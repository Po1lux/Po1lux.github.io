<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Linux Kernel ROP"><meta name="keywords" content><meta name="author" content="Po1lux"><meta name="copyright" content="Po1lux"><title>Linux Kernel ROP | Po1lux's Diary</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Load-CTF-Files-to-QEMU"><span class="toc-number">1.</span> <span class="toc-text">Load CTF Files to QEMU</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#提取cpio文件系统中的文件"><span class="toc-number">1.1.</span> <span class="toc-text">提取cpio文件系统中的文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Privilege-Transfer"><span class="toc-number">2.</span> <span class="toc-text">Privilege Transfer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#privilege-escalation"><span class="toc-number">3.</span> <span class="toc-text">privilege escalation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#debugging"><span class="toc-number">4.</span> <span class="toc-text">debugging</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://raw.githubusercontent.com/Po1lux/Po1lux.github.io/hexo/source/images/IMG.jpg"></div><div class="author-info__name text-center">Po1lux</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">53</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">28</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">6</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://raw.githubusercontent.com/Po1lux/Po1lux.github.io/hexo/source/images/IMG_3035.JPG)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Po1lux's Diary</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="post-info"><div id="post-title">Linux Kernel ROP</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-11-04</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>&#x8FD9;&#x4E2A;&#x9898;&#x76EE;&#x662F;&#x5185;&#x6838;&#x7A7A;&#x95F4;&#x7684;&#x6808;&#x6EA2;&#x51FA;&#xFF0C;&#x5173;&#x4E8E;&#x5185;&#x6838;&#x6A21;&#x5757;&#x7684;&#x6F0F;&#x6D1E;&#x7F51;&#x4E0A;&#x6709;&#x5F88;&#x591A;&#x5206;&#x6790;&#xFF0C;&#x5728;&#x8FD9;&#x91CC;&#x6211;&#x6253;&#x7B97;&#x53EA;&#x8BF4;&#x4E0B;&#x81EA;&#x5DF1;&#x901A;&#x8FC7;&#x8FD9;&#x4E2A;&#x9898;&#x76EE;&#x83B7;&#x5F97;&#x7684;&#x77E5;&#x8BC6;&#xFF0C;&#x5728;&#x6B64;&#x8BB0;&#x5F55;&#x4E00;&#x4E0B;</p>
<h2 id="Load-CTF-Files-to-QEMU"><a href="#Load-CTF-Files-to-QEMU" class="headerlink" title="Load CTF Files to QEMU"></a>Load CTF Files to QEMU</h2><p>CTF files&#x5305;&#x542B;&#x4E86;4&#x4E2A;&#x6587;&#x4EF6;</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x251C;&#x2500;&#x2500; bzImage</span><br><span class="line">&#x251C;&#x2500;&#x2500; core.cpio</span><br><span class="line">&#x251C;&#x2500;&#x2500; start.sh</span><br><span class="line">&#x2514;&#x2500;&#x2500; vmlinux</span><br></pre></td></tr></table></figure>
<p>start.sh&#x662F;&#x7CFB;&#x7EDF;&#x7684;&#x542F;&#x52A8;&#x811A;&#x672C;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x5F00;&#x542F;&#x4E86;kaslr</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 \</span><br><span class="line">-m 128M \</span><br><span class="line">-kernel ./bzImage \</span><br><span class="line">-initrd  ./core.cpio \</span><br><span class="line">-append <span class="string">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet kaslr&quot;</span> \</span><br><span class="line">-s  \</span><br><span class="line">-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \</span><br><span class="line">-nographic  \</span><br></pre></td></tr></table></figure>
<ul>
<li>qemu-system-x86_64&#xFF1A;&#x6A21;&#x62DF;x86_64&#x67B6;&#x6784;</li>
<li>-m&#xFF1A;&#x6307;&#x5B9A;RAM&#x5927;&#x5C0F;</li>
<li>-kernel&#xFF1A;&#x52A0;&#x8F7D;&#x7684;&#x5185;&#x6838;&#x955C;&#x50CF;</li>
<li>-initrd&#xFF1A;&#x6307;&#x5B9A;&#x5185;&#x6838;&#x542F;&#x52A8;&#x7684;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;</li>
<li>-s&#xFF1A;&#x76F8;&#x5F53;&#x4E8E; -gdb tcp::1234&#xFF0C;&#x7ED1;&#x5B9A;&#x7AEF;&#x53E3;&#xFF0C;&#x4F7F;&#x7528;gdb&#x8C03;&#x8BD5;</li>
</ul>
<p>&#x8FD8;&#x63D0;&#x4F9B;&#x4E86;vmlinux&#xFF0C;&#x8FD9;&#x91CC;&#x8BF4;&#x4E0B;vmlinux&#x548C;bzImage&#x7684;&#x5173;&#x7CFB;<a href="http://www.linfo.org/vmlinuz.html" target="_blank" rel="noopener">refference</a></p>
<blockquote>
<p>vmlinux&#x662F;&#x672A;&#x538B;&#x7F29;&#x7684;&#x3001;&#x9759;&#x6001;&#x94FE;&#x63A5;&#x7684;&#x3001;&#x53EF;&#x6267;&#x884C;&#x7684;&#x3001;&#x4F46;&#x662F;&#x4E0D;&#x80FD;bootable&#x7684;&#x5185;&#x6838;&#x6587;&#x4EF6;<br>vmlinuz&#x662F;&#x7531;vmlinux&#x7ECF;&#x8FC7;&#x538B;&#x7F29;&#x540E;&#xFF0C;&#x53EF;&#x4EE5;bootable&#x7684;&#x5185;&#x6838;&#x6587;&#x4EF6;&#xFF0C;&#x5B83;&#x5B9E;&#x9645;&#x4E0A;&#x5C31;&#x662F;<code>zImage</code>&#x6216;bzImage<br>bzImage&#x662F;vmlinuz&#x7ECF;&#x8FC7;gzip&#x538B;&#x7F29;&#x540E;&#x7684;&#x6587;&#x4EF6;&#xFF0C;&#x9002;&#x7528;&#x4E8E;&#x5927;&#x5185;&#x6838;<br>zImage&#x662F;vmlinuz&#x7ECF;&#x8FC7;gzip&#x538B;&#x7F29;&#x540E;&#x7684;&#x6587;&#x4EF6;&#xFF0C;&#x9002;&#x7528;&#x4E8E;<code>640k</code>&#x5185;&#x5B58;&#x7684;&#x5C0F;&#x5185;&#x6838;</p>
</blockquote>
<p>&#x4F46;&#x662F;&#x9898;&#x76EE;&#x63D0;&#x4F9B;&#x7684;vmlinux&#x548C;&#x5185;&#x6838;&#x4F7F;&#x7528;&#x7684;&#x4E0D;&#x4E00;&#x6837;&#xFF0C;&#x6240;&#x4EE5;&#x9700;&#x8981;&#x4ECE;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x4E2D;&#x63D0;&#x53D6;&#x6587;&#x4EF6;</p>
<h3 id="&#x63D0;&#x53D6;cpio&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x4E2D;&#x7684;&#x6587;&#x4EF6;"><a href="#&#x63D0;&#x53D6;cpio&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x4E2D;&#x7684;&#x6587;&#x4EF6;" class="headerlink" title="&#x63D0;&#x53D6;cpio&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x4E2D;&#x7684;&#x6587;&#x4EF6;"></a>&#x63D0;&#x53D6;cpio&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x4E2D;&#x7684;&#x6587;&#x4EF6;</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">mkdir core</span><br><span class="line">mv core.cpio ./core/core.cpio.gz</span><br><span class="line">gunzip core.cpio.gz</span><br><span class="line">cpio -idmv &lt; core.cpio</span><br><span class="line">&#x251C;&#x2500;&#x2500; bin</span><br><span class="line">&#x251C;&#x2500;&#x2500; core.ko</span><br><span class="line">&#x251C;&#x2500;&#x2500; etc</span><br><span class="line">&#x251C;&#x2500;&#x2500; exploit</span><br><span class="line">&#x251C;&#x2500;&#x2500; gen_cpio.sh</span><br><span class="line">&#x251C;&#x2500;&#x2500; init</span><br><span class="line">&#x251C;&#x2500;&#x2500; lib</span><br><span class="line">&#x251C;&#x2500;&#x2500; lib64</span><br><span class="line">&#x251C;&#x2500;&#x2500; linuxrc -&gt; bin/busybox</span><br><span class="line">&#x251C;&#x2500;&#x2500; proc</span><br><span class="line">&#x251C;&#x2500;&#x2500; root</span><br><span class="line">&#x251C;&#x2500;&#x2500; sbin</span><br><span class="line">&#x251C;&#x2500;&#x2500; sys</span><br><span class="line">&#x251C;&#x2500;&#x2500; tmp</span><br><span class="line">&#x251C;&#x2500;&#x2500; usr</span><br><span class="line">&#x2514;&#x2500;&#x2500; vmlinux</span><br><span class="line">&#x91CD;&#x6253;&#x5305;&#xFF1A;</span><br><span class="line">./gen_cpio.sh core.cpio</span><br></pre></td></tr></table></figure>
<p>vmlinux&#x662F;&#x672A;&#x538B;&#x7F29;&#x7684;&#x5185;&#x6838;&#x6587;&#x4EF6;&#xFF0C;&#x53EF;&#x4EE5;&#x4ECE;&#x8FD9;&#x91CC;&#x627E;Gadgets<br>core.ko&#x5C31;&#x662F;&#x5B58;&#x5728;&#x6F0F;&#x6D1E;&#x7684;&#x5185;&#x6838;&#x6A21;&#x5757;<br>init&#x662F;&#x542F;&#x52A8;&#x7684;&#x914D;&#x7F6E;&#x6587;&#x4EF6;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">mount -t proc proc /proc</span><br><span class="line">mount -t sysfs sysfs /sys</span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">/sbin/mdev -s</span><br><span class="line">mkdir -p /dev/pts</span><br><span class="line">mount -vt devpts -o gid=4,mode=620 none /dev/pts</span><br><span class="line">chmod 666 /dev/ptmx</span><br><span class="line">cat /proc/kallsyms &gt; /tmp/kallsyms</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line">ifconfig eth0 up</span><br><span class="line">udhcpc -i eth0</span><br><span class="line">ifconfig eth0 10.0.2.15 netmask 255.255.255.0</span><br><span class="line">route add default gw 10.0.2.2 </span><br><span class="line">insmod /core.ko</span><br><span class="line"></span><br><span class="line"><span class="comment">#poweroff -d 120 -f &amp;</span></span><br><span class="line">setsid /bin/cttyhack setuidgid 1000 /bin/sh</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&apos;sh end!\n&apos;</span></span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line"></span><br><span class="line">poweroff -d 0  -f</span><br></pre></td></tr></table></figure>
<p>poweroff -d 120 -f &amp; &#x8BBE;&#x7F6E;&#x4E86;&#x5B9A;&#x65F6;&#x5173;&#x673A;&#xFF0C;&#x5F71;&#x54CD;&#x8C03;&#x8BD5;&#xFF0C;&#x9700;&#x8981;&#x6CE8;&#x91CA;&#x6389;<br><code>echo 1 &gt; /proc/sys/kernel/kptr_restrict</code> &#x9650;&#x5236;&#x4E0D;&#x80FD;&#x4ECE; <code>/pro/kallsyms</code> &#x83B7;&#x53D6;&#x5185;&#x6838;&#x7B26;&#x53F7;&#x8868;&#x4FE1;&#x606F;</p>
<blockquote>
<p>/proc/kallsyms&#x5305;&#x542B;&#x4E86;kernel image&#x548C;&#x6240;&#x6709;&#x52A8;&#x6001;&#x52A0;&#x8F7D;&#x6A21;&#x5757;&#x7684;&#x7B26;&#x53F7;&#x8868;&#x3002;&#x5982;&#x679C;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x88AB;&#x7F16;&#x8BD1;&#x5668;&#x5185;&#x8054;&#xFF08;inline&#xFF09;&#x6216;&#x8005;&#x4F18;&#x5316;&#x6389;&#x4E86;&#xFF0C;&#x5219;&#x5B83;&#x5728;/proc/kallsyms&#x6709;&#x53EF;&#x80FD;&#x627E;&#x4E0D;&#x5230;&#x3002;&#x6B64;&#x5916;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x662F;root&#x7528;&#x6237;&#xFF0C;&#x5219;&#x663E;&#x793A;/proc/kallsyms&#x4E2D;&#x7684;&#x5730;&#x5740;&#x90FD;&#x662F;0&#xFF1A;</p>
</blockquote>
<p>&#x4F46;&#x662F;<code>cat /proc/kallsyms &gt; /tmp/kallsyms</code> &#x8FD9;&#x53E5;&#xFF0C;&#x5C06;kallsyms&#x62F7;&#x8D1D;&#x4E86;&#x4E00;&#x4EFD;&#x5728;/tmp&#x76EE;&#x5F55;&#x4E0B;&#xFF0C;&#x53EF;&#x4EE5;&#x5728;&#x8FD9;&#x91CC;&#x67E5;&#x627E;commit_creds&#x548C;prepare_kernel_cred&#x7684;&#x5730;&#x5740;</p>
<h2 id="Privilege-Transfer"><a href="#Privilege-Transfer" class="headerlink" title="Privilege Transfer"></a>Privilege Transfer</h2><p>Since userspace and kernel space are in different memory segment with different permission, we need some instructions to switch the spaces.</p>
<p>To switch from userspace to kernel space, we need to use syscall. To switch back&#xFF0C;we need to use two instructions as blew.</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">swapgs</span></span><br><span class="line"><span class="keyword">iretq</span></span><br></pre></td></tr></table></figure>
<p>The typical use of SWAPGS is to keep the &#x2018;user&#x2019; GS (which likely has a base address of 0) in the GSBase MSR, and the address of the kernel&#x2019;s per-CPU structure in KernelGSBase. Upon entry to Ring 0 (through a system call, software interrupt, or some other method), the kernel will use SWAPGS so accessing <code>[GS:0]</code> will get the pointer to the kernel data. Upon leaving Ring 0, SWAPGS will be called again, to switch GS back to the &#x2018;user&#x2019; GS. <a href="https://wiki.osdev.org/SWAPGS" target="_blank" rel="noopener">refference</a></p>
<p>Iretq instruction recovery the context of userspace, thus we come back from kernelspace to userspace. Before use this instruction,some value should be stored in the stack, and the stack construction as blew.</p>
<p>&#x5F53;&#x4F7F;&#x7528;IRET&#x6307;&#x4EE4;&#x8FD4;&#x56DE;&#x5230;&#x76F8;&#x540C;&#x4FDD;&#x62A4;&#x7EA7;&#x522B;&#x7684;&#x4EFB;&#x52A1;&#x65F6;&#xFF0C;IRET&#x4F1A;&#x4ECE;&#x6808;&#x5C06;<code>&#x8FD4;&#x56DE;&#x6307;&#x4EE4;&#x6307;&#x9488;</code>&#x3001;<code>&#x8FD4;&#x56DE;&#x4EE3;&#x7801;&#x6BB5;&#x9009;&#x62E9;&#x5668;</code>&#x4EE5;&#x53CA;<code>EFLAGS&#x6620;&#x50CF;</code>&#x5206;&#x522B;&#x5F39;&#x5165;RIP&#x3001;CS&#x4EE5;&#x53CA;RFLAGS&#x5BC4;&#x5B58;&#x5668;&#xFF0C;&#x7136;&#x540E;&#x6062;&#x590D;&#x6267;&#x884C;&#x4E2D;&#x65AD;&#x7684;&#x7A0B;&#x5E8F;&#x6216;&#x8FC7;&#x7A0B;&#x3002;<br>&#x5F53;&#x4F7F;&#x7528;IRET&#x6307;&#x4EE4;&#x8FD4;&#x56DE;&#x5230;&#x4E0D;&#x540C;&#x4FDD;&#x62A4;&#x7EA7;&#x522B;&#x65F6;&#xFF0C;IRET&#x4E0D;&#x4EC5;&#x4F1A;&#x4ECE;&#x6808;&#x5F39;&#x51FA;&#x4EE5;&#x4E0A;&#x5185;&#x5BB9;&#xFF0C;&#x8FD8;&#x4F1A;&#x5F39;&#x51FA;<code>RSP</code>&#x4EE5;&#x53CA;<code>SS</code>&#x3002;</p>
<p>&#x6808;&#x4E0A;&#x4FDD;&#x5B58;&#x4E86;trap frame&#xFF0C;&#x8FD4;&#x56DE;&#x5230;&#x7528;&#x6237;&#x6A21;&#x5F0F;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x6062;&#x590D;&#x4FE1;&#x606F;&#x4ECE;&#x4EE5;&#x4E0B;&#x7ED3;&#x6784;&#x4E2D;&#x8BFB;&#x53D6;&#xFF1A;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trap_frame</span> {</span></span><br><span class="line">    <span class="keyword">void</span> *rip;       <span class="comment">// instruction pointer +0</span></span><br><span class="line">    <span class="keyword">uint64_t</span> cs;     <span class="comment">// code segment +4</span></span><br><span class="line">    <span class="keyword">uint64_t</span> rflags; <span class="comment">// CPU flags +8</span></span><br><span class="line">    <span class="keyword">void</span> *rsp;       <span class="comment">// stack pointer +12</span></span><br><span class="line">    <span class="keyword">uint64_t</span> ss;     <span class="comment">// stack segment +16</span></span><br><span class="line">} __attribute__((packed));</span><br></pre></td></tr></table></figure>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">|---------|</span><br><span class="line">|iretq;ret| -&gt; the addr of the gadget  High</span><br><span class="line">|---------|</span><br><span class="line">|<span class="built_in"> RIP </span>    | -&gt; instruction address</span><br><span class="line">|---------|</span><br><span class="line">| CS      | -&gt; code segments</span><br><span class="line">|---------|</span><br><span class="line">| EFLAGS  | -&gt; flags <span class="keyword">for</span><span class="built_in"> system </span>status</span><br><span class="line">|---------|</span><br><span class="line">| RSP     | -&gt;<span class="built_in"> user </span>stack pointer</span><br><span class="line">|---------|</span><br><span class="line">| SS      | -&gt;<span class="built_in"> user </span>stack segment			Low</span><br><span class="line">|---------|</span><br></pre></td></tr></table></figure>
<h2 id="privilege-escalation"><a href="#privilege-escalation" class="headerlink" title="privilege escalation"></a>privilege escalation</h2><p>getting privilege escalation via commit_creds(prepare_kernel_cred(0)<br>The above privilege escalation payload allocates a new credential struct (with uid = 0, gid = 0, etc.) and applies it to the <strong>calling process</strong>.</p>
<h2 id="debugging"><a href="#debugging" class="headerlink" title="debugging"></a>debugging</h2><p>target remote:1234&#x901A;&#x8FC7;&#x7AEF;&#x53E3;&#x8C03;&#x8BD5;&#xFF0C;gdb ./vmlinux&#x542F;&#x52A8;&#xFF0C;&#x53EA;&#x52A0;&#x8F7D;&#x4E86; kernel &#x7684;&#x7B26;&#x53F7;&#x8868;&#xFF0C;&#x6A21;&#x5757;&#x52A0;&#x8F7D;&#x8FDB;&#x5185;&#x6838;&#x540E;&#xFF0C;&#x5E76;&#x6CA1;&#x6709;&#x4F5C;&#x4E3A;vmliunx&#x7684;&#x4E00;&#x90E8;&#x5206;&#x4F20;&#x7ED9;gdb&#xFF0C;&#x56E0;&#x4E3A;&#x9700;&#x8981;&#x52A0;&#x8F7D;&#x5185;&#x6838;&#x6A21;&#x5757;&#x7684;&#x7B26;&#x53F7;&#x8868;&#xFF0C;&#x7531;&#x4E8E;&#x6A21;&#x5757;&#x4E5F;&#x662F;&#x4E00;&#x4E2A;ELF&#x6587;&#x4EF6;&#xFF0C;&#x9700;&#x8981;&#x77E5;&#x9053;&#x6A21;&#x5757;&#x7684;.text&#x7684;&#x8282;&#x533A;&#x5730;&#x5740;&#x3002;&#x8FD9;&#x4E2A;&#x4FE1;&#x606F;&#x5206;&#x522B;&#x4FDD;&#x5B58;/sys/module/stack_smashing/sections/.text&#x4E2D;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gdb ./vmlinux</span><br><span class="line">target remote:1234 </span><br><span class="line">add-symbol-file ./core.ko textaddr</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/ $ id</span><br><span class="line">uid=1000(chal) gid=1000(chal) groups=1000(chal)</span><br><span class="line">/ $ /tmp/exploit </span><br><span class="line">[*]status has been saved.</span><br><span class="line">vmlinux_base 0xffffffff92800000</span><br><span class="line">vmlinux_base 0xffffffff92800000</span><br><span class="line">[*] <span class="built_in">set</span> off</span><br><span class="line">[*] core_read</span><br><span class="line">[+]canary: 0x808226e1f3461f00</span><br><span class="line">/ $ id</span><br><span class="line">uid=0(root) gid=0(root)</span><br></pre></td></tr></table></figure>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Po1lux</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://yoursite.com/2019/11/04/Linux-Kernel-ROP/">http://yoursite.com/2019/11/04/Linux-Kernel-ROP/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://yoursite.com">Po1lux's Diary</a>！</span></div></div><div class="post-meta__tag-list"></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2019/11/06/frida使用/"><i class="fa fa-chevron-left">  </i><span>frida-notebook</span></a></div><div class="next-post pull-right"><a href="/2019/10/06/mineucore-虚拟内存管理学习笔记/"><span>mineucore-虚拟内存管理学习笔记</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://raw.githubusercontent.com/Po1lux/Po1lux.github.io/hexo/source/images/IMG_3035.JPG)"><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2020 By Po1lux</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script></body></html>