<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content><meta name="keywords" content><meta name="author" content="Po1lux"><meta name="copyright" content="Po1lux"><title>Po1lux's Diary</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="author-info"><div class="author-info__avatar text-center"><img src="https://raw.githubusercontent.com/Po1lux/Po1lux.github.io/hexo/source/images/IMG.jpg"></div><div class="author-info__name text-center">Po1lux</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">52</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">28</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">5</span></a></div></div></div><nav id="nav" style="background-image: url(https://raw.githubusercontent.com/Po1lux/Po1lux.github.io/hexo/source/images/IMG_3035.JPG)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Po1lux's Diary</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="site-info"><div id="site-title">Po1lux's Diary</div><div id="site-sub-title"></div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2020/02/23/mineucore-内核线程管理学习笔记/">mineucore-内核线程管理学习笔记</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-02-23</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/Operating-System/">Operating System</a></span><div class="content"><p>&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x662F;&#x4EE5;&#x8FDB;&#x7A0B;&#x4E3A;&#x4E2D;&#x5FC3;&#x8BBE;&#x8BA1;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x5176;&#x9996;&#x8981;&#x4EFB;&#x52A1;&#x662F;&#x4E3A;&#x8FDB;&#x7A0B;&#x5EFA;&#x7ACB;&#x6863;&#x6848;&#xFF0C;&#x8FDB;&#x7A0B;&#x6863;&#x6848;&#x7528;&#x4E8E;&#x8868;&#x793A;&#x3001;&#x6807;&#x8BC6;&#x6216;&#x63CF;&#x8FF0;&#x8FDB;&#x7A0B;&#xFF0C;&#x5373;&#x8FDB;&#x7A0B;&#x63A7;&#x5236;&#x5757;&#x3002;&#x4E0B;&#x9762;&#x901A;&#x8FC7;&#x5B9E;&#x73B0;init&#x5185;&#x6838;&#x7EBF;&#x7A0B;&#xFF0C;&#x5B66;&#x4E60;&#x8FDB;&#x7A0B;&#x4ECE;&#x521B;&#x5EFA;&#x5230;&#x8FD0;&#x884C;&#x7684;&#x8FC7;&#x7A0B;</p>
<p>&#x5185;&#x6838;&#x7EBF;&#x7A0B;&#x662F;&#x4E00;&#x79CD;&#x7279;&#x6B8A;&#x7684;&#x8FDB;&#x7A0B;&#xFF0C;&#x5185;&#x6838;&#x7EBF;&#x7A0B;&#x548C;&#x8FDB;&#x7A0B;&#x7684;&#x533A;&#x522B;&#x4E3B;&#x8981;&#x6709;&#x4E24;&#x4E2A;&#xFF1A;</p>
<ol>
<li>&#x5185;&#x6838;&#x7EBF;&#x7A0B;&#x53EA;&#x8FD0;&#x884C;&#x5728;&#x5185;&#x6838;&#x6001;&#xFF0C;&#x7528;&#x6237;&#x8FDB;&#x7A0B;&#x5219;&#x4F1A;&#x5728;&#x7528;&#x6237;&#x6001;&#x548C;&#x5185;&#x6838;&#x6001;&#x5207;&#x6362;</li>
<li>&#x6240;&#x6709;&#x5185;&#x6838;&#x7EBF;&#x7A0B;&#x5171;&#x7528;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x5185;&#x6838;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#xFF0C;&#x4E0D;&#x9700;&#x8981;&#x4E3A;&#x5185;&#x6838;&#x7EBF;&#x7A0B;&#x7EF4;&#x62A4;&#x5355;&#x72EC;&#x7684;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#xFF1B;&#x800C;&#x6BCF;&#x4E2A;&#x7528;&#x6237;&#x8FDB;&#x7A0B;&#x90FD;&#x9700;&#x8981;&#x7EF4;&#x62A4;&#x5404;&#x81EA;&#x7684;&#x5185;&#x5B58;&#x7A7A;&#x95F4;</li>
</ol>
<p>&#x5982;&#x4F55;&#x751F;&#x6210;&#x4E00;&#x4E2A;&#x5185;&#x6838;&#x7EBF;&#x7A0B;&#x5E76;&#x8BA9;&#x5176;&#x8FD0;&#x884C;&#x5462;&#xFF1F;&#x5206;&#x4E09;&#x6B65;</p>
<ol>
<li>&#x521B;&#x5EFA;PCB&#x5757;&#xFF0C;&#x8BBE;&#x7F6E;&#x76F8;&#x5E94;&#x5C5E;&#x6027;</li>
<li>&#x5206;&#x914D;&#x76F8;&#x5E94;&#x7684;&#x8D44;&#x6E90;&#xFF08;&#x6808;&#x7A7A;&#x95F4;&#xFF0C;&#x865A;&#x62DF;&#x5185;&#x5B58;&#xFF09;</li>
<li>&#x88AB;&#x8C03;&#x5EA6;&#x5668;&#x6267;&#x884C;</li>
</ol>
<p>&#x4E0B;&#x9762;&#x8BE6;&#x7EC6;&#x8BF4;&#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x8FD9;&#x4E09;&#x6B65;&#xFF1A;</p>
<h2 id="1&#x3001;&#x4E3A;&#x5185;&#x6838;&#x7EBF;&#x7A0B;&#x521B;&#x5EFA;PCB&#x5757;&#x5E76;&#x521D;&#x59CB;&#x5316;"><a href="#1&#x3001;&#x4E3A;&#x5185;&#x6838;&#x7EBF;&#x7A0B;&#x521B;&#x5EFA;PCB&#x5757;&#x5E76;&#x521D;&#x59CB;&#x5316;" class="headerlink" title="1&#x3001;&#x4E3A;&#x5185;&#x6838;&#x7EBF;&#x7A0B;&#x521B;&#x5EFA;PCB&#x5757;&#x5E76;&#x521D;&#x59CB;&#x5316;"></a>1&#x3001;&#x4E3A;&#x5185;&#x6838;&#x7EBF;&#x7A0B;&#x521B;&#x5EFA;PCB&#x5757;&#x5E76;&#x521D;&#x59CB;&#x5316;</h2><p>&#x9996;&#x5148;&#x786E;&#x5B9A;PCB&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">proc_struct</span> {</span></span><br><span class="line">    <span class="keyword">enum</span> proc_state state;                      <span class="comment">// Process state</span></span><br><span class="line">    <span class="keyword">int</span> pid;                                    <span class="comment">// Process ID</span></span><br><span class="line">    <span class="keyword">int</span> runs;                                   <span class="comment">// the running times of Proces</span></span><br><span class="line">    <span class="keyword">uintptr_t</span> kstack;                           <span class="comment">// Process kernel stack</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">bool</span> need_resched;                 <span class="comment">// bool value: need to be rescheduled to release CPU?</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">proc_struct</span> *<span class="title">parent</span>;</span>                 <span class="comment">// the parent process</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span>;</span>                       <span class="comment">// Process&apos;s memory management field    &#x63CF;&#x8FF0;&#x7528;&#x6237;&#x6001;&#x8FDB;&#x7A0B;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x7684;&#x60C5;&#x51B5;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">context</span> <span class="title">context</span>;</span>                     <span class="comment">// Switch here to run process</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">trapframe</span> *<span class="title">tf</span>;</span>                       <span class="comment">// Trap frame for current interrupt</span></span><br><span class="line">    <span class="keyword">uintptr_t</span> cr3;                              <span class="comment">// CR3 register: the base addr of Page Directroy Table(PDT)</span></span><br><span class="line">    <span class="keyword">uint32_t</span> flags;                             <span class="comment">// Process flag</span></span><br><span class="line">    <span class="keyword">char</span> name[PROC_NAME_LEN + <span class="number">1</span>];               <span class="comment">// Process name</span></span><br><span class="line">    <span class="keyword">list_entry_t</span> list_link;                     <span class="comment">// Process link list </span></span><br><span class="line">    <span class="keyword">list_entry_t</span> hash_link;                     <span class="comment">// Process hash list</span></span><br><span class="line">};</span><br></pre></td></tr></table></figure>
<p>&#x8C03;&#x7528;alloc_proc&#x5B8C;&#x6210;PCB&#x7684;&#x521D;&#x59CB;&#x5316;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">proc-&gt;state = PROC_UNINIT;  <span class="comment">//&#x8BBE;&#x7F6E;&#x8FDB;&#x7A0B;&#x4E3A;uninitialized&#x72B6;&#x6001;&#xFF0C;&#x5DF2;&#x521B;&#x5EFA; &#x672A;&#x521D;&#x59CB;&#x5316;</span></span><br><span class="line">proc-&gt;pid = <span class="number">-1</span>;             <span class="comment">//&#x8BBE;&#x7F6E;&#x8FDB;&#x7A0B;pid&#x7684;&#x672A;&#x521D;&#x59CB;&#x5316;&#x503C;</span></span><br><span class="line">proc-&gt;runs = <span class="number">0</span>;</span><br><span class="line">proc-&gt;kstack = <span class="number">0</span>;</span><br><span class="line">proc-&gt;need_resched = <span class="number">0</span>;</span><br><span class="line">proc-&gt;parent = <span class="literal">NULL</span>;</span><br><span class="line">proc-&gt;mm = <span class="literal">NULL</span>;</span><br><span class="line"><span class="built_in">memset</span>(&amp;(proc-&gt;context), <span class="number">0</span>, <span class="keyword">sizeof</span>(struct context));</span><br><span class="line">proc-&gt;tf = <span class="literal">NULL</span>;</span><br><span class="line">proc-&gt;cr3 = boot_cr3;       <span class="comment">//&#x4F7F;&#x7528;&#x5185;&#x6838;&#x9875;&#x76EE;&#x5F55;&#x8868;&#x7684;&#x57FA;&#x5740;&#xFF0C;&#x5373;&#x5185;&#x6838;&#x7EBF;&#x7A0B;&#x5171;&#x7528;&#x4E00;&#x4E2A;&#x6620;&#x5C04;&#x5185;&#x6838;&#x7A7A;&#x95F4;&#x7684;&#x9875;&#x8868;&#xFF0C;&#x8FD9;&#x8868;&#x793A;&#x5185;&#x6838;&#x7A7A;&#x95F4;&#x5BF9;&#x6240;&#x6709;&#x5185;&#x6838;&#x7EBF;&#x7A0B;&#x90FD;&#x662F;&#x201C;&#x53EF;&#x89C1;&#x201D;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x66F4;&#x7CBE;&#x786E;&#x5730;&#x8BF4;&#xFF0C;&#x8FD9;&#x4E9B;&#x5185;&#x6838;&#x7EBF;&#x7A0B;&#x90FD;&#x5E94;&#x8BE5;&#x662F;&#x4ECE;&#x5C5E;&#x4E8E;&#x540C;&#x4E00;&#x4E2A;&#x552F;&#x4E00;&#x7684;&#x201C;&#x5927;&#x5185;&#x6838;&#x8FDB;&#x7A0B;&#x201D;&#x2014;uCore&#x5185;&#x6838;</span></span><br><span class="line">proc-&gt;flags = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">memset</span>(proc-&gt;name, <span class="number">0</span>, PROC_NAME_LEN);</span><br></pre></td></tr></table></figure>
<h2 id="2&#x3001;&#x4E3A;PCB&#x5206;&#x914D;&#x8D44;&#x6E90;"><a href="#2&#x3001;&#x4E3A;PCB&#x5206;&#x914D;&#x8D44;&#x6E90;" class="headerlink" title="2&#x3001;&#x4E3A;PCB&#x5206;&#x914D;&#x8D44;&#x6E90;"></a>2&#x3001;&#x4E3A;PCB&#x5206;&#x914D;&#x8D44;&#x6E90;</h2><p>&#x4E3B;&#x8981;&#x51FD;&#x6570;&#x5982;&#x4E0B;&#xFF1A;&#xFF08;&#x8FD9;&#x91CC;&#x4E0D;&#x8D34;&#x4EE3;&#x7801;&#x4E86;&#xFF0C;&#x592A;&#x591A;&#x4E86;&#xFF0C;&#x9648;&#x8FF0;&#x4E0B;&#x601D;&#x8DEF;&#xFF09;</p>
<p><strong>1&#x3001;setup_kstack</strong><br>&#x901A;&#x8FC7;&#x7269;&#x7406;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#x5668;&#x7533;&#x8BF7;8K&#x5185;&#x5B58;&#x4F5C;&#x4E3A;&#x5185;&#x6838;&#x6808;</p>
<p><strong>2&#x3001;copy_mm(clone_flags, proc)</strong><br>&#x6839;&#x636E;clone_flag&#x6807;&#x5FD7;&#x590D;&#x5236;&#x6216;&#x5171;&#x4EAB;&#x8FDB;&#x7A0B;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#x7ED3;&#x6784;&#xFF0C;&#x5185;&#x6838;&#x7EBF;&#x7A0B;&#x8BBE;&#x4E3A;NULL&#xFF0C;&#x7531;&#x4E8E;&#x5728;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x542F;&#x52A8;&#x540E;&#xFF0C;&#x5DF2;&#x7ECF;&#x5BF9;&#x6574;&#x4E2A;&#x6838;&#x5FC3;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x8FDB;&#x884C;&#x4E86;&#x7BA1;&#x7406;&#xFF0C;&#x901A;&#x8FC7;&#x8BBE;&#x7F6E;&#x9875;&#x8868;&#x5EFA;&#x7ACB;&#x4E86;&#x6838;&#x5FC3;&#x865A;&#x62DF;&#x7A7A;&#x95F4;(&#x5373; boot_cr3 &#x6307;&#x5411;&#x7684;&#x4E8C;&#x7EA7;&#x9875;&#x8868;&#x63CF;&#x8FF0;&#x7684;&#x7A7A;&#x95F4;)&#x3002;&#x6240;&#x4EE5;&#x5185;&#x6838;&#x4E2D;&#x7684;&#x6240;&#x6709;&#x7EBF;&#x7A0B;&#x90FD;&#x4E0D;&#x9700;&#x8981;&#x518D;&#x5EFA;&#x7ACB;&#x5404;&#x81EA;&#x7684;&#x9875;&#x8868;&#xFF0C;&#x53EA;&#x9700;&#x5171;&#x4EAB;&#x8FD9;&#x4E2A;&#x6838;&#x5FC3;&#x865A;&#x62DF;&#x7A7A;&#x95F4;&#x5C31;&#x53EF;&#x4EE5;&#x8BBF;&#x95EE;&#x6574;&#x4E2A;&#x7269;&#x7406;&#x5185;&#x5B58;&#x3002;</p>
<p><strong>3&#x3001;copy_thread</strong><br>&#x91CD;&#x70B9;&#x51FD;&#x6570;&#xFF0C;&#x8BBE;&#x7F6E;&#x4E86;proc-&gt;context&#xFF0C;context&#x5B58;&#x50A8;&#x7740;&#x7EBF;&#x7A0B;&#x8FD0;&#x884C;&#x65F6;&#x7684;&#x901A;&#x7528;&#x5BC4;&#x5B58;&#x5668;&#x7684;&#x503C;&#xFF0C;&#x8FD9;&#x91CC;&#x8BBE;&#x7F6E;&#x4E86;init&#x5185;&#x6838;&#x7EBF;&#x7A0B;&#x7684;eip&#x548C;esp&#xFF0C;&#x5373;init&#x8FD0;&#x884C;&#x65F6;&#x6307;&#x4EE4;&#x6307;&#x9488;&#x548C;&#x6808;&#x6307;&#x9488;&#x4F4D;&#x7F6E;&#x3002;</p>
<p>&#x8FD9;&#x91CC;&#x7684;eip&#x5E76;&#x4E0D;&#x662F;&#x76F4;&#x63A5;&#x6307;&#x5411;init&#x7EBF;&#x7A0B;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x800C;&#x662F;&#x6307;&#x5411;&#x4E86;forkret&#x8FD9;&#x4E2A;&#x6C47;&#x7F16;&#x51FD;&#x6570;&#xFF0C;&#x800C;esp&#x5219;&#x6307;&#x5411;&#x4E86;&#x4E2D;&#x65AD;&#x5E27;&#x3002;</p>
<p>&#x8FD9;&#x91CC;&#x4E2D;&#x65AD;&#x5E27;&#x5B8C;&#x6210;&#x4E86;&#x771F;&#x6B63;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#x5207;&#x6362;&#xFF0C;&#x5305;&#x62EC;&#x5404;&#x79CD;&#x6BB5;&#x5BC4;&#x5B58;&#x5668;&#x3001;&#x6807;&#x5FD7;&#x5BC4;&#x5B58;&#x5668;&#x7B49;&#x3002;</p>
<p>forkret&#x51FD;&#x6570;&#x505A;&#x7684;&#x529F;&#x80FD;&#x5C31;&#x662F;&#x5C06;eip&#x6307;&#x5411;&#x4E2D;&#x65AD;&#x5E27;trapfram.eip&#xFF0C;&#x800C;trapfram.eip&#x6307;&#x5411;kernel_thread_entry&#x8FD9;&#x4E2A;&#x6C47;&#x7F16;&#x51FD;&#x6570;&#xFF0C;&#x5176;&#x4E2D;trapfram.ebp&#x4E3A;&#x7EBF;&#x7A0B;&#x8981;&#x6267;&#x884C;&#x7684;&#x51FD;&#x6570;&#xFF0C;edx&#x4E3A;&#x53C2;&#x6570;&#xFF0C;&#x5728;kernel_thread_entry&#x4E2D;call ebp</p>
<p>&#x603B;&#x7684;&#x6765;&#x8BF4;&#xFF0C;copy_thread&#x8BBE;&#x7F6E;&#x8FDB;&#x7A0B;&#x5728;&#x5185;&#x6838;&#xFF08;&#x5C06;&#x6765;&#x4E5F;&#x5305;&#x62EC;&#x7528;&#x6237;&#x6001;&#xFF09;&#x6B63;&#x5E38;&#x8FD0;&#x884C;&#x548C;&#x8C03;&#x5EA6;&#x6240;&#x9700;&#x7684;&#x4E2D;&#x65AD;&#x5E27;&#x548C;&#x6267;&#x884C;&#x4E0A;&#x4E0B;&#x6587;&#xFF0C;context&#x5B8C;&#x6210;&#x4E86;&#x901A;&#x7528;&#x5BC4;&#x5B58;&#x5668;&#x4E0A;&#x4E0B;&#x6587;&#x7684;&#x5207;&#x6362;&#xFF0C;trapfram&#x5B8C;&#x6210;&#x4E86;&#x5904;&#x7406;&#x673A;&#x4E0A;&#x4E0B;&#x6587;&#x7684;&#x5207;&#x6362;</p>
<h2 id="3&#x3001;&#x7EBF;&#x7A0B;&#x5207;&#x6362;&#xFF08;&#x8FD0;&#x884C;&#xFF09;"><a href="#3&#x3001;&#x7EBF;&#x7A0B;&#x5207;&#x6362;&#xFF08;&#x8FD0;&#x884C;&#xFF09;" class="headerlink" title="3&#x3001;&#x7EBF;&#x7A0B;&#x5207;&#x6362;&#xFF08;&#x8FD0;&#x884C;&#xFF09;"></a>3&#x3001;&#x7EBF;&#x7A0B;&#x5207;&#x6362;&#xFF08;&#x8FD0;&#x884C;&#xFF09;</h2><p>&#x901A;&#x8FC7;<code>proc_run</code>&#x542F;&#x52A8;&#x7EBF;&#x7A0B;&#xFF0C;<code>proc_run</code> &#x7684;&#x6267;&#x884C;&#x8FC7;&#x7A0B;&#x4E3A;&#xFF1A;</p>
<ul>
<li>&#x4FDD;&#x5B58; IF &#x4F4D;&#x5E76;&#x4E14;&#x7981;&#x6B62;&#x4E2D;&#x65AD;&#xFF1B;</li>
<li>&#x5C06; current &#x6307;&#x9488;&#x6307;&#x5411;&#x5C06;&#x8981;&#x6267;&#x884C;&#x7684;&#x8FDB;&#x7A0B;&#xFF1B;</li>
<li>&#x66F4;&#x65B0; TSS &#x4E2D;&#x7684;&#x6808;&#x9876;&#x6307;&#x9488;&#xFF1B;</li>
<li>&#x9875;&#x8868;&#x5207;&#x6362;&#xFF1B;</li>
<li>&#x8C03;&#x7528; switch_to &#x8FDB;&#x884C;&#x4E0A;&#x4E0B;&#x6587;&#x5207;&#x6362;&#xFF1B;</li>
<li>&#x5F53;&#x6267;&#x884C; proc_run &#x7684;&#x8FDB;&#x7A0B;&#x6062;&#x590D;&#x6267;&#x884C;&#x4E4B;&#x540E;&#xFF0C;&#x9700;&#x8981;&#x6062;&#x590D; IF &#x4F4D;&#x3002;</li>
</ul>
<p>&#x4E3B;&#x8981;&#x51FD;&#x6570;&#x65F6;switch_to&#x51FD;&#x6570;&#xFF0C;&#x5F53; switch_to &#x51FD;&#x6570;&#x6267;&#x884C;&#x5B8C;&#x201C;ret&#x201D;&#x6307;&#x4EE4;&#x540E;&#xFF0C;&#x5C31;&#x8DF3;&#x8F6C;&#x5230;init&#x7EBF;&#x7A0B;&#x6267;&#x884C;&#x4E86;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">switch_to(&amp;(prev-&gt;context), &amp;(next-&gt;context));</span><br></pre></td></tr></table></figure>
<p>&#x901A;&#x8FC7;switch_to&#x51FD;&#x6570;&#x5B9E;&#x73B0;&#x4E24;&#x4E2A;&#x5185;&#x6838;&#x7EBF;&#x7A0B;&#x4E0A;&#x4E0B;&#x6587;&#x7684;&#x5207;&#x6362;&#xFF0C;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x662F;&#x4E00;&#x6BB5;&#x6C47;&#x7F16;&#x4EE3;&#x7801;&#xFF0C;&#x5B9E;&#x73B0;&#x4E86;&#x901A;&#x7528;&#x5BC4;&#x5B58;&#x5668;&#x548C;eip&#x7684;&#x66FF;&#x6362;&#xFF0C;&#x6700;&#x540E;push eip; ret&#xFF0C;&#x5C31;&#x8DF3;&#x8F6C;&#x5230;&#x4E86;next-&gt;context&#x7684;eip&#x6267;&#x884C;&#xFF0C;&#x8FD9;&#x4E2A;context&#x88AB;&#x8D4B;&#x503C;&#x6210;&#x4EC0;&#x4E48;&#x4E86;&#x5462;&#xFF1F;</p>
<p>&#x5728;copy_thread&#x51FD;&#x6570;&#x4E2D;&#x5BF9;&#x8FD9;&#x4E2A;context.eip&#x8FDB;&#x884C;&#x4E86;&#x521D;&#x59CB;&#x5316;&#xFF0C;&#x540C;&#x65F6;&#x6808;&#x5BC4;&#x5B58;&#x5668;esp&#x4E5F;&#x88AB;&#x66F4;&#x65B0;&#x4E86;&#xFF0C;&#x6211;&#x4EEC;&#x5148;&#x4E0D;&#x770B;&#x8FD9;&#x4E2A;esp&#x6709;&#x4EC0;&#x4E48;&#x7528;&#xFF0C;&#x5148;&#x770B;forkret&#x8FD9;&#x4E2A;&#x51FD;&#x6570;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">proc-&gt;context.eip = (<span class="keyword">uintptr_t</span>)forkret; <span class="comment">//&#x8BBE;&#x7F6E;initproc&#x7684;&#x8FDB;&#x7A0B;&#x4E0A;&#x4E0B;&#x6587;&#xFF0C;&#x4E0A;&#x6B21;&#x505C;&#x6B62;&#x6267;&#x884C;&#x65F6;&#x7684;&#x4E0B;&#x4E00;&#x6761;&#x6307;&#x4EE4;&#x5730;&#x5740;context.eip&#x548C;&#x4E0A;&#x6B21;&#x505C;&#x6B62;&#x6267;&#x884C;&#x65F6;&#x7684;&#x5806;&#x6808;&#x5730;&#x5740;context.esp</span></span><br><span class="line">proc-&gt;context.esp = (<span class="keyword">uintptr_t</span>)(proc-&gt;tf);<span class="comment">//&#x56E0;&#x4E3A;initproc&#x8FD8;&#x6CA1;&#x6709;&#x6267;&#x884C;&#x8FC7;&#xFF0C;&#x6240;&#x4EE5;&#x8FD9;&#x5176;&#x5B9E;&#x5C31;&#x662F;initproc&#x5B9E;&#x9645;&#x6267;&#x884C;&#x7684;&#x7B2C;&#x4E00;&#x6761;&#x6307;&#x4EE4;&#x7684;&#x5806;&#x6808;&#x6307;&#x9488;</span></span><br></pre></td></tr></table></figure>
<p>forkret&#x51FD;&#x6570;&#x662F;&#x4E00;&#x6BB5;&#x6C47;&#x7F16;&#x6307;&#x4EE4;&#xFF0C;&#x5176;&#x5B9E;&#x73B0;&#x5728;trapentry.S</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">.globl __trapret</span><br><span class="line">__trapret:</span><br><span class="line">    # restore registers from stack</span><br><span class="line">    popal</span><br><span class="line">    # restore %ds, %es, %fs and %gs</span><br><span class="line">    popl %gs</span><br><span class="line">    popl %fs</span><br><span class="line">    popl %es</span><br><span class="line">    popl %ds</span><br><span class="line">    # get rid of the trap number and error code</span><br><span class="line">    addl $0x8, %esp</span><br><span class="line">    iret</span><br><span class="line">.globl forkrets</span><br><span class="line">forkrets:</span><br><span class="line">    # set stack to this new process&apos;s trapframe</span><br><span class="line">    movl 4(%esp), %esp</span><br><span class="line">    jmp __trapret</span><br></pre></td></tr></table></figure>
<p>&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x66F4;&#x65B0;&#x4E86;&#x6808;&#x6307;&#x9488;&#x5BC4;&#x5B58;&#x5668;&#xFF0C;&#x7136;&#x540E;&#x5C06;&#x6808;&#x4E0A;&#x7684;&#x6570;&#x636E;&#x5F39;&#x56DE;&#x5BC4;&#x5B58;&#x5668;&#xFF0C;&#x8C03;&#x7528;&#x4E2D;&#x65AD;&#x8FD4;&#x56DE;&#x6307;&#x4EE4;iret&#x3002;&#x8FD9;&#x91CC;&#x7684;&#x5185;&#x6838;&#x7EBF;&#x7A0B;&#x4E0A;&#x4E0B;&#x6587;&#x5207;&#x6362;&#x53C2;&#x8003;&#x4E86;&#x5185;&#x6838;&#x6808;&#x5230;&#x7528;&#x6237;&#x6808;&#x7684;&#x4E2D;&#x65AD;&#x5B9E;&#x73B0;&#x3002;<br>&#x5F53;&#x53D1;&#x751F;&#x4E2D;&#x65AD;&#x65F6;&#xFF0C;&#x786C;&#x4EF6;&#x4F1A;&#x4F9D;&#x6B21;&#x538B;&#x6808;ss&#x3001;esp&#x3001;eflags&#x3001;cs&#x3001;eip&#x3001;errno&#xFF0C;&#x8FD9;&#x662F;&#x786C;&#x4EF6;&#x5B9E;&#x73B0;&#x7684;&#x90E8;&#x5206;&#xFF0C;&#x6700;&#x540E;&#x901A;&#x8FC7;iret&#x4E2D;&#x65AD;&#x8FD4;&#x56DE;&#x6307;&#x4EE4;&#x5C06;&#x6808;&#x4E0A;&#x7684;ss&#x3001;esp&#x3001;eflags&#x3001;cs&#x3001;eip&#x3001;errno&#x5F39;&#x56DE;&#x5BF9;&#x5E94;&#x7684;&#x5BC4;&#x5B58;&#x5668;&#x3002;&#x5728;&#x5185;&#x6838;&#x6808;&#x5230;&#x7528;&#x6237;&#x6808;&#x7684;&#x4E2D;&#x65AD;&#x5B9E;&#x73B0;&#x4E2D;&#xFF0C;&#x5F53;&#x4E0A;&#x8FF0;&#x5BC4;&#x5B58;&#x5668;&#x5728;&#x6808;&#x4E0A;&#x65F6;&#xFF0C;&#x4FEE;&#x6539;&#x4E0A;&#x8FF0;&#x5BC4;&#x5B58;&#x5668;&#x7684;&#x503C;&#xFF0C;&#x5F53;iret&#x65F6;&#xFF0C;&#x5C31;&#x5B9E;&#x73B0;&#x4E86;&#x5207;&#x6808;&#x7684;&#x6548;&#x679C;&#x3002;<br>&#x5728;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x4E0D;&#x9700;&#x8981;&#x4E2D;&#x65AD;&#xFF0C;&#x4F46;&#x662F;&#x901A;&#x8FC7;iret&#x4E2D;&#x65AD;&#x8FD4;&#x56DE;&#x6307;&#x4EE4;&#x5B9E;&#x73B0;&#x7EBF;&#x7A0B;&#x5207;&#x6362;&#x65F6;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#x5207;&#x6362;&#xFF0C;&#x4E3A;&#x6B64;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5EFA;&#x7ACB;&#x4E2D;&#x65AD;&#x5E27;trapframe&#xFF0C;<code>proc-&gt;context.esp = (uintptr_t)(proc-&gt;tf)</code>&#x8FD9;&#x53E5;&#x4EE3;&#x7801;&#x5C31;&#x8D77;&#x4F5C;&#x7528;&#x4E86;&#xFF0C;</p>
<p>&#x9996;&#x5148;&#x5728; kernel_thread&#x51FD;&#x6570;&#x4E2D;&#x5EFA;&#x7ACB;&#x4E34;&#x65F6;&#x4E2D;&#x65AD;&#x5E27;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tf.tf_cs = KERNEL_CS;</span><br><span class="line">tf.tf_ds = tf.tf_es = tf.tf_ss = KERNEL_DS;</span><br><span class="line">tf.tf_regs.reg_ebx = (<span class="keyword">uint32_t</span>)fn;	<span class="comment">//fn&#x4E3A;&#x8981;&#x542F;&#x52A8;&#x7684;&#x7EBF;&#x7A0B;&#x7684;&#x51FD;&#x6570;&#x6307;&#x9488;</span></span><br><span class="line">tf.tf_regs.reg_edx = (<span class="keyword">uint32_t</span>)arg;	<span class="comment">//arg&#x4E3A;&#x53C2;&#x6570;</span></span><br><span class="line">tf.tf_eip = (<span class="keyword">uint32_t</span>)kernel_thread_entry;  <span class="comment">//&#x4F4D;&#x4E8E;kern/process/entry.S</span></span><br></pre></td></tr></table></figure>
<p>&#x7136;&#x540E;&#x5728;copy_thread&#x51FD;&#x6570;&#x4E2D;&#xFF0C;&#x5206;&#x914D;&#x7A7A;&#x95F4;&#x5EFA;&#x7ACB;&#x4E2D;&#x65AD;&#x5E27;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">proc-&gt;tf = (struct trapframe *)(proc-&gt;kstack + KSTACKSIZE) - <span class="number">1</span>;<span class="comment">//&#x5728;&#x5185;&#x6838;&#x5806;&#x6808;&#x7684;&#x9876;&#x90E8;&#x8BBE;&#x7F6E;&#x4E2D;&#x65AD;&#x5E27;&#x5927;&#x5C0F;&#x7684;&#x4E00;&#x5757;&#x6808;&#x7A7A;&#x95F4;</span></span><br><span class="line">*(proc-&gt;tf) = *tf;</span><br><span class="line">proc-&gt;tf-&gt;tf_regs.reg_eax = <span class="number">0</span>;</span><br><span class="line">proc-&gt;tf-&gt;tf_esp = esp;</span><br><span class="line">proc-&gt;tf-&gt;tf_eflags |= FL_IF;       <span class="comment">// Interrupt Flag &#x8868;&#x793A;&#x6B64;&#x5185;&#x6838;&#x7EBF;&#x7A0B;&#x5728;&#x6267;&#x884C;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x80FD;&#x54CD;&#x5E94;&#x4E2D;&#x65AD;&#xFF0C;&#x6253;&#x65AD;&#x5F53;&#x524D;&#x7684;&#x6267;&#x884C;</span></span><br></pre></td></tr></table></figure>
<p>&#x5F53;&#x6267;&#x884C;iret&#x540E;&#xFF0C;cpu&#x8DF3;&#x8F6C;&#x5230;kernel_thread_entry&#x6267;&#x884C;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kernel_thread_entry:        <span class="meta"># void kernel_thread(void)</span></span><br><span class="line">  pushl %edx              <span class="meta"># push arg</span></span><br><span class="line">  call *%ebx              <span class="meta"># call fn</span></span><br><span class="line"></span><br><span class="line">  pushl %eax              <span class="meta"># save the return value of fn(arg)</span></span><br><span class="line">  call do_exit            <span class="meta"># call do_exit to terminate current thread</span></span><br></pre></td></tr></table></figure>
<p>&#x5F53;&#x6267;&#x884C;call *%ebx&#x65F6;&#xFF0C;&#x5C31;&#x5F00;&#x59CB;&#x6267;&#x884C;initproc&#x7684;&#x4E3B;&#x4F53;&#x4E86;&#x3002;Initprocde&#x7684;&#x4E3B;&#x4F53;&#x51FD;&#x6570;&#x5F88;&#x7B80;&#x5355;&#x5C31;&#x662F;&#x8F93;&#x51FA;&#x4E00;&#x6BB5;&#x5B57;&#x7B26;&#x4E32;&#xFF0C;&#x7136;&#x540E;&#x5C31;&#x8FD4;&#x56DE;&#x5230;kernel_tread_entry&#x51FD;&#x6570;&#xFF0C;&#x5E76;&#x8FDB;&#x4E00;&#x6B65;&#x8C03;&#x7528;do_exit&#x6267;&#x884C;&#x9000;&#x51FA;&#x64CD;&#x4F5C;&#x4E86;&#xFF0C;&#x81F3;&#x6B64;&#x4E00;&#x4E2A;&#x5185;&#x6838;&#x7EBF;&#x7A0B;init&#x7684;&#x6267;&#x884C;&#x7ED3;&#x675F;&#x4E86;&#x3002;</p>
<p>&#x901A;&#x8FC7;ucore&#x7684;&#x5B9E;&#x73B0;&#xFF0C;&#x53EF;&#x4EE5;&#x77E5;&#x9053;&#x5185;&#x6838;&#x7EBF;&#x7A0B;&#x7684;&#x542F;&#x52A8;&#xFF0C;<strong>&#x4F34;&#x968F;&#x7740;&#x4E0A;&#x4E0B;&#x6587;&#x5207;&#x6362;&#xFF0C;&#x8FD9;&#x91CC;&#x5305;&#x62EC;&#x901A;&#x7528;&#x5BC4;&#x5B58;&#x5668;&#x3001;&#x6BB5;&#x5BC4;&#x5B58;&#x5668;&#x3001;&#x6807;&#x5FD7;&#x5BC4;&#x5B58;&#x5668;&#x7B49;</strong>&#xFF0C;ucore&#x901A;&#x8FC7;&#x4E2D;&#x65AD;&#x8FD4;&#x56DE;&#x6307;&#x4EE4;iret&#x5B9E;&#x73B0;&#x4E86;&#x6BB5;&#x5BC4;&#x5B58;&#x5668;&#x548C;&#x6807;&#x5FD7;&#x5BC4;&#x5B58;&#x5668;&#x7684;&#x5207;&#x6362;</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/02/21/mineucore-x86-32下的中断处理/">mineucore-x86-32下的中断处理</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-02-21</time><div class="content"><h1 id="x86-32&#x4E0B;&#x7684;&#x4E2D;&#x65AD;&#x5904;&#x7406;"><a href="#x86-32&#x4E0B;&#x7684;&#x4E2D;&#x65AD;&#x5904;&#x7406;" class="headerlink" title="x86-32&#x4E0B;&#x7684;&#x4E2D;&#x65AD;&#x5904;&#x7406;"></a>x86-32&#x4E0B;&#x7684;&#x4E2D;&#x65AD;&#x5904;&#x7406;</h1><h2 id="1&#x3001;&#x4E2D;&#x65AD;&#x7684;&#x7C7B;&#x578B;"><a href="#1&#x3001;&#x4E2D;&#x65AD;&#x7684;&#x7C7B;&#x578B;" class="headerlink" title="1&#x3001;&#x4E2D;&#x65AD;&#x7684;&#x7C7B;&#x578B;"></a>1&#x3001;&#x4E2D;&#x65AD;&#x7684;&#x7C7B;&#x578B;</h2><p>&#x6765;&#x81EA;&#x786C;&#x4EF6;&#x8BBE;&#x5907;&#x7684;&#x5904;&#x7406;&#x8BF7;&#x6C42;&#x79F0;&#x4E3A;&#x786C;&#x4E2D;&#x65AD;&#xFF0C;&#x6216;&#x8005;&#x5916;&#x90E8;&#x4E2D;&#x65AD;&#x3002;&#x4ED6;&#x662F;&#x5F02;&#x6B65;&#x4EA7;&#x751F;&#x7684;&#xFF0C;&#x5373;&#x4E0E;CPU&#x7684;&#x6267;&#x884C;&#x65E0;&#x5173;&#xFF1B;<br>&#x5F02;&#x5E38;&#x662F;&#x975E;&#x6CD5;&#x6307;&#x4EE4;&#x6216;&#x8005;&#x5176;&#x4ED6;&#x539F;&#x56E0;&#x5BFC;&#x81F4;&#x5F53;&#x524D;&#x6307;&#x4EE4;&#x6267;&#x884C;&#x5931;&#x8D25;&#x540E;&#x7684;&#x5904;&#x7406;&#x8BF7;&#x6C42;&#xFF0C;&#x4E5F;&#x53EB;&#x5185;&#x90E8;&#x4E2D;&#x65AD;&#xFF0C;&#x4ED6;&#x7684;&#x4EA7;&#x751F;&#x65B9;&#x5F0F;&#x662F;&#x540C;&#x6B65;&#x7684;&#xFF1B;<br>&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4E3B;&#x52A8;&#x5411;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x53D1;&#x51FA;&#x7684;&#x670D;&#x52A1;&#x8BF7;&#x6C42;&#x79F0;&#x4E3A;&#x8F6F;&#x4E2D;&#x65AD;&#xFF08;trap&#xFF09;&#xFF0C;&#x4E5F;&#x53EB;&#x7CFB;&#x7EDF;&#x8C03;&#x7528; &#xFF0C;&#x4E00;&#x822C;&#x901A;&#x8FC7;INT n&#x6307;&#x4EE4;&#x5B9E;&#x73B0;&#xFF0C;&#x53EF;&#x4EE5;&#x662F;&#x540C;&#x6B65;&#x4EA7;&#x751F;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x662F;&#x5F02;&#x6B65;&#x4EA7;&#x751F;&#x3002;</p>
<p>INT&#x3001;IRET&#x6307;&#x4EE4;&#x7528;&#x4E8E;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#xFF0C;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x65F6;&#xFF0C;&#x5B58;&#x5728;&#x5806;&#x6808;&#x5207;&#x6362;&#x548C;&#x7279;&#x6743;&#x7EA7;&#x5207;&#x6362;<br>CALL&#x3001;RET&#x7528;&#x4E8E;&#x5E38;&#x89C4;&#x51FD;&#x6570;&#x8C03;&#x7528;</p>
<h2 id="2&#x3001;&#x4E2D;&#x65AD;&#x63CF;&#x8FF0;&#x7B26;&#x8868;IDT"><a href="#2&#x3001;&#x4E2D;&#x65AD;&#x63CF;&#x8FF0;&#x7B26;&#x8868;IDT" class="headerlink" title="2&#x3001;&#x4E2D;&#x65AD;&#x63CF;&#x8FF0;&#x7B26;&#x8868;IDT"></a>2&#x3001;&#x4E2D;&#x65AD;&#x63CF;&#x8FF0;&#x7B26;&#x8868;IDT</h2><p>&#x6BCF;&#x4E2A;&#x4E2D;&#x65AD;&#x6216;&#x5F02;&#x5E38;&#x4E0E;&#x4E00;&#x4E2A;&#x4E2D;&#x65AD;&#x670D;&#x52A1;&#x4F8B;&#x7A0B;&#x76F8;&#x5173;&#x8054;&#xFF0C;&#x5176;&#x5173;&#x8054;&#x5173;&#x7CFB;&#x5B58;&#x50A8;&#x5728;&#x4E2D;&#x65AD;&#x63CF;&#x8FF0;&#x7B26;&#x8868;&#xFF08;IDT&#xFF09;&#x4E2D;&#xFF0C;IDT&#x53EF;&#x4EE5;&#x4F4D;&#x4E8E;&#x5185;&#x5B58;&#x7684;&#x4EFB;&#x610F;&#x4F4D;&#x7F6E;&#xFF0C;IDT&#x7684;&#x8D77;&#x59CB;&#x5730;&#x5740;&#x548C;&#x5927;&#x5C0F;&#x4FDD;&#x5B58;&#x5728;&#x4E2D;&#x65AD;&#x63CF;&#x8FF0;&#x7B26;&#x8868;&#x5BC4;&#x5B58;&#x5668;&#xFF08;IDTR&#xFF09;&#x4E2D;&#xFF0C;CPU&#x53EF;&#x4EE5;&#x901A;&#x8FC7;IDTR&#x627E;&#x5230;IDT&#x3002;</p>
<p><img src="/2020/02/21/mineucore-x86-32&#x4E0B;&#x7684;&#x4E2D;&#x65AD;&#x5904;&#x7406;/image-20200221225125272.png" alt="image-20200221225125272" style="zoom:40%;"></p>
<p>IDT&#x4E2D;&#x6BCF;&#x4E00;&#x9879;&#x4E3A;&#x95E8;&#x63CF;&#x8FF0;&#x7B26;&#xFF0C;&#x542B;&#x6709;&#x6BB5;&#x9009;&#x62E9;&#x5B50;&#x548C;&#x504F;&#x79FB;&#x3002;&#x53D1;&#x751F;&#x4E2D;&#x65AD;&#x540E;&#xFF0C;CPU&#x6839;&#x636E;&#x4E2D;&#x65AD;&#x53F7;&#x5728;IDT&#x4E2D;&#x627E;&#x5230;&#x5BF9;&#x5E94;&#x7684;&#x95E8;&#x63CF;&#x8FF0;&#x7B26;&#xFF0C;&#x901A;&#x8FC7;&#x95E8;&#x63CF;&#x8FF0;&#x7B26;&#x4E2D;&#x7684;&#x6BB5;&#x9009;&#x62E9;&#x5B50;&#x53BB;GDT&#x7684;&#x6BB5;&#x63CF;&#x8FF0;&#x7B26;&#x4E2D;&#x627E;&#x5230;&#x8BE5;&#x6BB5;&#x7684;&#x57FA;&#x5740;&#xFF0C;&#x52A0;&#x4E0A;&#x95E8;&#x63CF;&#x8FF0;&#x7B26;&#x4E2D;&#x7684;&#x504F;&#x79FB;&#xFF0C;&#x4ECE;&#x800C;&#x8BA1;&#x7B97;&#x51FA;&#x4E2D;&#x65AD;&#x670D;&#x52A1;&#x4F8B;&#x7A0B;&#x6240;&#x5728;&#x7684;&#x5730;&#x5740;&#x3002;</p>
<p><img src="/2020/02/21/mineucore-x86-32&#x4E0B;&#x7684;&#x4E2D;&#x65AD;&#x5904;&#x7406;/image-20200221151425723.png" alt="image-20200221151425723" style="zoom:40%;"></p>
<p>&#x4E2D;&#x65AD;&#x63CF;&#x8FF0;&#x7B26;&#x8868;IDT&#x662F;&#x4E00;&#x4E2A;8&#x5B57;&#x8282;&#x6570;&#x7EC4;&#xFF0C;&#x6BCF;&#x4E00;&#x4E2A;&#x8868;&#x9879;&#x53EB;&#x505A;&#x4E00;&#x4E2A;&#x95E8;&#x63CF;&#x8FF0;&#x7B26;&#xFF0C;&#x201C;&#x95E8;&#x201D;&#x7684;&#x542B;&#x4E49;&#x662F;&#x6307;&#x5F53;&#x4E2D;&#x65AD;&#x53D1;&#x751F;&#x65F6;&#x5FC5;&#x987B;&#x5148;&#x8BBF;&#x95EE;&#x8FD9;&#x4E9B;&#x201C;&#x95E8;&#x201D;&#xFF0C;&#x80FD;&#x591F;&#x201C;&#x5F00;&#x95E8;&#x201D;&#xFF08;&#x5373;&#x5C06;&#x8981;&#x8FDB;&#x884C;&#x7684;&#x5904;&#x7406;&#x9700;&#x901A;&#x8FC7;&#x7279;&#x6743;&#x68C0;&#x67E5;&#xFF0C;&#x7B26;&#x5408;&#x8BBE;&#x5B9A;&#x7684;&#x6743;&#x9650;&#x7B49;&#x7EA6;&#x675F;&#xFF09;&#x540E;&#xFF0C;&#x7136;&#x540E;&#x624D;&#x80FD;&#x8FDB;&#x5165;&#x76F8;&#x5E94;&#x7684;&#x5904;&#x7406;&#x7A0B;&#x5E8F;&#xFF0C;&#x800C;&#x95E8;&#x63CF;&#x8FF0;&#x7B26;&#x5219;&#x63CF;&#x8FF0;&#x4E86;&#x201C;&#x95E8;&#x201D;&#x7684;&#x5C5E;&#x6027;&#xFF08;&#x5982;&#x7279;&#x6743;&#x7EA7;&#x3001;&#x6BB5;&#x5185;&#x504F;&#x79FB;&#x91CF;&#x7B49;&#xFF09;&#xFF0C;&#x5728;IDT&#x4E2D;&#xFF0C;&#x4E3B;&#x8981;&#x6709;3&#x79CD;&#x7C7B;&#x578B;&#x7684;&#x95E8;&#x63CF;&#x8FF0;&#x7B26;&#xFF1A;</p>
<p>1&#x3001;<strong>&#x4E2D;&#x65AD;&#x95E8;&#x63CF;&#x8FF0;&#x7B26;</strong>&#xFF08;Interrupt-gate descriptor&#xFF09;&#xFF0C;&#x7528;&#x4E8E;&#x786C;&#x4E2D;&#x65AD;&#x548C;&#x5F02;&#x5E38;&#x7684;&#x5904;&#x7406;&#xFF0C;&#x5176;&#x7C7B;&#x578B;&#x7801;&#x4E3A;110&#xFF0C;&#x4E2D;&#x65AD;&#x95E8;&#x5305;&#x542B;&#x4E86;&#x4E00;&#x4E2A;&#x5916;&#x8BBE;&#x4E2D;&#x65AD;&#x6216;&#x6545;&#x969C;&#x4E2D;&#x65AD;&#x7684;&#x5904;&#x7406;&#x7A0B;&#x5E8F;&#x6240;&#x5728;&#x6BB5;&#x7684;&#x9009;&#x62E9;&#x5B50;&#x548C;&#x6BB5;&#x5185;&#x504F;&#x79FB;&#x91CF;&#xFF0C;&#x4E2D;&#x65AD;&#x95E8;&#x4E2D;&#x7684;DPL&#xFF08;Descriptor Privilege Level&#xFF09;&#x4E3A;0&#xFF0C;&#x56E0;&#x6B64;&#x7528;&#x6237;&#x6001;&#x7684;&#x8FDB;&#x7A0B;&#x4E0D;&#x80FD;&#x8BBF;&#x95EE;&#x4E2D;&#x65AD;&#x95E8;&#x3002;&#x6240;&#x6709;&#x7684;&#x4E2D;&#x65AD;&#x5904;&#x7406;&#x7A0B;&#x5E8F;&#x90FD;&#x7531;&#x4E2D;&#x65AD;&#x95E8;&#x6FC0;&#x6D3B;&#xFF0C;&#x5E76;&#x5168;&#x90E8;&#x9650;&#x5236;&#x5728;&#x5185;&#x6838;&#x6001;&#x3002;&#x63A7;&#x5236;&#x6743;&#x901A;&#x8FC7;&#x9677;&#x9631;&#x95E8;&#x8FDB;&#x5165;&#x5904;&#x7406;&#x7A0B;&#x5E8F;&#x65F6;&#x4F1A;&#x6E05;&#x7A7A;IF&#x6807;&#x5FD7;&#xFF0C;&#x4E0D;&#x5141;&#x8BB8;&#x4E2D;&#x65AD;&#x5D4C;&#x5957;&#x7684;&#x53D1;&#x751F;&#x3002;</p>
<p>2&#x3001;<strong>&#x9677;&#x9631;&#x95E8;&#x63CF;&#x8FF0;&#x7B26;</strong>&#xFF08;Trap-gate descriptor&#xFF09;&#xFF0C;&#x7528;&#x4E8E;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7684;&#x5904;&#x7406;&#x3002;&#x4E0E;&#x4E2D;&#x65AD;&#x95E8;&#x7C7B;&#x4F3C;&#xFF0C;&#x5176;&#x552F;&#x4E00;&#x7684;&#x533A;&#x522B;&#x662F;&#xFF0C;&#x63A7;&#x5236;&#x6743;&#x901A;&#x8FC7;&#x9677;&#x9631;&#x95E8;&#x8FDB;&#x5165;&#x5904;&#x7406;&#x7A0B;&#x5E8F;&#x65F6;&#x7EF4;&#x6301;IF&#x6807;&#x5FD7;&#x4F4D;&#x4E0D;&#x53D8;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#xFF0C;&#x4E0D;&#x5173;&#x4E2D;&#x65AD;&#x3002;</p>
<p>3&#x3001;&#x4EFB;&#x52A1;&#x95E8;&#x63CF;&#x8FF0;&#x7B26;&#xFF0C;Intel&#x8BBE;&#x7F6E;&#x7684;&#x201C;&#x4EFB;&#x52A1;&#x201D;&#x5207;&#x6362;&#x7684;&#x624B;&#x6BB5;&#x3002;</p>
<p><img src="/2020/02/21/mineucore-x86-32&#x4E0B;&#x7684;&#x4E2D;&#x65AD;&#x5904;&#x7406;/image-20200221225152925.png" alt="image-20200221225152925" style="zoom:50%;"></p>
<h2 id="3&#x3001;&#x5BF9;&#x4E2D;&#x65AD;&#x5411;&#x91CF;&#x8868;&#xFF08;&#x4E2D;&#x65AD;&#x63CF;&#x8FF0;&#x7B26;&#x8868;&#xFF09;IDT&#x8FDB;&#x884C;&#x521D;&#x59CB;&#x5316;"><a href="#3&#x3001;&#x5BF9;&#x4E2D;&#x65AD;&#x5411;&#x91CF;&#x8868;&#xFF08;&#x4E2D;&#x65AD;&#x63CF;&#x8FF0;&#x7B26;&#x8868;&#xFF09;IDT&#x8FDB;&#x884C;&#x521D;&#x59CB;&#x5316;" class="headerlink" title="3&#x3001;&#x5BF9;&#x4E2D;&#x65AD;&#x5411;&#x91CF;&#x8868;&#xFF08;&#x4E2D;&#x65AD;&#x63CF;&#x8FF0;&#x7B26;&#x8868;&#xFF09;IDT&#x8FDB;&#x884C;&#x521D;&#x59CB;&#x5316;"></a>3&#x3001;&#x5BF9;&#x4E2D;&#x65AD;&#x5411;&#x91CF;&#x8868;&#xFF08;&#x4E2D;&#x65AD;&#x63CF;&#x8FF0;&#x7B26;&#x8868;&#xFF09;IDT&#x8FDB;&#x884C;&#x521D;&#x59CB;&#x5316;</h2><p>&#x5728;&#x4FDD;&#x62A4;&#x6A21;&#x5F0F;&#x4E0B;&#x6709;256&#x4E2A;&#x4E2D;&#x65AD;&#x53F7;&#xFF0C;0~31&#x662F;&#x4FDD;&#x7559;&#x4E2D;&#x65AD;&#x53F7;&#xFF0C;&#x7528;&#x4E8E;&#x5904;&#x7406;<strong>&#x5F02;&#x5E38;</strong>&#x548C;&#x4E0D;&#x53EF;&#x5C4F;&#x853D;&#x4E2D;&#x65AD;NMI&#xFF0C;32~255&#x7531;&#x7528;&#x6237;&#x5B9A;&#x4E49;&#xFF0C;&#x53EF;&#x4EE5;&#x662F;<strong>&#x8BBE;&#x5907;&#x4E2D;&#x65AD;</strong>&#x6216;<strong>&#x7CFB;&#x7EDF;&#x8C03;&#x7528;</strong>&#x3002;</p>
<p>1&#xFF09;&#x751F;&#x6210;&#x6BCF;&#x4E2A;&#x4E2D;&#x65AD;&#x53F7;&#x5BF9;&#x5E94;&#x7684;&#x4E2D;&#x65AD;&#x5904;&#x7406;&#x4F8B;&#x7A0B;&#x5730;&#x5740;</p>
<p>vectors.S&#x5305;&#x542B;&#x6240;&#x6709;&#x4E2D;&#x65AD;&#x53F7;&#x5BF9;&#x5E94;&#x7684;&#x4E2D;&#x65AD;&#x670D;&#x52A1;&#x4F8B;&#x7A0B;&#x5730;&#x5740;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># &#x7531;tools/vector.c&#x4EA7;&#x751F;</span><br><span class="line"># handler</span><br><span class="line">.text</span><br><span class="line">.globl __alltraps</span><br><span class="line">.globl vector0</span><br><span class="line">vector0:</span><br><span class="line">  pushl $0</span><br><span class="line">  pushl $0</span><br><span class="line">  jmp __alltraps</span><br><span class="line">.globl vector1</span><br><span class="line">vector1:</span><br><span class="line">  pushl $0</span><br><span class="line">  pushl $1</span><br><span class="line">  jmp __alltraps</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line"># vector table</span><br><span class="line">.data</span><br><span class="line">.globl __vectors</span><br><span class="line">__vectors:</span><br><span class="line">  .long vector0</span><br><span class="line">  .long vector1</span><br></pre></td></tr></table></figure>
<p>&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x6240;&#x6709;&#x4E2D;&#x65AD;&#x53F7;&#x5BF9;&#x5E94;&#x7684;&#x4E2D;&#x65AD;&#x670D;&#x52A1;&#x4F8B;&#x7A0B;&#x90FD;&#x4F1A;&#x8DF3;&#x8F6C;&#x5230;<code>__alltraps</code>&#x8FDB;&#x884C;&#x5904;&#x7406;</p>
<p>&#x4E0B;&#x9762;&#x4F7F;&#x7528;SETGATE&#x5C06;&#x8FD9;&#x4E9B;&#x5730;&#x5740;&#x586B;&#x5145;&#x5230;IDT&#x4E2D;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* *</span></span><br><span class="line"><span class="comment"> * Set up a normal interrupt/trap gate descriptor</span></span><br><span class="line"><span class="comment"> *   - istrap: 1 for a trap (= exception) gate, 0 for an interrupt gate</span></span><br><span class="line"><span class="comment"> *   - sel: Code segment selector for interrupt/trap handler</span></span><br><span class="line"><span class="comment"> *   - off: Offset in code segment for interrupt/trap handler</span></span><br><span class="line"><span class="comment"> *   - dpl: Descriptor Privilege Level - the privilege level required</span></span><br><span class="line"><span class="comment"> *          for software to invoke this interrupt/trap gate explicitly</span></span><br><span class="line"><span class="comment"> *          using an int instruction.</span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SETGATE(gate, istrap, sel, off, dpl) {            \</span></span><br><span class="line">    (gate).gd_off_15_0 = (<span class="keyword">uint32_t</span>)(off) &amp; <span class="number">0xffff</span>;        \</span><br><span class="line">    (gate).gd_ss = (sel);                                \</span><br><span class="line">    (gate).gd_args = <span class="number">0</span>;                                    \</span><br><span class="line">    (gate).gd_rsv1 = <span class="number">0</span>;                                    \</span><br><span class="line">    (gate).gd_type = (istrap) ? STS_TG32 : STS_IG32;    \</span><br><span class="line">    (gate).gd_s = <span class="number">0</span>;                                    \</span><br><span class="line">    (gate).gd_dpl = (dpl);                                \</span><br><span class="line">    (gate).gd_p = <span class="number">1</span>;                                    \</span><br><span class="line">    (gate).gd_off_31_16 = (<span class="keyword">uint32_t</span>)(off) &gt;&gt; <span class="number">16</span>;        \</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x6CE8;&#x610F;&#x4E2D;&#x65AD;&#x95E8;&#x7684;DPL&#x662F;0&#xFF0C;&#x9677;&#x9631;&#x95E8;&#x7684;DPL&#x662F;3</p>
<p>&#x7531;&#x4E0A;&#x53EF;&#x4EE5;&#x521D;&#x59CB;&#x5316;IDT</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">idt_init(<span class="keyword">void</span>) {</span><br><span class="line">    <span class="keyword">extern</span> <span class="keyword">uintptr_t</span> __vectors[];</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">256</span>; i ++) {</span><br><span class="line">        <span class="comment">//0&#x4E3A;&#x4E2D;&#x65AD;&#x95E8;&#xFF0C;GD_KTEXT&#x4E3A;&#x7CFB;&#x7EDF;&#x6BB5;&#x9009;&#x62E9;&#x5B50;&#xFF0C;DPL_KERNEL=0</span></span><br><span class="line">        SETGATE(idt[i], <span class="number">0</span>, GD_KTEXT, __vectors[i], DPL_KERNEL);</span><br><span class="line">    }</span><br><span class="line">    SETGATE(idt[T_SWITCH_TOK], <span class="number">0</span>, GD_KTEXT, __vectors[T_SWITCH_TOK], DPL_USER);</span><br><span class="line">	<span class="comment">// &#x52A0;&#x8F7D;LDT</span></span><br><span class="line">    lidt(&amp;idt_pd);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h1 id="4&#x3001;&#x901A;&#x8FC7;&#x4E2D;&#x65AD;&#x5B9E;&#x73B0;&#x5728;&#x5185;&#x6838;&#x6001;&#x548C;&#x7528;&#x6237;&#x6001;&#x7684;&#x5207;&#x6362;"><a href="#4&#x3001;&#x901A;&#x8FC7;&#x4E2D;&#x65AD;&#x5B9E;&#x73B0;&#x5728;&#x5185;&#x6838;&#x6001;&#x548C;&#x7528;&#x6237;&#x6001;&#x7684;&#x5207;&#x6362;" class="headerlink" title="4&#x3001;&#x901A;&#x8FC7;&#x4E2D;&#x65AD;&#x5B9E;&#x73B0;&#x5728;&#x5185;&#x6838;&#x6001;&#x548C;&#x7528;&#x6237;&#x6001;&#x7684;&#x5207;&#x6362;"></a>4&#x3001;&#x901A;&#x8FC7;&#x4E2D;&#x65AD;&#x5B9E;&#x73B0;&#x5728;&#x5185;&#x6838;&#x6001;&#x548C;&#x7528;&#x6237;&#x6001;&#x7684;&#x5207;&#x6362;</h1><p><strong>&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;&#xFF0C;&#x53D1;&#x751F;&#x4E2D;&#x65AD;&#x65F6;&#xFF0C;&#x6709;&#x4E00;&#x90E8;&#x5206;&#x538B;&#x6808;&#x64CD;&#x4F5C;&#x662F;&#x7531;&#x786C;&#x4EF6;&#x53C2;&#x4E0E;&#x7684;&#xFF0C;&#x800C;&#x4E14;&#x6839;&#x636E;&#x662F;&#x5426;&#x5B58;&#x5728;&#x7279;&#x6743;&#x7EA7;&#x7684;&#x5207;&#x6362;&#xFF0C;&#x538B;&#x5165;&#x4E0D;&#x540C;&#x7684;&#x53C2;&#x6570;&#x3002;</strong></p>
<p><strong>&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x91CD;&#x65B0;&#x68B3;&#x7406;&#x4E0B;&#x53D1;&#x751F;&#x4E2D;&#x65AD;&#x540E;&#x7684;&#x64CD;&#x4F5C;</strong>&#x3002;&#x53D1;&#x751F;&#x4E2D;&#x65AD;&#x540E;&#xFF0C;&#x82E5;&#x53D1;&#x751F;&#x7279;&#x6743;&#x7EA7;&#x7684;&#x5207;&#x6362;&#xFF08;&#x5982;&#x4ECE;&#x7528;&#x6237;&#x6001;&#x5230;&#x5185;&#x6838;&#x6001;&#xFF09;&#xFF0C;&#x5C06;SS&#x3001;ESP&#x4F9D;&#x6B21;&#x538B;&#x5165;&#x5806;&#x6808;&#x3002;&#x63A5;&#x7740;&#x538B;&#x5165;EFLAGS&#x3001;CS&#x3001;EIP&#x3001;err_code&#xFF0C;&#x4E0A;&#x8FF0;&#x8FD9;&#x4E9B;&#x538B;&#x6808;&#x64CD;&#x4F5C;&#x662F;&#x7531;&#x786C;&#x4EF6;&#x5B9E;&#x73B0;&#x3002;&#x63A5;&#x7740;CPU&#x6839;&#x636E;&#x4E2D;&#x65AD;&#x53F7;&#x5728;IDT&#x4E2D;&#x627E;&#x5230;&#x76F8;&#x5E94;&#x7684;&#x8868;&#x9879;&#xFF0C;&#x5C06;&#x4E2D;&#x65AD;&#x53F7;&#x538B;&#x6808;&#x540E;&#xFF0C;&#x8DF3;&#x8F6C;&#x5230; <code>__alltraps</code>&#xFF0C;<code>__alltraps</code>&#x5C06;&#x539F;&#x6765;&#x7684;&#x6BB5;&#x5BC4;&#x5B58;&#x5668;&#x5168;&#x90E8;&#x538B;&#x6808;&#xFF0C;&#x5E76;&#x5C06;&#x5F53;&#x524D;ESP&#x4F5C;&#x4E3A;&#x7B2C;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x8C03;&#x7528;trap&#x51FD;&#x6570;&#xFF0C;tap&#x51FD;&#x6570;&#x5C06;&#x53C2;&#x6570;&#x89E3;&#x6790;&#x6210;trapframe&#x7ED3;&#x6784;&#x4F53;&#xFF0C;&#x6839;&#x636E;&#x4E0D;&#x540C;&#x7684;&#x4E2D;&#x65AD;&#x53F7;&#x505A;&#x8FDB;&#x4E00;&#x6B65;&#x5904;&#x7406;&#x3002;trap&#x6267;&#x884C;&#x5B8C;&#x540E;&#x4F1A;&#x8C03;&#x7528;<code>__trapret</code>&#xFF0C;&#x5C06;&#x6808;&#x4E0A;&#x7684;&#x6570;&#x503C;&#x5F39;&#x56DE;&#x5BC4;&#x5B58;&#x5668;&#xFF0C;&#x786C;&#x4EF6;&#x538B;&#x6808;&#x7684;&#x53C2;&#x6570;&#x7531;iret&#x5F39;&#x56DE;&#x3002;&#x6240;&#x4EE5;&#x5F53;&#x6240;&#x6709;&#x53C2;&#x6570;&#x5B58;&#x5728;&#x6808;&#x4E0A;&#x65F6;&#x8FDB;&#x884C;&#x4FEE;&#x6539;&#xFF0C;&#x5728;&#x9000;&#x51FA;&#x4E2D;&#x65AD;&#x65F6;&#xFF0C;&#x76F8;&#x5E94;&#x7684;&#x5BC4;&#x5B58;&#x5668;&#x7684;&#x503C;&#x5C31;&#x4F1A;&#x4FEE;&#x6539;&#xFF0C;&#x4ECE;&#x800C;&#x5B8C;&#x6210;&#x7528;&#x6237;&#x6001;&#x548C;&#x5185;&#x6838;&#x6001;&#x7684;&#x5207;&#x6362;</p>
<p><strong>&#x5B9E;&#x73B0;&#x5185;&#x6838;&#x6001;&#x5230;&#x7528;&#x6237;&#x6001;&#x7684;&#x5207;&#x6362;&#xFF1A;</strong></p>
<p>&#x6B64;&#x65F6;&#x4E0D;&#x5B58;&#x5728;&#x7279;&#x6743;&#x7EA7;&#x7684;&#x5207;&#x6362;&#xFF0C;&#x53D1;&#x751F;&#x4E2D;&#x65AD;&#x65F6;&#x5F53;&#x524D;&#x6808;&#x7A7A;&#x95F4;&#x5982;&#x4E0B;&#xFF08;&#x4ECE;&#x4E0A;&#x5230;&#x4E0B;&#x4E3A;&#x4F4E;&#x5730;&#x5740;&#x5230;&#x9AD8;&#x5730;&#x5740;&#xFF09;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint16_t</span> tf_gs;</span><br><span class="line"><span class="keyword">uint16_t</span> tf_fs;</span><br><span class="line"><span class="keyword">uint16_t</span> tf_es;</span><br><span class="line"><span class="keyword">uint16_t</span> tf_ds;</span><br><span class="line"><span class="keyword">uint32_t</span> tf_trapno;</span><br><span class="line"><span class="comment">/* below here defined by x86 hardware */</span></span><br><span class="line"><span class="keyword">uint32_t</span> tf_err;</span><br><span class="line"><span class="keyword">uintptr_t</span> tf_eip;</span><br><span class="line"><span class="keyword">uint16_t</span> tf_cs;</span><br><span class="line"><span class="keyword">uint32_t</span> tf_eflags;</span><br></pre></td></tr></table></figure>
<p>&#x4E2D;&#x65AD;&#x670D;&#x52A1;&#x4F8B;&#x7A0B;&#x4EE3;&#x7801;&#xFF1A;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> T_SWITCH_TOU:</span><br><span class="line"><span class="keyword">if</span> (tf-&gt;tf_cs != USER_CS) {</span><br><span class="line">    <span class="comment">//&#x5F53;&#x524D;&#x5728;&#x5185;&#x6838;&#x6001;&#xFF0C;&#x9700;&#x8981;&#x5EFA;&#x7ACB;&#x5207;&#x6362;&#x5230;&#x7528;&#x6237;&#x6001;&#x6240;&#x9700;&#x7684;trapframe&#x7ED3;&#x6784;&#x7684;&#x6570;&#x636E;switchk2u&#xFF0C;&#x5373;&#x4FEE;&#x6539;&#x6808;&#x4E0A;&#x7684;&#x6BB5;&#x5BC4;&#x5B58;&#x5668;&#x4E3A;&#x7528;&#x6237;&#x6001;&#x6BB5;&#x5BC4;&#x5B58;&#x5668;</span></span><br><span class="line">    switchk2u = *tf;</span><br><span class="line">    switchk2u.tf_cs = USER_CS;</span><br><span class="line">    switchk2u.tf_ds = switchk2u.tf_es = switchk2u.tf_ss = USER_DS;</span><br><span class="line">    switchk2u.tf_esp = (<span class="keyword">uint32_t</span>)tf + <span class="keyword">sizeof</span>(struct trapframe) - <span class="number">8</span>;</span><br><span class="line">    <span class="comment">//&#x8BBE;&#x7F6E;EFLAG&#x7684;I/O&#x7279;&#x6743;&#x4F4D;&#xFF0C;&#x4F7F;&#x5F97;&#x5728;&#x7528;&#x6237;&#x6001;&#x53EF;&#x4F7F;&#x7528;in/out&#x6307;&#x4EE4;</span></span><br><span class="line">    switchk2u.tf_eflags |= (<span class="number">3</span> &lt;&lt; <span class="number">12</span>);</span><br><span class="line">    <span class="comment">//&#x8BBE;&#x7F6E;&#x4E34;&#x65F6;&#x6808;&#xFF0C;&#x6307;&#x5411;switchk2u&#xFF0C;&#x8FD9;&#x6837;iret&#x8FD4;&#x56DE;&#x65F6;&#xFF0C;CPU&#x4F1A;&#x4ECE;switchk2u&#x6062;&#x590D;&#x6570;&#x636E;&#xFF0C;</span></span><br><span class="line">    <span class="comment">//&#x800C;&#x4E0D;&#x662F;&#x4ECE;&#x73B0;&#x6709;&#x6808;&#x6062;&#x590D;&#x6570;&#x636E;&#x3002;</span></span><br><span class="line">    *((<span class="keyword">uint32_t</span> *)tf - <span class="number">1</span>) = (<span class="keyword">uint32_t</span>)&amp;switchk2u;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>&#x5B9E;&#x73B0;&#x7528;&#x6237;&#x6001;&#x5230;&#x5185;&#x6838;&#x6001;&#x7684;&#x5207;&#x6362;&#xFF1A;</strong></p>
<p>&#x6B64;&#x65F6;&#x53D1;&#x751F;&#x4E86;&#x7279;&#x6743;&#x7EA7;&#x7684;&#x53D8;&#x5316;&#xFF0C;&#x53D1;&#x751F;&#x4E2D;&#x65AD;&#x65F6;&#x5F53;&#x524D;&#x6808;&#x7A7A;&#x95F4;&#x5982;&#x4E0B;&#xFF08;&#x4ECE;&#x4E0A;&#x5230;&#x4E0B;&#x4E3A;&#x4F4E;&#x5730;&#x5740;&#x5230;&#x9AD8;&#x5730;&#x5740;&#xFF09;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint16_t</span> tf_gs;</span><br><span class="line"><span class="keyword">uint16_t</span> tf_fs;</span><br><span class="line"><span class="keyword">uint16_t</span> tf_es;</span><br><span class="line"><span class="keyword">uint16_t</span> tf_ds;</span><br><span class="line"><span class="keyword">uint32_t</span> tf_trapno;</span><br><span class="line"><span class="comment">/* below here defined by x86 hardware */</span></span><br><span class="line"><span class="keyword">uint32_t</span> tf_err;</span><br><span class="line"><span class="keyword">uintptr_t</span> tf_eip;</span><br><span class="line"><span class="keyword">uint16_t</span> tf_cs;</span><br><span class="line"><span class="keyword">uint32_t</span> tf_eflags;</span><br><span class="line"><span class="keyword">uintptr_t</span> tf_esp;</span><br><span class="line"><span class="keyword">uint16_t</span> tf_ss;</span><br></pre></td></tr></table></figure>
<p>&#x4E2D;&#x65AD;&#x670D;&#x52A1;&#x4F8B;&#x7A0B;&#x4EE3;&#x7801;&#xFF1A;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> T_SWITCH_TOK:</span><br><span class="line"><span class="keyword">if</span> (tf-&gt;tf_cs != KERNEL_CS) {</span><br><span class="line">    <span class="comment">//&#x53D1;&#x51FA;&#x4E2D;&#x65AD;&#x65F6;&#xFF0C;CPU&#x5904;&#x4E8E;&#x7528;&#x6237;&#x6001;&#xFF0C;&#x6211;&#x4EEC;&#x5E0C;&#x671B;&#x5904;&#x7406;&#x5B8C;&#x6B64;&#x4E2D;&#x65AD;&#x540E;&#xFF0C;CPU&#x7EE7;&#x7EED;&#x5728;&#x5185;&#x6838;&#x6001;&#x8FD0;&#x884C;&#xFF0C;</span></span><br><span class="line">    <span class="comment">//&#x4FEE;&#x6539;&#x6808;&#x4E0A;&#x7684;&#x6BB5;&#x5BC4;&#x5B58;&#x5668;&#x503C;&#x4E3A;&#x5185;&#x6838;&#x4EE3;&#x7801;&#x6BB5;&#x548C;&#x5185;&#x6838;&#x6570;&#x636E;&#x6BB5;</span></span><br><span class="line">    tf-&gt;tf_cs = KERNEL_CS;</span><br><span class="line">    tf-&gt;tf_ds = tf-&gt;tf_es = KERNEL_DS;</span><br><span class="line">    <span class="comment">//&#x8BBE;&#x7F6E;EFLAGS&#xFF0C;&#x8BA9;&#x7528;&#x6237;&#x6001;&#x4E0D;&#x80FD;&#x6267;&#x884C;in/out&#x6307;&#x4EE4;</span></span><br><span class="line">    tf-&gt;tf_eflags &amp;= ~(<span class="number">3</span> &lt;&lt; <span class="number">12</span>);</span><br><span class="line">    switchu2k = (struct trapframe *)(tf-&gt;tf_esp - (<span class="keyword">sizeof</span>(struct trapframe) - <span class="number">8</span>));</span><br><span class="line">    <span class="comment">//&#x8BBE;&#x7F6E;&#x4E34;&#x65F6;&#x6808;&#xFF0C;&#x6307;&#x5411;switchu2k&#xFF0C;&#x8FD9;&#x6837;iret&#x8FD4;&#x56DE;&#x65F6;&#xFF0C;CPU&#x4F1A;&#x4ECE;switchu2k&#x6062;&#x590D;&#x6570;&#x636E;&#xFF0C;</span></span><br><span class="line">    <span class="comment">//&#x800C;&#x4E0D;&#x662F;&#x4ECE;&#x73B0;&#x6709;&#x6808;&#x6062;&#x590D;&#x6570;&#x636E;&#x3002;</span></span><br><span class="line">    memmove(switchu2k, tf, <span class="keyword">sizeof</span>(struct trapframe) - <span class="number">8</span>);</span><br><span class="line">    *((<span class="keyword">uint32_t</span> *)tf - <span class="number">1</span>) = (<span class="keyword">uint32_t</span>)switchu2k;</span><br><span class="line"> }</span><br></pre></td></tr></table></figure>
<p>&#x6700;&#x7EC8;&#x6F14;&#x793A;&#x7ED3;&#x679C;</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">0: @ring 0</span><br><span class="line">0:  cs = 8</span><br><span class="line">0:  ds = 10</span><br><span class="line">0:  es = 10</span><br><span class="line">0:  ss = 10</span><br><span class="line">+++ switch to  user  mode +++</span><br><span class="line">1: @ring 3</span><br><span class="line">1:  cs = 1b</span><br><span class="line">1:  ds = 23</span><br><span class="line">1:  es = 23</span><br><span class="line">1:  ss = 23</span><br><span class="line">+++ switch to kernel mode +++</span><br><span class="line">2: @ring 0</span><br><span class="line">2:  cs = 8</span><br><span class="line">2:  ds = 10</span><br><span class="line">2:  es = 10</span><br><span class="line">2:  ss = 10</span><br></pre></td></tr></table></figure>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/02/20/mineucore-x86-32系统启动流程/">mineucore-x86-32系统启动流程</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-02-20</time><div class="content"><p>&#x5C06;&#x4E4B;&#x524D;&#x7684;&#x8BB0;&#x5F97;&#x4E1C;&#x897F;&#x91CD;&#x65B0;&#x6574;&#x7406;&#x6210;&#x7B14;&#x8BB0;&#xFF0C;&#x53BB;&#x5E74;10&#x6708;&#x4EFD;&#x68B3;&#x7406;&#x4E86;&#x7269;&#x7406;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#x548C;&#x865A;&#x62DF;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#x3002;</p>
<h2 id="1&#x3001;CPU&#x52A0;&#x7535;"><a href="#1&#x3001;CPU&#x52A0;&#x7535;" class="headerlink" title="1&#x3001;CPU&#x52A0;&#x7535;"></a>1&#x3001;CPU&#x52A0;&#x7535;</h2><p>CPU&#x52A0;&#x7535;&#x540E;&#xFF0C;&#x521D;&#x59CB;&#x5316;CS&#x4E0E;IP&#x5BC4;&#x5B58;&#x5668;&#x4E3A;&#x7EA6;&#x5B9A;&#x7684;&#x503C;&#xFF0C;CS&#x4E3A;0xf000&#xFF0C;IP&#x4E3A;0xfff0&#x3002;&#x4E3A;&#x4E86;&#x517C;&#x5BB9;8086&#xFF0C;&#x6B64;&#x65F6;CPU&#x5904;&#x4E8E;16&#x4F4D;&#x7684;&#x5B9E;&#x6A21;&#x5F0F;&#xFF0C;&#x6240;&#x4EE5;&#x5BC4;&#x5B58;&#x5668;&#x4E3A;16&#x4F4D;&#xFF0C;&#x901A;&#x8FC7;&#x4EE3;&#x7801;&#x6BB5;&#x5BC4;&#x5B58;&#x5668;CS&#x548C;&#x6307;&#x4EE4;&#x6307;&#x9488;&#x5BC4;&#x5B58;&#x5668;IP&#xFF0C;&#x8BA1;&#x7B97;PC&#x7684;&#x503C;&#xFF0C;&#x8BA1;&#x7B97;&#x65B9;&#x6CD5;&#x4E3A;PC = CS&lt;&lt;4 +IP&#xFF0C;&#x8FD9;&#x662F;&#x4E00;&#x4E2A;20&#x4F4D;&#x7684;&#x5730;&#x5740;&#xFF0C;&#x6240;&#x4EE5;&#x5B9E;&#x6A21;&#x5F0F;&#x4E0B;CPU&#x7684;&#x5BFB;&#x5740;&#x7A7A;&#x95F4;&#x4E3A;1MB&#xFF0C;&#x8BA1;&#x7B97;&#x5F97;&#x5230;&#x7684;PC = 0xFFFF0&#xFF0C;&#x8FD9;&#x5C31;&#x662F;CPU&#x6267;&#x884C;&#x7684;&#x7B2C;&#x4E00;&#x6761;&#x6307;&#x4EE4;&#xFF0C;<strong>&#x8BE5;&#x6307;&#x4EE4;&#x662F;&#x4E00;&#x4E2A;&#x957F;&#x8DF3;&#x8F6C;&#x6307;&#x4EE4;&#xFF0C;jmp F000:E05B&#xFF0C;&#x8DF3;&#x8F6C;&#x5230;BIOS&#x7A0B;&#x5E8F;&#x8D77;&#x59CB;&#x70B9;</strong>&#xFF0C;&#x5B9E;&#x9645;&#x5730;&#x5740;&#x662F;Base+EIP = FFFF0000 + 0000FFF0 = FFFFFFF0&#x3002;</p>
<h2 id="2&#x3001;BIOS"><a href="#2&#x3001;BIOS" class="headerlink" title="2&#x3001;BIOS"></a>2&#x3001;BIOS</h2><p>1&#x3001;BIOS&#x9996;&#x5148;&#x8FDB;&#x884C;&#x786C;&#x4EF6;&#x81EA;&#x68C0;<br>2&#x3001;&#x8BFB;&#x53D6;&#x4E3B;&#x5F15;&#x5BFC;&#x8BB0;&#x5F55;&#xFF08;MBR&#xFF09;&#x3002;&#x5F53;BIOS&#x68C0;&#x67E5;&#x5230;&#x786C;&#x4EF6;&#x6B63;&#x5E38;&#x5E76;&#x4E0E;CMOS&#x4E2D;&#x7684;&#x8BBE;&#x7F6E;&#x76F8;&#x7B26;&#x540E;&#xFF0C;&#x6309;&#x7167;CMOS&#x4E2D;&#x5BF9;&#x542F;&#x52A8;&#x8BBE;&#x5907;&#x7684;&#x8BBE;&#x7F6E;&#x987A;&#x5E8F;&#x68C0;&#x6D4B;&#x53EF;&#x7528;&#x7684;&#x542F;&#x52A8;&#x8BBE;&#x5907;&#x3002;BIOS&#x5C06;&#x76F8;&#x5E94;&#x542F;&#x52A8;&#x8BBE;&#x5907;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x6247;&#x533A;&#x8BFB;&#x5165;&#x5185;&#x5B58;&#x5730;&#x5740;&#x4E3A;<strong>0000:7C00H</strong>&#x5904;&#x3002;<br>3&#x3001;BIOS&#x68C0;&#x67E5;MBR&#x6247;&#x533A;&#x7684;&#x7ED3;&#x675F;&#x6807;&#x5FD7;&#x662F;&#x4E0D;&#x662F;0x55AA&#xFF0C;&#x82E5;&#x6EE1;&#x8DB3;&#x8981;&#x6C42;&#xFF0C;&#x5219;&#x79FB;&#x4EA4;&#x63A7;&#x5236;&#x6743;&#x7ED9;MBR&#x3002;</p>
<p> <strong>&#x7CFB;&#x7EDF;&#x7684;&#x542F;&#x52A8;&#x89C4;&#x8303;&#xFF1A;</strong></p>
<p>BIOS&#xFF1A;BIOS-MBR&#x3001;BIOS-GPT(&#x5168;&#x5C40;&#x552F;&#x4E00;&#x6807;&#x8BC6;&#x5206;&#x533A;&#x8868;)&#x3001;PXE<br>UEFI&#xFF1A;&#x7EDF;&#x4E00;&#x53EF;&#x6269;&#x5C55;&#x56FA;&#x4EF6;&#x63A5;&#x53E3;&#xFF0C;&#x6BD4;BIOS&#x52A0;&#x5165;&#x4E86;&#x5806;&#x5F15;&#x5BFC;&#x8BB0;&#x5F55;&#x7684;&#x53EF;&#x4FE1;&#x6027;&#x8FDB;&#x884C;&#x4E86;&#x68C0;&#x67E5;&#x7B49;</p>
<p><strong>BIOS&#x529F;&#x80FD;&#xFF1A;</strong>(Basic Input Output System&#xFF0C;&#x5373;&#x57FA;&#x672C;&#x8F93;&#x5165;/&#x8F93;&#x51FA;&#x7CFB;&#x7EDF;&#xFF09;&#x56FA;&#x8BDD;&#x5728;&#x4E3B;&#x677F;&#x4E0A;&#x7684;&#x7A0B;&#x5E8F;<br>&#x4EE5;&#x4E2D;&#x65AD;&#x8C03;&#x7528;&#x7684;&#x65B9;&#x5F0F;&#x5B9E;&#x73B0;&#x57FA;&#x672C;&#x7684;I/O&#x529F;&#x80FD;&#x3002;<br>INT 10h&#xFF1A;&#x5B57;&#x7B26;&#x663E;&#x793A;<br>INT 13h&#xFF1A;&#x78C1;&#x76D8;&#x6247;&#x533A;&#x8BFB;&#x5199;<br>INT 15h&#xFF1A;&#x68C0;&#x6D4B;&#x5185;&#x5B58;&#x5927;&#x5C0F;<br>INT 16h&#xFF1B;&#x78C1;&#x76D8;&#x8F93;&#x5165;<br>&#xFF08;&#x5728;intel&#x7684;CPU&#x4E2D;&#xFF0C;BIOS&#x53EA;&#x80FD;&#x5728;x86&#x7684;&#x5B9E;&#x6A21;&#x5F0F;&#x4E0B;&#x5DE5;&#x4F5C;&#xFF09;</p>
<p><strong>Q1&#xFF1A;&#x4E3A;&#x4EC0;&#x4E48;&#x4E0D;&#x5728;BIOS&#x4E2D;&#x76F4;&#x63A5;&#x52A0;&#x8F7D;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#xFF1F;</strong><br>&#x78C1;&#x76D8;&#x5B58;&#x5728;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#xFF0C;BIOS&#x4E0D;&#x53EF;&#x80FD;&#x8BC6;&#x522B;&#x6240;&#x6709;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#xFF0C;&#x6240;&#x4EE5;BIOS&#x4E0D;&#x7BA1;&#x78C1;&#x76D8;&#x7684;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x7684;&#x7C7B;&#x578B;&#xFF0C;&#x76F4;&#x63A5;&#x4ECE;&#x78C1;&#x76D8;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x6247;&#x533A;&#x8BFB;&#x53D6;&#x52A0;&#x8F7D;&#x7A0B;&#x5E8F;&#xFF0C;&#x7528;&#x52A0;&#x8F7D;&#x7A0B;&#x5E8F;&#x8BC6;&#x522B;&#x78C1;&#x76D8;&#x7684;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x7C7B;&#x578B;&#xFF0C;&#x5C06;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x52A0;&#x8F7D;&#x8FDB;&#x5185;&#x5B58;</p>
<h2 id="3&#x3001;MBR&#x4E3B;&#x5F15;&#x5BFC;&#x8BB0;&#x5F55;"><a href="#3&#x3001;MBR&#x4E3B;&#x5F15;&#x5BFC;&#x8BB0;&#x5F55;" class="headerlink" title="3&#x3001;MBR&#x4E3B;&#x5F15;&#x5BFC;&#x8BB0;&#x5F55;"></a>3&#x3001;MBR&#x4E3B;&#x5F15;&#x5BFC;&#x8BB0;&#x5F55;</h2><p>MBR&#x5C06;&#x81EA;&#x5DF1;&#x590D;&#x5236;&#x5230;0000:0600H&#x5904;&#xFF0C;&#x7136;&#x540E;&#x6267;&#x884C;446&#x5B57;&#x8282;&#xFF08;&#x4E00;&#x5171;512&#x5B57;&#x8282;&#xFF09;&#x7684;&#x542F;&#x52A8;&#x4EE3;&#x7801;<br>&#x626B;&#x63CF;&#x5206;&#x533A;&#x8868;&#x67E5;&#x627E;&#x6D3B;&#x52A8;&#x5206;&#x533A;&#xFF1B;<br>&#x5BFB;&#x627E;&#x6D3B;&#x52A8;&#x5206;&#x533A;&#x7684;&#x8D77;&#x59CB;&#x6247;&#x533A;&#xFF1B;<br>&#x5C06;&#x6D3B;&#x52A8;&#x5206;&#x533A;&#x7684;&#x5F15;&#x5BFC;&#x6247;&#x533A;&#x8BFB;&#x5230;&#x5185;&#x5B58;&#xFF1B;<br>&#x6267;&#x884C;&#x5F15;&#x5BFC;&#x6247;&#x533A;&#x7684;&#x8FD0;&#x884C;&#x4EE3;&#x7801;</p>
<h2 id="4&#x3001;&#x6D3B;&#x52A8;&#x5206;&#x533A;&#x7684;&#x5F15;&#x5BFC;&#x6247;&#x533A;"><a href="#4&#x3001;&#x6D3B;&#x52A8;&#x5206;&#x533A;&#x7684;&#x5F15;&#x5BFC;&#x6247;&#x533A;" class="headerlink" title="4&#x3001;&#x6D3B;&#x52A8;&#x5206;&#x533A;&#x7684;&#x5F15;&#x5BFC;&#x6247;&#x533A;"></a>4&#x3001;&#x6D3B;&#x52A8;&#x5206;&#x533A;&#x7684;&#x5F15;&#x5BFC;&#x6247;&#x533A;</h2><p>&#x6D3B;&#x52A8;&#x5206;&#x533A;&#x7684;&#x5F15;&#x5BFC;&#x6247;&#x533A;&#x7B2C;&#x4E00;&#x6761;&#x662F;&#x8DF3;&#x8F6C;&#x6307;&#x4EE4;&#xFF0C;&#x8DF3;&#x8F6C;&#x5230;&#x5F15;&#x5BFC;&#x4EE3;&#x7801;&#xFF0C;&#x6267;&#x884C;&#x52A0;&#x8F7D;&#x7A0B;&#x5E8F;<br>&#xFF08;&#x6D3B;&#x52A8;&#x5206;&#x533A;&#x662F;&#x6307;&#x78C1;&#x76D8;&#x4E3B;&#x5206;&#x533A;&#x7684;&#x4E00;&#x79CD;&#x72B6;&#x6001;&#x3002;&#x6807;&#x8BB0;&#x5206;&#x533A;&#x4E3A;&#x6D3B;&#x52A8;&#x5206;&#x533A;&#x7684;&#x76EE;&#x7684;&#x662F;&#x4E3A;&#x4E86;&#x8BA9;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x7531;&#x8BE5;&#x533A;&#x542F;&#x52A8;&#xFF0C;&#x6240;&#x4EE5;&#x901A;&#x5E38;&#x5C06;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x7684;&#x5206;&#x533A;&#x6807;&#x8BB0;&#x4E3A;&#x6D3B;&#x52A8;&#x5206;&#x533A;&#xFF09;</p>
<h2 id="5&#x3001;bootloader"><a href="#5&#x3001;bootloader" class="headerlink" title="5&#x3001;bootloader"></a>5&#x3001;bootloader</h2><p><strong>1&#x3001;&#x5F00;&#x542F;A20</strong><br><strong>2&#x3001;&#x521D;&#x59CB;&#x5316;GDT</strong><br><strong>3&#x3001;&#x4F7F;&#x80FD;&#x4FDD;&#x62A4;&#x6A21;&#x5F0F;&#xFF08;&#x5206;&#x6BB5;&#x673A;&#x5236;&#x5728;&#x4FDD;&#x62A4;&#x6A21;&#x5F0F;&#x4E0B;&#x81EA;&#x52A8;&#x4F7F;&#x80FD;&#xFF09;</strong><br>4&#x3001;&#x8BFB;&#x53D6;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#xFF0C;&#x4ECE;&#x786C;&#x76D8;&#x4E0A;&#x8BFB;&#x53D6;kernel&#xFF0C;&#x5E76;&#x653E;&#x5230;&#x5185;&#x5B58;&#x4E2D;&#x7684;&#x56FA;&#x5B9A;&#x4F4D;&#x7F6E;<br>5&#x3001;&#x8DF3;&#x8F6C;&#x5230;kernel&#x7684;&#x5165;&#x53E3;&#x70B9;entry point&#x6267;&#x884C;</p>
<h2 id="6&#x3001;&#x5F00;&#x542F;A20&#x5730;&#x5740;&#x7EBF;"><a href="#6&#x3001;&#x5F00;&#x542F;A20&#x5730;&#x5740;&#x7EBF;" class="headerlink" title="6&#x3001;&#x5F00;&#x542F;A20&#x5730;&#x5740;&#x7EBF;"></a>6&#x3001;&#x5F00;&#x542F;A20&#x5730;&#x5740;&#x7EBF;</h2><p>&#x5728;i8086&#x65F6;&#x4EE3;&#xFF0C;CPU&#x7684;&#x5730;&#x5740;&#x603B;&#x7EBF;&#x4E3A;16&#x4F4D;&#xFF0C;&#x6570;&#x636E;&#x603B;&#x7EBF;&#x4E3A;20&#x4F4D;&#xFF0C;&#x6700;&#x5927;&#x5BFB;&#x5740;&#x7A7A;&#x95F4;&#x4E3A;1MB&#xFF0C;&#x4F46;&#x662F;&#x5230;&#x4E86;i80286/i80386&#xFF0C;CPU&#x7684;&#x5730;&#x5740;&#x603B;&#x7EBF;&#x53D8;&#x6210;&#x4E86;32&#x4F4D;&#xFF0C;&#x5BFB;&#x5740;&#x7A7A;&#x95F4;&#x4E3A;4GB&#xFF0C;&#x4F46;&#x662F;&#x4E3A;&#x4E86;&#x517C;&#x5BB9;i8086&#xFF0C;CPU&#x5728;&#x52A0;&#x7535;&#x542F;&#x52A8;&#x65F6;&#x4ECD;&#x7136;&#x662F;20&#x4F4D;&#x5BFB;&#x5740;&#xFF0C;&#x6B64;&#x65F6;&#x4E3A;&#x5B9E;&#x6A21;&#x5F0F;&#xFF0C;CPU&#x901A;&#x8FC7;A20&#x5730;&#x5740;&#x7EBF;&#x6A21;&#x5757;&#xFF0C;&#x5728;&#x5B9E;&#x6A21;&#x5F0F;&#x4E0B;&#x5C06;&#x7B2C;20&#x4F4D;&#x7684;&#x5730;&#x5740;&#x7EBF;&#x9650;&#x5236;&#x4E3A;0&#xFF0C;&#x8FD9;&#x6837;CPU&#x5C31;&#x4E0D;&#x80FD;&#x8BBF;&#x95EE;&#x8D85;&#x8FC7;1MB&#x7684;&#x7A7A;&#x95F4;&#x4E86;&#x3002;bootloader&#x8981;&#x4ECE;&#x5B9E;&#x6A21;&#x5F0F;&#x5207;&#x6362;&#x5230;&#x4FDD;&#x62A4;&#x6A21;&#x5F0F;&#xFF0C;&#x83B7;&#x5F97;&#x66F4;&#x5927;&#x7684;&#x5BFB;&#x5740;&#x7A7A;&#x95F4;&#xFF0C;&#x5C31;&#x8981;&#x5F00;&#x542F;A20&#x5730;&#x5740;&#x7EBF;&#xFF0C;&#x83B7;&#x5F97;&#x9AD8;&#x4F4D;&#x5730;&#x5740;&#x7EBF;&#x3002;&#x4E8B;&#x5B9E;&#x4E0A;&#xFF0C;A20&#x5C31;&#x662F;&#x7B2C;21&#x6839;&#x7EBF;&#xFF0C;&#x7528;&#x6765;&#x63A7;&#x5236;&#x662F;&#x5426;&#x5141;&#x8BB8;&#x5BF9; 0x10FFEF &#x4EE5;&#x4E0A;&#x7684;&#x5B9E;&#x9645;&#x5185;&#x5B58;&#x5BFB;&#x5740;&#x3002;&#x79F0;&#x4E3A;A20 Gate&#x3002;</p>
<h2 id="7&#x3001;&#x521D;&#x59CB;&#x5316;GDT&#xFF08;&#x5168;&#x5C40;&#x63CF;&#x8FF0;&#x7B26;&#x8868;&#xFF09;"><a href="#7&#x3001;&#x521D;&#x59CB;&#x5316;GDT&#xFF08;&#x5168;&#x5C40;&#x63CF;&#x8FF0;&#x7B26;&#x8868;&#xFF09;" class="headerlink" title="7&#x3001;&#x521D;&#x59CB;&#x5316;GDT&#xFF08;&#x5168;&#x5C40;&#x63CF;&#x8FF0;&#x7B26;&#x8868;&#xFF09;"></a>7&#x3001;&#x521D;&#x59CB;&#x5316;GDT&#xFF08;&#x5168;&#x5C40;&#x63CF;&#x8FF0;&#x7B26;&#x8868;&#xFF09;</h2><p>&#x4F7F;&#x80FD;&#x4E86;A20&#x5730;&#x5740;&#x7EBF;&#xFF0C;&#x6709;&#x4E86;&#x66F4;&#x5927;&#x7684;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#xFF0C;&#x5C31;&#x9700;&#x8981;&#x5F00;&#x542F;&#x5206;&#x6BB5;&#x5F0F;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#x3002;GDT&#x8868;&#x7531;bootloader&#x521B;&#x5EFA;&#xFF0C;&#x6BCF;&#x4E00;&#x9879;&#x4E3A;&#x6BB5;&#x63CF;&#x8FF0;&#x7B26;&#xFF0C;&#x6BB5;&#x63CF;&#x8FF0;&#x7B26;&#x4E2D;&#x63CF;&#x8FF0;&#x4E86;&#x8BE5;&#x6BB5;&#x7684;&#x8D77;&#x59CB;&#x5730;&#x5740;base&#x548C;&#x5927;&#x5C0F;limit&#x7B49;&#x6570;&#x636E;&#x3002;&#x5728;&#x6CA1;&#x6709;&#x542F;&#x52A8;&#x9875;&#x673A;&#x5236;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x7EBF;&#x6027;&#x5730;&#x5740;&#x7B49;&#x4E8E;&#x7269;&#x7406;&#x5730;&#x5740;</p>
<p><img src="/2020/02/20/mineucore-x86-32&#x7CFB;&#x7EDF;&#x542F;&#x52A8;&#x6D41;&#x7A0B;/image-20200221104935105.png" alt="image-20200221104935105" style="zoom:50%;"></p>
<p>&#x5230;&#x4E86;&#x5206;&#x6BB5;&#x5F0F;&#x5185;&#x5B58;&#xFF0C;&#x5BF9;&#x5185;&#x5B58;&#x7684;&#x8BBF;&#x95EE;&#x5C31;&#x9700;&#x8981;&#x77E5;&#x9053;&#x5728;&#x54EA;&#x4E2A;&#x6BB5;&#xFF0C;&#x4EE5;&#x53CA;&#x504F;&#x79FB;&#x91CF;&#x3002;CS&#x3001;SS&#x7B49;&#x6BB5;&#x5BC4;&#x5B58;&#x5668;&#x4FDD;&#x5B58;&#x7684;&#x6709;&#x6BB5;&#x9009;&#x62E9;&#x5B50;&#xFF0C;&#x6BB5;&#x9009;&#x62E9;&#x5B50;&#x5305;&#x542B;&#x4E86;&#x8BE5;&#x6BB5;&#x5728;GDT&#x4E2D;&#x7684;&#x4E0B;&#x6807;&#xFF0C;&#x8FDB;&#x800C;&#x627E;&#x5230;&#x8BE5;&#x6BB5;&#x5BF9;&#x5E94;&#x7684;&#x6BB5;&#x63CF;&#x8FF0;&#x7B26;&#xFF0C;&#x901A;&#x8FC7;base&#x52A0;&#x4E0A;&#x504F;&#x79FB;&#x8FDB;&#x884C;&#x5BFB;&#x5740;&#x3002;</p>
<p><img src="/2020/02/20/mineucore-x86-32&#x7CFB;&#x7EDF;&#x542F;&#x52A8;&#x6D41;&#x7A0B;/image-20200221105607933.png" alt="image-20200221105607933" style="zoom:50%;"></p>
<h2 id="8&#x3001;&#x4F7F;&#x80FD;&#x4FDD;&#x62A4;&#x6A21;&#x5F0F;"><a href="#8&#x3001;&#x4F7F;&#x80FD;&#x4FDD;&#x62A4;&#x6A21;&#x5F0F;" class="headerlink" title="8&#x3001;&#x4F7F;&#x80FD;&#x4FDD;&#x62A4;&#x6A21;&#x5F0F;"></a>8&#x3001;&#x4F7F;&#x80FD;&#x4FDD;&#x62A4;&#x6A21;&#x5F0F;</h2><p>&#x5F00;&#x542F;A20&#x3001;&#x521D;&#x59CB;&#x5316;GDT&#x540E;&#xFF0C;&#x9700;&#x8981;&#x4F7F;&#x80FD;&#x4FDD;&#x62A4;&#x6A21;&#x5F0F;&#xFF0C;&#x5C06;CR0&#x5BC4;&#x5B58;&#x5668;&#x7684;PE&#x4F4D;(bit0)&#x7F6E;&#x4E3A;1&#x5373;&#x53EF;&#x4F7F;&#x80FD;&#x4FDD;&#x62A4;&#x6A21;&#x5F0F;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">movl %cr0, %eax</span><br><span class="line">orl 0x1, %eax</span><br><span class="line">movl %eax, %cr0</span><br></pre></td></tr></table></figure>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/02/19/inlineHookS/">inlineHookS安卓内联hook框架</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-02-19</time><div class="content"><h1 id="PROLOGUE"><a href="#PROLOGUE" class="headerlink" title="PROLOGUE"></a>PROLOGUE</h1><p>1&#x3001;&#x83B7;&#x5F97;&#x76EE;&#x6807;&#x51FD;&#x6570;&#x7B26;&#x53F7;&#x5730;&#x5740;&#xFF0C;&#x5C06;&#x76EE;&#x6807;NDK&#x5E93;&#x6620;&#x5C04;&#x5230;&#x5185;&#x5B58;&#xFF0C;&#x5E76;&#x89E3;&#x6790;&#x52A8;&#x6001;&#x7B26;&#x53F7;&#x8868;&#x548C;&#x52A8;&#x6001;&#x5B57;&#x7B26;&#x4E32;&#x8868;&#xFF0C;&#x83B7;&#x5F97;&#x76EE;&#x6807;&#x51FD;&#x6570;&#x7684;&#x7B26;&#x53F7;&#x5730;&#x5740;&#xFF08;&#x4E3A;&#x4E86;&#x7A81;&#x7834;android7&#x540E;&#x7CFB;&#x7EDF;&#x5BF9;&#x79C1;&#x6709;NDK&#x5E93;&#x7684;&#x8BBF;&#x95EE;&#x9650;&#x5236;&#xFF09;</p>
<p>2&#x3001;hook&#x8FC7;&#x7A0B;&#x6709;4&#x4E2A;&#x8DF3;&#x677F;&#x4EE3;&#x7801;&#x7EC4;&#x6210;&#xFF0C;&#x56E0;&#x4E3A;arm&#x67B6;&#x6784;&#x7684;&#x4E09;&#x7EA7;&#x6D41;&#x6C34;&#x7EBF;&#x8BBE;&#x8BA1;&#xFF0C;&#x5728;hook&#x70B9;&#x9996;&#x5148;&#x8981;&#x5907;&#x4EFD;8&#x5B57;&#x8282;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x5C06;&#x5176;&#x4FEE;&#x6539;&#x4E3A;&#x957F;&#x8DF3;&#x8F6C;&#x6307;&#x4EE4;&#xFF0C;&#x8DF3;&#x8F6C;&#x5230;&#x8DF3;&#x677F;0-beforeshellcoode&#xFF0C;&#x5728;beforeshellcode&#x4E2D;&#x9996;&#x5148;&#x5C06;&#x5904;&#x7406;&#x673A;&#x4E0A;&#x4E0B;&#x6587;&#x538B;&#x5165;&#x6808;&#xFF0C;&#x5E76;&#x5C06;sp&#x8D4B;&#x503C;&#x7ED9;r0&#xFF0C;&#x5C06;lr&#x8D4B;&#x503C;&#x7ED9;&#x4E86;r1&#xFF0C;&#x63A5;&#x7740;&#x56DE;&#x8C03;beforehook&#x51FD;&#x6570;&#xFF0C;&#x7531;&#x4E8E;arm32&#x7684;&#x51FD;&#x6570;&#x8C03;&#x7528;&#x7EA6;&#x5B9A;&#xFF0C;&#x8FDB;&#x5165;&#x88AB;&#x8C03;&#x51FD;&#x6570;&#x4F53;&#x540E;&#xFF0C;r0~r4&#x4E3A;&#x524D;4&#x4E2A;&#x53C2;&#x6570;&#xFF08;&#x4E4B;&#x540E;&#x7684;&#x53C2;&#x6570;&#x5728;&#x6808;&#x4E0A;&#xFF09;&#xFF0C;&#x6240;&#x4EE5;beforehook&#x51FD;&#x6570;&#x5C31;&#x53EF;&#x4EE5;&#x5F97;&#x5230;&#x76EE;&#x6807;&#x51FD;&#x6570;&#x7684;&#x53C2;&#x6570;&#xFF0C;&#x5E76;&#x53EF;&#x4FEE;&#x6539;&#x6808;&#x4E0A;&#x7684;&#x53C2;&#x6570;&#xFF0C;beforeshellcode&#x6700;&#x540E;&#x4F1A;&#x5C06;&#x6808;&#x4E0A;&#x7684;&#x5185;&#x5BB9;&#x5F39;&#x56DE;&#x539F;&#x5BC4;&#x5B58;&#x5668;&#xFF0C;&#x5B8C;&#x6210;&#x4E86;&#x53C2;&#x6570;&#x7684;&#x8F93;&#x51FA;&#x4E0E;&#x4FEE;&#x6539;&#x3002;</p>
<p>3&#x3001;&#x56E0;&#x4E3A;&#x5F88;&#x96BE;&#x5224;&#x65AD;&#x51FD;&#x6570;&#x4F53;&#x7684;&#x7ED3;&#x5C3E;&#xFF0C;&#x6240;&#x4EE5;&#x9009;&#x62E9;&#x51FD;&#x6570;&#x8FD4;&#x56DE;&#x540E;&#x7684;&#x5730;&#x5740;&#x4F5C;&#x4E3A;afterhook&#x51FD;&#x6570;&#x7684;hook&#x70B9;&#xFF0C;&#x901A;&#x8FC7;beforehook&#x51FD;&#x6570;&#x83B7;&#x5F97;lr&#x5BC4;&#x5B58;&#x5668;&#x7684;&#x503C;&#xFF0C;&#x5E76;&#x5728;beforehook&#x51FD;&#x6570;&#x5C3E;&#x5B9E;&#x73B0;lr&#x6307;&#x5411;&#x5730;&#x5740;&#x7684;&#x6307;&#x4EE4;&#x7684;hook&#xFF0C;&#x5C06;&#x5176;&#x8DF3;&#x8F6C;&#x5230;&#x8DF3;&#x677F;2-afterhookshellcode&#xFF0C;&#x5728;afterhook&#x4E2D;&#x8F93;&#x51FA;&#x6216;&#x4FEE;&#x6539;r0&#x7684;&#x503C;&#xFF0C;&#x5373;&#x53EF;&#x5B8C;&#x6210;&#x51FD;&#x6570;&#x8FD4;&#x56DE;&#x503C;&#x7684;&#x8F93;&#x51FA;&#x548C;&#x4FEE;&#x6539;&#x3002;</p>
<p>4&#x3001;&#x5B8C;&#x6210;&#x4E0A;&#x8FF0;&#x7684;hook&#xFF0C;&#x4E00;&#x5171;hook&#x4E86;&#x4E24;&#x5904;&#x4EE3;&#x7801;&#xFF0C;&#x56E0;&#x4E3A;&#x5907;&#x4EFD;&#x7684;&#x4EE3;&#x7801;&#x53EF;&#x80FD;&#x5B58;&#x5728;&#x6D89;&#x53CA;PC&#x6307;&#x4EE4;&#x6216;&#x76F8;&#x5BF9;&#x8DF3;&#x8F6C;&#x7684;&#x64CD;&#x4F5C;&#xFF0C;&#x800C;&#x6267;&#x884C;&#x5B8C;beforeshellcoode&#x548C;afterhookshellcode&#x540E;&#x7684;PC&#x503C;&#x5DF2;&#x7ECF;&#x6539;&#x53D8;&#x6216;&#x8005;&#x76F8;&#x5BF9;&#x5730;&#x5740;&#x4E0D;&#x518D;&#x6307;&#x5411;&#x6B63;&#x786E;&#x7684;&#x5730;&#x5740;&#x3002;&#x56E0;&#x6B64;&#x9700;&#x8981;&#x6307;&#x4EE4;&#x4FEE;&#x590D;&#xFF0C;&#x4FEE;&#x590D;&#x6307;&#x4EE4;&#x5206;&#x522B;&#x5728;beforeshellcode&#x548C;aftershellcode&#x540E;&#x7684;&#x8DF3;&#x677F;1&#x548C;&#x8DF3;&#x677F;2&#x4E2D;&#xFF0C;&#x5B9E;&#x73B0;&#x8DF3;&#x8F6C;&#x56DE;&#x5230;hook&#x70B9;</p>
<ul>
<li>&#x5BF9;&#x4E8E;&#x6D89;&#x53CA;PC&#x6307;&#x4EE4;&#x7684;&#x4FEE;&#x590D;&#xFF0C;&#x662F;&#x9009;&#x4E00;&#x4E2A;&#x6682;&#x65F6;&#x7528;&#x4E0D;&#x5230;&#x7684;&#x5BC4;&#x5B58;&#x5668;Rr&#x4FDD;&#x5B58;&#x539F;PC&#x7684;&#x503C;&#xFF0C;&#x4FEE;&#x6539;&#x6307;&#x4EE4;&#xFF0C;&#x5C06;PC&#x5BC4;&#x5B58;&#x5668;&#x66FF;&#x6362;&#x4E3A;Rr&#xFF0C;&#x5373;&#x53EF;&#x5B8C;&#x6210;&#x4FEE;&#x590D;&#x3002;</li>
<li>&#x5BF9;&#x4E8E;&#x76F8;&#x5BF9;&#x5730;&#x5740;&#x7684;&#x8DF3;&#x8F6C;&#xFF0C;&#x5219;&#x662F;&#x5148;&#x8BA1;&#x7B97;&#x51FA;&#x7EDD;&#x5BF9;&#x5730;&#x5740;&#xFF0C;&#x4F7F;&#x7528;&#x5BC4;&#x5B58;&#x5668;&#x8FDC;&#x8DF3;&#x5B8C;&#x6210;&#x6307;&#x4EE4;&#x4FEE;&#x590D;&#x3002;</li>
</ul>
<p>5&#x3001;<strong>&#xFF08;&#x5B58;&#x5728;&#x95EE;&#x9898;2.27&#x66F4;&#x65B0;&#xFF09;</strong>&#x60F3;&#x5B9E;&#x73B0;&#x4EFB;&#x610F;&#x8FDB;&#x7A0B;&#x7684;hook&#xFF0C;&#x5C31;&#x9700;&#x8981;&#x5C06;hook&#x5E93;&#x6CE8;&#x5165;&#x5230;&#x76EE;&#x6807;&#x8FDB;&#x7A0B;&#xFF0C;Xposed&#x901A;&#x8FC7;&#x66FF;&#x6362;app_process&#xFF0C;&#x5C06;&#x4EE3;&#x7801;&#x6CE8;&#x5165;&#x5230;zygote&#x8FDB;&#x7A0B;&#xFF0C;&#x8FD9;&#x6837;&#x6BCF;&#x4E2A;app&#x8FDB;&#x7A0B;&#x90FD;&#x5B58;&#x5728;xposed&#x7684;&#x4EE3;&#x7801;&#x3002;libc.so&#x6BCF;&#x4E2A;app&#x4E5F;&#x90FD;&#x4F1A;&#x8C03;&#x7528;&#xFF0C;&#x5C1D;&#x8BD5;&#x901A;&#x8FC7;patch libc.so&#x7684;.init_array&#x8282;&#x533A;&#xFF0C;&#x5C06;&#x5176;&#x6307;&#x5411;&#x4E00;&#x6BB5;shellcode&#xFF0C;shellcode&#x52A0;&#x8F7D;hook&#x5E93;&#xFF0C;&#x5E76;&#x5728;&#x8FD4;&#x56DE;&#x503C;&#x8C03;&#x7528;&#x6E90;.init_array&#x4E2D;&#x7684;&#x51FD;&#x6570;&#x3002;&#x8FD9;&#x6837;&#x6BCF;&#x4E2A;&#x8FDB;&#x7A0B;&#x786E;&#x5B9E;&#x88AB;&#x6CE8;&#x5165;&#x4E86;hook&#x5E93;&#xFF0C;&#x4F46;&#x662F;app&#x5728;&#x542F;&#x52A8;&#x65F6;&#x5E76;&#x6CA1;&#x6709;&#x89E6;&#x53D1;hook&#x5E93;&#x4E2D;&#x7684;JNI_Onload&#x51FD;&#x6570;&#x3002;</p>
<blockquote>
<p>&#x95EE;&#x9898;&#xFF1A;zygote&#x5728;&#x88AB;&#x590D;&#x5236;&#x524D;&#x5DF2;&#x7ECF;&#x52A0;&#x8F7D;&#x4E86;libc.so&#xFF0C;&#x800C;&#x6240;&#x6709;app&#x90FD;&#x662F;&#x590D;&#x5236;&#x7684;zygote&#xFF0C;&#x6240;&#x4EE5;libc.so&#x4E0D;&#x662F;&#x88AB;&#x6240;&#x6709;app&#x8FDB;&#x7A0B;&#x52A0;&#x8F7D;&#xFF0C;&#x800C;&#x662F;&#x88AB;zygote&#x52A0;&#x8F7D;&#x3002;&#x6240;&#x4EE5;hook&#x5E93;&#x6CA1;&#x6709;&#x5728;app&#x542F;&#x52A8;&#x65F6;&#x8C03;&#x7528;JNI_Onload&#x4E2D;&#x7684;&#x51FD;&#x6570;&#x3002;</p>
</blockquote>
<p>&#x4E0B;&#x9762;&#x5177;&#x4F53;&#x8BF4;&#x4E0B;&#x5B9E;&#x73B0;&#x7EC6;&#x8282;&#xFF1A;</p>
<h1 id="1&#x3001;&#x83B7;&#x5F97;&#x51FD;&#x6570;&#x7B26;&#x53F7;&#x5730;&#x5740;"><a href="#1&#x3001;&#x83B7;&#x5F97;&#x51FD;&#x6570;&#x7B26;&#x53F7;&#x5730;&#x5740;" class="headerlink" title="1&#x3001;&#x83B7;&#x5F97;&#x51FD;&#x6570;&#x7B26;&#x53F7;&#x5730;&#x5740;"></a>1&#x3001;&#x83B7;&#x5F97;&#x51FD;&#x6570;&#x7B26;&#x53F7;&#x5730;&#x5740;</h1><p>android7&#x540E;&#xFF0C;&#x7CFB;&#x7EDF;&#x5C06;&#x963B;&#x6B62;&#x5E94;&#x7528;&#x52A8;&#x6001;&#x94FE;&#x63A5;&#x975E;&#x516C;&#x5F00;NDK&#x5E93;&#xFF0C;&#x6240;&#x4EE5;&#x91C7;&#x7528;&#x81EA;&#x6620;&#x5C04;&#x76EE;&#x6807;NDK&#x5E93;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x89E3;&#x6790;ELF&#x6587;&#x4EF6;&#xFF0C;&#x83B7;&#x5F97;.dynsym&#x3001;.dynstr&#x8282;&#x533A;&#x7684;&#x4FE1;&#x606F;&#x548C;&#x7A0B;&#x5E8F;&#x5B9A;&#x4E49;&#x8282;&#x533A;&#x504F;&#x79FB;&#xFF0C;&#x5C06;&#x5176;&#x4FDD;&#x5B58;&#x5728;ctx&#x7ED3;&#x6784;&#x4F53;&#x53D8;&#x91CF;&#x4E2D;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> *ctx = my_dlopen(libpath);</span><br></pre></td></tr></table></figure>
<p><strong>my_dlopen&#x5185;&#x5BB9;&#xFF1A;</strong></p>
<p>1&#x3001;&#x5C06;&#x76EE;&#x6807;NDK&#x5E93;&#x6620;&#x5C04;&#x5230;&#x5185;&#x5B58;&#x4E2D;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fd = open(libPath, O_RDONLY)</span><br><span class="line">elf = (Elf32_Ehdr *) mmap(<span class="number">0</span>, size, PROT_READ, MAP_SHARED, fd, <span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>2&#x3001;&#x4ECE;ELF header&#x83B7;&#x5F97;&#x8282;&#x533A;&#x5934;&#x8868;section header table&#x7684;&#x504F;&#x79FB;</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">shtoff</span> = elf-&gt;e_sh<span class="literal">off</span>;</span><br></pre></td></tr></table></figure>
<p>3&#x3001;&#x904D;&#x5386;&#x8282;&#x533A;&#x5934;&#x8868;&#x627E;&#x5230;&#x7C7B;&#x578B;&#x4E3A;SHT_DYNSYM&#x7684;&#x8282;&#x533A;&#x5934;&#xFF0C;&#x5373;.dynsym&#x8282;&#x533A;&#x5934;&#xFF0C;&#x6839;&#x636E;&#x8282;&#x533A;&#x504F;&#x79FB;sh_off&#x3001;&#x8282;&#x533A;&#x5927;&#x5C0F;sh_size&#x5C06;.dynsym&#x8282;&#x533A;&#x62F7;&#x8D1D;&#x5185;&#x5B58;&#x4E2D;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Elf_Shdr *sh = (Elf_Shdr *)shtAddr;</span><br><span class="line">ctx-&gt;dynsym = <span class="built_in">calloc</span>(<span class="number">1</span>, sh-&gt;sh_size);</span><br><span class="line"><span class="built_in">memcpy</span>(ctx-&gt;dynsym, ((<span class="keyword">void</span> *) elf + sh-&gt;sh_offset), sh-&gt;sh_size);</span><br></pre></td></tr></table></figure>
<p>4&#x3001;&#x904D;&#x5386;&#x8282;&#x533A;&#x5934;&#x8868;&#x627E;&#x5230;&#x7C7B;&#x578B;&#x4E3A;SHT_STRTAB&#x7684;&#x8282;&#x533A;&#x5934;&#xFF0C;&#x5373;.dynstr&#x8282;&#x533A;&#x5934;&#xFF0C;&#x6839;&#x636E;&#x8282;&#x533A;&#x504F;&#x79FB;sh_off&#x3001;&#x8282;&#x533A;&#x5927;&#x5C0F;sh_size&#x5C06;.dynstr&#x8282;&#x533A;&#x62F7;&#x8D1D;&#x5185;&#x5B58;&#x4E2D;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ctx-&gt;dynstr = <span class="built_in">calloc</span>(<span class="number">1</span>, sh-&gt;sh_size);</span><br><span class="line"><span class="built_in">memcpy</span>(ctx-&gt;dynstr, (<span class="keyword">void</span> *) elf + sh-&gt;sh_offset, sh-&gt;sh_size);</span><br></pre></td></tr></table></figure>
<p><del>5&#x3001;&#x904D;&#x5386;&#x8282;&#x533A;&#x5934;&#x8868;&#x627E;&#x5230;&#x7C7B;&#x578B;&#x4E3A;SHT_PROGBITS&#x7684;&#x8282;&#x533A;&#x5934;&#xFF0C;&#x5373;&#x7A0B;&#x5E8F;&#x5B9A;&#x4E49;&#x8282;&#x533A;&#xFF0C;&#x8BA1;&#x7B97;&#x5F97;&#x5230;&#x504F;&#x79FB;&#xFF0C;</del>&#x5728;<strong>&#x52A8;&#x6001;&#x94FE;&#x63A5;&#x5E93;&#x6587;&#x4EF6;&#x4E2D; sh-&gt;sh_addr = sh-&gt;sh_offset</strong></p>
<p><del>ctx-&gt;off = sh-&gt;sh_addr - sh-&gt;sh_offset;</del></p>
<p><strong>&#x901A;&#x8FC7;my_dlsym&#x83B7;&#x5F97;&#x7B26;&#x53F7;&#x5730;&#x5740;</strong></p>
<p>.dynsym&#x8282;&#x533A;&#x4E2D;&#x7684;&#x7B26;&#x53F7;&#x540D;&#x4E3A;.dymstr&#x8282;&#x533A;&#x7684;&#x4E0B;&#x6807;&#xFF0C;&#x901A;&#x8FC7;&#x7B26;&#x53F7;&#x540D;&#x627E;&#x5230;&#x7B26;&#x53F7;&#x7684;&#x504F;&#x79FB;&#xFF0C;&#x8BA1;&#x7B97;&#x51FA;&#x7B26;&#x53F7;&#x5730;&#x5740;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">my_dlsym</span><span class="params">(<span class="keyword">void</span> *ctxStruct,<span class="keyword">char</span> *symName)</span></span>{</span><br><span class="line">    <span class="keyword">if</span>(ctxStruct==<span class="literal">NULL</span>){</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    }</span><br><span class="line">    CTXINFO *ctx = (CTXINFO*)ctxStruct;</span><br><span class="line">    Elf_Sym *sym =(Elf_Sym*) ctx-&gt;dynsym;</span><br><span class="line">    <span class="keyword">char</span> *dynstrAddr = ctx-&gt;dynstr;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;ctx-&gt;symsNum;i++,sym++){</span><br><span class="line">        <span class="keyword">char</span> *name = dynstrAddr+sym-&gt;st_name;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strcmp</span>(name,symName)==<span class="number">0</span>){</span><br><span class="line">            <span class="keyword">void</span> *res = ctx-&gt;execAddr+sym-&gt;st_value-ctx-&gt;off;</span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h1 id="2&#x3001;&#x56DE;&#x8C03;&#x51FD;&#x6570;"><a href="#2&#x3001;&#x56DE;&#x8C03;&#x51FD;&#x6570;" class="headerlink" title="2&#x3001;&#x56DE;&#x8C03;&#x51FD;&#x6570;"></a>2&#x3001;&#x56DE;&#x8C03;&#x51FD;&#x6570;</h1><p> <strong>hook&#x51FD;&#x6570;&#x7684;&#x53C2;&#x6570;</strong></p>
<p>&#x5728;shellcode&#x4E2D;&#xFF0C;&#x4FDD;&#x5B58;&#x4E0A;&#x4E0B;&#x6587;&#xFF0C;&#x5C06;&#x901A;&#x7528;&#x5BC4;&#x5B58;&#x5668;&#x3001;CPSR&#x3001;LR&#x3001;SP&#x4FDD;&#x5B58;&#x5230;&#x6808;&#x4E0A;&#xFF0C;&#x5E76;&#x5C06;sp&#x8D4B;&#x503C;&#x7ED9;R0&#xFF0C;&#x7136;&#x540E;&#x56DE;&#x8C03;beforeHook&#x51FD;&#x6570;&#xFF0C;&#x53C2;&#x6570;&#x7528; <code>struct pt_regs *</code>&#x7C7B;&#x578B;&#x63A5;&#x6536;&#xFF0C;&#x83B7;&#x5F97;&#x548C;&#x4FEE;&#x6539;&#x51FD;&#x6570;&#x53C2;&#x6570;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mov     r0, sp</span><br><span class="line">ldr     r1,[sp,#0x38]</span><br><span class="line">ldr     r3, _new_function_addr_s</span><br><span class="line">blx     r3</span><br></pre></td></tr></table></figure>
<p><strong>hook&#x51FD;&#x6570;&#x8FD4;&#x56DE;&#x503C;</strong></p>
<p>&#x5F88;&#x96BE;&#x786E;&#x5B9A;&#x51FD;&#x6570;&#x8FD4;&#x56DE;&#x65F6;PC&#x7684;&#x503C;&#xFF0C;&#x6240;&#x4EE5;&#x901A;&#x8FC7;&#x5728;beforeHook&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x4E2D;&#x83B7;&#x5F97;LR&#x7684;&#x503C;&#xFF0C;&#x5BF9;LR&#x6240;&#x5728;&#x7684;&#x6307;&#x4EE4;&#x8FDB;&#x884C;hook&#xFF0C;&#x901A;&#x8FC7;R0&#x83B7;&#x5F97;&#x548C;&#x4FEE;&#x6539;&#x51FD;&#x6570;&#x8FD4;&#x56DE;&#x503C;&#x3002;</p>
<h1 id="3&#x3001;&#x6307;&#x4EE4;&#x4FEE;&#x590D;"><a href="#3&#x3001;&#x6307;&#x4EE4;&#x4FEE;&#x590D;" class="headerlink" title="3&#x3001;&#x6307;&#x4EE4;&#x4FEE;&#x590D;"></a>3&#x3001;&#x6307;&#x4EE4;&#x4FEE;&#x590D;</h1><p>&#x91C7;&#x7528;&#x8DF3;&#x677F;&#x7684;&#x65B9;&#x5F0F;&#x8DF3;&#x56DE;&#x539F;&#x6307;&#x4EE4;&#xFF0C;&#x56E0;&#x4E3A;arm&#x67B6;&#x6784;&#x7684;&#x4E09;&#x7EA7;&#x6D41;&#x6C34;&#x7EBF;&#x8BBE;&#x8BA1;&#xFF0C;&#x5728;&#x8DF3;&#x56DE;&#x539F;&#x6307;&#x4EE4;&#x7684;&#x8DF3;&#x677F;&#x4E2D;&#xFF0C;&#x9700;&#x8981;&#x6709;&#x5907;&#x4EFD;&#x7684;2&#x6761;&#x6307;&#x4EE4;&#xFF0C;&#x5982;&#x679C;&#x8FD9;&#x4E24;&#x6761;&#x6307;&#x4EE4;&#x6D89;&#x53CA;PC&#x7684;&#x64CD;&#x4F5C;&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x9700;&#x8981;&#x5BF9;&#x6307;&#x4EE4;&#x4FEE;&#x590D;</p>
<h2 id="B-BL-BX-BLX&#x6307;&#x4EE4;&#x4FEE;&#x590D;"><a href="#B-BL-BX-BLX&#x6307;&#x4EE4;&#x4FEE;&#x590D;" class="headerlink" title="B BL BX BLX&#x6307;&#x4EE4;&#x4FEE;&#x590D;"></a>B BL BX BLX&#x6307;&#x4EE4;&#x4FEE;&#x590D;</h2><p>&#x9488;&#x5BF9;&#x5982;&#x4E0B;&#x6307;&#x4EE4;&#x60C5;&#x51B5;&#x8FDB;&#x884C;&#x4FEE;&#x590D;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">B imme24</span><br><span class="line">BL imme24</span><br><span class="line">BX PC</span><br><span class="line">BLX imme24</span><br></pre></td></tr></table></figure>
<p>imme24&#x8868;&#x793A;&#x6709;&#x7B26;&#x53F7;&#x7684;26&#x4F4D;&#x6574;&#x6570;&#xFF0C;&#x56E0;&#x4E3A;arm32&#x5730;&#x5740;&#x662F;4&#x5B57;&#x8282;&#x5BF9;&#x9F50;&#xFF0C;&#x6240;&#x4EE5;&#x540E;2bit&#x4E3A;0&#xFF0C;&#x56E0;&#x6B64;&#x7528;24bit&#x8868;&#x793A;26bit&#x6570;&#x636E;&#x3002;</p>
<p>&#x9996;&#x5148;&#x662F;&#x8BA1;&#x7B97;&#x8DF3;&#x8F6C;&#x7684;&#x771F;&#x6B63;&#x5730;&#x5740;&#xFF0C;imme24&#x662F;&#x76F8;&#x5BF9;PC&#x503C;&#x7684;&#x5730;&#x5740;&#xFF0C;PC&#x662F;32&#x4F4D;&#x6709;&#x7B26;&#x53F7;&#x7684;&#x6574;&#x6570;&#xFF0C;&#x56E0;&#x6B64;&#x8981;&#x60F3;&#x8BA1;&#x7B97;&#x771F;&#x6B63;&#x7684;&#x5730;&#x5740;&#xFF0C;&#x9700;&#x8981;&#x5C06;26bit&#x6570;&#x636E;&#x7B26;&#x53F7;&#x6269;&#x5145;&#x5230;32&#x4F4D;&#xFF0C;<strong>&#x8BA1;&#x7B97;&#x540E;&#x7684;&#x503C;&#x8981;&#x7528;&#x6709;&#x7B26;&#x53F7;&#x6574;&#x578B;&#x5B58;&#x50A8;</strong>&#xFF0C;&#x5177;&#x4F53;&#x64CD;&#x4F5C;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> imme32;</span><br><span class="line"><span class="keyword">int</span> value;</span><br><span class="line">x = (instruction &amp; <span class="number">0xFFFFFF</span>); <span class="comment">//&#x53D6;&#x6307;&#x4EE4;&#x4E2D;&#x7684;24bit&#x7ACB;&#x5373;&#x6570;</span></span><br><span class="line">topBit = x &gt;&gt; <span class="number">23</span>;</span><br><span class="line">imme32 = topBit ? ((x &lt;&lt; <span class="number">2</span>) | <span class="number">0xFC000000</span>) : x&lt;&lt;<span class="number">2</span>;</span><br><span class="line">value = imme32 + pc;</span><br><span class="line">&#x5BF9;&#x4E8E;BX PC&#x7684;&#x60C5;&#x51B5;&#xFF0C;value = pc</span><br></pre></td></tr></table></figure>
<p>BL&#x3001;BLX&#x94FE;&#x63A5;&#x8DF3;&#x8F6C;&#x540E;&#x4F1A;&#x901A;&#x8FC7;LR&#x5BC4;&#x5B58;&#x5668;&#x8FD4;&#x56DE;&#xFF0C;&#x6240;&#x4EE5;&#x4FEE;&#x590D;&#x65B9;&#x6848;&#x662F;&#x5C06;&#x8DF3;&#x8F6C;&#x6539;&#x6210;LDR PC&#x7684;&#x5F62;&#x5F0F;&#xFF0C;&#x5E76;&#x624B;&#x52A8;&#x4FEE;&#x6539;LR&#x5BC4;&#x5B58;&#x5668;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ADD LR, PC, #4</span><br><span class="line">LDR PC, [PC, #-4]</span><br><span class="line">value</span><br><span class="line">LDR PC,[PC,#-4]</span><br><span class="line">backAddr</span><br></pre></td></tr></table></figure>
<h2 id="LDR"><a href="#LDR" class="headerlink" title="LDR"></a>LDR</h2><p>&#x9488;&#x5BF9;&#x4EE5;&#x4E0B;&#x6307;&#x4EE4;&#x60C5;&#x51B5;&#x4FEE;&#x590D;&#xFF1A;&#xFF08;&#x8FD9;&#x91CC;&#x6CA1;&#x89C1;&#x8FC7; <strong>LDR Rd,[Rm,PC]</strong> &#x7684;&#x60C5;&#x51B5;&#xFF09;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LDR Rd,[PC,Rm]</span><br><span class="line">LDR Rd,[PC,#imme]</span><br></pre></td></tr></table></figure>
<p>LDR&#x547D;&#x4EE4;&#x7B2C;23 bit&#x4F4D;&#xFF0C;U&#x6807;&#x5FD7;&#x4F4D;&#x8868;&#x793A;&#x52A0;&#x51CF;&#xFF0C;0&#x51CF;1&#x52A0;&#x3002;&#x4FEE;&#x590D;&#x7684;&#x4E3B;&#x8981;&#x601D;&#x8DEF;&#x662F;&#x7528;&#x4E00;&#x4E2A;&#x4E34;&#x65F6;&#x5BC4;&#x5B58;&#x5668;r&#x6765;&#x4FDD;&#x5B58;PC&#x7684;&#x503C;&#xFF0C;r&#x4E0D;&#x80FD;&#x662F;Rd&#x6216;&#x8005;Rm&#xFF0C;&#x5C06;&#x4E0A;&#x8FF0;&#x6307;&#x4EE4;&#x4FEE;&#x6539;&#x4E3A;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LDR Rd,[r,Rm]</span><br><span class="line">LDR Rd,[r,#imme]</span><br></pre></td></tr></table></figure>
<p>&#x5177;&#x4F53;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PUSH {r}</span><br><span class="line">LDR r,[PC,#8]		;r&#x4E3A;PC&#x7684;&#x503C;</span><br><span class="line">LDR Rd,[r,Rm]		;&#x5C06;LDR Rd,[PC,Rm]&#x4E2D;&#x7684;PC&#x66FF;&#x6362;</span><br><span class="line">POP {r}</span><br><span class="line">ADD PC,PC,#0</span><br><span class="line">pc</span><br><span class="line">LDR PC,[PC,#-4]</span><br><span class="line">backAddr</span><br></pre></td></tr></table></figure>
<p>&#x7528; <code>ADD PC,PC,#0</code> &#x5BF9;PC&#x7684;&#x64CD;&#x4F5C;&#x4F1A;&#x6E05;&#x7A7A;&#x4E09;&#x7EA7;&#x6D41;&#x6C34;&#x7EBF;&#xFF0C;&#x90A3;&#x4E48;PC&#x5C31;&#x4F1A;&#x8DF3;&#x8FC7;&#x6B63;&#x5728;&#x53D6;&#x7801;&#xFF0C;&#x8BD1;&#x7801;&#x7684;&#x6307;&#x4EE4;&#xFF0C;&#x4ECE; <code>LDR PC,[PC,#-4]</code> &#x5F00;&#x59CB;&#x53D6;&#x7801;</p>
<h2 id="ADD&#x3001;MOV"><a href="#ADD&#x3001;MOV" class="headerlink" title="ADD&#x3001;MOV"></a>ADD&#x3001;MOV</h2><p>&#x9488;&#x5BF9;&#x4EE5;&#x4E0B;&#x6307;&#x4EE4;&#x7C7B;&#x578B;&#x4FEE;&#x590D;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ADD Rd,PC,Rm</span><br><span class="line">ADD Rd,PC</span><br><span class="line">MOV Rd,PC</span><br></pre></td></tr></table></figure>
<p>&#x4FEE;&#x590D;&#x65B9;&#x6CD5;&#x548C;LDR&#x7C7B;&#x4F3C;&#xFF0C;&#x5C06;PC&#x7528;&#x53E6;&#x5916;&#x4E00;&#x4E2A;&#x5BC4;&#x5B58;&#x5668;r&#x66FF;&#x6362;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ADD Rd,r,Rm</span><br><span class="line">ADD Rd,r</span><br><span class="line">MOV Rd,r</span><br></pre></td></tr></table></figure>
<h2 id="ADR"><a href="#ADR" class="headerlink" title="ADR"></a>ADR</h2><p>ADR&#x662F;&#x5C0F;&#x8303;&#x56F4;&#x7684;&#x5730;&#x5740;&#x8BFB;&#x53D6;&#x4F2A;&#x6307;&#x4EE4;.ADR &#x6307;&#x4EE4;&#x5C06;&#x57FA;&#x4E8E;PC &#x76F8;&#x5BF9;&#x504F;&#x79FB;&#x7684;&#x5730;&#x5740;&#x503C;&#x8BFB;&#x53D6;&#x5230;&#x5BC4;&#x5B58;&#x5668;&#x4E2D;.&#x5728;&#x6C47;&#x7F16;&#x7F16;&#x8BD1;&#x6E90;&#x7A0B;&#x5E8F;&#x65F6;,ADR &#x4F2A;&#x6307;&#x4EE4;&#x88AB;&#x7F16;&#x8BD1;&#x5668;&#x66FF;&#x6362;ADD &#x6307;&#x4EE4;&#x6216;SUB &#x6307;&#x4EE4;&#x6765;&#x5B9E;&#x73B0;&#x8BE5;ADR &#x4F2A;&#x6307;&#x4EE4;&#x7684;&#x529F;&#x80FD;&#xFF0C;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ldr r0, _start</span><br><span class="line">adr r0, _start</span><br><span class="line">ldr r0, =_start</span><br><span class="line">_start:</span><br><span class="line">b _start</span><br><span class="line"></span><br><span class="line">0x00000000: e59f0004 ldr r0, [pc, #4] ; 0xc</span><br><span class="line">0x00000004: e28f0000 add r0, pc, #0 ; 0x0</span><br><span class="line">0x00000008: e59f0000 ldr r0, [pc, #0] ; 0x10</span><br><span class="line">0x0000000c: eafffffe b 0xc</span><br><span class="line"></span><br><span class="line">r0 = 0xeafffffe</span><br><span class="line">r0 = 0x0000000c</span><br><span class="line">r0 = 0x0000000c</span><br></pre></td></tr></table></figure>
<h1 id="4&#x3001;patch-libc-so"><a href="#4&#x3001;patch-libc-so" class="headerlink" title="4&#x3001;patch libc.so"></a>4&#x3001;patch libc.so</h1><p>&#x4E3A;&#x4E86;&#x5B9E;&#x73B0;hook&#x4EFB;&#x610F;&#x52A8;&#x6001;&#x94FE;&#x63A5;&#x5E93;&#x4E2D;&#x7684;&#x51FD;&#x6570;&#xFF0C;&#x9700;&#x8981;&#x628A;&#x751F;&#x6210;&#x7684;so&#x6CE8;&#x5165;&#x5230;&#x76EE;&#x6807;&#x8FDB;&#x7A0B;&#x3002;</p>
<p>&#x88AB; <code>__attribute__((constructor))</code> &#x4FEE;&#x9970;&#x7684;&#x51FD;&#x6570;&#x4F1A;&#x51FA;&#x73B0;&#x5728;&#x52A8;&#x6001;&#x94FE;&#x63A5;&#x5E93;&#x7684; <code>.init_array</code>&#x8282;&#x533A;&#xFF0C;.init_array&#x8282;&#x533A;&#x4E2D;&#x7684;&#x51FD;&#x6570;&#x6307;&#x9488;&#x5728;&#x52A8;&#x6001;&#x94FE;&#x63A5;&#x5E93;&#x88AB;&#x52A0;&#x8F7D;&#x65F6;&#x5C31;&#x4F1A;&#x8FD0;&#x884C;&#x3002;&#x90A3;&#x4E48;&#x53EF;&#x4EE5;patch libc.so&#x7684; <code>.init_array</code>&#x8282;&#x533A;&#xFF0C;&#x4F7F;&#x52A0;&#x8F7D;libc.so&#x65F6;&#xFF0C;&#x81EA;&#x52A8;&#x52A0;&#x8F7D;hookso&#x3002;</p>
<p>&#x5C06;&#x8FD9;&#x6BB5;shellcode&#x6307;&#x4EE4;&#x653E;&#x5728;.rodata&#x6BB5;&#xFF0C;&#x4FEE;&#x6539; <code>.init_array</code>&#x8282;&#x533A;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x6307;&#x9488;&#xFF0C;&#x4F7F;&#x4E4B;&#x6307;&#x5411;shellcode&#x6307;&#x4EE4;&#xFF0C;&#x5E76;&#x5728;shellcode&#x6307;&#x4EE4;&#x6700;&#x540E;&#xFF0C;&#x8C03;&#x7528;&#x539F;&#x51FD;&#x6570;&#x6307;&#x9488;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">STMFD	SP!,{R0-R8,LR}</span><br><span class="line">LDR R0,[PC,#24]				;R0 = 0xC</span><br><span class="line">MOV R1,#0</span><br><span class="line">ADD R0,PC,R0</span><br><span class="line">;dlopen(&quot;soName&quot;,0)</span><br><span class="line">; dlopenAddr = (dlopenOff - PC)&gt;&gt;2 = (dlopenOff - (shellcodeOff+0x18)) &gt;&gt;2</span><br><span class="line">BL dlopenAddr</span><br><span class="line">LDMFD	SP!,{R0-R8,LR}</span><br><span class="line">LDR R0,[PC,#8]</span><br><span class="line">ADD R0,PC,R0</span><br><span class="line">BX R0</span><br><span class="line">soNameOff - shellcodeOff - 5*4</span><br><span class="line">oldInitAddr - shellcodeOff - 9*4</span><br><span class="line">0x0</span><br></pre></td></tr></table></figure>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/01/31/内存壳学习/">内存壳学习</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-01-31</time><div class="content"><p>&#x5185;&#x5B58;&#x58F3;&#x7684;&#x4FDD;&#x62A4;&#x65B9;&#x5F0F;&#x4E3B;&#x8981;&#x662F;&#x901A;&#x8FC7;&#x52A8;&#x6001;&#x52A0;&#x8F7D;&#x7684;&#x65B9;&#x5F0F;&#x4FDD;&#x62A4;&#x6E90;dex&#x3002;</p>
<p>DexShellS&#x7684;&#x4E3B;&#x8981;&#x529F;&#x80FD;&#x662F;&#x89E3;&#x5BC6;&#x91CA;&#x653E;&#x6E90;dex&#xFF0C;&#x5E76;&#x79FB;&#x4EA4;&#x63A7;&#x5236;&#x6743;&#xFF0C;&#x5F00;&#x59CB;&#x6E90;dex&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#x3002;</p>
<h2 id="1&#x3001;&#x91CD;&#x5199;attachBaseContext&#xFF0C;&#x66FF;&#x6362;LoadedApk&#x4E2D;&#x7684;mClassLoader"><a href="#1&#x3001;&#x91CD;&#x5199;attachBaseContext&#xFF0C;&#x66FF;&#x6362;LoadedApk&#x4E2D;&#x7684;mClassLoader" class="headerlink" title="1&#x3001;&#x91CD;&#x5199;attachBaseContext&#xFF0C;&#x66FF;&#x6362;LoadedApk&#x4E2D;&#x7684;mClassLoader"></a>1&#x3001;&#x91CD;&#x5199;attachBaseContext&#xFF0C;&#x66FF;&#x6362;LoadedApk&#x4E2D;&#x7684;mClassLoader</h2><p>&#x52A0;&#x8F7D;App&#x7684;classloader&#x88AB;&#x4FDD;&#x5B58;&#x5728;LoadedApk&#x7C7B;&#x7684;mClassLoader&#x5C5E;&#x6027;&#x4E2D;&#xFF0C;&#x6240;&#x4EE5;&#x9996;&#x5148;&#x8981;&#x627E;&#x5230;&#x8FD9;&#x4E2A;mClassLoader&#x3002;&#x6BCF;&#x4E00;&#x4E2A;App&#x90FD;&#x6709;&#x7684;ActivityThread&#x5BF9;&#x8C61;&#xFF0C;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x9759;&#x6001;&#x65B9;&#x6CD5;currentActivityThread&#x83B7;&#x5F97;&#xFF0C;ActivityThread&#x7C7B;&#x6709;&#x4E00;&#x4E2A;ArrayMap&#x7C7B;&#x578B;&#x7684;&#x53D8;&#x91CF;mPackages&#xFF0C;&#x4FDD;&#x5B58;&#x4E86;packageName&#x5230;LoadedApk&#x5BF9;&#x8C61;&#x7684;&#x6620;&#x5C04;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Object currentActivityThread = RefInvoke.invokeStaticMethod(<span class="string">&quot;android.app.ActivityThread&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;currentActivityThread&quot;</span>,</span><br><span class="line">                    <span class="keyword">new</span> Class[]{},<span class="keyword">new</span> Object[]{});</span><br><span class="line">ArrayMap mPackages = (ArrayMap)RefInvoke.getFieldObject(<span class="string">&quot;android.app.ActivityThread&quot;</span>,</span><br><span class="line">                    currentActivityThread,</span><br><span class="line">                    <span class="string">&quot;mPackages&quot;</span>);</span><br><span class="line">String packageName = <span class="keyword">this</span>.getPackageName();</span><br><span class="line">WeakReference wr = (WeakReference) mPackages.get(packageName);<span class="comment">//get LoadedApk</span></span><br></pre></td></tr></table></figure>
<p>&#x83B7;&#x5F97;LoadedApk&#x8FDB;&#x800C;&#x53EF;&#x4EE5;&#x83B7;&#x5F97;&#x6E90;classloader&#xFF0C;&#x6E90;classloader&#x4FDD;&#x5B58;&#x4E86;&#x539F;&#x5148;&#x52A0;&#x8F7D;&#x7684;&#x8D44;&#x6E90;&#xFF0C;&#x7531;&#x4E8E;&#x53CC;&#x4EB2;&#x59D4;&#x6D3E;&#x673A;&#x5236;&#xFF0C;&#x6211;&#x4EEC;&#x4E0D;&#x80FD;&#x653E;&#x5F03;&#x6E90;classloader</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ClassLoader mClassLoader = (ClassLoader)RefInvoke.getFieldObject(<span class="string">&quot;android.app.LoadedApk&quot;</span>,wr.get(),<span class="string">&quot;mClassLoader&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>&#x52A0;&#x8F7D;&#x91CA;&#x653E;&#x540E;&#x7684;&#x6E90;dex&#xFF0C;&#x5E76;&#x7EE7;&#x627F;&#x4E8E;&#x6E90;classloader</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DexClassLoader dexClassLoader = <span class="keyword">new</span> DexClassLoader(apkFileName, odexPath, libPath, mClassLoader);</span><br></pre></td></tr></table></figure>
<p>&#x8FD9;&#x4E2A;&#x65B0;&#x7684;classloader&#x662F;&#x901A;&#x8FC7;DexClassLoader&#x52A0;&#x8F7D;&#x5F97;&#x5230;&#x7684;&#xFF0C;&#x5E76;&#x4E0D;&#x80FD;&#x62E5;&#x6709;onCreate&#x7B49;&#x751F;&#x547D;&#x5468;&#x671F;&#xFF0C;&#x6240;&#x4EE5;&#x8FD8;&#x8981;&#x5C06;&#x5176;&#x8D4B;&#x503C;&#x7ED9;LoadedApk&#x7684;mClassLoader&#x5C5E;&#x6027;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RefInvoke.setFieldObject(<span class="string">&quot;android.app.LoadedApk&quot;</span>, <span class="string">&quot;mClassLoader&quot;</span>,wr.get(),dexClassLoader);</span><br></pre></td></tr></table></figure>
<p>&#x4EE5;&#x4E0A;&#x5C31;&#x5B8C;&#x6210;&#x4E86;&#x66FF;&#x6362;LoadedApk&#x4E2D;&#x7684;mClassLoader&#x7684;&#x66FF;&#x6362;&#x3002;&#x56E0;&#x4E3A;application&#x7B49;&#x5C5E;&#x6027;&#x8FD8;&#x662F;DexShellS&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x6B64;&#x65F6;&#x52A0;&#x8F7D;&#x7684;&#x6E90;Dex&#x8FD8;&#x4E0D;&#x80FD;&#x62E5;&#x6709;&#x6B63;&#x5E38;&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#xFF0C;&#x9700;&#x8981;&#x505A;&#x8FDB;&#x4E00;&#x6B65;&#x5C4F;&#x853D;&#x3002;</p>
<h2 id="2&#x3001;&#x91CD;&#x5199;onCreate"><a href="#2&#x3001;&#x91CD;&#x5199;onCreate" class="headerlink" title="2&#x3001;&#x91CD;&#x5199;onCreate"></a>2&#x3001;&#x91CD;&#x5199;onCreate</h2><p>&#x56E0;&#x4E3A;&#x6B64;&#x65F6;application&#x8FD8;&#x662F;DexShellS&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x8981;&#x8C03;&#x7528;LoadedApk#makeApplication&#x521B;&#x5EFA;&#x6E90;Dex&#x7684;application&#xFF0C;&#x901A;&#x8FC7;&#x67E5;&#x770B;&#x6E90;&#x7801;&#x53EF;&#x4EE5;&#x77E5;&#x9053;&#xFF1A;</p>
<p>1&#xFF09;LoadedApk&#x7684;mApplication&#x5C5E;&#x6027;&#x8981;&#x4E3A;&#x7A7A;&#xFF0C;&#x4E0D;&#x7136;&#x5C06;&#x8FD4;&#x56DE;DexShellS&#x7684;application<br>2&#xFF09;&#x4FEE;&#x6539;LoadedApk#mApplicationInfo#appClass&#x4E3A;&#x6E90;Dex&#x7684;Applicaiton&#x7684;Class<br>3&#xFF09;&#x521B;&#x5EFA;applicaiton&#x540E;&#x4F1A;&#x65B0;&#x6DFB;&#x52A0;&#x5728;mActivityThread.mAllApplications&#x4E2D;&#xFF0C;&#x6240;&#x4EE5;&#x8981;&#x5220;&#x9664;DexShellS&#x7684;application</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Application <span class="title">makeApplication</span><span class="params">(<span class="keyword">boolean</span> forceDefaultAppClass,Instrumentation instrumentation)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (mApplication != <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">return</span> mApplication;</span><br><span class="line">    }</span><br><span class="line">    Application app = <span class="keyword">null</span>;</span><br><span class="line">    String appClass = mApplicationInfo.className;</span><br><span class="line">    <span class="keyword">if</span> (forceDefaultAppClass || (appClass == <span class="keyword">null</span>)) {</span><br><span class="line">        appClass = <span class="string">&quot;android.app.Application&quot;</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        java.lang.ClassLoader cl = getClassLoader();</span><br><span class="line">        <span class="keyword">if</span> (!mPackageName.equals(<span class="string">&quot;android&quot;</span>)) {</span><br><span class="line">            initializeJavaContextClassLoader();</span><br><span class="line">        }</span><br><span class="line">        ContextImpl appContext = ContextImpl.createAppContext(mActivityThread, <span class="keyword">this</span>);</span><br><span class="line">        app = mActivityThread.mInstrumentation.newApplication(</span><br><span class="line">                cl, appClass, appContext);</span><br><span class="line">        appContext.setOuterContext(app);</span><br><span class="line">    } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">......</span><br><span class="line">    }</span><br><span class="line">    mActivityThread.mAllApplications.add(app);</span><br><span class="line">    mApplication = app;</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> app;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x6839;&#x636E;&#x4EE5;&#x4E0A;3&#x6B65;&#xFF0C;&#x5177;&#x4F53;&#x4EE3;&#x7801;&#x5B9E;&#x73B0;&#x5982;&#x4E0B;&#xFF1A;</p>
<p>1&#xFF09;LoadedApk#mApplication==NULL</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//---set LoadedApk#mApplication = null</span></span><br><span class="line">Object mcurrentActivityThread = RefInvoke.invokeStaticMethod(<span class="string">&quot;android.app.ActivityThread&quot;</span>,</span><br><span class="line">        <span class="string">&quot;currentActivityThread&quot;</span>,<span class="keyword">new</span> Class[]{},<span class="keyword">new</span> Object[]{});</span><br><span class="line">Object mBoundApplication = RefInvoke.getFieldObject(<span class="string">&quot;android.app.ActivityThread&quot;</span>,</span><br><span class="line">        mcurrentActivityThread,<span class="string">&quot;mBoundApplication&quot;</span>);</span><br><span class="line">Object mLoadedApk = RefInvoke.getFieldObject(<span class="string">&quot;android.app.ActivityThread$AppBindData&quot;</span>,</span><br><span class="line">        mBoundApplication,<span class="string">&quot;info&quot;</span>);</span><br><span class="line">RefInvoke.setFieldObject(<span class="string">&quot;android.app.LoadedApk&quot;</span>,<span class="string">&quot;mApplication&quot;</span>,mLoadedApk,<span class="keyword">null</span>);</span><br></pre></td></tr></table></figure>
<p>2&#xFF09;&#x4FEE;&#x6539;LoadedApk#mApplicationInfo#className</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//---set LoadedApk#mApplicationInfo   ActivityThread$AppBindData#appInfo</span></span><br><span class="line">ApplicationInfo appInfoLoadedApk = (ApplicationInfo) RefInvoke.getFieldObject(<span class="string">&quot;android.app.LoadedApk&quot;</span>,</span><br><span class="line">        mLoadedApk,<span class="string">&quot;mApplicationInfo&quot;</span>);</span><br><span class="line">appInfoLoadedApk.className = applicationClassName;</span><br></pre></td></tr></table></figure>
<p>3&#xFF09;&#x4FEE;&#x6539;ActivityThread$AppBindData#appInfo#className</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ApplicationInfo appInfoAT$AppBindData = (ApplicationInfo) RefInvoke.getFieldObject(<span class="string">&quot;android.app.ActivityThread$AppBindData&quot;</span>,</span><br><span class="line">        mBoundApplication,<span class="string">&quot;appInfo&quot;</span>);</span><br><span class="line">appInfoAT$AppBindData.className = applicationClassName;</span><br></pre></td></tr></table></figure>
<p>4&#xFF09;&#x79FB;&#x9664;ActivityThread#mAllApplications&#x4E2D;DexShellS&#x7684;application</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//---remove the old application in the ActivityThread#mAllApplications</span></span><br><span class="line">Object oldApplication = RefInvoke.getFieldObject(<span class="string">&quot;android.app.ActivityThread&quot;</span>,</span><br><span class="line">        mcurrentActivityThread,</span><br><span class="line">        <span class="string">&quot;mInitialApplication&quot;</span>);</span><br><span class="line">ArrayList&lt;Application&gt; mAllApplications = (ArrayList&lt;Application&gt;)RefInvoke.getFieldObject(<span class="string">&quot;android.app.ActivityThread&quot;</span>,</span><br><span class="line">        mcurrentActivityThread, <span class="string">&quot;mAllApplications&quot;</span>);</span><br><span class="line">mAllApplications.remove(oldApplication);</span><br></pre></td></tr></table></figure>
<p>5&#xFF09;&#x521B;&#x5EFA;&#x65B0;application</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Application app = (Application)RefInvoke.invokeMethod(<span class="string">&quot;android.app.LoadedApk&quot;</span>,<span class="string">&quot;makeApplication&quot;</span>,</span><br><span class="line">                mLoadedApk,<span class="keyword">new</span> Class[]{<span class="keyword">boolean</span>.class, Instrumentation.class},<span class="keyword">new</span> Object[]{<span class="keyword">false</span>,<span class="keyword">null</span>});</span><br></pre></td></tr></table></figure>
<p>6&#xFF09;&#x66FF;&#x6362;ActivityThread#mInitialApplication&#x4E3A;&#x65B0;application</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RefInvoke.setFieldObject(<span class="string">&quot;android.app.ActivityThread&quot;</span>,<span class="string">&quot;mInitialApplication&quot;</span>,</span><br><span class="line">        mcurrentActivityThread,app);</span><br></pre></td></tr></table></figure>
<p>7&#xFF09;&#x66FF;&#x6362;mProviderMap&#x4E2D;&#x7684;application</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ArrayMap mProviderMap = (ArrayMap) RefInvoke.getFieldObject(<span class="string">&quot;android.app.ActivityThread&quot;</span>,</span><br><span class="line">        mcurrentActivityThread,<span class="string">&quot;mProviderMap&quot;</span>);</span><br><span class="line">Iterator iterator = mProviderMap.values().iterator();</span><br><span class="line"><span class="keyword">while</span>(iterator.hasNext()){</span><br><span class="line">    Object providerClientRecord = iterator.next();</span><br><span class="line">    Object mLocalProvider = RefInvoke.getFieldObject(<span class="string">&quot;android.app.ActivityThread$ProviderClientRecord&quot;</span>,</span><br><span class="line">            providerClientRecord,<span class="string">&quot;mLocalProvider&quot;</span>);</span><br><span class="line">    RefInvoke.setFieldObject(<span class="string">&quot;android.content.ContentProvider&quot;</span>,</span><br><span class="line">            <span class="string">&quot;mContext&quot;</span>,mLocalProvider,app);</span><br></pre></td></tr></table></figure>
<p>&#x4E4B;&#x540E;&#x65B0;&#x7684;applicaiton&#x5C31;&#x53EF;&#x4EE5;&#x5F00;&#x59CB;&#x65B0;&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#x4E86;</p>
<p>&#x4E3B;&#x8981;&#x5B66;&#x4E60;&#x4E86;app&#x7684;&#x542F;&#x52A8;&#x6D41;&#x7A0B;&#xFF0C;&#x8FD9;&#x79CD;&#x5185;&#x5B58;&#x58F3;&#x5DF2;&#x7ECF;&#x88AB;&#x5B8C;&#x5168;&#x7834;&#x89E3;&#x4E86;&#xFF0C;&#x4E0B;&#x9762;&#x7684;&#x6307;&#x4EE4;&#x62BD;&#x53D6;&#x58F3;&#x4E5F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x4E3B;&#x52A8;&#x8C03;&#x7528;&#x7C7B;&#x65B9;&#x6CD5;&#x53BB;&#x5B9E;&#x73B0;&#x8131;&#x58F3;&#xFF0C;&#x5C06;&#x6838;&#x5FC3;&#x7B97;&#x6CD5;&#x653E;&#x5165;so&#x6587;&#x4EF6;&#xFF0C;&#x5E76;&#x6DF7;&#x6DC6;&#x53EF;&#x4EE5;&#x6709;&#x6548;&#x52A0;&#x5F3A;&#x4EE3;&#x7801;&#x7684;&#x4FDD;&#x62A4;&#x5F3A;&#x5EA6;&#xFF0C;java2c&#x4E0D;&#x7A33;&#x5B9A;&#xFF0C;&#x548C;&#x7CFB;&#x7EDF;&#x7248;&#x672C;&#x5F3A;&#x76F8;&#x5173;&#xFF0C;&#x73B0;&#x5728;vmp&#x58F3;&#x53EA;&#x662F;&#x5BF9;&#x90E8;&#x5206;&#x51FD;&#x6570;&#x505A;&#x865A;&#x62DF;&#x5316;&#xFF0C;&#x6BD4;&#x5982;onCreate</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/01/04/汇编分析一个so文件中的变形RC4和变形base64算法/">汇编分析一个so文件中的变形RC4和变形base64算法</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-01-04</time><div class="content"><h2 id="Prolong"><a href="#Prolong" class="headerlink" title="Prolong"></a>Prolong</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.init_array:00003E78 ; ELF Initialization Function Table</span><br><span class="line">.init_array:00003E78 ; ===========================================================================</span><br><span class="line">.init_array:00003E78</span><br><span class="line">.init_array:00003E78 ; Segment type: Pure data</span><br><span class="line">.init_array:00003E78                 AREA .init_array, DATA</span><br><span class="line">.init_array:00003E78                 ; ORG 0x3E78</span><br><span class="line">.init_array:00003E78                 DCD .datadiv_decode5009363700628197108+1</span><br><span class="line">.init_array:00003E78 ; .init_array   ends</span><br><span class="line">.init_array:00003E78</span><br></pre></td></tr></table></figure>
<p>&#x7A0B;&#x5E8F;&#x5728;.init_array&#x4E2D;&#x91CD;&#x65B0;&#x521D;&#x59CB;&#x5316;&#x4E86;&#x4E00;&#x4E9B;&#x5B57;&#x6BB5;&#xFF0C;&#x5305;&#x62EC;&#x751F;&#x6210;RC4&#x7684;&#x521D;&#x59CB;&#x5BC6;&#x94A5;K&#x3001;&#x72B6;&#x6001;&#x5411;&#x91CF;S&#xFF0C;&#x4E0B;&#x9762;&#x8BF4;&#x4E0B;K&#x7684;&#x751F;&#x6210;&#x8FC7;&#x7A0B;&#xFF1A;<br>1) so&#x4E2D;&#x539F;&#x59CB;&#x5B58;&#x50A8;&#x4E86;&#x957F;&#x5EA6;&#x4E3A;36&#x6570;&#x636E;&#xFF1A;<br>0x93,0x90,0x95,0xC3,0x9C,0x95,0x9C,0xC6,0x88,0x92,0x97,0x94,<br>0x92,0x88,0x96,0x93,0x91,0x92,0x88,0x9C,0x96,0x96,0x94,0x88<br>0xC6,0x9D,0x97,0xC1,0xC3,0x9D,0xC7,0x9C,0x9D,0xC0,0x9C,0x9D<br>2) &#x7ECF;&#x8FC7;.init_array&#x91CD;&#x65B0;&#x521D;&#x59CB;&#x5316;&#x53D8;&#x6210;&#x4E86;&#xFF1A;<br>650f909c-7217-3647-9331-c82df8b98e98<br>3) &#x7ECF;&#x8FC7;&#x4E00;&#x7CFB;&#x5217;&#x79FB;&#x4F4D;&#x53D8;&#x6210;&#x4E86;&#xFF1A;<br>89e89b8f-d28c-1339-7463-7127c909f056<br>4) &#x7136;&#x540E;&#x7ECF;&#x8FC7;&#x4E00;&#x4E2A;&#x6620;&#x5C04;&#x8868;abcdef0123456789=&gt;dbeafc2409715836<br>&#x6620;&#x5C04;&#x4E3A;&#x4E86;&#x6700;&#x7EC8;&#x7684;K36f36b3c-a03e-4996-8759-8408e626c215</p>
<p>&#x72B6;&#x6001;&#x5411;&#x91CF;&#x4E5F;&#x8FDB;&#x884C;&#x4E86;&#x91CD;&#x65B0;&#x521D;&#x59CB;&#x5316;&#xFF0C;&#x4E0B;&#x9762;&#x4E3B;&#x8981;&#x5206;&#x6790;&#xFF1A;<br>1&#x3001;&#x53D8;&#x5F62;&#x7684;RC4&#x7B97;&#x6CD5;<br>2&#x3001;&#x53D8;&#x5F62;&#x7684;base64&#x7B97;&#x6CD5;<br>3&#x3001;&#x7ED9;&#x51FA;&#x89E3;&#x5BC6;&#x811A;&#x672C;</p>
<h2 id="&#x4E00;&#x3001;&#x53D8;&#x5F62;&#x7684;RC4&#x7B97;&#x6CD5;"><a href="#&#x4E00;&#x3001;&#x53D8;&#x5F62;&#x7684;RC4&#x7B97;&#x6CD5;" class="headerlink" title="&#x4E00;&#x3001;&#x53D8;&#x5F62;&#x7684;RC4&#x7B97;&#x6CD5;"></a>&#x4E00;&#x3001;&#x53D8;&#x5F62;&#x7684;RC4&#x7B97;&#x6CD5;</h2><p>RC4&#x5305;&#x542B;&#x4E24;&#x4E2A;&#x5411;&#x91CF;&#xFF0C;&#x72B6;&#x6001;&#x5411;&#x91CF;S[256]&#xFF0C;&#x5411;&#x91CF;T[256]&#xFF0C;T&#x662F;&#x7531;&#x7528;&#x6237;&#x81EA;&#x5B9A;&#x4E49;&#x521D;&#x59CB;&#x5BC6;&#x94A5;K&#x8F6E;&#x8F6C;&#x586B;&#x5145;&#x5230;256&#x5B57;&#x8282;&#xFF0C;&#x7B97;&#x6CD5;&#x4E3B;&#x8981;&#x5305;&#x542B;&#x4E24;&#x90E8;&#x5206;&#x5185;&#x5BB9;<br>1&#x3001;&#x7528;T&#x7F6E;&#x4E71;&#x91CD;&#x6392;S<br>2&#x3001;&#x7528;T&#x548C;&#x660E;&#x6587;&#x751F;&#x6210;&#x5BC6;&#x6587;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#x72B6;&#x6001;&#x5411;&#x91CF;S:</span><br><span class="line"><span class="keyword">uint8_t</span> S[<span class="number">256</span>] = {</span><br><span class="line"><span class="number">0xD7</span>,<span class="number">0xDF</span>,   <span class="number">2</span>,<span class="number">0xD4</span>,<span class="number">0xFE</span>,<span class="number">0x6F</span>,<span class="number">0x53</span>,<span class="number">0x3C</span>,<span class="number">0x25</span>,<span class="number">0x6C</span>,<span class="number">0x99</span>,<span class="number">0x97</span>,   <span class="number">6</span>,<span class="number">0x56</span>,<span class="number">0x8F</span>,<span class="number">0xDE</span>,<span class="comment">//; 0</span></span><br><span class="line"><span class="number">0x40</span>,<span class="number">0x11</span>,<span class="number">0x64</span>,   <span class="number">7</span>,<span class="number">0x36</span>,<span class="number">0x15</span>,<span class="number">0x70</span>,<span class="number">0xCA</span>,<span class="number">0x18</span>,<span class="number">0x17</span>,<span class="number">0x7D</span>,<span class="number">0x6A</span>,<span class="number">0xDB</span>,<span class="number">0x13</span>,<span class="number">0x30</span>,<span class="number">0x37</span>,<span class="comment">//; 16</span></span><br><span class="line"><span class="number">0x29</span>,<span class="number">0x60</span>,<span class="number">0xE1</span>,<span class="number">0x23</span>,<span class="number">0x28</span>,<span class="number">0x8A</span>,<span class="number">0x50</span>,<span class="number">0x8C</span>,<span class="number">0xAC</span>,<span class="number">0x2F</span>,<span class="number">0x88</span>,<span class="number">0x20</span>,<span class="number">0x27</span>, <span class="number">0xF</span>,<span class="number">0x7C</span>,<span class="number">0x52</span>,<span class="comment">//; 32</span></span><br><span class="line"><span class="number">0xA2</span>,<span class="number">0xAB</span>,<span class="number">0xFC</span>,<span class="number">0xA1</span>,<span class="number">0xCC</span>,<span class="number">0x21</span>,<span class="number">0x14</span>,<span class="number">0x1F</span>,<span class="number">0xC2</span>,<span class="number">0xB2</span>,<span class="number">0x8B</span>,<span class="number">0x2C</span>,<span class="number">0xB0</span>,<span class="number">0x3A</span>,<span class="number">0x66</span>,<span class="number">0x46</span>,<span class="comment">//; 48</span></span><br><span class="line"><span class="number">0x3D</span>,<span class="number">0xBB</span>,<span class="number">0x42</span>,<span class="number">0xA5</span>, <span class="number">0xC</span>,<span class="number">0x75</span>,<span class="number">0x22</span>,<span class="number">0xD8</span>,<span class="number">0xC3</span>,<span class="number">0x76</span>,<span class="number">0x1E</span>,<span class="number">0x83</span>,<span class="number">0x74</span>,<span class="number">0xF0</span>,<span class="number">0xF6</span>,<span class="number">0x1C</span>,<span class="comment">//; 64</span></span><br><span class="line"><span class="number">0x26</span>,<span class="number">0xD1</span>,<span class="number">0x4F</span>, <span class="number">0xB</span>,<span class="number">0xFF</span>,<span class="number">0x4C</span>,<span class="number">0x4D</span>,<span class="number">0xC1</span>,<span class="number">0x87</span>,   <span class="number">3</span>,<span class="number">0x5A</span>,<span class="number">0xEE</span>,<span class="number">0xA4</span>,<span class="number">0x5D</span>,<span class="number">0x9E</span>,<span class="number">0xF4</span>,<span class="comment">//; 80</span></span><br><span class="line"><span class="number">0xC8</span>, <span class="number">0xD</span>,<span class="number">0x62</span>,<span class="number">0x63</span>,<span class="number">0x3E</span>,<span class="number">0x44</span>,<span class="number">0x7B</span>,<span class="number">0xA3</span>,<span class="number">0x68</span>,<span class="number">0x32</span>,<span class="number">0x1B</span>,<span class="number">0xAA</span>,<span class="number">0x2D</span>,   <span class="number">5</span>,<span class="number">0xF3</span>,<span class="number">0xF7</span>,<span class="comment">//; 96</span></span><br><span class="line"><span class="number">0x16</span>,<span class="number">0x61</span>,<span class="number">0x94</span>,<span class="number">0xE0</span>,<span class="number">0xD0</span>,<span class="number">0xD3</span>,<span class="number">0x98</span>,<span class="number">0x69</span>,<span class="number">0x78</span>,<span class="number">0xE9</span>, <span class="number">0xA</span>,<span class="number">0x65</span>,<span class="number">0x91</span>,<span class="number">0x8E</span>,<span class="number">0x35</span>,<span class="number">0x85</span>,<span class="comment">//; 112</span></span><br><span class="line"><span class="number">0x7A</span>,<span class="number">0x51</span>,<span class="number">0x86</span>,<span class="number">0x10</span>,<span class="number">0x3F</span>,<span class="number">0x7F</span>,<span class="number">0x82</span>,<span class="number">0xDD</span>,<span class="number">0xB5</span>,<span class="number">0x1A</span>,<span class="number">0x95</span>,<span class="number">0xE7</span>,<span class="number">0x43</span>,<span class="number">0xFD</span>,<span class="number">0x9B</span>,<span class="number">0x24</span>,<span class="comment">//; 128</span></span><br><span class="line"><span class="number">0x45</span>,<span class="number">0xEF</span>,<span class="number">0x92</span>,<span class="number">0x5C</span>,<span class="number">0xE4</span>,<span class="number">0x96</span>,<span class="number">0xA9</span>,<span class="number">0x9C</span>,<span class="number">0x55</span>,<span class="number">0x89</span>,<span class="number">0x9A</span>,<span class="number">0xEA</span>,<span class="number">0xF9</span>,<span class="number">0x90</span>,<span class="number">0x5F</span>,<span class="number">0xB8</span>,<span class="comment">//; 144</span></span><br><span class="line">   <span class="number">4</span>,<span class="number">0x84</span>,<span class="number">0xCF</span>,<span class="number">0x67</span>,<span class="number">0x93</span>,   <span class="number">0</span>,<span class="number">0xA6</span>,<span class="number">0x39</span>,<span class="number">0xA8</span>,<span class="number">0x4E</span>,<span class="number">0x59</span>,<span class="number">0x31</span>,<span class="number">0x6B</span>,<span class="number">0xAD</span>,<span class="number">0x5E</span>,<span class="number">0x5B</span>,<span class="comment">//; 160</span></span><br><span class="line"><span class="number">0x77</span>,<span class="number">0xB1</span>,<span class="number">0x54</span>,<span class="number">0xDC</span>,<span class="number">0x38</span>,<span class="number">0x41</span>,<span class="number">0xB6</span>,<span class="number">0x47</span>,<span class="number">0x9F</span>,<span class="number">0x73</span>,<span class="number">0xBA</span>,<span class="number">0xF8</span>,<span class="number">0xAE</span>,<span class="number">0xC4</span>,<span class="number">0xBE</span>,<span class="number">0x34</span>,<span class="comment">//; 176</span></span><br><span class="line">   <span class="number">1</span>,<span class="number">0x4B</span>,<span class="number">0x2A</span>,<span class="number">0x8D</span>,<span class="number">0xBD</span>,<span class="number">0xC5</span>,<span class="number">0xC6</span>,<span class="number">0xE8</span>,<span class="number">0xAF</span>,<span class="number">0xC9</span>,<span class="number">0xF5</span>,<span class="number">0xCB</span>,<span class="number">0xFB</span>,<span class="number">0xCD</span>,<span class="number">0x79</span>,<span class="number">0xCE</span>,<span class="comment">//; 192</span></span><br><span class="line"><span class="number">0x12</span>,<span class="number">0x71</span>,<span class="number">0xD2</span>,<span class="number">0xFA</span>,   <span class="number">9</span>,<span class="number">0xD5</span>,<span class="number">0xBC</span>,<span class="number">0x58</span>,<span class="number">0x19</span>,<span class="number">0x80</span>,<span class="number">0xDA</span>,<span class="number">0x49</span>,<span class="number">0x1D</span>,<span class="number">0xE6</span>,<span class="number">0x2E</span>,<span class="number">0xE3</span>,<span class="comment">//; 208</span></span><br><span class="line"><span class="number">0x7E</span>,<span class="number">0xB7</span>,<span class="number">0x3B</span>,<span class="number">0xB3</span>,<span class="number">0xA0</span>,<span class="number">0xB9</span>,<span class="number">0xE5</span>,<span class="number">0x57</span>,<span class="number">0x6E</span>,<span class="number">0xD9</span>,   <span class="number">8</span>,<span class="number">0xEB</span>,<span class="number">0xC7</span>,<span class="number">0xED</span>,<span class="number">0x81</span>,<span class="number">0xF1</span>,<span class="comment">//; 224</span></span><br><span class="line"><span class="number">0xF2</span>,<span class="number">0xBF</span>,<span class="number">0xC0</span>,<span class="number">0xA7</span>,<span class="number">0x4A</span>,<span class="number">0xD6</span>,<span class="number">0x2B</span>,<span class="number">0xB4</span>,<span class="number">0x72</span>,<span class="number">0x9D</span>, <span class="number">0xE</span>,<span class="number">0x6D</span>,<span class="number">0xEC</span>,<span class="number">0x48</span>,<span class="number">0xE2</span>,<span class="number">0x33</span>,<span class="comment">//;</span></span><br><span class="line">}</span><br><span class="line">&#x521D;&#x59CB;&#x5BC6;&#x94A5;K = <span class="number">36f</span>36b3c-a03e<span class="number">-4996</span><span class="number">-8759</span><span class="number">-8408e626</span>c215</span><br></pre></td></tr></table></figure>
<h3 id="1&#x3001;&#x7528;T&#x7F6E;&#x4E71;&#x91CD;&#x6392;S"><a href="#1&#x3001;&#x7528;T&#x7F6E;&#x4E71;&#x91CD;&#x6392;S" class="headerlink" title="1&#x3001;&#x7528;T&#x7F6E;&#x4E71;&#x91CD;&#x6392;S"></a>1&#x3001;&#x7528;T&#x7F6E;&#x4E71;&#x91CD;&#x6392;S</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">.text:B3E408BA loc_B3E408BA                            ; CODE XREF: sub_B3E40784+15E&#x2193;j</span><br><span class="line">.text:B3E408BA LDRB.W          R2, [R9,R1]             ; S[i], R9&#x662F;&#x72B6;&#x6001;&#x5411;&#x91CF;S&#x7684;&#x5730;&#x5740; ,R1&#x662F;&#x76F8;&#x5F53;&#x4E8E;&#x7B97;&#x6CD5;&#x4E2D;&#x7684;i</span><br><span class="line">.text:B3E408BE LDRB            R3, [R4,R1]             ; T[i], R4&#x662F;&#x5411;&#x91CF;T&#x7684;&#x5730;&#x5740;</span><br><span class="line">.text:B3E408C0 ADD             R3, R2                  ; T[i] + S[i]</span><br><span class="line">.text:B3E408C2 ADD             R0, R3                  ; j + T[i] + S[i] ,R0&#x76F8;&#x5F53;&#x4E8E;&#x7B97;&#x6CD5;&#x4E2D;&#x7684;j</span><br><span class="line">.text:B3E408C4 ASRS            R3, R0, #0x1F</span><br><span class="line">.text:B3E408C6 ADD.W           R3, R0, R3,LSR#24</span><br><span class="line">.text:B3E408CA BIC.W           R3, R3, #0xFF</span><br><span class="line">.text:B3E408CE SUBS            R0, R0, R3              ; R0 = R0 % 256</span><br><span class="line">.text:B3E408D0 LDRB.W          R3, [R9,R0]						 ; R3 = S[j]</span><br><span class="line">.text:B3E408D4 STRB.W          R3, [R9,R1]             ; S[i] = R3</span><br><span class="line">.text:B3E408D8 ADDS            R1, #1</span><br><span class="line">.text:B3E408DA CMP.W           R1, #0x100</span><br><span class="line">.text:B3E408DE STRB.W          R2, [R9,R0]						 ; S[j] = R2, R2&#x5373;&#x4E3A;&#x539F;R[i], swap&#x5B8C;&#x6210;</span><br><span class="line">.text:B3E408E2 BNE             loc_B3E408BA            ; &#x5FAA;&#x73AF;</span><br></pre></td></tr></table></figure>
<p>&#x7FFB;&#x8BD1;&#x6210;C&#x8BED;&#x8A00;&#x7B97;&#x6CD5;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">i = <span class="number">0</span>;</span><br><span class="line">j = T[<span class="number">0</span>] - <span class="number">0x29</span>;	<span class="comment">//j = 10</span></span><br><span class="line">swap(S[i],S[j]);	<span class="comment">//swap(S[0],S[10])</span></span><br><span class="line"><span class="keyword">for</span>(i = <span class="number">1</span>;i&lt;<span class="number">256</span>;i++){</span><br><span class="line">  j = (j + T[i] + S[i]) % <span class="number">256</span>;</span><br><span class="line">	swap(S[i],S[j]);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>T[0] - 0x29&#x5C31;&#x662F;(T[0] + S[0])256&#xFF0C;&#x4F18;&#x5316;&#x4E00;&#x4E0B;&#x5C31;&#x662F;&#xFF1A;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">j = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>;i&lt;<span class="number">256</span>;i++){</span><br><span class="line">  j = (j + T[i] + S[i]) % <span class="number">256</span>;</span><br><span class="line">	swap(S[i],S[j]);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="2&#x3001;&#x7528;&#x72B6;&#x6001;&#x5411;&#x91CF;T&#x548C;&#x660E;&#x6587;&#x4E00;&#x6B21;&#x4E00;&#x5BC6;&#x751F;&#x6210;&#x5BC6;&#x6587;"><a href="#2&#x3001;&#x7528;&#x72B6;&#x6001;&#x5411;&#x91CF;T&#x548C;&#x660E;&#x6587;&#x4E00;&#x6B21;&#x4E00;&#x5BC6;&#x751F;&#x6210;&#x5BC6;&#x6587;" class="headerlink" title="2&#x3001;&#x7528;&#x72B6;&#x6001;&#x5411;&#x91CF;T&#x548C;&#x660E;&#x6587;&#x4E00;&#x6B21;&#x4E00;&#x5BC6;&#x751F;&#x6210;&#x5BC6;&#x6587;"></a>2&#x3001;&#x7528;&#x72B6;&#x6001;&#x5411;&#x91CF;T&#x548C;&#x660E;&#x6587;&#x4E00;&#x6B21;&#x4E00;&#x5BC6;&#x751F;&#x6210;&#x5BC6;&#x6587;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">.text:B3E409A8 loc_B3E409A8                            ; CODE XREF: sub_B3E40784+1B0&#x2191;j</span><br><span class="line">.text:B3E409A8                                         ; sub_B3E40784+2B4&#x2193;j</span><br><span class="line">.text:B3E409A8 ADD.W           R1, R10, #1             ; R10=&#x7B97;&#x6CD5;&#x4E2D;&#x7684;i</span><br><span class="line">.text:B3E409AC CMP             R2, #0</span><br><span class="line">.text:B3E409AE MOV.W           R3, R1,ASR#31</span><br><span class="line">.text:B3E409B2 ADD.W           R3, R1, R3,LSR#24</span><br><span class="line">.text:B3E409B6 BIC.W           R3, R3, #0xFF           ; &#x5C06;R3&#x4F4E;8&#x4F4D;&#x6E05;&#x96F6;&#xFF0C;0xff = 255</span><br><span class="line">.text:B3E409BA SUB.W           R10, R1, R3             ; &#x4E0A;&#x9762;&#x8BA1;&#x7B97;&#x4E86;R10 = (R10+1)%256</span><br><span class="line">.text:B3E409BE LDRB.W          R1, [R9,R10]            ; R1 = S[R10],R9 = &#x72B6;&#x6001;&#x5411;&#x91CF;S&#x7684;&#x5730;&#x5740;</span><br><span class="line">.text:B3E409C2 ADD.W           R3, R12, R1             ; R12=&#x7B97;&#x6CD5;&#x4E2D;&#x7684;j</span><br><span class="line">.text:B3E409C6 MOV.W           R4, R3,ASR#31</span><br><span class="line">.text:B3E409CA ADD.W           R4, R3, R4,LSR#24</span><br><span class="line">.text:B3E409CE BIC.W           R4, R4, #0xFF</span><br><span class="line">.text:B3E409D2 SUB.W           R12, R3, R4             ; &#x4E0A;&#x9762;&#x8BA1;&#x7B97;&#x4E86;R12 = (R12+R1)%256</span><br><span class="line">.text:B3E409D6 LDRB.W          R3, [R9,R12]            ; &#x5F00;&#x59CB;&#x5BF9;S&#x6570;&#x7EC4;swap</span><br><span class="line">.text:B3E409DA STRB.W          R3, [R9,R10]            ; S[i] = S[j]</span><br><span class="line">.text:B3E409DE STRB.W          R1, [R9,R12]            ; S[j] = &#x539F;s[i]</span><br><span class="line">.text:B3E409E2 LDRB.W          R4, [R9,R10]            ; R4 = swap&#x540E;&#x7684;S[i]</span><br><span class="line">.text:B3E409E6 LDR             R3, [SP,#0x238+s]       ; R3 = &#x660E;&#x6587;&#x5730;&#x5740;</span><br><span class="line">.text:B3E409E8 ADD             R1, R4                  ; R1&#x662F;&#x539F;S[i]</span><br><span class="line">.text:B3E409EA LDRB            R3, [R3,R2]             ; R3 = s[R2]&#xFF0C;&#x53D6;&#x5F85;&#x52A0;&#x5BC6;&#x660E;&#x6587;&#x5B57;&#x7B26;</span><br><span class="line">.text:B3E409EC UXTB            R1, R1                  ; &#x9AD8;24&#x4F4D;&#x6E05;&#x96F6;&#xFF0C;&#x76F8;&#x5F53;&#x4E8E;&#x6A21;256</span><br><span class="line">.text:B3E409EE LDRB.W          R1, [R9,R1]             ; R1 = S[ (S[i] + S[j]) % 256 ]</span><br><span class="line">.text:B3E409F2 EOR.W           R11, R1, R3             ; &#x5F02;&#x6216;,RC4&#x7ED3;&#x679C;&#x4FDD;&#x5B58;&#x5728;R11</span><br><span class="line">.text:B3E409F6 BEQ             loc_B3E40A0E            ; &#x82E5;&#x5B57;&#x7B26;&#x7D22;&#x5F15;index=0&#xFF0C;&#x5219;&#x5F00;&#x59CB;&#x5904;&#x7406;&#x7B2C;&#x4E00;&#x4E2A;&#x5B57;&#x7B26;</span><br></pre></td></tr></table></figure>
<p>RC4&#x90E8;&#x5206;&#x5BF9;&#x5E94;&#x7684;C&#x8BED;&#x8A00;&#x7B97;&#x6CD5;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">i = (i + <span class="number">1</span>)%<span class="number">256</span>;</span><br><span class="line">m = S[i];</span><br><span class="line">j = (j + S[i])%<span class="number">256</span>;</span><br><span class="line">S[i] = S[j];</span><br><span class="line">S[j] = m;</span><br><span class="line">n = S[i];</span><br><span class="line">C = S[ (m+n) % <span class="number">256</span> ] ^ s[index];</span><br></pre></td></tr></table></figure>
<h3 id="3&#x3001;&#x53D8;&#x5F62;&#x7684;RC4&#x7B97;&#x6CD5;&#x603B;&#x7ED3;"><a href="#3&#x3001;&#x53D8;&#x5F62;&#x7684;RC4&#x7B97;&#x6CD5;&#x603B;&#x7ED3;" class="headerlink" title="3&#x3001;&#x53D8;&#x5F62;&#x7684;RC4&#x7B97;&#x6CD5;&#x603B;&#x7ED3;"></a>3&#x3001;&#x53D8;&#x5F62;&#x7684;RC4&#x7B97;&#x6CD5;&#x603B;&#x7ED3;</h3><p>&#x4ECE;&#x4E0A;&#x9762;&#x5206;&#x6790;&#xFF0C;&#x53EF;&#x4EE5;&#x77E5;&#x9053;&#x8BE5;&#x7B97;&#x6CD5;&#x4E0E;&#x5E38;&#x89C4;RC4&#x7B97;&#x6CD5;&#x7684;&#x4E0D;&#x540C;&#xFF1A;<br>1&#x3001;&#x4F7F;&#x7528;&#x81EA;&#x5B9A;&#x4E49;&#x7684;&#x521D;&#x59CB;&#x5BC6;&#x94A5;K<br>2&#x3001;&#x4F7F;&#x7528;&#x81EA;&#x5B9A;&#x4E49;&#x7684;&#x72B6;&#x6001;&#x5411;&#x91CF;S</p>
<hr>
<h2 id="&#x4E8C;&#x3001;&#x53D8;&#x5F62;&#x7684;base64&#x7B97;&#x6CD5;"><a href="#&#x4E8C;&#x3001;&#x53D8;&#x5F62;&#x7684;base64&#x7B97;&#x6CD5;" class="headerlink" title="&#x4E8C;&#x3001;&#x53D8;&#x5F62;&#x7684;base64&#x7B97;&#x6CD5;"></a>&#x4E8C;&#x3001;&#x53D8;&#x5F62;&#x7684;base64&#x7B97;&#x6CD5;</h2><p>base64&#x7B97;&#x6CD5;&#x4E2D;&#xFF0C;3&#x4E2A;&#x5B57;&#x7B26;&#x4E3A;&#x4E00;&#x7EC4;&#x88AB;&#x7F16;&#x7801;&#x6210;4&#x4E2A;base64&#x5B57;&#x7B26;&#xFF0C;&#x5047;&#x8BBE;&#x5F85;&#x7F16;&#x7801;&#x5B57;&#x7B26;&#x7D22;&#x5F15;&#x4E3A;index&#xFF0C;&#x67D0;&#x4E00;&#x7EC4;&#x7684;&#x4E09;&#x4E2A;&#x5B57;&#x7B26;&#x4E3A;x0&#x3001;x1&#x3001;x2&#xFF0C;&#x8BE5;&#x7EC4;base64&#x7F16;&#x7801;&#x7ED3;&#x679C;&#x5BF9;&#x5E94;&#x7684;&#x5B57;&#x7B26;&#x4E3A;y0&#x3001;y1&#x3001;y2&#x3001;y3&#x3002;</p>
<p>&#x8FD9;&#x91CC;&#x9700;&#x8981;&#x5224;&#x65AD;&#x5F53;&#x524D;&#x5904;&#x7406;&#x7684;index&#x662F;&#x8FD9;&#x4E00;&#x7EC4;&#x4E2D;&#x7684;&#x7B2C;&#x51E0;&#x4E2A;&#x5B57;&#x7B26;&#xFF0C;&#x6761;&#x4EF6;&#x4E3A;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.text:B3E409AC CMP             R2, #0</span><br><span class="line">.text:B3E409F6 BEQ             loc_B3E40A0E</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.text:B3E409F8 MOV             R1, #0xAAAAAAAB</span><br><span class="line">.text:B3E40A00 UMULL.W         R1, R3, R2, R1</span><br><span class="line">.text:B3E40A04 LSRS            R1, R3, #1              ; &#x8BA1;&#x7B97;&#x7ED3;&#x679C;&#xFF1A;R1 = R2 / 3</span><br><span class="line">.text:B3E40A06 ADD.W           LR, R1, R1,LSL#1        ; LR = R1 + R1*2 &#x5373;LR = 3*(R2/3)</span><br><span class="line">.text:B3E40A0A CMP             LR, R2</span><br><span class="line">.text:B3E40A0C BNE             loc_B3E40936            ; &#x82E5;index!=0 &amp;&amp; index%3!=0</span><br><span class="line">.text:B3E40A0E loc_B3E40A0E</span><br></pre></td></tr></table></figure>
<p>&#x4E0A;&#x9762;&#x4E3A;&#x4E24;&#x4E2A;&#x6761;&#x4EF6;&#xFF0C;&#x6574;&#x5408;&#x5230;&#x4E00;&#x8D77;&#x5C31;&#x662F;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(index!=<span class="number">0</span> &amp;&amp; <span class="number">3</span>*(index/<span class="number">3</span>)!=index)</span><br><span class="line">	<span class="keyword">goto</span> loc_B3E40936;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	<span class="keyword">goto</span> loc_B3E40A0E;</span><br></pre></td></tr></table></figure>
<p>&#x8FD9;&#x91CC;&#x5C31;&#x5224;&#x65AD;&#x4E86;&#x5F53;&#x524D;index&#xFF0C;&#x5904;&#x4E8E;&#x5C0F;&#x7EC4;&#x7684;&#x4F4D;&#x7F6E;&#xFF0C;&#x662F;&#x4E0D;&#x662F;x0&#xFF0C;&#x82E5;&#x662F;x0&#xFF0C;&#x5C31;&#x53BB;&#x6267;&#x884C;loc_B3E40A0E&#xFF1B;&#x82E5;&#x662F;x1&#x3001;x2&#x5C31;&#x53BB;&#x6267;&#x884C;loc_B3E40936</p>
<p>&#x4F46;&#x662F;&#x6267;&#x884C;loc_B3E40936&#x540E;&#xFF0C;&#x8FD8;&#x9700;&#x8981;&#x5224;&#x65AD;&#x5F53;&#x524D;index&#x5904;&#x4E8E;&#x7684;&#x4F4D;&#x7F6E;&#x662F;x1&#x8FD8;&#x662F;x2&#xFF0C;&#x5C31;&#x6709;&#x4E86;&#x4E0B;&#x9762;&#x7684;&#x5224;&#x65AD;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.text:B3E40936 CMP             R2, #1                  ; &#x6BD4;&#x8F83;index&#x548C;1</span><br><span class="line">.text:B3E40938 ITT NE                                  ; &#x4E0D;&#x76F8;&#x7B49;&#x6267;&#x884C;&#x7B2C;1&#x3001;2&#x6761;&#x6307;&#x4EE4;</span><br><span class="line">.text:B3E4093A ADDNE.W         R1, LR, #1              ; R2!=1, Then R1 = LR + 1</span><br><span class="line">.text:B3E4093E CMPNE           R1, R2</span><br><span class="line">.text:B415E940 BNE             loc_B415E96A            ; &#x4E0D;&#x76F8;&#x7B49;&#xFF0C;&#x8BF4;&#x660E;index&#x5904;&#x4E8E;x2&#x7684;&#x4F4D;&#x7F6E;&#xFF0C;&#x8DF3;&#x8F6C;loc_B3E4096A</span><br><span class="line">.text:B415E942 ...</span><br><span class="line">.text:B415E944...</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="number">3</span>*(index/<span class="number">3</span>)+<span class="number">1</span> != index)</span><br><span class="line">	<span class="keyword">goto</span> loc_B3E4096A;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>&#x82E5;3*(index/3)+1 != index&#xFF0C;&#x5219;&#x8BF4;&#x660E;&#x5F53;&#x524D;index&#x5904;&#x4E8E;x2&#x7684;&#x4F4D;&#x7F6E;&#xFF0C;&#x5426;&#x5219;&#x8BF4;&#x660E;&#x5F53;&#x524D;index&#x5904;&#x4E8E;x1&#x7684;&#x4F4D;&#x7F6E;</p>
<h3 id="1&#x3001;&#x5904;&#x7406;&#x7B2C;1&#x4E2A;&#x5B57;&#x7B26;&#xFF0C;&#x5F97;&#x5230;&#x7B2C;1&#x4E2A;base64&#x5B57;&#x7B26;"><a href="#1&#x3001;&#x5904;&#x7406;&#x7B2C;1&#x4E2A;&#x5B57;&#x7B26;&#xFF0C;&#x5F97;&#x5230;&#x7B2C;1&#x4E2A;base64&#x5B57;&#x7B26;" class="headerlink" title="1&#x3001;&#x5904;&#x7406;&#x7B2C;1&#x4E2A;&#x5B57;&#x7B26;&#xFF0C;&#x5F97;&#x5230;&#x7B2C;1&#x4E2A;base64&#x5B57;&#x7B26;"></a>1&#x3001;&#x5904;&#x7406;&#x7B2C;1&#x4E2A;&#x5B57;&#x7B26;&#xFF0C;&#x5F97;&#x5230;&#x7B2C;1&#x4E2A;base64&#x5B57;&#x7B26;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">.text:B3E40A0E loc_B3E40A0E                            ; &#x5F00;&#x59CB;&#x5904;&#x7406;x0</span><br><span class="line">.text:B3E40A0E LDR             R1, =(byte_B3E44050 - 0xB3E40A1C) ; R1 = base64&#x5B57;&#x7B26;&#x8868;&#x5730;&#x5740;&#x76F8;&#x5BF9;PC&#x7684;&#x5DEE;&#x503C;</span><br><span class="line">.text:B3E40A10 UXTB.W          R3, R11                 ; &#x5C06;x0&#x4F4E;8&#x4F4D;&#xFF0C;&#x65E0;&#x7B26;&#x53F7;&#x6269;&#x5C55;&#x5230;32&#x4F4D;&#xFF0C;&#x5373;&#x9AD8;24&#x4F4D;&#x6E05;&#x96F6;&#xFF0C;&#x4FDD;&#x5B58;&#x5230;R3</span><br><span class="line">.text:B3E40A14 LSRS            R4, R3, #2              ; &#x903B;&#x8F91;&#x53F3;&#x79FB;2&#x4F4D;&#xFF0C;&#x53D6;&#x9AD8;6&#x4F4D;</span><br><span class="line">.text:B3E40A16 LDR             R6, [SP,#0x238+var_228] ; R6 = N&#xFF0C;&#x8FD9;&#x91CC;N&#x662F;K[3] = 0x33</span><br><span class="line">.text:B3E40A18 ADD             R1, PC                  ; byte_B3E44050 ; R1=base64&#x5B57;&#x7B26;&#x8868;&#x5730;&#x5740;</span><br><span class="line">.text:B3E40A1A ADD             R6, R2                  ; R6 = N + index&#xFF0C;R2&#x662F;&#x5B57;&#x7B26;&#x7D22;&#x5F15;index</span><br><span class="line">.text:B3E40A1C LDRB            R4, [R1,R4]             ; &#x53D6;&#x51FA;&#x7B2C;&#x4E00;&#x4E2A;&#x7D22;&#x5F15;&#x5BF9;&#x5E94;&#x7684;base64&#x5B57;&#x7B26;&#xFF0C;&#x8BBE;&#x4E3A;y0&apos;</span><br><span class="line">.text:B3E40A1E EOR.W           R4, R4, #7              ; y0 = y0&apos; ^ 7</span><br><span class="line">.text:B3E40A22 STRB            R4, [R0,R6]             ; &#x4FDD;&#x5B58;&#x7B2C;&#x4E00;&#x4E2A;base64&#x5B57;&#x7B26;y0&#xFF0C;R0&#x4E3A;malloc&#x7684;buf&#x5730;&#x5740;</span><br><span class="line">.text:B3E40A24 ADDS            R4, R0, R6              ; &#x53D6;buf[N + index]&#x7684;&#x5730;&#x5740;</span><br><span class="line">.text:B3E40A26 MOVS            R6, #0x30 ; &apos;0&apos;</span><br><span class="line">.text:B3E40A28 AND.W           R3, R6, R3,LSL#4        ; R3 = (R3&lt;&lt;4)&amp; 00110000b</span><br><span class="line">.text:B3E40A28                                         ; &#x5373;&#x53D6;x0&#x4F4E;2&#x4F4D;&#x503C;</span><br><span class="line">.text:B3E40A2C ADDS            R6, R2, #1							 ; index++</span><br><span class="line">.text:B3E40A2E STRB            R3, [R4,#1]             ; &#x5728;buf[N + index + 1]&#x5199;&#x5165;x0&#x4F4E;2&#x4F4D;&#xFF0C;&#x5C06;&#x4F5C;&#x4E3A;&#x7B2C;&#x4E8C;&#x4E2A;base64&#x5B57;&#x7B26;y1&#x7684;&#x7D22;&#x5F15;&#x7684;&#x9AD8;2&#x4F4D;</span><br><span class="line">.text:B3E40A30 CMP             R6, R8                  ; &#x5224;&#x65AD;&#x660E;&#x6587;&#x5B57;&#x7B26;&#x7D22;&#x5F15;index+1&#x662F;&#x5426;&#x5927;&#x4E8E;&#x7B49;&#x4E8E;&#x660E;&#x6587;&#x5B57;&#x7B26;&#x957F;&#x5EA6;</span><br><span class="line">.text:B3E40A30                                         ; &#x82E5;&#x76F8;&#x7B49;&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x5C31;&#x5904;&#x7406;&#x6700;&#x540E;&#x4E00;&#x4E2A;&#x660E;&#x6587;&#x5B57;&#x7B26;</span><br><span class="line">.text:B3E40A32 BCS             loc_B3E40A3C            ; &#x82E5;&#x65E0;&#x7B26;&#x53F7;index &gt; len(s)&#xFF0C;&#x5219;&#x8DF3;&#x8F6C;&#xFF0C;&#x5904;&#x7406;&#x6700;&#x540E;&#x4E00;&#x4E2A;&#x5B57;&#x7B26;</span><br><span class="line">.text:B3E40A34</span><br><span class="line">.text:B3E40A34 loc_B3E40A34                            ; &#x5426;&#x5219;</span><br><span class="line">.text:B3E40A34 ADDS            R2, #1</span><br><span class="line">.text:B3E40A36 CMP             R2, R8									 </span><br><span class="line">.text:B3E40A38 BCC             loc_B3E409A8            ; &#x82E5;index&lt;=len(s),&#x8DF3;&#x8F6C;loc_B3E409A8,&#x7EE7;&#x7EED;&#x8BA1;&#x7B97;&#x4E0B;&#x4E00;&#x4E2A;base64&#x5B57;&#x7B26;</span><br></pre></td></tr></table></figure>
<p>&#x521D;&#x59CB;&#x5BC6;&#x94A5; K = 36f36b3c-a03e-4996-8759-8408e626c215</p>
<p><strong>&#x8BE5;&#x90E8;&#x5206;&#x7B97;&#x6CD5;&#x603B;&#x7ED3;&#xFF1A;</strong><br>1&#x3001;&#x53D6;RC4&#x52A0;&#x5BC6;&#x7ED3;&#x679C;C&#x7684;&#x4F4E;8&#x4F4D;&#xFF0C;&#x7136;&#x540E;&#x53D6;&#x8BE5;&#x503C;&#x7684;&#x9AD8;6&#x4F4D;&#x4F5C;&#x4E3A;base64&#x5B57;&#x7B26;&#x8868;&#x7D22;&#x5F15;<br>2&#x3001;&#x6839;&#x636E;&#x5B57;&#x7B26;&#x7D22;&#x5F15;&#xFF0C;&#x67E5;&#x5B57;&#x7B26;&#x8868;&#xFF0C;&#x5F97;&#x5230;&#x7B2C;&#x4E00;&#x4E2A;base64&#x5B57;&#x7B26;&#xFF0C;&#x8BBE;&#x4E3A;y0&#x2019;<br>3&#x3001;y0 = y0&#x2019; ^ 7<br>4&#x3001;N = K[3]<br>5&#x3001;&#x5C06;b&#x5199;&#x5165;buf[ N + index ]<br>6&#x3001;&#x5C06;&#x4F4E;2&#x4F4D;&#x5199;&#x5165;buf[ N + index +1 ]<br>&#x8FD9;&#x91CC;&#x6BD4;&#x5E38;&#x89C4;&#x7684;base64&#x7F16;&#x7801;&#x7B97;&#x6CD5;&#x591A;&#x4E86;&#x7B2C;&#x4E09;&#x6B65;</p>
<p><strong>&#x6307;&#x4EE4;&#x603B;&#x7ED3;&#xFF1A;</strong><br>1&#x3001;UXTB&#x6307;&#x4EE4;&#xFF0C;&#x65E0;&#x7B26;&#x53F7;&#x6269;&#x5C55;&#x5230;32&#x4F4D;&#xFF0C;&#x5373;&#x9AD8;24&#x4F4D;&#x6E05;&#x96F6; <a href="http://www.keil.com/support/man/docs/armasm/armasm_dom1361289924987.htm" target="_blank" rel="noopener">http://www.keil.com/support/man/docs/armasm/armasm_dom1361289924987.htm</a><br>2&#x3001;&#x53D6;&#x4E00;&#x4E2A;&#x5B57;&#x7B26;A&#x7684;&#x4F4E;2&#x4F4D;&#xFF0C;&#x5C06;&#x5176;&#x4F5C;&#x4E3A;&#x4E0B;&#x4E00;&#x4E2A;&#x5B57;&#x7B26;&#x7D22;&#x5F15;&#x7684;&#x9AD8;2&#x4F4D;&#xFF0C;&#x4FDD;&#x5B58;&#x5230;B&#x4E2D; <code>B = (A&lt;&lt;4) &amp; 00110000b</code><br>3&#x3001;<code>CMP R1,R2 BCS label</code>&#xFF0C;&#x65E0;&#x7B26;&#x53F7;R1&lt;R2&#xFF0C;&#x5219;&#x8DF3;&#x8F6C;label<br>4&#x3001;<code>CMP R1,R2 BCC label</code>&#xFF0C;&#x65E0;&#x7B26;&#x53F7;R1&gt;=R2&#xFF0C;&#x5219;&#x8DF3;&#x8F6C;label</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span></span><br><span class="line">{</span><br><span class="line">  v26[v44 + v29] = byte_4050[(<span class="keyword">unsigned</span> <span class="keyword">int</span>)v36 &gt;&gt; <span class="number">2</span>] ^ <span class="number">7</span>;<span class="comment">// &#x53F3;&#x79FB;&#x4E24;&#x4F4D;&#xFF0C;&#x5F97;&#x5230;&#x7B2C;&#x4E00;&#x4E2A;base64&#x5B57;&#x7B26;&#x7D22;&#x5F15;</span></span><br><span class="line">  v17 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)&amp;v26[v44 + v29];</span><br><span class="line">  v27 = <span class="number">16</span> * v36 &amp; <span class="number">0x30</span>;                  <span class="comment">// &#x83B7;&#x53D6;&#x7D22;&#x5F15;2&#x7684;&#x9AD8;2&#x4F4D;</span></span><br><span class="line">  *(_BYTE *)(v17 + <span class="number">1</span>) = v27;              <span class="comment">// v26[v44 + v29 +1] =  16 * v36 &amp; 0x30</span></span><br><span class="line">  <span class="keyword">if</span> ( v29 + <span class="number">1</span> &gt;= v24 )</span><br><span class="line">  {</span><br><span class="line">    v38 = byte_4050[v27];</span><br><span class="line">    *(_WORD *)(v17 + <span class="number">2</span>) = <span class="number">0x3B3B</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_43;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="2&#x3001;&#x5904;&#x7406;&#x7B2C;2&#x4E2A;&#x5B57;&#x7B26;&#xFF0C;&#x5F97;&#x5230;&#x7B2C;2&#x4E2A;base64&#x5B57;&#x7B26;"><a href="#2&#x3001;&#x5904;&#x7406;&#x7B2C;2&#x4E2A;&#x5B57;&#x7B26;&#xFF0C;&#x5F97;&#x5230;&#x7B2C;2&#x4E2A;base64&#x5B57;&#x7B26;" class="headerlink" title="2&#x3001;&#x5904;&#x7406;&#x7B2C;2&#x4E2A;&#x5B57;&#x7B26;&#xFF0C;&#x5F97;&#x5230;&#x7B2C;2&#x4E2A;base64&#x5B57;&#x7B26;"></a>2&#x3001;&#x5904;&#x7406;&#x7B2C;2&#x4E2A;&#x5B57;&#x7B26;&#xFF0C;&#x5F97;&#x5230;&#x7B2C;2&#x4E2A;base64&#x5B57;&#x7B26;</h3><p>&#x4E0B;&#x9762;&#x662F;&#x5904;&#x7406;x1&#x7684;&#x8FC7;&#x7A0B;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">.text:B3E40936 loc_B3E40936                            ; CODE XREF: sub_B3E40784+288&#x2193;j</span><br><span class="line">.text:B3E40936 CMP             R2, #1                  ; &#x6BD4;&#x8F83;index&#x548C;1</span><br><span class="line">.text:B3E40938 ITT NE                                  ; &#x4E0D;&#x76F8;&#x7B49;&#x6267;&#x884C;&#x7B2C;1&#x3001;2&#x6761;&#x6307;&#x4EE4;</span><br><span class="line">.text:B3E4093A ADDNE.W         R1, LR, #1              ; R2!=1, Then R1 = LR + 1</span><br><span class="line">.text:B3E4093E CMPNE           R1, R2</span><br><span class="line">.text:B3E40940 BNE             loc_B3E4096A</span><br><span class="line">.text:B3E40942 LDR             R1, [SP,#0x238+var_228] ; R1 = N</span><br><span class="line">.text:B3E40944 UXTB.W          R6, R11                 ; R11=x1&#x65E0;&#x7B26;&#x53F7;&#x6269;&#x5C55;&#x5230;32 &#x4F4D;(&#x9AD8;24&#x4F4D;&#x6E05;0</span><br><span class="line">.text:B3E40948 ADDS            R3, R1, R2              ; R3 = N + index</span><br><span class="line">.text:B3E4094A LDRB            R4, [R0,R3]             ; &#x53D6;&#x7B2C;&#x4E8C;&#x4E2A;base64&#x5B57;&#x7B26;&#xFF0C;&#x771F;&#x6B63;&#x4FDD;&#x5B58;&#x7684;&#x662F;x0&#x4F4E;2&#x4F4D;</span><br><span class="line">.text:B3E4094A                                         ; R0&#x4E3A;malloc&#x7684;buf&#x5730;&#x5740;</span><br><span class="line">.text:B3E4094C LDR             R1, =(byte_B3E44050 - 0xB3E40952)</span><br><span class="line">.text:B3E4094E ADD             R1, PC                  ; byte_B3E44050 ; R1&#x4E3A;base64&#x5B57;&#x7B26;&#x8868;&#x5730;&#x5740;</span><br><span class="line">.text:B3E40950 ORR.W           R4, R4, R6,LSR#4        ; 1&#x3001;&#x53D6;x1&#x9AD8;4&#x4F4D;</span><br><span class="line">.text:B3E40950                                         ; 2&#x3001;&#x53D6;x0&#x4F4E;2&#x4F4D;&#x548C;&#x4E0A;&#x9762;&#x6570;&#x503C;&#x8FDB;&#x884C;&#x4E0E;&#x64CD;&#x4F5C;&#xFF0C;&#x5F97;&#x5230;&#x4E00;&#x4E2A;&#x65B0;&#x7684;6&#x4F4D;&#x503C;&#xFF0C;&#x4F5C;&#x4E3A;&#x7B2C;&#x4E8C;&#x4E2A;&#x7D22;&#x5F15;</span><br><span class="line">.text:B3E40954 LDRB            R4, [R1,R4]             ; &#x67E5;&#x8868;&#xFF0C;&#x53D6;&#x7B2C;&#x4E8C;&#x4E2A;&#x7D22;&#x5F15;&#x503C;&#x5BF9;&#x5E94;&#x7684;base64&#x5B57;&#x7B26;</span><br><span class="line">.text:B3E40956 STRB            R4, [R0,R3]             ; &#x4FDD;&#x5B58;&#x7ED3;&#x679C;&#x5230;buf[N + index]</span><br><span class="line">.text:B3E40958 ADDS            R4, R0, R3              ; R4 = buf[N + index]&#x7684;&#x5730;&#x5740;</span><br><span class="line">.text:B3E4095A MOVS            R3, #0x3C ; &apos;&lt;&apos;         ; R3 = 00111100b</span><br><span class="line">.text:B3E4095C AND.W           R3, R3, R6,LSL#2        ; &#x5C06;x1&#x903B;&#x8F91;&#x5DE6;&#x79FB;2&#x4F4D;&amp;00111100b</span><br><span class="line">.text:B3E4095C                                         ; &#x5C06;x1&#x4F4E;&#x56DB;&#x4F4D;&#xFF0C;&#x540E;&#x9762;&#x4F5C;&#x4E3A;&#x7B2C;3&#x4E2A;base64&#x5B57;&#x7B26;&#x7D22;&#x5F15;&#x7684;&#x9AD8;&#x56DB;&#x4F4D;</span><br><span class="line">.text:B3E40960 ADDS            R6, R2, #1							 ; index++</span><br><span class="line">.text:B3E40962 CMP             R6, R8</span><br><span class="line">.text:B3E40964 STRB            R3, [R4,#1]             ; &#x5C06;y2&#x7D22;&#x5F15;&#x7684;&#x9AD8;&#x56DB;&#x4F4D;&#x5199;&#x5165;buf[N + index + 1]</span><br><span class="line">.text:B3E40966 BCC             loc_B3E40A34						 ; &#x82E5;R6&lt;=R8&#xFF0C;&#x5373;index + 1 &lt; len(s)&#xFF0C;&#x8DF3;&#x8F6C;loc_B3E40A34&#xFF0C;&#x7EE7;&#x7EED;&#x8BA1;&#x7B97;x2</span><br><span class="line">.text:B3E40968 B               loc_B3E40A82            ; index + 1 &lt; len(s)&#xFF0C;&#x5F53;&#x524D;index&#x4E3A;&#x6700;&#x540E;&#x4E00;&#x4E2A;&#x5B57;&#x7B26;&#xFF0C;&#x5904;&#x7406;&#x540E;&#x7EED;base64&#x5B57;&#x7B26;</span><br></pre></td></tr></table></figure>
<p><strong>&#x8BE5;&#x90E8;&#x5206;&#x7B97;&#x6CD5;&#x603B;&#x7ED3;&#xFF1A;</strong><br>1&#x3001;&#x53D6;x0&#x4F4E;2&#x4F4D;&#x4E0E;x2&#x7684;&#x9AD8;4&#x4F4D;&#xFF0C;&#x7EC4;&#x6210;&#x65B0;&#x7684;6&#x4F4D;&#x6570;&#x503C;&#xFF0C;&#x4F5C;&#x4E3A;base64&#x5B57;&#x7B26;&#x8868;&#x7D22;&#x5F15;<br>2&#x3001;&#x6839;&#x636E;&#x5B57;&#x7B26;&#x7D22;&#x5F15;&#xFF0C;&#x67E5;&#x5B57;&#x7B26;&#x8868;&#xFF0C;&#x5F97;&#x5230;&#x7B2C;&#x4E8C;&#x4E2A;base64&#x5B57;&#x7B26;&#xFF0C;&#x8BBE;&#x4E3A;y1<br>3&#x3001;N = K[3]<br>4&#x3001;&#x5C06;y1&#x5199;&#x5165;buf[ N + index ]<br>5&#x3001;&#x5C06;x1&#x4F4E;4&#x4F4D;&#x5199;&#x5165;buf[ N + index +1 ]</p>
<p><strong>&#x6307;&#x4EE4;&#x603B;&#x7ED3;&#xFF1A;</strong></p>
<p>1&#x3001;IT&#xFF08;If-Then&#xFF09;&#x6307;&#x4EE4;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.text:B3E40936 loc_B3E40936                            ; CODE XREF: sub_B3E40784+288&#x2193;j</span><br><span class="line">.text:B3E40936 CMP             R2, #1                  ; &#x6BD4;&#x8F83;index&#x548C;1</span><br><span class="line">.text:B3E40938 ITT NE                                  ; &#x4E0D;&#x76F8;&#x7B49;&#x6267;&#x884C;&#x7B2C;1&#x3001;2&#x6761;&#x6307;&#x4EE4;</span><br><span class="line">.text:B3E4093A ADDNE.W         R1, LR, #1              ; R2!=1, Then R1 = LR + 1</span><br><span class="line">.text:B3E4093E CMPNE           R1, R2</span><br></pre></td></tr></table></figure>
<p>IT&#x6307;&#x4EE4;&#x7528;&#x4E8E;&#x6839;&#x636E;&#x7279;&#x5B9A;&#x6761;&#x4EF6;&#x6765;&#x6267;&#x884C;&#x7D27;&#x968F;&#x5176;&#x540E;&#x7684;1~4&#x6761;&#x6307;&#x4EE4;&#xFF0C;&#x5176;&#x683C;&#x5F0F;&#x4E3A;&#xFF1A;<code>IT{x{y{z}}} {cond}</code> &#x3002;&#x5176;&#x4E2D;x&#x3001;y&#x3001;z&#x5206;&#x522B;&#x662F;&#x6267;&#x884C;&#x7B2C;&#x4E8C;&#x3001;&#x4E09;&#x3001;&#x56DB;&#x6761;&#x6307;&#x4EE4;&#x7684;&#x6761;&#x4EF6;&#xFF0C;&#x53EF;&#x53D6;&#x7684;&#x503C;&#x4E3A;T&#xFF08;then&#xFF09;&#x6216;E&#xFF08;else&#xFF09;&#xFF0C;&#x82E5;&#x4E3A;T&#xFF0C;&#x5219;&#x6267;&#x884C;cond&#x5BF9;&#x5E94;&#x7684;&#x6307;&#x4EE4;&#xFF1B;&#x82E5;&#x4E3A;E&#xFF0C;&#x5219;&#x6267;&#x884C;cond&#x76F8;&#x53CD;&#x6761;&#x4EF6;&#x7684;&#x6307;&#x4EE4;&#x3002;&#x800C;cond&#x5BF9;&#x5E94;&#x6267;&#x884C;&#x7B2C;&#x4E00;&#x6761;&#x6307;&#x4EE4;&#x7684;&#x6761;&#x4EF6;&#x3002;<a href="http://www.keil.com/support/man/docs/armasm/armasm_dom1361289872225.htm" target="_blank" rel="noopener">&#x53C2;&#x8003;</a></p>
<p>2&#x3001; BCC</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CMP A,B</span><br><span class="line">BCC labal</span><br></pre></td></tr></table></figure>
<p>A&lt;B&#xFF0C;&#x5219;&#x8DF3;&#x8F6C;&#x5230;label</p>
<h3 id="3&#x3001;&#x5904;&#x7406;&#x7B2C;3&#x4E2A;&#x5B57;&#x7B26;&#xFF0C;&#x5F97;&#x5230;&#x7B2C;3&#x3001;4&#x4E2A;base64&#x5B57;&#x7B26;"><a href="#3&#x3001;&#x5904;&#x7406;&#x7B2C;3&#x4E2A;&#x5B57;&#x7B26;&#xFF0C;&#x5F97;&#x5230;&#x7B2C;3&#x3001;4&#x4E2A;base64&#x5B57;&#x7B26;" class="headerlink" title="3&#x3001;&#x5904;&#x7406;&#x7B2C;3&#x4E2A;&#x5B57;&#x7B26;&#xFF0C;&#x5F97;&#x5230;&#x7B2C;3&#x3001;4&#x4E2A;base64&#x5B57;&#x7B26;"></a>3&#x3001;&#x5904;&#x7406;&#x7B2C;3&#x4E2A;&#x5B57;&#x7B26;&#xFF0C;&#x5F97;&#x5230;&#x7B2C;3&#x3001;4&#x4E2A;base64&#x5B57;&#x7B26;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">.text:B415E96A loc_B415E96A                            ; CODE XREF: sub_B415E784+1BC&#x2191;j</span><br><span class="line">.text:B415E96A CMP             R2, #2</span><br><span class="line">.text:B415E96C ITT NE</span><br><span class="line">.text:B415E96E ADDNE.W         R1, LR, #2</span><br><span class="line">.text:B415E972 CMPNE           R1, R2</span><br><span class="line">.text:B415E974 BNE             loc_B415EA34</span><br><span class="line">.text:B415E976 LDR             R1, =(byte_B4162050 - 0xB415E984)</span><br><span class="line">.text:B415E978 AND.W           R4, R11, #0xC0          ; &#x53D6;x2&#x7684;&#x9AD8;2&#x4F4D;&#xFF0C;&#x4E0E;x1&#x7684;&#x4F4E;4&#x4F4D;&#x53EF;&#x4EE5;&#x7EC4;&#x6210;&#x4E00;&#x4E2A;6&#x4F4D;base64&#x5B57;&#x7B26;&#x7D22;&#x5F15;</span><br><span class="line">.text:B415E97C LDR.W           LR, [SP,#0x238+var_228] ; LR = N</span><br><span class="line">.text:B415E980 ADD             R1, PC                  ; byte_B4162050 ; R1&#x662F;base64&#x5B57;&#x7B26;&#x8868;&#x5730;&#x5740;</span><br><span class="line">.text:B415E982 ADD.W           R3, LR, R2							 ; R3 = N + index</span><br><span class="line">.text:B415E986 ADD.W           LR, LR, #1							 ; LR++</span><br><span class="line">.text:B415E98A STR.W           LR, [SP,#0x238+var_228] ; N++</span><br><span class="line">.text:B415E98E LDRB            R6, [R0,R3]             ; R0&#x4E3A;buf&#x7684;&#x5730;&#x5740;&#xFF0C;&#x53D6;&#x51FA;x1&#x7684;&#x4F4E;&#x56DB;&#x4F4D;</span><br><span class="line">.text:B415E990 ORR.W           R6, R6, R4,LSR#6        ; &#x7EC4;&#x6210;&#x65B0;&#x7684;6&#x4F4D;base64&#x5B57;&#x7B26;&#x7D22;&#x5F15;</span><br><span class="line">.text:B415E994 LDRB            R6, [R1,R6]             ; &#x67E5;&#x8868;&#xFF0C;&#x53D6;&#x51FA;base64&#x5B57;&#x7B26;</span><br><span class="line">.text:B415E996 EOR.W           R6, R6, #0xF            ; &#x53D6;&#x51FA;&#x7684;base64&#x5B57;&#x7B26;&#x5F02;&#x6216;0xF</span><br><span class="line">.text:B415E99A STRB            R6, [R0,R3]             ; &#x5199;&#x5165;buf</span><br><span class="line">.text:B415E99C AND.W           R6, R11, #0x3F          ; &#x53D6;x2&#x4F4E;6&#x4F4D;</span><br><span class="line">.text:B415E9A0 ADD             R3, R0                  ; &#x53D6;&#x5F53;&#x524D;buf&#x5730;&#x5740;</span><br><span class="line">.text:B415E9A2 LDRB            R1, [R1,R6]             ; &#x6839;&#x636E;x2&#x7684;&#x4F4E;6&#x4F4D;&#xFF0C;&#x67E5;&#x8868;&#xFF0C;&#x53D6;&#x7B2C;4&#x4E2A;base64&#x5B57;&#x7B26;</span><br><span class="line">.text:B415E9A4 STRB            R1, [R3,#1]             ; &#x5199;&#x5165;buf&#x7684;&#x4E0B;&#x4E00;&#x4E2A;&#x5B57;&#x8282;</span><br><span class="line">.text:B415E9A6 B               loc_B415EA34</span><br></pre></td></tr></table></figure>
<p>&#x8FD9;&#x91CC;&#x518D;&#x6B21;&#x5224;&#x65AD;&#x4E86;index&#x5728;&#x7EC4;&#x7684;&#x4F4D;&#x7F6E;&#xFF08;&#x611F;&#x89C9;&#x662F;&#x591A;&#x4F59;&#x7684;<br>&#x6839;&#x636E;&#x6CE8;&#x91CA;&#x53EF;&#x4EE5;&#x6E05;&#x695A;&#x7684;&#x770B;&#x5230;&#xFF0C;&#x751F;&#x6210;&#x4E86;&#x7B2C;3&#x3001;4&#x4E2A;base64&#x5B57;&#x7B26;&#xFF0C;&#x5176;&#x4E2D;&#x548C;&#x5E38;&#x89C4;base64&#x7B97;&#x6CD5;&#x4E0D;&#x540C;&#x7684;&#x662F;&#xFF0C;&#x7B2C;3&#x4E2A;base64&#x5B57;&#x7B26;&#x4E0E;0xF&#x8FDB;&#x884C;&#x4E86;&#x5F02;&#x6216;&#x5904;&#x7406;</p>
<p>&#x5230;&#x6B64;&#x7B2C;&#x4E00;&#x7EC4;3&#x4E2A;&#x5B57;&#x7B26;&#xFF0C;&#x751F;&#x6210;&#x4E86;4&#x4E2A;base64&#x5B57;&#x7B26;&#x3002;</p>
<h3 id="4&#x3001;strlen-s-3-1&#x65F6;&#x7684;&#x5904;&#x7406;"><a href="#4&#x3001;strlen-s-3-1&#x65F6;&#x7684;&#x5904;&#x7406;" class="headerlink" title="4&#x3001;strlen(s) % 3 = 1&#x65F6;&#x7684;&#x5904;&#x7406;"></a>4&#x3001;strlen(s) % 3 = 1&#x65F6;&#x7684;&#x5904;&#x7406;</h3><p>&#x5F53;base64&#x5904;&#x7406;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#x957F;&#x5EA6;&#x4E0D;&#x80FD;&#x88AB;3&#x6574;&#x9664;&#xFF0C;&#x4F1A;&#x6709;&#x5176;&#x4ED6;&#x7684;&#x5904;&#x7406;</p>
<p>&#x5E38;&#x89C4;&#x7684;base64&#x7B97;&#x6CD5;&#x7684;&#x5904;&#x7406;&#x65B9;&#x5F0F;&#x662F;&#x76F4;&#x63A5;&#x8865;&#x96F6;&#x67E5;&#x8868;</p>
<p>&#x800C;&#x8FD9;&#x4E2A;&#x53D8;&#x5F62;&#x7684;base64&#x7B97;&#x6CD5;&#x6709;&#x70B9;&#x4E0D;&#x540C;</p>
<p>&#x6211;&#x4EEC;&#x4ECE;&#x5F53;&#x5269;&#x4F59;&#x5B57;&#x7B26;&#x4E3A;x0&#x65F6;&#x7684;&#x5904;&#x7406;&#x65B9;&#x5F0F;&#x5F00;&#x59CB;&#x5206;&#x6790;&#xFF0C;&#x4ECE;&#x4E0A;&#x9762;&#x7684;&#x8DF3;&#x8F6C;&#x5206;&#x6790;&#xFF0C;&#x53EF;&#x4EE5;&#x77E5;&#x9053;&#x8BE5;&#x6BB5;&#x4EE3;&#x7801;&#x5728;loc_00000A3C</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.text:B4052A3C loc_B4052A3C                            ; CODE XREF: sub_B4052784+2AE&#x2191;j</span><br><span class="line">.text:B4052A3C LDRB            R1, [R1,R3]             ; R1 = base64&#x5B57;&#x7B26;&#x8868;&#xFF0C;&#x5C06;x0&#x7684;&#x4F4E;2&#x4F4D;&#x5DE6;&#x79FB;4&#x4F4D;&#xFF0C;&#x5F53;&#x505A;base64&#x5B57;&#x7B26;&#x8868;&#x7D22;&#x5F15;&#xFF0C;&#x5F97;&#x5230;y1</span><br><span class="line">.text:B4052A3E MOVW            R2, #0x3B3B</span><br><span class="line">.text:B4052A42 STRH            R2, [R4,#2]             ; R4&#x4E3A;buf&#x5730;&#x5740;&#xFF0C;y2=y3=0x3b</span><br><span class="line">.text:B4052A44</span><br><span class="line">.text:B4052A44 loc_B4052A44                            ; CODE XREF: sub_B4052784+304&#x2193;j</span><br><span class="line">.text:B4052A44 STRB            R1, [R4,#1]             ; &#x5199;&#x5165;y1</span><br></pre></td></tr></table></figure>
<p><strong>&#x7528;&#x5E38;&#x89C4;base64&#x7B97;&#x6CD5;&#x751F;&#x6210;y0&#x3001;y1&#x540E;&#xFF0C;&#x4E0D;&#x540C;&#x7684;&#x662F;&#xFF0C;&#x8BE5;&#x53D8;&#x5F62;&#x7B97;&#x6CD5;&#x5728;&#x540E;&#x9762;&#x8FFD;&#x52A0;&#x4E86;0x3B3B</strong>&#xFF0C;&#x4E3A;<strong>&#x201C;;;&#x201D;</strong>&#xFF0C;&#x60F3;&#x5F53;&#x4E8E;base64&#x7B97;&#x6CD5;&#x4E2D;&#x7684;==</p>
<h3 id="5&#x3001;strlen-s-3-2&#x65F6;&#x7684;&#x5904;&#x7406;"><a href="#5&#x3001;strlen-s-3-2&#x65F6;&#x7684;&#x5904;&#x7406;" class="headerlink" title="5&#x3001;strlen(s) % 3 = 2&#x65F6;&#x7684;&#x5904;&#x7406;"></a>5&#x3001;strlen(s) % 3 = 2&#x65F6;&#x7684;&#x5904;&#x7406;</h3><p>&#x5F53;&#x5269;&#x4F59;&#x5B57;&#x7B26;&#x4E3A;x1&#x65F6;&#x7684;&#x5904;&#x7406;&#x65B9;&#x5F0F;&#x7684;&#x5206;&#x6790;&#xFF0C;&#x4ECE;&#x4E0A;&#x9762;&#x7684;&#x8DF3;&#x8F6C;&#x5206;&#x6790;&#xFF0C;&#x53EF;&#x4EE5;&#x77E5;&#x9053;&#x8BE5;&#x6BB5;&#x4EE3;&#x7801;&#x5728;loc_00000A82</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.text:B3A1EA82 loc_B3A1EA82                            </span><br><span class="line">.text:B3A1EA82 LDRB            R1, [R1,R3]             ; R1&#x4E3A;base64&#x5B57;&#x7B26;&#x8868;&#xFF0C;R3&#x4F4D;x1&#x4F4E;4&#x4F4D;&#x518D;&#x5DE6;&#x79FB;2&#x4F4D;&#x7684;&#x503C;&#xFF0C;&#x5373;y2&#x7684;base64&#x5B57;&#x7B26;&#x7D22;&#x5F15;</span><br><span class="line">.text:B3A1EA84 MOVS            R2, #0x34 ; &apos;4&apos;</span><br><span class="line">.text:B3A1EA86 STRB            R2, [R4,#2]             ; y3 = 0x34</span><br><span class="line">.text:B3A1EA88 B               loc_B3A1EA44            </span><br><span class="line"></span><br><span class="line">.text:B4052A44 loc_B4052A44                            </span><br><span class="line">.text:B4052A44 STRB            R1, [R4,#1]             ; &#x5199;&#x5165;y2</span><br></pre></td></tr></table></figure>
<p><strong>&#x7528;&#x5E38;&#x89C4;base64&#x7B97;&#x6CD5;&#x751F;&#x6210;y0&#x3001;y1&#x3001;y2&#x540E;&#xFF0C;&#x4E0D;&#x540C;&#x7684;&#x662F;&#xFF0C;&#x8BE5;&#x53D8;&#x5F62;&#x7B97;&#x6CD5;&#x5728;&#x540E;&#x9762;&#x8FFD;&#x52A0;&#x4E86;0x34</strong></p>
<p>&#x81F3;&#x6B64;&#x53D8;&#x5F62;base64&#x7B97;&#x6CD5;&#x5206;&#x6790;&#x5B8C;&#x6210;</p>
<h3 id="6&#x3001;&#x53D8;&#x5F62;base64&#x7B97;&#x6CD5;&#x603B;&#x7ED3;"><a href="#6&#x3001;&#x53D8;&#x5F62;base64&#x7B97;&#x6CD5;&#x603B;&#x7ED3;" class="headerlink" title="6&#x3001;&#x53D8;&#x5F62;base64&#x7B97;&#x6CD5;&#x603B;&#x7ED3;"></a>6&#x3001;&#x53D8;&#x5F62;base64&#x7B97;&#x6CD5;&#x603B;&#x7ED3;</h3><p>&#x8BBE;&#x4E00;&#x7EC4;&#x5F85;&#x7F16;&#x7801;&#x7684;&#x5B57;&#x7B26;&#x957F;&#x5EA6;&#x4E3A;L&#xFF0C;&#x751F;&#x6210;&#x7F16;&#x7801;&#x5B57;&#x7B26;&#x4E3A;y0&#x3001;y1&#x3001;y2&#x3001;y3</p>
<p><strong>&#x4E0E;&#x4F20;&#x7EDF;base64&#x7B97;&#x6CD5;&#x4E0D;&#x540C;&#x7684;&#x662F;&#xFF1A;</strong><br>1&#x3001;&#x5B57;&#x7B26;&#x8868;&#x53D8;&#x6210; <strong>!:#$%&amp;()+-*/`~_[]{}?&lt;&gt;,.@^abcdefghijklmnopqrstuvwxyz0123456789\&#x2018;;&#x201D;</strong><br>2&#x3001;y0 = y0 ^ 0x7<br>3&#x3001;y2 = y2 ^ 0xF<br>4&#x3001;&#x82E5;L % 3 = 2&#xFF0C;y3 = 0x34</p>
<h2 id="&#x4E09;&#x3001;&#x89E3;&#x5BC6;&#x4EE3;&#x7801;"><a href="#&#x4E09;&#x3001;&#x89E3;&#x5BC6;&#x4EE3;&#x7801;" class="headerlink" title="&#x4E09;&#x3001;&#x89E3;&#x5BC6;&#x4EE3;&#x7801;"></a>&#x4E09;&#x3001;&#x89E3;&#x5BC6;&#x4EE3;&#x7801;</h2><p>&#x6700;&#x540E;&#x5904;&#x7406;&#x7684;&#x7ED3;&#x679C;&#x4F1A;&#x4E0E;  <code>{9*8ga*l!Tn?@#fj&apos;j&quot;,0x24,&quot;\g;;</code> &#x5BF9;&#x6BD4;</p>
<p>&#x7531;&#x4EE5;&#x4E0A;&#x5206;&#x6790;&#xFF0C;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x5199;&#x51FA;&#x89E3;&#x5BC6;&#x4EE3;&#x7801;</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line">RC4_key = <span class="string">&quot;36f36b3c-a03e-4996-8759-8408e626c215&quot;</span></span><br><span class="line">base64_encoded = <span class="string">&quot; {9*8ga*l!Tn?@#fj&apos;j$\\g;;&quot;</span></span><br><span class="line">base64_table = <span class="string">&quot;!:#$%&amp;()+-*/`~_[]{}?&lt;&gt;,.@^abcdefghijklmnopqrstuvwxyz0123456789\\&apos;;&quot;</span>;</span><br><span class="line">base64_table_ori = <span class="string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=&quot;</span>;</span><br><span class="line"></span><br><span class="line">RC4_S = [<span class="number">0xD7</span>,<span class="number">0xDF</span>,   <span class="number">2</span>,<span class="number">0xD4</span>,<span class="number">0xFE</span>,<span class="number">0x6F</span>,<span class="number">0x53</span>,<span class="number">0x3C</span>,<span class="number">0x25</span>,<span class="number">0x6C</span>,<span class="number">0x99</span>,<span class="number">0x97</span>,   <span class="number">6</span>,<span class="number">0x56</span>,<span class="number">0x8F</span>,<span class="number">0xDE</span>,</span><br><span class="line">		<span class="number">0x40</span>,<span class="number">0x11</span>,<span class="number">0x64</span>,   <span class="number">7</span>,<span class="number">0x36</span>,<span class="number">0x15</span>,<span class="number">0x70</span>,<span class="number">0xCA</span>,<span class="number">0x18</span>,<span class="number">0x17</span>,<span class="number">0x7D</span>,<span class="number">0x6A</span>,<span class="number">0xDB</span>,<span class="number">0x13</span>,<span class="number">0x30</span>,<span class="number">0x37</span>,</span><br><span class="line">		<span class="number">0x29</span>,<span class="number">0x60</span>,<span class="number">0xE1</span>,<span class="number">0x23</span>,<span class="number">0x28</span>,<span class="number">0x8A</span>,<span class="number">0x50</span>,<span class="number">0x8C</span>,<span class="number">0xAC</span>,<span class="number">0x2F</span>,<span class="number">0x88</span>,<span class="number">0x20</span>,<span class="number">0x27</span>, <span class="number">0xF</span>,<span class="number">0x7C</span>,<span class="number">0x52</span>,</span><br><span class="line">		<span class="number">0xA2</span>,<span class="number">0xAB</span>,<span class="number">0xFC</span>,<span class="number">0xA1</span>,<span class="number">0xCC</span>,<span class="number">0x21</span>,<span class="number">0x14</span>,<span class="number">0x1F</span>,<span class="number">0xC2</span>,<span class="number">0xB2</span>,<span class="number">0x8B</span>,<span class="number">0x2C</span>,<span class="number">0xB0</span>,<span class="number">0x3A</span>,<span class="number">0x66</span>,<span class="number">0x46</span>,</span><br><span class="line">		<span class="number">0x3D</span>,<span class="number">0xBB</span>,<span class="number">0x42</span>,<span class="number">0xA5</span>, <span class="number">0xC</span>,<span class="number">0x75</span>,<span class="number">0x22</span>,<span class="number">0xD8</span>,<span class="number">0xC3</span>,<span class="number">0x76</span>,<span class="number">0x1E</span>,<span class="number">0x83</span>,<span class="number">0x74</span>,<span class="number">0xF0</span>,<span class="number">0xF6</span>,<span class="number">0x1C</span>,</span><br><span class="line">		<span class="number">0x26</span>,<span class="number">0xD1</span>,<span class="number">0x4F</span>, <span class="number">0xB</span>,<span class="number">0xFF</span>,<span class="number">0x4C</span>,<span class="number">0x4D</span>,<span class="number">0xC1</span>,<span class="number">0x87</span>,   <span class="number">3</span>,<span class="number">0x5A</span>,<span class="number">0xEE</span>,<span class="number">0xA4</span>,<span class="number">0x5D</span>,<span class="number">0x9E</span>,<span class="number">0xF4</span>,</span><br><span class="line">		<span class="number">0xC8</span>, <span class="number">0xD</span>,<span class="number">0x62</span>,<span class="number">0x63</span>,<span class="number">0x3E</span>,<span class="number">0x44</span>,<span class="number">0x7B</span>,<span class="number">0xA3</span>,<span class="number">0x68</span>,<span class="number">0x32</span>,<span class="number">0x1B</span>,<span class="number">0xAA</span>,<span class="number">0x2D</span>,   <span class="number">5</span>,<span class="number">0xF3</span>,<span class="number">0xF7</span>,</span><br><span class="line">		<span class="number">0x16</span>,<span class="number">0x61</span>,<span class="number">0x94</span>,<span class="number">0xE0</span>,<span class="number">0xD0</span>,<span class="number">0xD3</span>,<span class="number">0x98</span>,<span class="number">0x69</span>,<span class="number">0x78</span>,<span class="number">0xE9</span>, <span class="number">0xA</span>,<span class="number">0x65</span>,<span class="number">0x91</span>,<span class="number">0x8E</span>,<span class="number">0x35</span>,<span class="number">0x85</span>,</span><br><span class="line">		<span class="number">0x7A</span>,<span class="number">0x51</span>,<span class="number">0x86</span>,<span class="number">0x10</span>,<span class="number">0x3F</span>,<span class="number">0x7F</span>,<span class="number">0x82</span>,<span class="number">0xDD</span>,<span class="number">0xB5</span>,<span class="number">0x1A</span>,<span class="number">0x95</span>,<span class="number">0xE7</span>,<span class="number">0x43</span>,<span class="number">0xFD</span>,<span class="number">0x9B</span>,<span class="number">0x24</span>,</span><br><span class="line">		<span class="number">0x45</span>,<span class="number">0xEF</span>,<span class="number">0x92</span>,<span class="number">0x5C</span>,<span class="number">0xE4</span>,<span class="number">0x96</span>,<span class="number">0xA9</span>,<span class="number">0x9C</span>,<span class="number">0x55</span>,<span class="number">0x89</span>,<span class="number">0x9A</span>,<span class="number">0xEA</span>,<span class="number">0xF9</span>,<span class="number">0x90</span>,<span class="number">0x5F</span>,<span class="number">0xB8</span>,</span><br><span class="line">		   <span class="number">4</span>,<span class="number">0x84</span>,<span class="number">0xCF</span>,<span class="number">0x67</span>,<span class="number">0x93</span>,   <span class="number">0</span>,<span class="number">0xA6</span>,<span class="number">0x39</span>,<span class="number">0xA8</span>,<span class="number">0x4E</span>,<span class="number">0x59</span>,<span class="number">0x31</span>,<span class="number">0x6B</span>,<span class="number">0xAD</span>,<span class="number">0x5E</span>,<span class="number">0x5B</span>,</span><br><span class="line">		<span class="number">0x77</span>,<span class="number">0xB1</span>,<span class="number">0x54</span>,<span class="number">0xDC</span>,<span class="number">0x38</span>,<span class="number">0x41</span>,<span class="number">0xB6</span>,<span class="number">0x47</span>,<span class="number">0x9F</span>,<span class="number">0x73</span>,<span class="number">0xBA</span>,<span class="number">0xF8</span>,<span class="number">0xAE</span>,<span class="number">0xC4</span>,<span class="number">0xBE</span>,<span class="number">0x34</span>,</span><br><span class="line">		   <span class="number">1</span>,<span class="number">0x4B</span>,<span class="number">0x2A</span>,<span class="number">0x8D</span>,<span class="number">0xBD</span>,<span class="number">0xC5</span>,<span class="number">0xC6</span>,<span class="number">0xE8</span>,<span class="number">0xAF</span>,<span class="number">0xC9</span>,<span class="number">0xF5</span>,<span class="number">0xCB</span>,<span class="number">0xFB</span>,<span class="number">0xCD</span>,<span class="number">0x79</span>,<span class="number">0xCE</span>,</span><br><span class="line">		<span class="number">0x12</span>,<span class="number">0x71</span>,<span class="number">0xD2</span>,<span class="number">0xFA</span>,   <span class="number">9</span>,<span class="number">0xD5</span>,<span class="number">0xBC</span>,<span class="number">0x58</span>,<span class="number">0x19</span>,<span class="number">0x80</span>,<span class="number">0xDA</span>,<span class="number">0x49</span>,<span class="number">0x1D</span>,<span class="number">0xE6</span>,<span class="number">0x2E</span>,<span class="number">0xE3</span>,</span><br><span class="line">		<span class="number">0x7E</span>,<span class="number">0xB7</span>,<span class="number">0x3B</span>,<span class="number">0xB3</span>,<span class="number">0xA0</span>,<span class="number">0xB9</span>,<span class="number">0xE5</span>,<span class="number">0x57</span>,<span class="number">0x6E</span>,<span class="number">0xD9</span>,   <span class="number">8</span>,<span class="number">0xEB</span>,<span class="number">0xC7</span>,<span class="number">0xED</span>,<span class="number">0x81</span>,<span class="number">0xF1</span>,</span><br><span class="line">		<span class="number">0xF2</span>,<span class="number">0xBF</span>,<span class="number">0xC0</span>,<span class="number">0xA7</span>,<span class="number">0x4A</span>,<span class="number">0xD6</span>,<span class="number">0x2B</span>,<span class="number">0xB4</span>,<span class="number">0x72</span>,<span class="number">0x9D</span>, <span class="number">0xE</span>,<span class="number">0x6D</span>,<span class="number">0xEC</span>,<span class="number">0x48</span>,<span class="number">0xE2</span>,<span class="number">0x33</span>,</span><br><span class="line">		]</span><br><span class="line">RC4_T = []</span><br><span class="line">t = <span class="string">&quot;&quot;</span></span><br><span class="line">tmp = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(base64_encoded)):</span><br><span class="line">	<span class="keyword">if</span> base64_encoded[i]==<span class="string">&quot;;&quot;</span>:</span><br><span class="line">		t = base64_encoded[i]</span><br><span class="line">		tmp +=t</span><br><span class="line">		<span class="keyword">continue</span></span><br><span class="line">	<span class="keyword">if</span> i%<span class="number">4</span>==<span class="number">0</span>:</span><br><span class="line">		t = chr(ord(base64_encoded[i])^<span class="number">0x7</span>)</span><br><span class="line">	<span class="keyword">elif</span> i%<span class="number">4</span> == <span class="number">2</span>:</span><br><span class="line">		t = chr(ord(base64_encoded[i])^<span class="number">0xF</span>)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		t = base64_encoded[i]</span><br><span class="line">	tmp +=t</span><br><span class="line"><span class="comment">#print tmp#&apos;{6*?gn*k![n8@,fm&apos;e$[g;;</span></span><br><span class="line"></span><br><span class="line">transtable = string.maketrans(base64_table,base64_table_ori)</span><br><span class="line">transtmp = tmp.translate(transtable)</span><br><span class="line"><span class="comment">#print transtmp#/R6KTgnKkAPn8YWfm/eDPg==</span></span><br><span class="line"></span><br><span class="line">base64_decoded = transtmp.decode(<span class="string">&apos;base64&apos;</span>)</span><br><span class="line">cipher = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(base64_decoded)):</span><br><span class="line">	cipher.append(int(binascii.b2a_hex(base64_decoded[i]),<span class="number">16</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#&#x751F;&#x6210;T</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">	RC4_T.append(ord(RC4_key[i%len(RC4_key)]))</span><br><span class="line"></span><br><span class="line"><span class="comment">#&#x7528;T&#x7F6E;&#x4E71;S</span></span><br><span class="line">j = RC4_T[<span class="number">0</span>] - <span class="number">0x29</span></span><br><span class="line">RC4_S[<span class="number">0</span>],RC4_S[j] = RC4_S[j],RC4_S[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">256</span>):</span><br><span class="line">	j = (j + RC4_T[i] + RC4_S[i]) % <span class="number">256</span></span><br><span class="line">	RC4_S[i],RC4_S[j] = RC4_S[j],RC4_S[i]</span><br><span class="line"></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line">j = <span class="number">0</span></span><br><span class="line">res = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> range(len(cipher)):</span><br><span class="line">	i = (i+<span class="number">1</span>)%<span class="number">256</span></span><br><span class="line">	m = RC4_S[i]</span><br><span class="line">	j = (j + m)%<span class="number">256</span></span><br><span class="line">	RC4_S[i],RC4_S[j] = RC4_S[j],RC4_S[i]</span><br><span class="line">	n = RC4_S[i]</span><br><span class="line">	p = RC4_S[(m+n)%<span class="number">256</span>] ^ cipher[k]</span><br><span class="line">	res += chr(p)</span><br><span class="line"><span class="keyword">print</span> res</span><br></pre></td></tr></table></figure>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/12/17/2019-12-17 ubuntu16-04源码编译Android6-0-0-r1/">ubuntu-16.04 源码编译 Android-6.0.0_r1 与调试</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-12-17</time><div class="content"><p>&#x4E00;&#x6B21;&#x8FC7;&#x8FD8;&#x662F;&#x633A;&#x5F00;&#x5FC3;&#x7684;&#xFF0C;&#x8BB0;&#x5F55;&#x4E0B;&#x7F16;&#x8BD1;&#x8FC7;&#x7A0B;</p>
<p>&#x73AF;&#x5883;&#xFF1A;ubuntu-16.04 amd64&#xFF0C;&#x6E90;&#x7801;&#x662F;Android-6.0.0_r1</p>
<h1 id="1&#x3001;&#x73AF;&#x5883;&#x914D;&#x7F6E;"><a href="#1&#x3001;&#x73AF;&#x5883;&#x914D;&#x7F6E;" class="headerlink" title="1&#x3001;&#x73AF;&#x5883;&#x914D;&#x7F6E;"></a>1&#x3001;&#x73AF;&#x5883;&#x914D;&#x7F6E;</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install -y git flex bison gperf build-essential libncurses5-dev:i386 \</span><br><span class="line">libx11-dev:i386 libreadline6-dev:i386 libgl1-mesa-dev g++-multilib \</span><br><span class="line">tofrodos python-markdown libxml2-utils xsltproc \</span><br><span class="line">zlib1g-dev:i386 dpkg-dev libsdl1.2-dev libesd0-dev \</span><br><span class="line">git-core gnupg zip curl zlib1g-dev gcc-multilib \</span><br><span class="line">libc6-dev-i386 lib32ncurses5-dev x11proto-core-dev \</span><br><span class="line">libx11-dev lib32z-dev ccache unzip m4</span><br></pre></td></tr></table></figure>
<p>&#x5B89;&#x88C5; <strong>open JDK7</strong></p>
<p>Ubuntu16.04&#x6CA1;&#x6709;open JDK7&#x7684;&#x6E90;&#xFF0C;&#x589E;&#x52A0;&#x4E2A;&#x4ED3;&#x5E93;&#x6E90;</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo<span class="built_in"> add-apt-repository </span>ppa:openjdk-r/ppa </span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install openjdk-7-jdk</span><br></pre></td></tr></table></figure>
<p>&#x5B89;&#x88C5;&#x540E;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#x5DF2;&#x7ECF;&#x914D;&#x7F6E;&#x597D;&#xFF0C;java -version&#x67E5;&#x770B;</p>
<p>&#x6709;&#x4E9B;&#x5DE5;&#x5177;&#x9700;&#x8981;JDX8&#x624D;&#x80FD;&#x8FD0;&#x884C;&#xFF0C;&#x6BD4;&#x5982;jadx&#xFF0C;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x4E0B;&#x9762;&#x7684;&#x547D;&#x4EE4;&#x5207;&#x6362;java&#x7248;&#x672C;</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo update-alternatives --config java</span><br><span class="line">sudo update-alternatives --config javac</span><br></pre></td></tr></table></figure>
<h1 id="2&#x3001;&#x83B7;&#x5F97;Android&#x6E90;&#x7801;"><a href="#2&#x3001;&#x83B7;&#x5F97;Android&#x6E90;&#x7801;" class="headerlink" title="2&#x3001;&#x83B7;&#x5F97;Android&#x6E90;&#x7801;"></a>2&#x3001;&#x83B7;&#x5F97;Android&#x6E90;&#x7801;</h1><p>&#x4F7F;&#x7528;repo&#x4E0B;&#x8F7D;&#x6587;&#x4EF6;&#x5F88;&#x5927;&#xFF0C;&#x56E0;&#x4E3A;aosp&#x6587;&#x4EF6;&#x5939;&#x4E0B;&#x7684;<strong>.repo</strong>&#x6587;&#x4EF6;&#x662F;&#x4ED3;&#x5E93;&#xFF0C;<strong>.repo</strong>&#x4EE5;&#x5916;&#x7684;&#x6587;&#x4EF6;&#x624D;&#x662F;&#x9700;&#x8981;&#x7684;&#x6E90;&#x7801;&#x6587;&#x4EF6;&#xFF0C;.repo&#x5F88;&#x5927;&#xFF0C;&#x4F7F;&#x7528;repo&#x4E0B;&#x8F7D;&#x7684;&#x6E90;&#x7801;&#x6709;&#x51E0;&#x5341;&#x4E2A;G&#x3002;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x4E0B;&#x8F7D;&#x522B;&#x4EBA;&#x6253;&#x5305;&#x597D;&#x7684;&#x955C;&#x50CF;&#x6587;&#x4EF6;</p>
<p><a href="https://pan.baidu.com/s/1JYOgTrF6xe3cNwmzxmE5Yw" target="_blank" rel="noopener">https://pan.baidu.com/s/1JYOgTrF6xe3cNwmzxmE5Yw</a></p>
<p>&#x8FD9;&#x6837;android-6.0.0_r1&#x7684;&#x5927;&#x5C0F;&#x4E3A;4G&#x591A;</p>
<p>&#x8C37;&#x6B4C;&#x5B98;&#x65B9;repo&#x548C;&#x6559;&#x7A0B;<br><a href="https://source.android.com/setup/build/downloading" target="_blank" rel="noopener">https://source.android.com/setup/build/downloading</a><br>&#x5F53;&#x7136;&#x4E5F;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x6E05;&#x534E;&#x7684;repo&#x955C;&#x50CF;<br><a href="https://mirrors.tuna.tsinghua.edu.cn/help/AOSP/" target="_blank" rel="noopener">https://mirrors.tuna.tsinghua.edu.cn/help/AOSP/</a></p>
<p>&#x4E0B;&#x8F7D;&#x4E0B;&#x6765;&#x662F;7z&#x538B;&#x7F29;&#x6587;&#x4EF6;&#xFF0C;&#x9700;&#x8981;&#x989D;&#x5916;&#x7684;&#x8F6F;&#x4EF6;&#x89E3;&#x538B;</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install p7zip-full</span><br><span class="line">7z x android-6.0.0_r1.7z</span><br></pre></td></tr></table></figure>
<p>&#x89E3;&#x538B;&#x540E;&#x4FEE;&#x6539;<strong>art/build/Android.common_build.mk</strong>&#xFF0C;&#x4FEE;&#x6539;&#x5185;&#x5BB9;&#x5982;&#x4E0B;</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Host.</span></span><br><span class="line">ART_HOST_CLANG := false</span><br><span class="line">- <span class="keyword">ifneq</span> (<span class="variable">$(WITHOUT_HOST_CLANG)</span>,true)</span><br><span class="line">+ <span class="keyword">ifeq</span> (<span class="variable">$(WITHOUT_HOST_CLANG)</span>,false)</span><br><span class="line"><span class="comment"># By default, host builds use clang for better warnings.</span></span><br><span class="line">ART_HOST_CLANG := true</span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure>
<p>&#x5426;&#x5219;&#x4F1A;&#x62A5;unsupported reloc&#x2026;&#x7684;&#x9519;&#x8BEF;</p>
<p>If it still not works,try this in your android root path:<br> <code>cp /usr/bin/ld.gold prebuilts/gcc/linux-x86/host/x86_64-linux-glibc2.11-4.6/x86_64-linux/bin/ld</code></p>
<h1 id="3&#x3001;&#x7F16;&#x8BD1;"><a href="#3&#x3001;&#x7F16;&#x8BD1;" class="headerlink" title="3&#x3001;&#x7F16;&#x8BD1;"></a>3&#x3001;&#x7F16;&#x8BD1;</h1><p>&#x5728;&#x6E90;&#x7801;&#x6839;&#x76EE;&#x5F55;&#x4E0B;&#xFF1A;</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make clobber</span><br><span class="line">source build/envsetup.sh</span><br></pre></td></tr></table></figure>
<p>&#x901A;&#x8FC7;lunch&#x9009;&#x62E9;&#x7F16;&#x8BD1;&#x76EE;&#x6807;&#xFF0C;&#x8FD9;&#x91CC;&#x7F16;&#x8BD1;<strong>aosp_arm-eng</strong>&#xFF0C;&#x9009;&#x62E9;1</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lunch</span><br></pre></td></tr></table></figure>
<p>&#x5F00;&#x59CB;&#x7F16;&#x8BD1;</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">make</span> -j8</span><br></pre></td></tr></table></figure>
<p>&#x7F16;&#x8BD1;&#x597D;&#x7684;&#x6587;&#x4EF6;&#x5728;<strong>out/target/product/generic</strong></p>
<p>&#x542F;&#x52A8;&#x6A21;&#x62DF;&#x5668;</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">emulator -memory <span class="number">512</span> -cache-size <span class="number">2028</span></span><br></pre></td></tr></table></figure>
<p>&#x82E5;&#x6709;&#x591A;&#x4E2A;&#x7248;&#x672C;</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">source build/envsetup.sh</span><br><span class="line">lunch</span><br><span class="line">emulator</span><br></pre></td></tr></table></figure>
<h2 id="&#x7F16;&#x8BD1;&#x5355;&#x72EC;&#x7684;&#x6A21;&#x5757;"><a href="#&#x7F16;&#x8BD1;&#x5355;&#x72EC;&#x7684;&#x6A21;&#x5757;" class="headerlink" title="&#x7F16;&#x8BD1;&#x5355;&#x72EC;&#x7684;&#x6A21;&#x5757;"></a>&#x7F16;&#x8BD1;&#x5355;&#x72EC;&#x7684;&#x6A21;&#x5757;</h2><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">mmm</span> art/runtime</span><br></pre></td></tr></table></figure>
<p>&#x91CD;&#x65B0;&#x6253;&#x5305;&#x7CFB;&#x7EDF;&#x955C;&#x50CF;</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">make snod</span></span><br></pre></td></tr></table></figure>
<h2 id="emulator&#x542F;&#x52A8;&#x53C2;&#x6570;"><a href="#emulator&#x542F;&#x52A8;&#x53C2;&#x6570;" class="headerlink" title="emulator&#x542F;&#x52A8;&#x53C2;&#x6570;"></a>emulator&#x542F;&#x52A8;&#x53C2;&#x6570;</h2><p>-memory <strong>size</strong><br>-cache-size <strong>size</strong></p>
<p><a href="https://developer.android.com/studio/run/emulator-commandline?hl=zh-cn" target="_blank" rel="noopener">https://developer.android.com/studio/run/emulator-commandline?hl=zh-cn</a></p>
<p>&#x771F;&#x6B63;&#x4F7F;&#x7528;&#x7684;&#x547D;&#x4EE4;</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">out/host/linux-x86/bin/emulator -sysdir out/target/product/generic/ -system out/target/product/generic/system.img -ramdisk out/target/product/generic/ramdisk.img -data out/target/product/generic/userdata.img -kernel /home/hzh/oldhome/learn/goldfish/arch/arm/boot/zImage -scale 1.0 -memory 512 -partition-size 1024</span><br></pre></td></tr></table></figure>
<h2 id="&#x5173;&#x95ED;ubuntu&#x8282;&#x80FD;&#x6A21;&#x5F0F;"><a href="#&#x5173;&#x95ED;ubuntu&#x8282;&#x80FD;&#x6A21;&#x5F0F;" class="headerlink" title="&#x5173;&#x95ED;ubuntu&#x8282;&#x80FD;&#x6A21;&#x5F0F;"></a>&#x5173;&#x95ED;ubuntu&#x8282;&#x80FD;&#x6A21;&#x5F0F;</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pm-powersave false</span><br></pre></td></tr></table></figure>
<h1 id="4&#x3001;REFERRENCE"><a href="#4&#x3001;REFERRENCE" class="headerlink" title="4&#x3001;REFERRENCE"></a>4&#x3001;REFERRENCE</h1><p><a href="https://www.jianshu.com/p/367f0886e62b" target="_blank" rel="noopener">https://www.jianshu.com/p/367f0886e62b</a></p>
<p><a href="http://eternalsakura13.com/2018/02/24/bianyi/" target="_blank" rel="noopener">http://eternalsakura13.com/2018/02/24/bianyi/</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/12/17/2019-12-17 ubuntu16.04 处理wifi问题小记/">ubuntu16.04 处理wifi问题小记</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-12-17</time><div class="content"><p>&#x5728;&#x5B9E;&#x4F53;&#x673A;&#x4E0A;&#x5B89;&#x88C5;ubuntu&#x540E;&#xFF0C;&#x51FA;&#x73B0;&#x4E86;&#x4E24;&#x4E2A;&#x95EE;&#x9898;&#xFF0C;&#x4E00;&#x4E2A;&#x662F;ubuntu&#x5B89;&#x88C5;&#x540E;&#x6CA1;&#x6709;&#x652F;&#x6301;&#x7B14;&#x8BB0;&#x672C;&#x7F51;&#x5361;&#x7684;&#x9A71;&#x52A8;&#xFF0C;&#x901A;&#x8FC7;&#x5347;&#x7EA7;&#x5185;&#x6838;&#x89E3;&#x51B3;&#x4E86;&#xFF1B;&#x53E6;&#x4E00;&#x4E2A;&#x662F;&#x7F51;&#x5361;&#x9A71;&#x52A8;&#x5B89;&#x88C5;&#x6210;&#x529F;&#x540E;&#xFF0C;&#x603B;&#x662F;&#x65E0;&#x7F18;&#x65E0;&#x6545;&#x6389;&#x7EBF;&#xFF0C;&#x901A;&#x8FC7;&#x5173;&#x95ED;wifi&#x7684;&#x7535;&#x6E90;&#x7BA1;&#x7406;&#x89E3;&#x51B3;&#x4E86;&#xFF1B;&#x671F;&#x95F4;&#x8FD8;&#x5378;&#x8F7D;&#x4E86;&#x4E00;&#x6B21;&#x53CC;&#x7CFB;&#x7EDF;&#x4E2D;&#x7684;ubuntu&#x2026;&#x5728;&#x6B64;&#x8BB0;&#x5F55;&#x4E00;&#x4E0B;&#x6298;&#x817E;&#x7684;&#x5185;&#x5BB9;&#xFF0C;&#x65B9;&#x4FBF;&#x4EE5;&#x540E;&#x67E5;&#x770B;&#x3002;</p>
<h1 id="&#x4E00;&#x3001;&#x5B89;&#x88C5;&#x7F51;&#x5361;&#x9A71;&#x52A8;"><a href="#&#x4E00;&#x3001;&#x5B89;&#x88C5;&#x7F51;&#x5361;&#x9A71;&#x52A8;" class="headerlink" title="&#x4E00;&#x3001;&#x5B89;&#x88C5;&#x7F51;&#x5361;&#x9A71;&#x52A8;"></a>&#x4E00;&#x3001;&#x5B89;&#x88C5;&#x7F51;&#x5361;&#x9A71;&#x52A8;</h1><p>&#x88C5;&#x4E86;ubuntu16.04&#x7684;&#x53CC;&#x7CFB;&#x7EDF;&#xFF0C;&#x4F46;&#x662F;&#x6CA1;&#x6709;&#x7F51;&#x5361;&#x9A71;&#x52A8;&#xFF0C;&#x7F51;&#x5361;&#x578B;&#x53F7;&#x4E3A;realtek 8822be&#xFF0C;&#x7F51;&#x4E0A;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;&#x65B9;&#x6CD5;&#x5C31;&#x662F;&#x5347;&#x7EA7;linux&#x5185;&#x6838;&#xFF0C;4.14&#x7684;&#x5185;&#x6838;&#x5F00;&#x59CB;&#x652F;&#x6301;&#x8BE5;&#x7F51;&#x5361;&#xFF0C;&#x4E2D;&#x95F4;&#x6709;&#x4E2A;&#x4E9B;&#x5751;&#xFF0C;&#x8BB0;&#x5F55;&#x4E00;&#x4E0B;</p>
<p>&#x4E0B;&#x8F7D;linux&#x5185;&#x6838;&#x6587;&#x4EF6;&#xFF0C;&#x624B;&#x52A8;&#x5B89;&#x88C5;&#xFF1A;<a href="http://kernel.ubuntu.com/~kernel-ppa/mainline/" target="_blank" rel="noopener">http://kernel.ubuntu.com/~kernel-ppa/mainline/</a></p>
<p>&#x4F46;&#x662F;&#x627E;&#x4E0D;&#x5230;4.14.0&#x7684;&#x7248;&#x672C;&#xFF0C;&#x5C31;&#x4E0B;&#x8F7D;&#x4E86;4.14.1&#xFF0C;&#x4EE5;&#x4E3A;&#x6CA1;&#x6709;&#x5F71;&#x54CD;&#xFF0C;&#x4F46;&#x662F;&#x5B89;&#x88C5;&#x540E;&#xFF0C;&#x53D1;&#x73B0;&#x65E0;&#x7EBF;&#x7F51;&#x8FD8;&#x662F;&#x4E0D;&#x80FD;&#x4F7F;&#x7528;&#xFF0C;&#x6240;&#x4EE5;&#x901A;&#x8FC7;&#x522B;&#x4EBA;&#x7684;&#x6587;&#x4EF6;&#x540D;&#xFF0C;&#x62FC;&#x51FA;&#x6765;&#x4E86;&#x4E0B;&#x8F7D;&#x94FE;&#x63A5;&#xFF0C;&#x4E0B;&#x8F7D;&#x4E86;4.14.0&#x7684;</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span>//kernel.ubuntu.com/~kernel-ppa/mainline/v4<span class="meta">.14</span>/linux-headers-<span class="number">4.14</span><span class="meta">.0</span>-<span class="number">041400_4.14</span><span class="meta">.0</span>-<span class="number">041400.</span>201711122031_all.deb</span><br><span class="line"> </span><br><span class="line"><span class="symbol">http:</span>//kernel.ubuntu.com/~kernel-ppa/mainline/v4<span class="meta">.14</span>/linux-headers-<span class="number">4.14</span><span class="meta">.0</span>-<span class="number">041400</span>-generic_4<span class="meta">.14</span><span class="meta">.0</span>-<span class="number">041400.</span>201711122031_amd64.deb</span><br><span class="line"> </span><br><span class="line"><span class="symbol">http:</span>//kernel.ubuntu.com/~kernel-ppa/mainline/v4<span class="meta">.14</span>/linux-image-<span class="number">4.14</span><span class="meta">.0</span>-<span class="number">041400</span>-generic_4<span class="meta">.14</span><span class="meta">.0</span>-<span class="number">041400.</span>201711122031_amd64.deb</span><br></pre></td></tr></table></figure>
<p>&#x5B89;&#x88C5;&#xFF1A;</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">sudo</span> dpkg -i <span class="regexp">*.deb</span></span><br></pre></td></tr></table></figure>
<p>&#x91CD;&#x542F;&#x540E;&#x8FD8;&#x662F;&#x4E0D;&#x80FD;&#x4F7F;&#x7528;</p>
<p>&#x7136;&#x540E;&#x53BB;/lib/firmware/rtlwifi&#xFF0C;&#x53D1;&#x73B0;&#x6CA1;&#x6709;rtl8822be&#x7684;&#x9A71;&#x52A8;&#x6587;&#x4EF6;</p>
<p>&#x4E0B;&#x8F7D;rtl8822be&#x7684;&#x9A71;&#x52A8;&#x6587;&#x4EF6;&#xFF1A;<br><a href="https://raw.githubusercontent.com/wkennington/linux-firmware/master/rtlwifi/rtl8822befw.bin" target="_blank" rel="noopener">https://raw.githubusercontent.com/wkennington/linux-firmware/master/rtlwifi/rtl8822befw.bin</a></p>
<p>&#x79FB;&#x52A8;&#x5230;/lib/firmware/rtlwifi&#x76EE;&#x5F55;&#x4E0B;&#xFF0C;&#x91CD;&#x542F;&#x540E;&#x5C31;&#x53EF;&#x4EE5;&#x6B63;&#x5E38;&#x4F7F;&#x7528;&#x4E86;</p>
<h1 id="&#x4E8C;&#x3001;&#x5173;&#x95ED;wifi&#x7684;&#x7535;&#x6E90;&#x7BA1;&#x7406;"><a href="#&#x4E8C;&#x3001;&#x5173;&#x95ED;wifi&#x7684;&#x7535;&#x6E90;&#x7BA1;&#x7406;" class="headerlink" title="&#x4E8C;&#x3001;&#x5173;&#x95ED;wifi&#x7684;&#x7535;&#x6E90;&#x7BA1;&#x7406;"></a>&#x4E8C;&#x3001;&#x5173;&#x95ED;wifi&#x7684;&#x7535;&#x6E90;&#x7BA1;&#x7406;</h1><p>wifi&#x65F6;&#x4E0D;&#x65F6;&#x4F1A;&#x65AD;&#x5F00;&#xFF0C;&#x5173;&#x95ED;power management&#x89E3;&#x51B3;</p>
<p>&#x4E00;&#x6B21;&#x6027;&#x624B;&#x52A8;&#x89E3;&#x51B3;&#xFF1A;</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iwconfig wlp5s0 power off</span><br></pre></td></tr></table></figure>
<p>&#x6C38;&#x4E45;&#x89E3;&#x51B3;&#xFF1A;</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/NetworkManager/conf.d/default-wifi-powersave-on.conf</span><br></pre></td></tr></table></figure>
<p>&#x5C06;wifi.powersave = 3&#x4FEE;&#x6539;&#x4E3A;wifi.powersave = 2<br>&#x6570;&#x503C;&#x89E3;&#x91CA;&#xFF1A;</p>
<figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">NM_SETTING_WIRELESS_POWERSAVE_DEFAULT (0)</span>: use the default value</span><br><span class="line"><span class="attribute">NM_SETTING_WIRELESS_POWERSAVE_IGNORE (1)</span>: don&apos;t touch existing setting</span><br><span class="line"><span class="attribute">NM_SETTING_WIRELESS_POWERSAVE_DISABLE (2)</span>: disable powersave</span><br><span class="line"><span class="attribute">NM_SETTING_WIRELESS_POWERSAVE_ENABLE (3)</span>: enable powersave</span><br></pre></td></tr></table></figure>
<h1 id="&#x4E09;&#x3001;&#x5378;&#x8F7D;&#x53CC;&#x7CFB;&#x7EDF;"><a href="#&#x4E09;&#x3001;&#x5378;&#x8F7D;&#x53CC;&#x7CFB;&#x7EDF;" class="headerlink" title="&#x4E09;&#x3001;&#x5378;&#x8F7D;&#x53CC;&#x7CFB;&#x7EDF;"></a>&#x4E09;&#x3001;&#x5378;&#x8F7D;&#x53CC;&#x7CFB;&#x7EDF;</h1><p>&#x901A;&#x8FC7;&#x7ED9;windows EFI&#x542F;&#x52A8;&#x5206;&#x533A;&#x5206;&#x914D;&#x76D8;&#x7B26;&#xFF0C;&#x5220;&#x9664;&#x5176;&#x4E2D;&#x7684;ubuntu&#x5F15;&#x5BFC;&#xFF0C;&#x5177;&#x4F53;&#x64CD;&#x4F5C;&#x5982;&#x4E0B;&#xFF1A;</p>
<p>&#x4EE5;&#x7BA1;&#x7406;&#x5458;&#x8EAB;&#x4EFD;&#x6253;&#x5F00;cmd&#xFF0C;&#x8F93;&#x5165;diskpart</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">list disk						;&#x67E5;&#x770B;&#x78C1;&#x76D8;</span><br><span class="line"><span class="keyword">select</span> disk <span class="number">1</span></span><br><span class="line"><span class="keyword">list</span> <span class="keyword">partition</span>			;&#x67E5;&#x770B;&#x5206;&#x533A;</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">partition</span> <span class="number">1</span>	;&#x542F;&#x52A8;&#x5206;&#x533A;&#x4E00;&#x822C;&#x4E3A;200&#x591A;M</span><br><span class="line">assign letter=F</span><br></pre></td></tr></table></figure>
<p>cd&#x8FDB;&#x53BB;&#xFF0C;&#x5220;&#x9664;/EFI/ubuntu&#x6587;&#x4EF6;&#x5939;</p>
<figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">remove letter=F	;&#x5220;&#x9664;&#x539F;&#x5148;&#x5206;&#x914D;&#x7684;&#x76D8;&#x7B26;</span></span><br></pre></td></tr></table></figure>
<p>&#x7136;&#x540E;&#x5728;&#x78C1;&#x76D8;&#x7BA1;&#x7406;&#xFF0C;&#x5220;&#x9664;ubuntu&#x7684;&#x786C;&#x76D8;</p>
<p>&#x5907;&#x6CE8;&#xFF1A;pppop&#x8FDE;&#x63A5;&#x547D;&#x4EE4;&#xFF1A;</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo pppoeconf</span><br><span class="line">sudo pon dsl-provider</span><br><span class="line">sudo poff</span><br></pre></td></tr></table></figure></div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/12/15/FUPK源码阅读/">FUPK源码阅读</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-12-15</time><div class="content"><h2 id="1&#x3001;&#x83B7;&#x5F97;&#x5B8C;&#x6574;&#x7684;DEX"><a href="#1&#x3001;&#x83B7;&#x5F97;&#x5B8C;&#x6574;&#x7684;DEX" class="headerlink" title="1&#x3001;&#x83B7;&#x5F97;&#x5B8C;&#x6574;&#x7684;DEX"></a>1&#x3001;&#x83B7;&#x5F97;&#x5B8C;&#x6574;&#x7684;DEX</h2><p>&#x5728;<strong>frameworks/base/core/java/android/app/ActivityThread.java</strong>&#x7684;<strong>handleBindApplication</strong>&#x5904;&#x63D2;&#x6869;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> {</span><br><span class="line">    UpkConfig config = <span class="keyword">new</span> UpkConfig();</span><br><span class="line">    <span class="keyword">if</span> (config.load() &amp;&amp; config.mTargetPackage.equals(data.info.getPackageName())) {</span><br><span class="line">        Fupk upk = <span class="keyword">new</span> Fupk(config.mTargetPackage);</span><br><span class="line">        upk.unpackAfter(<span class="number">10000</span>);</span><br><span class="line">    }</span><br><span class="line">} <span class="keyword">catch</span> (Throwable t) {</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x521B;&#x5EFA;Fupk&#x7684;&#x5B9E;&#x4F8B;&#xFF0C;&#x521B;&#x5EFA;&#x5B9E;&#x4F8B;&#x8FC7;&#x7A0B;&#x52A0;&#x8F7D;so&#x6587;&#x4EF6;&#xFF0C;&#x7136;&#x540E;&#x8C03;&#x7528;&#x5176;<strong>unpackAfter</strong>&#x51FD;&#x6570;&#xFF0C;&#x5176;&#x4E2D;&#x8C03;&#x7528;<strong>unpackNow</strong>&#x521D;&#x59CB;&#x5316;&#x5176;&#x7C7B;&#x53D8;&#x91CF;appLoader&#xFF0C;&#x6700;&#x540E;&#x8C03;&#x7528;native&#x51FD;&#x6570;<strong>core_Fupk::unpackAll</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String hookSo = <span class="string">&quot;/data/local/tmp/libFupk3.so&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> {</span><br><span class="line">  System.load(Global.hookSo);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x8BE5;so&#x6587;&#x4EF6;&#x5B58;&#x5728;JNI_OnLoad&#x51FD;&#x6570;&#xFF0C;&#x5728;app/src/main/cpp/main.cpp&#x4E2D;&#xFF0C;&#x4E3B;&#x8981;&#x505A;&#x4E86;&#x4E24;&#x90E8;&#x5206;&#x5185;&#x5BB9;&#xFF1A;1&#x3001;&#x52A8;&#x6001;&#x6CE8;&#x518C;native&#x51FD;&#x6570;<strong>core_Fupk::unpackAll</strong>&#xFF1B;2&#x3001;&#x901A;&#x8FC7;dlopen&#x3001;dlsym&#x51FD;&#x6570;&#x83B7;&#x5F97;libdvm.so&#x4E2D;&#x7684;&#x63A5;&#x53E3;&#xFF08;&#x51FD;&#x6570;&#x6307;&#x9488;&#xFF09;</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">core_Fupk::registerNativeMethod(env)</span><br></pre></td></tr></table></figure>
<p>&#x56DE;&#x5230;<strong>core_Fupk::unpackAll</strong>&#xFF0C;&#x8BE5;&#x51FD;&#x6570;&#x9996;&#x5148;&#x5C06;dump&#x65B9;&#x6CD5;&#x7684;&#x51FD;&#x6570;&#x7ED1;&#x5B9A;&#x5230;app/src/main/cpp/DexHelper/DexDumper.cpp&#x4E2D;&#x7684;fupk_ExportMethod&#x4E2D;</p>
<p>&#x7136;&#x540E;&#x8C03;&#x7528;&#x4E86;app/src/main/cpp/DexHelper/Fupk.cpp&#x4E2D;&#x7684;&#x5BF9;&#x8C61;&#x7684;unpackAll&#x65B9;&#x6CD5;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> ::core_Fupk::unpackAll(JNIEnv *env, jobject obj, jstring folder) {</span><br><span class="line">    <span class="class"><span class="keyword">interface</span>-&gt;<span class="title">ExportMethod</span> </span>= fupk_ExportMethod;</span><br><span class="line">    <span class="function">Fupk <span class="title">upk</span><span class="params">(env, sFolder, obj)</span></span>;</span><br><span class="line">    upk.unpackAll();</span><br></pre></td></tr></table></figure>
<p>&#x5728;&#x5B9E;&#x4F8B;&#x5316;Fupk&#x5BF9;&#x8C61;&#x65F6;&#xFF0C;&#x901A;&#x8FC7;&#x81EA;&#x5B9A;&#x4E49;&#x63A5;&#x53E3;<code>dlsym(libdvm, &quot;dvmGetUserDexFiles&quot;);</code>&#x83B7;&#x5F97;gDvm.userDexFiles&#x8FD4;&#x56DE;&#x7684;HashTable&#xFF0C;&#x4ECE;&#x4E2D;&#x63D0;&#x53D6;DvmDex&#x4FE1;&#x606F;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> dvmDex = mCookie.getCookieAt(i, name, mIgnoreCase);</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">DvmDex</span> {</span></span><br><span class="line">    <span class="comment">/* pointer to the DexFile we&apos;re associated with */</span></span><br><span class="line">    DexFile*            pDexFile;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* clone of pDexFile-&gt;pHeader (it&apos;s used frequently enough) */</span></span><br><span class="line">    <span class="keyword">const</span> DexHeader*    pHeader;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* interned strings; parallel to &quot;stringIds&quot; */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">StringObject</span>** <span class="title">pResStrings</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* resolved classes; parallel to &quot;typeIds&quot; */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ClassObject</span>** <span class="title">pResClasses</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* resolved methods; parallel to &quot;methodIds&quot; */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Method</span>**     <span class="title">pResMethods</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* resolved instance fields; parallel to &quot;fieldIds&quot; */</span></span><br><span class="line">    <span class="comment">/* (this holds both InstField and StaticField) */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Field</span>**      <span class="title">pResFields</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* interface method lookup cache */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">AtomicCache</span>* <span class="title">pInterfaceCache</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* shared memory region with file contents */</span></span><br><span class="line">    <span class="keyword">bool</span>                isMappedReadOnly;</span><br><span class="line">    MemMapping          memMap;</span><br><span class="line"></span><br><span class="line">    jobject dex_object;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* lock ensuring mutual exclusion during updates */</span></span><br><span class="line">    <span class="keyword">pthread_mutex_t</span>     modLock; <span class="comment">// TODO import</span></span><br><span class="line">};</span><br></pre></td></tr></table></figure>
<p>&#x8FD9;&#x6837;&#x5C31;&#x83B7;&#x5F97;&#x4E86;&#x5185;&#x5B58;&#x4E2D;&#x5B8C;&#x6574;&#x7684;Dex&#xFF0C;&#x4E0B;&#x9762;&#x5F00;&#x59CB;&#x4E3B;&#x52A8;&#x8C03;&#x7528;&#x65B9;&#x6CD5;</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DexDumper <span class="title">dumper</span><span class="params">(mEnv, dvmDex, mUpkObj)</span></span>;</span><br><span class="line">dumper.rebuild();<span class="comment">//dump&#x65B9;&#x6CD5;&#x4F53;@cs</span></span><br></pre></td></tr></table></figure>
<p>&#x8FD9;&#x4E2A;<strong>mUpkObj</strong>&#x662F;&#x5185;&#x6838;&#x4E2D;Fupk&#x7684;&#x5B9E;&#x4F8B;&#xFF0C;&#x521B;&#x5EFA;DexDumper&#x5B9E;&#x4F8B;&#x540E;&#xFF0C;&#x5F00;&#x59CB;&#x4E3B;&#x52A8;&#x8C03;&#x7528;&#x5176;&#x65B9;&#x6CD5;</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//app/src/main/cpp/DexHelper/DexDumper.cpp</span></span><br><span class="line"><span class="keyword">bool</span> DexDumper::rebuild() {</span><br><span class="line">  jclass upkClazz = mEnv-&gt;GetObjectClass(mUpkObj);</span><br><span class="line">  <span class="keyword">auto</span> loaderObject = JniInfo::GetObjectField(mEnv, mUpkObj, <span class="string">&quot;appLoader&quot;</span>, <span class="string">&quot;Ljava/lang/ClassLoader;&quot;</span>);</span><br><span class="line">  <span class="keyword">auto</span> tryLoadClass_method = mEnv-&gt;GetMethodID(upkClazz, <span class="string">&quot;tryLoadClass&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)Ljava/lang/Class;&quot;</span>);</span><br></pre></td></tr></table></figure>
<h2 id="2&#x3001;&#x7C7B;&#x7684;&#x4E3B;&#x52A8;&#x52A0;&#x8F7D;"><a href="#2&#x3001;&#x7C7B;&#x7684;&#x4E3B;&#x52A8;&#x52A0;&#x8F7D;" class="headerlink" title="2&#x3001;&#x7C7B;&#x7684;&#x4E3B;&#x52A8;&#x52A0;&#x8F7D;"></a>2&#x3001;&#x7C7B;&#x7684;&#x4E3B;&#x52A8;&#x52A0;&#x8F7D;</h2><ol>
<li>&#x83B7;&#x5F97;&#x5185;&#x6838;Fupk&#x5B9E;&#x4F8B;&#x7684;Class</li>
<li>&#x83B7;&#x5F97;ClassLoader&#x5B9E;&#x4F8B;systemClassLoader</li>
<li>&#x83B7;&#x5F97;tryLoadClass&#x65B9;&#x6CD5;id</li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> jClazz = mEnv-&gt;CallObjectMethod(mUpkObj, tryLoadClass_method, jDotDescriptor);<span class="comment">//&#x901A;&#x8FC7;tryLoadClass&#x83B7;&#x53D6;&#x7C7B;&#x5BF9;&#x8C61;</span></span><br></pre></td></tr></table></figure>
<p>&#x53C2;&#x6570;jDotDescriptor&#x5373;&#x4E3A;&#x83B7;&#x5F97;&#x7684;&#x7C7B;&#x7B7E;&#x540D;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// I will load the class from java(the loader may has been replaced)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Class <span class="title">tryLoadClass</span><span class="params">(String className)</span> </span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="keyword">return</span> FRefInvoke.getClass(appLoader, className);</span><br><span class="line">    } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Class <span class="title">getClass</span><span class="params">(ClassLoader loader, String class_name)</span> <span class="keyword">throws</span> Exception</span>{</span><br><span class="line">    <span class="keyword">if</span> (loader != <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">return</span> loader.loadClass(class_name);<span class="comment">//&#x4E3B;&#x52A8;&#x52A0;&#x8F7D;@cs</span></span><br><span class="line">        } <span class="keyword">catch</span> (Exception e){</span><br><span class="line">            <span class="comment">// class not found from loader, used Class.forName instead</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> Class.forName(class_name);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x901A;&#x8FC7;tryLoadClass&#x51FD;&#x6570;&#xFF0C;&#x4F7F;&#x7528;systemClassLoader&#x53BB;&#x4E3B;&#x52A8;&#x52A0;&#x8F7D;&#x8FD9;&#x4E2A;&#x7C7B;</p>
<h2 id="3&#x3001;&#x4E3B;&#x52A8;&#x8C03;&#x7528;&#x65B9;&#x6CD5;&#xFF0C;dump&#x65B9;&#x6CD5;&#x4F53;"><a href="#3&#x3001;&#x4E3B;&#x52A8;&#x8C03;&#x7528;&#x65B9;&#x6CD5;&#xFF0C;dump&#x65B9;&#x6CD5;&#x4F53;" class="headerlink" title="3&#x3001;&#x4E3B;&#x52A8;&#x8C03;&#x7528;&#x65B9;&#x6CD5;&#xFF0C;dump&#x65B9;&#x6CD5;&#x4F53;"></a>3&#x3001;&#x4E3B;&#x52A8;&#x8C03;&#x7528;&#x65B9;&#x6CD5;&#xFF0C;dump&#x65B9;&#x6CD5;&#x4F53;</h2><p>&#x56DE;&#x5230;native&#x5C42;</p>
<p>&#x540E;&#x9762;&#x901A;&#x8FC7;DexDumper::fixMethodByDvm&#x4E3B;&#x52A8;&#x8C03;&#x7528;&#x65B9;&#x6CD5;</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> DexDumper::fixMethodByDvm(DexSharedData &amp;shared, DexMethod *dexMethod,</span><br><span class="line">                               ClassDefBuilder* builder, u4 &amp;lastIndex) {</span><br><span class="line">    lastIndex = lastIndex + dexMethod-&gt;methodIdx;</span><br><span class="line">    <span class="keyword">auto</span> m = builder-&gt;getMethodMap(lastIndex);</span><br><span class="line"></span><br><span class="line">    assert(m != <span class="literal">nullptr</span> &amp;&amp; <span class="string">&quot;Unable to fix MethodBy Dvm, this should happened&quot;</span>);</span><br><span class="line"></span><br><span class="line">    shared.mCurMethod = dexMethod;</span><br><span class="line">    FupkImpl::fupkInvokeMethod(m);<span class="comment">//&#x8C03;&#x7528;&#x65B9;&#x6CD5;@cs</span></span><br><span class="line">    shared.mCurMethod = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>FupkImpl::fupkInvokeMethod(m)</strong>&#x5373;&#x4E3A;</p>
<p><strong>app/src/main/cpp/DexHelper/DexDumper.cpp</strong>&#x4E2D;&#x7684;<strong>fupk_ExportMethod</strong>&#x65B9;&#x6CD5;</p>
<p>&#x8BE5;&#x65B9;&#x6CD5;&#x63D2;&#x6869;&#x5230;&#x4E86;&#x5185;&#x6838;&#x4E2D;&#x7684;invoke&#x51FD;&#x6570;&#x4E2D;</p>
<p>&#x5728;fupk_ExportMethod&#x4E2D;&#xFF0C;&#x5C06;&#x65B9;&#x6CD5;&#x6307;&#x9488;&#x4FDD;&#x5B58;&#x5728;&#x4E86;shared&#x53D8;&#x91CF;&#x4E2D;</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shared-&gt;extra.append((<span class="keyword">char</span>*)item, code_item_len);<span class="comment">//&#x4FDD;&#x5B58;&#x65B9;&#x6CD5;&#x4F53;@cs</span></span><br></pre></td></tr></table></figure>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/12/14/2019-12-14 Android-6.0.0_r1源码分析-Java层加载Dex和类的过程/">Android-6.0.0_r1源码分析-Java层加载Dex和类的过程</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-12-14</time><div class="content"><h1 id="PROLOGUE"><a href="#PROLOGUE" class="headerlink" title="PROLOGUE"></a>PROLOGUE</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Dynamic dynamic;</span><br><span class="line"></span><br><span class="line">DexClassLoader dexClassLoader = <span class="keyword">new</span> DexClassLoader(dexPath,optimizedDirectory, libraryPath, getClassLoader());</span><br><span class="line">Class Clazz = dexClassLoader.loadClass(<span class="string">&quot;com.example.myapplication.Dynamic&quot;</span>);</span><br><span class="line">dynamic = (Dynamic) Clazz.newInstance(); </span><br><span class="line"></span><br><span class="line">dynamic.sayHello();</span><br><span class="line">&#x6216;</span><br><span class="line">Method m = Clazz.getDeclaredMethod(<span class="string">&quot;sayHello&quot;</span>);</span><br><span class="line">m.invoke();</span><br></pre></td></tr></table></figure>
<p>&#x5728;android&#x4E2D;&#xFF0C;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x4E0A;&#x9762;&#x4E24;&#x884C;&#x4EE3;&#x7801;&#x52A8;&#x6001;&#x52A0;&#x8F7D;dex&#x6587;&#x4EF6;&#xFF0C;&#x5E76;&#x52A0;&#x8F7D;&#x5176;&#x4E2D;&#x7684;&#x7C7B;&#xFF0C;&#x8C03;&#x7528;&#x7C7B;&#x4E2D;&#x7684;&#x65B9;&#x6CD5;&#x3002;&#x8BB0;&#x5F55;&#x4E00;&#x4E0B;&#x52A8;&#x6001;&#x52A0;&#x8F7D;Dex&#x548C;&#x7C7B;&#x7684;&#x8FC7;&#x7A0B;&#x3002;</p>
<p>&#x52A8;&#x6001;&#x52A0;&#x8F7D;&#x7684;&#x57FA;&#x7840;&#x662F;ClassLoader&#x2014;&#x7C7B;&#x52A0;&#x8F7D;&#x5668;&#xFF0C;ClassLoader &#x5C31;&#x662F;&#x4E13;&#x95E8;&#x7528;&#x6765;&#x5904;&#x7406;&#x7C7B;&#x52A0;&#x8F7D;&#x5DE5;&#x4F5C;&#x7684;&#xFF0C;&#x4E00;&#x4E2A;&#x8FD0;&#x884C;&#x4E2D;&#x7684; APP &#x4E0D;&#x4EC5;&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x7C7B;&#x52A0;&#x8F7D;&#x5668;&#x3002;</p>
<p>&#x5728; Java &#x4E2D;&#xFF0C;&#x53EA;&#x6709;&#x5F53;&#x4E24;&#x4E2A;&#x5B9E;&#x4F8B;&#x7684;&#x7C7B;&#x540D;&#x3001;&#x5305;&#x540D;&#x4EE5;&#x53CA;&#x52A0;&#x8F7D;&#x5176;&#x7684; ClassLoader &#x90FD;&#x76F8;&#x540C;&#xFF0C;&#x624D;&#x4F1A;&#x88AB;&#x8BA4;&#x4E3A;&#x662F;&#x540C;&#x4E00;&#x79CD;&#x7C7B;&#x578B;</p>
<h1 id="&#x4E00;&#x3001;&#x521B;&#x5EFA;&#x7C7B;&#x52A0;&#x8F7D;&#x5668;&#x7684;&#x8FC7;&#x7A0B;"><a href="#&#x4E00;&#x3001;&#x521B;&#x5EFA;&#x7C7B;&#x52A0;&#x8F7D;&#x5668;&#x7684;&#x8FC7;&#x7A0B;" class="headerlink" title="&#x4E00;&#x3001;&#x521B;&#x5EFA;&#x7C7B;&#x52A0;&#x8F7D;&#x5668;&#x7684;&#x8FC7;&#x7A0B;"></a>&#x4E00;&#x3001;&#x521B;&#x5EFA;&#x7C7B;&#x52A0;&#x8F7D;&#x5668;&#x7684;&#x8FC7;&#x7A0B;</h1><p>&#x5728;Android&#x4E2D;&#xFF0C;<strong>ClassLoader</strong>&#x662F;&#x4E00;&#x4E2A;&#x62BD;&#x8C61;&#x7C7B;&#xFF0C;&#x5B9A;&#x4E49;&#x4E3A;&#xFF1A;<code>public abstract class ClassLoader</code><br>&#x5728;&#x5B9E;&#x9645;&#x5F00;&#x53D1;&#x4E2D;&#xFF0C;&#x4E00;&#x822C;&#x4F7F;&#x7528;&#x5176;&#x5B50;&#x7C7B;<strong>DexClassLoader</strong>&#x548C;<strong>PathClassLoader</strong>&#x6765;&#x521B;&#x5EFA;&#x7C7B;&#x52A0;&#x8F7D;&#x5668;&#x5B9E;&#x4F8B;&#xFF0C;&#x8FDB;&#x800C;&#x52A0;&#x8F7D;&#x7C7B;&#xFF0C;&#x9700;&#x8981;&#x8BF4;&#x660E;&#x7684;&#x662F;&#xFF0C;&#x8FD9;&#x4E24;&#x4E2A;&#x7C7B;&#x90FD;&#x7EE7;&#x627F;&#x4E8E;<strong>BaseDexClassLoader</strong>&#xFF0C;<strong>BaseDexClassLoader</strong>&#x53C8;&#x7EE7;&#x627F;&#x4E8E;<strong>ClassLoader</strong>&#xFF0C;&#x4ED6;&#x4EEC;&#x4E4B;&#x95F4;&#x7684;&#x5173;&#x7CFB;&#x5982;&#x4E0B;&#xFF0C;&#x56FE;&#x7247;&#x6765;&#x81EA;gityuan</p>
<p><img src="/2019/12/14/2019-12-14 Android-6.0.0_r1&#x6E90;&#x7801;&#x5206;&#x6790;-Java&#x5C42;&#x52A0;&#x8F7D;Dex&#x548C;&#x7C7B;&#x7684;&#x8FC7;&#x7A0B;/2019-12-14 Android6-0-0&#x6E90;&#x7801;&#x5206;&#x6790;-&#x52A8;&#x6001;&#x52A0;&#x8F7D;DEX&#x548C;&#x7C7B;&#x8FC7;&#x7A0B;/classloader.jpg" alt="img"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DexClassLoader</span> <span class="keyword">extends</span> <span class="title">BaseDexClassLoader</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">PathClassLoader</span> <span class="keyword">extends</span> <span class="title">BaseDexClassLoader</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">BaseDexClassLoader</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span></span></span><br></pre></td></tr></table></figure>
<p>DexClassLoader&#x7C7B;&#x548C;PathClassLoader&#x7C7B;&#x7684;&#x533A;&#x522B;&#x5728;&#x4E0B;&#x9762;&#x5206;&#x6790;&#x7684;&#x65F6;&#x5019;&#x4F1A;&#x8BF4;</p>
<p>&#x9996;&#x5148;&#x770B;&#x4ED6;&#x8FD9;&#x4E24;&#x4E2A;&#x7C7B;&#x7684;&#x6784;&#x9020;&#x51FD;&#x6570;&#xFF1A;</p>
<p><strong>DexClassLoader</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/libcore/dalvik/src/main/java/dalvik/system/DexClassLoader.java</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DexClassLoader</span><span class="params">(String dexPath, String optimizedDirectory,</span></span></span><br><span class="line"><span class="function"><span class="params">        String libraryPath, ClassLoader parent)</span> </span>{</span><br><span class="line">  <span class="keyword">super</span>(dexPath, <span class="keyword">new</span> File(optimizedDirectory), libraryPath, parent);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>PathClassLoader</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PathClassLoader</span><span class="params">(String dexPath, ClassLoader parent)</span> </span>{</span><br><span class="line">  <span class="keyword">super</span>(dexPath, <span class="keyword">null</span>, <span class="keyword">null</span>, parent);</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PathClassLoader</span><span class="params">(String dexPath, String libraryPath,</span></span></span><br><span class="line"><span class="function"><span class="params">    ClassLoader parent)</span> </span>{</span><br><span class="line">  <span class="keyword">super</span>(dexPath, <span class="keyword">null</span>, libraryPath, parent);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x8FD9;&#x4E24;&#x4E2A;&#x7C7B;&#x7684;&#x6784;&#x9020;&#x51FD;&#x6570;&#x90FD;&#x76F4;&#x63A5;&#x4F7F;&#x7528;&#x4E86;&#x7236;&#x7C7B;&#x7684;&#x6784;&#x9020;&#x51FD;&#x6570;&#xFF0C;&#x4F46;&#x662F;&#x4F20;&#x53C2;&#x4E0D;&#x540C;&#xFF0C;DexClassLoader&#x8BBE;&#x7F6E;&#x4E86;optimizedDirectory&#xFF0C;&#x800C;PathClassLoader&#x8BE5;&#x53C2;&#x6570;&#x8BBE;&#x4E3A;null&#x3002;<br><strong>BaseDexClassLoader</strong>&#x6784;&#x9020;&#x51FD;&#x6570;&#xFF1A;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">BaseDexClassLoader</span><span class="params">(String dexPath, File optimizedDirectory,</span></span></span><br><span class="line"><span class="function"><span class="params">        String libraryPath, ClassLoader parent)</span> </span>{</span><br><span class="line">    <span class="keyword">super</span>(parent);</span><br><span class="line">    <span class="keyword">this</span>.pathList = <span class="keyword">new</span> DexPathList(<span class="keyword">this</span>, dexPath, libraryPath, optimizedDirectory);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x4F7F;&#x7528;super(parent)&#x521B;&#x5EFA;&#x4E86;&#x5BF9;&#x8C61;&#xFF0C;&#x7136;&#x540E;&#x4F7F;&#x7528;makePathElements&#x521B;&#x5EFA;&#x4E86;DexPathList&#x5BF9;&#x8C61;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">/libcore/dalvik/src/main/java/dalvik/system/DexPathList.java</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DexPathList</span><span class="params">(ClassLoader definingContext, String dexPath,</span></span></span><br><span class="line"><span class="function"><span class="params">        String libraryPath, File optimizedDirectory)</span> </span>{</span><br><span class="line">......</span><br><span class="line">    <span class="keyword">this</span>.definingContext = definingContext;</span><br><span class="line">    <span class="comment">// save dexPath for BaseDexClassLoader</span></span><br><span class="line">    <span class="keyword">this</span>.dexElements = makePathElements(splitDexPath(dexPath), optimizedDirectory,</span><br><span class="line">                                        suppressedExceptions);</span><br><span class="line">......</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Makes an array of dex/resource path elements, one per element of the given      array.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Element[] makePathElements(List&lt;File&gt; files, File optimizedDirectory,List&lt;IOException&gt; suppressedExceptions) {</span><br><span class="line">    List&lt;Element&gt; elements = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Open all files and load the (direct or contained) dex files up front.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">for</span> (File file : files) {</span><br><span class="line">        File zip = <span class="keyword">null</span>;</span><br><span class="line">        File dir = <span class="keyword">new</span> File(<span class="string">&quot;&quot;</span>);</span><br><span class="line">        DexFile dex = <span class="keyword">null</span>;</span><br><span class="line">        String path = file.getPath();</span><br><span class="line">        String name = file.getName();</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">				<span class="keyword">else</span> <span class="keyword">if</span> (file.isFile()) {</span><br><span class="line">            <span class="keyword">if</span> (name.endsWith(DEX_SUFFIX)) {</span><br><span class="line">                <span class="comment">// Raw dex file (not inside a zip/jar).</span></span><br><span class="line">              	dex = loadDexFile(file, optimizedDirectory);</span><br><span class="line">            }</span><br><span class="line">        }<span class="comment">//endif if (file.isFile())</span></span><br><span class="line">      </span><br><span class="line">        <span class="keyword">if</span> ((zip != <span class="keyword">null</span>) || (dex != <span class="keyword">null</span>)) {</span><br><span class="line">          elements.add(<span class="keyword">new</span> Element(dir, <span class="keyword">false</span>, zip, dex));</span><br><span class="line">				}</span><br><span class="line">    }<span class="comment">//endfor for (File file : files)</span></span><br><span class="line">    <span class="keyword">return</span> elements.toArray(<span class="keyword">new</span> Element[elements.size()]);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Constructs a {<span class="doctag">@code</span> DexFile} instance, as appropriate depending</span></span><br><span class="line"><span class="comment"> * on whether {<span class="doctag">@code</span> optimizedDirectory} is {<span class="doctag">@code</span> null}.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> DexFile <span class="title">loadDexFile</span><span class="params">(File file, File optimizedDirectory)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException </span>{</span><br><span class="line">    <span class="keyword">if</span> (optimizedDirectory == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DexFile(file);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        String optimizedPath = optimizedPathFor(file, optimizedDirectory);</span><br><span class="line">        <span class="keyword">return</span> DexFile.loadDex(file.getPath(), optimizedPath, <span class="number">0</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Converts a dex/jar file path and an output directory to an</span></span><br><span class="line"><span class="comment"> * output file path for an associated optimized dex file.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">optimizedPathFor</span><span class="params">(File path,</span></span></span><br><span class="line"><span class="function"><span class="params">        File optimizedDirectory)</span> </span>{</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Get the filename component of the path, and replace the</span></span><br><span class="line"><span class="comment">     * suffix with &quot;.dex&quot; if that&apos;s not already the suffix.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String fileName = path.getName();</span><br><span class="line">    <span class="keyword">if</span> (!fileName.endsWith(DEX_SUFFIX)) {</span><br><span class="line">        <span class="keyword">int</span> lastDot = fileName.lastIndexOf(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (lastDot &lt; <span class="number">0</span>) {</span><br><span class="line">            fileName += DEX_SUFFIX;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            StringBuilder sb = <span class="keyword">new</span> StringBuilder(lastDot + <span class="number">4</span>);</span><br><span class="line">            sb.append(fileName, <span class="number">0</span>, lastDot);</span><br><span class="line">            sb.append(DEX_SUFFIX);</span><br><span class="line">            fileName = sb.toString();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    File result = <span class="keyword">new</span> File(optimizedDirectory, fileName);</span><br><span class="line">    <span class="keyword">return</span> result.getPath();</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x4E0A;&#x9762;4&#x4E2A;&#x51FD;&#x6570;</p>
<p><strong>DexPathList</strong>&#x6784;&#x9020;&#x51FD;&#x6570;&#xFF0C;&#x5C06;&#x6574;&#x4E2A;dexPath&#x8DEF;&#x5F84;&#x5206;&#x6210;&#x5305;&#x542B;&#x591A;&#x4E2A;Dex&#x6587;&#x4EF6;&#x8DEF;&#x5F84;&#x7684;list&#x4F5C;&#x4E3A;&#x53C2;&#x6570;&#x4F20;&#x7ED9;&#x4E86;makePathElements&#x3002;</p>
<p><strong>makePathElements</strong>&#x6839;&#x636E;dex&#x7684;path&#xFF0C;&#x5C06;&#x6240;&#x6709;&#x7684;dex&#x90FD;&#x5C01;&#x88C5;&#x5728;&#x4E86;&#x6570;&#x7EC4;&#x4E2D;&#xFF0C;&#x7136;&#x540E;&#x8C03;&#x7528;loadDexFile&#x52A0;&#x8F7D;dex&#x6587;&#x4EF6;&#x3002;</p>
<p><strong>loadDexFile</strong>&#x521B;&#x5EFA;DexFile&#x5BF9;&#x8C61;&#x3002;&#x82E5;optimizedDirectory&#x4E0D;&#x4E3A;NULL&#xFF0C;&#x5C06;dex&#x6587;&#x4EF6;&#x751F;&#x6210;&#x5728;optimizedDirectory&#x8DEF;&#x5F84;&#x4E2D;&#xFF0C;&#x4F7F;&#x7528;DexFile&#x7C7B;&#x7684;loadDex&#x51FD;&#x6570;&#x521B;&#x5EFA;&#x5BF9;&#x8C61;&#xFF1B;&#x82E5;optimizedDirectory&#x4E3A;NULL&#xFF0C;&#x90A3;&#x4E48;&#x4F1A;&#x76F4;&#x63A5;&#x4F7F;&#x7528; dex &#x6587;&#x4EF6;&#x539F;&#x6709;&#x7684;&#x8DEF;&#x5F84;&#x6765;&#x521B;&#x5EFA; DexFile&#x5BF9;&#x8C61;&#x3002;</p>
<p><strong>optimizedPathFor</strong>&#x4E3B;&#x8981;&#x5904;&#x7406;&#x4E86;&#x6E90;&#x6587;&#x4EF6;&#x540E;&#x7F00;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x8BA9;&#x5176;&#x540E;&#x7F00;&#x4E3A;<code>.dex</code>&#x3002;&#x5F53;optimizedDirectory&#x4E0D;&#x4E3A;NULL&#x65F6;&#xFF0C;&#x5728;optimizedDirectory&#x76EE;&#x5F55;&#x521B;&#x5EFA;&#x65B0;&#x6587;&#x4EF6;&#xFF0C;&#x5E76;&#x5C06;&#x76EE;&#x5F55;&#x8FD4;&#x56DE;&#x3002;</p>
<p><strong>DexClassLoader&#x7C7B;&#x548C;PathClassLoader&#x7C7B;&#x7684;&#x533A;&#x522B;</strong></p>
<p>DexClassLoader&#x7C7B;&#x548C;PathClassLoader&#x7C7B;&#x7684;&#x533A;&#x522B;&#x4E3B;&#x8981;&#x5728;&#x4E8E;&#x6784;&#x9020;&#x5BF9;&#x8C61;&#x65F6;<strong>optimizedDirectory</strong>&#x662F;&#x5426;&#x4E3A;NULL&#x3002;</p>
<p>&#x7531;&#x4E8E;dex&#x6587;&#x4EF6;&#x88AB;&#x5305;&#x542B;&#x5728;APK&#x6216;&#x8005;Jar&#x6587;&#x4EF6;&#x4E2D;,&#x56E0;&#x6B64;&#x5728;&#x88C5;&#x8F7D;&#x76EE;&#x6807;&#x7C7B;&#x4E4B;&#x524D;&#x9700;&#x8981;&#x5148;&#x4ECE;APK&#x6216;Jar&#x6587;&#x4EF6;&#x4E2D;&#x89E3;&#x538B;&#x51FA;dex&#x6587;&#x4EF6;&#xFF0C;optimizedDirectory &#x5FC5;&#x987B;&#x662F;&#x4E00;&#x4E2A;&#x5185;&#x90E8;&#x5B58;&#x50A8;&#x8DEF;&#x5F84;&#xFF0C;<strong>optimizedDirectory</strong>&#x53C2;&#x6570;&#x5C31;&#x662F;&#x6307;&#x5B9A;&#x89E3;&#x538B;&#x51FA;&#x7684;dex&#x6587;&#x4EF6;&#x5B58;&#x653E;&#x7684;&#x8DEF;&#x5F84;&#xFF0C;PathClassLoader&#x7C7B;&#x6784;&#x9020;&#x5BF9;&#x8C61;&#x65F6;optimizedDirectory&#x53C2;&#x6570;&#x4E3A;&#x7A7A;&#xFF0C;&#x5219;&#x8BF4;&#x660E;&#x5176;&#x4E0D;&#x9700;&#x8981;&#x89E3;&#x538B;&#x63D0;&#x53D6;dex&#x6587;&#x4EF6;&#xFF0C;&#x6240;&#x4EE5;&#x5176;&#x76F4;&#x63A5;&#x52A0;&#x8F7D;&#x5185;&#x90E8;&#x7684;dex&#x6587;&#x4EF6;&#xFF1B;&#x800C;DexClassLoader&#x7C7B;&#x53EF;&#x4EE5;&#x6307;&#x5B9A;optimizedDirectory&#x53C2;&#x6570;&#xFF0C;&#x8BF4;&#x660E;&#x5176;&#x9700;&#x8981;&#x4ECE;&#x5916;&#x90E8;&#x89E3;&#x538B;&#x63D0;&#x53D6;dex&#x6587;&#x4EF6;&#x3002;&#x603B;&#x7ED3;&#x5982;&#x4E0B;&#xFF1A;</p>
<p><strong>DexClassLoader</strong>&#xFF1A;&#x80FD;&#x591F;&#x52A0;&#x8F7D;&#x672A;&#x5B89;&#x88C5;&#x7684;jar/apk/dex<br><strong>PathClassLoader</strong>&#xFF1A;&#x52A0;&#x8F7D;Android&#x7CFB;&#x7EDF;&#x7C7B;&#x548C;&#x7CFB;&#x7EDF;&#x4E2D;&#x5E94;&#x7528;&#x7684;&#x7C7B;</p>
<p>&#x56DE;&#x5230;makePathElements&#x51FD;&#x6570;&#xFF0C;&#x5C06;DexFile&#x5BF9;&#x8C61;&#x548C;&#x8DEF;&#x5F84;&#x7B49;&#x4FE1;&#x606F;&#x5C01;&#x88C5;&#x6210;&#x4E86;&#x6570;&#x7EC4;&#x8FD4;&#x56DE;&#x7ED9;&#x4E86;DexPathList&#x6784;&#x9020;&#x51FD;&#x6570;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">    elements.add(<span class="keyword">new</span> Element(dir, <span class="keyword">false</span>, zip, dex));</span><br><span class="line"><span class="keyword">return</span> elements.toArray(<span class="keyword">new</span> Element[elements.size()]);</span><br></pre></td></tr></table></figure>
<p>&#x7136;&#x540E;&#x5728;BaseDexClassLoader&#x51FD;&#x6570;&#x4E2D;&#x901A;&#x8FC7;DexPathList&#x7C7B;&#x7684;&#x5B9E;&#x4F8B;&#x5BF9;&#x8C61;<strong>pathList</strong>&#x4FDD;&#x5B58;&#x4E86;&#x8FD9;&#x4E9B;<strong>DexFile</strong>&#x5BF9;&#x8C61;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> DexPathList pathList;</span><br></pre></td></tr></table></figure>
<h1 id="&#x4E8C;&#x3001;&#x52A0;&#x8F7D;&#x7C7B;&#x7684;&#x8FC7;&#x7A0B;"><a href="#&#x4E8C;&#x3001;&#x52A0;&#x8F7D;&#x7C7B;&#x7684;&#x8FC7;&#x7A0B;" class="headerlink" title="&#x4E8C;&#x3001;&#x52A0;&#x8F7D;&#x7C7B;&#x7684;&#x8FC7;&#x7A0B;"></a>&#x4E8C;&#x3001;&#x52A0;&#x8F7D;&#x7C7B;&#x7684;&#x8FC7;&#x7A0B;</h1><p>JVM &#x4E2D; ClassLoader &#x901A;&#x8FC7; defineClass &#x65B9;&#x6CD5;&#x52A0;&#x8F7D; jar &#x91CC;&#x9762;&#x7684; Class&#xFF0C;&#x800C; Android &#x4E2D;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x88AB;&#x5F03;&#x7528;&#x4E86;&#x3002;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> Class&lt;?&gt; defineClass(<span class="keyword">byte</span>[] classRep, <span class="keyword">int</span> offset, <span class="keyword">int</span> length)</span><br><span class="line">        <span class="keyword">throws</span> ClassFormatError {</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">&quot;can&apos;t load this type of class file&quot;</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x53D6;&#x4EE3;&#x7684;&#x662F;loadClass&#x65B9;&#x6CD5;&#x3002;&#x7B2C;&#x4E00;&#x8282;&#x4E2D;&#x901A;&#x8FC7;&#x5B9E;&#x4F8B;&#x5316;&#x7C7B;&#x52A0;&#x8F7D;&#x5668;ClassLoader&#xFF0C;&#x521B;&#x5EFA;&#x4E86;DexFile&#x5BF9;&#x8C61;&#xFF0C;&#x5E76;&#x628A;&#x5BF9;&#x8C61;&#x4FDD;&#x5B58;&#x5728;&#x4E86;<strong>pathList</strong>&#x5B9E;&#x4F8B;&#x5BF9;&#x8C61;&#x4E2D;&#x3002;&#x5728;Android&#x4E2D;&#xFF0C;&#x4F7F;&#x7528;loadClass&#x65B9;&#x6CD5;&#x52A0;&#x8F7D;&#x4E00;&#x4E2A;&#x7C7B;&#xFF0C;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x5B9A;&#x4E49;&#x5728;ClassLoader&#x7C7B;&#x4E2D;&#xFF0C;&#x5176;&#x6D3E;&#x751F;&#x7C7B;&#x6CA1;&#x6709;&#x91CD;&#x5199;&#x8BE5;&#x65B9;&#x6CD5;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">/libcore/libart/src/main/java/java/lang/ClassLoader.java</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Loads the class with the specified name. Invoking this method is</span></span><br><span class="line"><span class="comment">* equivalent to calling {<span class="doctag">@code</span> loadClass(className, false)}.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> Class&lt;?&gt; loadClass(String className) <span class="keyword">throws</span> ClassNotFoundException {</span><br><span class="line">    <span class="keyword">return</span> loadClass(className, <span class="keyword">false</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Loads the class with the specified name, optionally linking it after</span></span><br><span class="line"><span class="comment"> * loading.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; loadClass(String className, <span class="keyword">boolean</span> resolve) <span class="keyword">throws</span> ClassNotFoundException {</span><br><span class="line">    Class&lt;?&gt; clazz = findLoadedClass(className);</span><br><span class="line">    <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) {</span><br><span class="line">        ClassNotFoundException suppressed = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            clazz = parent.loadClass(className, <span class="keyword">false</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (ClassNotFoundException e) {</span><br><span class="line">            suppressed = e;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                clazz = findClass(className);</span><br><span class="line">            } <span class="keyword">catch</span> (ClassNotFoundException e) {</span><br><span class="line">                e.addSuppressed(suppressed);</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> clazz;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>ClassLoader &#x53CC;&#x4EB2;&#x59D4;&#x6D3E;&#x6A21;&#x578B;&#x52A0;&#x8F7D;&#x7C7B;&#x7684;&#x8FC7;&#x7A0B;</strong></p>
<p>&#x4E0A;&#x9762;&#x7B2C;&#x4E8C;&#x4E2A;loadClass&#x65B9;&#x6CD5;&#x4F7F;&#x7528;&#x4E86;&#x53CC;&#x4EB2;&#x59D4;&#x6D3E;&#x6A21;&#x578B;&#xFF0C;loadClass&#x5728;&#x52A0;&#x8F7D;&#x4E00;&#x4E2A;&#x7C7B;&#x65F6;</p>
<p>1&#x3001;&#x5224;&#x65AD;&#x5F53;&#x524D;&#x7684;&#x7C7B;&#x52A0;&#x8F7D;&#x5668;ClassLoader&#x662F;&#x5426;&#x52A0;&#x8F7D;&#x8FC7;&#x6B64;&#x7C7B;&#xFF0C;&#x6709;&#x5C31;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;<br>2&#x3001;&#x82E5;&#x672A;&#x52A0;&#x8F7D;&#x8FC7;&#x5F53;&#x524D;&#x7C7B;&#xFF0C;&#x5C31;&#x53BB;&#x67E5;&#x8BE2;Parent&#x662F;&#x5426;&#x52A0;&#x8F7D;&#x8FC7;&#x6B64;&#x7C7B;<br>3&#x3001;&#x5982;&#x679C;&#x7EE7;&#x627F;&#x8DEF;&#x7EBF;&#x4E0A;&#x7684;ClassLoader&#x90FD;&#x6CA1;&#x6709;&#x52A0;&#x8F7D;&#xFF0C;&#x5219;&#x8C03;&#x7528;findClass&#x53BB;&#x52A0;&#x8F7D;&#x8FD9;&#x4E2A;&#x7C7B;<br>&#x5373;&#x5982;&#x679C;&#x4E00;&#x4E2A;&#x7C7B;&#x88AB;&#x4F4D;&#x4E8E;&#x6811;&#x6839;&#x7684;ClassLoader&#x52A0;&#x8F7D;&#x8FC7;&#xFF0C;&#x90A3;&#x4E48;&#x8FD9;&#x4E2A;&#x7C7B;&#x5728;&#x4E00;&#x4E2A;&#x865A;&#x62DF;&#x673A;&#x7684;&#x8FD0;&#x884C;&#x5468;&#x671F;&#x5185;&#x6C38;&#x8FDC;&#x4E0D;&#x4F1A;&#x88AB;&#x91CD;&#x65B0;&#x52A0;&#x8F7D;&#x3002;</p>
<p><strong>&#x4F5C;&#x7528;</strong></p>
<p><strong>&#x4E00;&#x4E2A;Class&#x7684;&#x6807;&#x8BC6;&#x4E3A;&#x5305;&#x540D;PackageName+&#x7C7B;&#x540D;ClassName+&#x7C7B;&#x52A0;&#x8F7D;&#x5668;ClassLoader</strong></p>
<p>&#x9996;&#x5148;&#x662F;&#x5171;&#x4EAB;&#x529F;&#x80FD;&#xFF0C;&#x4E00;&#x4E9B; Framework &#x5C42;&#x7EA7;&#x7684;&#x7C7B;&#x4E00;&#x65E6;&#x88AB;&#x9876;&#x5C42;&#x7684; ClassLoader &#x52A0;&#x8F7D;&#x8FC7;&#x5C31;&#x7F13;&#x5B58;&#x5728;&#x5185;&#x5B58;&#x91CC;&#x9762;&#xFF0C;&#x4EE5;&#x540E;&#x4EFB;&#x4F55;&#x5730;&#x65B9;&#x7528;&#x5230;&#x90FD;&#x4E0D;&#x9700;&#x8981;&#x91CD;&#x65B0;&#x52A0;&#x8F7D;&#x3002;</p>
<p>&#x9664;&#x6B64;&#x4E4B;&#x5916;&#x8FD8;&#x6709;&#x9694;&#x79BB;&#x529F;&#x80FD;&#xFF0C;&#x4E0D;&#x540C;&#x7EE7;&#x627F;&#x8DEF;&#x7EBF;&#x4E0A;&#x7684; ClassLoader &#x52A0;&#x8F7D;&#x7684;&#x7C7B;&#x80AF;&#x5B9A;&#x4E0D;&#x662F;&#x540C;&#x4E00;&#x4E2A;&#x7C7B;&#xFF0C;&#x8FD9;&#x6837;&#x7684;&#x9650;&#x5236;&#x907F;&#x514D;&#x4E86;&#x7528;&#x6237;&#x81EA;&#x5DF1;&#x7684;&#x4EE3;&#x7801;&#x5192;&#x5145;&#x6838;&#x5FC3;&#x7C7B;&#x5E93;&#x7684;&#x7C7B;&#x8BBF;&#x95EE;&#x6838;&#x5FC3;&#x7C7B;&#x5E93;&#x5305;&#x53EF;&#x89C1;&#x6210;&#x5458;&#x7684;&#x60C5;&#x51B5;&#x3002;&#x8FD9;&#x4E5F;&#x597D;&#x7406;&#x89E3;&#xFF0C;&#x4E00;&#x4E9B;&#x7CFB;&#x7EDF;&#x5C42;&#x7EA7;&#x7684;&#x7C7B;&#x4F1A;&#x5728;&#x7CFB;&#x7EDF;&#x521D;&#x59CB;&#x5316;&#x7684;&#x65F6;&#x5019;&#x88AB;&#x52A0;&#x8F7D;&#xFF0C;&#x6BD4;&#x5982; java.lang.String&#xFF0C;&#x5982;&#x679C;&#x5728;&#x4E00;&#x4E2A;&#x5E94;&#x7528;&#x91CC;&#x9762;&#x80FD;&#x591F;&#x7B80;&#x5355;&#x5730;&#x7528;&#x81EA;&#x5B9A;&#x4E49;&#x7684; String &#x7C7B;&#x628A;&#x8FD9;&#x4E2A;&#x7CFB;&#x7EDF;&#x7684; String &#x7C7B;&#x7ED9;&#x66FF;&#x6362;&#x6389;&#xFF0C;&#x90A3;&#x5C06;&#x4F1A;&#x6709;&#x4E25;&#x91CD;&#x7684;&#x5B89;&#x5168;&#x95EE;&#x9898;&#x3002;</p>
<p>loadClass&#x65B9;&#x6CD5;&#x8C03;&#x7528;&#x4E86;findClass&#x65B9;&#x6CD5;&#xFF0C;ClassLoader&#x7C7B;&#x7684;findClass&#x65B9;&#x6CD5;&#x4F1A;&#x62A5;&#x5F02;&#x5E38;&#xFF0C;&#x800C;BaseDexClassLoader &#x91CD;&#x8F7D;&#x4E86;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">/libcore/dalvik/src/main/java/dalvik/system/BaseDexClassLoader.java</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException {</span><br><span class="line">    List&lt;Throwable&gt; suppressedExceptions = <span class="keyword">new</span> ArrayList&lt;Throwable&gt;();</span><br><span class="line">    Class c = pathList.findClass(name, suppressedExceptions);</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="keyword">null</span>) {</span><br><span class="line">        ClassNotFoundException cnfe = <span class="keyword">new</span> ClassNotFoundException(<span class="string">&quot;Didn&apos;t find class \&quot;&quot;</span> + name + <span class="string">&quot;\&quot; on path: &quot;</span> + pathList);</span><br><span class="line">        <span class="keyword">for</span> (Throwable t : suppressedExceptions) {</span><br><span class="line">            cnfe.addSuppressed(t);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">throw</span> cnfe;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x4E0A;&#x9762;&#x5728;&#x521B;&#x5EFA;&#x7C7B;&#x6784;&#x9020;&#x5668;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x5DF2;&#x7ECF;&#x521B;&#x5EFA;&#x597D;&#x4E86;&#x6240;&#x6709;&#x7684;DexFile&#x5BF9;&#x8C61;&#xFF0C;&#x5E76;&#x5C01;&#x88C5;&#x5728;&#x4E86;BaseDexClassLoader&#x7C7B;&#x4E2D;&#x7684;&#x4E00;&#x4E2A;&#x5B9E;&#x4F8B;&#x5BF9;&#x8C61;<strong>pathList</strong>&#x4E2D;&#xFF1A;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> DexPathList pathList;</span><br></pre></td></tr></table></figure>
<p>BaseDexClassLoader&#x7684;findClass&#x65B9;&#x6CD5;&#x76F4;&#x63A5;&#x8C03;&#x7528;&#x4E86;DexPathList&#x7C7B;&#x7684;findClass&#x65B9;&#x6CD5;&#xFF1A;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">/libcore/dalvik/src/main/java/dalvik/system/DexPathList.java</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Finds the named class in one of the dex files pointed at by</span></span><br><span class="line"><span class="comment">* this instance. This will find the one in the earliest listed</span></span><br><span class="line"><span class="comment">* path element. If the class is found but has not yet been</span></span><br><span class="line"><span class="comment">* defined, then this method will define it in the defining</span></span><br><span class="line"><span class="comment">* context that this instance was constructed with.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Class <span class="title">findClass</span><span class="params">(String name, List&lt;Throwable&gt; suppressed)</span> </span>{</span><br><span class="line">  <span class="keyword">for</span> (Element element : dexElements) {</span><br><span class="line">      DexFile dex = element.dexFile;</span><br><span class="line">      <span class="keyword">if</span> (dex != <span class="keyword">null</span>) {</span><br><span class="line">          Class clazz = dex.loadClassBinaryName(name, definingContext, suppressed);</span><br><span class="line">          <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) {</span><br><span class="line">              <span class="keyword">return</span> clazz;</span><br><span class="line">          }</span><br><span class="line">      }</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span> (dexElementsSuppressedExceptions != <span class="keyword">null</span>) {</span><br><span class="line">      suppressed.addAll(Arrays.asList(dexElementsSuppressedExceptions));</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x5728;DexPathList&#x7C7B;&#x7684;findClass&#x65B9;&#x6CD5;&#x4E2D;&#xFF0C;&#x904D;&#x5386;&#x5176;dexElements&#x53D8;&#x91CF;&#x4E2D;&#x4FDD;&#x5B58;&#x7684;DexFile&#x5BF9;&#x8C61;&#xFF0C;&#x8FD9;&#x4E2A;dexElements&#x53D8;&#x91CF;&#x5728;DexPathList&#x7C7B;&#x7684;&#x6784;&#x65B9;&#x6CD5;&#x4E2D;&#x88AB;&#x521D;&#x59CB;&#x5316;&#xFF0C;&#x7531;<strong>makePathElements</strong>&#x65B9;&#x6CD5;&#x751F;&#x6210;&#xFF0C;&#x4FDD;&#x5B58;&#x4E86;DexFile&#x5BF9;&#x8C61;&#x3002;</p>
<p>&#x7136;&#x540E;&#x63A5;&#x7740;&#x8C03;&#x7528;&#x4E86;DexFile&#x5BF9;&#x8C61;&#x7684;<strong>loadClassBinaryName</strong>&#x65B9;&#x6CD5;&#xFF0C;&#x6211;&#x4EEC;&#x627E;&#x5230;DexFile&#x7C7B;&#x7684;&#x8BE5;&#x65B9;&#x6CD5;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">/libcore/dalvik/src/main/java/dalvik/system/DexFile.java</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Class <span class="title">loadClassBinaryName</span><span class="params">(String name, ClassLoader loader, List&lt;Throwable&gt; suppressed)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> defineClass(name, loader, mCookie, suppressed);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Class <span class="title">defineClass</span><span class="params">(String name, ClassLoader loader, Object cookie,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 List&lt;Throwable&gt; suppressed)</span> </span>{</span><br><span class="line">    Class result = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        result = defineClassNative(name, loader, cookie);</span><br><span class="line">    } <span class="keyword">catch</span> (NoClassDefFoundError e) {</span><br><span class="line">        <span class="keyword">if</span> (suppressed != <span class="keyword">null</span>) {</span><br><span class="line">            suppressed.add(e);</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">catch</span> (ClassNotFoundException e) {</span><br><span class="line">        <span class="keyword">if</span> (suppressed != <span class="keyword">null</span>) {</span><br><span class="line">            suppressed.add(e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>loadClassBinaryName</strong>&#x65B9;&#x6CD5;&#x662F;&#x5BF9;&#x540C;&#x7C7B;&#x4E0B;<strong>defineClass</strong>&#x65B9;&#x6CD5;&#x7684;&#x5C01;&#x88C5;&#xFF0C;&#x5728;<strong>defineClass</strong>&#x65B9;&#x6CD5;&#x5185;&#xFF0C;&#x53C8;&#x8C03;&#x7528;&#x4E86;native&#x5C42;&#x7684;<strong>defineClassNative</strong>&#x65B9;&#x6CD5;</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">/art/runtime/native/dalvik_system_DexFile.cc</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> jclass <span class="title">DexFile_defineClassNative</span><span class="params">(JNIEnv* env, jclass, jstring javaName, jobject javaLoader,jobject cookie)</span> </span>{</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">const</span> DexFile*&gt;&gt; dex_files = ConvertJavaArrayToNative(env, cookie);</span><br><span class="line">  <span class="function">ScopedUtfChars <span class="title">class_name</span><span class="params">(env, javaName)</span></span>;</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">  const std::string descriptor(DotToDescriptor(class_name.c_str()));</span><br><span class="line">  const size_t hash(ComputeModifiedUtf8Hash(descriptor.c_str()));</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; dex_file : *dex_files) {</span><br><span class="line">    <span class="keyword">const</span> DexFile::ClassDef* dex_class_def = dex_file-&gt;FindClassDef(descriptor.c_str(), hash);</span><br><span class="line">    <span class="keyword">if</span> (dex_class_def != <span class="literal">nullptr</span>) {</span><br><span class="line">      <span class="function">ScopedObjectAccess <span class="title">soa</span><span class="params">(env)</span></span>;</span><br><span class="line">      ClassLinker* class_linker = Runtime::Current()-&gt;GetClassLinker();</span><br><span class="line">      class_linker-&gt;RegisterDexFile(*dex_file);</span><br><span class="line">      StackHandleScope&lt;<span class="number">1</span>&gt; hs(soa.Self());</span><br><span class="line">      Handle&lt;mirror::ClassLoader&gt; class_loader(</span><br><span class="line">          hs.NewHandle(soa.Decode&lt;mirror::ClassLoader*&gt;(javaLoader)));</span><br><span class="line">      mirror::Class* result = class_linker-&gt;DefineClass(soa.Self(), descriptor.c_str(), hash,class_loader, *dex_file, *dex_class_def);</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x5728;<strong>DexFile_defineClassNative</strong>&#x65B9;&#x6CD5;&#x4E2D;&#x3002;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x901A;&#x8FC7;&#x8C03;&#x7528;Runtime&#x7C7B;&#x7684;&#x9759;&#x6001;&#x6210;&#x5458;&#x51FD;&#x6570;Current&#x83B7;&#x5F97;&#x4E86;Runtime&#x5355;&#x4F8B;&#xFF0C;&#x5728;ART&#x865A;&#x62DF;&#x673A;&#x8FDB;&#x7A0B;&#x4E2D;&#xFF0C;&#x5B58;&#x5728;&#x7740;&#x4E00;&#x4E2A;Runtime&#x5355;&#x4F8B;&#xFF0C;&#x7528;&#x6765;&#x63CF;&#x8FF0;ART&#x8FD0;&#x884C;&#x65F6;&#x3002;&#x83B7;&#x5F97;&#x4E86;&#x8FD9;&#x4E2A;&#x5355;&#x4F8B;&#x4E4B;&#x540E;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x8C03;&#x7528;&#x5B83;&#x7684;&#x6210;&#x5458;&#x51FD;&#x6570;GetClassLinker&#x6765;&#x83B7;&#x5F97;&#x4E00;&#x4E2A;ClassLinker&#x5BF9;&#x8C61;&#x3002;ClassLinker&#x5BF9;&#x8C61;&#x662F;&#x5728;&#x521B;&#x5EFA;ART&#x865A;&#x62DF;&#x673A;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#x521B;&#x5EFA;&#x7684;&#xFF0C;&#x7528;&#x6765;&#x52A0;&#x8F7D;&#x7C7B;&#x4EE5;&#x53CA;&#x94FE;&#x63A5;&#x7C7B;&#x65B9;&#x6CD5;&#x3002;&#x7136;&#x540E;&#x8C03;&#x7528;&#x4E86;class_linker&#x7684;DefineClass&#x6765;&#x83B7;&#x5F97;class&#x5BF9;&#x8C61;&#x5E76;&#x8FD4;&#x56DE;&#xFF0C;&#x81F3;&#x6B64;&#x7C7B;&#x52A0;&#x8F7D;&#x5C31;&#x5B8C;&#x6210;&#x4E86;&#x3002;</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/12/09/NDK开发学习记录/">NDK开发学习记录</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-12-09</time><div class="content"><p>&#x8BB0;&#x5F55;&#x5F0F;&#x5B66;&#x4E60;&#xFF0C;&#x5185;&#x5BB9;&#x53EF;&#x80FD;&#x4E0D;&#x5168;&#xFF0C;&#x7528;&#x5230;&#x77E5;&#x8BC6;&#x5C31;&#x4F1A;&#x8BB0;&#x5F55;&#x4E0B;&#x6765;&#xFF0C;&#x65B9;&#x4FBF;&#x4E4B;&#x540E;&#x7684;&#x67E5;&#x9605;&#x548C;&#x590D;&#x4E60;&#x3002;</p>
<p>JNIEnv&#x7684;&#x6307;&#x9488;&#x4F1A;&#x88AB;JNI&#x4F20;&#x5165;&#x5230;&#x672C;&#x5730;&#x65B9;&#x6CD5;&#x7684;&#x5B9E;&#x73B0;&#x51FD;&#x6570;&#x4E2D;&#x6765;&#x5BF9;Java&#x7AEF;&#x7684;&#x4EE3;&#x7801;&#x8FDB;&#x884C;&#x64CD;&#x4F5C;&#x3002;</p>
<h1 id="&#x4E00;&#x3001;Native&#x51FD;&#x6570;&#x7684;&#x6CE8;&#x518C;"><a href="#&#x4E00;&#x3001;Native&#x51FD;&#x6570;&#x7684;&#x6CE8;&#x518C;" class="headerlink" title="&#x4E00;&#x3001;Native&#x51FD;&#x6570;&#x7684;&#x6CE8;&#x518C;"></a>&#x4E00;&#x3001;Native&#x51FD;&#x6570;&#x7684;&#x6CE8;&#x518C;</h1><p>&#x6CE8;&#x518C;native&#x51FD;&#x6570;&#x7684;&#x5177;&#x4F53;&#x65B9;&#x6CD5;&#x4E0D;&#x540C;&#xFF0C;&#x4F1A;&#x5BFC;&#x81F4;&#x7CFB;&#x7EDF;&#x5728;&#x8FD0;&#x884C;&#x65F6;&#x91C7;&#x7528;&#x4E0D;&#x540C;&#x7684;&#x65B9;&#x5F0F;&#x6765;&#x5BFB;&#x627E;&#x8FD9;&#x4E9B;native&#x65B9;&#x6CD5;&#x3002;</p>
<h2 id="1&#x3001;Native&#x51FD;&#x6570;&#x9759;&#x6001;&#x6CE8;&#x518C;"><a href="#1&#x3001;Native&#x51FD;&#x6570;&#x9759;&#x6001;&#x6CE8;&#x518C;" class="headerlink" title="1&#x3001;Native&#x51FD;&#x6570;&#x9759;&#x6001;&#x6CE8;&#x518C;"></a>1&#x3001;Native&#x51FD;&#x6570;&#x9759;&#x6001;&#x6CE8;&#x518C;</h2><p>&#x9759;&#x6001;&#x6CE8;&#x518C;&#x5C31;&#x662F;&#x6839;&#x636E;&#x51FD;&#x6570;&#x540D;&#x6765;&#x904D;&#x5386;Java&#x548C;JNI&#x51FD;&#x6570;&#x4E4B;&#x95F4;&#x7684;&#x5173;&#x8054;&#xFF0C;&#x800C;&#x4E14;&#x8981;&#x6C42;JNI&#x5C42;&#x51FD;&#x6570;&#x7684;&#x540D;&#x5B57;&#x5FC5;&#x987B;&#x9075;&#x5FAA;&#x7279;&#x5B9A;&#x7684;&#x683C;&#x5F0F;&#x3002;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x5728;java&#x5C42;&#x7684;<span class="keyword">native</span>&#x65B9;&#x6CD5;&#x58F0;&#x660E;&#xFF1A;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">modifyBytecode</span><span class="params">()</span></span>;</span><br><span class="line">javah&#x751F;&#x6210;&#x5934;&#x6587;&#x4EF6;&#xFF1A;</span><br><span class="line">javah cn.pollux.modifydalvikbytecode.MainActivity</span><br></pre></td></tr></table></figure>
<p>&#x5728;&#x5934;&#x6587;&#x4EF6;&#x5185;&#x4F1A;&#x6709;native&#x5C42;&#x7684;&#x65B9;&#x6CD5;&#x58F0;&#x660E;</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">JNIEXPORT jint JNICALL Java_cn_pollux_modifydalvikbytecode_MainActivity_modifyBytecode</span><br><span class="line">  (JNIEnv *, jclass);</span><br></pre></td></tr></table></figure>
<p><strong>JNIEXPORT</strong>&#xFF1A;&#x8BF4;&#x660E;&#x8BE5;&#x51FD;&#x6570;&#x65F6;&#x5BFC;&#x51FA;&#x51FD;&#x6570;&#xFF0C;&#x5728;java&#x5C42;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x8C03;&#x7528;<br><strong>JNICALL</strong>&#xFF1A;</p>
<p>&#x603B;&#x7ED3;&#x9759;&#x6001;&#x6CE8;&#x518C;&#x7684;&#x6D41;&#x7A0B;&#xFF1A;<br>1&#x3001;&#x7F16;&#x5199;&#x5305;&#x542B;native&#x65B9;&#x6CD5;&#x7684;Java&#x7C7B;<br>2&#x3001;&#x4F7F;&#x7528;Javah&#x547D;&#x4EE4;&#x751F;&#x6210;.h&#x5934;&#x6587;&#x4EF6;<br>3&#x3001;&#x7F16;&#x5199;&#x4EE3;&#x7801;&#x5B9E;&#x73B0;&#x5934;&#x6587;&#x4EF6;&#x4E2D;&#x7684;&#x65B9;&#x6CD5;</p>
<h2 id="2&#x3001;Native&#x51FD;&#x6570;&#x52A8;&#x6001;&#x6CE8;&#x518C;"><a href="#2&#x3001;Native&#x51FD;&#x6570;&#x52A8;&#x6001;&#x6CE8;&#x518C;" class="headerlink" title="2&#x3001;Native&#x51FD;&#x6570;&#x52A8;&#x6001;&#x6CE8;&#x518C;"></a>2&#x3001;Native&#x51FD;&#x6570;&#x52A8;&#x6001;&#x6CE8;&#x518C;</h2><p>&#x52A8;&#x6001;&#x6CE8;&#x518C;&#xFF0C;&#x5373;&#x901A;&#x8FC7;RegisterNatives&#x65B9;&#x6CD5;&#x628A;C/C++&#x4E2D;&#x7684;&#x65B9;&#x6CD5;&#x6620;&#x5C04;&#x5230;Java&#x4E2D;&#x7684;native&#x65B9;&#x6CD5;&#x58F0;&#x660E;&#x3002;</p>
<p>&#x5F53;&#x7528;System.loadLibarary()&#x65B9;&#x6CD5;&#x52A0;&#x8F7D;so&#x5E93;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x865A;&#x62DF;&#x673A;&#x4F1A;&#x9996;&#x5148;&#x8C03;&#x7528;JNI_OnLoad&#x51FD;&#x6570;&#xFF0C;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x7684;&#x4F5C;&#x7528;&#x662F;&#x544A;&#x8BC9;&#x865A;&#x62DF;&#x673A;&#x6B64;C&#x5E93;&#x4F7F;&#x7528;&#x7684;&#x662F;&#x54EA;&#x4E00;&#x4E2A;JNI&#x7248;&#x672C;&#xFF0C;&#x9ED8;&#x8BA4;&#x6700;&#x521D;&#x7684;JNI 1.1&#x7248;&#x672C;&#x3002;&#x6240;&#x4EE5;&#x53EF;&#x4EE5;&#x5728;JNI_OnLoad&#x51FD;&#x6570;&#x4E2D;&#xFF0C;&#x6CE8;&#x518C;JNI&#x51FD;&#x6570;&#x3002;</p>
<p>&#x5728;Java&#x5C42;&#x58F0;&#x660E;&#x4E00;&#x4E2A;native&#x51FD;&#x6570;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">testJava</span><span class="params">(String str)</span></span>;</span><br></pre></td></tr></table></figure>
<p>&#x5728;native&#x5C42;&#x7684;JNI_OnLoad&#x51FD;&#x6570;&#x4E2D;&#x5C06;Java&#x5C42;&#x7684;<strong>testJava</strong>&#x51FD;&#x6570;&#x4E0E;Native&#x5C42;&#x7684;<strong>testNative</strong>&#x51FD;&#x6570;&#x7ED1;&#x5B9A;</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">jint <span class="title">JNI_OnLoad</span><span class="params">(JavaVM* vm, <span class="keyword">void</span>* reserved)</span></span>{</span><br><span class="line">  JNIEnv* env = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">if</span> (vm-&gt;GetEnv((<span class="keyword">void</span> **) &amp;env, JNI_VERSION_1_6) != JNI_OK) {</span><br><span class="line">      LOGE(<span class="string">&quot;This jni version is not supported&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> JNI_VERSION_1_6;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span> (!registerNativeMethod(env)) {</span><br><span class="line">    LOGE(<span class="string">&quot;Unable to register native method: maybe the java has not loaded&quot;</span>);</span><br><span class="line">    <span class="comment">// I don&apos;t want the process crash, just continue</span></span><br><span class="line">    env-&gt;ExceptionClear();</span><br><span class="line">	}</span><br><span class="line">  <span class="keyword">return</span> JNI_VERSION_1_6;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x901A;&#x8FC7;GetEnv&#x51FD;&#x6570;&#x83B7;&#x53D6;JNIEnv&#x7ED3;&#x6784;&#x4F53;&#x6307;&#x9488;&#xFF0C;JNIEnv&#x7ED3;&#x6784;&#x4F53;&#x6307;&#x5411;&#x4E86;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x8868;&#xFF0C;&#x8BE5;&#x51FD;&#x6570;&#x8868;&#x6307;&#x5411;&#x4E86;&#x5BF9;&#x5E94;&#x7684;JNI&#x51FD;&#x6570;&#xFF0C;&#x6211;&#x4EEC;&#x901A;&#x8FC7;&#x8FD9;&#x4E9B;JNI&#x51FD;&#x6570;&#x5B9E;&#x73B0;JNI&#x7F16;&#x7A0B;&#xFF0C;&#x6BD4;&#x5982;&#x5728;jni.h&#x4E2D;</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">JNINativeInterface</span>* <span class="title">JNIEnv</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">JNINativeInterface</span> {</span></span><br><span class="line">......</span><br><span class="line">    jclass      (*FindClass)(JNIEnv*, <span class="keyword">const</span> <span class="keyword">char</span>*);</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p>JNIEnv&#x662F;&#x6307;&#x5411;JNINativeInterface&#x7ED3;&#x6784;&#x4F53;&#x7684;&#x6307;&#x9488;&#xFF0C;env&#x662F;&#x6307;&#x5411;JNIEnv&#x53D8;&#x91CF;&#x7684;&#x6307;&#x9488;&#xFF0C;&#x6240;&#x4EE5;env&#x662F;&#x6307;&#x5411;JNINativeInterface&#x7ED3;&#x6784;&#x4F53;&#x6307;&#x9488;&#x7684;&#x6307;&#x9488;&#x3002;</p>
<p>&#x5728;&#x770B;&#x4E0B;registerNativeMethod&#x51FD;&#x6570;&#x5185;&#x5BB9;</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">registerNativeMethod</span><span class="params">(JNIEnv *env)</span></span>{</span><br><span class="line">	<span class="keyword">auto</span> clazz = env-&gt;FindClass(<span class="string">&quot;com/pollux/jnil/JNIDemo&quot;</span>);</span><br><span class="line">	JNINativeMethod natives[] = {</span><br><span class="line">    {<span class="string">&quot;testJava&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)V&quot;</span>, (<span class="keyword">void</span>*)testNative}</span><br><span class="line">  };</span><br><span class="line">	<span class="keyword">if</span> (env-&gt;RegisterNatives(clazz, natives,</span><br><span class="line">                           <span class="keyword">sizeof</span>(natives)/<span class="keyword">sizeof</span>(JNINativeMethod))!= JNI_OK) {</span><br><span class="line">		env-&gt;ExceptionClear();</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x88AB;&#x52A8;&#x6001;&#x6CE8;&#x518C;&#x7684;&#x51FD;&#x6570;</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testNative</span><span class="params">(JNIEnv *env, jobject, jlong handle)</span> </span>{</span><br><span class="line">    LOGI(<span class="string">&quot;JNI&quot;</span>, <span class="string">&quot;dynamic register&quot;</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>RegisterNatives</strong>&#x7B2C;&#x4E8C;&#x4E2A;&#x53C2;&#x6570;&#x4E3A;JNINativeMethod&#x7C7B;&#x578B;&#x7684;&#x6570;&#x7EC4;&#xFF0C;JNI&#x5141;&#x8BB8;&#x901A;&#x8FC7;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x6620;&#x5C04;&#x8868;&#xFF0C;&#x6CE8;&#x518C;&#x7ED9;JVM&#xFF0C;JVM&#x901A;&#x8FC7;&#x51FD;&#x6570;&#x6620;&#x5C04;&#x8868;&#x6765;&#x67E5;&#x627E;&#x8C03;&#x7528;&#x76F8;&#x5E94;&#x7684;&#x51FD;&#x6570;&#x3002;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x6620;&#x5C04;&#x8868;&#x5C31;&#x662F;<strong>RegisterNatives</strong>&#x6570;&#x7EC4;&#xFF0C;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> {</span> </span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* name;	<span class="comment">//Java&#x5C42;&#x51FD;&#x6570;&#x540D;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* signature;	<span class="comment">//Java&#x5C42;&#x51FD;&#x6570;&#x7B7E;&#x540D;</span></span><br><span class="line">    <span class="keyword">void</span>* fnPtr;	<span class="comment">//Native&#x5C42;&#x51FD;&#x6570;&#x540D;&#xFF08;&#x51FD;&#x6570;&#x6307;&#x9488;&#xFF09; </span></span><br><span class="line">} JNINativeMethod;</span><br></pre></td></tr></table></figure>
<p>&#x56E0;&#x4E3A;Java&#x652F;&#x6301;&#x91CD;&#x8F7D;&#xFF0C;&#x6240;&#x4EE5;&#x9700;&#x8981;&#x51FD;&#x6570;&#x7B7E;&#x540D;&#x6307;&#x5B9A;&#x53C2;&#x6570;&#x4E0E;&#x8FD4;&#x56DE;&#x503C;&#x3002;</p>
<p>&#x603B;&#x7ED3;&#xFF1A;</p>
<p>1&#x3001;&#x5728;Java&#x5C42;&#x58F0;&#x660E;&#x4E00;&#x4E2A;&#x51FD;&#x6570;<br>2&#x3001;&#x5728;Native&#x5C42;&#x7684;JNI_Onload&#x51FD;&#x6570;&#x4E2D;&#x6CE8;&#x518C;&#x51FD;&#x6570;</p>
<h1 id="&#x4E8C;&#x3001;-Java&#x5C42;&#x8C03;&#x7528;Native&#x5C42;&#x65B9;&#x6CD5;"><a href="#&#x4E8C;&#x3001;-Java&#x5C42;&#x8C03;&#x7528;Native&#x5C42;&#x65B9;&#x6CD5;" class="headerlink" title="&#x4E8C;&#x3001; Java&#x5C42;&#x8C03;&#x7528;Native&#x5C42;&#x65B9;&#x6CD5;"></a>&#x4E8C;&#x3001; Java&#x5C42;&#x8C03;&#x7528;Native&#x5C42;&#x65B9;&#x6CD5;</h1><h1 id="&#x4E09;&#x3001;Native&#x5C42;&#x8C03;&#x7528;Java&#x5C42;&#x4EE3;&#x7801;"><a href="#&#x4E09;&#x3001;Native&#x5C42;&#x8C03;&#x7528;Java&#x5C42;&#x4EE3;&#x7801;" class="headerlink" title="&#x4E09;&#x3001;Native&#x5C42;&#x8C03;&#x7528;Java&#x5C42;&#x4EE3;&#x7801;"></a>&#x4E09;&#x3001;Native&#x5C42;&#x8C03;&#x7528;Java&#x5C42;&#x4EE3;&#x7801;</h1><h2 id="1&#x3001;&#x83B7;&#x53D6;jclass"><a href="#1&#x3001;&#x83B7;&#x53D6;jclass" class="headerlink" title="1&#x3001;&#x83B7;&#x53D6;jclass"></a>1&#x3001;&#x83B7;&#x53D6;jclass</h2><p>jclass&#x662F;JNI&#x4E2D;&#x8BBE;&#x5B9A;&#x7684;&#x5BF9;&#x5E94;&#x4E8E;java&#x5C42;Class&#x7684;&#x53D8;&#x91CF;&#xFF0C;&#x65E0;&#x8BBA;jclass&#x3001;jmethod&#x3001;jobject&#xFF0C;&#x51FA;&#x4E8E;&#x5B89;&#x5168;&#x7684;&#x8003;&#x8651;&#xFF0C;&#x4ED6;&#x4EEC;&#x90FD;&#x662F;&#x95F4;&#x63A5;&#x5F15;&#x7528;&#xFF0C;&#x8FD9;&#x4E9B;&#x53D8;&#x91CF;&#x5B9A;&#x4E49;&#x5728;jni.h&#x6587;&#x4EF6;&#x4E2D;</p>
<p>JNIEnv&#x6709;&#x4E09;&#x79CD;&#x65B9;&#x6CD5;&#x83B7;&#x5F97;jclass</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">jclass <span class="title">FindClass</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* name)</span></span></span><br><span class="line"><span class="function">jclass <span class="title">GetObjectClass</span><span class="params">(jobject obj)</span></span></span><br><span class="line"><span class="function">jclass <span class="title">GetSuperclass</span><span class="params">(jclass clazz)</span></span></span><br></pre></td></tr></table></figure>
<h2 id="2&#x3001;&#x8C03;&#x7528;Java&#x7C7B;&#x7684;&#x6210;&#x5458;&#x65B9;&#x6CD5;"><a href="#2&#x3001;&#x8C03;&#x7528;Java&#x7C7B;&#x7684;&#x6210;&#x5458;&#x65B9;&#x6CD5;" class="headerlink" title="2&#x3001;&#x8C03;&#x7528;Java&#x7C7B;&#x7684;&#x6210;&#x5458;&#x65B9;&#x6CD5;"></a>2&#x3001;&#x8C03;&#x7528;Java&#x7C7B;&#x7684;&#x6210;&#x5458;&#x65B9;&#x6CD5;</h2><p><strong>&#x5173;&#x952E;API&#xFF1A;</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">jclass <span class="title">FindClass</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* name)</span></span></span><br><span class="line"><span class="function">jobject <span class="title">NewObject</span><span class="params">(jclass clazz, jmethodID methodID, ...)</span></span></span><br><span class="line"><span class="function"><span class="comment">//&#x83B7;&#x53D6;&#x65B9;&#x6CD5;ID</span></span></span><br><span class="line"><span class="function">jmethodID <span class="title">GetStaticMethodID</span><span class="params">(jclass clazz, <span class="keyword">const</span> <span class="keyword">char</span>* name, <span class="keyword">const</span> <span class="keyword">char</span>* sig)</span></span></span><br><span class="line"><span class="function">jmethodID <span class="title">GetMethodID</span><span class="params">(jclass clazz, <span class="keyword">const</span> <span class="keyword">char</span>* name, <span class="keyword">const</span> <span class="keyword">char</span>* sig)</span></span></span><br><span class="line"><span class="function"><span class="comment">//&#x8C03;&#x7528;&#x65B9;&#x6CD5;</span></span></span><br><span class="line">NativeType CallStatic&lt;type&gt;Method(JNIEnv *env, jobject obj,jmethodID methodID, ...);</span><br><span class="line">NativeType Call&lt;type&gt;Method(JNIEnv *env, jobject obj,jmethodID methodID, ...);</span><br></pre></td></tr></table></figure>
<p><strong>&#x8C03;&#x7528;&#x7C7B;&#x7684;&#x9759;&#x6001;&#x65B9;&#x6CD5;</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">jclass jclazz = env-&gt;FindClass(<span class="string">&quot;com/example/myapplication/JNITest&quot;</span>);</span><br><span class="line">jmethodID statictest_mid= env-&gt;GetStaticMethodID(jclazz,<span class="string">&quot;static_test&quot;</span>,<span class="string">&quot;()V&quot;</span>);</span><br><span class="line">env-&gt;CallStaticVoidMethod(jclazz,statictest_mid);</span><br></pre></td></tr></table></figure>
<p><strong>&#x8C03;&#x7528;&#x7C7B;&#x7684;&#x5B9E;&#x4F8B;&#x65B9;&#x6CD5;</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//&#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x8C61;</span></span><br><span class="line">jclass jclazz = env-&gt;FindClass(<span class="string">&quot;com/example/myapplication/JNITest&quot;</span>);</span><br><span class="line">jmethodID construction_mid =env-&gt;GetMethodID(jclazz,<span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;()V&quot;</span>);</span><br><span class="line">jobject JNITest_obj = env-&gt;NewObject(jclazz,construction_mid);</span><br><span class="line"><span class="comment">//&#x8C03;&#x7528;&#x65B9;&#x6CD5;</span></span><br><span class="line">jmethodID test_mid=env-&gt;GetMethodID(jclazz,<span class="string">&quot;test&quot;</span>, <span class="string">&quot;(ILjava/lang/String;)Ljava/lang/String;&quot;</span>);</span><br><span class="line">jstring b =(jstring)env-&gt;CallObjectMethod(JNITest_obj,test_mid,<span class="number">4</span>,env-&gt;NewStringUTF(<span class="string">&quot;bbbb&quot;</span>));</span><br></pre></td></tr></table></figure>
<h2 id="3&#x3001;&#x8BBF;&#x95EE;&#x548C;&#x8BBE;&#x7F6E;Java&#x7C7B;&#x7684;&#x6210;&#x5458;&#x53D8;&#x91CF;"><a href="#3&#x3001;&#x8BBF;&#x95EE;&#x548C;&#x8BBE;&#x7F6E;Java&#x7C7B;&#x7684;&#x6210;&#x5458;&#x53D8;&#x91CF;" class="headerlink" title="3&#x3001;&#x8BBF;&#x95EE;&#x548C;&#x8BBE;&#x7F6E;Java&#x7C7B;&#x7684;&#x6210;&#x5458;&#x53D8;&#x91CF;"></a>3&#x3001;&#x8BBF;&#x95EE;&#x548C;&#x8BBE;&#x7F6E;Java&#x7C7B;&#x7684;&#x6210;&#x5458;&#x53D8;&#x91CF;</h2><p><strong>&#x5173;&#x952E;API&#xFF1A;</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">jfieldID <span class="title">GetStaticFieldID</span><span class="params">(jclass clazz, <span class="keyword">const</span> <span class="keyword">char</span>* name, <span class="keyword">const</span> <span class="keyword">char</span>* sig)</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SetStaticIntField</span><span class="params">(jclass clazz, jfieldID fieldID, jint value)</span></span></span><br><span class="line"><span class="function">jfieldID <span class="title">GetFieldID</span><span class="params">(jclass clazz, <span class="keyword">const</span> <span class="keyword">char</span>* name, <span class="keyword">const</span> <span class="keyword">char</span>* sig)</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SetIntField</span><span class="params">(jobject obj, jfieldID fieldID, jint value)</span></span></span><br></pre></td></tr></table></figure>
<p><strong>&#x8BBF;&#x95EE;&#x548C;&#x8BBE;&#x7F6E;&#x7C7B;&#x7684;&#x9759;&#x6001;&#x53D8;&#x91CF;</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">jfieldID fids = env-&gt;GetStaticFieldID(jclazz,<span class="string">&quot;staticNum&quot;</span>,<span class="string">&quot;I&quot;</span>);</span><br><span class="line">env-&gt;SetStaticIntField(jclazz,fids,<span class="number">34</span>);</span><br><span class="line">jint n2= env-&gt;GetStaticIntField(jclazz,fids);</span><br></pre></td></tr></table></figure>
<p><strong>&#x8BBF;&#x95EE;&#x548C;&#x8BBE;&#x7F6E;&#x7C7B;&#x7684;&#x5B9E;&#x4F8B;&#x53D8;&#x91CF;</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">jfieldID fid = env-&gt;GetFieldID(jclazz,<span class="string">&quot;age&quot;</span>,<span class="string">&quot;I&quot;</span>);</span><br><span class="line">env-&gt;SetIntField(JNITest_obj,fid,<span class="number">33</span>);</span><br><span class="line">jint n1 = env-&gt;GetIntField(JNITest_obj,fid);</span><br></pre></td></tr></table></figure>
<h1 id="CMakeLists-txt"><a href="#CMakeLists-txt" class="headerlink" title="CMakeLists.txt"></a>CMakeLists.txt</h1><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># For more information about using CMake with Android Studio, read the</span></span><br><span class="line"><span class="comment"># documentation: https://d.android.com/studio/projects/add-native-code.html</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Sets the minimum version of CMake required to build the native library.</span></span><br><span class="line"></span><br><span class="line">cmake_minimum_required(VERSION <span class="number">3.4</span>.<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Creates and names a library, sets it as either STATIC</span></span><br><span class="line"><span class="comment"># or SHARED, and provides the relative paths to its source code.</span></span><br><span class="line"><span class="comment"># You can define multiple libraries, and CMake builds them for you.</span></span><br><span class="line"><span class="comment"># Gradle automatically packages shared libraries with your APK.</span></span><br><span class="line"></span><br><span class="line">add_library( <span class="comment"># Sets the name of the library.</span></span><br><span class="line">        native-<span class="class"><span class="keyword">lib</span></span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Sets the library as a shared library.</span></span><br><span class="line">        SHARED</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Provides a relative path to your source file(s).</span></span><br><span class="line">        native-<span class="class"><span class="keyword">lib</span>.<span class="title">cpp</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Searches for a specified prebuilt library and stores the path as a</span></span><br><span class="line"><span class="comment"># variable. Because CMake includes system libraries in the search path by</span></span><br><span class="line"><span class="comment"># default, you only need to specify the name of the public NDK library</span></span><br><span class="line"><span class="comment"># you want to add. CMake verifies that the library exists before</span></span><br><span class="line"><span class="comment"># completing its build.</span></span><br><span class="line"></span><br><span class="line">find_library( <span class="comment"># Sets the name of the path variable.</span></span><br><span class="line">        log-<span class="class"><span class="keyword">lib</span></span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Specifies the name of the NDK library that</span></span><br><span class="line">        <span class="comment"># you want CMake to locate.</span></span><br><span class="line">        log)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Specifies libraries CMake should link to your target library. You</span></span><br><span class="line"><span class="comment"># can link multiple libraries, such as libraries you define in this</span></span><br><span class="line"><span class="comment"># build script, prebuilt third-party libraries, or system libraries.</span></span><br><span class="line"></span><br><span class="line">target_link_libraries( <span class="comment"># Specifies the target library.</span></span><br><span class="line">        native-<span class="class"><span class="keyword">lib</span></span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Links the target library to the log library</span></span><br><span class="line">        <span class="comment"># included in the NDK.</span></span><br><span class="line">        ${log-<span class="class"><span class="keyword">lib</span>})</span></span><br></pre></td></tr></table></figure>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/12/02/2019-12-02 初试反调试/">初试反调试</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-12-02</time><div class="content"><p>&#x7406;&#x8BBA;&#x77E5;&#x8BC6;&#x4E0D;&#x662F;&#x5F88;&#x591A;&#xFF0C;&#x5F88;&#x591A;&#x64CD;&#x4F5C;&#xFF0C;&#x8BB0;&#x5F55;&#x4E00;&#x4E0B;&#xFF0C;&#x6837;&#x672C;&#x662F;AliCrackme_2.apk</p>
<p>&#x53CD;&#x8C03;&#x8BD5;&#x4E2D;&#x6709;&#x4E00;&#x4E2A;&#x65B9;&#x6CD5;&#x662F;&#x5FAA;&#x73AF;&#x68C0;&#x67E5;&#x8FDB;&#x7A0B;&#x7684;status&#x5B57;&#x6BB5;&#xFF0C;&#x5982;&#x679C;&#x8FDB;&#x7A0B;&#x88AB;ptrace&#x540E;&#xFF0C;&#x5176;TracerPid&#x4E3A;ptrace&#x8FDB;&#x7A0B;&#x7684;pid</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@hammerhead:/ # cat /proc/7063/status</span><br><span class="line">Name:	pollux.smalilearn</span><br><span class="line">State:	t (tracing stop)</span><br><span class="line">Tgid:	7063</span><br><span class="line">Pid:	7063</span><br><span class="line">PPid:	757</span><br><span class="line">TracerPid:	7099</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">root@hammerhead:/ # ps |grep 7099</span><br><span class="line">root      7099  7094  16964  11840 ffffffff b6efe854 S ./android_server</span><br></pre></td></tr></table></figure>
<p>1&#x3001;&#x6DFB;&#x52A0;android:debuggable = &#x201C;true&#x201D;</p>
<p>&#x4FEE;&#x6539;AndroidManifest.xml&#x5728;manifest&#x6807;&#x7B7E;&#x4E0B;&#x52A0;&#x4E0A;<code>android:debuggable = &quot;true&quot;</code>&#xFF0C;&#x5426;&#x5219;&#x5728;&#x7528;jdb&#x9644;&#x52A0;&#x8FDB;&#x7A0B;&#x65F6;&#x4F1A;&#x62A5;&#x9519;&#xFF0C;&#x9644;&#x52A0;&#x4E0D;&#x4E0A;&#x8FDB;&#x7A0B;&#x3002;</p>
<p>&#x91CD;&#x65B0;&#x6253;&#x5305;:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar signapk.jar testkey.x509.pem testkey.pk8 AliCrackme_2.apk AliCrackme_2.sig.apk</span><br></pre></td></tr></table></figure>
<p>2&#x3001;&#x4F7F;&#x7528;am&#x547D;&#x4EE4;&#x4EE5;debug&#x65B9;&#x5F0F;&#x542F;&#x52A8;&#x7A0B;&#x5E8F;&#xFF0C;&#x6B64;&#x65F6;&#x7A0B;&#x5E8F;&#x5904;&#x4E8E;&#x7B49;&#x5F85;Debugger&#x72B6;&#x6001;</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am start -D -n com.yaotong.crackme/.MainActivity</span><br></pre></td></tr></table></figure>
<p>3&#x3001;&#x5728;&#x5B89;&#x5353;&#x7AEF;&#x542F;&#x52A8;<code>android_server</code>&#xFF0C;&#x7A0B;&#x5E8F;&#x5728;&#x5B89;&#x88C5;&#x76EE;&#x5F55;&#x7684;<code>dbgsrv</code>&#x6587;&#x4EF6;&#x5939;&#x4E0B;</p>
<p>4&#x3001;&#x4E3A;IDA&#x8BBE;&#x7F6E;&#x7AEF;&#x53E3;&#x8F6C;&#x53D1;</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">adb</span> <span class="selector-tag">forward</span> <span class="selector-tag">tcp</span><span class="selector-pseudo">:23946</span> <span class="selector-tag">tcp</span><span class="selector-pseudo">:23946</span></span><br></pre></td></tr></table></figure>
<p>5&#x3001;IDA&#x9644;&#x52A0;&#x8FDB;&#x7A0B;&#xFF0C;&#x5E76;&#x8BBE;&#x7F6E;&#x52A0;&#x8F7D;&#x5E93;&#x7684;&#x65AD;&#x70B9;</p>
<p><img src="/2019/12/02/2019-12-02 &#x521D;&#x8BD5;&#x53CD;&#x8C03;&#x8BD5;/image-20191202160324614.png" alt="image-20191202160324614" style="zoom:50%;"></p>
<p>6&#x3001;&#x6253;&#x5F00;ddms&#xFF0C;&#x4F7F;&#x7528;jdb&#x9644;&#x52A0;&#x8FDB;&#x7A0B;</p>
<p>8700&#x662F;ddms&#x5F00;&#x542F;&#x7684;&#x7AEF;&#x53E3;&#x8F6C;&#x53D1;</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">jdb</span> <span class="selector-tag">-attach</span> 127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:8700</span></span><br></pre></td></tr></table></figure>
<p>&#x8FD4;&#x56DE;IDA&#xFF0C;&#x8FD0;&#x884C;&#x7A0B;&#x5E8F;&#xFF0C;&#x7A0B;&#x5E8F;&#x5C31;&#x4F1A;&#x65AD;&#x5728;linker.so&#x4E2D;&#xFF0C;linker&#x662F;&#x7528;&#x4E8E;&#x52A0;&#x8F7D;so&#x6587;&#x4EF6;&#x7684;&#x6A21;&#x5757;<br><img src="/2019/12/02/2019-12-02 &#x521D;&#x8BD5;&#x53CD;&#x8C03;&#x8BD5;/image-20191202161144065.png" alt="image-20191202161144065" style="zoom:50%;"></p>
<p>&#x53CC;&#x5F00;IDA&#xFF0C;&#x8BA1;&#x7B97;JNI_Onload&#x51FD;&#x6570;&#x7684;&#x5730;&#x5740;&#xFF0C;&#x5230;&#x8BE5;&#x5904;&#x4E0B;&#x65AD;&#xFF0C;&#x5355;&#x6B65;&#x5230;BLX R7&#x65F6;&#x9000;&#x51FA;JNI_Onload&#x51FD;&#x6570;</p>
<p><img src="/2019/12/02/2019-12-02 &#x521D;&#x8BD5;&#x53CD;&#x8C03;&#x8BD5;/image-20191202161354035.png" alt="image-20191202161354035" style="zoom:50%;"></p>
<p>R7&#x7684;&#x503C;&#x4E3A;<code>pthread_create</code>&#xFF0C;&#x56DE;&#x770B;so&#x7684;&#x4F2A;&#x4EE3;&#x7801;&#xFF0C;&#x53EF;&#x4EE5;&#x731C;&#x6D4B;&#x7A0B;&#x5E8F;&#x5F00;&#x542F;&#x65B0;&#x7EBF;&#x7A0B;&#x53BB;&#x5FAA;&#x73AF;&#x67E5;&#x8BE2;TracerPid&#x7684;&#x503C;&#x662F;&#x5426;&#x4E3A;0&#xFF0C;&#x5B9A;&#x4F4D;&#x5230;BLX R7&#x7684;&#x504F;&#x79FB;&#x4E3A;1C58&#xFF0C;&#x9009;&#x4E2D;&#x8BE5;&#x884C;&#x6307;&#x4EE4;&#xFF0C;CTRL+ALT+K&#x5C06;&#x5176;patch&#x4E3A;&#x7A7A;&#x6307;&#x4EE4;</p>
<p><img src="/2019/12/02/2019-12-02 &#x521D;&#x8BD5;&#x53CD;&#x8C03;&#x8BD5;/image-20191202163955073.png" alt="image-20191202163955073" style="zoom:50%;"></p>
<p>ARM&#x6307;&#x4EE4;&#x96C6;&#x4E2D;&#x7684;<code>NOP</code>(0xe1a00000)&#x662F;&#x4E00;&#x6761;&#x4F2A;&#x6307;&#x4EE4;&#xFF0C;&#x7F16;&#x8BD1;&#x7CFB;&#x7EDF;&#x7528;&#x4E00;&#x6761;<code>MOV r0, r0, lsl #0</code>(0xe1a00000)&#x6307;&#x4EE4;&#x66FF;&#x4EE3;&#x5176;&#x6267;&#x884C;&#xFF0C;&#x8BBE;&#x4E3A;ANDEQ  r0,r0,r0&#xFF0C;&#x5373;&#x53EF;&#x751F;&#x6210;&#x7A7A;&#x6307;&#x4EE4;</p>
<p>&#x4FDD;&#x5B58;&#x540E;&#xFF0C;&#x91CD;&#x65B0;&#x6253;&#x5305;&#x7B7E;&#x540D;&#xFF0C;IDA&#x53EF;&#x4EE5;&#x6B63;&#x5E38;&#x8C03;&#x8BD5;&#x4E86;</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/12/01/2019-12-01 手机和AS中debug环境配置问题小记/">手机和AS中debug环境配置问题小记</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-12-01</time><div class="content"><h2 id="&#x4E00;&#x3001;&#x5728;AS&#x4E2D;&#x5C1D;&#x8BD5;&#x8C03;&#x8BD5;native&#x4EE3;&#x7801;&#xFF0C;&#x62A5;&#x9519;"><a href="#&#x4E00;&#x3001;&#x5728;AS&#x4E2D;&#x5C1D;&#x8BD5;&#x8C03;&#x8BD5;native&#x4EE3;&#x7801;&#xFF0C;&#x62A5;&#x9519;" class="headerlink" title="&#x4E00;&#x3001;&#x5728;AS&#x4E2D;&#x5C1D;&#x8BD5;&#x8C03;&#x8BD5;native&#x4EE3;&#x7801;&#xFF0C;&#x62A5;&#x9519;"></a>&#x4E00;&#x3001;&#x5728;AS&#x4E2D;&#x5C1D;&#x8BD5;&#x8C03;&#x8BD5;native&#x4EE3;&#x7801;&#xFF0C;&#x62A5;&#x9519;</h2><p><strong>1&#x3001;&#x62A5;&#x9519;&#xFF1A;</strong></p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Attention! No symbol directories found - please<span class="built_in"> check </span>your native debug configuration</span><br></pre></td></tr></table></figure>
<p><strong>&#x89E3;&#x51B3;&#xFF1A;</strong></p>
<p>&#x5728;app/build.gradle&#x7684;android&#x6807;&#x7B7E;&#x4E0B;&#xFF0C;&#x6DFB;&#x52A0;&#x5982;&#x4E0B;&#x5185;&#x5BB9;&#xFF0C;&#x5173;&#x95ED;debug&#x6A21;&#x5F0F;&#x7684;&#x6DF7;&#x6DC6;&#xFF1A;</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">buildTypes</span> {</span><br><span class="line">    <span class="section">debug</span> {</span><br><span class="line">        <span class="attribute">minifyEnabled</span> <span class="literal">false</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>2&#x3001;&#x62A5;&#x9519;&#xFF1A;</strong></p>
<p>&#x542F;&#x52A8;&#x8C03;&#x8BD5;&#x65F6;&#x76F4;&#x63A5;&#x9000;&#x51FA;&#xFF0C;&#x62A5;&#x9519;&#x5185;&#x5BB9;&#x4E3A;&#xFF1A;</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Process finished with <span class="keyword">exit</span> code <span class="number">0</span></span><br><span class="line">com.intellij.execution.ExecutionFinishedException: Execution finished</span><br></pre></td></tr></table></figure>
<p><strong>&#x89E3;&#x51B3;&#xFF1A;</strong></p>
<p>&#x4E4B;&#x524D;host&#x6587;&#x4EF6;&#x88AB;&#x6211;&#x6539;&#x52A8;&#x8FC7;&#xFF0C;&#x5C06;&#x7ED1;&#x5B9A;localhost&#x91CD;&#x65B0;&#x7ED1;&#x5B9A;&#x4E3A;127.0.0.1</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span> <span class="selector-tag">localhost</span></span><br></pre></td></tr></table></figure>
<h2 id="&#x4E8C;&#x3001;&#x624B;&#x673A;debug&#x6A21;&#x5F0F;&#x7684;&#x95EE;&#x9898;"><a href="#&#x4E8C;&#x3001;&#x624B;&#x673A;debug&#x6A21;&#x5F0F;&#x7684;&#x95EE;&#x9898;" class="headerlink" title="&#x4E8C;&#x3001;&#x624B;&#x673A;debug&#x6A21;&#x5F0F;&#x7684;&#x95EE;&#x9898;"></a>&#x4E8C;&#x3001;&#x624B;&#x673A;debug&#x6A21;&#x5F0F;&#x7684;&#x95EE;&#x9898;</h2><p><strong>&#x95EE;&#x9898;&#xFF1A;</strong></p>
<p>&#x5728;ddms&#x4E2D;&#x53EA;&#x80FD;&#x770B;&#x5230;&#x88AB;debug&#x7684;&#x7A0B;&#x5E8F;</p>
<p><strong>&#x89E3;&#x51B3;&#xFF1A;</strong></p>
<p>&#x8F93;&#x5165;&#x5982;&#x4E0B;&#x547D;&#x4EE4;</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell getprop ro.debuggable</span><br></pre></td></tr></table></figure>
<p>&#x82E5;ro.debuggable = 0&#xFF0C;&#x8BF4;&#x660E;&#x8FD9;&#x4E2A;rom&#x662F;user&#x7248;&#x672C;&#xFF0C;&#x53EA;&#x80FD;&#x8C03;&#x8BD5;debug&#x7A0B;&#x5E8F;<br>&#x82E5;ro.debuggable = 1&#xFF0C;&#x8BF4;&#x660E;&#x8FD9;&#x4E2A;rom&#x662F;userdebug&#x7248;&#x672C;&#xFF0C;&#x53EF;&#x4EE5;&#x8C03;&#x8BD5;&#x7CFB;&#x7EDF;&#x6240;&#x6709;&#x8FDB;&#x7A0B;</p>
<p>&#x6709;&#x4E24;&#x79CD;&#x65B9;&#x6CD5;&#x89E3;&#x51B3;&#xFF1A;</p>
<p>1&#x3001;&#x5B89;&#x88C5;Xposed&#x7684;xinstaller&#x6A21;&#x5757;&#xFF0C;&#x5728;&#x6A21;&#x5757;&#x7684;<strong>&#x5176;&#x4ED6;&#x8BBE;&#x7F6E;</strong>&#x4E2D;&#x5F00;&#x542F;<strong>&#x8C03;&#x8BD5;&#x5E94;&#x7528;</strong>&#x529F;&#x80FD;<br>xinstaller &#x4E0B;&#x8F7D;&#x5730;&#x5740;&#xFF1A;<a href="https://repo.xposed.info/module/com.pyler.xinstaller" target="_blank" rel="noopener">https://repo.xposed.info/module/com.pyler.xinstaller</a></p>
<p>2&#x3001;&#x4ECE;ROM&#x4E2D;&#x63D0;&#x53D6;boot.img&#xFF0C;&#x89E3;&#x5305;&#xFF0C;&#x4FEE;&#x6539;default.prop&#xFF0C;&#x5C06;ro.debuggable=0&#x4FEE;&#x6539;&#x4E3A;ro.debuggable=1&#xFF0C;&#x91CD;&#x65B0;&#x6253;&#x5305;<br>&#x53C2;&#x8003;&#x6587;&#x7AE0;&#xFF1A;<a href="https://bbs.pediy.com/thread-197334.htm" target="_blank" rel="noopener">https://bbs.pediy.com/thread-197334.htm</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/11/27/2019-11-27 nexus5环境配置/">nexus5环境配置</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-11-27</time><div class="content"><p>nexus5&#x914D;&#x7F6E;&#x73AF;&#x5883;&#xFF0C;&#x8BB0;&#x5F55;&#x4E00;&#x4E0B;&#x3002;</p>
<h2 id="&#x5DE5;&#x5177;&#x7248;&#x672C;"><a href="#&#x5DE5;&#x5177;&#x7248;&#x672C;" class="headerlink" title="&#x5DE5;&#x5177;&#x7248;&#x672C;"></a>&#x5DE5;&#x5177;&#x7248;&#x672C;</h2><ol>
<li>&#x5B98;&#x65B9;&#x955C;&#x50CF;&#xFF1A;hammerhead-lrx22c-factory-3b22f481.zip</li>
<li>Auto Root&#xFF1A;CF-Auto-Root-hammerhead-hammerhead-nexus5.zip</li>
<li>&#x7B2C;&#x4E09;&#x65B9;Recovery&#xFF1A;twrp-3.3.1-0-hammerhead.img</li>
<li>Xposed&#x5E94;&#x7528;&#xFF1A;xposed-installer-3-1-5.apk</li>
<li>Xposed&#x6846;&#x67B6;&#xFF1A;xposed-v89-sdk21-arm.zip</li>
<li>Xposed&#x6A21;&#x5757;XInstaller&#xFF1A;com.pyler.xinstaller_v500_128e2a.apk</li>
<li>adbd Insecure&#xFF1A;adbd-Insecure-v2.00.apk</li>
</ol>
<h2 id="1&#x3001;&#x5237;&#x5165;&#x5B98;&#x65B9;&#x955C;&#x50CF;"><a href="#1&#x3001;&#x5237;&#x5165;&#x5B98;&#x65B9;&#x955C;&#x50CF;" class="headerlink" title="1&#x3001;&#x5237;&#x5165;&#x5B98;&#x65B9;&#x955C;&#x50CF;"></a>1&#x3001;&#x5237;&#x5165;&#x5B98;&#x65B9;&#x955C;&#x50CF;</h2><p>&#x4E0B;&#x8F7D;&#x955C;&#x50CF;<br><a href="https://developers.google.com/android/images#hammerhead" target="_blank" rel="noopener">https://developers.google.com/android/images#hammerhead</a></p>
<p>&#x624B;&#x673A;&#x8FDB;&#x5165;bootloader</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">adb</span> reboot <span class="keyword">bootloader</span></span><br><span class="line"><span class="keyword">&#x6216;&#x957F;&#x6309;&#x5173;&#x673A;&#x952E;+&#x97F3;&#x91CF;&#x4E0B;</span></span><br></pre></td></tr></table></figure>
<p>&#x4F7F;&#x7528;flash-all.sh&#x811A;&#x672C;&#x5237;&#x5165;&#x540E;&#x65E0;&#x9650;&#x91CD;&#x542F;&#xFF0C;&#x5148;&#x5C06;&#x4E0B;&#x8F7D;&#x540E;&#x955C;&#x50CF;&#x5305;&#x4E2D;&#x7684;image-hammerhead-lrx22c.zip&#x89E3;&#x538B;&#xFF0C;&#x5199;&#x4E00;&#x4E2A;shell&#x811A;&#x672C;&#x5B89;&#x88C5;&#xFF1A;</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">fastboot erase cache </span><br><span class="line">fastboot erase userdata</span><br><span class="line">fastboot erase bootfastboot erase cache</span><br><span class="line">fastboot erase recovery</span><br><span class="line">fastboot erase system</span><br><span class="line">fastboot erase userdata   </span><br><span class="line">fastboot flash bootloader bootloader-hammerhead-hhz12d.img</span><br><span class="line">fastboot reboot-bootloader</span><br><span class="line">fastboot flash radio radio-hammerhead-m8974a-2.0.50.2.22.img</span><br><span class="line">fastboot reboot-bootloader</span><br><span class="line">fastboot flash recovery ./image-hammerhead-lrx22c/recovery.img</span><br><span class="line">fastboot flash boot ./image-hammerhead-lrx22c/boot.img</span><br><span class="line">fastboot flash system ./image-hammerhead-lrx22c/system.img</span><br><span class="line">fastboot flash cache ./image-hammerhead-lrx22c/cache.img</span><br><span class="line">fastboot flash userdata ./image-hammerhead-lrx22c/userdata.img</span><br></pre></td></tr></table></figure>
<p>&#x7136;&#x540E;&#x91CD;&#x542F;&#x624B;&#x673A;</p>
<h2 id="2&#x3001;ROOT"><a href="#2&#x3001;ROOT" class="headerlink" title="2&#x3001;ROOT"></a>2&#x3001;ROOT</h2><p>&#x4E0B;&#x8F7D;Auto Root<br><a href="https://download.chainfire.eu/363/CF-Root/CF-Auto-Root/CF-Auto-Root-hammerhead-hammerhead-nexus5.zip" target="_blank" rel="noopener">https://download.chainfire.eu/363/CF-Root/CF-Auto-Root/CF-Auto-Root-hammerhead-hammerhead-nexus5.zip</a></p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">adb reboot bootloader</span><br><span class="line">chmod +x root-<span class="keyword">mac</span>.<span class="keyword">sh</span></span><br><span class="line">./root-<span class="keyword">mac</span>.<span class="keyword">sh</span></span><br></pre></td></tr></table></figure>
<h2 id="3&#x3001;twrp"><a href="#3&#x3001;twrp" class="headerlink" title="3&#x3001;twrp"></a>3&#x3001;twrp</h2><p>&#x4E0B;&#x8F7D;Twrp<br><a href="https://twrp.me/lg/lgnexus5.html" target="_blank" rel="noopener">https://twrp.me/lg/lgnexus5.html</a></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">adb</span> <span class="selector-tag">reboot</span> <span class="selector-tag">bootloader</span></span><br><span class="line"><span class="selector-tag">fastboot</span> <span class="selector-tag">flash</span> <span class="selector-tag">recovery</span> <span class="selector-tag">twrp-3</span><span class="selector-class">.3</span><span class="selector-class">.1-0-hammerhead</span><span class="selector-class">.img</span></span><br><span class="line"><span class="selector-tag">fastboot</span> <span class="selector-tag">reboot</span></span><br><span class="line"><span class="selector-tag">adb</span> <span class="selector-tag">reboot</span> <span class="selector-tag">recovery</span></span><br></pre></td></tr></table></figure>
<h2 id="4&#x3001;Xposed"><a href="#4&#x3001;Xposed" class="headerlink" title="4&#x3001;Xposed"></a>4&#x3001;Xposed</h2><p>&#x4E0B;&#x8F7D;&#x5B89;&#x88C5;&#x5B89;&#x88C5;&#x5305;</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb install xposed-installer<span class="number">-3</span><span class="number">-1</span><span class="number">-5.</span>apk</span><br></pre></td></tr></table></figure>
<p>android5.0&#x4EE5;&#x4E0A;&#x9700;&#x8981;&#x5B89;&#x88C5;&#x989D;&#x5916;&#x7684;&#x6846;&#x67B6;<br><a href="https://forum.xda-developers.com/showthread.php?t=3034811" target="_blank" rel="noopener">https://forum.xda-developers.com/showthread.php?t=3034811</a></p>
<p>&#x4E0B;&#x8F7D;&#x5BF9;&#x5E94;&#x7684;&#x6846;&#x67B6;<br><a href="https://dl-xda.xposed.info/framework/sdk21/arm/xposed-v89-sdk21-arm.zip" target="_blank" rel="noopener">https://dl-xda.xposed.info/framework/sdk21/arm/xposed-v89-sdk21-arm.zip</a></p>
<p>&#x5B98;&#x65B9;&#x63A8;&#x8350;Twrp&#x5B89;&#x88C5;<br>&#x8FDB;&#x5165;Twrp-&gt;Advanced-&gt;ADB sideload</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">adb slidload adb sideload xposed-v89-sdk21-arm.<span class="keyword">zip</span></span><br><span class="line">&#x6216;</span><br><span class="line">adb <span class="keyword">shell</span> flash-archive.<span class="keyword">sh</span> xposed-v89-sdk21-arm.<span class="keyword">zip</span></span><br></pre></td></tr></table></figure>
<h2 id="5&#x3001;&#x5B89;&#x88C5;adbd-Insecure"><a href="#5&#x3001;&#x5B89;&#x88C5;adbd-Insecure" class="headerlink" title="5&#x3001;&#x5B89;&#x88C5;adbd Insecure"></a>5&#x3001;&#x5B89;&#x88C5;adbd Insecure</h2><p>&#x8BA9;adb shell&#x547D;&#x4EE4;&#x76F4;&#x63A5;&#x53D8;&#x6210;root&#x6743;&#x9650;</p>
<h2 id="6&#x3001;&#x5B89;&#x88C5;Xposed&#x7684;Xinstaller&#x6A21;&#x5757;"><a href="#6&#x3001;&#x5B89;&#x88C5;Xposed&#x7684;Xinstaller&#x6A21;&#x5757;" class="headerlink" title="6&#x3001;&#x5B89;&#x88C5;Xposed&#x7684;Xinstaller&#x6A21;&#x5757;"></a>6&#x3001;&#x5B89;&#x88C5;Xposed&#x7684;Xinstaller&#x6A21;&#x5757;</h2><p><a href="https://repo.xposed.info/module/com.pyler.xinstaller" target="_blank" rel="noopener">https://repo.xposed.info/module/com.pyler.xinstaller</a></p>
<p>&#x4E0D;&#x9700;&#x8981;&#x4FEE;&#x6539;boot.img&#xFF0C;&#x5F00;&#x542F;&#x7CFB;&#x7EDF;&#x8C03;&#x8BD5;</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/11/23/2019-12-23 通过在native层动态修改内存中的Dalvik指令来学习Dex文件格式/">通过在native层动态修改内存中的Dalvik指令来学习Dex文件格式</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-11-23</time><div class="content"><h1 id="1-Prologue"><a href="#1-Prologue" class="headerlink" title="1. Prologue"></a>1. Prologue</h1><p>&#x53EA;&#x770B;Dex&#x6587;&#x4EF6;&#x683C;&#x5F0F;&#x611F;&#x89C9;&#x4F1A;&#x5F88;&#x67AF;&#x71E5;&#xFF0C;&#x6240;&#x4EE5;&#x60F3;&#x901A;&#x8FC7;&#x52A8;&#x624B;&#x7684;&#x65B9;&#x5F0F;&#x53BB;&#x7406;&#x89E3;Dex&#x6587;&#x4EF6;&#x4E2D;&#x7684;&#x76F8;&#x5173;&#x6570;&#x636E;&#x7684;&#x4F5C;&#x7528;&#xFF0C;&#x4EE5;&#x53CA;&#x4E92;&#x76F8;&#x600E;&#x4E48;&#x5173;&#x8054;&#x8D77;&#x6765;&#x7684;&#x3002;&#x5B9E;&#x73B0;&#x7684;&#x76EE;&#x6807;&#x662F;&#x901A;&#x8FC7;so&#x5E93;&#x52A8;&#x6001;&#x5C06;&#x5185;&#x5B58;&#x4E2D;&#x7684;&#x52A0;&#x6CD5;&#x6307;&#x4EE4;&#x4FEE;&#x6539;&#x6210;&#x4E58;&#x6CD5;&#x6307;&#x4EE4;&#x3002;&#x5177;&#x4F53;&#x7684;&#x5B66;&#x4E60;&#x8FC7;&#x7A0B;&#x662F;&#x5B66;&#x4E60;&#x4E86;&#x59DC;&#x7EF4;&#x7684;&#x535A;&#x5BA2;&#xFF0C;&#x5F04;&#x61C2;&#x540E;&#x89C9;&#x5F97;&#x8FD9;&#x4E2A;&#x6587;&#x7AE0;&#x5F88;&#x9002;&#x5408;&#x7528;&#x6765;&#x5B66;&#x4E60;Dex&#x6587;&#x4EF6;&#x683C;&#x5F0F;&#xFF0C;&#x6240;&#x4EE5;&#x53C2;&#x8003;&#x4E86;&#x7F51;&#x4E0A;&#x6709;&#x5173;Dex&#x6587;&#x4EF6;&#x683C;&#x5F0F;&#x7684;&#x6587;&#x7AE0;&#xFF0C;&#x6253;&#x7B97;&#x7528;&#x81EA;&#x5DF1;&#x7684;&#x601D;&#x8DEF;&#x8BB0;&#x5F55;&#x4E00;&#x4E0B;&#x5B66;&#x4E60;&#x7684;&#x8FC7;&#x7A0B;&#x3002;&#x90E8;&#x5206;&#x5185;&#x5BB9;&#x53EF;&#x80FD;&#x4F1A;&#x8D58;&#x8FF0;&#x59DC;&#x7EF4;&#x7684;&#x6587;&#x7AE0;&#xFF0C;&#x4F46;&#x662F;&#x6211;&#x4F1A;&#x7A7F;&#x63D2;&#x81EA;&#x5DF1;&#x9047;&#x5230;&#x7684;&#x96BE;&#x61C2;&#x7684;&#x90E8;&#x5206;&#x548C;&#x4E00;&#x4E9B;&#x5185;&#x5BB9;&#x81EA;&#x5DF1;&#x7684;&#x6574;&#x7406;&#x3002;</p>
<p>&#x5177;&#x4F53;&#x6765;&#x8BF4;&#x662F;&#x5B9A;&#x4E49;&#x4E86;&#x4E00;&#x4E2A;&#x7C7B;&#xFF0C;&#x5176;&#x4E2D;&#x6709;&#x4E00;&#x4E2A;&#x65B9;&#x6CD5;&#x5B9E;&#x73B0;&#x4E86;&#x52A0;&#x6CD5;&#x7684;&#x529F;&#x80FD;&#xFF0C;&#x7136;&#x540E;&#x5728;so&#x5E93;&#x4E2D;&#xFF0C;&#x5BFB;&#x627E;&#x5230;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x7684;&#x6307;&#x4EE4;&#x4EE3;&#x7801;&#xFF0C;&#x5C06;&#x5176;&#x4FEE;&#x6539;&#x6210;&#x51CF;&#x6CD5;&#x3002;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestAdd</span> </span>{</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> a,<span class="keyword">int</span> b)</span></span>{</span><br><span class="line">		<span class="keyword">int</span> c;</span><br><span class="line">		c = a + b;</span><br><span class="line">		<span class="keyword">return</span> c;</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h1 id="2-Dex&#x6587;&#x4EF6;&#x5E03;&#x5C40;"><a href="#2-Dex&#x6587;&#x4EF6;&#x5E03;&#x5C40;" class="headerlink" title="2.Dex&#x6587;&#x4EF6;&#x5E03;&#x5C40;"></a>2.Dex&#x6587;&#x4EF6;&#x5E03;&#x5C40;</h1><p>&#x9996;&#x5148;&#x8BF4;&#x660E;&#x4E00;&#x4E2A;&#x4E0B;&#x9762;&#x4F1A;&#x7528;&#x5230;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;</p>
<h2 id="leb128"><a href="#leb128" class="headerlink" title="leb128"></a>leb128</h2><p>LEB128 &#xFF08; little endian base 128 ) &#x683C;&#x5F0F; &#xFF0C;&#x662F;&#x57FA;&#x4E8E; 1 &#x4E2A; Byte &#x7684;&#x4E00;&#x79CD;&#x4E0D;&#x5B9A;&#x957F;&#x5EA6;&#x7684;&#x7F16;&#x7801;&#x65B9;&#x5F0F; &#x3002;&#x4E0D;&#x5B9A;&#x957F;&#x5EA6;&#x662F;&#x6307;&#x53D6;&#x6BCF;&#x4E2A;&#x5B57;&#x8282;&#x7684;&#x6700;&#x9AD8;&#x4F4D;&#x5F53;&#x505A;&#x6807;&#x5FD7;&#x4F4D;&#xFF0C;&#x82E5;&#x4E00;&#x4E2A;&#x5B57;&#x8282;&#x7684;&#x6700;&#x9AD8;&#x4F4D;&#x4E3A;1&#xFF0C;&#x5219;&#x8868;&#x793A;&#x4E0B;&#x4E2A;&#x5B57;&#x8282;&#x7684;&#x5185;&#x5BB9;&#x4E5F;&#x5C5E;&#x4E8E;&#x8FD9;&#x4E2A;&#x6570;&#x503C;&#xFF0C;&#x76F4;&#x5230;&#x4E00;&#x4E2A;&#x5B57;&#x8282;&#x7684;&#x6700;&#x9AD8;&#x4F4D;&#x4E3A;0&#xFF0C;&#x5C31;&#x76F8;&#x5F53;&#x4E8E;&#x5B57;&#x7B26;&#x4E32;&#x7684;&#x201D;\0&#x201D;&#x3002;&#x6BD4;&#x5982;leb128 0x0c2e&#x3002;</p>
<table>
<thead>
<tr>
<th>0x0c</th>
<th>0x2e</th>
</tr>
</thead>
<tbody>
<tr>
<td>0000 1100</td>
<td>1010 1110</td>
</tr>
</tbody>
</table>
<p>&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x9AD8;&#x4F4D;&#x5B57;&#x8282;&#x7684;0x0c&#x7684;&#x6700;&#x9AD8;&#x4F4D;&#x4E3A;0&#x3002;<br>&#x90A3;&#x4E48;&#x8FD9;&#x4E2A;&#x6570;&#x503C;&#x8868;&#x793A;&#x591A;&#x5C11;&#xFF1F;&#x8F6C;&#x6362;&#x8FC7;&#x7A0B;&#x5982;&#x4E0B;</p>
<table>
<thead>
<tr>
<th>&#x8F6C;&#x6362;&#x8FC7;&#x7A0B;</th>
<th>&#x6570;&#x503C;</th>
</tr>
</thead>
<tbody>
<tr>
<td>&#x539F;&#x59CB;&#x6570;&#x636E;</td>
<td>0000 1100   1010 1110</td>
</tr>
<tr>
<td>&#x56E0;&#x4E3A;&#x6700;&#x9AD8;&#x4F4D;&#x662F;&#x6807;&#x5FD7;&#x4F4D;&#xFF0C;&#x6240;&#x4EE5;&#x5220;&#x53BB;&#x6700;&#x9AD8;&#x4F4D;</td>
<td>000 1100   010 1110</td>
</tr>
<tr>
<td>&#x6309;4bit&#x4ECE;&#x4F4E;&#x5230;&#x9AD8;&#x91CD;&#x65B0;&#x7EC4;&#x5408;</td>
<td>00 0110 0010 1110</td>
</tr>
<tr>
<td>&#x7ED3;&#x679C;</td>
<td>0x062e</td>
</tr>
</tbody>
</table>
<p>&#x8FD9;&#x79CD;&#x6570;&#x636E;&#x683C;&#x5F0F;&#x76F8;&#x5BF9;&#x4E8E;int&#x53EF;&#x4EE5;&#x6709;&#x6548;&#x7684;&#x964D;&#x4F4E;&#x5185;&#x5B58;&#x4F7F;&#x7528;</p>
<p>&#x5E95;&#x5C42;&#x4EE3;&#x7801;&#x4F4D;&#x4E8E;&#xFF1A;<code>android/dalvik/libdex/leb128.h</code></p>
<hr>
<p>dex&#x6587;&#x4EF6;&#x53EF;&#x4EE5;&#x5206;&#x4E3A;3&#x4E2A;&#x90E8;&#x5206;&#xFF0C;&#x5206;&#x522B;&#x662F;&#x6587;&#x4EF6;&#x5934;&#x3001;&#x7D22;&#x5F15;&#x533A;&#x3001;&#x6570;&#x636E;&#x533A;&#x3002;&#x56FE;&#x7247;&#x6765;&#x81EA;&#x56DB;&#x54E5;&#x7684;&#x535A;&#x5BA2;&#x3002;</p>
<p><img src="/2019/11/23/2019-12-23 &#x901A;&#x8FC7;&#x5728;native&#x5C42;&#x52A8;&#x6001;&#x4FEE;&#x6539;&#x5185;&#x5B58;&#x4E2D;&#x7684;Dalvik&#x6307;&#x4EE4;&#x6765;&#x5B66;&#x4E60;Dex&#x6587;&#x4EF6;&#x683C;&#x5F0F;/&#x901A;&#x8FC7;&#x5728;native&#x5C42;&#x52A8;&#x6001;&#x4FEE;&#x6539;&#x5185;&#x5B58;&#x4E2D;&#x7684;Dalvik&#x6307;&#x4EE4;&#x6765;&#x5B66;&#x4E60;Dex&#x6587;&#x4EF6;&#x683C;&#x5F0F;/Center-20191123224929316.png" alt="img" style="zoom:75%;"></p>
<h2 id="&#x6587;&#x4EF6;&#x5934;"><a href="#&#x6587;&#x4EF6;&#x5934;" class="headerlink" title="&#x6587;&#x4EF6;&#x5934;"></a>&#x6587;&#x4EF6;&#x5934;</h2><p>&#x56FE;&#x4E2D;magic&#x5E94;&#x8BE5;&#x4E3A;64bit&#xFF0C;8byte</p>
<p><img src="/2019/11/23/2019-12-23 &#x901A;&#x8FC7;&#x5728;native&#x5C42;&#x52A8;&#x6001;&#x4FEE;&#x6539;&#x5185;&#x5B58;&#x4E2D;&#x7684;Dalvik&#x6307;&#x4EE4;&#x6765;&#x5B66;&#x4E60;Dex&#x6587;&#x4EF6;&#x683C;&#x5F0F;/&#x901A;&#x8FC7;&#x5728;native&#x5C42;&#x52A8;&#x6001;&#x4FEE;&#x6539;&#x5185;&#x5B58;&#x4E2D;&#x7684;Dalvik&#x6307;&#x4EE4;&#x6765;&#x5B66;&#x4E60;Dex&#x6587;&#x4EF6;&#x683C;&#x5F0F;/16729fada031bdd6.png" alt="img" style="zoom:80%;"></p>
<p><img src="/2019/11/23/2019-12-23 &#x901A;&#x8FC7;&#x5728;native&#x5C42;&#x52A8;&#x6001;&#x4FEE;&#x6539;&#x5185;&#x5B58;&#x4E2D;&#x7684;Dalvik&#x6307;&#x4EE4;&#x6765;&#x5B66;&#x4E60;Dex&#x6587;&#x4EF6;&#x683C;&#x5F0F;/image-20200307123117353.png" alt="image-20200307123117353" style="zoom:70%;"></p>
<p>&#x6587;&#x4EF6;&#x5934;&#x63CF;&#x8FF0;&#x4E86;&#x6574;&#x4E2A;dex&#x6587;&#x4EF6;&#x7684;&#x6587;&#x4EF6;&#x4FE1;&#x606F;&#xFF0C;&#x5404;&#x4E2A;&#x7D22;&#x5F15;&#x5206;&#x533A;&#x7684;&#x5927;&#x5C0F;&#x548C;&#x504F;&#x79FB;&#x5730;&#x5740;&#xFF0C;&#x8FD9;&#x4E2A;&#x504F;&#x79FB;&#x5730;&#x5740;&#x662F;&#x76F8;&#x5BF9;&#x4E8E;&#x6587;&#x4EF6;&#x8D77;&#x59CB;&#x5730;&#x5740;&#x7684;&#x504F;&#x79FB;&#x3002;&#x903B;&#x8F91;&#x4E0A;&#x7528;header_item&#x7ED3;&#x6784;&#x4F53;&#x8868;&#x793A;&#x3002;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">ubyte <span class="number">8</span>-bit unsinged <span class="keyword">int</span></span><br><span class="line">uint  <span class="number">32</span>-bit <span class="keyword">unsigned</span> <span class="keyword">int</span>, little-endian</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">header_item</span> </span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">	ubyte[<span class="number">8</span>]  magic;</span><br><span class="line">	unit      checksum; </span><br><span class="line">	ubyte[<span class="number">20</span>] signature; </span><br><span class="line">	uint      file_size; </span><br><span class="line">	uint      header_size; </span><br><span class="line">	unit      endian_tag; </span><br><span class="line">	uint      link_size; </span><br><span class="line">	uint      link_off; </span><br><span class="line">	uint      map_off;</span><br><span class="line">	uint      string_ids_size;	<span class="comment">//60</span></span><br><span class="line">	uint      string_ids_off;		<span class="comment">//64</span></span><br><span class="line">	uint      type_ids_size; </span><br><span class="line">	uint      type_ids_off; </span><br><span class="line">	uint      proto_ids_size; </span><br><span class="line">	uint      proto_ids_off; </span><br><span class="line">	uint      method_ids_size; </span><br><span class="line">	uint      method_ids_off; </span><br><span class="line">	uint      class_defs_size; </span><br><span class="line">	uint      class_defs_off; </span><br><span class="line">	uint      data_size;</span><br><span class="line">	uint      data_off; </span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h2 id="&#x7D22;&#x5F15;&#x533A;"><a href="#&#x7D22;&#x5F15;&#x533A;" class="headerlink" title="&#x7D22;&#x5F15;&#x533A;"></a>&#x7D22;&#x5F15;&#x533A;</h2><h3 id="string-ids"><a href="#string-ids" class="headerlink" title="string_ids"></a>string_ids</h3><p>string_ids &#x533A;&#x63CF;&#x8FF0;&#x4E86; .dex &#x6587;&#x4EF6;&#x6240;&#x6709;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#x3002;&#x5728;&#x5B9E;&#x4F8B;&#x4E2D;&#xFF0C;&#x5728;&#x5DF2;&#x77E5;&#x901A;&#x8FC7;&#x7C7B;&#x548C;&#x65B9;&#x6CD5;&#x540D;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x901A;&#x8FC7;&#x904D;&#x5386;string_data_off&#x6307;&#x5411;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#xFF0C;&#x83B7;&#x5F97;string_ids_item&#x7ED3;&#x6784;&#x4F53;&#x6570;&#x7EC4;&#x7684;&#x4E0B;&#x6807;index&#xFF0C;&#x8FD9;&#x4E2A;index&#x548C;&#x540E;&#x9762;&#x7684;type_ids&#x533A;&#x3001;method_ids&#x533A;&#x5BC6;&#x5207;&#x76F8;&#x5173;&#x3002;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">string_ids_item</span>{</span></span><br><span class="line">		uint string_data_off;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x5728;&#x5B9E;&#x4F8B;&#x4E2D;&#xFF0C;&#x901A;&#x8FC7;&#x5B57;&#x7B26;&#x4E32;&#x627E;&#x5230;string_ids_item&#x7684;&#x7ED3;&#x6784;&#x4F53;&#x6570;&#x7EC4;&#x4E0B;&#x6807;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getStrIdx</span><span class="params">(<span class="keyword">int</span> search_start_position, <span class="keyword">char</span> *target_string,<span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">int</span> index;</span><br><span class="line">    <span class="keyword">int</span> stringidsoff;</span><br><span class="line">    <span class="keyword">int</span> stringdataoff;</span><br><span class="line">    <span class="keyword">int</span> *stringaddress;</span><br><span class="line">    <span class="keyword">int</span> string_num_mutf8;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//header_item-&gt;string_ids_size</span></span><br><span class="line">    <span class="keyword">if</span>(*(<span class="keyword">int</span> *)(search_start_position + <span class="number">56</span>)) </span><br><span class="line">    {</span><br><span class="line">        index = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//header_item-&gt;string_ids_off</span></span><br><span class="line">        stringidsoff = search_start_position + *(<span class="keyword">int</span> *)(search_start_position+<span class="number">60</span>);</span><br><span class="line">        <span class="keyword">while</span>(<span class="number">1</span>) {</span><br><span class="line">            stringdataoff = *(<span class="keyword">int</span> *)stringidsoff;</span><br><span class="line">            stringidsoff +=<span class="number">4</span>;</span><br><span class="line">            stringaddress = (<span class="keyword">int</span> *)(search_start_position + stringdataoff);</span><br><span class="line">            string_num_mutf8 = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span>( readUleb128(stringaddress,(<span class="keyword">int</span>)&amp;string_num_mutf8) == size</span><br><span class="line">                &amp;&amp; !<span class="built_in">strncmp</span>((<span class="keyword">char</span> *)stringaddress + string_num_mutf8,target_string,size))</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            ++index;</span><br><span class="line">            <span class="keyword">if</span>(*(<span class="keyword">int</span> *)(search_start_position+<span class="number">56</span>) &lt;= index ) {</span><br><span class="line">                index = <span class="number">-1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }<span class="keyword">else</span> {</span><br><span class="line">        index = <span class="number">-1</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> index;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="type-ids"><a href="#type-ids" class="headerlink" title="type_ids"></a>type_ids</h3><p>type_ids&#x533A;&#x7D22;&#x5F15;&#x4E86; dex &#x6587;&#x4EF6;&#x91CC;&#x7684;&#x6240;&#x6709;&#x6570;&#x636E;&#x7C7B;&#x578B; &#xFF0C;&#x5305;&#x62EC; class &#x7C7B;&#x578B; &#xFF0C;&#x6570;&#x7EC4;&#x7C7B;&#x578B;&#xFF08;array types&#xFF09;&#x548C;&#x57FA;&#x672C;&#x7C7B;&#x578B;(primitive types) &#xFF0C;&#x5176;&#x4E2D;descriptor_idx&#x5BF9;&#x5E94;&#x4E8E;&#x4E0A;&#x9762;&#x63D0;&#x5230;&#x7684;string_ids_item&#x7ED3;&#x6784;&#x4F53;&#x6570;&#x7EC4;&#x7684;&#x4E0B;&#x6807;&#x3002;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">type_ids_item</span>{</span></span><br><span class="line">		uint descriptor_idx;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x901A;&#x8FC7;string_idx_item&#x7684;&#x4E0B;&#x6807;&#xFF0C;&#x627E;&#x5230;type_ids_item&#x7684;&#x4E0B;&#x6807;&#x7684;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF0C;&#x540E;&#x9762;&#x4F1A;&#x8BF4;&#x660E;&#x8FD9;&#x4E48;&#x7D22;&#x5F15;&#x7684;&#x7ED3;&#x679C;&#x662F;&#x4EC0;&#x4E48;&#x3002;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">signed</span> <span class="keyword">int</span> <span class="title">getTypeIdx</span><span class="params">(<span class="keyword">int</span> search_start_position, <span class="keyword">int</span> strIdx)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">int</span> typeIdsSize;</span><br><span class="line">    <span class="keyword">int</span> typeIdsOff;</span><br><span class="line">    <span class="keyword">int</span> typeid_to_stringid;</span><br><span class="line">    <span class="keyword">signed</span> <span class="keyword">int</span> result;</span><br><span class="line">    <span class="keyword">int</span> next_typeIdsOff;</span><br><span class="line">    <span class="keyword">int</span> next_typeid_to_stringid;</span><br><span class="line"></span><br><span class="line">    typeIdsSize = *(<span class="keyword">int</span> *)(search_start_position + <span class="number">64</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !typeIdsSize )</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    typeIdsOff = search_start_position + *(<span class="keyword">int</span> *)(search_start_position + <span class="number">68</span>);</span><br><span class="line">    typeid_to_stringid = *(<span class="keyword">int</span> *)typeIdsOff;</span><br><span class="line">    result = <span class="number">0</span>;</span><br><span class="line">    next_typeIdsOff = typeIdsOff + <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">if</span> ( typeid_to_stringid != strIdx )</span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">        {</span><br><span class="line">            ++result;</span><br><span class="line">            <span class="keyword">if</span> ( result == typeIdsSize )</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            next_typeid_to_stringid = *(<span class="keyword">int</span> *)next_typeIdsOff;</span><br><span class="line">            next_typeIdsOff += <span class="number">4</span>;</span><br><span class="line">            <span class="keyword">if</span> ( next_typeid_to_stringid == strIdx )</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> result;<span class="comment">//&#x8FD4;&#x56DE;&#x4E0B;&#x6807;</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="method-ids"><a href="#method-ids" class="headerlink" title="method_ids"></a>method_ids</h3><p>method_ids&#x8BB0;&#x5F55;&#x4E86;dex&#x6587;&#x4EF6;&#x4E2D;&#x7684;&#x65B9;&#x6CD5;&#x4FE1;&#x606F;&#xFF0C;&#x901A;&#x8FC7;string_idx&#x7684;&#x4E0B;&#x6807;&#x548C;type_idx&#x7684;&#x4E0B;&#x6807;&#xFF0C;&#x53EF;&#x4EE5;&#x7D22;&#x5F15;&#x5230;&#x6307;&#x5B9A;&#x7684;method_ids&#x7ED3;&#x6784;&#x4F53;&#x3002;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">method_ids_item</span>{</span></span><br><span class="line">		ushort class_idx;</span><br><span class="line">		ushort proto_idx;</span><br><span class="line">		uint name_idx;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x5728;&#x5B9E;&#x4F8B;&#x4E2D;&#xFF0C;&#x7D22;&#x5F15;&#x6307;&#x5B9A;&#x65B9;&#x6CD5;&#x7684;&#x7ED3;&#x6784;&#x4F53;&#xFF0C;&#x83B7;&#x53D6;method_ids&#x4E0B;&#x6807;&#x7684;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span>  <span class="title">getMethodIdx</span><span class="params">(<span class="keyword">int</span> search_start_position, <span class="keyword">int</span> method_strIdx, <span class="keyword">int</span> class_typeIdx)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">int</span> methodIdsSize;</span><br><span class="line">    <span class="keyword">int</span> classIdx;</span><br><span class="line">    <span class="keyword">signed</span> <span class="keyword">int</span> result;</span><br><span class="line"></span><br><span class="line">    methodIdsSize = *(<span class="keyword">int</span> *)(search_start_position + <span class="number">88</span>);<span class="comment">//header_item-&gt;methodIdsSize</span></span><br><span class="line">    <span class="keyword">if</span> ( methodIdsSize )</span><br><span class="line">    {</span><br><span class="line">        classIdx = search_start_position + *(<span class="keyword">int</span> *)(search_start_position + <span class="number">92</span>);<span class="comment">//header_item-&gt;methodIdsOff</span></span><br><span class="line">        result = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> ( *(<span class="keyword">short</span> *)classIdx != class_typeIdx || *(<span class="keyword">int</span> *)(classIdx + <span class="number">4</span>) != method_strIdx )</span><br><span class="line">        {</span><br><span class="line">            ++result;</span><br><span class="line">            classIdx += <span class="number">8</span>;</span><br><span class="line">            <span class="keyword">if</span> ( result == methodIdsSize )</span><br><span class="line">            {result = <span class="number">-1</span>;<span class="keyword">break</span>;}</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    {</span><br><span class="line">        result = <span class="number">-1</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h2 id="&#x6570;&#x636E;&#x533A;"><a href="#&#x6570;&#x636E;&#x533A;" class="headerlink" title="&#x6570;&#x636E;&#x533A;"></a>&#x6570;&#x636E;&#x533A;</h2><h3 id="class-defs"><a href="#class-defs" class="headerlink" title="class_defs"></a>class_defs</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">class_def_item</span></span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">	uint class_idx;     	<span class="comment">//--&gt;type_ids   </span></span><br><span class="line">	uint access_flags;		</span><br><span class="line">	uint superclass_idx;	<span class="comment">//--&gt;type_ids</span></span><br><span class="line">	uint interface_off;     <span class="comment">//--&gt;type_list</span></span><br><span class="line">	uint source_file_idx;	<span class="comment">//--&gt;string_ids</span></span><br><span class="line">	uint annotations_off;	<span class="comment">//--&gt;annotation_directory_item</span></span><br><span class="line">	uint class_data_off;	<span class="comment">//--&gt;class_data_item</span></span><br><span class="line">	uint static_value_off;	<span class="comment">//--&gt;encoded_array_item</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getClassItem</span><span class="params">(<span class="keyword">int</span> search_start_position, <span class="keyword">int</span> class_typeIdx)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">int</span> classDefsSize;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> classDefsOff;</span><br><span class="line">    <span class="keyword">int</span> result;</span><br><span class="line">    <span class="keyword">int</span> classIdx;</span><br><span class="line">    <span class="keyword">int</span> count;</span><br><span class="line"></span><br><span class="line">    classDefsSize = *(<span class="keyword">int</span> *)(search_start_position + <span class="number">96</span>);</span><br><span class="line">    classDefsOff = *(<span class="keyword">int</span> *)(search_start_position + <span class="number">100</span>);</span><br><span class="line">    result = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (classDefsSize)</span><br><span class="line">    {</span><br><span class="line">        classIdx = search_start_position + classDefsOff;</span><br><span class="line">        result = classIdx;</span><br><span class="line">        <span class="keyword">if</span> ( *(<span class="keyword">int</span> *)classIdx != class_typeIdx)</span><br><span class="line">        {</span><br><span class="line">            count = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">            {</span><br><span class="line">                ++count;</span><br><span class="line">                <span class="keyword">if</span> (count == classDefsSize)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                result += <span class="number">32</span>;</span><br><span class="line">                <span class="keyword">if</span> ( *(<span class="keyword">int</span> *)(result) == class_typeIdx)</span><br><span class="line">                    <span class="keyword">return</span> result;</span><br><span class="line">            }</span><br><span class="line">            result = <span class="number">0</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> result;<span class="comment">//&#x8FD4;&#x56DE;class_def_item&#x7ED3;&#x6784;&#x4F53;&#x7684;&#x5730;&#x5740;</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="class-data-item"><a href="#class-data-item" class="headerlink" title="class_data_item"></a>class_data_item</h3><p>class_data_item&#x7ED3;&#x6784;&#x4F53;&#x63CF;&#x8FF0;&#x4E86;static&#x5B57;&#x6BB5;&#xFF0C;&#x7C7B;&#x5B57;&#x6BB5;&#xFF0C;static&#x65B9;&#x6CD5;&#xFF0C;&#x7C7B;&#x65B9;&#x6CD5;&#x7B49;&#x4FE1;&#x606F;&#x3002;&#x5176;&#x4E2D;<code>direct_methods</code>&#x548C;<code>virtual_methods</code>&#x662F;&#x7ED3;&#x6784;&#x4F53;&#x6570;&#x7EC4;&#xFF0C;&#x4E00;&#x4E2A;&#x65B9;&#x6CD5;&#x5BF9;&#x5E94;&#x4E00;&#x4E2A;&#x6570;&#x7EC4;&#x5143;&#x7D20;&#x3002;&#x8FD9;&#x4E2A;&#x7ED3;&#x6784;&#x4F53;&#x4E3B;&#x8981;&#x901A;&#x8FC7;class_defs&#x7ED3;&#x6784;&#x4F53;&#x7684;class_data_off&#x5B57;&#x6BB5;&#x7D22;&#x5F15;&#x3002;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">class_data_item</span></span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">	uleb128 static_fields_size;</span><br><span class="line">	uleb128 instance_fields_size;</span><br><span class="line">	uleb128 direct_methods_size;</span><br><span class="line">	uleb128 virtual_methods_size;</span><br><span class="line">	encoded_field  static_fields[static_fields_size];</span><br><span class="line">	encoded_field  instance_fields[instance_fields_size];</span><br><span class="line">	encoded_method direct_methods[direct_methods_size];</span><br><span class="line">	encoded_method virtual_methods[virtual_methods_size];</span><br><span class="line">}</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">encoded_field</span></span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">	uleb128 filed_idx_diff; </span><br><span class="line">	uleb128 access_flags;  </span><br><span class="line">}</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">encoded_method</span></span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">	uleb128 method_idx_diff; </span><br><span class="line">	uleb128 access_flags; </span><br><span class="line">	uleb128 code_off;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>encoded_method&#x7ED3;&#x6784;&#x4F53;&#x7684;<code>code_off</code>&#x4E00;&#x4E2A;&#x6307;&#x5411; data &#x533A;&#x7684;&#x504F;&#x79FB;&#x5730;&#x5740; &#xFF0C;&#x76EE;&#x6807;&#x662F; method &#x7684;&#x4EE3;&#x7801;&#x5B9E;&#x73B0; &#xFF0C;&#x88AB;&#x6307;&#x5411;&#x7684;&#x7ED3;&#x6784;&#x662F;code_item&#xFF0C;&#x800C;<code>method_idx_diff</code>&#x5B57;&#x6BB5;&#x524D;&#x7F00; methd_idx &#x8868;&#x793A;&#x5B83;&#x7684;&#x503C;&#x662F; method_ids &#x7684;&#x4E00;&#x4E2A; &#x4E0B;&#x6807;&#xFF0C;&#x540E;&#x7F00; _diff &#x8868;&#x793A;&#x5B83;&#x662F;&#x4E8E;&#x53E6;&#x5916;&#x4E00;&#x4E2A; method_idx &#x7684;&#x4E00;&#x4E2A;&#x5DEE;&#x503C; &#xFF0C;&#x5C31;&#x662F;&#x76F8;&#x5BF9;&#x4E8E; encodeed_method [] &#x6570;&#x7EC4;&#x91CC;&#x4E0A;&#x4E00;&#x4E2A;&#x5143;&#x7D20;&#x7684; method_idx &#x7684;&#x5DEE;&#x503C;&#x3002;<br>&#x5982;&#x4E0B;&#x4E24;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x7B2C;&#x4E00;&#x4E2A;&#x662F;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#xFF0C;&#x7B2C;&#x4E8C;&#x4E2A;&#x662F;&#x5B9A;&#x4E49;&#x7684;direct&#x65B9;&#x6CD5;&#xFF1A;<br><img src="/2019/11/23/2019-12-23 &#x901A;&#x8FC7;&#x5728;native&#x5C42;&#x52A8;&#x6001;&#x4FEE;&#x6539;&#x5185;&#x5B58;&#x4E2D;&#x7684;Dalvik&#x6307;&#x4EE4;&#x6765;&#x5B66;&#x4E60;Dex&#x6587;&#x4EF6;&#x683C;&#x5F0F;/image-20191205151233427.png" alt="image-20191205151233427"></p>
<p><strong>direct_methods</strong><br>&#x5B9A;&#x4E49;&#x7684;&#x76F4;&#x63A5;&#xFF08;static&#x3001;private &#x6216;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#x7684;&#x4EFB;&#x4F55;&#x4E00;&#x4E2A;&#xFF09;&#x65B9;&#x6CD5;&#xFF1B;&#x4EE5;&#x4E00;&#x7CFB;&#x5217;&#x7F16;&#x7801;&#x5143;&#x7D20;&#x7684;&#x5F62;&#x5F0F;&#x8868;&#x793A;&#x3002;&#x8FD9;&#x4E9B;&#x65B9;&#x6CD5;&#x5FC5;&#x987B;&#x6309; method_idx &#x4EE5;&#x5347;&#x5E8F;&#x8FDB;&#x884C;&#x6392;&#x5E8F;&#x3002;</p>
<p><strong>virtual_methods</strong><br>&#x5B9A;&#x4E49;&#x7684;&#x865A;&#x62DF;&#xFF08;&#x975E; static&#x3001;private &#x6216;&#x6784;&#x9020;&#x51FD;&#x6570;&#xFF09;&#x65B9;&#x6CD5;&#xFF1B;&#x4EE5;&#x4E00;&#x7CFB;&#x5217;&#x7F16;&#x7801;&#x5143;&#x7D20;&#x7684;&#x5F62;&#x5F0F;&#x8868;&#x793A;&#x3002;&#x6B64;&#x5217;&#x8868;&#x4E0D;&#x5F97;&#x5305;&#x62EC;&#x7EE7;&#x627F;&#x65B9;&#x6CD5;&#xFF0C;&#x9664;&#x975E;&#x88AB;&#x6B64;&#x9879;&#x6240;&#x8868;&#x793A;&#x7684;&#x7C7B;&#x8986;&#x76D6;&#x3002;&#x8FD9;&#x4E9B;&#x65B9;&#x6CD5;&#x5FC5;&#x987B;&#x6309; method_idx &#x4EE5;&#x5347;&#x5E8F;&#x8FDB;&#x884C;&#x6392;&#x5E8F;&#x3002;&#x865A;&#x62DF;&#x65B9;&#x6CD5;&#x7684; method_idx &#x4E0D;&#x5F97;&#x4E0E;&#x4EFB;&#x4F55;&#x76F4;&#x63A5;&#x65B9;&#x6CD5;&#x76F8;&#x540C;&#x3002;</p>
<h3 id="code-item"><a href="#code-item" class="headerlink" title="code_item"></a>code_item</h3><p>code_item&#x7ED3;&#x6784;&#x4F53;&#x63CF;&#x8FF0;&#x4E86;&#x67D0;&#x4E2A; method &#x7684;&#x5177;&#x4F53;&#x5B9E;&#x73B0;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">code_item</span></span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">ushort registers_size;</span><br><span class="line">ushort ins_size;</span><br><span class="line">ushort outs_size;</span><br><span class="line">ushort tries_size;</span><br><span class="line">uint debug_info_off;</span><br><span class="line">uint insns_size;<span class="comment">//&#x6307;&#x4EE4;&#x4E2A;&#x6570;</span></span><br><span class="line">ushort insns [ insns_size ];</span><br><span class="line">ushort paddding; <span class="comment">// optional</span></span><br><span class="line">try_item tries [ tyies_size ]; <span class="comment">// optional</span></span><br><span class="line">encoded_catch_handler_list handlers; <span class="comment">// optional</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x901A;&#x8FC7;&#x4E00;&#x4E2A;&#x7C7B;&#x7684;class_data_item&#x5730;&#x5740;&#x548C;&#x5176;&#x65B9;&#x6CD5;&#x7684;method_idx&#x83B7;&#x53D6;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x5BF9;&#x5E94;&#x7684;code_item&#x7ED3;&#x6784;&#x7684;&#x4EE3;&#x7801;&#x5982;&#x4E0B;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getCodeItem</span><span class="params">(<span class="keyword">int</span> search_start_position, <span class="keyword">int</span> class_def_item_address, <span class="keyword">int</span> methodIdx)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> *classDataOff;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> staticFieldsSize;</span><br><span class="line">    <span class="keyword">int</span> *classDataOff_new_start;</span><br><span class="line">    <span class="keyword">int</span> instanceFieldsSize;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> directMethodsSize;</span><br><span class="line">    <span class="keyword">int</span> virtualMethodSize;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> *after_skipstaticfield_address;</span><br><span class="line">    <span class="keyword">int</span> *DexMethod_start_address;</span><br><span class="line">    <span class="keyword">int</span> result;</span><br><span class="line">    <span class="keyword">int</span> DexMethod_methodIdx;</span><br><span class="line">    <span class="keyword">int</span> *DexMethod_accessFlagsstart_address;</span><br><span class="line">    <span class="keyword">int</span> Uleb_bytes_read;</span><br><span class="line">    <span class="keyword">int</span> tmp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//&#x83B7;&#x53D6;DexClassData&#x7ED3;&#x6784;&#x4F53;&#x7684;&#x5730;&#x5740;</span></span><br><span class="line">    classDataOff = (<span class="keyword">int</span> *)(*(<span class="keyword">int</span> *)(class_def_item_address + <span class="number">24</span>) + search_start_position);</span><br><span class="line">    LOGD(<span class="string">&quot; classDataOff = %x&quot;</span>, classDataOff);</span><br><span class="line"></span><br><span class="line">    Uleb_bytes_read = <span class="number">0</span>;</span><br><span class="line">    staticFieldsSize = readUleb128(classDataOff, (<span class="keyword">int</span>)&amp;Uleb_bytes_read);</span><br><span class="line">    LOGD(<span class="string">&quot;staticFieldsSize= %d&quot;</span>,staticFieldsSize);</span><br><span class="line"></span><br><span class="line">    classDataOff_new_start = (<span class="keyword">int</span> *)((<span class="keyword">char</span> *)classDataOff + Uleb_bytes_read);</span><br><span class="line">    LOGD(<span class="string">&quot;staticFieldsSize_addr= %x&quot;</span>,classDataOff_new_start);</span><br><span class="line"></span><br><span class="line">    instanceFieldsSize = readUleb128(classDataOff_new_start, (<span class="keyword">int</span>)&amp;Uleb_bytes_read);</span><br><span class="line">    LOGD(<span class="string">&quot;instanceFieldsSize= %d&quot;</span>,instanceFieldsSize);</span><br><span class="line"></span><br><span class="line">    classDataOff_new_start = (<span class="keyword">int</span> *)((<span class="keyword">char</span> *)classDataOff_new_start + Uleb_bytes_read);</span><br><span class="line">    LOGD(<span class="string">&quot;instanceFieldsSize_addr= %x&quot;</span>,classDataOff_new_start);</span><br><span class="line"></span><br><span class="line">    directMethodsSize = readUleb128(classDataOff_new_start, (<span class="keyword">int</span>)&amp;Uleb_bytes_read);</span><br><span class="line">    LOGD(<span class="string">&quot;directMethodsSize= %d&quot;</span>,directMethodsSize);</span><br><span class="line"></span><br><span class="line">    classDataOff_new_start  = (<span class="keyword">int</span> *)((<span class="keyword">char</span> *)classDataOff_new_start + Uleb_bytes_read);</span><br><span class="line">    LOGD(<span class="string">&quot;directMethod_addr= %x&quot;</span>,classDataOff_new_start);</span><br><span class="line"></span><br><span class="line">    virtualMethodSize = readUleb128(classDataOff_new_start, (<span class="keyword">int</span>)&amp;Uleb_bytes_read);</span><br><span class="line">    LOGD(<span class="string">&quot;virtualMethodsSize= %d&quot;</span>,virtualMethodSize);</span><br><span class="line"></span><br><span class="line">    after_skipstaticfield_address = skipUleb128(<span class="number">2</span> * staticFieldsSize, (<span class="keyword">int</span> *)((<span class="keyword">char</span> *)classDataOff_new_start + Uleb_bytes_read));</span><br><span class="line">    LOGD(<span class="string">&quot;after_skipstaticfield_address = %x&quot;</span>,  after_skipstaticfield_address);</span><br><span class="line"></span><br><span class="line">    DexMethod_start_address = skipUleb128(<span class="number">2</span> * instanceFieldsSize, after_skipstaticfield_address);</span><br><span class="line">    LOGD(<span class="string">&quot;DexMethod_start_address = %x&quot;</span>, DexMethod_start_address);</span><br><span class="line"></span><br><span class="line">    result = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(directMethodsSize)</span><br><span class="line">    {</span><br><span class="line">        DexMethod_methodIdx = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> DexMethod_methodIdx_tmp = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">do</span> {</span><br><span class="line"></span><br><span class="line">            DexMethod_methodIdx_tmp = <span class="number">0</span>;</span><br><span class="line">            DexMethod_methodIdx = readUleb128(DexMethod_start_address, (<span class="keyword">int</span>)&amp;Uleb_bytes_read);</span><br><span class="line">            DexMethod_methodIdx_tmp = readUleb128(DexMethod_start_address, (<span class="keyword">int</span>)&amp;Uleb_bytes_read);</span><br><span class="line"></span><br><span class="line">            LOGD(<span class="string">&quot;DexMethod_direct_methodIdx = %x&quot;</span>, DexMethod_methodIdx);</span><br><span class="line">            LOGD(<span class="string">&quot;DexMethod_direct_methodIdx_tmp = %x&quot;</span>, DexMethod_methodIdx_tmp);</span><br><span class="line"></span><br><span class="line">            DexMethod_accessFlagsstart_address = (<span class="keyword">int</span> *)((<span class="keyword">char</span> *)DexMethod_start_address + Uleb_bytes_read);</span><br><span class="line">            <span class="keyword">if</span> (DexMethod_methodIdx == methodIdx)</span><br><span class="line">            {</span><br><span class="line">                readUleb128(DexMethod_accessFlagsstart_address, (<span class="keyword">int</span>)&amp;Uleb_bytes_read);</span><br><span class="line">                <span class="keyword">return</span> readUleb128((<span class="keyword">int</span> *)((<span class="keyword">char</span> *)DexMethod_accessFlagsstart_address + Uleb_bytes_read),</span><br><span class="line">                                   (<span class="keyword">int</span>)&amp;Uleb_bytes_read) +  search_start_position;</span><br><span class="line">            }</span><br><span class="line">            --directMethodsSize;</span><br><span class="line">            DexMethod_start_address = skipUleb128(<span class="number">2</span>, DexMethod_accessFlagsstart_address);</span><br><span class="line">        }<span class="keyword">while</span> (directMethodsSize);</span><br><span class="line">        result = <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (virtualMethodSize)</span><br><span class="line">    {</span><br><span class="line">        DexMethod_methodIdx = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> DexMethod_methodIdx_tmp = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        {</span><br><span class="line">            DexMethod_methodIdx_tmp = <span class="number">0</span>;</span><br><span class="line">            DexMethod_methodIdx = readUleb128(DexMethod_start_address, (<span class="keyword">int</span>)&amp;Uleb_bytes_read);</span><br><span class="line">            DexMethod_methodIdx_tmp = readUleb128(DexMethod_start_address, (<span class="keyword">int</span>)&amp;Uleb_bytes_read);</span><br><span class="line"></span><br><span class="line">            LOGD(<span class="string">&quot;DexMethod_virtual_methodIdx = %x&quot;</span>, DexMethod_methodIdx);</span><br><span class="line">            LOGD(<span class="string">&quot;DexMethod_virtual_methodIdx_tmp = %x&quot;</span>, DexMethod_methodIdx_tmp);</span><br><span class="line"></span><br><span class="line">            DexMethod_accessFlagsstart_address = (<span class="keyword">int</span> *)((<span class="keyword">char</span> *)DexMethod_start_address + Uleb_bytes_read);</span><br><span class="line">            <span class="keyword">if</span> (DexMethod_methodIdx == methodIdx)</span><br><span class="line">            {</span><br><span class="line">                readUleb128(DexMethod_accessFlagsstart_address, (<span class="keyword">int</span>)&amp;Uleb_bytes_read);</span><br><span class="line">                <span class="keyword">return</span> readUleb128((<span class="keyword">int</span> *)((<span class="keyword">char</span> *)DexMethod_accessFlagsstart_address + Uleb_bytes_read), (<span class="keyword">int</span>)&amp;Uleb_bytes_read) +  search_start_position;</span><br><span class="line">            }</span><br><span class="line">            --virtualMethodSize;</span><br><span class="line">            DexMethod_start_address = skipUleb128(<span class="number">2</span>, DexMethod_accessFlagsstart_address);</span><br><span class="line">        }<span class="keyword">while</span> ( virtualMethodSize );</span><br><span class="line">        result = <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x8FD4;&#x56DE;&#x7684;&#x5185;&#x5BB9;&#x5C31;&#x662F;code_item&#x7ED3;&#x6784;&#x4F53;&#x7684;&#x5730;&#x5740;&#x3002;</p>
<h1 id="3-&#x5B9E;&#x4F8B;&#x8BF4;&#x660E;"><a href="#3-&#x5B9E;&#x4F8B;&#x8BF4;&#x660E;" class="headerlink" title="3. &#x5B9E;&#x4F8B;&#x8BF4;&#x660E;"></a>3. &#x5B9E;&#x4F8B;&#x8BF4;&#x660E;</h1><h2 id="&#x7ED3;&#x6784;&#x4F53;&#x4E4B;&#x95F4;&#x7684;&#x5173;&#x8054;"><a href="#&#x7ED3;&#x6784;&#x4F53;&#x4E4B;&#x95F4;&#x7684;&#x5173;&#x8054;" class="headerlink" title="&#x7ED3;&#x6784;&#x4F53;&#x4E4B;&#x95F4;&#x7684;&#x5173;&#x8054;"></a>&#x7ED3;&#x6784;&#x4F53;&#x4E4B;&#x95F4;&#x7684;&#x5173;&#x8054;</h2><p>&#x901A;&#x8FC7;&#x4E0A;&#x9762;Dex&#x6587;&#x4EF6;&#x5E03;&#x5C40;&#x7684;&#x8BF4;&#x660E;&#xFF0C;&#x603B;&#x7ED3;&#x4E00;&#x4E0B;&#x901A;&#x8FC7;&#x5982;&#x4F55;&#x901A;&#x8FC7;&#x7C7B;&#x540D;&#x548C;&#x65B9;&#x6CD5;&#x540D;&#xFF0C;&#x5728;&#x5185;&#x5B58;&#x4E2D;&#x627E;&#x5230;&#x65B9;&#x6CD5;&#x7684;&#x6307;&#x4EE4;&#x4EE3;&#x7801;</p>
<ol>
<li><p>&#x5DF2;&#x77E5;&#x7C7B;&#x540D;&#x548C;&#x65B9;&#x6CD5;&#x540D;&#xFF0C;&#x901A;&#x8FC7;&#x7D22;&#x5F15;&#x533A;&#x7684;string_idx_item&#x7ED3;&#x6784;&#x4F53;&#xFF0C;&#x83B7;&#x53D6;class_strIdx&#x548C;method_strIdx</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class_strIdx = getStrIdx(search_start_position,<span class="string">&quot;Lcom/pollux/dalvikbytecode/TestAdd;&quot;</span>,</span><br><span class="line">                             strlen(<span class="string">&quot;Lcom/pollux/dalvikbytecode/TestAdd;&quot;</span>));</span><br><span class="line">method_strIdx = getStrIdx(search_start_position,<span class="string">&quot;add&quot;</span>, <span class="number">3</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>&#x5DF2;&#x77E5;class_strIdx&#xFF0C;&#x901A;&#x8FC7;&#x7D22;&#x5F15;&#x533A;&#x7684;type_idx_item&#x7ED3;&#x6784;&#x4F53;&#xFF0C;&#x83B7;&#x53D6;class_typeIdx</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">class_typeIdx = getTypeIdx(search_start_position,class_strIdx);</span><br></pre></td></tr></table></figure>
</li>
<li><p>&#x5DF2;&#x77E5;class_typeIdx&#x548C;method_strIdx&#xFF0C;&#x901A;&#x8FC7;&#x7D22;&#x5F15;&#x533A;&#x7684;method_idx_item&#x7ED3;&#x6784;&#x4F53;&#xFF0C;&#x83B7;&#x53D6;method_typeIdx</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">methodIdx = getMethodIdx(search_start_position, method_strIdx, class_typeIdx);</span><br></pre></td></tr></table></figure>
</li>
<li><p>&#x5DF2;&#x77E5;class_typeIdx&#xFF0C;&#x83B7;&#x53D6;&#x7C7B;&#x5BF9;&#x5E94;&#x7684;class_defs_item&#x7ED3;&#x6784;&#x4F53;&#x7684;&#x5730;&#x5740;</p>
<figure class="highlight ceylon"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span><span class="number">_</span>def<span class="number">_</span>item<span class="number">_</span>address = getClassItem(search<span class="number">_</span>start<span class="number">_p</span>osition,<span class="keyword">class</span><span class="number">_</span>typeIdx);</span><br></pre></td></tr></table></figure>
</li>
<li><p>&#x6709;&#x4E86;class_defs_item&#x7ED3;&#x6784;&#x4F53;&#x7684;&#x5730;&#x5740;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x5176;class_data_off&#x5B57;&#x6BB5;&#xFF0C;&#x83B7;&#x53D6;class_data_item&#x7ED3;&#x6784;&#x4F53;&#x7684;&#x5730;&#x5740;&#xFF0C;&#x8FDB;&#x800C;&#x901A;&#x8FC7;&#x4E0A;&#x9762;&#x83B7;&#x53D6;&#x7684;method_typeIdx&#xFF0C;&#x5728;encoded_method&#x5B57;&#x6BB5;&#x4E2D;&#x627E;&#x5230;&#x65B9;&#x6CD5;&#x5BF9;&#x5E94;&#x7684;code_item&#x7ED3;&#x6784;&#x4F53;&#x5730;&#x5740;&#xFF0C;&#x800C;code_item&#x5219;&#x5305;&#x542B;&#x4E86;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x5B9E;&#x73B0;&#x7684;&#x5177;&#x4F53;&#x6307;&#x4EE4;&#x4EE3;&#x7801;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">codeItem_address = getCodeItem(search_start_position,class_def_item_address,methodIdx);</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>&#x4E4B;&#x540E;&#x5C31;&#x662F;&#x89E3;&#x6790;&#x6307;&#x4EE4;&#xFF0C;&#x6307;&#x4EE4;&#x4EE3;&#x7801;&#x5B58;&#x653E;&#x5728;code_item&#x4E2D;insns&#x5B57;&#x6BB5;&#x4E2D;&#xFF0C;2&#x5B57;&#x8282;&#x4E00;&#x4E2A;&#x5143;&#x7D20;&#xFF0C;&#x6240;&#x4EE5;&#x5982;&#x679C;code_item-&gt;insns_size=3&#xFF0C;&#x90A3;&#x4E48;&#x6307;&#x4EE4;&#x4EE3;&#x7801;&#x7684;&#x5927;&#x5C0F;&#x4E3A;3x2=6&#x5B57;&#x8282;</p>
<p>&#x9996;&#x5148;&#x83B7;&#x53D6;&#x6307;&#x4EE4;&#x7684;&#x5927;&#x5C0F;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> insnssize[<span class="number">4</span>];</span><br><span class="line"><span class="keyword">void</span> *code_insns_size = (<span class="keyword">void</span>*)(codeItem_address+<span class="number">12</span>);</span><br><span class="line"><span class="built_in">memcpy</span>(insnssize,code_insns_size,<span class="number">4</span>);</span><br><span class="line"><span class="keyword">int</span> k = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span>(;k&lt;<span class="number">4</span>;k++){</span><br><span class="line">    LOGD(<span class="string">&quot;size:%d&quot;</span>,insnssize[k]);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x63A5;&#x7740;&#x83B7;&#x53D6;&#x5177;&#x4F53;&#x7684;&#x6307;&#x4EE4;&#x4EE3;&#x7801;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> *code_insns_address;</span><br><span class="line">code_insns_address = (<span class="keyword">void</span> *)(codeItem_address+<span class="number">16</span>);</span><br><span class="line">LOGD(<span class="string">&quot;code_insns_address = %x&quot;</span>, code_insns_address);</span><br><span class="line"><span class="comment">//&#x8FD9;&#x91CC;&#x53EF;&#x4EE5;&#x5148;&#x6253;&#x5370;&#x65B9;&#x6CD5;&#x7684;&#x6307;&#x4EE4;</span></span><br><span class="line"><span class="keyword">char</span> instrans[<span class="number">6</span>];<span class="comment">//&#x8FD9;&#x91CC;&#x7684;6&#x5C31;&#x662F;insns_size*2,&#x56E0;&#x4E3A;short&#x662F;&#x4E24;&#x4E2A;&#x5B57;&#x8282;</span></span><br><span class="line"><span class="built_in">memcpy</span>(instrans, code_insns_address, <span class="number">6</span>);</span><br><span class="line"><span class="keyword">int</span> i=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span>(;i&lt;<span class="number">6</span>;i++){</span><br><span class="line">   LOGD(<span class="string">&quot;%x&quot;</span>,instrans[i]);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x5B9E;&#x73B0;&#x52A0;&#x6CD5;&#x7684;&#x6307;&#x4EE4;&#x662F;<code>90 00 02 03 0F 00</code>&#xFF0C;&#x4E00;&#x6761;&#x6307;&#x4EE4;&#x683C;&#x5F0F;&#x662F;&#x6307;&#x4EE4;&#x7801;+&#x6307;&#x4EE4;&#x64CD;&#x4F5C;&#x6570;&#xFF0C;&#x901A;&#x8FC7;&#x67E5;&#x627E;<a href="http://www.dre.vanderbilt.edu/~schmidt/android/android-4.0/dalvik/docs/dalvik-bytecode.html" target="_blank" rel="noopener">Dalvik&#x6307;&#x4EE4;&#x7684;&#x683C;&#x5F0F;</a>&#xFF0C;&#x53EF;&#x4EE5;&#x77E5;&#x9053;&#x52A0;&#x6CD5;&#x7684;&#x6307;&#x4EE4;&#x662F;0x90&#xFF0C;&#x6307;&#x4EE4;&#x683C;&#x5F0F;&#x662F;<em>binop</em> vAA, vBB, vCC</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">binop vAA, vBB, vCC</span><br><span class="line">90: add-int</span><br><span class="line">91: sub-int</span><br><span class="line">92: mul-int</span><br><span class="line">93: div-int</span><br><span class="line">94: rem-int</span><br><span class="line">95: and-int</span><br><span class="line">96: or-int</span><br><span class="line"></span><br><span class="line">A: destination register<span class="built_in"> or </span>pair (8 bits)</span><br><span class="line">B: first source register<span class="built_in"> or </span>pair (8 bits)</span><br><span class="line">C: second source register<span class="built_in"> or </span>pair (8 bits)</span><br><span class="line"></span><br><span class="line">Perform the identified binary operation on the two source registers, storing the result in the first source register.</span><br></pre></td></tr></table></figure>
<p>&#x53EF;&#x4EE5;&#x77E5;&#x9053; 00 &#x662F;0&#x53F7;&#x5BC4;&#x5B58;&#x5668;&#xFF0C;02&#x662F;&#x4E8C;&#x53F7;&#x5BC4;&#x5B58;&#x5668;&#xFF0C;03&#x662F;3&#x53F7;&#x5BC4;&#x5B58;&#x5668;&#xFF0C;&#x6240;&#x4EE5;&#x53EA;&#x8981;&#x5C06;<code>90</code>&#x4FEE;&#x6539;&#x6210;<code>91</code>&#x5C31;&#x53D8;&#x6210;&#x51CF;&#x6CD5;&#x4E86;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> *codeinsns_page_address =</span><br><span class="line">            (<span class="keyword">void</span> *)(codeItem_address + <span class="number">16</span> - (codeItem_address + <span class="number">16</span>) % (<span class="keyword">unsigned</span> <span class="keyword">int</span>)page_size);</span><br><span class="line">		<span class="comment">//&#x4FEE;&#x6539;&#x8BE5;&#x9875;&#x7684;&#x8BFB;&#x5199;&#x6743;&#x9650;</span></span><br><span class="line">    mprotect(codeinsns_page_address,page_size, PROT_READ|PROT_WRITE);</span><br><span class="line">    <span class="comment">//&#x5199;&#x5165;&#x5BF9;&#x5E94;&#x51CF;&#x6CD5;&#x7684;&#x5B57;&#x8282;&#x7801;</span></span><br><span class="line">    <span class="keyword">char</span> inject[]={<span class="number">0x91</span>,<span class="number">0x00</span>,<span class="number">0x02</span>,<span class="number">0x03</span>,<span class="number">0x0f</span>,<span class="number">0x00</span>};</span><br><span class="line">    <span class="built_in">memcpy</span>(code_insns_address,&amp;inject,<span class="number">6</span>);</span><br></pre></td></tr></table></figure>
<h1 id="4-&#x603B;&#x7ED3;"><a href="#4-&#x603B;&#x7ED3;" class="headerlink" title="4. &#x603B;&#x7ED3;"></a>4. &#x603B;&#x7ED3;</h1><p>&#x867D;&#x7136;&#x4FEE;&#x6539;&#x5185;&#x5B58;&#x4E2D;&#x7684;&#x6307;&#x4EE4;&#x6CA1;&#x6709;&#x96BE;&#x5EA6;&#xFF0C;&#x4F46;&#x662F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x8FD9;&#x4E2A;&#xFF0C;&#x53EF;&#x4EE5;&#x5B66;&#x4E60;&#x5230;Dex&#x4E2D;&#x5404;&#x4E2A;&#x6570;&#x636E;&#x4E4B;&#x95F4;&#x7684;&#x5173;&#x7CFB;&#xFF0C;&#x600E;&#x4E48;&#x901A;&#x8FC7;&#x7C7B;&#x540D;&#x548C;&#x65B9;&#x6CD5;&#x540D;&#x5728;&#x5185;&#x5B58;&#x4E2D;&#x627E;&#x5230;&#x5BF9;&#x5E94;&#x7684;&#x6307;&#x4EE4;&#x3002;&#x5B9E;&#x73B0;&#x52A0;&#x6CD5;&#x6307;&#x4EE4;&#x53D8;&#x6210;&#x51CF;&#x6CD5;&#x6307;&#x4EE4;&#x5F88;&#x5BB9;&#x6613;&#xFF0C;&#x56E0;&#x4E3A;&#x5E76;&#x6CA1;&#x6709;&#x6539;&#x53D8;&#x6307;&#x4EE4;&#x7684;&#x6574;&#x4F53;&#x957F;&#x5EA6;&#xFF0C;&#x5982;&#x679C;&#x4FEE;&#x6539;&#x590D;&#x6742;&#x7684;&#x6307;&#x4EE4;&#xFF0C;&#x5C31;&#x6709;&#x53EF;&#x80FD;&#x6539;&#x53D8;&#x6307;&#x4EE4;&#x7684;&#x957F;&#x5EA6;&#xFF0C;&#x800C;Dex&#x6587;&#x4EF6;&#x4E2D;&#x5404;&#x4E2A;&#x6570;&#x636E;&#x7684;&#x5BFB;&#x5740;&#x90FD;&#x662F;&#x76F8;&#x5BF9;&#x5730;&#x5740;&#xFF0C;&#x6240;&#x4EE5;&#x5982;&#x679C;&#x6307;&#x4EE4;&#x957F;&#x5EA6;&#x4FEE;&#x6539;&#x4E86;&#xFF0C;&#x5C31;&#x8981;&#x5BF9;&#x53EF;&#x80FD;&#x5F71;&#x54CD;&#x5230;&#x7684;&#x76F8;&#x5BF9;&#x5730;&#x5740;&#x8FDB;&#x884C;&#x4FEE;&#x590D;&#xFF0C;&#x5C31;&#x4F1A;&#x53D8;&#x5F97;&#x5F88;&#x590D;&#x6742;&#x3002;</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/11/20/2019-11-20 IDA-notebook/">IDA notebook</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-11-20</time><div class="content"><h1 id="1-&#x5E38;&#x7528;&#x5B8F;&#x5B9A;&#x4E49;"><a href="#1-&#x5E38;&#x7528;&#x5B8F;&#x5B9A;&#x4E49;" class="headerlink" title="1. &#x5E38;&#x7528;&#x5B8F;&#x5B9A;&#x4E49;"></a>1. &#x5E38;&#x7528;&#x5B8F;&#x5B9A;&#x4E49;</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   This file contains definitions used by the Hex-Rays decompiler output.</span></span><br><span class="line"><span class="comment">   It has type definitions and convenience macros to make the</span></span><br><span class="line"><span class="comment">   output more readable.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   Copyright (c) 2007-2011 Hex-Rays</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(__GNUC__)</span></span><br><span class="line">  <span class="keyword">typedef</span>          <span class="keyword">long</span> <span class="keyword">long</span> ll;</span><br><span class="line">  <span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> ull;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> __int64 long long</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> __int32 int</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> __int16 short</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> __int8  char</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> MAKELL(num) num ## LL</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> FMT_64 <span class="meta-string">&quot;ll&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(_MSC_VER)</span></span><br><span class="line">  <span class="keyword">typedef</span>          __int64 ll;</span><br><span class="line">  <span class="keyword">typedef</span> <span class="keyword">unsigned</span> __int64 ull;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> MAKELL(num) num ## i64</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> FMT_64 <span class="meta-string">&quot;I64&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined (__BORLANDC__)</span></span><br><span class="line">  <span class="keyword">typedef</span>          __int64 ll;</span><br><span class="line">  <span class="keyword">typedef</span> <span class="keyword">unsigned</span> __int64 ull;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> MAKELL(num) num ## i64</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> FMT_64 <span class="meta-string">&quot;L&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">error</span> <span class="meta-string">&quot;unknown compiler&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> uint;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> uchar;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">short</span> ushort;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> ulong;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span>          <span class="keyword">char</span>   int8;</span><br><span class="line"><span class="keyword">typedef</span>   <span class="keyword">signed</span> <span class="keyword">char</span>   sint8;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">char</span>   uint8;</span><br><span class="line"><span class="keyword">typedef</span>          <span class="keyword">short</span>  int16;</span><br><span class="line"><span class="keyword">typedef</span>   <span class="keyword">signed</span> <span class="keyword">short</span>  sint16;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">short</span>  uint16;</span><br><span class="line"><span class="keyword">typedef</span>          <span class="keyword">int</span>    int32;</span><br><span class="line"><span class="keyword">typedef</span>   <span class="keyword">signed</span> <span class="keyword">int</span>    sint32;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">int</span>    uint32;</span><br><span class="line"><span class="keyword">typedef</span> ll              int64;</span><br><span class="line"><span class="keyword">typedef</span> ll              sint64;</span><br><span class="line"><span class="keyword">typedef</span> ull             uint64;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Partially defined types:</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _BYTE  uint8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _WORD  uint16</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _DWORD uint32</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _QWORD uint64</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(_MSC_VER)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _LONGLONG __int128</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _WINDOWS_</span></span><br><span class="line"><span class="keyword">typedef</span> int8 BYTE;</span><br><span class="line"><span class="keyword">typedef</span> int16 WORD;</span><br><span class="line"><span class="keyword">typedef</span> int32 DWORD;</span><br><span class="line"><span class="keyword">typedef</span> int32 LONG;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="keyword">typedef</span> int64 QWORD;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">int</span> <span class="keyword">bool</span>;       <span class="comment">// we want to use bool in our C programs</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Some convenience macros to make partial accesses nicer</span></span><br><span class="line"><span class="comment">// first unsigned macros:</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOBYTE(x)   (*((_BYTE*)&amp;(x)))   <span class="comment">// low byte</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOWORD(x)   (*((_WORD*)&amp;(x)))   <span class="comment">// low word</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LODWORD(x)  (*((_DWORD*)&amp;(x)))  <span class="comment">// low dword</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HIBYTE(x)   (*((_BYTE*)&amp;(x)+1))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HIWORD(x)   (*((_WORD*)&amp;(x)+1))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HIDWORD(x)  (*((_DWORD*)&amp;(x)+1))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BYTEn(x, n)   (*((_BYTE*)&amp;(x)+n))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WORDn(x, n)   (*((_WORD*)&amp;(x)+n))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BYTE1(x)   BYTEn(x,  1)         <span class="comment">// byte 1 (counting from 0)</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BYTE2(x)   BYTEn(x,  2)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BYTE3(x)   BYTEn(x,  3)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BYTE4(x)   BYTEn(x,  4)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BYTE5(x)   BYTEn(x,  5)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BYTE6(x)   BYTEn(x,  6)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BYTE7(x)   BYTEn(x,  7)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BYTE8(x)   BYTEn(x,  8)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BYTE9(x)   BYTEn(x,  9)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BYTE10(x)  BYTEn(x, 10)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BYTE11(x)  BYTEn(x, 11)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BYTE12(x)  BYTEn(x, 12)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BYTE13(x)  BYTEn(x, 13)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BYTE14(x)  BYTEn(x, 14)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BYTE15(x)  BYTEn(x, 15)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WORD1(x)   WORDn(x,  1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WORD2(x)   WORDn(x,  2)         <span class="comment">// third word of the object, unsigned</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WORD3(x)   WORDn(x,  3)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WORD4(x)   WORDn(x,  4)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WORD5(x)   WORDn(x,  5)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WORD6(x)   WORDn(x,  6)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WORD7(x)   WORDn(x,  7)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// now signed macros (the same but with sign extension)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SLOBYTE(x)   (*((int8*)&amp;(x)))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SLOWORD(x)   (*((int16*)&amp;(x)))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SLODWORD(x)  (*((int32*)&amp;(x)))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SHIBYTE(x)   (*((int8*)&amp;(x)+1))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SHIWORD(x)   (*((int16*)&amp;(x)+1))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SHIDWORD(x)  (*((int32*)&amp;(x)+1))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SBYTEn(x, n)   (*((int8*)&amp;(x)+n))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SWORDn(x, n)   (*((int16*)&amp;(x)+n))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SBYTE1(x)   SBYTEn(x,  1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SBYTE2(x)   SBYTEn(x,  2)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SBYTE3(x)   SBYTEn(x,  3)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SBYTE4(x)   SBYTEn(x,  4)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SBYTE5(x)   SBYTEn(x,  5)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SBYTE6(x)   SBYTEn(x,  6)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SBYTE7(x)   SBYTEn(x,  7)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SBYTE8(x)   SBYTEn(x,  8)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SBYTE9(x)   SBYTEn(x,  9)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SBYTE10(x)  SBYTEn(x, 10)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SBYTE11(x)  SBYTEn(x, 11)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SBYTE12(x)  SBYTEn(x, 12)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SBYTE13(x)  SBYTEn(x, 13)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SBYTE14(x)  SBYTEn(x, 14)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SBYTE15(x)  SBYTEn(x, 15)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SWORD1(x)   SWORDn(x,  1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SWORD2(x)   SWORDn(x,  2)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SWORD3(x)   SWORDn(x,  3)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SWORD4(x)   SWORDn(x,  4)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SWORD5(x)   SWORDn(x,  5)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SWORD6(x)   SWORDn(x,  6)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SWORD7(x)   SWORDn(x,  7)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Helper functions to represent some assembly instructions.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Fill memory block with an integer value</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">memset32</span><span class="params">(<span class="keyword">void</span> *ptr, uint32 value, <span class="keyword">int</span> count)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  uint32 *p = (uint32 *)ptr;</span><br><span class="line">  <span class="keyword">for</span> ( <span class="keyword">int</span> i=<span class="number">0</span>; i &lt; count; i++ )</span><br><span class="line">    *p++ = value;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// Generate a reference to pair of operands</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;  <span class="title">int16</span> __<span class="title">PAIR__</span>( <span class="title">int8</span>  <span class="title">high</span>, <span class="title">T</span> <span class="title">low</span>) {</span> <span class="keyword">return</span> ((( int16)high) &lt;&lt; <span class="keyword">sizeof</span>(high)*<span class="number">8</span>) | uint8(low); }</span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;  <span class="title">int32</span> __<span class="title">PAIR__</span>( <span class="title">int16</span> <span class="title">high</span>, <span class="title">T</span> <span class="title">low</span>) {</span> <span class="keyword">return</span> ((( int32)high) &lt;&lt; <span class="keyword">sizeof</span>(high)*<span class="number">8</span>) | uint16(low); }</span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;  <span class="title">int64</span> __<span class="title">PAIR__</span>( <span class="title">int32</span> <span class="title">high</span>, <span class="title">T</span> <span class="title">low</span>) {</span> <span class="keyword">return</span> ((( int64)high) &lt;&lt; <span class="keyword">sizeof</span>(high)*<span class="number">8</span>) | uint32(low); }</span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt; <span class="title">uint16</span> __<span class="title">PAIR__</span>(<span class="title">uint8</span>  <span class="title">high</span>, <span class="title">T</span> <span class="title">low</span>) {</span> <span class="keyword">return</span> (((uint16)high) &lt;&lt; <span class="keyword">sizeof</span>(high)*<span class="number">8</span>) | uint8(low); }</span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt; <span class="title">uint32</span> __<span class="title">PAIR__</span>(<span class="title">uint16</span> <span class="title">high</span>, <span class="title">T</span> <span class="title">low</span>) {</span> <span class="keyword">return</span> (((uint32)high) &lt;&lt; <span class="keyword">sizeof</span>(high)*<span class="number">8</span>) | uint16(low); }</span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt; <span class="title">uint64</span> __<span class="title">PAIR__</span>(<span class="title">uint32</span> <span class="title">high</span>, <span class="title">T</span> <span class="title">low</span>) {</span> <span class="keyword">return</span> (((uint64)high) &lt;&lt; <span class="keyword">sizeof</span>(high)*<span class="number">8</span>) | uint32(low); }</span><br><span class="line"></span><br><span class="line"><span class="comment">// rotate left</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt; <span class="title">T</span> __<span class="title">ROL__</span>(<span class="title">T</span> <span class="title">value</span>, <span class="title">uint</span> <span class="title">count</span>)</span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">  <span class="keyword">const</span> uint nbits = <span class="keyword">sizeof</span>(T) * <span class="number">8</span>;</span><br><span class="line">  count %= nbits;</span><br><span class="line"></span><br><span class="line">  T high = value &gt;&gt; (nbits - count);</span><br><span class="line">  value &lt;&lt;= count;</span><br><span class="line">  value |= high;</span><br><span class="line">  <span class="keyword">return</span> value;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// rotate right</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt; <span class="title">T</span> __<span class="title">ROR__</span>(<span class="title">T</span> <span class="title">value</span>, <span class="title">uint</span> <span class="title">count</span>)</span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">  <span class="keyword">const</span> uint nbits = <span class="keyword">sizeof</span>(T) * <span class="number">8</span>;</span><br><span class="line">  count %= nbits;</span><br><span class="line"></span><br><span class="line">  T low = value &lt;&lt; (nbits - count);</span><br><span class="line">  value &gt;&gt;= count;</span><br><span class="line">  value |= low;</span><br><span class="line">  <span class="keyword">return</span> value;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// carry flag of left shift</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt; <span class="title">int8</span> __<span class="title">MKCSHL__</span>(<span class="title">T</span> <span class="title">value</span>, <span class="title">uint</span> <span class="title">count</span>)</span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">  <span class="keyword">const</span> uint nbits = <span class="keyword">sizeof</span>(T) * <span class="number">8</span>;</span><br><span class="line">  count %= nbits;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (value &gt;&gt; (nbits-count)) &amp; <span class="number">1</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// carry flag of right shift</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt; <span class="title">int8</span> __<span class="title">MKCSHR__</span>(<span class="title">T</span> <span class="title">value</span>, <span class="title">uint</span> <span class="title">count</span>)</span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">  <span class="keyword">return</span> (value &gt;&gt; (count<span class="number">-1</span>)) &amp; <span class="number">1</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// sign flag</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt; <span class="title">int8</span> __<span class="title">SETS__</span>(<span class="title">T</span> <span class="title">x</span>)</span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">  <span class="keyword">if</span> ( <span class="keyword">sizeof</span>(T) == <span class="number">1</span> )</span><br><span class="line">    <span class="keyword">return</span> int8(x) &lt; <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="keyword">sizeof</span>(T) == <span class="number">2</span> )</span><br><span class="line">    <span class="keyword">return</span> int16(x) &lt; <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="keyword">sizeof</span>(T) == <span class="number">4</span> )</span><br><span class="line">    <span class="keyword">return</span> int32(x) &lt; <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> int64(x) &lt; <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// overflow flag of subtraction (x-y)</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>, <span class="title">class</span> <span class="title">U</span>&gt; <span class="title">int8</span> __<span class="title">OFSUB__</span>(<span class="title">T</span> <span class="title">x</span>, <span class="title">U</span> <span class="title">y</span>)</span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">  <span class="keyword">if</span> ( <span class="keyword">sizeof</span>(T) &lt; <span class="keyword">sizeof</span>(U) )</span><br><span class="line">  {</span><br><span class="line">    U x2 = x;</span><br><span class="line">    int8 sx = __SETS__(x2);</span><br><span class="line">    <span class="keyword">return</span> (sx ^ __SETS__(y)) &amp; (sx ^ __SETS__(x2-y));</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  {</span><br><span class="line">    T y2 = y;</span><br><span class="line">    int8 sx = __SETS__(x);</span><br><span class="line">    <span class="keyword">return</span> (sx ^ __SETS__(y2)) &amp; (sx ^ __SETS__(x-y2));</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// overflow flag of addition (x+y)</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>, <span class="title">class</span> <span class="title">U</span>&gt; <span class="title">int8</span> __<span class="title">OFADD__</span>(<span class="title">T</span> <span class="title">x</span>, <span class="title">U</span> <span class="title">y</span>)</span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">  <span class="keyword">if</span> ( <span class="keyword">sizeof</span>(T) &lt; <span class="keyword">sizeof</span>(U) )</span><br><span class="line">  {</span><br><span class="line">    U x2 = x;</span><br><span class="line">    int8 sx = __SETS__(x2);</span><br><span class="line">    <span class="keyword">return</span> ((<span class="number">1</span> ^ sx) ^ __SETS__(y)) &amp; (sx ^ __SETS__(x2+y));</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  {</span><br><span class="line">    T y2 = y;</span><br><span class="line">    int8 sx = __SETS__(x);</span><br><span class="line">    <span class="keyword">return</span> ((<span class="number">1</span> ^ sx) ^ __SETS__(y2)) &amp; (sx ^ __SETS__(x+y2));</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// carry flag of subtraction (x-y)</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>, <span class="title">class</span> <span class="title">U</span>&gt; <span class="title">int8</span> __<span class="title">CFSUB__</span>(<span class="title">T</span> <span class="title">x</span>, <span class="title">U</span> <span class="title">y</span>)</span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">  <span class="keyword">int</span> size = <span class="keyword">sizeof</span>(T) &gt; <span class="keyword">sizeof</span>(U) ? <span class="keyword">sizeof</span>(T) : <span class="keyword">sizeof</span>(U);</span><br><span class="line">  <span class="keyword">if</span> ( size == <span class="number">1</span> )</span><br><span class="line">    <span class="keyword">return</span> uint8(x) &lt; uint8(y);</span><br><span class="line">  <span class="keyword">if</span> ( size == <span class="number">2</span> )</span><br><span class="line">    <span class="keyword">return</span> uint16(x) &lt; uint16(y);</span><br><span class="line">  <span class="keyword">if</span> ( size == <span class="number">4</span> )</span><br><span class="line">    <span class="keyword">return</span> uint32(x) &lt; uint32(y);</span><br><span class="line">  <span class="keyword">return</span> uint64(x) &lt; uint64(y);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// carry flag of addition (x+y)</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>, <span class="title">class</span> <span class="title">U</span>&gt; <span class="title">int8</span> __<span class="title">CFADD__</span>(<span class="title">T</span> <span class="title">x</span>, <span class="title">U</span> <span class="title">y</span>)</span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">  <span class="keyword">int</span> size = <span class="keyword">sizeof</span>(T) &gt; <span class="keyword">sizeof</span>(U) ? <span class="keyword">sizeof</span>(T) : <span class="keyword">sizeof</span>(U);</span><br><span class="line">  <span class="keyword">if</span> ( size == <span class="number">1</span> )</span><br><span class="line">    <span class="keyword">return</span> uint8(x) &gt; uint8(x+y);</span><br><span class="line">  <span class="keyword">if</span> ( size == <span class="number">2</span> )</span><br><span class="line">    <span class="keyword">return</span> uint16(x) &gt; uint16(x+y);</span><br><span class="line">  <span class="keyword">if</span> ( size == <span class="number">4</span> )</span><br><span class="line">    <span class="keyword">return</span> uint32(x) &gt; uint32(x+y);</span><br><span class="line">  <span class="keyword">return</span> uint64(x) &gt; uint64(x+y);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="comment">// The following definition is not quite correct because it always returns</span></span><br><span class="line"><span class="comment">// uint64. The above C++ functions are good, though.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __PAIR__(high, low) (((uint64)(high)&lt;&lt;sizeof(high)*8) | low)</span></span><br><span class="line"><span class="comment">// For C, we just provide macros, they are not quite correct.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __ROL__(x, y) __rotl__(x, y)      <span class="comment">// Rotate left</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __ROR__(x, y) __rotr__(x, y)      <span class="comment">// Rotate right</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __CFSHL__(x, y) invalid_operation <span class="comment">// Generate carry flag for (x&lt;&lt;y)</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __CFSHR__(x, y) invalid_operation <span class="comment">// Generate carry flag for (x&gt;&gt;y)</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __CFADD__(x, y) invalid_operation <span class="comment">// Generate carry flag for (x+y)</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __CFSUB__(x, y) invalid_operation <span class="comment">// Generate carry flag for (x-y)</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __OFADD__(x, y) invalid_operation <span class="comment">// Generate overflow flag for (x+y)</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __OFSUB__(x, y) invalid_operation <span class="comment">// Generate overflow flag for (x-y)</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// No definition for rcl/rcr because the carry flag is unknown</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __RCL__(x, y)    invalid_operation <span class="comment">// Rotate left thru carry</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __RCR__(x, y)    invalid_operation <span class="comment">// Rotate right thru carry</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __MKCRCL__(x, y) invalid_operation <span class="comment">// Generate carry flag for a RCL</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __MKCRCR__(x, y) invalid_operation <span class="comment">// Generate carry flag for a RCR</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __SETP__(x, y)   invalid_operation <span class="comment">// Generate parity flag for (x-y)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// In the decompilation listing there are some objects declarared as _UNKNOWN</span></span><br><span class="line"><span class="comment">// because we could not determine their types. Since the C compiler does not</span></span><br><span class="line"><span class="comment">// accept void item declarations, we replace them by anything of our choice,</span></span><br><span class="line"><span class="comment">// for example a char:</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _UNKNOWN char</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _MSC_VER</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> snprintf _snprintf</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> vsnprintf _vsnprintf</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<h1 id="2-&#x5FEB;&#x6377;&#x952E;"><a href="#2-&#x5FEB;&#x6377;&#x952E;" class="headerlink" title="2. &#x5FEB;&#x6377;&#x952E;"></a>2. &#x5FEB;&#x6377;&#x952E;</h1><p>Shirt+F12&#xFF0C;&#x6253;&#x5F00;&#x5B57;&#x7B26;&#x4E32;&#x5185;&#x5BB9;&#x7A97;&#x53E3;<br>Ctrl+S&#xFF0C;&#x6709;&#x4E24;&#x4E2A;&#x7528;&#x9014;&#xFF0C;&#x5728;&#x6B63;&#x5E38;&#x6253;&#x5F00;so&#x6587;&#x4EF6;&#x7684;IDA View&#x89C6;&#x56FE;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x53EF;&#x4EE5;&#x67E5;&#x770B;so&#x5BF9;&#x5E94;&#x7684;Segement&#x4FE1;&#x606F;&#xFF1B;&#x5F53;&#x5728;&#x8C03;&#x8BD5;&#x9875;&#x9762;&#x7684;&#x65F6;&#x5019;&#xFF0C;ctrl+s&#x53EF;&#x4EE5;&#x5FEB;&#x901F;&#x5B9A;&#x4F4D;&#x5230;&#x6211;&#x4EEC;&#x60F3;&#x8981;&#x8C03;&#x8BD5;&#x7684;so&#x6587;&#x4EF6;&#x6620;&#x5C04;&#x5230;&#x5185;&#x5B58;&#x7684;&#x5730;&#x5740;<br>G&#x5FEB;&#x6377;&#x952E;&#xFF1A;&#x5728;IDA&#x8C03;&#x8BD5;&#x9875;&#x9762;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;S&#x952E;&#x5FEB;&#x901F;&#x8DF3;&#x8F6C;&#x5230;&#x6307;&#x5B9A;&#x7684;&#x5185;&#x5B58;&#x4F4D;&#x7F6E;<br>&#x8C03;&#x8BD5;&#x5FEB;&#x6377;&#x952E;&#xFF1A;F8&#x5355;&#x6B65;&#x8C03;&#x8BD5;&#xFF0C;F7&#x5355;&#x6B65;&#x8FDB;&#x5165;&#x8C03;&#x8BD5;&#xFF0C;F9&#x5FEB;&#x6377;&#x952E;&#x8FD0;&#x884C;</p>
<p>alt+t&#x53EF;&#x4EE5;&#x8FDB;&#x884C;&#x641C;&#x7D22;&#x65B9;&#x6CD5;&#x540D;&#xFF08;&#x5982;&#x679C;&#x9700;&#x8981;&#x641C;&#x7D22;&#x5B57;&#x7B26;&#x4E32;&#xFF0C;&#x53EA;&#x9700;&#x8981;&#x5148;shift+f12&#x5207;&#x6362;&#x5230;string&#x9009;&#x9879;&#x5361;&#xFF0C;&#x518D;&#x6B21;alt+t&#x5373;&#x53EF;&#xFF09;</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/11/08/使用frida-Hook动态加载Dex/">使用frida Hook动态加载Dex</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-11-08</time><div class="content"><p>&#x590D;&#x73B0;&#x4E86;2018DDCTF &#x7684;&#x4E00;&#x9053;&#x5B89;&#x5353;&#x9898;HelloBabyDex&#xFF0C;&#x53C2;&#x8003;&#x4E86;&#x7F51;&#x4E0A;&#x7684;&#x5F88;&#x591A;&#x8D44;&#x6599;&#xFF0C;&#x5B66;&#x5230;&#x4E86;&#x5F88;&#x591A;&#x77E5;&#x8BC6;&#xFF0C;&#x8BB0;&#x5F55;&#x4E00;&#x4E0B;&#x4F7F;&#x7528;frida Hook&#x52A8;&#x6001;&#x52A0;&#x8F7D;Dex&#x53BB;&#x89E3;&#x8FD9;&#x9053;&#x9898;&#x8FC7;&#x7A0B;&#x4E2D;&#x5B66;&#x5230;&#x7684;&#x4E1C;&#x897F;&#xFF0C;&#x671F;&#x95F4;&#x8FD8;&#x8865;&#x5145;&#x4E86;Java&#x5173;&#x4E8E;&#x53CD;&#x5C04;&#x673A;&#x5236;&#x7684;&#x77E5;&#x8BC6;&#x2026;..</p>
<h3 id="POINT"><a href="#POINT" class="headerlink" title="POINT"></a>POINT</h3><ol>
<li>Hook&#x52A8;&#x6001;&#x52A0;&#x8F7D;&#x7684;Dex&#x7684;&#x7C7B;&#x65B9;&#x6CD5;</li>
<li>Hook&#x91CD;&#x8F7D;&#x7684;&#x65B9;&#x6CD5;</li>
<li>&#x4F7F;&#x7528;Java.cast&#x8FDB;&#x884C;&#x7C7B;&#x578B;&#x8F6C;&#x6362;</li>
<li>&#x4F7F;&#x7528;Java.array&#x521B;&#x5EFA;&#x6570;&#x7EC4;</li>
<li>java&#x53CD;&#x5C04;&#x673A;&#x5236;&#x4E2D;&#x7684;&#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x8C61;</li>
</ol>
<h3 id="PROLOGUE"><a href="#PROLOGUE" class="headerlink" title="PROLOGUE"></a>PROLOGUE</h3><p>&#x8FD9;&#x4E2A;app&#x4F7F;&#x7528;&#x4E86;&#x7F8E;&#x56E2;&#x7684;rubust&#x70ED;&#x4FEE;&#x6539;&#x6846;&#x67B6;&#xFF0C;&#x6846;&#x67B6;&#x901A;&#x8FC7;DexClassLoader&#x65B9;&#x6CD5;&#x53BB;&#x52A8;&#x6001;&#x52A0;&#x8F7D;&#x6587;&#x4EF6;&#xFF0C;&#x7136;&#x540E;&#x901A;&#x8FC7;&#x53CD;&#x5C04;&#x673A;&#x5236;&#x53BB;&#x8C03;&#x7528;&#x7C7B;&#x65B9;&#x6CD5;&#x6216;&#x6210;&#x5458;&#x53D8;&#x91CF;&#xFF0C;&#x800C;DexClassLoader&#x65B9;&#x6CD5;&#x771F;&#x6B63;&#x4F7F;&#x7528;&#x7684;&#x662F;&#x5176;&#x7236;&#x7C7B;&#x7684;&#x7236;&#x7C7B;&#x4E2D;&#x7684;loadClass&#x65B9;&#x6CD5;&#xFF0C;&#x90A3;&#x5C31;&#x53EF;&#x4EE5;&#x53BB;Hook DexClassLoader&#x8FD9;&#x4E2A;&#x7C7B;&#x4E0B;&#x7684;loadClass&#x65B9;&#x6CD5;&#x3002;</p>
<h2 id="0&#x3001;&#x4F7F;&#x7528;frida&#x6CE8;&#x5165;&#x5230;Zygote&#x751F;&#x6210;&#x8C03;&#x8BD5;app"><a href="#0&#x3001;&#x4F7F;&#x7528;frida&#x6CE8;&#x5165;&#x5230;Zygote&#x751F;&#x6210;&#x8C03;&#x8BD5;app" class="headerlink" title="0&#x3001;&#x4F7F;&#x7528;frida&#x6CE8;&#x5165;&#x5230;Zygote&#x751F;&#x6210;&#x8C03;&#x8BD5;app"></a>0&#x3001;&#x4F7F;&#x7528;frida&#x6CE8;&#x5165;&#x5230;Zygote&#x751F;&#x6210;&#x8C03;&#x8BD5;app</h2><p>&#x901A;&#x8FC7;&#x5206;&#x6790;&#x9898;&#x76EE;&#xFF0C;&#x53EF;&#x4EE5;&#x77E5;&#x9053;&#x7A0B;&#x5E8F;&#x5728;onCreate&#x65F6;&#x53BB;&#x52A8;&#x6001;&#x52A0;&#x8F7D;&#x4E86;dex&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;app&#x5728;&#x542F;&#x52A8;&#x65F6;&#x52A0;&#x8F7D;&#x7684;dex&#xFF0C;&#x56E0;&#x6B64;&#x9700;&#x8981;&#x5728;&#x542F;&#x52A8;&#x524D;&#x5C06;frida&#x6CE8;&#x5165;&#x5230;&#x76EE;&#x6807;&#x8FDB;&#x7A0B;&#x3002;frida&#x53EF;&#x4EE5;&#x901A;&#x8FC7;-f&#x53C2;&#x6570;&#x5B9E;&#x73B0;&#xFF1A;</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida -U -f cn.chaitin.geektan.crackme</span><br></pre></td></tr></table></figure>
<p>&#x542F;&#x52A8;python&#x811A;&#x672C;&#x540E;&#xFF0C;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;%resume&#x542F;&#x52A8;app</p>
<h2 id="1&#x3001;&#x3001;Hook&#x91CD;&#x8F7D;&#x7684;&#x65B9;&#x6CD5;loadClass"><a href="#1&#x3001;&#x3001;Hook&#x91CD;&#x8F7D;&#x7684;&#x65B9;&#x6CD5;loadClass" class="headerlink" title="1&#x3001;&#x3001;Hook&#x91CD;&#x8F7D;&#x7684;&#x65B9;&#x6CD5;loadClass"></a>1&#x3001;&#x3001;Hook&#x91CD;&#x8F7D;&#x7684;&#x65B9;&#x6CD5;loadClass</h2><p>&#x4F46;&#x662F;loadClass&#x6709;2&#x4E2A;&#x91CD;&#x8F7D;&#x65B9;&#x6CD5;&#xFF0C;&#x5728;frida&#x4E2D;&#x4F7F;&#x7528;overload&#x6307;&#x5B9A;Hook&#x7684;&#x91CD;&#x8F7D;&#x65B9;&#x6CD5;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; loadClass(String name) <span class="keyword">throws</span> ClassNotFoundException {</span><br><span class="line">        <span class="keyword">return</span> loadClass(name, <span class="keyword">false</span>);</span><br><span class="line">    }</span><br><span class="line">......</span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="keyword">boolean</span> resolve)</span><br><span class="line">        <span class="keyword">throws</span> ClassNotFoundException</span><br><span class="line">    {</span><br><span class="line">            Class&lt;?&gt; c = findLoadedClass(name);</span><br><span class="line">            <span class="keyword">if</span> (c == <span class="keyword">null</span>) {</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    <span class="keyword">if</span> (parent != <span class="keyword">null</span>) {</span><br><span class="line">                        c = parent.loadClass(name, <span class="keyword">false</span>);</span><br><span class="line">                    } <span class="keyword">else</span> {</span><br><span class="line">                        c = findBootstrapClassOrNull(name);</span><br><span class="line">                    }</span><br><span class="line">                } <span class="keyword">catch</span> (ClassNotFoundException e) {</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">if</span> (c == <span class="keyword">null</span>) {</span><br><span class="line">                    c = findClass(name);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>
<p>Hook&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x4E3A;String&#x7C7B;&#x578B;&#x7684;&#x65B9;&#x6CD5;&#xFF1A;</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> dexclassLoader = Java.use(<span class="string">&quot;dalvik.system.DexClassLoader&quot;</span>);</span><br><span class="line">dexclassLoader.loadClass.overload(<span class="string">&apos;java.lang.String&apos;</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span></span><br></pre></td></tr></table></figure>
<h2 id="2&#x3001;&#x5C06;loadClass&#x5F97;&#x5230;&#x7C7B;&#x5BF9;&#x8C61;&#x8FDB;&#x884C;&#x7C7B;&#x578B;&#x8F6C;&#x6362;"><a href="#2&#x3001;&#x5C06;loadClass&#x5F97;&#x5230;&#x7C7B;&#x5BF9;&#x8C61;&#x8FDB;&#x884C;&#x7C7B;&#x578B;&#x8F6C;&#x6362;" class="headerlink" title="2&#x3001;&#x5C06;loadClass&#x5F97;&#x5230;&#x7C7B;&#x5BF9;&#x8C61;&#x8FDB;&#x884C;&#x7C7B;&#x578B;&#x8F6C;&#x6362;"></a>2&#x3001;&#x5C06;loadClass&#x5F97;&#x5230;&#x7C7B;&#x5BF9;&#x8C61;&#x8FDB;&#x884C;&#x7C7B;&#x578B;&#x8F6C;&#x6362;</h2><p>&#x8FD9;&#x4E2A;name&#x5C31;&#x662F;&#x52A8;&#x6001;&#x52A0;&#x8F7D;&#x7684;&#x7C7B;&#x540D;&#xFF0C;&#x5373; <code>cn.chaitin.geektan.crackme.MainActivityPatch</code>&#xFF0C;&#x5F53;name&#x5339;&#x914D;&#x6210;&#x529F;&#x65F6;&#xFF0C;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x7C7B;&#x5BF9;&#x8C61;<code>class cn.chaitin.geektan.crackme.MainActivityPatch</code>&#xFF0C;&#x6309;&#x7406;&#x8BF4;&#x5229;&#x7528;&#x53CD;&#x5C04;&#x673A;&#x5236;&#xFF0C;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x8FD9;&#x4E2A;&#x7C7B;&#x5BF9;&#x8C61;&#x53BB;&#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x8C61;&#xFF0C;&#x4F46;&#x662F;&#x5C1D;&#x8BD5;&#x540E;&#x4E0D;&#x884C;&#xFF0C;&#x9700;&#x8981;&#x8FDB;&#x884C;&#x7C7B;&#x578B;&#x8F6C;&#x6362;</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> hookclass = <span class="keyword">this</span>.loadClass(name,<span class="literal">false</span>);</span><br><span class="line"><span class="keyword">var</span> ClassUse = Java.use(<span class="string">&quot;java.lang.Class&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> hookClassCast = Java.cast(hookClass,ClassUse);</span><br></pre></td></tr></table></figure>
<p>&#x8FD9;&#x6837;&#x5C31;&#x83B7;&#x5F97;&#x4E86;&#x4E00;&#x4E2A;&#x6307;&#x5411;MainActivityPatch&#x7684;&#x7C7B;&#x5BF9;&#x8C61;</p>
<h2 id="3&#x3001;&#x83B7;&#x5F97;&#x7C7B;Constructor&#x5E76;&#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x8C61;"><a href="#3&#x3001;&#x83B7;&#x5F97;&#x7C7B;Constructor&#x5E76;&#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x8C61;" class="headerlink" title="3&#x3001;&#x83B7;&#x5F97;&#x7C7B;Constructor&#x5E76;&#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x8C61;"></a>3&#x3001;&#x83B7;&#x5F97;&#x7C7B;Constructor&#x5E76;&#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x8C61;</h2><p>&#x6709;&#x4E86;&#x7C7B;&#x5BF9;&#x8C61;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x7C7B;&#x5BF9;&#x8C61;&#x7684; <code>getDeclaredConstructor(Class&lt;?&gt;...ParametersType)</code>&#x65B9;&#x6CD5;&#x83B7;&#x5F97;&#x6307;&#x5B9A;&#x53C2;&#x6570;&#x7684;&#x6784;&#x9020;&#x5668;&#xFF0C;&#x5373;&#x6784;&#x9020;&#x51FD;&#x6570;&#x5BF9;&#x8C61;&#x3002;&#x51FD;&#x6570;&#x7684;&#x53C2;&#x6570;&#x662F;&#x7C7B;&#x578B;&#x4E3A;&#x7C7B;&#x5BF9;&#x8C61;&#x7684;&#x6570;&#x7EC4;&#x3002;&#x67E5;&#x770B;&#x52A8;&#x6001;&#x52A0;&#x8F7D;&#x7C7B;&#x4E2D;<code>MainActivityPatch</code>&#x7684;&#x6784;&#x9020;&#x51FD;&#x6570;&#xFF0C;&#x53C2;&#x6570;&#x662F;Object&#x7C7B;&#x578B;&#x3002;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">MainActivityPatch</span><span class="params">(Object obj)</span> </span>{</span><br><span class="line">    <span class="keyword">this</span>.originClass = (MainActivity) obj;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x901A;&#x8FC7;frida&#x7684;Java.array&#x65B9;&#x6CD5;&#x53BB;&#x6784;&#x9020;Object&#x7C7B;&#x578B;&#x7684;&#x6570;&#x7EC4;&#xFF0C;&#x8BED;&#x6CD5;&#x662F;</p>
<figure class="highlight ceylon"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Java.array(<span class="string">&apos;type&apos;</span>,[<span class="keyword">value</span><span class="number">1</span>,<span class="keyword">value</span><span class="number">2</span>,....]);</span><br></pre></td></tr></table></figure>
<p><strong>&#x6784;&#x9020;&#x53C2;&#x6570;</strong>&#xFF0C;&#x8FD9;&#x4E2A;type&#x7684;&#x5199;&#x6CD5;&#x548C;smali&#x8BED;&#x6CD5;&#x4E00;&#x6837;</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> objectclass= Java.use(<span class="string">&quot;java.lang.Object&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> ConstructorParam =Java.array(<span class="string">&apos;Ljava.lang.Object;&apos;</span>,[objectclass.class]);</span><br></pre></td></tr></table></figure>
<p><strong>&#x7136;&#x540E;&#x8C03;&#x7528;getDeclaredConstructor&#x65B9;&#x6CD5;&#x83B7;&#x5F97;&#x7C7B;&#x6784;&#x9020;&#x5668;</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = hookClassCast.getDeclaredConstructor(ConstructorParam);</span><br></pre></td></tr></table></figure>
<p>&#x8FD9;&#x6837;&#x901A;&#x8FC7;&#x6307;&#x5B9A;&#x6784;&#x9020;&#x51FD;&#x6570;&#x7684;&#x53C2;&#x6570;&#xFF0C;&#x8FD4;&#x56DE;&#x4E86;&#x4E00;&#x4E2A;&#x6307;&#x5B9A;&#x7684;&#x6784;&#x9020;&#x51FD;&#x6570;&#x5BF9;&#x8C61;&#xFF0C;<code>Constructor</code>&#x5BF9;&#x8C61;&#x4E2D;&#x6709;&#x4E00;&#x4E2A;&#x65B9;&#x6CD5;<code>newInstance(Object ... initargs)</code>&#xFF0C;&#x8FD9;&#x91CC;&#x7684;<code>initargs</code>&#x5373;&#x4E3A;&#x8981;&#x4F20;&#x7ED9;&#x6784;&#x9020;&#x51FD;&#x6570;&#x7684;&#x53C2;&#x6570;&#x3002;&#x4F7F;&#x7528;<code>newInstance</code>&#x5C31;&#x83B7;&#x53D6;&#x4E86;<code>MainActivityPatch</code>&#x7C7B;&#x7684;&#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x8C61;</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> orininclass = Java.use(<span class="string">&quot;cn.chaitin.geektan.crackme.MainActivity&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> mainAc = orininclass.$<span class="keyword">new</span>();</span><br><span class="line"><span class="keyword">var</span> instance = Constructor.newInstance([mainAc]);</span><br></pre></td></tr></table></figure>
<h2 id="4&#x3001;&#x8C03;&#x7528;&#x5BF9;&#x8C61;&#x65B9;&#x6CD5;"><a href="#4&#x3001;&#x8C03;&#x7528;&#x5BF9;&#x8C61;&#x65B9;&#x6CD5;" class="headerlink" title="4&#x3001;&#x8C03;&#x7528;&#x5BF9;&#x8C61;&#x65B9;&#x6CD5;"></a>4&#x3001;&#x8C03;&#x7528;&#x5BF9;&#x8C61;&#x65B9;&#x6CD5;</h2><p>&#x5F97;&#x5230;&#x5B9E;&#x4F8B;&#x5316;&#x7684;&#x5BF9;&#x8C61;&#x540E;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;getDeclaredMethods&#x65B9;&#x6CD5;&#x83B7;&#x53D6;&#x6240;&#x6709;&#x8FD9;&#x4E2A;&#x7C7B;&#x7684;&#x7C7B;&#x65B9;&#x6CD5;&#xFF0C;&#x67E5;&#x770B;getDeclaredMethods&#x7684;&#x539F;&#x578B;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Method[] getDeclaredMethods()</span><br></pre></td></tr></table></figure>
<p>&#x901A;&#x8FC7;&#x539F;&#x578B;&#x53EF;&#x4EE5;&#x77E5;&#x9053;&#x8BE5;&#x65B9;&#x6CD5;&#x8FD4;&#x56DE;&#x7684;&#x662F;Method&#x6570;&#x7EC4;&#xFF0C;Joseph&#x51FD;&#x6570;&#x5728;&#x6570;&#x7EC4;&#x4E2D;&#x7B2C;&#x4E00;&#x4E2A;&#x3002;</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> func = hookClassCast.getDeclaredMethods();</span><br><span class="line"><span class="keyword">var</span> f = func[<span class="number">0</span>];</span><br></pre></td></tr></table></figure>
<p>&#x77E5;&#x9053;&#x76EE;&#x6807;&#x51FD;&#x6570;&#x7684;&#x4F4D;&#x7F6E;&#x540E;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;Method.invoke&#x65B9;&#x6CD5;&#x8C03;&#x7528;&#x8BE5;&#x65B9;&#x6CD5;&#xFF0C;&#x770B;&#x4E0B;invoke&#x65B9;&#x6CD5;&#x7684;&#x53C2;&#x6570;&#xFF0C;&#x7B2C;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x662F;&#x6267;&#x884C;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x7684;&#x5BF9;&#x8C61;&#x5B9E;&#x4F8B;&#xFF0C;&#x7B2C;&#x4E8C;&#x4E2A;&#x53C2;&#x6570;&#x662F;&#x5E26;&#x5165;&#x7684;&#x5B9E;&#x9645;&#x503C;&#x6570;&#x7EC4;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> Object <span class="title">invoke</span><span class="params">(Object obj, Object... args)</span></span></span><br></pre></td></tr></table></figure>
<p>&#x6240;&#x4EE5;&#x6267;&#x884C;Joseph(5&#xFF0C;6)&#x7684;js&#x8BED;&#x53E5;&#x662F;</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Integerclass = Java.use(<span class="string">&quot;java.lang.Integer&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> num1 = Integerclass.$<span class="keyword">new</span>(<span class="number">5</span>);</span><br><span class="line"><span class="keyword">var</span> num2 = Integerclass.$<span class="keyword">new</span>(<span class="number">6</span>);</span><br><span class="line"><span class="keyword">var</span> numArr1 = Java.array(<span class="string">&apos;Ljava.lang.Object;&apos;</span>,[num1,num2]);</span><br><span class="line"><span class="keyword">var</span> rtn1 = f.invoke(instance,numArr1);</span><br></pre></td></tr></table></figure>
<p>&#x6700;&#x7EC8;&#x7684;EXP&#x5982;&#x4E0B;&#xFF08;&#x53C2;&#x8003;&#x770B;&#x96EA;&#x8BBA;&#x575B;<a href="https://bbs.pediy.com/user-811277.htm" target="_blank" rel="noopener">ghostmazeW</a>&#xFF09;</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="keyword">var</span> hookClass = <span class="literal">undefined</span>;</span><br><span class="line">        <span class="keyword">var</span> ClassUse = Java.use(<span class="string">&quot;java.lang.Class&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> objectclass= Java.use(<span class="string">&quot;java.lang.Object&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> dexclassLoader = Java.use(<span class="string">&quot;dalvik.system.DexClassLoader&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> orininclass = Java.use(<span class="string">&quot;cn.chaitin.geektan.crackme.MainActivity&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> Integerclass = Java.use(<span class="string">&quot;java.lang.Integer&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> mainAc = orininclass.$<span class="keyword">new</span>();</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">        dexclassLoader.loadClass.overload(<span class="string">&apos;java.lang.String&apos;</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>{</span><br><span class="line">            <span class="keyword">var</span> hookname = <span class="string">&quot;cn.chaitin.geektan.crackme.MainActivityPatch&quot;</span>;</span><br><span class="line">            <span class="keyword">var</span> result = <span class="keyword">this</span>.loadClass(name,<span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">if</span>(name == hookname){</span><br><span class="line">                <span class="keyword">var</span> hookClass = result;</span><br><span class="line">                <span class="keyword">var</span> hookClassCast = Java.cast(hookClass,ClassUse);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;-----------------------------GET Constructor-------------------------------------&quot;</span>);</span><br><span class="line">                <span class="keyword">var</span> ConstructorParam =Java.array(<span class="string">&apos;Ljava.lang.Object;&apos;</span>,[objectclass.class]);</span><br><span class="line">                <span class="keyword">var</span> Constructor = hookClassCast.getDeclaredConstructor(ConstructorParam);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;Constructor:&quot;</span>+Constructor);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;orinin:&quot;</span>+mainAc);</span><br><span class="line">                <span class="keyword">var</span> instance = Constructor.newInstance([mainAc]);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;patchAc:&quot;</span>+instance);</span><br><span class="line">                send(instance);</span><br><span class="line"> </span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;-----------------------------GET Methods----------------------------&quot;</span>);</span><br><span class="line">                <span class="keyword">var</span> func = hookClassCast.getDeclaredMethods();</span><br><span class="line">                <span class="built_in">console</span>.log(func);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;--------------------------GET Joseph Function---------------------------&quot;</span>);</span><br><span class="line">                <span class="built_in">console</span>.log(func[<span class="number">0</span>]);</span><br><span class="line">                <span class="keyword">var</span> f = func[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">var</span> num1 = Integerclass.$<span class="keyword">new</span>(<span class="number">5</span>);</span><br><span class="line">                <span class="keyword">var</span> num2 = Integerclass.$<span class="keyword">new</span>(<span class="number">6</span>);</span><br><span class="line">                <span class="keyword">var</span> numArr1 = Java.array(<span class="string">&apos;Ljava.lang.Object;&apos;</span>,[num1,num2]);</span><br><span class="line">                <span class="keyword">var</span> num3 = Integerclass.$<span class="keyword">new</span>(<span class="number">7</span>);</span><br><span class="line">                <span class="keyword">var</span> num4 = Integerclass.$<span class="keyword">new</span>(<span class="number">8</span>);</span><br><span class="line">                <span class="keyword">var</span> numArr2 = Java.array(<span class="string">&apos;Ljava.lang.Object;&apos;</span>,[num3,num4]);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;-----------------------------GET Array------------------------------&quot;</span>);</span><br><span class="line">                <span class="built_in">console</span>.log(numArr1);</span><br><span class="line">                <span class="built_in">console</span>.log(numArr2);</span><br><span class="line">                <span class="keyword">var</span> rtn1 = f.invoke(instance,numArr1);</span><br><span class="line">                <span class="keyword">var</span> rtn2 = f.invoke(instance,numArr2);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;--------------------------------FLAG---------------------------------&quot;</span>);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;DDCTF{&quot;</span>+rtn1+rtn2+<span class="string">&quot;}&quot;</span>);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;--------------------------------OVER--------------------------------&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line"> </span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        }</span><br><span class="line">});</span><br></pre></td></tr></table></figure>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/11/06/frida使用/">frida-notebook</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-11-06</time><div class="content"><h2 id="1&#x3001;hook&#x51FD;&#x6570;&#xFF0C;&#x83B7;&#x53D6;java&#x5C42;&#x67D0;&#x4E2A;&#x51FD;&#x6570;&#x7684;&#x8FD4;&#x56DE;&#x503C;"><a href="#1&#x3001;hook&#x51FD;&#x6570;&#xFF0C;&#x83B7;&#x53D6;java&#x5C42;&#x67D0;&#x4E2A;&#x51FD;&#x6570;&#x7684;&#x8FD4;&#x56DE;&#x503C;" class="headerlink" title="1&#x3001;hook&#x51FD;&#x6570;&#xFF0C;&#x83B7;&#x53D6;java&#x5C42;&#x67D0;&#x4E2A;&#x51FD;&#x6570;&#x7684;&#x8FD4;&#x56DE;&#x503C;"></a>1&#x3001;hook&#x51FD;&#x6570;&#xFF0C;&#x83B7;&#x53D6;java&#x5C42;&#x67D0;&#x4E2A;&#x51FD;&#x6570;&#x7684;&#x8FD4;&#x56DE;&#x503C;</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="number">1000</span> == MainActivity.<span class="keyword">this</span>.cnt) {</span><br><span class="line">    tv3.setText(<span class="string">&quot;SECCON{&quot;</span> + String.valueOf((MainActivity.<span class="keyword">this</span>.cnt + MainActivity.<span class="keyword">this</span>.calc()) * <span class="number">107</span>) + <span class="string">&quot;}&quot;</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>calc&#x4E3A;native&#x5C42;&#x7684;&#x51FD;&#x6570;&#xFF0C;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;hook onCreate&#x65B9;&#x6CD5;&#xFF0C;&#x91CD;&#x65B0;&#x5B9E;&#x73B0;onCreate&#x65B9;&#x6CD5;&#xFF0C;&#x8C03;&#x7528;calc&#x65B9;&#x6CD5;&#xFF0C;&#x83B7;&#x5F97;&#x8FD4;&#x56DE;&#x503C;</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Java.Perform &#x5F00;&#x59CB;&#x6267;&#x884C;JavaScript&#x811A;&#x672C;&#x3002;</span></span><br><span class="line">Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">    <span class="keyword">var</span> MainActivity = Java.use(<span class="string">&apos;com.example.seccon2015.rock_paper_scissors.MainActivity&apos;</span>);</span><br><span class="line">    MainActivity.onCreate.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">        <span class="keyword">var</span> returnValue = <span class="keyword">this</span>.calc();<span class="comment">//&#x8C03;&#x7528;MainActivity.calc()</span></span><br><span class="line">        send(<span class="string">&quot;Return:&quot;</span>+returnValue);</span><br><span class="line">        <span class="keyword">var</span> result = (<span class="number">1000</span>+returnValue)*<span class="number">107</span>;</span><br><span class="line">        send(<span class="string">&quot;Flag:&quot;</span>+<span class="string">&quot;SECCON{&quot;</span>+result.toString()+<span class="string">&quot;}&quot;</span>);</span><br><span class="line">    }</span><br><span class="line">});</span><br></pre></td></tr></table></figure>
<h2 id="2&#x3001;hook&#x51FD;&#x6570;&#xFF0C;&#x4FEE;&#x6539;java&#x5C42;&#x53D8;&#x91CF;&#x7684;&#x503C;"><a href="#2&#x3001;hook&#x51FD;&#x6570;&#xFF0C;&#x4FEE;&#x6539;java&#x5C42;&#x53D8;&#x91CF;&#x7684;&#x503C;" class="headerlink" title="2&#x3001;hook&#x51FD;&#x6570;&#xFF0C;&#x4FEE;&#x6539;java&#x5C42;&#x53D8;&#x91CF;&#x7684;&#x503C;"></a>2&#x3001;hook&#x51FD;&#x6570;&#xFF0C;&#x4FEE;&#x6539;java&#x5C42;&#x53D8;&#x91CF;&#x7684;&#x503C;</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Java.perform(function () {</span><br><span class="line">    var MainActivity = Java.use(<span class="string">&apos;com.example.seccon2015.rock_paper_scissors.MainActivity&apos;</span>);</span><br><span class="line">    <span class="comment">//hook onClick&#x65B9;&#x6CD5;&#xFF0C;&#x6B64;&#x5904;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;onClick&#x65B9;&#x6CD5;&#x662F;&#x4F20;&#x9012;&#x4E86;&#x4E00;&#x4E2A;View&#x53C2;&#x6570;v</span></span><br><span class="line">    MainActivity.onClick.implementation = function (v) {</span><br><span class="line">        <span class="comment">//&#x8C03;&#x7528;onClick,&#x6A21;&#x62DF;&#x70B9;&#x51FB;&#x4E8B;&#x4EF6;</span></span><br><span class="line">        <span class="keyword">this</span>.onClick(v);</span><br><span class="line">        <span class="keyword">this</span>.n.value = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">this</span>.m.value = <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">this</span>.cnt.value = <span class="number">999</span>;</span><br><span class="line">        send(<span class="string">&quot;Success!&quot;</span>)</span><br><span class="line">    }</span><br><span class="line">});</span><br></pre></td></tr></table></figure>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/11/04/Linux-Kernel-ROP/">Linux Kernel ROP</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-11-04</time><div class="content"><p>&#x8FD9;&#x4E2A;&#x9898;&#x76EE;&#x662F;&#x5185;&#x6838;&#x7A7A;&#x95F4;&#x7684;&#x6808;&#x6EA2;&#x51FA;&#xFF0C;&#x5173;&#x4E8E;&#x5185;&#x6838;&#x6A21;&#x5757;&#x7684;&#x6F0F;&#x6D1E;&#x7F51;&#x4E0A;&#x6709;&#x5F88;&#x591A;&#x5206;&#x6790;&#xFF0C;&#x5728;&#x8FD9;&#x91CC;&#x6211;&#x6253;&#x7B97;&#x53EA;&#x8BF4;&#x4E0B;&#x81EA;&#x5DF1;&#x901A;&#x8FC7;&#x8FD9;&#x4E2A;&#x9898;&#x76EE;&#x83B7;&#x5F97;&#x7684;&#x77E5;&#x8BC6;&#xFF0C;&#x5728;&#x6B64;&#x8BB0;&#x5F55;&#x4E00;&#x4E0B;</p>
<h2 id="Load-CTF-Files-to-QEMU"><a href="#Load-CTF-Files-to-QEMU" class="headerlink" title="Load CTF Files to QEMU"></a>Load CTF Files to QEMU</h2><p>CTF files&#x5305;&#x542B;&#x4E86;4&#x4E2A;&#x6587;&#x4EF6;</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x251C;&#x2500;&#x2500; bzImage</span><br><span class="line">&#x251C;&#x2500;&#x2500; core.cpio</span><br><span class="line">&#x251C;&#x2500;&#x2500; start.sh</span><br><span class="line">&#x2514;&#x2500;&#x2500; vmlinux</span><br></pre></td></tr></table></figure>
<p>start.sh&#x662F;&#x7CFB;&#x7EDF;&#x7684;&#x542F;&#x52A8;&#x811A;&#x672C;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x5F00;&#x542F;&#x4E86;kaslr</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 \</span><br><span class="line">-m 128M \</span><br><span class="line">-kernel ./bzImage \</span><br><span class="line">-initrd  ./core.cpio \</span><br><span class="line">-append <span class="string">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet kaslr&quot;</span> \</span><br><span class="line">-s  \</span><br><span class="line">-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \</span><br><span class="line">-nographic  \</span><br></pre></td></tr></table></figure>
<ul>
<li>qemu-system-x86_64&#xFF1A;&#x6A21;&#x62DF;x86_64&#x67B6;&#x6784;</li>
<li>-m&#xFF1A;&#x6307;&#x5B9A;RAM&#x5927;&#x5C0F;</li>
<li>-kernel&#xFF1A;&#x52A0;&#x8F7D;&#x7684;&#x5185;&#x6838;&#x955C;&#x50CF;</li>
<li>-initrd&#xFF1A;&#x6307;&#x5B9A;&#x5185;&#x6838;&#x542F;&#x52A8;&#x7684;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;</li>
<li>-s&#xFF1A;&#x76F8;&#x5F53;&#x4E8E; -gdb tcp::1234&#xFF0C;&#x7ED1;&#x5B9A;&#x7AEF;&#x53E3;&#xFF0C;&#x4F7F;&#x7528;gdb&#x8C03;&#x8BD5;</li>
</ul>
<p>&#x8FD8;&#x63D0;&#x4F9B;&#x4E86;vmlinux&#xFF0C;&#x8FD9;&#x91CC;&#x8BF4;&#x4E0B;vmlinux&#x548C;bzImage&#x7684;&#x5173;&#x7CFB;<a href="http://www.linfo.org/vmlinuz.html" target="_blank" rel="noopener">refference</a></p>
<blockquote>
<p>vmlinux&#x662F;&#x672A;&#x538B;&#x7F29;&#x7684;&#x3001;&#x9759;&#x6001;&#x94FE;&#x63A5;&#x7684;&#x3001;&#x53EF;&#x6267;&#x884C;&#x7684;&#x3001;&#x4F46;&#x662F;&#x4E0D;&#x80FD;bootable&#x7684;&#x5185;&#x6838;&#x6587;&#x4EF6;<br>vmlinuz&#x662F;&#x7531;vmlinux&#x7ECF;&#x8FC7;&#x538B;&#x7F29;&#x540E;&#xFF0C;&#x53EF;&#x4EE5;bootable&#x7684;&#x5185;&#x6838;&#x6587;&#x4EF6;&#xFF0C;&#x5B83;&#x5B9E;&#x9645;&#x4E0A;&#x5C31;&#x662F;<code>zImage</code>&#x6216;bzImage<br>bzImage&#x662F;vmlinuz&#x7ECF;&#x8FC7;gzip&#x538B;&#x7F29;&#x540E;&#x7684;&#x6587;&#x4EF6;&#xFF0C;&#x9002;&#x7528;&#x4E8E;&#x5927;&#x5185;&#x6838;<br>zImage&#x662F;vmlinuz&#x7ECF;&#x8FC7;gzip&#x538B;&#x7F29;&#x540E;&#x7684;&#x6587;&#x4EF6;&#xFF0C;&#x9002;&#x7528;&#x4E8E;<code>640k</code>&#x5185;&#x5B58;&#x7684;&#x5C0F;&#x5185;&#x6838;</p>
</blockquote>
<p>&#x4F46;&#x662F;&#x9898;&#x76EE;&#x63D0;&#x4F9B;&#x7684;vmlinux&#x548C;&#x5185;&#x6838;&#x4F7F;&#x7528;&#x7684;&#x4E0D;&#x4E00;&#x6837;&#xFF0C;&#x6240;&#x4EE5;&#x9700;&#x8981;&#x4ECE;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x4E2D;&#x63D0;&#x53D6;&#x6587;&#x4EF6;</p>
<h3 id="&#x63D0;&#x53D6;cpio&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x4E2D;&#x7684;&#x6587;&#x4EF6;"><a href="#&#x63D0;&#x53D6;cpio&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x4E2D;&#x7684;&#x6587;&#x4EF6;" class="headerlink" title="&#x63D0;&#x53D6;cpio&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x4E2D;&#x7684;&#x6587;&#x4EF6;"></a>&#x63D0;&#x53D6;cpio&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x4E2D;&#x7684;&#x6587;&#x4EF6;</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">mv core.cpio core.cpio.gz</span><br><span class="line">gunzip core.cpio.gz</span><br><span class="line">cpio -idmv &lt; core.cpio</span><br><span class="line"></span><br><span class="line">&#x251C;&#x2500;&#x2500; bin</span><br><span class="line">&#x251C;&#x2500;&#x2500; core.ko</span><br><span class="line">&#x251C;&#x2500;&#x2500; etc</span><br><span class="line">&#x251C;&#x2500;&#x2500; exploit</span><br><span class="line">&#x251C;&#x2500;&#x2500; gen_cpio.sh</span><br><span class="line">&#x251C;&#x2500;&#x2500; init</span><br><span class="line">&#x251C;&#x2500;&#x2500; lib</span><br><span class="line">&#x251C;&#x2500;&#x2500; lib64</span><br><span class="line">&#x251C;&#x2500;&#x2500; linuxrc -&gt; bin/busybox</span><br><span class="line">&#x251C;&#x2500;&#x2500; proc</span><br><span class="line">&#x251C;&#x2500;&#x2500; root</span><br><span class="line">&#x251C;&#x2500;&#x2500; sbin</span><br><span class="line">&#x251C;&#x2500;&#x2500; sys</span><br><span class="line">&#x251C;&#x2500;&#x2500; tmp</span><br><span class="line">&#x251C;&#x2500;&#x2500; usr</span><br><span class="line">&#x2514;&#x2500;&#x2500; vmlinux</span><br></pre></td></tr></table></figure>
<p>vmlinux&#x662F;&#x672A;&#x538B;&#x7F29;&#x7684;&#x5185;&#x6838;&#x6587;&#x4EF6;&#xFF0C;&#x53EF;&#x4EE5;&#x4ECE;&#x8FD9;&#x91CC;&#x627E;Gadgets<br>core.ko&#x5C31;&#x662F;&#x5B58;&#x5728;&#x6F0F;&#x6D1E;&#x7684;&#x5185;&#x6838;&#x6A21;&#x5757;<br>init&#x662F;&#x542F;&#x52A8;&#x7684;&#x914D;&#x7F6E;&#x6587;&#x4EF6;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">mount -t proc proc /proc</span><br><span class="line">mount -t sysfs sysfs /sys</span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">/sbin/mdev -s</span><br><span class="line">mkdir -p /dev/pts</span><br><span class="line">mount -vt devpts -o gid=4,mode=620 none /dev/pts</span><br><span class="line">chmod 666 /dev/ptmx</span><br><span class="line">cat /proc/kallsyms &gt; /tmp/kallsyms</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line">ifconfig eth0 up</span><br><span class="line">udhcpc -i eth0</span><br><span class="line">ifconfig eth0 10.0.2.15 netmask 255.255.255.0</span><br><span class="line">route add default gw 10.0.2.2 </span><br><span class="line">insmod /core.ko</span><br><span class="line"></span><br><span class="line"><span class="comment">#poweroff -d 120 -f &amp;</span></span><br><span class="line">setsid /bin/cttyhack setuidgid 1000 /bin/sh</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&apos;sh end!\n&apos;</span></span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line"></span><br><span class="line">poweroff -d 0  -f</span><br></pre></td></tr></table></figure>
<p>poweroff -d 120 -f &amp; &#x8BBE;&#x7F6E;&#x4E86;&#x5B9A;&#x65F6;&#x5173;&#x673A;&#xFF0C;&#x5F71;&#x54CD;&#x8C03;&#x8BD5;&#xFF0C;&#x9700;&#x8981;&#x6CE8;&#x91CA;&#x6389;<br><code>echo 1 &gt; /proc/sys/kernel/kptr_restrict</code> &#x9650;&#x5236;&#x4E0D;&#x80FD;&#x4ECE; <code>/pro/kallsyms</code> &#x83B7;&#x53D6;&#x5185;&#x6838;&#x7B26;&#x53F7;&#x8868;&#x4FE1;&#x606F;</p>
<blockquote>
<p>/proc/kallsyms&#x5305;&#x542B;&#x4E86;kernel image&#x548C;&#x6240;&#x6709;&#x52A8;&#x6001;&#x52A0;&#x8F7D;&#x6A21;&#x5757;&#x7684;&#x7B26;&#x53F7;&#x8868;&#x3002;&#x5982;&#x679C;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x88AB;&#x7F16;&#x8BD1;&#x5668;&#x5185;&#x8054;&#xFF08;inline&#xFF09;&#x6216;&#x8005;&#x4F18;&#x5316;&#x6389;&#x4E86;&#xFF0C;&#x5219;&#x5B83;&#x5728;/proc/kallsyms&#x6709;&#x53EF;&#x80FD;&#x627E;&#x4E0D;&#x5230;&#x3002;&#x6B64;&#x5916;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x662F;root&#x7528;&#x6237;&#xFF0C;&#x5219;&#x663E;&#x793A;/proc/kallsyms&#x4E2D;&#x7684;&#x5730;&#x5740;&#x90FD;&#x662F;0&#xFF1A;</p>
</blockquote>
<p>&#x4F46;&#x662F;<code>cat /proc/kallsyms &gt; /tmp/kallsyms</code> &#x8FD9;&#x53E5;&#xFF0C;&#x5C06;kallsyms&#x62F7;&#x8D1D;&#x4E86;&#x4E00;&#x4EFD;&#x5728;/tmp&#x76EE;&#x5F55;&#x4E0B;&#xFF0C;&#x53EF;&#x4EE5;&#x5728;&#x8FD9;&#x91CC;&#x67E5;&#x627E;commit_creds&#x548C;prepare_kernel_cred&#x7684;&#x5730;&#x5740;</p>
<h2 id="Privilege-Transfer"><a href="#Privilege-Transfer" class="headerlink" title="Privilege Transfer"></a>Privilege Transfer</h2><p>Since userspace and kernel space are in different memory segment with different permission, we need some instructions to switch the spaces.</p>
<p>To switch from userspace to kernel space, we need to use syscall. To switch back&#xFF0C;we need to use two instructions as blew.</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">swapgs</span></span><br><span class="line"><span class="keyword">iretq</span></span><br></pre></td></tr></table></figure>
<p>The typical use of SWAPGS is to keep the &#x2018;user&#x2019; GS (which likely has a base address of 0) in the GSBase MSR, and the address of the kernel&#x2019;s per-CPU structure in KernelGSBase. Upon entry to Ring 0 (through a system call, software interrupt, or some other method), the kernel will use SWAPGS so accessing <code>[GS:0]</code> will get the pointer to the kernel data. Upon leaving Ring 0, SWAPGS will be called again, to switch GS back to the &#x2018;user&#x2019; GS. <a href="https://wiki.osdev.org/SWAPGS" target="_blank" rel="noopener">refference</a></p>
<p>Iretq instruction recovery the context of userspace, thus we come back from kernelspace to userspace. Before use this instruction,some value should be stored in the stack, and the stack construction as blew.</p>
<p>&#x5F53;&#x4F7F;&#x7528;IRET&#x6307;&#x4EE4;&#x8FD4;&#x56DE;&#x5230;&#x76F8;&#x540C;&#x4FDD;&#x62A4;&#x7EA7;&#x522B;&#x7684;&#x4EFB;&#x52A1;&#x65F6;&#xFF0C;IRET&#x4F1A;&#x4ECE;&#x6808;&#x5C06;<code>&#x8FD4;&#x56DE;&#x6307;&#x4EE4;&#x6307;&#x9488;</code>&#x3001;<code>&#x8FD4;&#x56DE;&#x4EE3;&#x7801;&#x6BB5;&#x9009;&#x62E9;&#x5668;</code>&#x4EE5;&#x53CA;<code>EFLAGS&#x6620;&#x50CF;</code>&#x5206;&#x522B;&#x5F39;&#x5165;RIP&#x3001;CS&#x4EE5;&#x53CA;RFLAGS&#x5BC4;&#x5B58;&#x5668;&#xFF0C;&#x7136;&#x540E;&#x6062;&#x590D;&#x6267;&#x884C;&#x4E2D;&#x65AD;&#x7684;&#x7A0B;&#x5E8F;&#x6216;&#x8FC7;&#x7A0B;&#x3002;<br>&#x5F53;&#x4F7F;&#x7528;IRET&#x6307;&#x4EE4;&#x8FD4;&#x56DE;&#x5230;&#x4E0D;&#x540C;&#x4FDD;&#x62A4;&#x7EA7;&#x522B;&#x65F6;&#xFF0C;IRET&#x4E0D;&#x4EC5;&#x4F1A;&#x4ECE;&#x6808;&#x5F39;&#x51FA;&#x4EE5;&#x4E0A;&#x5185;&#x5BB9;&#xFF0C;&#x8FD8;&#x4F1A;&#x5F39;&#x51FA;<code>RSP</code>&#x4EE5;&#x53CA;<code>SS</code>&#x3002;</p>
<p>&#x6808;&#x4E0A;&#x4FDD;&#x5B58;&#x4E86;trap frame&#xFF0C;&#x8FD4;&#x56DE;&#x5230;&#x7528;&#x6237;&#x6A21;&#x5F0F;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x6062;&#x590D;&#x4FE1;&#x606F;&#x4ECE;&#x4EE5;&#x4E0B;&#x7ED3;&#x6784;&#x4E2D;&#x8BFB;&#x53D6;&#xFF1A;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trap_frame</span> {</span></span><br><span class="line">    <span class="keyword">void</span> *rip;       <span class="comment">// instruction pointer +0</span></span><br><span class="line">    <span class="keyword">uint64_t</span> cs;     <span class="comment">// code segment +4</span></span><br><span class="line">    <span class="keyword">uint64_t</span> rflags; <span class="comment">// CPU flags +8</span></span><br><span class="line">    <span class="keyword">void</span> *rsp;       <span class="comment">// stack pointer +12</span></span><br><span class="line">    <span class="keyword">uint64_t</span> ss;     <span class="comment">// stack segment +16</span></span><br><span class="line">} __attribute__((packed));</span><br></pre></td></tr></table></figure>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">|---------|</span><br><span class="line">|iretq;ret| -&gt; the addr of the gadget  High</span><br><span class="line">|---------|</span><br><span class="line">|<span class="built_in"> RIP </span>    | -&gt; instruction address</span><br><span class="line">|---------|</span><br><span class="line">| CS      | -&gt; code segments</span><br><span class="line">|---------|</span><br><span class="line">| EFLAGS  | -&gt; flags <span class="keyword">for</span><span class="built_in"> system </span>status</span><br><span class="line">|---------|</span><br><span class="line">| RSP     | -&gt;<span class="built_in"> user </span>stack pointer</span><br><span class="line">|---------|</span><br><span class="line">| SS      | -&gt;<span class="built_in"> user </span>stack segment			Low</span><br><span class="line">|---------|</span><br></pre></td></tr></table></figure>
<h2 id="privilege-escalation"><a href="#privilege-escalation" class="headerlink" title="privilege escalation"></a>privilege escalation</h2><p>getting privilege escalation via commit_creds(prepare_kernel_cred(0)<br>The above privilege escalation payload allocates a new credential struct (with uid = 0, gid = 0, etc.) and applies it to the <strong>calling process</strong>.</p>
<h2 id="debugging"><a href="#debugging" class="headerlink" title="debugging"></a>debugging</h2><p>target remote:1234&#x901A;&#x8FC7;&#x7AEF;&#x53E3;&#x8C03;&#x8BD5;&#xFF0C;gdb ./vmlinux&#x542F;&#x52A8;&#xFF0C;&#x53EA;&#x52A0;&#x8F7D;&#x4E86; kernel &#x7684;&#x7B26;&#x53F7;&#x8868;&#xFF0C;&#x6A21;&#x5757;&#x52A0;&#x8F7D;&#x8FDB;&#x5185;&#x6838;&#x540E;&#xFF0C;&#x5E76;&#x6CA1;&#x6709;&#x4F5C;&#x4E3A;vmliunx&#x7684;&#x4E00;&#x90E8;&#x5206;&#x4F20;&#x7ED9;gdb&#xFF0C;&#x56E0;&#x4E3A;&#x9700;&#x8981;&#x52A0;&#x8F7D;&#x5185;&#x6838;&#x6A21;&#x5757;&#x7684;&#x7B26;&#x53F7;&#x8868;&#xFF0C;&#x7531;&#x4E8E;&#x6A21;&#x5757;&#x4E5F;&#x662F;&#x4E00;&#x4E2A;ELF&#x6587;&#x4EF6;&#xFF0C;&#x9700;&#x8981;&#x77E5;&#x9053;&#x6A21;&#x5757;&#x7684;.text&#x7684;&#x8282;&#x533A;&#x5730;&#x5740;&#x3002;&#x8FD9;&#x4E2A;&#x4FE1;&#x606F;&#x5206;&#x522B;&#x4FDD;&#x5B58;/sys/module/stack_smashing/sections/.text&#x4E2D;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gdb ./vmlinux</span><br><span class="line">target remote:1234 </span><br><span class="line">add-symbol-file ./core.ko textaddr</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/ $ id</span><br><span class="line">uid=1000(chal) gid=1000(chal) groups=1000(chal)</span><br><span class="line">/ $ /tmp/exploit </span><br><span class="line">[*]status has been saved.</span><br><span class="line">vmlinux_base 0xffffffff92800000</span><br><span class="line">vmlinux_base 0xffffffff92800000</span><br><span class="line">[*] <span class="built_in">set</span> off</span><br><span class="line">[*] core_read</span><br><span class="line">[+]canary: 0x808226e1f3461f00</span><br><span class="line">/ $ id</span><br><span class="line">uid=0(root) gid=0(root)</span><br></pre></td></tr></table></figure>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/10/06/mineucore-虚拟内存管理学习笔记/">mineucore-虚拟内存管理学习笔记</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-10-06</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/OS/">OS</a></span><div class="content"><h2 id="&#x6982;&#x8FF0;"><a href="#&#x6982;&#x8FF0;" class="headerlink" title="&#x6982;&#x8FF0;"></a>&#x6982;&#x8FF0;</h2><p>&#x865A;&#x62DF;&#x9875;&#x5F0F;&#x5B58;&#x50A8;&#x6280;&#x672F;&#xFF0C;&#x5728;&#x9875;&#x5F0F;&#x5B58;&#x50A8;&#x7BA1;&#x7406;&#x7684;&#x57FA;&#x7840;&#x4E0A;&#xFF0C;&#x589E;&#x52A0;&#x8BF7;&#x6C42;&#x8C03;&#x9875;&#x548C;&#x9875;&#x9762;&#x7F6E;&#x6362;</p>
<p>&#x6709;&#x4E86;&#x9875;&#x5F0F;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#x6280;&#x672F;&#xFF0C;CPU&#x4F7F;&#x7528;&#x7684;&#x5730;&#x5740;&#x5DF2;&#x7ECF;&#x4E0D;&#x662F;&#x5B9E;&#x9645;&#x7684;&#x7269;&#x7406;&#x5730;&#x5740;&#x4E86;&#xFF0C;&#x800C;&#x662F;&#x865A;&#x62DF;&#x5730;&#x5740;&#xFF0C;&#x8FDB;&#x800C;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x8BBE;&#x7F6E;&#x6BB5;&#x754C;&#x9650;&#x6216;&#x9875;&#x8868;&#x9879;&#x6765;&#x8BBE;&#x5B9A;&#x7A0B;&#x5E8F;&#x8FD0;&#x884C;&#x65F6;&#x7684;&#x8BBF;&#x95EE;&#x7A7A;&#x95F4;&#xFF0C;&#x786E;&#x4FDD;&#x7A0B;&#x5E8F;&#x8FD0;&#x884C;&#x4E0D;&#x8D8A;&#x754C;&#xFF0C;&#x5B8C;&#x6210;&#x5185;&#x5B58;&#x8BBF;&#x95EE;&#x4FDD;&#x62A4;&#x7684;&#x529F;&#x80FD;&#x3002;</p>
<p>&#x4F46;&#x662F;&#x60F3;&#x6700;&#x5927;&#x5316;&#x5229;&#x7528;&#x7269;&#x7406;&#x5185;&#x5B58;&#xFF0C;&#x6839;&#x636E;&#x7A0B;&#x5E8F;&#x7684;&#x5C40;&#x90E8;&#x6027;&#x539F;&#x7406;&#xFF0C;&#x5373;&#x7A0B;&#x5E8F;&#x5728;&#x6267;&#x884C;&#x8FC7;&#x7A0B;&#x4E2D;&#x7684;&#x4E00;&#x4E2A;&#x8F83;&#x77ED;&#x7684;&#x65F6;&#x671F;&#x5185;&#xFF0C;&#x6240;&#x6267;&#x884C;&#x7684;&#x6307;&#x4EE4;&#x5730;&#x5740;&#x548C;&#x6307;&#x4EE4;&#x64CD;&#x4F5C;&#x6570;&#x5730;&#x5740;&#xFF0C;&#x5206;&#x522B;&#x5C40;&#x9650;&#x4E8E;&#x4E00;&#x5B9A;&#x533A;&#x57DF;&#x3002;&#x53EF;&#x4F7F;&#x7A0B;&#x5E8F;&#x5728;&#x6CA1;&#x6709;&#x8BBF;&#x95EE;&#x67D0;&#x4E2A;&#x865A;&#x62DF;&#x5730;&#x5740;&#x65F6;&#xFF0C;&#x4E0D;&#x5206;&#x914D;&#x7269;&#x7406;&#x5185;&#x5B58;&#xFF0C;&#x5F53;&#x7A0B;&#x5E8F;&#x8BBF;&#x95EE;&#x67D0;&#x4E2A;&#x865A;&#x62DF;&#x5730;&#x5740;&#x65F6;&#xFF0C;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x5728;&#x52A8;&#x6001;&#x7684;&#x5206;&#x914D;&#x5185;&#x5B58;&#xFF0C;&#x5728;&#x9875;&#x8868;&#x4E2D;&#x5EFA;&#x7ACB;&#x865A;&#x62DF;&#x5730;&#x5740;&#x5230;&#x7269;&#x7406;&#x5730;&#x5740;&#x7684;&#x6620;&#x5C04;&#x5173;&#x7CFB;&#xFF0C;&#x8FD9;&#x5C31;&#x662F;<strong>&#x6309;&#x9700;&#x5206;&#x9875;</strong>&#x3002;</p>
<p>&#x4F46;&#x662F;&#x7269;&#x7406;&#x5185;&#x5B58;&#x603B;&#x4F1A;&#x4F7F;&#x7528;&#x6B86;&#x5C3D;&#xFF0C;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x53EF;&#x4EE5;&#x5C06;&#x7A0B;&#x5E8F;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x4E2D;&#x4E0D;&#x7ECF;&#x5E38;&#x8BBF;&#x95EE;&#x7684;&#x6570;&#x636E;&#x653E;&#x5165;&#x5916;&#x5B58;&#x4E2D;&#xFF0C;&#x5E76;&#x5728;&#x9875;&#x8868;&#x9879;&#x4E2D;&#x6807;&#x8BB0;&#xFF0C;&#x5F53;&#x53D1;&#x751F;&#x7F3A;&#x9875;&#x5F02;&#x5E38;&#x65F6;&#xFF0C;&#x5C31;&#x628A;&#x5916;&#x5B58;&#x4E2D;&#x7684;&#x6570;&#x636E;&#x91CD;&#x65B0;&#x52A0;&#x8F7D;&#x8FDB;&#x5185;&#x5B58;&#x4E2D;&#xFF0C;&#x8FD9;&#x662F;<strong>&#x9875;&#x6362;&#x5165;&#x6362;&#x51FA;&#xFF08;page swap in/out&#xFF09;</strong>&#x6280;&#x672F;&#x3002;&#x5982;&#x4F55;&#x9009;&#x62E9;&#x7269;&#x7406;&#x9875;&#x653E;&#x5165;&#x5916;&#x5B58;&#x4E2D;&#xFF0C;&#x8FD9;&#x5C31;&#x662F;<strong>&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;</strong>&#x7684;&#x5DE5;&#x4F5C;&#x4E86;&#x3002;</p>
<p>&#x5F53;&#x4E24;&#x4E2A;&#x865A;&#x62DF;&#x9875;&#x7684;&#x6570;&#x636E;&#x5185;&#x5BB9;&#x76F8;&#x540C;&#x65F6;&#xFF0C;&#x53EF;&#x53EA;&#x5206;&#x914D;&#x4E00;&#x4E2A;&#x7269;&#x7406;&#x9875;&#x6846;&#xFF0C;&#x8FD9;&#x6837;&#x5982;&#x679C;&#x5BF9;&#x4E24;&#x4E2A;&#x865A;&#x62DF;&#x9875;&#x7684;&#x8BBF;&#x95EE;&#x65B9;&#x5F0F;&#x662F;&#x53EA;&#x8BFB;&#x65B9;&#x5F0F;&#xFF0C;&#x8FD9;&#x4E24;&#x4E2A;&#x865A;&#x62DF;&#x9875;&#x53EF;&#x5171;&#x4EAB;&#x9875;&#x6846;&#xFF0C;&#x8282;&#x7701;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#xFF1B;&#x5982;&#x679C;CPU&#x5BF9;&#x5176;&#x4E2D;&#x4E4B;&#x4E00;&#x7684;&#x865A;&#x62DF;&#x9875;&#x8FDB;&#x884C;&#x5199;&#x64CD;&#x4F5C;&#xFF0C;&#x5219;&#x8FD9;&#x4E24;&#x4E2A;&#x865A;&#x62DF;&#x9875;&#x7684;&#x6570;&#x636E;&#x5185;&#x5BB9;&#x4F1A;&#x4E0D;&#x540C;&#xFF0C;&#x9700;&#x8981;&#x5206;&#x914D;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x7269;&#x7406;&#x9875;&#x6846;&#xFF0C;&#x5E76;&#x5C06;&#x7269;&#x7406;&#x9875;&#x6846;&#x6807;&#x8BB0;&#x4E3A;&#x53EF;&#x5199;&#xFF0C;&#x8FD9;&#x6837;&#x4E24;&#x4E2A;&#x865A;&#x62DF;&#x9875;&#x9762;&#x5C06;&#x6620;&#x5C04;&#x5230;&#x4E0D;&#x540C;&#x7684;&#x7269;&#x7406;&#x9875;&#x5E27;&#xFF0C;&#x786E;&#x4FDD;&#x6574;&#x4E2A;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x7684;&#x6B63;&#x786E;&#x8BBF;&#x95EE;&#x3002;&#x8FD9;&#x79CD;&#x6280;&#x672F;&#x79F0;&#x4E3A;<strong>&#x5199;&#x65F6;&#x590D;&#x5236;&#xFF08;Copy On Write&#xFF0C;&#x7B80;&#x79F0;COW&#xFF09;</strong>&#x3002;</p>
<p>&#x4E0B;&#x9762;&#x4E3B;&#x8981;&#x5728;&#x7269;&#x7406;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#x548C;&#x4E2D;&#x65AD;&#x5F02;&#x5E38;&#x7684;&#x57FA;&#x7840;&#x4E0A;&#x5B8C;&#x6210;&#x4E0A;&#x9762;&#x7684;&#x4E09;&#x4E2A;&#x5185;&#x5BB9;&#x3002;</p>
<h2 id="&#x6309;&#x9700;&#x5206;&#x9875;&#x4E0E;FIFO&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;"><a href="#&#x6309;&#x9700;&#x5206;&#x9875;&#x4E0E;FIFO&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;" class="headerlink" title="&#x6309;&#x9700;&#x5206;&#x9875;&#x4E0E;FIFO&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;"></a>&#x6309;&#x9700;&#x5206;&#x9875;&#x4E0E;FIFO&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;</h2><p>&#x5728;&#x7269;&#x7406;&#x5185;&#x5B58;&#x65B9;&#x9762;&#xFF0C;&#x4F7F;&#x7528;Page&#x7ED3;&#x6784;&#x4F53;&#x7BA1;&#x7406;&#x6240;&#x6709;&#x7269;&#x7406;&#x5185;&#x5B58;&#xFF0C;&#x6BCF;&#x4E00;&#x4E2A;&#x7269;&#x7406;&#x5E27;&#xFF0C;&#x90FD;&#x5BF9;&#x5E94;&#x4E00;&#x4E2A;Page&#x7ED3;&#x6784;&#x4F53;&#x3002;Page&#x7ED3;&#x6784;&#x4F53;&#x4FDD;&#x5B58;&#x5728;ucore&#x7CFB;&#x7EDF;&#x7684;&#x7269;&#x7406;&#x5185;&#x5B58;&#x4E0A;&#x65B9;&#x3002;&#x4E3A;&#x4E86;&#x5B9E;&#x73B0;&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;&#xFF0C;&#x5728;Page&#x7ED3;&#x6784;&#x4F53;&#x672B;&#x5C3E;&#xFF0C;&#x6DFB;&#x52A0;&#x4E86;&#x4E24;&#x4E2A;&#x65B0;&#x7684;&#x6210;&#x5458;&#x3002;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Page</span> {</span></span><br><span class="line">    <span class="keyword">int</span> ref; <span class="comment">//&#x8BE5;&#x7269;&#x7406;&#x5E27;&#x88AB;&#x7EBF;&#x6027;&#x5730;&#x5740;&#x5F15;&#x7528;&#x7684;&#x6B21;&#x6570;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> flags; <span class="comment">//&#x63CF;&#x8FF0;&#x9875;&#x9762;&#x5C5E;&#x6027;&#x7684;&#x6807;&#x5FD7;&#x4F4D;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> property; <span class="comment">//&#x63CF;&#x8FF0;&#x8FDE;&#x7EED;&#x7A7A;&#x95F2;&#x5757;&#x7684;&#x6570;&#x91CF;</span></span><br><span class="line">    <span class="keyword">list_entry_t</span> page_link; <span class="comment">//&#x7528;&#x4E8E;&#x4E32;&#x8054;&#x7A7A;&#x95F2;&#x5757;&#x53CC;&#x5411;&#x94FE;&#x8868;&#x7684;&#x94FE;&#x63A5;&#x7ED3;&#x6784;</span></span><br><span class="line">    <span class="keyword">list_entry_t</span> pra_page_link; <span class="comment">//&#x7528;&#x6765;&#x6784;&#x9020;&#x6309;&#x9875;&#x7684;&#x7B2C;&#x4E00;&#x6B21;&#x8BBF;&#x95EE;&#x65F6;&#x95F4;&#x8FDB;&#x884C;&#x6392;&#x5E8F;&#x7684;&#x4E00;&#x4E2A;&#x94FE;&#x8868;&#xFF0C;&#x8868;&#x5934;&#x65F6;&#x95F4;&#x6700;&#x8FD1;&#xFF0C;&#x8868;&#x5C3E;&#x65F6;&#x95F4;&#x6700;&#x8FDC;</span></span><br><span class="line">    <span class="keyword">uintptr_t</span> pra_vaddr; <span class="comment">//&#x7528;&#x6765;&#x8BB0;&#x5F55;&#x6B64;&#x7269;&#x7406;&#x9875;&#x5BF9;&#x5E94;&#x7684;&#x865A;&#x62DF;&#x9875;&#x8D77;&#x59CB;&#x5730;&#x5740;</span></span><br><span class="line">};</span><br></pre></td></tr></table></figure>
<p>pra_page_link&#x8FD9;&#x4E2A;&#x53CC;&#x5411;&#x94FE;&#x8868;&#x4E5F;&#x662F;&#x6709;&#x5934;&#x7ED3;&#x70B9;&#x7684;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//swap_info.c</span></span><br><span class="line"><span class="keyword">list_entry_t</span> pra_list_head;<span class="comment">//&#x505A;&#x4E3A;&#x5934;&#x7ED3;&#x70B9;&#xFF0C;&#x7528;&#x53CC;&#x5411;&#x94FE;&#x8868;&#x5404;&#x7528;&#x5230;&#x7684;&#x9875;&#x6846;Page&#x7ED3;&#x6784;&#x4F53;&#xFF0C;&#x6309;&#x7167;&#x65F6;&#x95F4;&#x987A;&#x5E8F;&#xFF0C;&#x4F7F;&#x7528;&#x65F6;&#x5F53;&#x6210;&#x961F;&#x5217;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x4F7F;&#x7528;</span></span><br></pre></td></tr></table></figure>
<p>&#x4F46;&#x662F;&#x5BF9;&#x4E8E;&#x7528;&#x6237;&#x6001;&#x7684;&#x7A0B;&#x5E8F;&#x6765;&#x8BF4;&#xFF0C;&#x9700;&#x8981;&#x6709;&#x76F8;&#x5173;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x548C;&#x64CD;&#x4F5C;&#x6765;&#x4F53;&#x73B0;&#x4E00;&#x822C;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x5BF9;&#x865A;&#x62DF;&#x5185;&#x5B58;&#x7684;&#x201C;&#x9700;&#x6C42;&#x201D;&#x3002;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> {</span></span><br><span class="line">    <span class="keyword">list_entry_t</span> mmap_list; <span class="comment">//&#x8FDE;&#x63A5;vma_struct&#x7684;&#x53CC;&#x5411;&#x94FE;&#x8868;&#x7684;&#x5934;&#x7ED3;&#x70B9;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">vma_struct</span> *<span class="title">mmap_cache</span>;</span> <span class="comment">//&#x6307;&#x5411;&#x5F53;&#x524D;&#x6B63;&#x5728;&#x4F7F;&#x7528;&#x7684;vma&#x7ED3;&#x6784;&#xFF0C;&#x7528;&#x4E8E;&#x63D0;&#x901F;</span></span><br><span class="line">    <span class="keyword">pde_t</span> *pgdir; <span class="comment">//&#x6307;&#x5411;&#x5F53;&#x524D;mm&#x6570;&#x636E;&#x7ED3;&#x6784;&#x6240;&#x7EF4;&#x62A4;&#x7684;&#x9875;&#x76EE;&#x5F55;&#x8868;</span></span><br><span class="line">    <span class="keyword">int</span> map_count; <span class="comment">//&#x5176;&#x94FE;&#x63A5;&#x7684;vma_struct&#x7684;&#x6570;&#x91CF;</span></span><br><span class="line">    <span class="keyword">void</span> *sm_priv; <span class="comment">//&#x6307;&#x5411;&#x7528;&#x6765;&#x94FE;&#x63A5;&#x8BB0;&#x5F55;&#x9875;&#x8BBF;&#x95EE;&#x60C5;&#x51B5;&#x7684;&#x94FE;&#x8868;&#x5934;</span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vma_struct</span> {</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">vm_mm</span>;</span> <span class="comment">//&#x6307;&#x5411;&#x5934;mm&#x7ED3;&#x6784;</span></span><br><span class="line">    <span class="keyword">uintptr_t</span> vm_start; <span class="comment">//&#x865A;&#x62DF;&#x5730;&#x5740;&#x7684;&#x8D77;&#x59CB;&#x5730;&#x5740;</span></span><br><span class="line">    <span class="keyword">uintptr_t</span> vm_end; <span class="comment">//&#x865A;&#x62DF;&#x5730;&#x5740;&#x7684;&#x7ED3;&#x675F;&#x5730;&#x5740;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> vm_flags; <span class="comment">//&#x865A;&#x62DF;&#x7A7A;&#x95F4;&#x7684;&#x6807;&#x5FD7;&#x4F4D;</span></span><br><span class="line">    <span class="keyword">list_entry_t</span> list_link; <span class="comment">//&#x53CC;&#x5411;&#x94FE;&#x8868;&#x7684;&#x8FDE;&#x63A5;&#x7ED3;&#x6784;&#xFF08;&#x6309;&#x7167;&#x5730;&#x5740;&#x6392;&#x5E8F;&#xFF09;</span></span><br><span class="line">};</span><br></pre></td></tr></table></figure>
<p>mm_struct&#x7EF4;&#x62A4;&#x4E00;&#x4E2A;&#x9875;&#x8868;&#x7684;&#x53EF;&#x7528;&#x7A7A;&#x95F2;&#x7A7A;&#x95F4;&#xFF0C;&#x5177;&#x4F53;&#x6765;&#x8BF4;&#x662F;&#x4E00;&#x4E2A;mm_struct&#x4E0B;&#x94FE;&#x63A5;&#x591A;&#x4E2A;vma_struct&#xFF0C;vma_struct&#x6807;&#x8BB0;&#x4E86;&#x8FD9;&#x4E2A;4M&#x7A7A;&#x95F4;&#x4E2D;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x7684;&#x865A;&#x62DF;&#x7A7A;&#x95F4;&#xFF0C;&#x5404;&#x4E2A;vma_struct&#x95F4;&#x901A;&#x8FC7;list_link&#x53CC;&#x5411;&#x94FE;&#x8868;&#x94FE;&#x63A5;&#xFF0C;&#x800C;mm_struct&#x5C31;&#x662F;&#x8FD9;&#x4E2A;&#x53CC;&#x5411;&#x94FE;&#x8868;&#x7684;&#x8868;&#x5934;&#x3002;</p>
<p>&#x5F53;&#x9875;&#x8868;&#x6620;&#x5C04;&#x5230;&#x7269;&#x7406;&#x5185;&#x5B58;&#x65F6;&#xFF0C;&#x9875;&#x8868;&#x5185;&#x5BB9;&#x4E3A;&#x9875;&#x5E27;&#x7684;&#x5730;&#x5740;&#x8FD8;&#x6709;&#x4E00;&#x4E9B;&#x6807;&#x5FD7;&#x4F4D;&#xFF0C;&#x4F46;&#x662F;&#x5F53;&#x865A;&#x62DF;&#x5185;&#x5B58;&#x6620;&#x5C04;&#x5230;&#x5916;&#x5B58;&#x65F6;&#xFF0C;&#x5176;&#x9875;&#x8868;&#x5185;&#x5BB9;&#x5982;&#x4F55;&#x8BBE;&#x8BA1;&#xFF1F;&#x5373;&#x5982;&#x4F55;&#x533A;&#x5206;&#x7269;&#x7406;&#x5185;&#x5B58;&#x7684;&#x6620;&#x5C04;&#x548C;swap&#x533A;&#x7684;&#x6620;&#x5C04;&#x3002;</p>
<p>&#x4E00;&#x4E2A;&#x9875;&#x5927;&#x5C0F;&#x4E3A;4kb&#xFF0C;&#x5F53;&#x6620;&#x5C04;&#x5230;&#x786C;&#x76D8;&#x4E2D;&#x65F6;&#xFF0C;&#x9700;&#x8981;&#x5360;&#x7528;8&#x4E2A;&#x6247;&#x533A;&#xFF08;0.5kb/&#x6247;&#x533A;&#xFF09;&#x3002;&#x53EF;&#x5C06;PTE&#xFF08;&#x9875;&#x8868;&#x9879;&#xFF09;&#x7684;&#x9AD8;24&#x4F4D;&#x8868;&#x793A;&#x5BF9;&#x6362;&#x5230;&#x786C;&#x76D8;&#x4E0A;&#x7684;&#x9875;&#x7684;&#x8D77;&#x59CB;&#x6247;&#x533A;&#x53F7;&#xFF0C;&#x5E76;&#x5C06;bit 0&#x7F6E;&#x4E3A;0&#xFF0C;&#x5373;&#x5F53;PTE&#x9AD8;24&#x4F4D;&#x4E0D;&#x4E3A;0&#xFF0C;&#x4E14;bit 0&#x4E3A;0&#xFF0C;&#x5219;&#x8BF4;&#x660E;&#x8BE5;&#x7269;&#x7406;&#x9875;&#x88AB;&#x6620;&#x5C04;&#x5230;&#x4E86;swap&#x533A;&#x3002;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* <span class="keyword">swap_entry_t</span></span><br><span class="line">* --------------------------------------------</span><br><span class="line">* |         offset        |   reserved   | <span class="number">0</span> |</span><br><span class="line">* --------------------------------------------</span><br><span class="line">*           <span class="number">24</span> bits            <span class="number">7</span> bits    <span class="number">1</span> bit</span><br></pre></td></tr></table></figure>
<p>&#x7F3A;&#x9875;&#x4E2D;&#x65AD;&#x7684;&#x5904;&#x7406;&#x51FD;&#x6570;&#x4E3B;&#x8981;&#x662F;do_pgfault&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#xFF0C;&#x4E3B;&#x8981;&#x5305;&#x62EC;&#x4E24;&#x4E2A;&#x5206;&#x652F;&#xFF1A;1&#xFF09;&#x5F53;&#x53D1;&#x751F;&#x7F3A;&#x9875;&#x4E2D;&#x65AD;&#x65F6;&#xFF0C;&#x5982;&#x679C;&#x9875;&#x8868;&#x9879;&#x7684;&#x5185;&#x5BB9;&#x4E3A;0&#xFF0C;&#x5219;&#x8868;&#x793A;&#x53D1;&#x751F;&#x7F3A;&#x9875;&#x5F02;&#x5E38;&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x4F1A;&#x8BF7;&#x6C42;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x7269;&#x7406;&#x9875;&#xFF0C;&#x7136;&#x540E;&#x66F4;&#x65B0;&#x9875;&#x8868;&#x5185;&#x5BB9;&#xFF0C;&#x5B8C;&#x6210;&#x6620;&#x5C04;&#x8FC7;&#x7A0B;&#x3002;2&#xFF09;&#x5982;&#x679C;&#x4E0D;&#x4E3A;0&#xFF0C;&#x5219;&#x4E3A;&#x662F;&#x4E00;&#x4E2A;&#x6620;&#x5C04;&#x5230;swap&#x533A;&#x7684;&#x7F3A;&#x9875;&#x5F02;&#x5E38;&#x3002;&#x5F53;&#x7136;&#x4E0D;&#x4F1A;&#x76F4;&#x63A5;&#x5230;&#x8FD9;&#x4E24;&#x4E2A;&#x5206;&#x652F;&#xFF0C;&#x8FD8;&#x9700;&#x8981;&#x6839;&#x636E;&#x9519;&#x8BEF;&#x53F7;&#xFF0C;&#x505A;&#x8FDB;&#x4E00;&#x6B65;&#x5224;&#x65AD;&#x3002;</p>
<p>&#x4E0B;&#x9762;&#x5B8C;&#x6574;&#x7684;do_pgfault&#x51FD;&#x6570;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//vmm.c</span></span><br><span class="line"><span class="comment">/* do_pgfault - &#x5904;&#x7406;&#x9875;&#x4E2D;&#x65AD;&#x5F02;&#x5E38;&#x7684;&#x4E3B;&#x8981;&#x51FD;&#x6570;</span></span><br><span class="line"><span class="comment"> * @mm         : &#x7BA1;&#x7406;&#x53EF;&#x7528;&#x865A;&#x62DF;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x7684;&#x7ED3;&#x6784;&#x4F53;</span></span><br><span class="line"><span class="comment"> * @error_code : &#x5904;&#x7406;&#x5668;&#x629B;&#x51FA;&#x7684;&#x5F02;&#x5E38;&#x7801;</span></span><br><span class="line"><span class="comment"> * @addr       : CR2&#x5BC4;&#x5B58;&#x5668;&#x4FDD;&#x5B58;&#x7684;&#x53D1;&#x751F;&#x9875;&#x8BBF;&#x95EE;&#x9519;&#x8BEF;&#x7684;&#x7EBF;&#x6027;&#x5730;&#x5740;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">do_pgfault(struct mm_struct *mm, <span class="keyword">uint32_t</span> error_code, <span class="keyword">uintptr_t</span> addr) {</span><br><span class="line">    <span class="keyword">int</span> ret = -E_INVAL;</span><br><span class="line">    <span class="comment">//&#x67E5;&#x627E;&#x5305;&#x542B;&#x7F3A;&#x9875;&#x5F02;&#x5E38;addr&#x7684;vma</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">vma_struct</span> *<span class="title">vma</span> = <span class="title">find_vma</span>(<span class="title">mm</span>, <span class="title">addr</span>);</span><span class="comment">//&#x5728;&#x6D4B;&#x8BD5;&#x4E2D; addr = 100h</span></span><br><span class="line"></span><br><span class="line">    pgfault_num++;</span><br><span class="line">    <span class="comment">//&#x82E5;&#x67E5;&#x627E;&#x4E0D;&#x5230;&#xFF0C;&#x8BF4;&#x660E;&#x8BE5;&#x5730;&#x5740;&#x65E0;&#x6548;&#xFF0C;&#x4E0D;&#x5408;&#x6CD5;</span></span><br><span class="line">    <span class="keyword">if</span> (vma == <span class="literal">NULL</span> || vma-&gt;vm_start &gt; addr) {</span><br><span class="line">        cprintf(<span class="string">&quot;not valid addr %x, and  can not find it in vma\n&quot;</span>, addr);</span><br><span class="line">        <span class="keyword">goto</span> failed;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//&#x5224;&#x65AD;&#x5F02;&#x5E38;&#x7C7B;&#x578B;&#xFF0C;&#x4E0E;3&#xFF0C;&#x5373;&amp;11b&#xFF0C;&#x53D6;&#x540E;&#x4E24;&#x4F4D;</span></span><br><span class="line">    <span class="keyword">switch</span> (error_code &amp; <span class="number">3</span>) {</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>: <span class="comment">//&#x7F3A;&#x9875;&#xFF0C;&#x5B58;&#x5728;&#x5199;&#x5F02;&#x5E38;&#xFF0C;&#x4E0B;&#x9762;&#x5224;&#x65AD;&#x7269;&#x7406;&#x9875;&#x662F;&#x5426;&#x53EF;&#x5199;&#xFF0C;&#x82E5;&#x53EF;&#x5199;&#xFF0C;&#x901A;&#x8FC7;&#x4E0B;&#x9762;&#x6D41;&#x7A0B;&#x5C06;&#x8BE5;&#x7269;&#x7406;&#x9875;&#x6620;&#x5C04;&#xFF0C;&#x82E5;&#x4E0D;&#x53EF;&#x5199;&#xFF0C;&#x5219;&#x62A5;&#x9519;</span></span><br><span class="line">        <span class="keyword">if</span> (!(vma-&gt;vm_flags &amp; VM_WRITE)) {</span><br><span class="line">            cprintf(<span class="string">&quot;do_pgfault failed: error code flag = write AND not present, but the addr&apos;s vma cannot write\n&quot;</span>);</span><br><span class="line">            <span class="keyword">goto</span> failed;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>: <span class="comment">//&#x5BF9;&#x5E94;&#x7269;&#x7406;&#x9875;&#x5B58;&#x5728;&#xFF0C;&#x4F46;&#x662F;&#x8BFB;&#x5F02;&#x5E38;&#xFF0C;&#x5E94;&#x8BE5;&#x662F;&#x6743;&#x9650;&#x95EE;&#x9898;&#xFF0C;&#x76F4;&#x63A5;&#x62A5;&#x9519;</span></span><br><span class="line">        cprintf(<span class="string">&quot;do_pgfault failed: error code flag = read AND present\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> failed;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>: <span class="comment">//&#x7F3A;&#x9875;&#xFF0C;&#x8BFB;&#x5F02;&#x5E38;&#xFF0C;&#x4E0B;&#x9762;&#x5224;&#x65AD;&#x7269;&#x7406;&#x9875;&#x662F;&#x5426;&#x53EF;&#x8BFB;&#xFF0C;&#x82E5;&#x53EF;&#x8BFB;&#xFF0C;&#x901A;&#x8FC7;&#x4E0B;&#x9762;&#x6D41;&#x7A0B;&#x5C06;&#x8BE5;&#x7269;&#x7406;&#x9875;&#x6620;&#x5C04;&#xFF0C;&#x82E5;&#x4E0D;&#x53EF;&#x5199;&#xFF0C;&#x5219;&#x62A5;&#x9519;</span></span><br><span class="line">        <span class="keyword">if</span> (!(vma-&gt;vm_flags &amp; (VM_READ | VM_EXEC))) {</span><br><span class="line">            cprintf(<span class="string">&quot;do_pgfault failed: error code flag = read AND not present, but the addr&apos;s vma cannot read or exec\n&quot;</span>);</span><br><span class="line">            <span class="keyword">goto</span> failed;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">/* &#x5269;&#x4E0B;&#x4E24;&#x79CD;&#x60C5;&#x51B5;&#xFF1A;</span></span><br><span class="line"><span class="comment">     * 1. &#x5199;&#x4E00;&#x4E2A;&#x4E0D;&#x5B58;&#x5728;&#x7684;&#x53EF;&#x5199;&#x7269;&#x7406;&#x5730;&#x5740;</span></span><br><span class="line"><span class="comment">     * 2. &#x8BFB;&#x4E00;&#x4E2A;&#x4E0D;&#x5B58;&#x5728;&#x7684;&#x53EF;&#x8BFB;&#x7269;&#x7406;&#x5730;&#x5740;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> perm = PTE_U;<span class="comment">//perm&#x4E3A;PDE&#xFF08;&#x9875;&#x76EE;&#x5F55;&#x9879;&#xFF09;/PTE&#xFF08;&#x9875;&#x9879;&#xFF09;&#x7684;&#x6743;&#x9650;&#x4F4D;</span></span><br><span class="line">    <span class="keyword">if</span> (vma-&gt;vm_flags &amp; VM_WRITE) {</span><br><span class="line">        perm |= PTE_W;</span><br><span class="line">    }</span><br><span class="line">    addr = ROUNDDOWN(addr, PGSIZE);</span><br><span class="line"></span><br><span class="line">    ret = -E_NO_MEM;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pte_t</span> *ptep=<span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((ptep = get_pte(mm-&gt;pgdir, addr, <span class="number">1</span>)) == <span class="literal">NULL</span>) {</span><br><span class="line">        cprintf(<span class="string">&quot;get_pte in do_pgfault failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> failed;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//&#x5982;&#x679C;&#x8BE5;&#x9875;&#x8868;&#x5185;&#x5BB9;&#x4E3A;0&#xFF0C;&#x8BF4;&#x660E;&#x672A;&#x5EFA;&#x7ACB;&#x6620;&#x5C04;&#xFF0C;</span></span><br><span class="line">    <span class="keyword">if</span> (*ptep == <span class="number">0</span>) { <span class="comment">// pgdir_alloc_page&#x7533;&#x8BF7;&#x4E00;&#x4E2A;&#x7269;&#x7406;&#x9875;&#xFF0C;&#x5E76;&#x5EFA;&#x7ACB;&#x6620;&#x5C04;</span></span><br><span class="line">        <span class="keyword">if</span> (pgdir_alloc_page(mm-&gt;pgdir, addr, perm) == <span class="literal">NULL</span>) {</span><br><span class="line">            cprintf(<span class="string">&quot;pgdir_alloc_page in do_pgfault failed\n&quot;</span>);</span><br><span class="line">            <span class="keyword">goto</span> failed;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> { <span class="comment">// &#x5426;&#x5219;&#x5C31;&#x662F;&#x6620;&#x5C04;&#x5230;swap&#x533A;&#xFF0C;&#x9700;&#x8981;&#x5C06;&#x78C1;&#x76D8;&#x4E2D;&#x7684;&#x6570;&#x636E;&#x52A0;&#x8F7D;&#x5230;&#x7269;&#x7406;&#x9875;</span></span><br><span class="line">           <span class="comment">// &#x8C03;&#x7528; page_insert &#x91CD;&#x65B0;&#x5EFA;&#x7ACB;&#x6620;&#x5C04;</span></span><br><span class="line">        <span class="keyword">if</span>(swap_init_ok) {</span><br><span class="line">            struct Page *page=<span class="literal">NULL</span>;</span><br><span class="line">            <span class="keyword">if</span> ((ret = swap_in(mm, addr, &amp;page)) != <span class="number">0</span>) {</span><br><span class="line">                cprintf(<span class="string">&quot;swap_in in do_pgfault failed\n&quot;</span>);</span><br><span class="line">                <span class="keyword">goto</span> failed;</span><br><span class="line">            }    </span><br><span class="line">            page_insert(mm-&gt;pgdir, page, addr, perm);</span><br><span class="line">            swap_map_swappable(mm, addr, page, <span class="number">1</span>);</span><br><span class="line">            page-&gt;pra_vaddr = addr;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            cprintf(<span class="string">&quot;no swap_init_ok but ptep is %x, failed\n&quot;</span>,*ptep);</span><br><span class="line">            <span class="keyword">goto</span> failed;</span><br><span class="line">        }</span><br><span class="line">   }</span><br><span class="line">   ret = <span class="number">0</span>;</span><br><span class="line">failed:</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x4E0B;&#x9762;&#x662F;&#x5B9E;&#x73B0;FIFO&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;&#x7684;_fifo_map_swappable&#x51FD;&#x6570;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line">_fifo_map_swappable(struct mm_struct *mm, <span class="keyword">uintptr_t</span> addr, struct Page *page, <span class="keyword">int</span> swap_in)</span><br><span class="line">{</span><br><span class="line">    <span class="keyword">list_entry_t</span> *head=(<span class="keyword">list_entry_t</span>*) mm-&gt;sm_priv;<span class="comment">//&#x83B7;&#x53D6;&#x961F;&#x5217;&#x7684;&#x8868;&#x5934;</span></span><br><span class="line">    <span class="keyword">list_entry_t</span> *entry=&amp;(page-&gt;pra_page_link);<span class="comment">//&#x83B7;&#x53D6;&#x5F53;&#x524D;&#x4F7F;&#x7528;&#x7684;&#x7EF4;&#x62A4;&#x7269;&#x7406;&#x9875;&#x7684;Page&#x7ED3;&#x6784;&#x4F53;&#x7684;&#x5730;&#x5740;</span></span><br><span class="line"> </span><br><span class="line">    assert(entry != <span class="literal">NULL</span> &amp;&amp; head != <span class="literal">NULL</span>);</span><br><span class="line">    list_add(head, entry);<span class="comment">//&#x6240;&#x4EE5;&#x5B9E;&#x73B0;&#x94FE;&#x63A5;&#x6548;&#x679C;&#xFF0C;&#x53EA;&#x8981;&#x6DFB;&#x52A0;&#x8FD9;&#x4E00;&#x53E5;&#x5C31;&#x53EF;&#x4EE5;&#x4E86;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x4F7F;&#x7528;&#x4E00;&#x4E2A;&#x53CC;&#x5411;&#x94FE;&#x8868;&#x7EF4;&#x62A4;&#x4E00;&#x4E2A;&#x961F;&#x5217;&#xFF0C;&#x7528;&#x6765;&#x4FDD;&#x5B58;&#x7269;&#x7406;&#x9875;&#x7684;&#x4F7F;&#x7528;&#x60C5;&#x51B5;&#x3002;&#x6BCF;&#x6B21;&#x4E0D;&#x8BBA;&#x91CD;&#x65B0;&#x5206;&#x914D;&#x7269;&#x7406;&#x9875;&#x5EFA;&#x7ACB;&#x6620;&#x5C04;&#xFF0C;&#x8FD8;&#x662F;&#x5C06;&#x78C1;&#x76D8;&#x4E2D;&#x7684;&#x6570;&#x636E;&#x88C5;&#x5165;&#x7269;&#x7406;&#x5185;&#x5B58;&#x5EFA;&#x7ACB;&#x6620;&#x5C04;&#xFF0C;&#x5373;&#x6BCF;&#x6B21;&#x7269;&#x7406;&#x9875;&#x88AB;&#x4F7F;&#x7528;&#xFF0C;&#x90FD;&#x4F1A;&#x66F4;&#x65B0;Page&#x6570;&#x636E;&#x7ED3;&#x6784;&#x7684;pra_page_link&#x94FE;&#x8868;&#xFF0C;&#x4E0A;&#x9762;&#x8BF4;&#x4E86;&#xFF0C;&#x8FD9;&#x4E2A;&#x94FE;&#x8868;&#x6309;&#x65F6;&#x95F4;&#x5148;&#x540E;&#x8FDE;&#x63A5;&#x88AB;&#x4F7F;&#x7528;&#x7684;&#x7269;&#x7406;&#x9875;&#xFF0C;&#x7528;&#x4EE5;FIFO&#x7684;&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;&#xFF0C;&#x6BCF;&#x6B21;&#x65B0;&#x4F7F;&#x7528;&#x7684;&#x7269;&#x7406;&#x9875;&#x90FD;&#x4F1A;&#x94FE;&#x63A5;&#x5728;&#x94FE;&#x8868;&#x7684;&#x672B;&#x5C3E;&#x3002;</p>
<p>&#x4E0B;&#x9762;&#x662F;&#x5B9E;&#x73B0;&#x7684;FIFO&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;&#x7684;_fifo_swap_out_victim&#x51FD;&#x6570;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line">_fifo_swap_out_victim(struct mm_struct *mm, struct Page ** ptr_page, <span class="keyword">int</span> in_tick)</span><br><span class="line">{</span><br><span class="line">     <span class="keyword">list_entry_t</span> *head=(<span class="keyword">list_entry_t</span>*) mm-&gt;sm_priv;<span class="comment">//&#x83B7;&#x53D6;&#x961F;&#x5217;&#x7684;&#x8868;&#x5934;</span></span><br><span class="line">     assert(head != <span class="literal">NULL</span>);</span><br><span class="line">     assert(in_tick==<span class="number">0</span>);</span><br><span class="line">     <span class="keyword">list_entry_t</span> *le = head-&gt;next;</span><br><span class="line">     assert(head!=le);</span><br><span class="line">     <span class="class"><span class="keyword">struct</span> <span class="title">Page</span> *<span class="title">p</span> = <span class="title">le2page</span>(<span class="title">le</span>, <span class="title">pra_page_link</span>);</span><span class="comment">//&#x901A;&#x8FC7;Page&#x7684;&#x6210;&#x5458;pra_page_link&#x83B7;&#x53D6;Page&#x7684;&#x6307;&#x9488;</span></span><br><span class="line">     list_del(le);</span><br><span class="line">     assert(p !=<span class="literal">NULL</span>);</span><br><span class="line">     *ptr_page = p;</span><br><span class="line">     <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x4E0A;&#x9762;&#x7684;&#x961F;&#x5217;&#x4FDD;&#x5B58;&#x7684;&#x662F;&#x6B63;&#x5728;&#x4F7F;&#x7528;&#x7684;&#x7269;&#x7406;&#x9875;&#xFF0C;&#x5982;&#x679C;&#x7269;&#x7406;&#x5185;&#x5B58;&#x6EE1;&#x4E86;&#xFF0C;&#x5C31;&#x9700;&#x8981;&#x5C06;&#x6B63;&#x5728;&#x4F7F;&#x7528;&#x7684;&#x7269;&#x7406;&#x9875;&#x7F6E;&#x6362;&#x5230;&#x5916;&#x5B58;&#x4E2D;&#xFF0C;&#x8BE5;&#x51FD;&#x6570;_fifo_swap_out_victim&#x5C31;&#x662F;&#x5220;&#x9664;&#x961F;&#x5217;&#x4E2D;&#x5BF9;&#x9996;&#x7684;&#x6700;&#x65E9;&#x4F7F;&#x7528;&#x7684;&#x7269;&#x7406;&#x9875;&#xFF0C;&#x5E76;&#x7528;ptr_page&#x4FDD;&#x5B58;&#x3002;</p>
<h2 id="&#x5206;&#x6790;&#x6D4B;&#x8BD5;&#x6570;&#x636E;"><a href="#&#x5206;&#x6790;&#x6D4B;&#x8BD5;&#x6570;&#x636E;" class="headerlink" title="&#x5206;&#x6790;&#x6D4B;&#x8BD5;&#x6570;&#x636E;"></a>&#x5206;&#x6790;&#x6D4B;&#x8BD5;&#x6570;&#x636E;</h2><p>&#x5728;&#x6D4B;&#x8BD5;&#x4E2D;&#xFF0C;&#x53EA;&#x63D0;&#x4F9B;&#x4E86;4&#x4E2A;&#x7269;&#x7406;&#x9875;&#x8FDB;&#x884C;&#x5206;&#x914D;&#xFF0C;&#x9996;&#x5148;&#x5EFA;&#x7ACB;&#x4E86;4&#x4E2A;&#x7269;&#x7406;&#x9875;&#x7684;&#x6620;&#x5C04;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//swap.c</span></span><br><span class="line"><span class="comment">//CHECK_VALID_PHY_PAGE_NUM = 4</span></span><br><span class="line">     <span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;CHECK_VALID_PHY_PAGE_NUM;i++) {</span><br><span class="line">          check_rp[i] = alloc_page();</span><br><span class="line">          assert(check_rp[i] != <span class="literal">NULL</span> );</span><br><span class="line">          assert(!PageProperty(check_rp[i]));</span><br><span class="line">     }</span><br></pre></td></tr></table></figure>
<p>&#x7136;&#x540E;&#x901A;&#x8FC7;&#x76F4;&#x63A5;&#x5199;&#x5185;&#x5B58;&#x6570;&#x636E;&#x89E6;&#x53D1;&#x7F3A;&#x9875;&#x4E2D;&#x65AD;&#xFF0C;&#x603B;&#x5171;&#x53D1;&#x751F;12&#x6B21;&#x5185;&#x5B58;&#x5199;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//swap_fifo.c</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line">_fifo_check_swap(<span class="keyword">void</span>) {</span><br><span class="line">    cprintf(<span class="string">&quot;write Virt Page c in fifo_check_swap\n&quot;</span>);</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="number">0x3000</span> = <span class="number">0x0c</span>;_</span><br><span class="line">    assert(pgfault_num==<span class="number">4</span>);</span><br><span class="line">    cprintf(<span class="string">&quot;write Virt Page a in fifo_check_swap\n&quot;</span>);</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="number">0x1000</span> = <span class="number">0x0a</span>;</span><br><span class="line">    assert(pgfault_num==<span class="number">4</span>);</span><br><span class="line">    cprintf(<span class="string">&quot;write Virt Page d in fifo_check_swap\n&quot;</span>);</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="number">0x4000</span> = <span class="number">0x0d</span>;</span><br><span class="line">    assert(pgfault_num==<span class="number">4</span>);</span><br><span class="line">    cprintf(<span class="string">&quot;write Virt Page b in fifo_check_swap\n&quot;</span>);</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="number">0x2000</span> = <span class="number">0x0b</span>;</span><br><span class="line">    assert(pgfault_num==<span class="number">4</span>);</span><br><span class="line">    cprintf(<span class="string">&quot;write Virt Page e in fifo_check_swap\n&quot;</span>);<span class="comment">//&#x9875;&#x9762;&#x7F6E;&#x6362;&#x5F00;&#x59CB;</span></span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="number">0x5000</span> = <span class="number">0x0e</span>;<span class="comment">//&#x9875;&#x9762;&#x7F6E;&#x6362;&#x5F00;&#x59CB;</span></span><br><span class="line">    assert(pgfault_num==<span class="number">5</span>);</span><br><span class="line">    cprintf(<span class="string">&quot;write Virt Page b in fifo_check_swap\n&quot;</span>);</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="number">0x2000</span> = <span class="number">0x0b</span>;</span><br><span class="line">    assert(pgfault_num==<span class="number">5</span>);</span><br><span class="line">    cprintf(<span class="string">&quot;write Virt Page a in fifo_check_swap\n&quot;</span>);</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="number">0x1000</span> = <span class="number">0x0a</span>;</span><br><span class="line">    assert(pgfault_num==<span class="number">6</span>);</span><br><span class="line">    cprintf(<span class="string">&quot;write Virt Page b in fifo_check_swap\n&quot;</span>);</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="number">0x2000</span> = <span class="number">0x0b</span>;</span><br><span class="line">    assert(pgfault_num==<span class="number">7</span>);</span><br><span class="line">    cprintf(<span class="string">&quot;write Virt Page c in fifo_check_swap\n&quot;</span>);</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="number">0x3000</span> = <span class="number">0x0c</span>;</span><br><span class="line">    assert(pgfault_num==<span class="number">8</span>);</span><br><span class="line">    cprintf(<span class="string">&quot;write Virt Page d in fifo_check_swap\n&quot;</span>);</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="number">0x4000</span> = <span class="number">0x0d</span>;</span><br><span class="line">    assert(pgfault_num==<span class="number">9</span>);</span><br><span class="line">    cprintf(<span class="string">&quot;write Virt Page e in fifo_check_swap\n&quot;</span>);</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="number">0x5000</span> = <span class="number">0x0e</span>;</span><br><span class="line">    assert(pgfault_num==<span class="number">10</span>);</span><br><span class="line">    cprintf(<span class="string">&quot;write Virt Page a in fifo_check_swap\n&quot;</span>);</span><br><span class="line">    assert(*(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="number">0x1000</span> == <span class="number">0x0a</span>);</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="number">0x1000</span> = <span class="number">0x0a</span>;</span><br><span class="line">    assert(pgfault_num==<span class="number">11</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x4E0B;&#x9762;&#x5206;&#x6790;&#x6D4B;&#x8BD5;&#x7ED3;&#x679C;</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="builtin-name">set</span> up init env <span class="keyword">for</span> check_swap begin!</span><br><span class="line">page fault at 0x00001000: K/W [<span class="literal">no</span><span class="built_in"> page </span>found].</span><br><span class="line">page fault at 0x00002000: K/W [<span class="literal">no</span><span class="built_in"> page </span>found].</span><br><span class="line">page fault at 0x00003000: K/W [<span class="literal">no</span><span class="built_in"> page </span>found].</span><br><span class="line">page fault at 0x00004000: K/W [<span class="literal">no</span><span class="built_in"> page </span>found].</span><br><span class="line"><span class="builtin-name">set</span> up init env <span class="keyword">for</span> check_swap over!</span><br><span class="line">write Virt<span class="built_in"> Page </span>c <span class="keyword">in</span> fifo_check_swap</span><br><span class="line">write Virt<span class="built_in"> Page </span>a <span class="keyword">in</span> fifo_check_swap</span><br><span class="line">write Virt<span class="built_in"> Page </span>d <span class="keyword">in</span> fifo_check_swap</span><br><span class="line">write Virt<span class="built_in"> Page </span>b <span class="keyword">in</span> fifo_check_swap</span><br><span class="line">write Virt<span class="built_in"> Page </span>e <span class="keyword">in</span> fifo_check_swap</span><br><span class="line">page fault at 0x00005000: K/W [<span class="literal">no</span><span class="built_in"> page </span>found].</span><br><span class="line">swap_out: i 0, store<span class="built_in"> page </span><span class="keyword">in</span> vaddr 0x1000 <span class="keyword">to</span> disk swap entry 2</span><br><span class="line">write Virt<span class="built_in"> Page </span>b <span class="keyword">in</span> fifo_check_swap</span><br><span class="line">write Virt<span class="built_in"> Page </span>a <span class="keyword">in</span> fifo_check_swap</span><br><span class="line">page fault at 0x00001000: K/W [<span class="literal">no</span><span class="built_in"> page </span>found].</span><br><span class="line">*ptep!=0</span><br><span class="line">swap_out: i 0, store<span class="built_in"> page </span><span class="keyword">in</span> vaddr 0x2000 <span class="keyword">to</span> disk swap entry 3</span><br><span class="line">swap_in: load disk swap entry 2 with swap_page <span class="keyword">in</span> vadr 0x1000</span><br><span class="line">write Virt<span class="built_in"> Page </span>b <span class="keyword">in</span> fifo_check_swap</span><br><span class="line">page fault at 0x00002000: K/W [<span class="literal">no</span><span class="built_in"> page </span>found].</span><br><span class="line">*ptep!=0</span><br><span class="line">swap_out: i 0, store<span class="built_in"> page </span><span class="keyword">in</span> vaddr 0x3000 <span class="keyword">to</span> disk swap entry 4</span><br><span class="line">swap_in: load disk swap entry 3 with swap_page <span class="keyword">in</span> vadr 0x2000</span><br><span class="line">write Virt<span class="built_in"> Page </span>c <span class="keyword">in</span> fifo_check_swap</span><br><span class="line">page fault at 0x00003000: K/W [<span class="literal">no</span><span class="built_in"> page </span>found].</span><br><span class="line">*ptep!=0</span><br><span class="line">swap_out: i 0, store<span class="built_in"> page </span><span class="keyword">in</span> vaddr 0x4000 <span class="keyword">to</span> disk swap entry 5</span><br><span class="line">swap_in: load disk swap entry 4 with swap_page <span class="keyword">in</span> vadr 0x3000</span><br><span class="line">write Virt<span class="built_in"> Page </span>d <span class="keyword">in</span> fifo_check_swap</span><br><span class="line">page fault at 0x00004000: K/W [<span class="literal">no</span><span class="built_in"> page </span>found].</span><br><span class="line">*ptep!=0</span><br><span class="line">swap_out: i 0, store<span class="built_in"> page </span><span class="keyword">in</span> vaddr 0x5000 <span class="keyword">to</span> disk swap entry 6</span><br><span class="line">swap_in: load disk swap entry 5 with swap_page <span class="keyword">in</span> vadr 0x4000</span><br><span class="line">write Virt<span class="built_in"> Page </span>e <span class="keyword">in</span> fifo_check_swap</span><br><span class="line">page fault at 0x00005000: K/W [<span class="literal">no</span><span class="built_in"> page </span>found].</span><br><span class="line">*ptep!=0</span><br><span class="line">swap_out: i 0, store<span class="built_in"> page </span><span class="keyword">in</span> vaddr 0x1000 <span class="keyword">to</span> disk swap entry 2</span><br><span class="line">swap_in: load disk swap entry 6 with swap_page <span class="keyword">in</span> vadr 0x5000</span><br><span class="line">write Virt<span class="built_in"> Page </span>a <span class="keyword">in</span> fifo_check_swap</span><br><span class="line">page fault at 0x00001000: K/R [<span class="literal">no</span><span class="built_in"> page </span>found].</span><br><span class="line">swap_out: i 0, store<span class="built_in"> page </span><span class="keyword">in</span> vaddr 0x2000 <span class="keyword">to</span> disk swap entry 3</span><br><span class="line">swap_in: load disk swap entry 2 with swap_page <span class="keyword">in</span> vadr 0x1000</span><br><span class="line">count is 0, total is 7</span><br></pre></td></tr></table></figure>
<p>&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#x7A0B;&#x5E8F;&#x8981;&#x5BF9;0x00005000&#x8FDB;&#x884C;&#x5199;&#x65F6;&#x51FA;&#x73B0;&#x7F3A;&#x9875;&#x4E2D;&#x65AD;&#xFF0C;&#x4F46;&#x662F;&#x7269;&#x7406;&#x9875;&#x5DF2;&#x7ECF;&#x6EE1;&#x4E86;&#xFF0C;&#x5C31;&#x628A;0x00001000&#x5BF9;&#x5E94;&#x7684;&#x7269;&#x7406;&#x9875;&#x7F6E;&#x6362;&#x5230;swap&#x533A;&#x2026;&#x2026;</p>
<p>&#x6700;&#x540E;12&#x6B21;&#x5199;&#x4E2D;&#xFF0C;&#x53D1;&#x751F;&#x4E86;7&#x6B21;&#x7F3A;&#x9875;&#x5F02;&#x5E38;&#x3002;</p>
<h2 id="&#x5176;&#x4ED6;"><a href="#&#x5176;&#x4ED6;" class="headerlink" title="&#x5176;&#x4ED6;"></a>&#x5176;&#x4ED6;</h2><h3 id="&#x4F7F;&#x7528;gdb&#x67E5;&#x770B;mm-struct-&#x548C;-vma-struct-&#x7ED3;&#x6784;&#x4F53;&#x7684;&#x5185;&#x5BB9;"><a href="#&#x4F7F;&#x7528;gdb&#x67E5;&#x770B;mm-struct-&#x548C;-vma-struct-&#x7ED3;&#x6784;&#x4F53;&#x7684;&#x5185;&#x5BB9;" class="headerlink" title="&#x4F7F;&#x7528;gdb&#x67E5;&#x770B;mm_struct &#x548C; vma_struct &#x7ED3;&#x6784;&#x4F53;&#x7684;&#x5185;&#x5BB9;"></a>&#x4F7F;&#x7528;gdb&#x67E5;&#x770B;mm_struct &#x548C; vma_struct &#x7ED3;&#x6784;&#x4F53;&#x7684;&#x5185;&#x5BB9;</h3><p>&#x67E5;&#x770B; mm_struct &#x548C; vma_struct &#x7ED3;&#x6784;&#x4F53;&#x7684;&#x5185;&#x5BB9;&#x3002;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x521D;&#x59CB;&#x65F6;&#xFF0C;&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x9875;&#x76EE;&#x5F55;&#x8868;&#x9879;&#xFF0C;&#x7EF4;&#x62A4;&#x4E86;&#x4E00;&#x4E2A;&#x9875;&#x8868;&#xFF0C;&#x8BE5;&#x9875;&#x8868;&#x7EF4;&#x62A4;&#x4E86;0~4M&#x7684;&#x865A;&#x62DF;&#x5185;&#x5B58;&#x7A7A;&#x95F4;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">gef&#x27A4;  p check_mm_struct</span><br><span class="line">$<span class="number">3</span> = (struct mm_struct *) <span class="number">0xc0303000</span></span><br><span class="line">  </span><br><span class="line">gef&#x27A4;  p *((struct mm_struct *) <span class="number">0xc0303000</span>)</span><br><span class="line">$<span class="number">12</span> = {</span><br><span class="line">  mmap_list = {</span><br><span class="line">    prev = <span class="number">0xc0304010</span>, </span><br><span class="line">    next = <span class="number">0xc0304010</span></span><br><span class="line">  }, </span><br><span class="line">  mmap_cache = <span class="number">0xc0304000</span>, </span><br><span class="line">  pgdir = <span class="number">0xc0120000</span>, </span><br><span class="line">  map_count = <span class="number">0x1</span>, </span><br><span class="line">  sm_priv = <span class="number">0x0</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">gef&#x27A4;  p *((struct vma_struct *) (<span class="number">0xc0304010</span><span class="number">-0x10</span>))</span><br><span class="line">$<span class="number">13</span> = {</span><br><span class="line">  vm_mm = <span class="number">0xc0303000</span>, </span><br><span class="line">  vm_start = <span class="number">0x0</span>, </span><br><span class="line">  vm_end = <span class="number">0x400000</span>, </span><br><span class="line">  vm_flags = <span class="number">0x2</span>, </span><br><span class="line">  list_link = {</span><br><span class="line">    prev = <span class="number">0xc0303000</span>, </span><br><span class="line">    next = <span class="number">0xc0303000</span></span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line">&#x67E5;&#x770B;&#x9875;&#x8868;&#x5185;&#x5BB9;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x9875;&#x8868;&#x4E2D;&#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x6620;&#x5C04;</span><br><span class="line">gef&#x27A4;  x/<span class="number">4</span>xw <span class="number">0xc0120000</span></span><br><span class="line"><span class="number">0xc0120000</span>:	<span class="number">0x00000000</span>	<span class="number">0x00000000</span>	<span class="number">0x00000000</span>	<span class="number">0x00000000</span></span><br></pre></td></tr></table></figure>
<h3 id="&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;&#x5206;&#x7C7B;"><a href="#&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;&#x5206;&#x7C7B;" class="headerlink" title="&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;&#x5206;&#x7C7B;"></a>&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;&#x5206;&#x7C7B;</h3><p>&#x5C40;&#x90E8;&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;&#xFF1A;1.&#x6700;&#x4F18;&#x7B97;&#x6CD5; 2.FIFO&#x7B97;&#x6CD5; 3.&#x6700;&#x8FD1;&#x6700;&#x4E45;&#x672A;&#x4F7F;&#x7528;&#x7B97;&#x6CD5; 4.&#x65F6;&#x949F;&#x7F6E;&#x6362;&#x7B97;&#x6CD5; 5.&#x6700;&#x4E0D;&#x5E38;&#x7528;&#x7B97;&#x6CD5;</p>
<p>&#x5168;&#x5C40;&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;&#xFF1A;1.&#x5DE5;&#x4F5C;&#x96C6;&#x7F6E;&#x6362;&#x7B97;&#x6CD5; 2.&#x7F3A;&#x9875;&#x7387;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;</p>
<h3 id="&#x5C40;&#x90E8;&#x6027;&#x539F;&#x7406;"><a href="#&#x5C40;&#x90E8;&#x6027;&#x539F;&#x7406;" class="headerlink" title="&#x5C40;&#x90E8;&#x6027;&#x539F;&#x7406;"></a>&#x5C40;&#x90E8;&#x6027;&#x539F;&#x7406;</h3><p>&#x7A0B;&#x5E8F;&#x5728;&#x6267;&#x884C;&#x8FC7;&#x7A0B;&#x4E2D;&#x7684;&#x4E00;&#x4E2A;&#x8F83;&#x77ED;&#x7684;&#x65F6;&#x671F;&#x5185;&#xFF0C;&#x6240;&#x6267;&#x884C;&#x7684;&#x6307;&#x4EE4;&#x5730;&#x5740;&#x548C;&#x6307;&#x4EE4;&#x64CD;&#x4F5C;&#x6570;&#x5730;&#x5740;&#xFF0C;&#x5206;&#x522B;&#x5C40;&#x9650;&#x4E8E;&#x4E00;&#x5B9A;&#x533A;&#x57DF;&#xFF0C;&#x5305;&#x62EC;&#x65F6;&#x95F4;&#x5C40;&#x90E8;&#x6027;&#x3001;&#x7A7A;&#x95F4;&#x5C40;&#x90E8;&#x6027;&#x3001;&#x5206;&#x652F;&#x5C40;&#x90E8;&#x6027;</p>
</div><hr></div><nav id="pagination"><div class="pagination"><span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://raw.githubusercontent.com/Po1lux/Po1lux.github.io/hexo/source/images/IMG_3035.JPG)"><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2020 By Po1lux</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script></body></html>